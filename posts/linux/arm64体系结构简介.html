<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Arm64体系结构简介 - Laumy的技术栈</title>
    <link rel="stylesheet" href="/laumy.github.io/assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="/laumy.github.io/">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="/laumy.github.io/">首页</a></div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#arm">ARM简介</a><ul></ul></li><li><a href="#armv8">Armv8体系结构</a><ul><li><a href="#_1">通用寄存器</a></li><li><a href="#_2">处理器状态</a></li><li><a href="#_3">特殊寄存器</a></li></ul></li><li><a href="#_4">异常</a><ul><li><a href="#_5">异常类型</a></li><li><a href="#_6">异常等级</a></li><li><a href="#_7">中断发生硬件处理过程</a></li><li><a href="#_8">异常向量表</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>Arm64体系结构简介</h1>
  <div class="meta">2023-03-04 · linux</div>
  <div class="post-content"><h2 id="arm">ARM简介</h2>
<table>
<thead>
<tr>
<th>ARM版本</th>
<th>典型处理器</th>
<th>主要特性</th>
</tr>
</thead>
<tbody>
<tr>
<td>v1</td>
<td></td>
<td>26位地址空间</td>
</tr>
<tr>
<td>v2</td>
<td></td>
<td>增加乘法、乘加法、支持协处理指令等</td>
</tr>
<tr>
<td>v3</td>
<td></td>
<td>地址空间扩展到32位，增加SPSP和CPSR等</td>
</tr>
<tr>
<td>v4</td>
<td>ARM7TDMI/ARM920T</td>
<td>增加Thumb指令等</td>
</tr>
<tr>
<td>v5</td>
<td>ARM926EJ-S</td>
<td>增加Jazelle和VFPv2等</td>
</tr>
<tr>
<td>v6</td>
<td>ARM11 MPCore</td>
<td>增加SIMD、TrustZone以及Thumb-2等</td>
</tr>
<tr>
<td>v7</td>
<td>Cortex-A8/Cortex-A9</td>
<td>增加NEON和VFPv3/v4扩展</td>
</tr>
<tr>
<td>v8</td>
<td>Cortex-A72</td>
<td>支持32位和64位指令集处理器体系结构</td>
</tr>
<tr>
<td>v9</td>
<td>Cortex-x2</td>
<td>支持可伸缩矢量扩展计算、机密计算体系结构</td>
</tr>
</tbody>
</table>
<ul>
<li>A系列：面向性能密集型系统的应用处理器内核。</li>
<li>R系列：面向实时应用的高性能内核。</li>
<li>M系列：面向各类嵌入式应用的微控制器内核。</li>
</ul>
<h2 id="armv8">Armv8体系结构</h2>
<h3 id="_1">通用寄存器</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_300bd876e354afece405179950027a19.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/中断管理/arm64体系结构简介/images/wp_editor_md_300bd876e354afece405179950027a19.jpg"/></a></p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_3a9846839047d6c5589d0be273267e79.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/中断管理/arm64体系结构简介/images/wp_editor_md_3a9846839047d6c5589d0be273267e79.jpg"/></a></p>
<p>AArch64状态下支持31个64位通用寄存器，分别是X0~X30，而AArch32状态支持16个32位通用寄存器。在AArch64状态下使用X表示64位寄存器，另外还可以使用W来表示32位的数据。X29（FP）是栈帧寄存器，指向栈的顶部（SP指向栈的当前位置），X30（LR）是链接寄存器，保持函数返回地址。</p>
<p>下图是AArch32状态下AArch64到AArch32状态的寄存器mapping。</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_2b3ec9c1a3941651f2d9b8dfee42fdd2.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/中断管理/arm64体系结构简介/images/wp_editor_md_2b3ec9c1a3941651f2d9b8dfee42fdd2.jpg"/></a></p>
<h3 id="_2">处理器状态</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_5433b5e87c5d450f730e9933e5598d9f.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/中断管理/arm64体系结构简介/images/wp_editor_md_5433b5e87c5d450f730e9933e5598d9f.jpg"/></a></p>
<p>Aarch64使用了PSTATE寄存器来表示当前处理器的状态（armv7使用的是CPSR），上图中I和F表示cpu本地中断的屏蔽位。SP为选择SP寄存器，在不同的异常等级下，SP寄存器是不一样的（见下小节），当运行在EL0是即为SP_EL0。</p>
<h3 id="_3">特殊寄存器</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_b513e04cf9482236a9552e95d3cdff19.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/中断管理/arm64体系结构简介/images/wp_editor_md_b513e04cf9482236a9552e95d3cdff19.jpg"/></a></p>
<p>除了31个通用的寄存器外，还有上面的特殊寄存器。不同特权模式下的寄存器有所差别。 - XZR/WZR：两个零寄存器。WZR是32位零位寄存器，XZR是64位零位寄存器。 - PC：指向当前运行指令的下一条指令地址。 - SP:每个异常等级都有一个专门的SP寄存器SP_ELn。高等级的特权模式可以访问低等级的SP寄存器。 - SPSR:备份程序状态寄存器，运行一个异常程序是，处理器的一些状态信息会保存在备份程序状态寄存器里，如会将处理器的PSTATE寄存器的值暂时保存到SPSR里，当处理完成返回时，再把SPSR的值恢复到PSTATE寄存器。 - ELR:存放异常返回地址。</p>
<h2 id="_4">异常</h2>
<h3 id="_5">异常类型</h3>
<ul>
<li>中断</li>
<li>中止</li>
<li>复位</li>
<li>系统调用</li>
</ul>
<h3 id="_6">异常等级</h3>
<p>Armv8支持aarch64和aarch32两种执行状态，aarch64是64位执行状态，运行A64指令集；aarch32是兼容armv7架构32位执行状态，运行A32的指令集。aarch64有4中异常等级。</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_d33462d1c44c6e5a531a2de24c1d5e58.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/中断管理/arm64体系结构简介/images/wp_editor_md_d33462d1c44c6e5a531a2de24c1d5e58.jpg"/></a></p>
<ul>
<li>EL0:用户特权，用于运行普通的用户程序。</li>
<li>EL1:系统特权，用于操作系统内核。如果使能虚拟化，则运行虚拟机操作系统内核。</li>
<li>EL2:运行虚拟化扩展的虚拟机监控器（hypervisor）。</li>
<li>EL3:运行安全os下的监控器（secure monitor）。</li>
</ul>
<p>除了EL0以外，每个异常等级都有两个选择，选择自己等级或使用EL0等级，如果选用自己等级SP为SP_ELn（SP_ELnH），如果使用EL0那么SP为SP_EL0（SP_ELnt）。 ARMv8有4种以上等级，只有在获取异常或异常返回发生等级的变化。当处理器从较高等级切换到较低等级时，执行状态可以不变或者可以从aarch64切换到aarch32。当处理器从较低等级切换到较高等级时，执行状态可以不变或从aarch32切换到aarch64。</p>
<h3 id="_7">中断发生硬件处理过程</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_ab2e4fe23e14c02bb29a7f1f4c2374bf.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/中断管理/arm64体系结构简介/images/wp_editor_md_ab2e4fe23e14c02bb29a7f1f4c2374bf.jpg"/></a></p>
<p>当事件触发异常发生时，处理器硬件会自动的执行以下动作。 1. 进入异常： （1）将PC保存到ELR_ELx （2）PSTATE保存到SPSR_ELx，会关闭到cpu本地的IRQ和FIQ中断，防止中断嵌套 1. 退出异常： （1）将ELR_ELx的数据保存到PC （2）将SPSR_ELx的数据保存到PSTATE，打开中断。</p>
<p>以上过程都是硬件自动完成。硬件处理完成后，就进入程序处理阶段，分为三个阶段保存上下文、中断处理、恢复上下文。</p>
<ul>
<li>上下文：进入中断后，需要将打断的应用当前的相关寄存器保存起来，一般是存储在当前任务内核堆栈里面，当中断退出时，再从堆栈中获取恢复。</li>
<li>中断处理：包括确定中断源，将触发的中断源屏蔽，接着再处理中断服务程序。</li>
</ul>
<h3 id="_8">异常向量表</h3>
<p>异常发生时，处理器会跳转到相应位置执行异常相关指令。异常相关的处理指令通常存储在内存种，这个存储位置为异常向量，在ARMv8体系结构中，EL1、EL2、EL3都有一个异常向量表，每个异常向量表存储的基地址在VBAR_ELx寄存器中，EL0没有异常向量表，那是因为EL0的异常发生在用户态，当用户态发生发生异常时系统会跃迁到内核态EL1处理，所以EL0没有异常向量表，也可以认为EL0和EL1是共用EL1的异常向量表。</p>
<p>下图是一张异常向量表的示例，可以看到异常向量表分为4组，每组有4种类型。</p>
<p>异常向量表为什么分为4组？ （1）当系统的发生异常处于内核态，异常等级为ELx（EL1/EL2/EL3）时，可以选择使用SP_EL0或SP_ELx来作为栈指针，所以分为Current EL with SP0和Current EL with SPx两组。目前对于arm64的嵌入式设备来说，通常只有到EL1等级，EL2用于虚拟化，EL3用于安全基本，所以EL2和EL3基本没有用。 （2）当系统的发生在用户态（EL0），会下陷到内核变为EL1，但是会根据执行状态是aarch64或者aarch32来区分两组，Lower EL using AArch64或Lower EL using AArch32。</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_af808db86932ba6136ca71480519e505.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/中断管理/arm64体系结构简介/images/wp_editor_md_af808db86932ba6136ca71480519e505.jpg"/></a></p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_652e4d45dde75ecd30f79fca1919fdda.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/中断管理/arm64体系结构简介/images/wp_editor_md_652e4d45dde75ecd30f79fca1919fdda.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">entry</span><span class="p">.</span><span class="n">S</span>

<span class="n">SYM_CODE_START</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span>
<span class="w">    </span><span class="cp">#内核态发生异常，异常等级为EL1，但是栈依旧使用的是SP_EL0</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span><span class="w">      </span><span class="c1">// Synchronous EL1t</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">irq</span><span class="w">       </span><span class="c1">// IRQ EL1t</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">fiq</span><span class="w">       </span><span class="c1">// FIQ EL1h</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="w">     </span><span class="c1">// Error EL1t</span>
<span class="w">    </span><span class="cp">#内核态发生异常，异常等级为EL1，但是栈使用是SP_EL1</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span><span class="w">      </span><span class="c1">// Synchronous EL1h</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">irq</span><span class="w">       </span><span class="c1">// IRQ EL1h</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">fiq</span><span class="w">       </span><span class="c1">// FIQ EL1h</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="w">     </span><span class="c1">// Error EL1h</span>
<span class="w">    </span><span class="cp">#用户态发生异常，异常等级为EL0（切到内核会转为EL1），到内核后执行状态是aarch64</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span><span class="w">      </span><span class="c1">// Synchronous 64-bit EL0</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">irq</span><span class="w">       </span><span class="c1">// IRQ 64-bit EL0</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">fiq</span><span class="w">       </span><span class="c1">// FIQ 64-bit EL0</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="w">     </span><span class="c1">// Error 64-bit EL0</span>
<span class="w">    </span><span class="cp">#用户态发生异常，异常等级为EL0（切到内核会转为EL1），到内核后执行状态是aarch32</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span><span class="w">      </span><span class="c1">// Synchronous 32-bit EL0</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">irq</span><span class="w">       </span><span class="c1">// IRQ 32-bit EL0</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">fiq</span><span class="w">       </span><span class="c1">// FIQ 32-bit EL0</span>
<span class="w">    </span><span class="n">kernel_ventry</span><span class="w">   </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="w">     </span><span class="c1">// Error 32-bit EL0</span>
<span class="n">SYM_CODE_END</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="/laumy.github.io/posts/linux/linux中断实现.html">← Linux中断实现</a>
    <a class="next" href="/laumy.github.io/posts/linux/中断基本概念.html">中断基本概念 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="/laumy.github.io/assets/site.js"></script>
  </body>
  </html>

