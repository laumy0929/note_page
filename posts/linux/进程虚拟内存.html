<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>进程虚拟内存 - Laumy的技术栈</title>
    <link rel="stylesheet" href="/laumy.github.io/assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="/laumy.github.io/">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="/laumy.github.io/">首页</a></div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#_1">进程虚拟地址空间</a><ul><li><a href="#executable-and-linkable-formatelf">Executable and Linkable Format（ELF）</a></li><li><a href="#_2">进程虚拟地址空间布局</a></li></ul></li><li><a href="#_3">虚拟地址空间描述</a><ul></ul></li><li><a href="#_4">操作系统角度看可执行文件的装载运行</a><ul></ul></li><li><a href="#vma">VMA的操作函数</a><ul><li><a href="#vma_1">VMA查找</a></li><li><a href="#vma_2">VMA插入</a></li><li><a href="#vma_3">VMA合并与拆分</a></li></ul></li><li><a href="#malloc">malloc函数</a><ul><li><a href="#malloc_1">与malloc相关的函数</a></li><li><a href="#malloc_2">malloc系统调用流程</a></li></ul></li><li><a href="#mmap">mmap函数</a><ul><li><a href="#_5">基本概念</a></li><li><a href="#_6">实现原理</a></li></ul></li><li><a href="#_7">缺页异常</a><ul><li><a href="#do_page_fault">do_page_fault</a></li><li><a href="#_8">匿名页面</a></li><li><a href="#_9">文件页面</a></li><li><a href="#swap">swap页面换入</a></li><li><a href="#cow">页面写时复制COW</a></li></ul></li><li><a href="#rmap">RMAP</a><ul><li><a href="#_10">关键数据结构</a></li><li><a href="#_11">基本原理</a></li><li><a href="#_12">映射到一个进程的反向映射</a></li><li><a href="#_13">映射到多个进程的反向映射</a></li><li><a href="#_16">反向映射的应用</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>进程虚拟内存</h1>
  <div class="meta">2023-08-26 · linux</div>
  <div class="post-content"><h2 id="_1">进程虚拟地址空间</h2>
<h3 id="executable-and-linkable-formatelf">Executable and Linkable Format（ELF）</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_084108bffd6a37851ac96f61c55c3863.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_084108bffd6a37851ac96f61c55c3863.jpg"/></a>   上图是可执行文件的内容结构图，由ELF header、program headers、各section、sections headers组成。 - ELF header：描述整个文件的基本属性，如文件版本号、目标机器型号、程序入口地址等。 - program headers：描述ELF文件该如何被操作系统映射到进程的虚拟地址空间，对于LOAD类型的Segment，每个Segment对应一个VMA。对于操作系统来说，并不关心各个section所包含的内容，它只关心跟装载相关的问题，最主要的是section的权限（可读，可写，可执行），所以对于相同类型的section，将会被合并成要给Segment进行映射，如init/text/rodata，这些都是可读可执行所以合并成一个Segment来描述。对于.o文件是没有program heades的。 - sections：代码经过编译之后，将会分类链接多个section，如init/text/data/bss。 - sections headers：用于ELF文件中各sections的。</p>
<h4 id="elf-header">ELF header</h4>
<p>描述ELF header的结构体</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">e_ident</span><span class="p">[</span><span class="n">EI_NIDENT</span><span class="p">];</span><span class="w"> </span><span class="cm">/* 16 bytes */</span>
<span class="w"> </span><span class="n">Elf64_Half</span><span class="w"> </span><span class="n">e_type</span><span class="p">;</span><span class="w"> </span><span class="cm">/* File type */</span>
<span class="w"> </span><span class="p">....</span>
<span class="w"> </span><span class="n">Elf64_Addr</span><span class="w"> </span><span class="n">e_entry</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Entry point virtual address */</span>
<span class="w"> </span><span class="n">Elf64_Off</span><span class="w"> </span><span class="n">e_phoff</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Prog headers file offset */</span>
<span class="w"> </span><span class="n">Elf64_Off</span><span class="w"> </span><span class="n">e_shoff</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Sec headers file offset */</span>
<span class="w"> </span><span class="p">....</span>
<span class="w"> </span><span class="n">Elf64_Half</span><span class="w"> </span><span class="n">e_phentsize</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Prog headers entry size */</span>
<span class="w"> </span><span class="n">Elf64_Half</span><span class="w"> </span><span class="n">e_phnum</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Prog headers entry count */</span>
<span class="w"> </span><span class="n">Elf64_Half</span><span class="w"> </span><span class="n">e_shentsize</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Sec headers entry size */</span>
<span class="w"> </span><span class="n">Elf64_Half</span><span class="w"> </span><span class="n">e_shnum</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Sec headers entry count */</span>
<span class="w"> </span><span class="n">Elf64_Half</span><span class="w"> </span><span class="n">e_shstrndx</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Sec string table index */</span>
<span class="p">}</span><span class="w"> </span><span class="n">Elf64_Ehdr</span><span class="p">;</span>
</code></pre></div>
<p>可以通过readelf -h 来获取ELF的header信息。</p>
<div class="codehilite"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">readelf</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="w"> </span><span class="n">wifi_daemon</span>
<span class="n">ELF</span><span class="w"> </span><span class="n">Header</span><span class="o">:</span>
<span class="w">  </span><span class="nl">Magic</span><span class="p">:</span><span class="w">   </span><span class="mf">7f</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">46</span><span class="w"> </span><span class="mo">02</span><span class="w"> </span><span class="mo">01</span><span class="w"> </span><span class="mo">01</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span>
<span class="w">  </span><span class="nl">Class</span><span class="p">:</span><span class="w">                             </span><span class="n">ELF64</span>
<span class="w">  </span><span class="nl">Data</span><span class="p">:</span><span class="w">                              </span><span class="mi">2</span><span class="err">'</span><span class="n">s</span><span class="w"> </span><span class="n">complement</span><span class="p">,</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">endian</span>
<span class="w">  </span><span class="nl">Version</span><span class="p">:</span><span class="w">                           </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
<span class="w">  </span><span class="n">OS</span><span class="o">/</span><span class="n">ABI</span><span class="o">:</span><span class="w">                            </span><span class="n">UNIX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="n">V</span>
<span class="w">  </span><span class="n">ABI</span><span class="w"> </span><span class="n">Version</span><span class="o">:</span><span class="w">                       </span><span class="mi">0</span>
<span class="w">  </span><span class="nl">Type</span><span class="p">:</span><span class="w">                              </span><span class="n">EXEC</span><span class="w"> </span><span class="p">(</span><span class="n">Executable</span><span class="w"> </span><span class="n">file</span><span class="p">)</span>
<span class="w">  </span><span class="nl">Machine</span><span class="p">:</span><span class="w">                           </span><span class="n">AArch64</span>
<span class="w">  </span><span class="nl">Version</span><span class="p">:</span><span class="w">                           </span><span class="mh">0x1</span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">address</span><span class="o">:</span><span class="w">               </span><span class="mh">0x401c00</span>
<span class="w">  </span><span class="n">Start</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">headers</span><span class="o">:</span><span class="w">          </span><span class="mi">64</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">file</span><span class="p">)</span>
<span class="w">  </span><span class="n">Start</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">headers</span><span class="o">:</span><span class="w">          </span><span class="mi">44568</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">file</span><span class="p">)</span>
<span class="w">  </span><span class="nl">Flags</span><span class="p">:</span><span class="w">                             </span><span class="mh">0x0</span>
<span class="w">  </span><span class="n">Size</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">header</span><span class="o">:</span><span class="w">               </span><span class="mi">64</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
<span class="w">  </span><span class="n">Size</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">headers</span><span class="o">:</span><span class="w">           </span><span class="mi">56</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
<span class="w">  </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">headers</span><span class="o">:</span><span class="w">         </span><span class="mi">9</span>
<span class="w">  </span><span class="n">Size</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">headers</span><span class="o">:</span><span class="w">           </span><span class="mi">64</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
<span class="w">  </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">headers</span><span class="o">:</span><span class="w">         </span><span class="mi">29</span>
<span class="w">  </span><span class="n">Section</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">index</span><span class="o">:</span><span class="w"> </span><span class="mi">28</span>
</code></pre></div>
<h4 id="program-headers">program headers</h4>
<p>描述Program header的结构体。</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Program header for ELF64.</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w">  </span><span class="p">{</span>
<span class="w">  </span><span class="n">Elf64_Word</span><span class="w"> </span><span class="n">p_type</span><span class="p">;</span><span class="w">    </span><span class="c1">// Type of segment</span>
<span class="w">  </span><span class="n">Elf64_Word</span><span class="w"> </span><span class="n">p_flags</span><span class="p">;</span><span class="w">   </span><span class="c1">// Segment flags</span>
<span class="w">  </span><span class="n">Elf64_Off</span><span class="w"> </span><span class="n">p_offset</span><span class="p">;</span><span class="w">   </span><span class="c1">// File offset where segment is located, in bytes</span>
<span class="w">  </span><span class="n">Elf64_Addr</span><span class="w"> </span><span class="n">p_vaddr</span><span class="p">;</span><span class="w">   </span><span class="c1">// Virtual address of beginning of segment</span>
<span class="w">  </span><span class="n">Elf64_Addr</span><span class="w"> </span><span class="n">p_paddr</span><span class="p">;</span><span class="w">   </span><span class="c1">// Physical addr of beginning of segment (OS-specific)</span>
<span class="w">  </span><span class="n">Elf64_Xword</span><span class="w"> </span><span class="n">p_filesz</span><span class="p">;</span><span class="w"> </span><span class="c1">// Num. of bytes in file image of segment (may be zero)</span>
<span class="w">  </span><span class="n">Elf64_Xword</span><span class="w"> </span><span class="n">p_memsz</span><span class="p">;</span><span class="w">  </span><span class="c1">// Num. of bytes in mem image of segment (may be zero)</span>
<span class="w">  </span><span class="n">Elf64_Xword</span><span class="w"> </span><span class="n">p_align</span><span class="p">;</span><span class="w">  </span><span class="c1">// Segment alignment constraint</span>
<span class="p">}</span><span class="w"> </span><span class="n">Elf64_Phdr</span><span class="p">;</span>
</code></pre></div>
<p>可以通过readelf -l []来获取ELF的pragram header信息。</p>
<div class="codehilite"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">readelf</span><span class="w"> </span><span class="o">-</span><span class="n">l</span><span class="w"> </span><span class="n">wifi_daemon</span>

<span class="n">Elf</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">EXEC</span><span class="w"> </span><span class="p">(</span><span class="n">Executable</span><span class="w"> </span><span class="n">file</span><span class="p">)</span>
<span class="n">Entry</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="mh">0x401c00</span>
<span class="n">There</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">headers</span><span class="p">,</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">64</span>

<span class="n">Program</span><span class="w"> </span><span class="n">Headers</span><span class="o">:</span>
<span class="w">  </span><span class="n">Type</span><span class="w">           </span><span class="n">Offset</span><span class="w">             </span><span class="n">VirtAddr</span><span class="w">           </span><span class="n">PhysAddr</span>
<span class="w">                 </span><span class="n">FileSiz</span><span class="w">            </span><span class="n">MemSiz</span><span class="w">              </span><span class="n">Flags</span><span class="w">  </span><span class="n">Align</span>
<span class="w">  </span><span class="n">PHDR</span><span class="w">           </span><span class="mh">0x0000000000000040</span><span class="w"> </span><span class="mh">0x0000000000400040</span><span class="w"> </span><span class="mh">0x0000000000400040</span>
<span class="w">                 </span><span class="mh">0x00000000000001f8</span><span class="w"> </span><span class="mh">0x00000000000001f8</span><span class="w">  </span><span class="n">R</span><span class="w">      </span><span class="mi">8</span>
<span class="w">  </span><span class="n">INTERP</span><span class="w">         </span><span class="mh">0x0000000000000238</span><span class="w"> </span><span class="mh">0x0000000000400238</span><span class="w"> </span><span class="mh">0x0000000000400238</span>
<span class="w">                 </span><span class="mh">0x000000000000001b</span><span class="w"> </span><span class="mh">0x000000000000001b</span><span class="w">  </span><span class="n">R</span><span class="w">      </span><span class="mi">1</span>
<span class="w">      </span><span class="p">[</span><span class="n">Requesting</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">interpreter</span><span class="o">:</span><span class="w"> </span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">aarch64</span><span class="p">.</span><span class="n">so</span><span class="mf">.1</span><span class="p">]</span>
<span class="w">  </span><span class="n">LOAD</span><span class="w">           </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="mh">0x0000000000400000</span><span class="w"> </span><span class="mh">0x0000000000400000</span>
<span class="w">                 </span><span class="mh">0x000000000000899c</span><span class="w"> </span><span class="mh">0x000000000000899c</span><span class="w">  </span><span class="n">R</span><span class="w"> </span><span class="n">E</span><span class="w">    </span><span class="mi">10000</span>
<span class="w">  </span><span class="n">LOAD</span><span class="w">           </span><span class="mh">0x0000000000008b60</span><span class="w"> </span><span class="mh">0x0000000000418b60</span><span class="w"> </span><span class="mh">0x0000000000418b60</span>
<span class="w">                 </span><span class="mh">0x00000000000005b4</span><span class="w"> </span><span class="mh">0x00000000000005e0</span><span class="w">  </span><span class="n">RW</span><span class="w">     </span><span class="mi">10000</span>
<span class="w">  </span><span class="n">DYNAMIC</span><span class="w">        </span><span class="mh">0x0000000000008b68</span><span class="w"> </span><span class="mh">0x0000000000418b68</span><span class="w"> </span><span class="mh">0x0000000000418b68</span>
<span class="w">                 </span><span class="mh">0x0000000000000270</span><span class="w"> </span><span class="mh">0x0000000000000270</span><span class="w">  </span><span class="n">RW</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="n">NOTE</span><span class="w">           </span><span class="mh">0x0000000000000254</span><span class="w"> </span><span class="mh">0x0000000000400254</span><span class="w"> </span><span class="mh">0x0000000000400254</span>
<span class="w">                 </span><span class="mh">0x0000000000000020</span><span class="w"> </span><span class="mh">0x0000000000000020</span><span class="w">  </span><span class="n">R</span><span class="w">      </span><span class="mi">4</span>
<span class="w">  </span><span class="n">GNU_EH_FRAME</span><span class="w">   </span><span class="mh">0x0000000000008628</span><span class="w"> </span><span class="mh">0x0000000000408628</span><span class="w"> </span><span class="mh">0x0000000000408628</span>
<span class="w">                 </span><span class="mh">0x000000000000008c</span><span class="w"> </span><span class="mh">0x000000000000008c</span><span class="w">  </span><span class="n">R</span><span class="w">      </span><span class="mi">4</span>
<span class="w">  </span><span class="n">GNU_STACK</span><span class="w">      </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="mh">0x0000000000000000</span>
<span class="w">                 </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w">  </span><span class="n">RW</span><span class="w">     </span><span class="mi">10</span>
<span class="w">  </span><span class="n">GNU_RELRO</span><span class="w">      </span><span class="mh">0x0000000000008b60</span><span class="w"> </span><span class="mh">0x0000000000418b60</span><span class="w"> </span><span class="mh">0x0000000000418b60</span>
<span class="w">                 </span><span class="mh">0x00000000000004a0</span><span class="w"> </span><span class="mh">0x00000000000004a0</span><span class="w">  </span><span class="n">R</span><span class="w">      </span><span class="mi">1</span>

<span class="w"> </span><span class="n">Section</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Segment</span><span class="w"> </span><span class="n">mapping</span><span class="o">:</span>
<span class="w">  </span><span class="n">Segment</span><span class="w"> </span><span class="n">Sections</span><span class="p">...</span>
<span class="w">   </span><span class="mo">00</span>
<span class="w">   </span><span class="mo">01</span><span class="w">     </span><span class="p">.</span><span class="n">interp</span>
<span class="mo">02</span><span class="w">     </span><span class="p">.</span><span class="n">interp</span><span class="w"> </span><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">ABI</span><span class="o">-</span><span class="n">tag</span><span class="w"> </span><span class="p">.</span><span class="n">hash</span><span class="w"> </span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">hash</span><span class="w"> </span><span class="p">.</span><span class="n">dynsym</span><span class="w"> </span><span class="p">.</span><span class="n">dynstr</span><span class="w"> </span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">version_r</span><span class="w"> </span><span class="p">.</span><span class="n">rela</span><span class="p">.</span><span class="n">dyn</span><span class="w"> </span><span class="p">.</span><span class="n">rela</span><span class="p">.</span><span class="n">plt</span><span class="w"> </span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="p">.</span><span class="n">plt</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="w"> </span><span class="p">.</span><span class="n">fini</span><span class="w"> </span><span class="p">.</span><span class="n">rodata</span><span class="w"> </span><span class="p">.</span><span class="n">eh_frame_hdr</span><span class="w"> </span><span class="p">.</span><span class="n">eh_frame</span>
<span class="w">   </span><span class="mo">03</span><span class="w">     </span><span class="p">.</span><span class="n">init_array</span><span class="w"> </span><span class="p">.</span><span class="n">fini_array</span><span class="w"> </span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">rel</span><span class="p">.</span><span class="n">ro</span><span class="w"> </span><span class="p">.</span><span class="n">dynamic</span><span class="w"> </span><span class="p">.</span><span class="n">got</span><span class="w"> </span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="p">.</span><span class="n">bss</span>
<span class="w">   </span><span class="mo">04</span><span class="w">     </span><span class="p">.</span><span class="n">dynamic</span>
<span class="w">   </span><span class="mo">05</span><span class="w">     </span><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">ABI</span><span class="o">-</span><span class="n">tag</span>
<span class="w">   </span><span class="mo">06</span><span class="w">     </span><span class="p">.</span><span class="n">eh_frame_hdr</span>
<span class="w">   </span><span class="mo">07</span>
<span class="w">   </span><span class="mi">08</span><span class="w">     </span><span class="p">.</span><span class="n">init_array</span><span class="w"> </span><span class="p">.</span><span class="n">fini_array</span><span class="w"> </span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">rel</span><span class="p">.</span><span class="n">ro</span><span class="w"> </span><span class="p">.</span><span class="n">dynamic</span><span class="w"> </span><span class="p">.</span><span class="n">got</span>
</code></pre></div>
<p>从上可以看出一共有9各segment，与前面elf header信息中的Number of program headers:9对应。这里我们重点关注02和03的segment即可，因为这两个segment的类型是LOAD类型，每个segment就对应一个VMA，与我们后面关于虚拟地址到物理地址的映射有着非常重要的联系。 操作系统只关心段的权限（可读、可写、可执行），所以对于相同类型权限段可以合并到一起当作一个段来映射，所以通常的分类有一下三种： - 可读可执行：代码块为代表 - 可读可写：data块和BSS块为代表 - 只读：rodata块为代表</p>
<h4 id="sections">sections</h4>
<p>下面是描述sections headers的结构体。</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Section header.</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Elf32_Shdr</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w"> </span><span class="n">sh_name</span><span class="p">;</span><span class="w">      </span><span class="c1">// Section name (index into string table)</span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w"> </span><span class="n">sh_type</span><span class="p">;</span><span class="w">      </span><span class="c1">// Section type (SHT_*)</span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w"> </span><span class="n">sh_flags</span><span class="p">;</span><span class="w">     </span><span class="c1">// Section flags (SHF_*)</span>
<span class="w">  </span><span class="n">Elf32_Addr</span><span class="w"> </span><span class="n">sh_addr</span><span class="p">;</span><span class="w">      </span><span class="c1">// Address where section is to be loaded</span>
<span class="w">  </span><span class="n">Elf32_Off</span><span class="w"> </span><span class="n">sh_offset</span><span class="p">;</span><span class="w">     </span><span class="c1">// File offset of section data, in bytes</span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w"> </span><span class="n">sh_size</span><span class="p">;</span><span class="w">      </span><span class="c1">// Size of section, in bytes</span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w"> </span><span class="n">sh_link</span><span class="p">;</span><span class="w">      </span><span class="c1">// Section type-specific header table index link</span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w"> </span><span class="n">sh_info</span><span class="p">;</span><span class="w">      </span><span class="c1">// Section type-specific extra information</span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w"> </span><span class="n">sh_addralign</span><span class="p">;</span><span class="w"> </span><span class="c1">// Section address alignment</span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w"> </span><span class="n">sh_entsize</span><span class="p">;</span><span class="w">   </span><span class="c1">// Size of records contained within the section</span>
<span class="p">};</span>
</code></pre></div>
<p>可以通过readelf -S []来读取ELF的section header的信息。</p>
<div class="codehilite"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">readelf</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="n">wifi_daemon</span>
<span class="n">There</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">headers</span><span class="p">,</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0xae18</span><span class="o">:</span>

<span class="n">Section</span><span class="w"> </span><span class="n">Headers</span><span class="o">:</span>
<span class="w">  </span><span class="p">[</span><span class="n">Nr</span><span class="p">]</span><span class="w"> </span><span class="n">Name</span><span class="w">              </span><span class="n">Type</span><span class="w">             </span><span class="n">Address</span><span class="w">           </span><span class="n">Offset</span>
<span class="w">       </span><span class="n">Size</span><span class="w">              </span><span class="n">EntSize</span><span class="w">          </span><span class="n">Flags</span><span class="w">  </span><span class="n">Link</span><span class="w">  </span><span class="n">Info</span><span class="w">  </span><span class="n">Align</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w">                   </span><span class="nb">NULL</span><span class="w">             </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="mo">00000000</span>
<span class="w">       </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">           </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">interp</span><span class="w">           </span><span class="n">PROGBITS</span><span class="w">         </span><span class="mo">000000000040023</span><span class="mi">8</span><span class="w">  </span><span class="mo">0000023</span><span class="mi">8</span>
<span class="w">       </span><span class="mo">000000000000001</span><span class="n">b</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">   </span><span class="n">A</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">1</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">ABI</span><span class="o">-</span><span class="n">tag</span><span class="w">     </span><span class="n">NOTE</span><span class="w">             </span><span class="mo">0000000000400254</span><span class="w">  </span><span class="mo">00000254</span>
<span class="w">       </span><span class="mo">0000000000000020</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">   </span><span class="n">A</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">4</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">hash</span><span class="w">             </span><span class="n">HASH</span><span class="w">             </span><span class="mo">000000000040027</span><span class="mi">8</span><span class="w">  </span><span class="mo">0000027</span><span class="mi">8</span>
<span class="w">       </span><span class="mo">00000000000001</span><span class="n">a0</span><span class="w">  </span><span class="mo">0000000000000004</span><span class="w">   </span><span class="n">A</span><span class="w">       </span><span class="mi">5</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">hash</span><span class="w">         </span><span class="n">GNU_HASH</span><span class="w">         </span><span class="mo">000000000040041</span><span class="mi">8</span><span class="w">  </span><span class="mo">0000041</span><span class="mi">8</span>
<span class="w">       </span><span class="mo">0000000000000024</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">   </span><span class="n">A</span><span class="w">       </span><span class="mi">5</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">dynsym</span><span class="w">           </span><span class="n">DYNSYM</span><span class="w">           </span><span class="mo">0000000000400440</span><span class="w">  </span><span class="mo">00000440</span>
<span class="w">       </span><span class="mo">000000000000061</span><span class="mi">8</span><span class="w">  </span><span class="mo">000000000000001</span><span class="mi">8</span><span class="w">   </span><span class="n">A</span><span class="w">       </span><span class="mi">6</span><span class="w">     </span><span class="mi">1</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">dynstr</span><span class="w">           </span><span class="n">STRTAB</span><span class="w">           </span><span class="mo">0000000000400</span><span class="n">a58</span><span class="w">  </span><span class="mo">00000</span><span class="n">a58</span>
<span class="w">       </span><span class="mo">00000000000003</span><span class="n">b8</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">   </span><span class="n">A</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">1</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">version</span><span class="w">      </span><span class="n">VERSYM</span><span class="w">           </span><span class="mf">0000000000400e10</span><span class="w">  </span><span class="mf">00000e10</span>
<span class="w">       </span><span class="mo">00000000000000</span><span class="mi">82</span><span class="w">  </span><span class="mo">0000000000000002</span><span class="w">   </span><span class="n">A</span><span class="w">       </span><span class="mi">5</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">2</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">version_r</span><span class="w">    </span><span class="n">VERNEED</span><span class="w">          </span><span class="mf">0000000000400e98</span><span class="w">  </span><span class="mf">00000e98</span>
<span class="w">       </span><span class="mo">0000000000000060</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">   </span><span class="n">A</span><span class="w">       </span><span class="mi">6</span><span class="w">     </span><span class="mi">3</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">9</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">rela</span><span class="p">.</span><span class="n">dyn</span><span class="w">         </span><span class="n">RELA</span><span class="w">             </span><span class="mo">0000000000400</span><span class="n">ef8</span><span class="w">  </span><span class="mo">00000</span><span class="n">ef8</span>
<span class="w">       </span><span class="mo">0000000000000030</span><span class="w">  </span><span class="mo">000000000000001</span><span class="mi">8</span><span class="w">   </span><span class="n">A</span><span class="w">       </span><span class="mi">5</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">rela</span><span class="p">.</span><span class="n">plt</span><span class="w">         </span><span class="n">RELA</span><span class="w">             </span><span class="mf">0000000000400f</span><span class="mi">28</span><span class="w">  </span><span class="mf">00000f</span><span class="mi">28</span>
<span class="w">       </span><span class="mf">00000000000005e8</span><span class="w">  </span><span class="mo">000000000000001</span><span class="mi">8</span><span class="w">  </span><span class="n">AI</span><span class="w">       </span><span class="mi">5</span><span class="w">    </span><span class="mi">22</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">init</span><span class="w">             </span><span class="n">PROGBITS</span><span class="w">         </span><span class="mo">0000000000401510</span><span class="w">  </span><span class="mo">00001510</span>
<span class="w">       </span><span class="mo">000000000000001</span><span class="mi">8</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">AX</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">4</span>
<span class="w">  </span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">plt</span><span class="w">              </span><span class="n">PROGBITS</span><span class="w">         </span><span class="mo">0000000000401530</span><span class="w">  </span><span class="mo">00001530</span>
<span class="w">       </span><span class="mo">0000000000000410</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">AX</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">16</span>
<span class="w">  </span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="w">             </span><span class="n">PROGBITS</span><span class="w">         </span><span class="mo">0000000000401</span><span class="mi">940</span><span class="w">  </span><span class="mo">00001</span><span class="mi">940</span>
<span class="w">       </span><span class="mf">00000000000038e4</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">AX</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">64</span>
<span class="w">  </span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">fini</span><span class="w">             </span><span class="n">PROGBITS</span><span class="w">         </span><span class="mo">0000000000405224</span><span class="w">  </span><span class="mo">00005224</span>
<span class="w">       </span><span class="mo">0000000000000014</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">AX</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">4</span>
<span class="w">  </span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">rodata</span><span class="w">           </span><span class="n">PROGBITS</span><span class="w">         </span><span class="mo">000000000040523</span><span class="mi">8</span><span class="w">  </span><span class="mo">0000523</span><span class="mi">8</span>
<span class="w">       </span><span class="mf">00000000000033f</span><span class="mi">0</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">   </span><span class="n">A</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">eh_frame_hdr</span><span class="w">     </span><span class="n">PROGBITS</span><span class="w">         </span><span class="mo">000000000040</span><span class="mi">8628</span><span class="w">  </span><span class="mo">0000</span><span class="mi">8628</span>
<span class="w">       </span><span class="mo">00000000000000</span><span class="mi">8</span><span class="n">c</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">   </span><span class="n">A</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">4</span>
<span class="w">  </span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">eh_frame</span><span class="w">         </span><span class="n">PROGBITS</span><span class="w">         </span><span class="mo">000000000040</span><span class="mi">86</span><span class="n">b8</span><span class="w">  </span><span class="mo">0000</span><span class="mi">86</span><span class="n">b8</span>
<span class="w">       </span><span class="mf">00000000000002e4</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">   </span><span class="n">A</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="mi">18</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">init_array</span><span class="w">       </span><span class="n">INIT_ARRAY</span><span class="w">       </span><span class="mo">000000000041</span><span class="mi">8</span><span class="n">b60</span><span class="w">  </span><span class="mo">0000</span><span class="mi">8</span><span class="n">b60</span>
<span class="w">       </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="mo">000000000000000</span><span class="mi">8</span><span class="w">  </span><span class="n">WA</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">1</span>
<span class="w">  </span><span class="p">[</span><span class="mi">19</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">fini_array</span><span class="w">       </span><span class="n">FINI_ARRAY</span><span class="w">       </span><span class="mo">000000000041</span><span class="mi">8</span><span class="n">b60</span><span class="w">  </span><span class="mo">0000</span><span class="mi">8</span><span class="n">b60</span>
<span class="w">       </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="mo">000000000000000</span><span class="mi">8</span><span class="w">  </span><span class="n">WA</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">1</span>
<span class="w">  </span><span class="p">[</span><span class="mi">20</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">rel</span><span class="p">.</span><span class="n">ro</span><span class="w">      </span><span class="n">PROGBITS</span><span class="w">         </span><span class="mo">000000000041</span><span class="mi">8</span><span class="n">b60</span><span class="w">  </span><span class="mo">0000</span><span class="mi">8</span><span class="n">b60</span>
<span class="w">       </span><span class="mo">000000000000000</span><span class="mi">8</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">WA</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">dynamic</span><span class="w">          </span><span class="n">DYNAMIC</span><span class="w">          </span><span class="mo">000000000041</span><span class="mi">8</span><span class="n">b68</span><span class="w">  </span><span class="mo">0000</span><span class="mi">8</span><span class="n">b68</span>
<span class="w">       </span><span class="mo">0000000000000270</span><span class="w">  </span><span class="mo">0000000000000010</span><span class="w">  </span><span class="n">WA</span><span class="w">       </span><span class="mi">6</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="mi">22</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">got</span><span class="w">              </span><span class="n">PROGBITS</span><span class="w">         </span><span class="mo">000000000041</span><span class="mi">8</span><span class="n">dd8</span><span class="w">  </span><span class="mo">0000</span><span class="mi">8</span><span class="n">dd8</span>
<span class="w">       </span><span class="mo">000000000000022</span><span class="mi">8</span><span class="w">  </span><span class="mo">000000000000000</span><span class="mi">8</span><span class="w">  </span><span class="n">WA</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="mi">23</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">data</span><span class="w">             </span><span class="n">PROGBITS</span><span class="w">         </span><span class="mo">000000000041</span><span class="mi">9000</span><span class="w">  </span><span class="mo">0000</span><span class="mi">9000</span>
<span class="w">       </span><span class="mo">0000000000000114</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">WA</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="mi">24</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">bss</span><span class="w">              </span><span class="n">NOBITS</span><span class="w">           </span><span class="mo">000000000041</span><span class="mi">9118</span><span class="w">  </span><span class="mo">0000</span><span class="mi">9114</span>
<span class="w">       </span><span class="mo">000000000000002</span><span class="mi">8</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">WA</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="mi">25</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">comment</span><span class="w">          </span><span class="n">PROGBITS</span><span class="w">         </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="mo">0000</span><span class="mi">9114</span>
<span class="w">       </span><span class="mo">0000000000000033</span><span class="w">  </span><span class="mo">0000000000000001</span><span class="w">  </span><span class="n">MS</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">1</span>
<span class="w">  </span><span class="p">[</span><span class="mi">26</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">symtab</span><span class="w">           </span><span class="n">SYMTAB</span><span class="w">           </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="mo">0000</span><span class="mi">9148</span>
<span class="w">       </span><span class="mo">00000000000011</span><span class="n">a0</span><span class="w">  </span><span class="mo">000000000000001</span><span class="mi">8</span><span class="w">          </span><span class="mi">27</span><span class="w">   </span><span class="mi">103</span><span class="w">     </span><span class="mi">8</span>
<span class="w">  </span><span class="p">[</span><span class="mi">27</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">strtab</span><span class="w">           </span><span class="n">STRTAB</span><span class="w">           </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="mo">0000</span><span class="n">a2e8</span>
<span class="w">       </span><span class="mo">0000000000000</span><span class="n">a38</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">           </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">1</span>
<span class="w">  </span><span class="p">[</span><span class="mi">28</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">shstrtab</span><span class="w">         </span><span class="n">STRTAB</span><span class="w">           </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="mo">0000</span><span class="n">ad20</span>
<span class="w">       </span><span class="mf">00000000000000f</span><span class="mi">4</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">           </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">1</span>
<span class="n">Key</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Flags</span><span class="o">:</span>
<span class="w">  </span><span class="n">W</span><span class="w"> </span><span class="p">(</span><span class="n">write</span><span class="p">),</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p">(</span><span class="n">alloc</span><span class="p">),</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="p">(</span><span class="n">execute</span><span class="p">),</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="p">(</span><span class="n">merge</span><span class="p">),</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="p">(</span><span class="n">strings</span><span class="p">)</span>
<span class="w">  </span><span class="n">I</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="p">),</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="p">(</span><span class="n">link</span><span class="w"> </span><span class="n">order</span><span class="p">),</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="p">(</span><span class="n">group</span><span class="p">),</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">(</span><span class="n">TLS</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="p">(</span><span class="n">exclude</span><span class="p">),</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">unknown</span><span class="p">)</span>
<span class="w">  </span><span class="n">O</span><span class="w"> </span><span class="p">(</span><span class="n">extra</span><span class="w"> </span><span class="n">OS</span><span class="w"> </span><span class="n">processing</span><span class="w"> </span><span class="n">required</span><span class="p">)</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="p">(</span><span class="n">OS</span><span class="w"> </span><span class="n">specific</span><span class="p">),</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">(</span><span class="n">processor</span><span class="w"> </span><span class="n">specific</span><span class="p">)</span>
</code></pre></div>
<p>可以看出wifi_daemon中一共有29个section，与ELF header描述内容中的Number of section headers:29是匹配的。</p>
<h3 id="_2">进程虚拟地址空间布局</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_84f197c7354956b9c09ec9d32ccdec97.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_84f197c7354956b9c09ec9d32ccdec97.jpg"/></a>   系统对虚拟地址空间进行布局，在2.3章节中描述了内核空间的划分，同样针对用户空间也有进行了划分。可以分为4类： - 栈：用于维护函数调用的上下文，栈在用户空间的最高地址处分配，地址是向下增长。 - 堆：用户程序动态分配内存的区域，当使用malloc分配内存时，虚拟地址空间将在这个范围，地址向上增长。 - MMAP:在栈和堆空间有一个MMAP区域，主要用于mmap系统调用的映射。包括文件映射（包含动态库、文件IO）和匿名映射。 - 可执行文件映像：存储可执行文件在内存的映像，装载器会将ELF内容读取或映射到这里。   可执行文件映像可再进行分类，前面章节描述了，程序最终编译临界成各个sections，如text，data，bss等等，但对于系统来说关注的是加载的方式，如读写执行权限，因此可执行文件映像的分类是按照权限划分的。如上分为只读权限（对应init,text等section），读写权限（对应.data,bss等）。</p>
<h2 id="_3">虚拟地址空间描述</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_0bc071fc49abb0b7ab2526ed0779b15c.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_0bc071fc49abb0b7ab2526ed0779b15c.jpg"/></a>   Linux系统操作的是虚拟地址，访问实际内存需要将虚拟地址通过MMU查询页表，转化为物理地址。用户空间的虚拟地址可以按照如上图进行分为几个segment，每个segment都对应一个VMA。虚拟地址到物理地址的映射，是每个VMA到物理地址的映射。   VMA作为进程地址空间一块连续区域，使用struct vm_area_struct结构体进行描述。该结构体中描述了连续区域的起始地址和地址。   VMA之间通过双向链接连接在一起，在struct vm_area_struct中vm_next，vm_prev分别指向下一个VMA和上一个VMA，使用双向链表来组织VMA，便于进程虚拟地址对VMA的插入。   VMA同时又被加入到一棵红黑树中，在struct vm_area_struct中的vm_rb描述红黑树的节点，根节点在struct mm_struct mm_rb来描述，既然VMA通过链表串一起了，为什么再使用红黑树来组织，主要是使用红黑树能够加快进程搜索VMA的速度。   mm_struct数据结构中的pgd指向了该进程的页表页目录，每个进程都有自己一份独立的页表，当CPU第一次访问虚拟地址空间时，如果查询页表找不到对应的物理页，将会发生缺页异常，在缺页异常中，进行分配物理页面，当然如果页表没有创建，需要先申请物理页面创建页表，最后将物理页面填充到页表中，完成虚拟地址到物理地址的映射关系。   上图中数据结构的层级关系struct task_struct-&gt;struct mm_struct-&gt;struct vm_area_struct。   可以通过节点/proc/[pid]/maps来查看内存mappings，下面例子中每一行都表示一个VMA。可以man proc来查看各项参数意义。</p>
<div class="codehilite"><pre><span></span><code><span class="n">address</span><span class="w">           </span><span class="n">perms</span><span class="w"> </span><span class="n">offset</span><span class="w">  </span><span class="n">dev</span><span class="w">   </span><span class="n">inode</span><span class="w">       </span><span class="n">pathname</span>
<span class="mo">00400000-00452000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mo">00000000</span><span class="w"> </span><span class="mi">08</span><span class="o">:</span><span class="mo">02</span><span class="w"> </span><span class="mi">173521</span><span class="w">      </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dbus</span><span class="o">-</span><span class="n">daemon</span>
<span class="mo">00651000-00652000</span><span class="w"> </span><span class="n">r</span><span class="o">--</span><span class="n">p</span><span class="w"> </span><span class="mo">00051000</span><span class="w"> </span><span class="mi">08</span><span class="o">:</span><span class="mo">02</span><span class="w"> </span><span class="mi">173521</span><span class="w">      </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dbus</span><span class="o">-</span><span class="n">daemon</span>
<span class="mo">00652000-00655000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mo">00052000</span><span class="w"> </span><span class="mi">08</span><span class="o">:</span><span class="mo">02</span><span class="w"> </span><span class="mi">173521</span><span class="w">      </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dbus</span><span class="o">-</span><span class="n">daemon</span>
<span class="mf">00e03000-00e24000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="w"> </span><span class="mi">0</span><span class="w">           </span><span class="p">[</span><span class="n">heap</span><span class="p">]</span>
<span class="p">...</span>
<span class="mi">35</span><span class="n">b1800000</span><span class="mi">-35</span><span class="n">b1820000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mo">00000000</span><span class="w"> </span><span class="mi">08</span><span class="o">:</span><span class="mo">02</span><span class="w"> </span><span class="mi">135522</span><span class="w">  </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="mf">-2.15</span><span class="p">.</span><span class="n">so</span>
<span class="mi">35</span><span class="n">b1a1f000</span><span class="mi">-35</span><span class="n">b1a20000</span><span class="w"> </span><span class="n">r</span><span class="o">--</span><span class="n">p</span><span class="w"> </span><span class="mf">0001f</span><span class="mo">000</span><span class="w"> </span><span class="mi">08</span><span class="o">:</span><span class="mo">02</span><span class="w"> </span><span class="mi">135522</span><span class="w">  </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="mf">-2.15</span><span class="p">.</span><span class="n">so</span>
<span class="mi">35</span><span class="n">b1a20000</span><span class="mi">-35</span><span class="n">b1a21000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mo">00020000</span><span class="w"> </span><span class="mi">08</span><span class="o">:</span><span class="mo">02</span><span class="w"> </span><span class="mi">135522</span><span class="w">  </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="mf">-2.15</span><span class="p">.</span><span class="n">so</span>
<span class="mi">35</span><span class="n">b1a21000</span><span class="mi">-35</span><span class="n">b1a22000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">35</span><span class="n">b1c00000</span><span class="mi">-35</span><span class="n">b1dac000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mo">00000000</span><span class="w"> </span><span class="mi">08</span><span class="o">:</span><span class="mo">02</span><span class="w"> </span><span class="mi">135870</span><span class="w">  </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="mf">-2.15</span><span class="p">.</span><span class="n">so</span>
<span class="mi">35</span><span class="n">b1dac000</span><span class="mi">-35</span><span class="n">b1fac000</span><span class="w"> </span><span class="o">---</span><span class="n">p</span><span class="w"> </span><span class="mo">001</span><span class="n">ac000</span><span class="w"> </span><span class="mi">08</span><span class="o">:</span><span class="mo">02</span><span class="w"> </span><span class="mi">135870</span><span class="w">  </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="mf">-2.15</span><span class="p">.</span><span class="n">so</span>
<span class="mi">35</span><span class="n">b1fac000</span><span class="mi">-35</span><span class="n">b1fb0000</span><span class="w"> </span><span class="n">r</span><span class="o">--</span><span class="n">p</span><span class="w"> </span><span class="mo">001</span><span class="n">ac000</span><span class="w"> </span><span class="mi">08</span><span class="o">:</span><span class="mo">02</span><span class="w"> </span><span class="mi">135870</span><span class="w">  </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="mf">-2.15</span><span class="p">.</span><span class="n">so</span>
<span class="mi">35</span><span class="n">b1fb0000</span><span class="mi">-35</span><span class="n">b1fb2000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mo">001</span><span class="n">b0000</span><span class="w"> </span><span class="mi">08</span><span class="o">:</span><span class="mo">02</span><span class="w"> </span><span class="mi">135870</span><span class="w">  </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="mf">-2.15</span><span class="p">.</span><span class="n">so</span>
<span class="p">..</span>
<span class="mf">7f</span><span class="n">ffb2c0d000</span><span class="mi">-7</span><span class="n">fffb2c2e000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="p">[</span><span class="n">stack</span><span class="p">]</span>
</code></pre></div>
<ul>
<li>address: VMA对应的起始地址，对应struct vm_area_struct中的vm_start,vm_end。</li>
<li>perms：VMA的权限，r=read,w=write,x=execute,s=shared,p=private。s和p二选一，主要是判断当前的地址空间是进程私有，还是共享。</li>
<li>offset: 文件映射，表示此段虚拟内存起始地址在文件中以页为单位的偏移，匿名映射为0。</li>
<li>dev：所映射文件所属的设备号，匿名映射为0。</li>
<li>inode:映射文所属节点节点号，匿名映射为0。</li>
<li>pathname：文件映射，对应的就是映射的文件名。匿名映射，是此段虚拟内存在进程的角色，如heap，stack等。   是否可以查看进程虚拟内存都被谁占用了，对应的VMA的大小是否有增大趋势，可以用于判断内存泄露？</li>
</ul>
<h2 id="_4">操作系统角度看可执行文件的装载运行</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_5491bb24c4969fa6e432263f97684337.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_5491bb24c4969fa6e432263f97684337.jpg"/></a>   从操作系统角度看，一个进程最关键的特征是它拥有独立的虚拟地址空间，这使得它跟别的进程有差别。下面来看一个程序被执行比较通用的情形，流程如下： - 创建一个独立的虚拟地址空间。 - 建立执行程序虚拟空间与可执行文件的映射关系。 - 将CPU的指令寄存器设置成可执行文件的入口函数，启动运行。 - 运行过程中，通过缺页异常将指令、数据装载进内存。 （1）创建独立的虚拟地址空间   系统访问使用的是虚拟地址，虚拟地址通过查询页表找到对应的物理内存，因此最开始是创建好虚拟地址空间，而创建虚拟地址空间实际上并不是创建空间直接建立好跟物理内存的连续，而是先创建映射函数所需要的相应数据结构，比如task_struct,mm_struct等。对应页表的创建，实际上只分配了一个页目录就可以了，不需要设置页的映射关系，等实际程序访问的时候通过缺页异常才进行设置。 （2）建立执行程序虚拟空间与可执行文件的映射关系   上一个步骤建立了虚拟地址空间，这一步所做的建立虚拟空间与可执行文件的映射关系，因为程序执行时发生缺页异常，系统会从物理内存分配一块内存，然后将缺页从磁盘读取到内存中，再设置缺页的虚拟页和物理页的映射关系，这样程序就可以运行了。因此，当程序发生缺页异常时，需要知道程序当前的页在磁盘的那一个位置。 Linux系统将进程虚拟地址空间分配成多个段，这个段叫做虚拟内存区域（VMA，Virtual Memory Area）。如系统创建进程后，会设置一个.text段（原则上应该时多个sections的合并）的VMA。 （3）将CPU的指令寄存器设置可执行程序文件的入口函数 这一步就是将ELF文件头中保存的入口地址赋值为PC，然后启动运行。 （4）缺页异常   在上述步骤执行后，实际可执行文件的指令和数据都还没有装入到内存中，操作系统只是通过该可执行文件头部信息建立起可执行文件和进程虚拟内存空间直接的映射关系，当程序启动运行时，执行相关的虚拟地址，当发现这虚拟地址对应的物理页面为空，将会发生缺页异常，缺页异常会分配一块内存，然后将可执行文件的指令和数据从磁盘加载到内存中，后续就可以直接访问内存进行读写访问执行了。</p>
<h2 id="vma">VMA的操作函数</h2>
<h3 id="vma_1">VMA查找</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_cae6bbb4ff624621c3e6bdbb77955519.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_cae6bbb4ff624621c3e6bdbb77955519.jpg"/></a></p>
<h3 id="vma_2">VMA插入</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_ba7570a966d1b3c3b242f39fc77d8418.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_ba7570a966d1b3c3b242f39fc77d8418.jpg"/></a></p>
<h3 id="vma_3">VMA合并与拆分</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_1dfe4e90e363a34ba15fee26101bf260.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_1dfe4e90e363a34ba15fee26101bf260.jpg"/></a> <a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_337f56c246f926c63fa4d98c2d2426a4.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_337f56c246f926c63fa4d98c2d2426a4.jpg"/></a></p>
<h2 id="malloc">malloc函数</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_04081ca9a41741a9307555d8f308df40.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_04081ca9a41741a9307555d8f308df40.jpg"/></a>   用户空间分配内存，不会每次申请都向linux内核做一个系统调用进行分配获取内存，而是在用户空间维持着一个缓冲池，这个缓冲池有自己的内存管理算法。当用户进行malloc时候，如果缓存池中有内存，就直接获取返回，如果缓存池中没有内存，就会下陷做系统调用到linux内核中获取内存。   用户空间通过系统调用向内核获取内存时分为两种情况：当分配的内存小于M_MMAP_THRESHOLD阈值时会使用brk系统调用来扩展堆空间，当分配内存大于M_MMAP_THRESHOLD阈值时，会使用mmap进行映射分配。M_MMAP_THRESHOLD通常为128K，用户可以通过调用mallopt函数来修改该阈值。   malloc通过brk方式申请的内存，free释放内存时，并不会归还给系统，而是缓存到malloc内存池中，待下次使用。   malloc通过mmap申请到的内存，free释放内存时，会把内存归还给系统，内存得到真正释放。</p>
<h3 id="malloc_1">与malloc相关的函数</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_9d33544fd7defac58768bf0fb0b0870e.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_9d33544fd7defac58768bf0fb0b0870e.jpg"/></a></p>
<h3 id="malloc_2">malloc系统调用流程</h3>
<p>待补充</p>
<h2 id="mmap">mmap函数</h2>
<h3 id="_5">基本概念</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_c946072d39436dd061b81a53b731b460.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_c946072d39436dd061b81a53b731b460.jpg"/></a>   mmap用于内存映射，将一段区域映射到自己的进程地址空间中。这段区域可以是文件页属性也可以是物理页属性，所以分为两种： - 文件映射：将文件映射到进程空间，文件存放在存储设备上（文件内容会以page cache缓存到物理内存中）。 - 匿名映射：没有文件对应的区域，内容在物理内存上。   mmap用于文件映射能提高读写效率，主要的差异点是常规的文件操作需要从磁盘到页缓存拷贝，然后内核空间到用户空间还有拷贝，有两次数据拷贝动作；而mmap操控文件，只需要从磁盘到用户主存一次拷贝，后续的读写直接对主存读写，相当于少了依次内核到用户空间的拷贝。 mmap针对进程是否可见，有分为两种： <a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_ab5e85f7a85316f3f5b2ba2614daef10.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_ab5e85f7a85316f3f5b2ba2614daef10.jpg"/></a> - 私有映射：数据源拷贝一次副本，进程之间互不影响。 - 共享映射：共享的进程都能看到。 根据排列组合就有4中映射情况： - 私有匿名映射：可以用于分配大的内存，如malloc堆空间。 - 共享匿名隐射：可用于父子进程间通信，在内存文件系统中创建/dev/zero设备。 - 私有文件映射：常用于动态库的加载，如代码段，数据段等。 - 共享文件映射：非父子之间的进程间通信，文件读写等。 <a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_a712591b39c53c00e36b92c9b8c57f1d.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_a712591b39c53c00e36b92c9b8c57f1d.jpg"/></a></p>
<h3 id="_6">实现原理</h3>
<p>do_mmap函数调用流程待补充.....</p>
<p>举例mmap文件内存映射的实现过程，可以分为三个阶段： - 1.创建mmap虚拟地址空间VMA   如果mmap没有指定虚拟地址空间区域，则搜索一段空闲的连续虚拟地址空间，并分配一个vm_area_struct实例添加到红黑树和链表中。 - 2.建立VMA与文件物理地址（在磁盘那个位置）的映射关系   通过虚拟文件系统inode模块定位到文件在磁盘的位置，建立VMA与文件的联系。 call_mmap-&gt;file-&gt;f_op-&gt;mmap？ - 3.访问文件对应的虚拟地址，引发缺页异常，将文件内容加载到内存   前面阶段，并没有将文件的数据拷贝到内存中，真正的文件读取是进程发起读写操作时。进程在读货写操作访问映射的虚拟地址空间，通过查询页表，发现这一段地址并不再物理页面上，引发缺页异常，于是先从磁盘加载数据到内存中。后续堆文件的读写，直接就对对应的物理内存读写，当改变了内容，系统会自动将脏页面写回到磁盘上，当前也可以强行同步（msync）</p>
<h2 id="_7">缺页异常</h2>
<p>Linux系统有一个重要的特性就是用户“欺骗性”，如通过malloc申请了内存，但是实际上并没有分配内存给你，等实际访问内存的时候才会分配给你。用户很多重要的初始化操作只是针对虚拟内存的，虚拟内存实际对应的物理内存空间并没有分配，等实际需要访问的时候才会进行分配，因此当进程访问虚拟地址空间，发现虚拟地址空间没有与物理内存建立映射关系，处理器就会自动触发缺页异常（缺页中断）。下面是触发缺页异常的一些场景情形： <a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_aa1d714693eea980f6d11968869cfc16.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_aa1d714693eea980f6d11968869cfc16.jpg"/></a>   缺页异常会执行到对应的中断函数，会跟实际的处理器架构有些关系，在实际中缺页异常最终会调用到do_page_fault（arch/arm64/mm/fault.c）函数，接下来将会从这个函数进行重点分析。</p>
<h3 id="do_page_fault">do_page_fault</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_223927592e2f268ae6884bf365121175.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_223927592e2f268ae6884bf365121175.jpg"/></a></p>
<h3 id="_8">匿名页面</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_0656050714f015845bcc645afbb7fb80.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_0656050714f015845bcc645afbb7fb80.jpg"/></a>   发生匿名页缺页异常，一般是①malloc/mmap分配进程地址空间区域，没有对应的物理内存将会触发分配。② 用户栈不够时，进行栈区的扩大处理。   匿名页面分配时，会判断页面是否可写，如果是只读权限，那么系统会分配一个zero page。Zero page是一个特殊的物理页（实际没有使用物理内存空间），里面值全部为0，zero page针对匿名页场景专门进行的优化，主要是节省内存和对性能的一定优化。当malloc或者mmap分配内存仅仅是进程地址空间中的虚拟内存，如果用程序需要读这个malloc分配的虚拟内存，那么系统会返回全0的数据，因此linux内核不必为这种情况单独分配物理内存，而是使用系统零页，当程序需要写入这个页面时就会触发一个缺页异常，于是缺页异常变成写时复制的缺页异常。malloc分配虚拟内存，有以下几种情况。 - malloc分配后，直接读内存，这时缺页异常，分配到的是zero page，PTE的属性是read only。 - malloc分配后，先读后写，先读的时候缺页异常分配的是系统零页，再写再触发缺页异常触发写时复制。 - malloc分配后，直接写内存，触发缺页异常，使用alloc_zerod_user_highpage_movable分配新页面。</p>
<h3 id="_9">文件页面</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_d411bc5c6f9229a3116dd61850b582d4.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_d411bc5c6f9229a3116dd61850b582d4.jpg"/></a>   文件页面异常分为读文件异常，写私有文件异常，写共享文件异常。总体的思路是没有分配物理页面，就进行分配物理页面，然后将内容从文件中拷贝到物理页面中，再建立好页表。 - 读文件异常：会尝试多映射数据周围的内容，因为周围数据再次被命中的概率比较高，这样减少缺页异常次数。 - 写私有文件：写私有文件会发生写时复制，会先分配一块物理页面cow_page，先将文件内容读取文件缓存页（page cache），然后再将其内容复制到cow_page中。 - 写共享文件：写共享文件不会发生写时复制，如果mkwrite函数不为空，将会通知进程页面变成可写。同时会将页设置为脏页。</p>
<h3 id="swap">swap页面换入</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_0d0a88f43c5e72ed8292ba98fe15017a.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_0d0a88f43c5e72ed8292ba98fe15017a.jpg"/></a>   当内存不足时，会把页面交换到磁盘swap分区中，当再次访问这块内存时会发生缺页异常，大致的流程就是搜索swap cache看页面是否在内存中，如果不在说明被交换出去了，那就需要从磁盘里面读出来，然后重新刷新页表，重新建立虚拟地址和物理页面的映射关系。</p>
<h3 id="cow">页面写时复制COW</h3>
<p>通常有以下两种情况会触发写时复制（Copy on write，CoW）。 （1）父进程创建一个子进程，为了避免复制物理页，子进程和父进程以只读方式共享的匿名页和文件页，当有一个进程需要写只读页时，将会触发页错误异常，进程会拷贝一份新的物理页进行写。 （2）进程创建了一个私有文件映射，当进行读访问时，缺页异常将文件内容读取到page cache中，并将以只读方式跟虚拟页建立映射关系。当进程再对改内容进行写时，缺页异常会触发写时复制，为page cache创建一个副本，新建一个虚拟页与复制的物理页建立联系。 <a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_84171174ccd68f84c7c3875b62adcc06.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_84171174ccd68f84c7c3875b62adcc06.jpg"/></a> vm_normal_page从页表项得到页帧号,如果返回值为NULL，表示这是一个特殊的页映射，这种特殊的页映射只有页帧号，没有对应实际的物理页，具体是什么用途，需要再研究？ 如上图，写时复制一共有四种情形。 - 写时复制：wp_page_copy - 可写且共享的特殊映射页面：wp_pfn_shared - 可写且共享的普通页面：wp_page_shared - KSM匿名页面（复用的页面）：wp_page_reuse 下面重点看看wp_page_copy的流程： <a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_35c342abdc67f0593add42e69bf94c3e.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_35c342abdc67f0593add42e69bf94c3e.jpg"/></a>   1.为什么会产生page fault？ Page fault是硬件提供的特性，由硬件触发，触发条件为CPU访问某线性地址时，如果没有找到对应可访问页表项，则由硬件直接触发page fault。   2.发生缺页的地址是否可以位于内核态地址空间？ 有可能，内核地址空间发生缺页异常仅可能在vmalloc区，线性映射区域对应的页表在内核初始化就已经建立好了，所以这部分内存对应的虚拟地址空间不可能产生page fault。</p>
<h2 id="rmap">RMAP</h2>
<p>反向映射是物理页面page可以寻找到其对应的虚拟地址空间VMA。当进行页面回收的时候，就需要利用反向映射技术找到其对应的进程VMA，然后将VMA与当前页面断开映射关系，即可进行回收当前页面。   一个物理页面是可以同时被多个进程的虚拟页面映射的，但是一个虚拟页面只能映射一个物理页面。不同虚拟页面映射到同一物理页面的场景主要有子进程复制了父进程的VMA以及KSM机制的存在。</p>
<h3 id="_10">关键数据结构</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_e4e008eade507e84b99c1c805f91075b.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_e4e008eade507e84b99c1c805f91075b.jpg"/></a></p>
<h3 id="_11">基本原理</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_dd6c2685f14c0c162aaf0bea21188b5d.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_dd6c2685f14c0c162aaf0bea21188b5d.jpg"/></a></p>
<h3 id="_12">映射到一个进程的反向映射</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">vm_fault_t</span><span class="w"> </span><span class="nf">do_anonymous_page</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_fault</span><span class="w"> </span><span class="o">*</span><span class="n">vmf</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">......</span>
<span class="w">    </span><span class="n">__anon_vma_prepare</span><span class="p">(</span><span class="n">vma</span><span class="p">)</span>
<span class="w">    </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_zeroed_user_highpage_movable</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span><span class="w"> </span><span class="n">vmf</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
<span class="w">    </span><span class="n">page_add_new_anon_rmap</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">vma</span><span class="p">,</span><span class="w"> </span><span class="n">vmf</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<p>以匿名映射为例说明：   在缺页异常分配物理页时，会调用两个函数做RAMP相关的处理：__anon_vma_prepare，以及page_add_new_anon_rmap。 <a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_0e475cb2b8676c6ad7a54f59acbecf9a.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_0e475cb2b8676c6ad7a54f59acbecf9a.jpg"/></a></p>
<p>创建过程： （1）分配页面的时候，为每个VMA创建一个AVC，然后再创建一个AV。 （2）AVC-&gt;vma指向VMA，AVC-&gt;AV指向AV。 （3）将AVC添加到VMA-&gt;anon_vma_chain链表中。 （4）将AVC添加到AV-&gt;rb_root红黑树中。 （5）将page-&gt;mapping指向av。   反向映射过程： （1）通过page-&gt;mapping找到av。 （2）在av-&gt;rb_root红黑树中从根节点进行遍历avc。 （3）从avc中avc-&gt;vma找到vma。</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">page_add_new_anon_rmap</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">,</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">compound</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compound</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">thp_nr_pages</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="n">VM_BUG_ON_VMA</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span><span class="w"> </span><span class="n">vma</span><span class="p">);</span>
<span class="n">__SetPageSwapBacked</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="n">设置page的标志位位PG_swapbacked</span><span class="err">，</span><span class="n">表示页面可以交换到磁盘</span><span class="err">。</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">compound</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">VM_BUG_ON_PAGE</span><span class="p">(</span><span class="o">!</span><span class="n">PageTransHuge</span><span class="p">(</span><span class="n">page</span><span class="p">),</span><span class="w"> </span><span class="n">page</span><span class="p">);</span>
<span class="w">        </span><span class="cm">/* increment count (starts at -1) */</span>
<span class="w">        </span><span class="n">atomic_set</span><span class="p">(</span><span class="n">compound_mapcount_ptr</span><span class="p">(</span><span class="n">page</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hpage_pincount_available</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
<span class="w">            </span><span class="n">atomic_set</span><span class="p">(</span><span class="n">compound_pincount_ptr</span><span class="p">(</span><span class="n">page</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="n">__mod_lruvec_page_state</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">NR_ANON_THPS</span><span class="p">,</span><span class="w"> </span><span class="n">nr</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Anon THP always mapped first with PMD */</span>
<span class="w">        </span><span class="n">VM_BUG_ON_PAGE</span><span class="p">(</span><span class="n">PageTransCompound</span><span class="p">(</span><span class="n">page</span><span class="p">),</span><span class="w"> </span><span class="n">page</span><span class="p">);</span>
<span class="w">        </span><span class="cm">/* increment count (starts at -1) */</span>
<span class="w">        </span><span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">_mapcount</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">__mod_lruvec_page_state</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">NR_ANON_MAPPED</span><span class="p">,</span><span class="w"> </span><span class="n">nr</span><span class="p">);</span>
<span class="n">__page_set_anon_rmap</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">vma</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="n">设置页面位匿名映射</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">__page_set_anon_rmap</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">,</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">exclusive</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">anon_vma</span><span class="w"> </span><span class="o">*</span><span class="n">anon_vma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">anon_vma</span><span class="p">;</span>
<span class="n">anon_vma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">anon_vma</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PAGE_MAPPING_ANON</span><span class="p">;</span>
<span class="n">WRITE_ONCE</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">anon_vma</span><span class="p">);</span>
<span class="n">Page中的mapping指向anon_vma</span>
<span class="w">    </span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linear_page_index</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_13">映射到多个进程的反向映射</h3>
<h4 id="_14">未发生写时复制</h4>
<p>父进程创建子进程时，如果没有还没有进行写操作只有读操作，为了节省内存，父子是共享物理页面的，只有当父子进程需要修改页面内容是，才会发生写时复制一份。 <a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_7a65ba08a7451b8e47ff5651fbe7abe8.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_7a65ba08a7451b8e47ff5651fbe7abe8.jpg"/></a> - 遍历父进程的VMA，子进程进行复制一份VMA。 - 每复制一份VMA，就创建一个AVC（下图的AVC_c），用于建立父子之间的桥梁联系。AVC_c（AVC_c-&gt;anon_vma）指向父AV并添加到父AV（AV-&gt;rb_root）红黑树中，同时AVC_c（AVC_c-&gt;vma）又指向子进程的VMA。这样在遍历父AV的红黑树，就能通过AVC_c找到子进程的VMA。 - 子进程创建属于自己的AVC/AV，并建立VMA,AVC,AV的联系。 - 子进程复制了父进程的pte，所以子进程的vma对应虚拟页面也父进程的虚拟页面同时指向物理页面page（二对一的情况）。 <a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_04ce4257a5067ca7f04a211bb8c63640.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_04ce4257a5067ca7f04a211bb8c63640.jpg"/></a>   物理页面page寻找虚拟页面过程： - 通过page-&gt;mapping找到父进程的AV，如上图AV0。 - 遍历AV0的红黑树，这里找到两个AVC节点，分别是父AVC0节点以及父子进程桥梁节点AVC_c。 - 通过父AVC0找到父进程的VMA0（AVC0-&gt;vma指向父VMA0）。 - 通过桥梁AVC_c找到子进程的VMA1（AVC_c-vma指向子VMA1）   经过上述过程，物理页面page就可以找到与其对应的两个虚拟页面了。</p>
<h4 id="_15">发生写时复制</h4>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_f2b79044880e2a52ea4d0c2b33955dda.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_f2b79044880e2a52ea4d0c2b33955dda.jpg"/></a>   当父子进程的某一方出现写页面操作时，将会触发写时复制复制一份自己的物理页面，如上图，VMA1的pte指向复制的新物理页，同时物理页page-&gt;mapping指向AV1，这样copy page就能够通过AV1遍历其红黑树找到AVC1，进而通过AVC1找到VMA1。   疑问：上图中AVC_c依旧在AV0的红黑树中，所以父进程的物理页page依旧通过AV0找到子进程的VMA1，但是子进程实际的pte已经指向copy page了，跟父进程的page没有关系了。网上看到的说法是，为了解决这个问题，即使page找到了对应的VMA，会检查vma的页表是否确实映射到了此页，进而解决这个问题，需要进一步研究代码求证。</p>
<h3 id="_16">反向映射的应用</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_b1756eab66e402777cb13520ae84b778.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/内存管理/进程虚拟内存-2/images/wp_editor_md_b1756eab66e402777cb13520ae84b778.jpg"/></a>   反向映射主要的应用场景如下： - Kswapd回收页面是，需要断开映射到物理页面的PTE。 - 页面迁移时，需要断开所有映射到页面的PTE。</p></div>
  <div class="post-nav">
    <a class="prev" href="/laumy.github.io/posts/linux/内存测量.html">← 内存测量</a>
    <a class="next" href="/laumy.github.io/posts/linux/dma与cache一致性.html">DMA与cache一致性 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="/laumy.github.io/assets/site.js"></script>
  </body>
  </html>

