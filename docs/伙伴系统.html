<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ä¼™ä¼´ç³»ç»Ÿ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">ç›¸å…³ç»“æ„ä½“</a><ul><li><a href="#_2">æ ¸å¿ƒç»“æ„ä½“</a></li><li><a href="#free_area">free_area</a></li></ul></li><li><a href="#_3">åŸºæœ¬åŸç†</a><ul><li><a href="#_4">ä¼™ä¼´ç³»ç»Ÿå†…å­˜å—åˆ†é…</a></li><li><a href="#_5">ä¼™ä¼´ç³»ç»Ÿå†…å­˜å—åˆå¹¶</a></li><li><a href="#_6">å†…å­˜å—è¿ç§»</a></li></ul></li><li><a href="#_7">åˆå§‹åŒ–</a><ul><li><a href="#_8">åˆå§‹åŒ–ç›¸å…³æ•°æ®ç»“æ„</a></li><li><a href="#memblock">memblockå†…å­˜é‡Šæ”¾åˆ°ä¼™ä¼´ç³»ç»Ÿ</a></li></ul></li><li><a href="#_9">é¡µé¢åˆ†é…å™¨</a><ul><li><a href="#api">åˆ†é…å™¨API</a></li><li><a href="#alloc_pages">alloc_pages</a></li></ul></li><li><a href="#_24">å†…å­˜è§„æ•´</a><ul><li><a href="#_25">åŸºæœ¬åŸç†</a></li></ul></li><li><a href="#_26">å†…å­˜é¡µé¢å›æ”¶</a><ul><li><a href="#lru">LRUæœºåˆ¶</a></li><li><a href="#lru_1">LRUé“¾è¡¨</a></li><li><a href="#lru_2">LRUç¼“å­˜</a></li><li><a href="#_27">é¡µé¢å›æ”¶æ—¶æœº</a></li><li><a href="#_28">å›æ”¶ç­–ç•¥</a></li><li><a href="#_29">å¿«é€Ÿé¡µé¢å›æ”¶</a></li><li><a href="#kswpad">kswpadå›æ”¶</a></li><li><a href="#_30">ç›´æ¥é¡µé¢å›æ”¶</a></li><li><a href="#shrink_node">shrink_node</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>ä¼™ä¼´ç³»ç»Ÿ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-07-22
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">ç›¸å…³ç»“æ„ä½“</h2>
<h3 id="_2">æ ¸å¿ƒç»“æ„ä½“</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_145e1dfab349c93979e3382e570502f5.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_145e1dfab349c93979e3382e570502f5.jpg"/></a></p>
<ul>
<li>struct pglist_data: èŠ‚ç‚¹çš„æè¿°ï¼Œarm64 UMAæ¶æ„ä¸­ï¼Œåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>struct zone node_zone[]ï¼šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ è¡¨ç¤ºä¸€ä¸ªå†…å­˜åŒºåŸŸæ‰€å¯¹åº”çš„ struct zone ç»“æ„ä½“ã€‚ä»åå­—å¯ä»¥çœ‹å‡ºï¼Œæ­¤æ•°ç»„çš„é•¿åº¦ä¸º MAX_NR_ZONESï¼Œå³å®ƒæœ€å¤šå¯ä»¥åŒ…å« MAX_NR_ZONES ä¸ªå…ƒç´ ï¼Œå› æ­¤ï¼Œæ­¤æ•°ç»„é€šå¸¸ç”¨äºæè¿°ç³»ç»Ÿæ‰€èƒ½æ”¯æŒçš„æ‰€æœ‰å†…å­˜åŒºåŸŸã€‚è¿™äº›å†…å­˜åŒºåŸŸå¯èƒ½åŒ…æ‹¬ä¸åŒç±»å‹ï¼ˆä¾‹å¦‚ï¼ŒDMAã€æ™®é€šæˆ–é«˜ç«¯ï¼‰å’Œå¤§å°çš„å†…å­˜åŒºåŸŸã€‚</li>
<li>struct zonelist node_zonelists[]ï¼šä»…åœ¨ NUMA æ¶æ„ç³»ç»Ÿä¸­ä½¿ç”¨ã€‚å®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ è¡¨ç¤ºä¸€ä¸ª NUMA èŠ‚ç‚¹æ‰€å¯¹åº”çš„å†…å­˜åŒºåŸŸæ‰€ç»„æˆçš„é“¾è¡¨ã€‚å®ƒæ˜¯ä¸ºäº†æ”¯æŒ NUMA ç³»ç»Ÿä¸­çš„å†…å­˜åˆ†é…è€Œè®¾è®¡çš„ã€‚åœ¨ NUMA ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªèƒ½è®¿é—®ä¸€éƒ¨åˆ†ç‰©ç†å†…å­˜ï¼Œå› æ­¤éœ€è¦å°†æ‰€æœ‰å¯è®¿é—®çš„å†…å­˜åŒºåŸŸç»„æˆä¸€ä¸ªé“¾è¡¨ä¾›å†…å­˜åˆ†é…å™¨ä½¿ç”¨ã€‚ä»åå­—å¯ä»¥çœ‹å‡ºï¼Œæ­¤æ•°ç»„çš„é•¿åº¦ä¸º MAX_ZONELISTSï¼Œå³å®ƒæœ€å¤šå¯ä»¥åŒ…å« MAX_ZONELISTS ä¸ªå…ƒç´ ï¼Œå› æ­¤ï¼Œæ­¤æ•°ç»„é€šå¸¸ç”¨äºæè¿°ç³»ç»Ÿæ‰€æ”¯æŒçš„æ‰€æœ‰ NUMA èŠ‚ç‚¹ã€‚</li>
<li>struct lruvec lruvecï¼šç”¨äºå¤„ç†è¯¥èŠ‚ç‚¹çš„é¡µé¢å›æ”¶</li>
<li>struct per_cpu_pageset: pagesetç”¨äºå®ç°å†·çƒ­åˆ†é…å™¨ï¼Œå†…æ ¸é¡µæ—¶çƒ­çš„æ„å‘³ç€é¡µå·²ç»åŠ è½½åˆ°CPUé«˜é€Ÿç¼“å­˜ï¼Œä¸åœ¨å†…å­˜ä¸­çš„é¡µç›¸æ¯”ï¼Œå…¶æ•°æ®èƒ½å¤Ÿæ›´å¿«åœ°è®¿é—®ã€‚ç›¸åï¼Œå†·é¡µåˆ™ä¸å†é«˜é€Ÿç¼“å­˜ä¸­ï¼Œåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šï¼Œæ¯ä¸ªCPUéƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªé«˜é€Ÿç¼“å­˜ã€‚</li>
<li>free_area:ç”¨äºå®ç°ä¼™ä¼´ç³»ç»Ÿï¼Œæ¯ä¸ªæ•°ç»„å…ƒç´ éƒ½è¡¨ç¤ºæŸä¸­å›ºå®šé•¿åº¦çš„ä¸€äº›è¿ç»­å†…å­˜åŒºã€‚å¯¹äºåŒ…å«åœ¨æ¯ä¸ªåŒºåŸŸçš„ç©ºé—²å†…å­˜é¡µçš„ç®¡ç†ã€‚</li>
</ul>
<h3 id="free_area">free_area</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_b6dcaa46e506c9d16ad6c387ffe95db0.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_b6dcaa46e506c9d16ad6c387ffe95db0.jpg"/></a></p>
<p>ä¸Šå›¾æè¿°å‡ºäº†Node-&gt;zone-&gt;free_area-&gt;pageä¹‹é—´çš„å…³ç³»ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">......</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">free_area</span><span class="w"> </span><span class="n">free_area</span><span class="p">[</span><span class="n">MAX_ORDER</span><span class="p">];</span><span class="w"> </span><span class="c1">//å­˜å‚¨ç€ä¸åŒé•¿åº¦çš„ç©ºé—²åŒºåŸŸ</span>
<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<p>ä¼™ä¼´ç³»ç»Ÿä¸­æ˜¯ä»¥2^næ¬¡æ–¹æ¥å¯¹å†…å­˜è¿›è¡Œåˆ†é…çš„ï¼Œå› æ­¤ç³»ç»Ÿä¸­æ˜¯ä»¥2^næ¬¡æ–¹æ¥ç»„ç»‡é“¾è¡¨ç»“æ„çš„ã€‚ä¾‹å¦‚struct free_area[2]å¯¹åº”çš„å°±æ˜¯2^nä¸ªpageå†…å­˜å—é“¾è¡¨ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">free_area</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">free_list</span><span class="p">[</span><span class="n">MIGRATE_TYPES</span><span class="p">];</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_free</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>nr_freeæŒ‡å®šäº†å½“å‰å†…å­˜åŒºä¸­ç©ºé—²é¡µå—çš„æ•°ç›®ã€‚</li>
<li>free_listç”¨äºè¿æ¥ç©ºé—²é¡µçš„é“¾è¡¨ï¼Œæ¯ç§è¿ç§»ç±»å‹éƒ½å¯¹åº”äºä¸€ä¸ªç©ºé—²åˆ—è¡¨ã€‚</li>
<li>free_area[]ç¡®å®šè¿ç»­å†…å­˜çš„çº§æ•°åï¼Œè¿˜ä¼šæ ¹æ®å…¶MIGRATEç±»å‹æ¥è¿›è¡Œåˆ†ç±»ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†ä¾¿æ›´å¥½çš„ç®¡ç†å†…å­˜ï¼Œä»¥å‡å°‘å†…å­˜ç¢ç‰‡ã€‚</li>
</ul>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_09912eee85e1252a5720ec66cddb2972.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_09912eee85e1252a5720ec66cddb2972.jpg"/></a></p>
<h2 id="_3">åŸºæœ¬åŸç†</h2>
<p>ä¸ºäº†è§£å†³å†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼Œlinuxå†…æ ¸ä½¿ç”¨çš„ä¼™ä¼´ç³»ç»Ÿç®—æ³•ã€‚ä¼™ä¼´ç³»ç»Ÿç®—æ³•æ˜¯ä¸€ä¸ªé«˜æ•ˆä¸”ç®€å•çš„å†…å­˜åˆ†é…ç­–ç•¥ï¼Œå½“æˆ‘ä»¬æ‰¾åˆ°å¾…åˆ†é…å†…å­˜çš„zoneåï¼Œå†…æ ¸å°†ä»å¯¹åº”zoneçš„ç©ºé—²é“¾è¡¨ä¸­å»åˆ†é…å†…å­˜ã€‚åœ¨é‡Šæ”¾å†…å­˜æ˜¯ï¼Œå†…æ ¸å°†ç›¸åº”çš„å†…å­˜è¿˜å›ç›¸åº”çš„å†…å­˜è¿˜å›å¯¹åº”çš„zoneç©ºé—²å†…å­˜é“¾è¡¨ä¸­ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_b6dcaa46e506c9d16ad6c387ffe95db0.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_b6dcaa46e506c9d16ad6c387ffe95db0.jpg"/></a></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºfree_areaæ•°ç»„å¤§å°ä¸ºMAX_ORDERï¼Œä¹Ÿå°±æ˜¯free_areaæ•°ç»„å­˜æ”¾ç€MAX_ORDERä¸ªé“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨çš„å…ƒç´ å­˜æ”¾çš„é¡µå—å¤§å°ä¸º2çš„næ¬¡å¹‚ï¼Œå…¶ä¸­nä¸ºè¯¥é“¾è¡¨åœ¨free_areaæ•°ç»„ä¸­çš„ç´¢å¼•ä½ç½®ã€‚åœ¨åŒä¸€ä¸ªorderå†…å­˜å—ä¸­ï¼Œæœ‰æ ¹æ®MIGRATEç±»å‹å°†pageå­˜æ”¾åœ¨ä¸åŒçš„é“¾è¡¨ä¸­ã€‚</p>
<h3 id="_4">ä¼™ä¼´ç³»ç»Ÿå†…å­˜å—åˆ†é…</h3>
<p>å¦‚æœå†…æ ¸è¦åˆ†é…2^nä¸ªé¡µå†…å­˜å¤§å°ï¼Œä¼™ä¼´ç³»ç»Ÿå¤„ç†æ–¹å¼å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰æ£€æŸ¥å¯¹åº”çš„free_area[n]ç´¢å¼•ï¼ˆå¦‚æœæ˜¯3ï¼Œåˆ™æ˜¯free_area[3]ï¼‰çš„æ•°ç»„ï¼Œå¦‚æœåœ¨å…¶ç´¢å¼•ä¸‹çš„é“¾è¡¨æœ‰ç©ºé—²å†…å­˜å—ï¼Œåˆ™è¿”å›ã€‚ ï¼ˆ2ï¼‰å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ»¡è¶³è¦æ±‚çš„å†…å­˜å—ï¼Œåˆ™æŸ¥æ‰¾n+1æ•°ç»„ç´¢å¼•ï¼ˆfree_area[4]ï¼‰ï¼Œè‹¥å­˜åœ¨ç©ºé—²å†…å­˜å—ï¼Œå°†n+1ç´¢å¼•çš„å†…å­˜å—æ‹†åˆ†æˆå¤§å°ç›¸ç­‰ä¸”è¿ç»­çš„ä¸¤å—å†…å­˜ï¼Œå°†ä¸€å—å†…å­˜è¿”å›ç»™å†…æ ¸ä½¿ç”¨ï¼Œå¦å¤–ä¸€å—å†…å­˜æ·»åŠ åˆ°nçš„æ•°ç»„ç´¢å¼•é“¾è¡¨ä¸­ã€‚ ï¼ˆ3ï¼‰è‹¥n+1æ•°ç»„ç´¢å¼•ä¸­ä¾æ—§æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ç»§ç»­å‘n+2æ•°ç»„ç´¢å¼•å¯»æ‰¾ï¼Œå†ä¾æ¬¡å‘ä¸‹æ‹†åˆ†ï¼Œç›´è‡³æ»¡è¶³è¦æ±‚ä½ç½®ã€‚</p>
<h3 id="_5">ä¼™ä¼´ç³»ç»Ÿå†…å­˜å—åˆå¹¶</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_e14a45790a10dc23e9916b4f4413814a.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_e14a45790a10dc23e9916b4f4413814a.jpg"/></a></p>
<p>å½“ç³»ç»Ÿä¸­å­˜åœ¨ä¸¤å—å¤§å°ä¸€æ ·ï¼Œå†…å­˜ç‰©ç†åœ°å€è¿ç»­å°†ä¼šè¯•å›¾åˆå¹¶æ·»åŠ åˆ°ä¸Šä¸€é˜¶ã€‚ä¸Šå›¾ä¸­åœ¨free_area[2]ä¸­æœ‰5ä¸ªç©ºé—²å†…å­˜å—ï¼Œå½“éç©ºé—²å†…å­˜å—PFN=6å³å°†é‡Šæ”¾æ˜¯ï¼Œä¼™ä¼´ç³»ç»Ÿå°†ä¼šè¿›è¡Œæ£€æŸ¥ï¼Œå‘ç°PFN=6ä¸PFN=1å†…å­˜å—å¤§å°ä¸€æ ·ä¸”è¿ç»­ï¼Œåˆ™è¿›è¡Œåˆå¹¶æ·»åŠ åˆ°order=3çš„ä¸Šä¸€é˜¶è¿ç»­å†…å­˜å—ä¸­ï¼ŒåŒæ—¶åœ¨order=3ä¸­ä¼šç»§ç»­æœç´¢ï¼Œçœ‹æ˜¯å¦æ»¡è¶³å¯ä»¥åˆå¹¶æ·»åŠ åˆ°order=4ä¸­ï¼Œç›´åˆ°ä¸èƒ½åˆå¹¶ä¸ºæ­¢ã€‚struct pageä¸­æœ‰å‡ ä¸ªæˆå‘˜å˜é‡ä¸ä¼™ä¼´ç³»ç»Ÿæœ‰å…³ç³»ã€‚</p>
<ul>
<li>__mapcount:æ ‡è®°pageæ˜¯å¦åœ¨ä¼™ä¼´ç³»ç»Ÿä¸­</li>
<li>privateï¼šé¡µå—ä¸­çš„ç¬¬ä¸€é¡µprivateå­—æ®µå­˜æ”¾äº†å†…å­˜å—çš„orderå€¼</li>
<li>indexï¼šå­˜æ”¾MIFRATEçš„ç±»å‹</li>
<li>__refcountï¼šç”¨æˆ·ä½¿ç”¨è®¡æ•°</li>
</ul>
<h3 id="_6">å†…å­˜å—è¿ç§»</h3>
<p>ä¼™ä¼´ç³»ç»Ÿèƒ½ä¸€å®šç¨‹åº¦è§£å†³å†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œä½†æ˜¯ç³»ç»Ÿè¿è¡Œä¹…ä¹‹åï¼Œå†…æ ¸ä¼šå¤§é‡çš„è¿›è¡Œå†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾å·¥ä½œï¼Œè¿™ä¾æ—§ä¼šå¯¼è‡´å†…å­˜ç¢ç‰‡ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_125209fe9700e90e4c4f6b520d274ef8.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_125209fe9700e90e4c4f6b520d274ef8.jpg"/></a></p>
<p>å¦‚ä¸Šå›¾ï¼Œå‡å®šå†…å­˜ç”±60é¡µç»„æˆï¼Œå·¦ä¾§çš„åœ°å€ç©ºé—´æ•£å¸ƒç€ç©ºé—²é¡µï¼Œå°½ç®¡25%çš„ç‰©ç†å†…å­˜ä»ç„¶æœªåˆ†é…ï¼Œä½†æœ€å¤§çš„è¿ç»­ç©ºé—²åŒºåªæœ‰ä¸€é¡µã€‚è¿™å¯¹ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºæ˜¯æ²¡é—®é¢˜ï¼ˆå…¶å†…å­˜é€šè¿‡é¡µè¡¨æ˜ å°„ï¼Œå³ä½¿ç©ºé—²é¡µåœ¨ç‰©ç†å†…å­˜ä¸­åˆ†å¸ƒå¦‚ä½•ï¼Œåº”ç”¨ç¨‹åºçœ‹åˆ°çš„å†…å­˜æ˜¯è¿ç»­çš„ï¼‰ã€‚å³å›¾ç»™å‡ºçš„æƒ…å½¢ä¸­ï¼Œç©ºé—²é¡µå’Œä½¿ç”¨é¡µçš„æ•°ç›®ä¸ä½œå›¾ç›¸åŒï¼Œä½†æ‰€æœ‰ç©ºé—²é¡µéƒ½ä½äºä¸€ä¸ªè¿ç»­åŒºä¸­ã€‚ä¸ºäº†ç¼“è§£è¿™ç§å†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œå†…æ ¸ä¼™ä¼´ç³»ç»Ÿå¼•å…¥äº†MIGRATEã€‚ä¸‹é¢æ˜¯Linuxå†…æ ¸ä¸­ç”¨äºæè¿°ä¸åŒå†…å­˜åŒºåŸŸçš„è¿ç§»ç±»å‹å¸¸é‡ï¼Œè¡¨ç¤ºå¯¹åº”åŒºåŸŸä¸­é¡µé¢çš„å¯ç§»åŠ¨æ€§å’Œé‡è¦æ€§ç­‰å±æ€§ã€‚</p>
<ul>
<li>MIGRATE_ISOLATE:è¡¨ç¤ºè¿™ä¸ªå†…å­˜åŒºåŸŸçš„é¡µé¢ä¸å¯ç§»åŠ¨ï¼Œå¹¶ä¸”éœ€è¦ç‹¬ç«‹å‡ºæ¥ï¼Œä¾‹å¦‚ç”¨äºè®¾å¤‡DMAã€‚</li>
<li>MIGRATE_CMA:è¡¨ç¤ºè¿™ä¸ªå†…å­˜åŒºåŸŸçš„é¡µé¢è¢«ä¿ç•™ç”¨äºè¿ç»­å†…å­˜åˆ†é…ï¼ˆCMAï¼‰ï¼Œé€šå¸¸ç”¨äºä¸€äº›åµŒå…¥ç³»ç»Ÿä¸­ã€‚</li>
<li>MIGRATE_HIGHATOMIC:è¡¨ç¤ºè¿™ä¸ªå†…å­˜åŒºåŸŸçš„é¡µé¢è¢«é¢„æœŸä¼šç»å¸¸è¿›è¡Œæä¼˜å…ˆçº§å†…å­˜æ“ä½œï¼Œä¾‹å¦‚è§£é”é¡µéœ€è¦ä½¿ç”¨ç¡¬ä»¶åŸå­æ“ä½œã€‚</li>
<li>MIGRATE_MOVABLE:è¡¨ç¤ºè¿™ä¸ªå†…å­˜åŒºåŸŸçš„é¡µé¢å¯ä»¥è‡ªç”±è¢«è¿ç§»ï¼Œé€šå¸¸ç”¨äºç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿå†…å­˜æˆ–è€…æ”¯æŒè™šæ‹Ÿæœºçš„å†…å­˜ç®¡ç†åœºæ™¯ã€‚</li>
<li>MIGRATE_RECALAIMABLE:è¡¨ç¤ºè¿™ä¸ªå†…å­˜åŒºåŸŸçš„é¡µé¢å¯ä»¥è¢«å›æ”¶ï¼Œä¾‹å¦‚åŒ…å«ç¼“å­˜é¡µï¼ŒåŒ¿åé¡µç­‰ã€‚</li>
<li>MIGRATE_UNMOVABLE:è¡¨ç¤ºè¿™ä¸ªå†…å­˜åŒºåŸŸçš„é¡µé¢ä¸å¯ç§»åŠ¨ï¼Œä¾‹å¦‚å†…æ ¸ä»£ç ï¼Œå†…æ ¸æ•°æ®ç­‰ã€‚ åœ¨ä¼™ä¼´ç³»ç»Ÿåˆ†é…è¿ç»­å†…å­˜å—æ˜¯ï¼Œå½“ä¸€ä¸ªæŒ‡å®šè¿ç§»ç±»å‹æ‰€å¯¹åº”çš„é“¾è¡¨ä¸­æ²¡æœ‰ç©ºé—²å†…å­˜å—æ—¶ï¼Œå†…æ ¸å°†ä¼šæŒ‰ç…§é™æ€å®šä¹‰çš„é¡ºåºåœ¨å…¶ä»–è¿ç§»ç±»å‹çš„é“¾è¡¨ä¸­è¿›è¡Œå¯»æ‰¾ã€‚</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fallbacks</span><span class="p">[</span><span class="n">MIGRATE_TYPES</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">[</span><span class="n">MIGRATE_UNMOVABLE</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">MIGRATE_RECLAIMABLE</span><span class="p">,</span><span class="w"> </span><span class="n">MIGRATE_MOVABLE</span><span class="p">,</span><span class="w">   </span><span class="n">MIGRATE_TYPES</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">[</span><span class="n">MIGRATE_MOVABLE</span><span class="p">]</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">MIGRATE_RECLAIMABLE</span><span class="p">,</span><span class="w"> </span><span class="n">MIGRATE_UNMOVABLE</span><span class="p">,</span><span class="w"> </span><span class="n">MIGRATE_TYPES</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">[</span><span class="n">MIGRATE_RECLAIMABLE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">MIGRATE_UNMOVABLE</span><span class="p">,</span><span class="w">   </span><span class="n">MIGRATE_MOVABLE</span><span class="p">,</span><span class="w">   </span><span class="n">MIGRATE_TYPES</span><span class="w"> </span><span class="p">},</span>
<span class="cp">#ifdef CONFIG_CMA</span>
<span class="w">    </span><span class="p">[</span><span class="n">MIGRATE_CMA</span><span class="p">]</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">MIGRATE_TYPES</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* Never used */</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MEMORY_ISOLATION</span>
<span class="w">    </span><span class="p">[</span><span class="n">MIGRATE_ISOLATE</span><span class="p">]</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">MIGRATE_TYPES</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* Never used */</span>
<span class="cp">#endif</span>
<span class="p">};</span>
</code></pre></div>
<h2 id="_7">åˆå§‹åŒ–</h2>
<h3 id="_8">åˆå§‹åŒ–ç›¸å…³æ•°æ®ç»“æ„</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_b53a6ce1e893cd701e83c3db0bb7978e.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_b53a6ce1e893cd701e83c3db0bb7978e.jpg"/></a></p>
<p>ä¼™ä¼´ç³»ç»Ÿç›¸å…³æ•°æ®ç»“æ„ä¸»è¦åœ¨zone_sizes_initä¸­å®Œæˆï¼Œä¸»è¦çš„å‡ ç‚¹å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰ä¸ºæ¯ä¸ªzoneåŒºåŸŸçš„free_area[]æ•°ç»„ä¸­çš„MIGRATE free listé“¾è¡¨åˆå§‹åŒ–ã€‚ ï¼ˆ2ï¼‰ä¸ºæ¯ä¸ªzoneåŒºåŸŸæ‰€æœ‰çš„é¡µæ¡†æè¿°ç¬¦struct pageï¼ˆåˆ†é…ï¼‰åˆå§‹åŒ–ã€‚ ï¼ˆ3ï¼‰ä¸ºæ¯ä¸ªzoneåŒºåŸŸä¸­æ‰€æœ‰çš„pageblockè®¾å®šè¿ç§»ç±»å‹ã€‚ ï¼ˆ4ï¼‰ä¸ºæ¯ä¸ªå†…å­˜èŠ‚ç‚¹åˆå§‹åŒ–å¯ä½¿ç”¨çš„å¤‡ç”¨å†…å­˜node_zonelistsã€‚ ä¸ºæ¯ä¸ªzoneåŒºåŸŸçš„æ¯cpuæˆå‘˜pagesetåˆå§‹åŒ–ã€‚</p>
<h3 id="memblock">memblockå†…å­˜é‡Šæ”¾åˆ°ä¼™ä¼´ç³»ç»Ÿ</h3>
<p><a href="http://8.134.108.235/wp-content/uploads/2023/11/wp_editor_md_9e3347fbfc030e039f1392ee33c867f2.jpg"><img alt="" src="images/wp_editor_md_9e3347fbfc030e039f1392ee33c867f2.jpg"/></a></p>
<h2 id="_9">é¡µé¢åˆ†é…å™¨</h2>
<h3 id="api">åˆ†é…å™¨API</h3>
<p>å°±ä¼™ä¼´ç³»ç»Ÿæ¥å£è€Œè¨€ï¼Œä¸cåº“ä¸­çš„mallocå‡½æ•°ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œåˆ†é…çš„å‚æ•°æ˜¯ä»¥åˆ†é…é˜¶ä¸ºå‚æ•°ï¼Œå³ä¼™ä¼´ç³»ç»Ÿå°†åœ¨å†…å­˜ä¸­åˆ†é…2^orderé¡µã€‚</p>
<h4 id="_10">åˆ†é…æ¥å£</h4>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_3bfc370b8e9591b77db8ff33c3115527.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_3bfc370b8e9591b77db8ff33c3115527.jpg"/></a></p>
<h4 id="_11">åˆ†é…æ©ç </h4>
<h5 id="_12">åŒºåŸŸä¿®é¥°ç¬¦</h5>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_84bc7a4844ae938021a6069a25c64ecf.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_84bc7a4844ae938021a6069a25c64ecf.jpg"/></a></p>
<h5 id="_13">ç§»åŠ¨ä¿®é¥°ç¬¦</h5>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_ae7068647219ad19519ad010d2e2838d.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_ae7068647219ad19519ad010d2e2838d.jpg"/></a></p>
<h5 id="_14">æ°´çº¿ä¿®é¥°ç¬¦</h5>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_c1692c66aafab364d8dddebeaa564f7c.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_c1692c66aafab364d8dddebeaa564f7c.jpg"/></a></p>
<h5 id="_15">å›æ”¶ä¿®é¥°ç¬¦</h5>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_c0ffd53fc4f403387bad2959ded0169d.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_c0ffd53fc4f403387bad2959ded0169d.jpg"/></a></p>
<h3 id="alloc_pages">alloc_pages</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_6ddd633e5ceb3a6b88e7172c5126c869.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_6ddd633e5ceb3a6b88e7172c5126c869.jpg"/></a></p>
<p>alloc_pagesæœ€ç»ˆä¼šè°ƒç”¨åˆ°__alloc_pagesï¼Œåˆ†é…ç‰©ç†é¡µé¢é¦–å…ˆä¼šå…ˆå°è¯•ä»ä¼™ä¼´ç³»ç»Ÿä¸­è¿›è¡Œå¿«é€Ÿåˆ†é…ï¼Œå¦‚æœå¿«é€Ÿåˆ†é…ä¸æˆåŠŸä¼šè¿›å…¥æ…¢é€Ÿåˆ†é…ã€‚å¿«é€Ÿåˆ†é…å’Œæ…¢é€Ÿåˆ†é…çš„åŒºåˆ«ï¼Ÿ</p>
<h4 id="prepare_alloc_pages">prepare_alloc_pages</h4>
<p>ç”¨äºåˆå§‹åŒ–é¡µé¢åˆ†é…å™¨ä¸­ç”¨åˆ°çš„å‚æ•°ï¼Œç¡®å®šé¦–é€‰çš„zoneç­‰ã€‚åœ¨é¡µé¢åˆ†é…å™¨ä¸­ï¼Œä½¿ç”¨alloc_contextæ•°æ®ç»“æ„æ¥ç”¨äºå„å‡½æ•°ä¹‹é—´çš„å‚æ•°ä¼ é€’ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include â€œmm/internal.hâ€</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">alloc_context</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">zonelist</span><span class="w"> </span><span class="o">*</span><span class="n">zonelist</span><span class="p">;</span>
<span class="w">    </span><span class="n">nodemask_t</span><span class="w"> </span><span class="o">*</span><span class="n">nodemask</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">zoneref</span><span class="w"> </span><span class="o">*</span><span class="n">preferred_zoneref</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">migratetype</span><span class="p">;</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">zone_type</span><span class="w"> </span><span class="n">highest_zoneidx</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">spread_dirty_pages</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<ul>
<li>zonelist: åˆ†é…é¡µé¢çš„åŒºåŸŸåˆ—è¡¨</li>
<li>nodemaskï¼šæŒ‡å®šçš„nodeï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šåˆ™åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸­è¿›è¡Œåˆ†é…</li>
<li>prefered_zonerefï¼šæŒ‡å®šé¦–å…ˆåˆ†é…çš„åŒºåŸŸ</li>
<li>migratetype:è¦åˆ†é…çš„è¿ç§»ç±»å‹</li>
<li>highest_zoneidx:å°†åˆ†é…é™åˆ¶ä¸ºå°äºåŒºåŸŸåˆ—è¡¨ä¸­æŒ‡å®šçš„é«˜åŒºåŸŸ</li>
<li>spread_dirty_pages:è„åŒºå¹³è¡¡ç›¸å…³</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">prepare_alloc_pages</span><span class="p">(</span><span class="n">gfp_t</span><span class="w"> </span><span class="n">gfp_mask</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">order</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">preferred_nid</span><span class="p">,</span><span class="w"> </span><span class="n">nodemask_t</span><span class="w"> </span><span class="o">*</span><span class="n">nodemask</span><span class="p">,</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">alloc_context</span><span class="w"> </span><span class="o">*</span><span class="n">ac</span><span class="p">,</span><span class="w"> </span><span class="n">gfp_t</span><span class="w"> </span><span class="o">*</span><span class="n">alloc_gfp</span><span class="p">,</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">alloc_flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">highest_zoneidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gfp_zone</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">);</span>
<span class="n">ac</span><span class="o">-&gt;</span><span class="n">zonelist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_zonelist</span><span class="p">(</span><span class="n">preferred_nid</span><span class="p">,</span><span class="w"> </span><span class="n">gfp_mask</span><span class="p">);</span>
<span class="c1">//ï¼ˆ1ï¼‰ç¡®å®šé¦–é€‰å†…å­˜èŠ‚ç‚¹çš„zonelistï¼Œä¸€ä¸ªå†…å­˜èŠ‚ç‚¹åŒ…å«ä¸¤ä¸ªzonelistï¼Œä¸€ä¸ªæ˜¯æœ¬åœ°çš„ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯è¿œç«¯çš„ï¼Œå¯¹äºarm64æ¶æ„åªæœ‰ä¸€ä¸ªã€‚</span>
<span class="w">    </span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">nodemask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodemask</span><span class="p">;</span>
<span class="w">    </span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">migratetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gfp_migratetype</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">);</span>
<span class="w">   </span><span class="c1">//ï¼ˆ2ï¼‰æ ¹å› åˆ†é…æ©ç æ¥ç¡®å®šè·å–å†…å­˜çš„è¿ç§»ç±»å‹</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpusets_enabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">alloc_gfp</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">__GFP_HARDWALL</span><span class="p">;</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * When we are in the interrupt context, it is irrelevant</span>
<span class="cm">         * to the current task context. It means that any node ok.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_task</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">nodemask</span><span class="p">)</span>
<span class="w">            </span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">nodemask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset_current_mems_allowed</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="o">*</span><span class="n">alloc_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">ALLOC_CPUSET</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">fs_reclaim_acquire</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">);</span>
<span class="w">    </span><span class="n">fs_reclaim_release</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">);</span>

<span class="w">    </span><span class="n">might_sleep_if</span><span class="p">(</span><span class="n">gfp_mask</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">__GFP_DIRECT_RECLAIM</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">should_fail_alloc_page</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="o">*</span><span class="n">alloc_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gfp_to_alloc_flags_cma</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">alloc_flags</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Dirty zone balancing only done in the fast path */</span>
<span class="w">    </span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">spread_dirty_pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gfp_mask</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">__GFP_WRITE</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * The preferred zone is used for statistics but crucially it is</span>
<span class="cm">     * also used as the starting point for the zonelist iterator. It</span>
<span class="cm">     * may get reset for allocations that ignore memory policies.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">preferred_zoneref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first_zones_zonelist</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">zonelist</span><span class="p">,</span>
<span class="w">                    </span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">highest_zoneidx</span><span class="p">,</span><span class="w"> </span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">nodemask</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//ï¼ˆ3ï¼‰ç¡®å®šé¦–é€‰çš„zone</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_16">å¿«é€Ÿè·¯å¾„åˆ†é…</h4>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_a6aecfddcbcbd49af95e6e9d659eda12.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_a6aecfddcbcbd49af95e6e9d659eda12.jpg"/></a></p>
<p>éå†zonelistä¸­çš„zoneï¼Œæ‰«æzoneçš„æ–¹å‘æ˜¯ä»é«˜ç«¯zoneåˆ°ä½ç«¯zoneï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸ä¸€å®šæ‰«æzonelistä¸­æ‰€æœ‰çš„zoneï¼Œè€Œæ˜¯ä»é¦–é€‰zone(prefered_zone)å¼€å§‹æ‰«æï¼Œé¦–é€‰zoneæ˜¯é€šè¿‡gfp_maskæ¢ç®—ã€‚ alloc_contextæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å‚æ•°ï¼Œå…¶å­˜å‚¨äº†zoneä»å“ªé‡Œå¼€å§‹æ‰«æï¼Œå†…å­˜åˆ†é…çš„è¿ç§»ç±»å‹ç­‰ã€‚zone_watermark_okå°†ä¼šæ£€æµ‹åœ¨åˆ†é…å†…å­˜æ—¶éœ€è¦åˆ¤æ–­zoneçš„æ°´ä½æƒ…å†µä»¥åŠæ˜¯å¦æ»¡è¶³åˆ†é…è¿ç»­å¤§å†…å­˜å—çš„éœ€æ±‚ï¼Œå¦‚æœä¸ç¬¦åˆåˆ™åˆ†é…å¤±è´¥ã€‚ rmqueueä¼šä»ä¼™ä¼´ç³»ç»Ÿä¸­è·å–å†…å­˜ï¼Œå¦‚æœå¯¹åº”çš„orderä¸æ»¡è¶³ï¼Œå°±ä¼šä»é«˜ä¸€é˜¶çš„å†…å­˜å—åŒºè·å–ã€‚åœ¨è°ƒç”¨requeueåˆ†é…å†…å­˜æ—¶ï¼Œå½“åˆ†é…çš„æ—¶å•ä¸ªç‰©ç†é¡µé¢(order=0)ï¼Œå°†ä¼šè°ƒç”¨rmqueue_pcplistå‡½æ•°ï¼Œä»Per-CPUå˜é‡per_cpu_pagesä¸­åˆ†é…é¡µé¢ã€‚per_cpu_pagesæ˜¯ä¸€ä¸ªPer-CPUå˜é‡ï¼Œå³æ¯ä¸ªCPUéƒ½ç”±ä¸€ä¸ªæœ¬åœ°çš„per_cpu_pageså˜é‡ï¼Œè¿™ä¸ªper_cpu_pagesæ•°æ®ç»“æ„ç†ç”±ä¸€ä¸ªå•é¡µé¢é“¾è¡¨ï¼Œé‡Œé¢å­˜æ”¾ä¸€å°éƒ¨åˆ†å•ä¸ªç‰©ç†é¡µé¢ï¼Œå½“ç³»ç»Ÿéœ€è¦å•ä¸ªç‰©ç†é¡µé¢æ˜¯ï¼Œå°±ä»æœ¬åœ°CPUçš„Per-CPUå˜é‡é“¾è¡¨ä¸­ç›´æ¥è·å–ç‰©ç†é¡µé¢ï¼Œè¿™æ ·å°±å¯ä»¥å¿«é€Ÿåˆ†é…å†…å­˜ï¼Œå‡å°‘zoneä¸­ç›¸å…³é”çš„æ“ä½œï¼ˆåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸­è®¿é—®å†…å­˜ä¼šæœ‰é”ä¿æŠ¤ï¼‰ã€‚</p>
<h4 id="_17">æ…¢é€Ÿè·¯å¾„åˆ†é…</h4>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_92e81393fe4ffab32a2faf9d1f7e6a03.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_92e81393fe4ffab32a2faf9d1f7e6a03.jpg"/></a></p>
<h4 id="_18">æ°´ä½ç®¡ç†</h4>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_057ce6206421a720aec0a0aaba72fff3.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_057ce6206421a720aec0a0aaba72fff3.jpg"/></a> æ°´ä½ç®¡ç†çš„è®¾ç½®ä¸»è¦åœ¨init_per_zone_wmark_minå‡½æ•°ä¸­å®ç°ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">__meminit</span><span class="w"> </span><span class="nf">init_per_zone_wmark_min</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="err">ï¼ˆ</span><span class="mi">1</span><span class="err">ï¼‰</span><span class="n">è®¡ç®—min_free_kbyteså€¼</span>
<span class="n">calculate_min_free_kbytes</span><span class="p">();</span>
<span class="err">ï¼ˆ</span><span class="mi">2</span><span class="err">ï¼‰</span><span class="n">è®¾ç½®å„zoneçš„æ°´ä½å€¼</span>
<span class="n">setup_per_zone_wmarks</span><span class="p">();</span>
<span class="err">ï¼ˆ</span><span class="mi">3</span><span class="err">ï¼‰</span><span class="n">zoneçŠ¶ä½“é˜ˆå€¼</span><span class="err">ï¼Œ</span><span class="n">ç”¨äºå†…å­˜å‹ç¼©</span><span class="err">ï¼Œ</span><span class="n">Per</span><span class="o">-</span><span class="n">CPUç›¸å…³</span><span class="err">ï¼Ÿ</span>
<span class="n">refresh_zone_stat_thresholds</span><span class="p">();</span>
<span class="err">ï¼ˆ</span><span class="mi">4</span><span class="err">ï¼‰</span><span class="n">è®¾ç½®å„zoneåŒºé¢„ç•™å†…å­˜</span>
<span class="w">    </span><span class="n">setup_per_zone_lowmem_reserve</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_NUMA</span>
<span class="w">    </span><span class="n">setup_min_unmapped_ratio</span><span class="p">();</span>
<span class="w">    </span><span class="n">setup_min_slab_ratio</span><span class="p">();</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">khugepaged_min_free_kbytes_update</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="_19">ç›¸å…³æ•°æ®ç»“æ„</h5>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"common/framework/platform_init.h"</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">......</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">_watermark</span><span class="p">[</span><span class="n">NR_WMARK</span><span class="p">];</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_reserved_highatomic</span><span class="p">;</span>
<span class="kt">long</span><span class="w"> </span><span class="n">lowmem_reserve</span><span class="p">[</span><span class="n">MAX_NR_ZONES</span><span class="p">];</span>

<span class="n">atomic_long_t</span><span class="w"> </span><span class="n">managed_pages</span><span class="p">;</span>
<span class="n">unsinged</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">spanned_pages</span><span class="p">;</span>
<span class="n">unsinged</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">present_pages</span><span class="p">;</span>
<span class="p">......</span>
<span class="p">};</span>

<span class="k">enum</span><span class="w"> </span><span class="n">zone_wtermarks</span><span class="w"> </span><span class="p">{</span>
<span class="n">WMARK_MIN</span><span class="p">,</span>
<span class="n">WMARK_LOW</span><span class="p">,</span>
<span class="n">WMARK_HIGH</span><span class="p">,</span>
<span class="n">NR_WMARK</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define min_wmark_pages(z) (z-&gt;watermark[WMARK_MIN])</span>
<span class="cp">#define low_wmark_pages(z) (z-&gt;watermark[WMARK_LOW])</span>
<span class="cp">#define high_wmark_pages(z) (z-&gt;watermark[WMARK_HIGH])</span>
</code></pre></div>
<ul>
<li>_watermark[NR_WMARK]:å­˜å‚¨æ°´ä½ç­‰çº§å¯¹åº”çš„å†…å­˜å®¹é‡</li>
<li>nr_reserved_highatomic:è¯¥å†…å­˜åŒºåŸŸå†…é¢„ç•™å†…å­˜çš„å¤§å°ï¼Œå…¶å¤§å°=watermark[WMARK_MIN]ï¼Ÿ</li>
<li>lowmem_reserve[MAX_NR_ZONES]ï¼šæ¯ä¸ªåŒºåŸŸå¿…é¡»ä¸ºè‡ªå·±ä¿ç•™ä¸€å®šçš„ç‰©ç†é¡µæ•°é‡ï¼Œé˜²æ­¢é«˜ä½å†…å­˜åŒºåŸŸå¯¹è‡ªå·±å†…å­˜ç©ºé—´è¿›è¡Œè¿‡å¤šçš„æŒ¤å‹ã€‚å¦‚å½“NORMALåŒºåŸŸåˆ†é…ä¸åˆ°å†…å­˜æ˜¯ï¼Œä¼šå¾€ä¸‹åˆ†é…DMAåŒºåŸŸï¼ŒDMAåŒºåŸŸè¦ä¿ç•™ä¸€å®šç©ºé—´ä¸èƒ½è®©NORMALåŒºåŸŸçš„æŒ¤å‹ã€‚</li>
<li>managed_pages: é€šè¿‡buddyä¼™ä¼´ç³»ç»Ÿç®¡ç†çš„æ‰€æœ‰å¯ç”¨é¡µï¼Œ=present_pages-reserved_pages</li>
<li>spanned_pages:zoneåŒºåŸŸæ‰€æœ‰çš„ç‰©ç†é¡µï¼ŒåŒ…å«ç©ºæ´ï¼Œ=zone_end_pfn-zone_start_pfn</li>
<li>present_pages:zoneåŒºåŸŸå¯ç”¨çš„æ‰€æœ‰ç‰©ç†é¡µï¼ŒåŒ…å«reserved_pagesï¼Œ=spanned_pages-hole_pages</li>
<li>WMARK_HIGH:å½“ç‰©ç†å†…å­˜åŒºåŸŸçš„å‰©ä½™å†…å­˜å®¹é‡é«˜äº_watermark[WMARK_HIGH]æ—¶ï¼Œè¯´æ˜ç‰©ç†å†…å­˜åŒºåŸŸä¸­çš„å†…å­˜å®¹é‡éå¸¸å……è¶³ï¼Œå†…å­˜åˆ†é…æ²¡æœ‰å‹åŠ›</li>
<li>WMARK_LOW:å½“å‰©ä½™å†…å­˜å®¹é‡ä»‹äº_watermark[WMARK_LOW]ä¸_watermark[WMARK_HIGH]ä¹‹é—´æ—¶ï¼Œè¯´æ˜æ­¤æ—¶å†…å®¹å®¹é‡æœ‰ç‚¹å±é™©äº†ï¼Œå†…å­˜åˆ†é…é¢ä¸´ä¸€å®šå‹åŠ›ï¼Œä½†æ˜¯è¿˜å¯ä»¥æ»¡è¶³è¿›ç¨‹çš„å†…å­˜åˆ†é…è¦æ±‚ï¼Œå½“ç»™è¿›ç¨‹åˆ†é…å®Œå†…å­˜ä¹‹åï¼Œå°±ä¼šå”¤é†’kswapdè¿›ç¨‹å¼€å§‹è¿›è¡Œå†…å­˜å›æ”¶ï¼ŒçŸ¥é“å‰©ä½™å†…å­˜é«˜äº_watermark[WMARK_HIGH]ä¸ºæ­¢ã€‚åˆ†é…å†…å­˜æ—¶ä¼šè§¦å‘å†…å­˜å›æ”¶ï¼Œä½†æ˜¯åˆ†é…çš„è¿›ç¨‹æœ¬èº«ä¸ä¼šè¢«é˜»å¡ï¼Œå±äºå¼‚æ­¥å›æ”¶å†…å­˜ã€‚</li>
<li>WMARK_MIN:å½“å‰©ä½™å†…å­˜å®¹é‡ä½äº_watermark[WMARK_MIN]æ—¶ï¼Œè¯´æ˜æ­¤æ—¶çš„å†…å®¹å®¹é‡éå¸¸å±é™©äº†ï¼Œå¦‚æœè¿›ç¨‹å†æ­¤æ—¶è¯·æ±‚åˆ†é…å†…å­˜ï¼Œå†…æ ¸ä¼šè¿›è¡Œé˜»å¡å¼ç›´æ¥å†…å­˜å›æ”¶ï¼Œç›´åˆ°å†…å­˜å®¹é‡å¤§äº_watermark[WMARK_LOW]ç»™äºˆåˆ†é…ã€‚_watermark[WMARK_MIN]ä»¥ä¸‹çš„å†…å­˜å®¹é‡æ—¶é¢„ç•™ç»™å†…æ ¸åœ¨ç´§æ€¥æƒ…å†µä¸‹ä½¿ç”¨çš„ï¼Œè¿™éƒ¨åˆ†å†…å­˜å¯¹åº”çš„æ—¶nr_reserved_highatomicã€‚</li>
</ul>
<h5 id="_20">æ°´ä½çº¿çš„è®¡ç®—æ¦‚è¿°</h5>
<p>WMARK_HIGH,WMARK_LOW,WMARK_MINè¿™ä¸ªä¸‰ä¸ªæ°´ä½çº¿çš„æ•°å€¼æ˜¯é€šè¿‡å†…æ ¸å‚æ•°/proc/sys/vm/min_free_kbytesä¸ºåŸºå‡†åˆ†åˆ«è®¡ç®—å¤„ç†çš„ï¼Œå•ä½æ˜¯KBã€‚min_free_kbytesæ˜¯ç³»ç»Ÿä¿ç•™ç©ºé—²å†…å­˜çš„æœ€ä½é™ï¼Œ_watermark[WMARK_MIN]çš„æ˜¯é€šè¿‡min_free_kbytesè®¡ç®—å‡ºæ¥çš„ã€‚</p>
<ul>
<li>_watermark[WMARK_MIN]=f(min_free_kbytes)</li>
<li>_watermark[WMARK_LOW]=1.25*_watermark[WMARK_MIN]</li>
<li>_watermark[WMARK_HIGH]=1.5*[WMARK_LOW]</li>
</ul>
<h5 id="min_free_kbytes">min_free_kbytesè®¡ç®—</h5>
<p>åœ¨å‡½æ•°calculate_min_free_kbytesç”¨äºè®¡ç®—min_free_kbytesçš„å€¼ï¼Œæ¥ä¸‹æ¥çº¿çœ‹çœ‹min_free_kbyteså†…æ ¸æ˜¯å¦‚ä½•è®¡ç®—å‡ºæ¥çš„ã€‚å¦‚ä¸‹ï¼ˆå¦‚æœæœ‰DMA32ä¹Ÿéœ€è¦åŒ…å«è¿›å»ï¼‰ï¼Œåˆå§‹åŒ–æ—¶high=0ï¼Œæ‰€ä»¥å®é™…ç­‰äºZONE_DMA+ZONE_NORMALä¸­managed_pagesçš„å’Œã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_6340e226d227b860c482fd1b1bc874b2.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_6340e226d227b860c482fd1b1bc874b2.jpg"/></a></p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_3e44bddb70f008f147fd8ccef9dd9bfa.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_3e44bddb70f008f147fd8ccef9dd9bfa.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">nr_free_zone_pages</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">zoneref</span><span class="w"> </span><span class="o">*</span><span class="n">z</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="o">*</span><span class="n">zone</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Just pick one node, since fallback list is circular */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">zonelist</span><span class="w"> </span><span class="o">*</span><span class="n">zonelist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_zonelist</span><span class="p">(</span><span class="n">numa_node_id</span><span class="p">(),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="err">ï¼ˆ</span><span class="mi">1</span><span class="err">ï¼‰</span><span class="n">å¯¹æ¯ä¸ªzoneåšè®¡ç®—</span><span class="err">ï¼Œ</span><span class="n">å°†æ¯ä¸ªzoneä¸­ä½äºhighæ°´ä½çš„å¯ç”¨å†…å­˜åšç´¯åŠ </span><span class="err">ï¼Œ</span><span class="n">å¾—åˆ°å¦‚ä¸Šå›¾çš„A</span><span class="o">+</span><span class="n">B</span><span class="err">ã€‚</span><span class="n">åˆå§‹åŒ–æ—¶</span><span class="err">ï¼Œ</span><span class="n">high_pageså®é™…</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">    </span><span class="n">for_each_zone_zonelist</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">zonelist</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zone_managed_pages</span><span class="p">(</span><span class="n">zone</span><span class="p">);</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">high_wmark_pages</span><span class="p">(</span><span class="n">zone</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">high</span><span class="p">)</span>
<span class="w">            </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">high</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">nr_free_buffer_pages</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nr_free_zone_pages</span><span class="p">(</span><span class="n">gfp_zone</span><span class="p">(</span><span class="n">GFP_USER</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">calculate_min_free_kbytes</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">lowmem_kbytes</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">new_min_free_kbytes</span><span class="p">;</span>
<span class="err">ï¼ˆ</span><span class="mi">2</span><span class="err">ï¼‰</span><span class="n">ä½ä½å†…å­˜åŒºåŸŸ</span><span class="err">ï¼ˆ</span><span class="n">éHIGH_MEM</span><span class="err">ï¼Œ</span><span class="n">å®é™…ä¸Š64æ²¡æœ‰HIGH_MEM</span><span class="err">ï¼‰</span><span class="n">æ€»å®¹é‡æœ‰é¡µæ•°è½¬ä¸ºKB</span><span class="err">ã€‚</span>
<span class="n">lowmem_kbytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nr_free_buffer_pages</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="err">ï¼ˆ</span><span class="mi">3</span><span class="err">ï¼‰</span><span class="n">å¯¹lowmem_kbytes</span><span class="o">*</span><span class="mi">16</span><span class="n">å†è¿›è¡Œå¼€æ–¹</span>
<span class="w">    </span><span class="n">new_min_free_kbytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">int_sqrt</span><span class="p">(</span><span class="n">lowmem_kbytes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<span class="err">ï¼ˆ</span><span class="mi">4</span><span class="err">ï¼‰</span><span class="n">user_min_free_kbytesæ˜¯ç”¨æˆ·è®¾ç½®çš„å€¼</span><span class="err">ï¼ˆ</span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">min_free_kbytes</span><span class="err">ï¼‰ï¼Œ</span><span class="n">ç®—å‡ºæ¥çš„å€¼ä¸ç”¨æˆ·è®¾ç½®çš„å€¼è¿›è¡Œæ¯”è¾ƒå–å¤§å€¼</span><span class="err">ï¼Œ</span><span class="n">ä½†æ˜¯æœ€ç»ˆèŒƒå›´éœ€è¦ä»‹äº128</span><span class="o">~</span><span class="mi">262144</span><span class="n">KBä¹‹é—´</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">new_min_free_kbytes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">user_min_free_kbytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">min_free_kbytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_min_free_kbytes</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">min_free_kbytes</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span>
<span class="w">            </span><span class="n">min_free_kbytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">min_free_kbytes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">262144</span><span class="p">)</span>
<span class="w">            </span><span class="n">min_free_kbytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">262144</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_warn</span><span class="p">(</span><span class="err">\</span><span class="s">"min_free_kbytes is not updated to %d because user defined value %d is preferred</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,</span>
<span class="w">                </span><span class="n">new_min_free_kbytes</span><span class="p">,</span><span class="w"> </span><span class="n">user_min_free_kbytes</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="_21">æ°´ä½çº¿è®¾ç½®</h5>
<p>å‡½æ•°setup_per_zone_wmarksç”¨äºè®¡ç®—watermark[min,low,high]çš„å€¼ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">__setup_per_zone_wmarks</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="err">ï¼ˆ</span><span class="mi">1</span><span class="err">ï¼‰</span><span class="n">å°†min_free_kbytesè½¬ä¸ºpageä¸ºå•ä½</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pages_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min_free_kbytes</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">lowmem_pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="o">*</span><span class="n">zone</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Calculate total number of !ZONE_HIGHMEM pages */</span>
<span class="w">    </span><span class="n">for_each_zone</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">is_highmem</span><span class="p">(</span><span class="n">zone</span><span class="p">))</span>
<span class="w">            </span><span class="n">lowmem_pages</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">zone_managed_pages</span><span class="p">(</span><span class="n">zone</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">for_each_zone</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">u64</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="n">è®¡ç®—å‡ºæ°´çº¿æŒ¡ä½åŸºç¡€å€¼tmp</span><span class="o">=</span>
<span class="w"> </span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">min_free_kbytes</span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">zone_managed_pages</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lowmem_pages</span>
<span class="n">å¦‚æœåªæœ‰ä¸€ä¸ªzoneçš„è¯</span><span class="err">ï¼Œ</span><span class="n">tmp</span><span class="o">=</span><span class="w"> </span><span class="n">min_free_kbytes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span>
<span class="w">        </span><span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pages_min</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">zone_managed_pages</span><span class="p">(</span><span class="n">zone</span><span class="p">);</span>
<span class="w">        </span><span class="n">do_div</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">lowmem_pages</span><span class="p">);</span>
<span class="w">        </span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="n">HIGHMEM_ZONEæ°´çº¿æŒ¡ä½è®¡ç®—</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_highmem</span><span class="p">(</span><span class="n">zone</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/*</span>
<span class="cm">             * __GFP_HIGH and PF_MEMALLOC allocations usually don\'t</span>
<span class="cm">             * need highmem pages, so cap pages_min to a small</span>
<span class="cm">             * value here.</span>
<span class="cm">             *</span>
<span class="cm">             * The WMARK_HIGH-WMARK_LOW and (WMARK_LOW-WMARK_MIN)</span>
<span class="cm">             * deltas control async page reclaim, and so should</span>
<span class="cm">             * not be capped for highmem.</span>
<span class="cm">             */</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">min_pages</span><span class="p">;</span>

<span class="w">            </span><span class="n">min_pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zone_managed_pages</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<span class="w">            </span><span class="n">min_pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clamp</span><span class="p">(</span><span class="n">min_pages</span><span class="p">,</span><span class="w"> </span><span class="n">SWAP_CLUSTER_MAX</span><span class="p">,</span><span class="w"> </span><span class="mi">128UL</span><span class="p">);</span>
<span class="w">            </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">_watermark</span><span class="p">[</span><span class="n">WMARK_MIN</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min_pages</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/*</span>
<span class="cm">             * If it\'s a lowmem zone, reserve a number of pages</span>
<span class="cm">             * proportionate to the zone\'s size.</span>
<span class="cm">             */</span>
<span class="w">            </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">_watermark</span><span class="p">[</span><span class="n">WMARK_MIN</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<span class="w">            </span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="n">éHIGHMEM_ZONE</span><span class="w"> </span><span class="n">æ°´ä½çº¿minæŒ¡ä½çš„è®¡ç®—</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Set the kswapd watermarks distance according to the</span>
<span class="cm">         * scale factor in proportion to available memory, but</span>
<span class="cm">         * ensure a minimum size on small systems.</span>
<span class="cm">         */</span>
<span class="w">       </span><span class="err">ï¼ˆ</span><span class="mi">5</span><span class="err">ï¼‰</span><span class="n">è®¡ç®—å„ä¸ªzoneçš„lowå’ŒhigæŒ¡ä½çš„å€¼</span><span class="err">ï¼Œ</span><span class="n">æŒ¡ä½å€¼tmpä¼šå—ç”¨æˆ·èŠ‚ç‚¹</span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">watermark_scale_factorçš„å½±å“</span><span class="err">ï¼Œ</span><span class="n">è®©ç”¨æˆ·å¯è°ƒèŠ‚minåˆ°lowå’Œhighé—´çš„æ¯”ä¾‹å…³ç³»</span><span class="err">ã€‚</span><span class="n">tmpä¸ºminä¸lowå’Œhighä¹‹é—´çš„å·®å€¼</span><span class="err">ï¼Œ</span><span class="n">mult_frac</span><span class="p">(</span><span class="n">zone_managed_pages</span><span class="p">(</span><span class="n">zone</span><span class="p">),</span><span class="n">watermark_scale_factor</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">)</span><span class="o">=</span><span class="n">zone_managed_pages</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">watermark_scale_factor</span><span class="o">/</span><span class="mi">10000</span><span class="p">)</span><span class="err">ï¼Œ</span><span class="n">å³æ€»å†…å­˜å¤§å°</span><span class="o">*</span><span class="err">ï¼ˆ</span><span class="n">watermark_scale_factor</span><span class="o">/</span><span class="mi">10000</span><span class="err">ï¼‰ï¼Œ</span><span class="n">å› æ­¤tmpå–çš„æ˜¯</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">2</span><span class="n">å’Œ</span><span class="err">ï¼ˆ</span><span class="n">watermark_scale_factor</span><span class="o">/</span><span class="mi">10000</span><span class="p">)</span><span class="n">çš„æœ€å¤§å€¼</span><span class="err">ï¼Œ</span><span class="n">æ„æ€å°±æ˜¯å³ä½¿ç”¨æˆ·é€šè¿‡èŠ‚ç‚¹ä¿®æ”¹</span><span class="err">ï¼Œ</span><span class="n">ä½†æ˜¯å€¼ç®—å‡ºæ¥å°</span><span class="err">ï¼Œ</span><span class="n">è¿˜æ˜¯ä¼šé€‰æ‹©åŸè®¡ç®—å‡ºæ¥çš„å·®å€¼</span><span class="err">ã€‚</span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_t</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">                </span><span class="n">mult_frac</span><span class="p">(</span><span class="n">zone_managed_pages</span><span class="p">(</span><span class="n">zone</span><span class="p">),</span>
<span class="w">                      </span><span class="n">watermark_scale_factor</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">));</span>

<span class="w">        </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">watermark_boost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">_watermark</span><span class="p">[</span><span class="n">WMARK_LOW</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">min_wmark_pages</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<span class="w">        </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">_watermark</span><span class="p">[</span><span class="n">WMARK_HIGH</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min_wmark_pages</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">        </span><span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* update totalreserve_pages */</span>
<span class="w">    </span><span class="n">calculate_totalreserve_pages</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="watermark_scale_factor">watermark_scale_factor</h5>
<p>minæ°´ä½åˆ°lowå’Œhighæ°´ä½ä¹‹é—´çš„è·ç¦»ï¼Œå¯ä»¥é€šè¿‡è°ƒèŠ‚èŠ‚ç‚¹/proc/sys/vm/watermark_scale_factoræ¥æ§åˆ¶ï¼Œå†…å­˜å æ¯”è®¡ç®—æ–¹å¼ä¸ºèŒƒå›´ä¸ºwatermark_scale_factor/10000ï¼Œæ„æ€æ˜¯minä¸lowçš„å·®å€¼ä¸ºæ€»å†…å­˜å¤§å°*ã€‚</p>
<p>ï¼ˆwatermark_scale_factor/10000ï¼‰ï¼Œwatermark_scale_factorå–å€¼èŒƒå›´10~1000ï¼Œæ‰€ä»¥å æ¯”èŒƒå›´0.1%~10%ï¼ˆ10/10000~1000/10000ï¼‰ã€‚å› æ­¤minå’Œlowçš„å·®å€¼ä¸ºæ€»å†…å­˜å¤§å°*ï¼ˆ0.1%~10%ï¼‰ã€‚</p>
<p>å°ç»“ï¼Œå¯¹åº”æ°´çº¿çš„lowå’Œhighä¸ºæ­¢åˆ†ä¸¤ç§æƒ…å†µï¼š - è‹¥min_free_kbytesåå¤§ï¼Œåˆ™æ°´çº¿lowåˆ°highåŒºé—´é•¿åº¦ç”±min_free_kbyteså†³å®šï¼Œ - è‹¥min_free_kbytesåå°ï¼Œåˆ™æ°´çº¿lowåˆ°highåŒºé—´é•¿åº¦ç”±watermark_scale_factorå†³å®šã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_c3401f3e65a06bbc7b76c2fd4e5ec865.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_c3401f3e65a06bbc7b76c2fd4e5ec865.jpg"/></a></p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_f173f629f2884001b99edee9bc09115a.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_f173f629f2884001b99edee9bc09115a.jpg"/></a></p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_3a6275365e1dcb5dd3b76af984d3c1e8.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_3a6275365e1dcb5dd3b76af984d3c1e8.jpg"/></a></p>
<p>å½“åˆ†é…å†…å­˜å‘ç°å‰©ä½™ç©ºé—´ä½äºä½æ°´ä½ï¼Œå°†ä¼šå”¤é†’kswpadå†…æ ¸çº¿ç¨‹è¿›è¡Œå†…å­˜å›æ”¶,å›æ”¶è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚æœlowä¸minæ°´ä½å·®å€¼è¾ƒå°ï¼Œå³ä½¿kswpadå¯åŠ¨ï¼Œä½†æ˜¯å›æ”¶è¿‡ç¨‹æ˜¯ç¼“æ…¢ï¼Œå½“å‡ºç°çªå‘å¤§å†…å­˜åˆ†é…æ—¶ï¼Œå¯èƒ½ç›´æ¥è§¦å‘åˆ°minæ°´ä½ï¼Œè¿™æ—¶å€™å°±ä¼šè§¦å‘é˜»å¡å¼å†…å­˜å›æ”¶ï¼ˆDirect Reclaimï¼‰ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œåˆç†çš„è°ƒæ•´lowå’Œminä¹‹é—´çš„å·®å€¼ï¼Œå› æ­¤å¼•å…¥äº†watermark_scale_factorï¼Œè¯¥å€¼å°±æ˜¯è¿›è¡Œäººä¸ºè°ƒæ•´lowå’Œminä¹‹é—´çš„å·®å€¼ï¼Œå½“å·®å€¼è¾ƒå¤§æ—¶ï¼Œä¸­é—´ç©ºä½™ç©ºé—´è¾ƒå¤§ï¼Œä¹Ÿèƒ½ä½¿kswpadæå‰è¿›è¡Œå”¤é†’å›æ”¶å†…å­˜ã€‚ å¯ä»¥è§‚å¯Ÿ/proc/vmstatä¸­çš„allocstallè®¡æ•°ï¼Œå½“è¿›ç¨‹é¢‘ç¹å‘ç”Ÿallocstallæˆ–è€…kswapdè¿‡æ—©è¿›å…¥ä¼‘çœ çŠ¶ä½“ï¼Œè¯´æ˜minå’Œlowæ°´ä½å·®å€¼å¤ªå°ï¼Œæ— æ³•åº”å¯¹çªå‘å†…å­˜åˆ†é…ã€‚å³å¯é€šè¿‡watermark_scale_factorç”¨äºè°ƒæ•´kspwadçš„æ¿€è¿›ç¨‹åº¦ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">vmstat</span><span class="w"> </span><span class="o">|</span><span class="n">grep</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="err">'</span><span class="n">allocstall</span><span class="o">|</span><span class="n">kswapd_low_wmark_hit_quickly</span><span class="err">'</span>
<span class="n">allocstall_dma</span><span class="w"> </span><span class="mi">0</span>
<span class="n">allocstall_dma32</span><span class="w"> </span><span class="mi">0</span>
<span class="n">allocstall_normal</span><span class="w"> </span><span class="mi">4</span>
<span class="n">allocstall_movable</span><span class="w"> </span><span class="mi">11</span>
<span class="n">kswapd_low_wmark_hit_quickly</span><span class="w"> </span><span class="mi">611</span>
</code></pre></div>
<p>å¦‚ä¸Šï¼Œå¦‚æœè¿™äº›æ•°å€¼åœ¨çŸ­æ—¶é—´å†…æ˜¯å¦æœ‰å¢åŠ ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¯´æ˜é¢‘ç¹å‘ç”ŸDirect Recleamï¼Œéœ€è¦è°ƒå¤§watermark_scale_factorã€‚ æ€è€ƒï¼šå¦‚æœminå’Œlowæ°´ä½çº¿å·®å€¼å¾ˆå¤§ï¼Œåˆæœ‰ä»€ä¹ˆåå¤„ï¼Ÿ</p>
<h5 id="watermark">watermarkåˆ¤æ–­</h5>
<p>åœ¨å¿«é€Ÿè·¯å¾„åˆ†é…ç« èŠ‚ä¸­ï¼Œå†…å­˜åˆ†é…ä¼šè¿›è¡Œæ°´ä½çš„æ£€æµ‹ï¼Œå…¶ä¸­__zone_watermark_okç”¨äºæ£€æµ‹å†…å­˜æ°´ä½æƒ…å†µã€‚</p>
<h5 id="_22">é¢„ç•™å†…å­˜</h5>
<p>æ ¹æ®ç‰©ç†å†…å­˜åœ°å€é«˜ä½ï¼Œä½ä½å†…å­˜åˆ°é«˜ä½å†…å­˜åŒºåŸŸçš„é¡ºåºä¸€æ¬¡ï¼šZONE_DMAï¼ŒZONE_DMA32ï¼ŒZONE_NORMALï¼ŒZONE_HIGHMEMã€‚å½“é«˜ä½å†…å­˜åŒºåŸŸä¸å¤Ÿç”¨æ—¶ï¼Œå†…å­˜å°±ä¼šå‘ä¸‹æŒ¤å‹å…¶ä»–å†…å­˜åŒºåŸŸç‰©ç†å†…å­˜æ¥æ»¡è¶³å†…å­˜åˆ†é…éœ€æ±‚ã€‚å¦‚ä»ZONE_NORMALä¸­åˆ†é…å†…å­˜ï¼Œå½“åˆ†é…å®Œæ˜¯ä¼šä»ZONE_DMAä¸­è¿›è¡Œåˆ†é…ã€‚ä½†æ˜¯å†…æ ¸ä¸å…è®¸é«˜ä½å†…å­˜æ— é™åˆ¶çš„æŒ¤å‹ä½ä½å†…å­˜åŒºåŸŸï¼Œå› ä¸ºä½ä½å†…å­˜æœ‰ç€ç‰¹å®šçš„ç”¨é€”ï¼Œæ¯”å¦‚ZONE_DMAåŒºåŸŸæ»¡è¶³ç‰¹å®šè®¾å¤‡çš„å¯»å€ï¼ˆISAï¼‰ã€‚å› æ­¤æ¯ä¸ªå†…å­˜åŒºåŸŸä¼šç»™è‡ªå·±é¢„ç•™ä¸€å®šçš„å†…å­˜ï¼Œé˜²æ­¢è¢«é«˜ä½å†…å­˜åŒºåŸŸæŒ¤å‹å ç”¨ã€‚æ¯ä¸ªå†…å­˜åŒºåŸŸä½è‡ªå·±é¢„ç•™çš„è¿™éƒ¨åˆ†å†…å­˜å°±å­˜å‚¨åœ¨lowmem_reserveæ•°ç»„ä¸­ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">......</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_reserved_highatomic</span><span class="p">;</span>
<span class="kt">long</span><span class="w"> </span><span class="n">lowmem_reserve</span><span class="p">[</span><span class="n">MAX_NR_ZONES</span><span class="p">];</span>
<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>nr_reserved_highatomic:è¯¥èŠ‚ç‚¹å†…å­˜åŒºåŸŸä¸€å…±é¢„ç•™çš„å†…å­˜å¤§å°ï¼Ÿ</li>
<li>lowmem_reserveï¼šç”¨äºè§„å®šæ¯ä¸ªå†…å­˜åŒºåŸŸä¸ºè‡ªå·±é¢„ç•™çš„ç‰©ç†é¡µé¢æ•°é‡ï¼Œé˜²æ­¢é«˜ä½å†…å­˜åŒºåŸŸæŒ¤å‹ã€‚ é¢„ç•™å†…å­˜ä¸lowmem_reserve_ratioå€¼æœ‰å…³ã€‚</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">sysctl_lowmem_reserve_ratio</span><span class="p">[</span><span class="n">MAX_NR_ZONES</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="cp">#ifdef CONFIG_ZONE_DMA</span>
<span class="w">    </span><span class="p">[</span><span class="n">ZONE_DMA</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ZONE_DMA32</span>
<span class="w">    </span><span class="p">[</span><span class="n">ZONE_DMA32</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">[</span><span class="n">ZONE_NORMAL</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_HIGHMEM</span>
<span class="w">    </span><span class="p">[</span><span class="n">ZONE_HIGHMEM</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">[</span><span class="n">ZONE_MOVABLE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">ç³»ç»Ÿé€šè¿‡è¯»å–èŠ‚ç‚¹ä¹Ÿèƒ½å¤Ÿè·å–å…¶å€¼</span><span class="err">ï¼ˆ</span><span class="n">å¦‚ä¸‹</span><span class="err">ï¼Œ</span><span class="n">æ²¡æœ‰HIGHMEM</span><span class="err">ï¼‰</span>
<span class="n">root</span><span class="err">@</span><span class="n">TinaLinux</span><span class="o">:/</span><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">lowmem_reserve_ratio</span>
<span class="mi">256</span><span class="w">     </span><span class="mi">256</span><span class="w">     </span><span class="mi">32</span><span class="w">      </span><span class="mi">0</span>
</code></pre></div>
<p>å‡è®¾ZONE_DMA32ï¼ŒZONE_NORMALï¼ŒZONE_MOVABLEçš„å†…å­˜å¤§å°åˆ†åˆ«æ˜¯B,C,Dï¼Œåˆ™é¢„ç•™å†…å­˜çš„è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š - ZONE_DMA: B/256 + (B+C)/256 + (B+C+D)/256 - ZONE_DMA32: C/256 + (C+D)/256 - ZONE_NORMAL:D/32 - ZONE_MOVABLEï¼š0</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setup_per_zone_lowmem_reserve</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pglist_data</span><span class="w"> </span><span class="o">*</span><span class="n">pgdat</span><span class="p">;</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">zone_type</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>

<span class="w">    </span><span class="n">for_each_online_pgdat</span><span class="p">(</span><span class="n">pgdat</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_NR_ZONES</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="o">*</span><span class="n">zone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">node_zones</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sysctl_lowmem_reserve_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">ratio</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">zone_managed_pages</span><span class="p">(</span><span class="n">zone</span><span class="p">);</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">managed_pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_NR_ZONES</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="o">*</span><span class="n">upper_zone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">node_zones</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="w">                </span><span class="err">ï¼ˆ</span><span class="mi">1</span><span class="err">ï¼‰</span><span class="n">å¾€ä¸Šè®¡ç®—zoneåŒºæ€»å†…å­˜å¤§å°</span>
<span class="w">                </span><span class="n">managed_pages</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">zone_managed_pages</span><span class="p">(</span><span class="n">upper_zone</span><span class="p">);</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clear</span><span class="p">)</span>
<span class="w">                    </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">lowmem_reserve</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">lowmem_reserve</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">managed_pages</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ratio</span><span class="p">;</span>
<span class="w">                 </span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="n">é¢„ç•™å†…å­˜ç­‰äºæ€»å†…å­˜</span><span class="o">/</span><span class="n">ratio</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* update totalreserve_pages */</span>
<span class="w">    </span><span class="n">calculate_totalreserve_pages</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>è®¡ç®—æ–¹å¼å›¾ä¸¾ä¾‹ï¼Œå¦‚ä¸‹ï¼š <a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_75ed7c9261af53d97e712ab483afd736.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_75ed7c9261af53d97e712ab483afd736.jpg"/></a></p>
<p>å›¾æ¥æºäºç½‘ç»œ</p>
<p>å¯ä»¥é€šè¿‡/proc/zoneinfoèŠ‚ç‚¹æŸ¥çœ‹å„ä¸ªå†…å­˜åŒºåŸŸé¢„ç•™å†…å­˜å¤§å°ï¼Œå‚æ•°protectionè¯»å–çš„å°±æ˜¯å†…å­˜ç®¡ç†åŒºä¸­lowmem_reserve[]æ•°ç»„çš„å€¼ï¼Œlowmem_reserve[]æ•°ç»„çš„å•ä½æ˜¯é¡µé¢ã€‚è®¾ç½®lowmem_reservedæ˜¯ä¸ºäº†é˜²æ­¢é¡µé¢åˆ†é…å™¨è¿‡åº¦ä½ä»ä½ç«¯å†…å­˜ç®¡ç†åŒºä¸­åˆ†é…å†…å­˜ã€‚ä¸‹å›¾ä¸­ï¼ŒZONE_DMA32ï¼ŒZONE_NORMALå¯¹åº”çš„protectionéƒ½ä¸º0ï¼Œè¯´æ˜ä¸éœ€è¦åšä¿æŠ¤ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_7dc17118cf466206c6f58ab7abaf214c.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_7dc17118cf466206c6f58ab7abaf214c.jpg"/></a></p>
<p>åœ¨å†…å­˜ç®¡ç†ä¸­ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³è¿™æ¬¡åˆ†é…ä»»åŠ¡æ˜¯é€šè¿‡__zone_watermark_okæ¥åˆ¤æ–­ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nf">__zone_watermark_ok</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="o">*</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">mark</span><span class="p">,</span>
<span class="w">             </span><span class="kt">int</span><span class="w"> </span><span class="n">highest_zoneidx</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">alloc_flags</span><span class="p">,</span>
<span class="w">             </span><span class="kt">long</span><span class="w"> </span><span class="n">free_pages</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">......</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">free_pages</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">lowmem_reserve</span><span class="p">[</span><span class="n">highest_zoneidx</span><span class="p">])</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<p>zè¡¨ç¤ºå½“å‰æ‰«æçš„å†…å­˜ç®¡ç†åˆ†åŒºï¼Œhighest_zoneidxè¡¨ç¤ºè¿™æ¬¡åˆ†é…è¯·æ±‚é¦–é€‰çš„å†…å­˜ç®¡ç†åŒºï¼Œminä¸ºå½“å‰ç®¡ç†åŒºçš„æœ€ä½æ°´ä½å€¼ï¼Œå› æ­¤å½“å‘ç°å‰©ä½™å†…å­˜å°äºä½æ°´ä½+å½“å‰åˆ†åŒºçš„é¢„ç•™å†…å­˜ï¼Œé‚£ä¹ˆåˆ†é…å¤±è´¥ã€‚ æ¯ä¸ªå†…å­˜ç®¡ç†åŒºçš„lowmem_reserve[]å¯ä»¥é€šè¿‡è°ƒæ•´lowmem_reserve_ratioèŠ‚ç‚¹çš„å€¼æ¥ä¿®æ”¹ï¼Œæœ€ç»ˆè¿˜æ˜¯é€šè¿‡è¯¥è°ƒç”¨setup_per_zone_lowmem_reserveæ¥å®ç°ã€‚</p>
<h4 id="_23">å†·çƒ­é¡µ</h4>
<p>å¾…è¡¥å……</p>
<h2 id="_24">å†…å­˜è§„æ•´</h2>
<p>ä¼™ä¼´ç³»ç»Ÿä»¥é¡µçš„æ–¹å¼æ¥ç®¡ç†ç‰©ç†å†…å­˜ï¼Œéšç€ç³»ç»Ÿä¸æ–­çš„è¿è¡Œï¼Œç³»ç»Ÿå°±ä¼šäº§ç”Ÿç¢ç‰‡ï¼Œä¸€æ—¦å½¢æˆå¤§ç‰‡çš„ç¢ç‰‡ï¼Œç³»ç»Ÿå°±æ— æ³•åˆ†é…è¿ç»­çš„ç‰©ç†å†…å­˜ï¼ˆå¯¹ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹æ— å½±å“ï¼Ÿï¼‰ï¼Œå› æ­¤linuxå†…æ ¸å¼•å…¥çš„å†…å­˜è§„æ•´æŠ€æœ¯ï¼Œæ¥å¤„ç†å†…å­˜ç¢ç‰‡çš„é—®é¢˜ã€‚å†…å­˜ç¢ç‰‡å¯ä»¥åˆ†é…å†…ç¢ç‰‡å’Œå¤–ç¢ç‰‡ã€‚ å†…ç¢ç‰‡ï¼šç‰©ç†å†…å­˜é¡µé‡Œé¢çš„ç¢ç‰‡ã€‚ å¤–ç¢ç‰‡ï¼šç‰©ç†å†…å­˜é¡µä¹‹é—´çš„ç¢ç‰‡ï¼Œé€ æˆæ— æ³•åˆ†é…è¿ç»­ç‰©ç†é¡µã€‚</p>
<h3 id="_25">åŸºæœ¬åŸç†</h3>
<p>åœ¨å†…å­˜å¡è¿ç§»ç« èŠ‚ä¸­ï¼Œå†…æ ¸å®šä¹‰äº†migrate_typeç”¨äºæè¿°è¿ç§»ç±»å‹ï¼Œä¸»è¦æœ‰ - MIGRATE_MOVABLE:å¯ç§»åŠ¨ï¼Œè¡¨ç¤ºè¿™ä¸ªå†…å­˜åŒºåŸŸçš„é¡µé¢å¯ä»¥è‡ªç”±è¢«è¿ç§»ï¼Œé€šå¸¸ç”¨äºç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿå†…å­˜æˆ–è€…æ”¯æŒè™šæ‹Ÿæœºçš„å†…å­˜ç®¡ç†åœºæ™¯ã€‚ - MIGRATE_RECALAIMABLE:ä¸å¯ç§»åŠ¨ï¼Œä½†é¡µé¢å¯ä»¥è¢«å›æ”¶ï¼Œä¾‹å¦‚åŒ…å«ç¼“å­˜é¡µï¼ŒåŒ¿åé¡µç­‰ã€‚ - MIGRATE_UNMOVABLE:ä¸å¯ç§»åŠ¨ï¼Œä¾‹å¦‚å†…æ ¸ä»£ç ï¼Œå†…æ ¸æ•°æ®ç­‰ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_e9abd1eb005c7aef6a3efab5b6f2a10a.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_e9abd1eb005c7aef6a3efab5b6f2a10a.jpg"/></a></p>
<ul>
<li>T0æ—¶åˆ»ï¼šå¤„äºè¿ç§»å‰ï¼Œæ­¤æ—¶ç‰©ç†å†…å­˜ä¸­æœ‰ç©ºé—²å†…å­˜ï¼Œä½†æ˜¯å¹¶ä¸è¿ç»­ã€‚</li>
<li>T1æ—¶åˆ»ï¼šå¯åŠ¨è¿ç§»ï¼Œè¿ç§»åˆ†ä¸¤ä¸ªæ–¹å‘å¯¹zoneåˆ†åŒºè¿›è¡Œéå†æ‰«æï¼ŒzoneåŒºåŸŸä½åœ°å€å¾€é«˜åœ°å€æ‰«æç©ºé—²çš„ç‰©ç†é¡µï¼ŒzoneåŒºåŸŸé«˜åœ°å€åˆ°åœ°å€æ‰«æå¯ç§»åŠ¨å·²åˆ†é…çš„ç‰©ç†é¡µï¼Œä¸¤ä¸ªæ‰«æå™¨åœ¨ä¸­é—´ç›¸é‡æ—¶ç»“æŸï¼Œå°†å¯ç§»åŠ¨å·²åˆ†é…çš„ç‰©ç†é¡µè¿ç§»ï¼ˆæ‹·è´ï¼‰åˆ°ç©ºé—²é¡µä¸­ï¼Œé‡Šæ”¾åŸå†…å­˜ã€‚</li>
<li>T2æ—¶åˆ»ï¼šè¿ç§»åï¼Œè„é¡µè¢«é›†ä¸­åˆ°ä¸€èµ·ï¼Œç©ºé—²é¡µè¢«é›†ä¸­åˆ°ä¸€èµ·ã€‚</li>
</ul>
<p>Linuxå†…æ ¸è§¦å‘å†…å­˜è§„æ•´æœ‰3ä¸ªé€”å¾„ - æ‰‹åŠ¨è§¦å‘ï¼šecho 1 &gt; proc/sys/vm/compact_memoryï¼Œä¼šè§¦å‘å†…å­˜è§„æ•´ã€‚ - kcompactdå†…æ ¸çº¿ç¨‹ï¼šæ¯ä¸ªå†…å­˜èŠ‚ç‚¹ä¼šåˆ›å»ºä¸€ä¸ªkcompactdå†…æ ¸çº¿ç¨‹ï¼Œåç§°ä¸ºkcompactd0ã€kcompactd1ç­‰ç­‰ã€‚å†…å­˜æ°´ä½ä¸å¤Ÿæ—¶ï¼Œkcompactdå®ˆæŠ¤çº¿ç¨‹ä¼šåœ¨åå°å”¤é†’ï¼Œä¸kswapdçº¿ç¨‹ç±»ä¼¼ã€‚ - ç›´æ¥å†…å­˜è§„æ•´ï¼šåœ¨å†…å­˜åˆ†é…ä¸è¶³æ—¶ï¼Œç›´æ¥è§¦å‘compactã€‚</p>
<h2 id="_26">å†…å­˜é¡µé¢å›æ”¶</h2>
<p>Linuxç³»ç»Ÿä¼šå°†å†…å­˜å°½å¯èƒ½çš„éƒ½ä½¿ç”¨èµ·æ¥ï¼Œå¦‚å°†å‰©ä½™çš„å†…å­˜ä½œä¸ºæ–‡ä»¶ç¼“å­˜ï¼ˆpage cacheï¼‰ä»è€Œæé«˜ç³»ç»Ÿçš„æ€§èƒ½ã€‚å½“æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡éœ€è¦åˆ†é…å†…å­˜å‘ç°å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šè¿›è¡Œå†…å­˜è¿›è¡Œå›æ”¶ï¼Œå°†ä¸å¸¸ç”¨çš„å†…å­˜è¿›è¡Œå›æ”¶ã€‚å†…å­˜å›æ”¶ä¸æ˜¯ç®€å•çš„å›æ”¶é¡µé¢è¶Šå¤šè¶Šå¥½ï¼Œå› ä¸ºç³»ç»Ÿä¸­å¾ˆå¤šåœ°æ–¹éƒ½æ˜¯ç”¨ç©ºé—´æ¢æ—¶é—´ï¼Œå¦‚å°½å¯èƒ½çš„ä½¿ç”¨å†…å­˜ä½œä¸ºè®¾å¤‡äº¤æ¢çš„ç¼“å­˜ï¼Œè¿™æ ·å¯ä»¥æå¤§çš„æé«˜ç³»ç»Ÿè¿è¡Œæ•ˆç‡ã€‚å› æ­¤å†…å­˜å›æ”¶æ˜¯ç³»ç»Ÿåœ¨åˆ†é…å†…å­˜ä¸è¶³æ—¶ï¼Œæ‰ä¼šè§¦å‘å›æ”¶ã€‚ å¯¹äºç”¨æˆ·ç©ºé—´æ¥è¯´ï¼Œé¡µå¯ä»¥åˆ†ä¸ºåŒ¿åé¡µåˆ†ä¸ºæ–‡ä»¶é¡µå’ŒåŒ¿åé¡µï¼Œå¯¹äºå†…æ ¸ç©ºé—´ç”³è¯·çš„å†…å­˜æ¥è¯´ï¼Œæ²¡æœ‰åŒ¿åé¡µå’Œæ–‡ä»¶é¡µçš„åˆ’åˆ†ï¼Œæ‰€ä»¥æœ¬ç« èŠ‚æè¿°çš„é¡µé¢å›æ”¶ï¼Œå›æ”¶çš„éƒ½æ˜¯ç”¨æˆ·ç©ºé—´çš„å†…å­˜ã€‚ - æ–‡ä»¶é¡µï¼ˆç£ç›˜ç¼“å­˜é¡µï¼‰ï¼šä¸ç£ç›˜å­˜åœ¨æ˜ å°„å…³ç³»çš„å†…å­˜é¡µï¼ˆæ–‡ä»¶èƒŒæ™¯ï¼‰ï¼Œå¦‚è¿›ç¨‹ä»£ç æ®µã€æ–‡ä»¶æ˜ å°„é¡µç­‰ï¼Œä»–ä»¬æœ‰å¯¹åº”çš„ç£ç›˜è¿›è¡Œå­˜å‚¨ï¼Œè¦å›æ”¶æ­¤ç±»é¡µé¢æ—¶ï¼Œå¯å°†é¡µé¢ç›´æ¥ä¸¢å¼ƒï¼ˆå›æ”¶ï¼‰ï¼Œæ•°æ®è¿˜èƒ½ä»ç£ç›˜ä¸­è¯»å–ï¼Œè¿™éƒ¨åˆ†ç§°ä¸ºpage cacheã€‚ - åŒ¿åé¡µï¼šæ²¡æœ‰ä¸ç£ç›˜å­˜åœ¨æ˜ å°„å…³ç³»ï¼ˆæ— æ–‡ä»¶èƒŒæ™¯ï¼‰ï¼Œå¦‚å †ã€æ ˆã€æ•°æ®æ®µç­‰ï¼Œå¦‚æœå°†æ­¤ç±»æ•°æ®ç›´æ¥ä¸¢å¼ƒå°†æ— æ³•æ‰¾å›ï¼Œå› æ­¤è¦å›æ”¶æ­¤ç±»é¡µé¢ï¼Œéœ€è¦å°†æ•°æ®äº¤æ¢åˆ°æŒ‡å®šç£ç›˜ç©ºé—´å­˜å‚¨ï¼ˆswapåˆ†åŒºï¼‰ã€‚ <a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_e377f9da1b30145066fc138246e74597.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_e377f9da1b30145066fc138246e74597.jpg"/></a></p>
<p>ç£ç›˜é«˜é€Ÿç¼“å­˜çš„é¡µé¢éƒ½æ˜¯å¯ä»¥ç›´æ¥è¢«ä¸¢å¼ƒå›æ”¶çš„ï¼Œä½†å½“ç£ç›˜ç¼“å­˜é¡µæ˜¯è„é¡µé¢æ—¶ï¼Œåœ¨ä¸¢å¼ƒå›æ”¶å‰éœ€è¦å°†å…¶å†™å›åˆ°ç£ç›˜ä¸­ã€‚ åŒ¿åé¡µæ˜¯ä¸å¯ä»¥ä¸¢å¼ƒçš„ï¼Œå› ä¸ºç£ç›˜ä¸­æ˜¯æ²¡æœ‰å¯¹åº”çš„å­˜å‚¨ï¼Œå› æ­¤è¦æƒ³å›æ”¶è¿™ç§ç±»å‹çš„é¡µé¢ï¼Œéœ€è¦å°†è¯¥é¡µé¢çš„æ•°æ®è½¬å‚¨åˆ°æŒ‡å®šç£ç›˜ç©ºé—´ä¸­ï¼ˆç§°ä¸ºswapåˆ†åŒºï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹é¡µç§°ä¸ºé¡µé¢äº¤æ¢ï¼ˆswapï¼‰ï¼Œæ˜¾ç„¶è¿™ç§äº¤æ¢çš„ä»£ä»·æ˜¯ç›¸å¯¹è¾ƒé«˜ä¸€äº›ã€‚ Linuxå†…æ ¸ä¸­é™¤éé¡µé¢è¢«ä¿ç•™æˆ–ä¸Šé”ï¼ˆç‰¹æ®Šå¤„ç†ï¼Œé¿å…å›æ”¶ï¼‰ï¼Œæ‰€æœ‰çš„ç£ç›˜é«˜é€Ÿç¼“å­˜é¡µé¢éƒ½å¯ä»¥å›æ”¶ï¼Œæ‰€æœ‰çš„åŒ¿åé¡µé¢é¡µå¯ä»¥è¢«äº¤æ¢å‡ºå»è€Œå›æ”¶ã€‚</p>
<h3 id="lru">LRUæœºåˆ¶</h3>
<p>å¯¹äºlinuxå†…å­˜å›æ”¶æ¥è¯´ï¼ŒLRUé“¾è¡¨æ˜¯å…³é”®ï¼Œå› ä¸ºå†…å­˜å›æ”¶çš„æ•´ä¸ªè¿‡ç¨‹éƒ½æ˜¯å¤„ç†LRUé“¾è¡¨çš„æ”¶ç¼©ã€‚LRUé“¾è¡¨ä¸»è¦æ˜¯å †é¡µè¿›è¡Œæ’åºï¼Œå°†ä½¿ç”¨é¢‘ç‡ä½çš„é¡µæ”¾åˆ°é“¾è¡¨å°¾éƒ¨ï¼Œä½¿ç”¨é¢‘ç‡é«˜çš„æ”¾åˆ°é“¾è¡¨å¤´éƒ¨ï¼›è€Œå†…å­˜å›æ”¶å°±æ˜¯å°†LRUé“¾è¡¨ä¸­æœ€è¿‘å¾ˆå°‘è®¿é—®çš„å°¾éƒ¨é¡µæ¡†å†…å®¹ä»å†…å­˜è½¬å‚¨åˆ°ç£ç›˜ä¸­ï¼ˆåˆ†ä¸ºåŒ¿åé¡µå’Œæ–‡ä»¶é¡µï¼‰ï¼Œç„¶åå°†å…¶é¡µæ¡†é‡Šæ”¾åˆ°ä¼™ä¼´ç³»ç»Ÿä½œä¸ºç©ºé—²å†…å­˜ä½¿ç”¨ã€‚ LRUç®—æ³•è®¤ä¸ºè¿‡å»ä¸€æ®µæ—¶é—´é¢‘ç¹ä½¿ç”¨çš„é¡µé¢ï¼Œåœ¨ä¸ä¹…çš„å°†æ¥å¯èƒ½ä¼šåœ¨æ­¤è®¿é—®åˆ°ï¼Œè€Œå¾ˆä¹…æ²¡æœ‰ä½¿ç”¨çš„é¡µé¢åœ¨æœªæ¥çŸ­æ—¶é—´å†…ä¹Ÿä¸ä¼šè¢«è®¿é—®åˆ°ï¼Œå› æ­¤åœ¨ç‰©ç†å†…å­˜ä¸å¤Ÿç”¨çš„æƒ…å†µä¸‹ï¼Œè¿™æ ·çš„é¡µé¢æˆä¸ºè¢«æ¢å‡ºçš„æœ€ä½³å€™é€‰è€…ã€‚ LRUçš„åŸºæœ¬åŸç†æ˜¯ä¸ºæ¯ä¸ªç‰©ç†é¡µé¢ç»‘å®šä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨ä»¥è¡¨ç¤ºè¯¥é¡µé¢çš„è®¿é—®é¢‘åº¦ã€‚æ“ä½œç³»ç»Ÿå†…æ ¸è¿›è¡Œé¡µé¢å›æ”¶æ˜¯å°±æ ¹æ®é¡µé¢çš„è®¡æ•°å™¨å€¼æ¥ç¡®å®šè¦å›æ”¶é‚£äº›é¡µé¢ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_fb3a92ba2026e5edfd060ce3133ffa46.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_fb3a92ba2026e5edfd060ce3133ffa46.jpg"/></a></p>
<p>Linuxå†…æ ¸å¯¹äºLRUçš„å®ç°ä¸»è¦æ˜¯åŸºäºä¸€å¯¹åŒå‘é“¾è¡¨ï¼šactiveå’Œinactiveä¸¤ç±»é“¾è¡¨ã€‚ç»å¸¸è¢«è®¿é—®å¤„äºæ´»è·ƒçŠ¶æ€çš„é¡µé¢ä¼šè¢«æ”¾åœ¨activeé“¾è¡¨ä¸Šï¼Œä¸å¸¸ä½¿ç”¨çš„é¡µé¢è¢«æ”¾åˆ°inactiveé“¾è¡¨ä¸Šã€‚ç³»ç»Ÿåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œé¡µé¢ä¼šåœ¨activeé“¾è¡¨å’Œinactiveé“¾è¡¨ä¹‹é—´è½¬ç§»ï¼Œåœ¨activeé“¾è¡¨ä¸­ä½¿ç”¨é¢‘ç‡æœ€ä½çš„å°†ä¼šç§»åˆ°é“¾è¡¨å°¾éƒ¨ï¼Œå†è½¬ç§»åˆ°ä¸æ´»è·ƒé“¾è¡¨ä¸­ï¼Œæœ€åæ¢å‡ºé¡µé¢ã€‚ ç¬¬äºŒæ¬¡æœºä¼šæ³•æ˜¯åœ¨ç»å…¸LRUé“¾è¡¨ç®—æ³•åŸºç¡€ä¸Šåšäº†ä¸€äº›æ”¹è¿›ï¼Œåœ¨ç»å…¸LRUé“¾è¡¨ç®—æ³•ä¸­ï¼Œæ–°äº§ç”Ÿçš„é¡µé¢è¢«æ·»åŠ åˆ°LRUé“¾è¡¨çš„å¼€å‘ï¼Œå°†LRUé“¾è¡¨ä¸­ç°å­˜çš„é¡µé¢å‘åç§»åŠ¨ä¸€ä¸ªä½ç½®ã€‚å½“ç³»ç»Ÿå†…å­˜å‡ºç°çŸ­ç¼ºæ˜¯ï¼ŒLRUé“¾è¡¨å°¾éƒ¨çš„é¡µé¢å°†ä¼šç¦»å¼€å¹¶ç»å†æ¢å‡ºã€‚å½“ç³»ç»Ÿå†éœ€è¦è¿™äº›é¡µé¢æ˜¯ï¼Œè¿™äº›é¡µé¢ä¼šé‡æ–°ç½®äºLRUé“¾è¡¨çš„å¼€å¤´ï¼Œè¿™æ ·çš„è®¾è®¡åªè€ƒè™‘çš„æ—¶é—´çš„å…ˆåé¡ºåºè€Œæ²¡æœ‰è€ƒè™‘åˆ°é¡µé¢æ˜¯å¦é¢‘ç¹ä½¿ç”¨ï¼Œè€Œç¬¬äºŒæ¬¡æœºä¼šæ³•çš„æ”¹è¿›å°±æ˜¯é¿å…ç»å¸¸ä½¿ç”¨çš„é¡µé¢ä¸ä¼šè¢«ç½®æ¢å‡ºå»ï¼Œç¬¬äºŒæ¬¡æœºä¼šæ³•ç»™é¡µé¢è®¾ç½®ä¸€ä¸ªè®¿é—®çŠ¶æ€ä½ï¼Œåœ¨è¿›è¡Œæ·˜æ±°é€‰æ‹©æ˜¯ï¼Œä¼šå…ˆåˆ¤æ–­è¯¥çŠ¶æ€æ˜¯ä½ä¸º1ï¼Œå¦‚æœæ˜¯åˆ™ç»™ä»–ç¬¬äºŒæ¬¡æœºä¼šï¼Œå¹¶æ¸…ç©ºè¯¥ä½ï¼Œé€‰æ‹©å…¶ä»–é¡µé¢åˆ¤æ–­æ¢å‡ºã€‚</p>
<h3 id="lru_1">LRUé“¾è¡¨</h3>
<p>å†…æ ¸ä¸­ä¸€å…±æœ‰5æ¡LRUé“¾è¡¨ï¼Œå¦‚ä¸‹ï¼š - LRU_INACTIVE_ANON:ä¸æ´»è·ƒåŒ¿åé¡µé¢é“¾è¡¨ - LRU_ACTIVE_ANON:æ´»è·ƒåŒ¿åé¡µé¢é“¾è¡¨ - LRU_INACTIVE_FILE:ä¸æ´»è·ƒæ–‡ä»¶æ˜ å°„é¡µé¢é“¾è¡¨ - LRU_ACTIVE_FILE:æ´»è·ƒæ–‡ä»¶æ˜ å°„é¡µé¢é“¾è¡¨ - LRU_UNEVICTABLE:ä¸å¯å›æ”¶é¡µé¢é“¾è¡¨ Linuxå†…æ ¸åˆ†æˆ5æ¡é“¾è¡¨ï¼Œä¸»è¦æ˜¯å½“å†…å­˜å‡ºç°ç´§ç¼ºæ—¶ä¼˜å…ˆæ¢å‡ºæ–‡ä»¶æ˜ å°„çš„æ–‡ä»¶æ¢å‡ºé¡µé¢ï¼Œå› ä¸ºæ–‡ä»¶é¡µå¯èƒ½ä¸éœ€è¦é‡æ–°åˆ·å›ç£ç›˜è€Œç›´æ¥è¿›è¡Œå›æ”¶ï¼Œè€ŒåŒ¿åé¡µæ˜¯å¿…é¡»è¦å†™å…¥äº¤æ¢åŒºæ‰èƒ½å›æ”¶ã€‚Linuxæ¯ä¸ªå†…å­˜èŠ‚ç‚¹éƒ½ç»´æŠ¤ä¸€æ•´å¥—LRUé“¾è¡¨ï¼Œå­˜å‚¨åœ¨pglist_dataä¸­ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pglist_data</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">.....</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">lruvec</span><span class="w">       </span><span class="n">__lruvec</span><span class="p">;</span>
<span class="p">......</span>
<span class="p">};</span>

<span class="mi">5</span><span class="n">ç§ä¸åŒç±»å‹çš„LRUé“¾è¡¨</span>
<span class="k">enum</span><span class="w"> </span><span class="n">lru_list</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LRU_INACTIVE_ANON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LRU_BASE</span><span class="p">,</span>
<span class="w">    </span><span class="n">LRU_ACTIVE_ANON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LRU_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LRU_ACTIVE</span><span class="p">,</span>
<span class="w">    </span><span class="n">LRU_INACTIVE_FILE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LRU_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LRU_FILE</span><span class="p">,</span>
<span class="w">    </span><span class="n">LRU_ACTIVE_FILE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LRU_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LRU_FILE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LRU_ACTIVE</span><span class="p">,</span>
<span class="w">    </span><span class="n">LRU_UNEVICTABLE</span><span class="p">,</span>
<span class="w">    </span><span class="n">NR_LRU_LISTS</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">lruvec</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">        </span><span class="n">lists</span><span class="p">[</span><span class="n">NR_LRU_LISTS</span><span class="p">];</span>
<span class="w">    </span><span class="cm">/* per lruvec lru_lock for memcg */</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w">          </span><span class="n">lru_lock</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * These track the cost of reclaiming one LRU - file or anon -</span>
<span class="cm">     * over the other. As the observed cost of reclaiming one LRU</span>
<span class="cm">     * increases, the reclaim scan balance tips toward the other.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">anon_cost</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">file_cost</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* Non-resident age, driven by LRU movement */</span>
<span class="w">    </span><span class="n">atomic_long_t</span><span class="w">           </span><span class="n">nonresident_age</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* Refaults at the time of last reclaim cycle */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">refaults</span><span class="p">[</span><span class="n">ANON_AND_FILE</span><span class="p">];</span>
<span class="w">    </span><span class="cm">/* Various lruvec state flags (enum lruvec_flags) */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">flags</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_LRU_GEN</span>
<span class="w">    </span><span class="cm">/* evictable pages divided into generations */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lru_gen_struct</span><span class="w">       </span><span class="n">lrugen</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* to concurrently iterate lru_gen_mm_list */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lru_gen_mm_state</span><span class="w">     </span><span class="n">mm_state</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MEMCG</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pglist_data</span><span class="w"> </span><span class="o">*</span><span class="n">pgdat</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">ANDROID_VENDOR_DATA</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_f46f5f84032ec6a1ea66c55ff726a051.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_f46f5f84032ec6a1ea66c55ff726a051.jpg"/></a></p>
<p>å†…å­˜èŠ‚ç‚¹çš„æè¿°æ•°æ®ç»“æ„ç§æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡lruvecæŒ‡å‘è¿™äº›é“¾è¡¨ï¼Œæšä¸¾ç±»å‹å˜é‡lru_liståˆ—ä¸¾å‡ºä¸Šè¿°å„ç§LRUé“¾è¡¨ç±»å‹ï¼Œlruvecæ•°æ®ç»“æ„ä¸­å®šä¹‰äº†ä¸Šè¿°å„ç§LRUç±»å‹é“¾è¡¨ã€‚ linuxå†…æ ¸ä½¿ç”¨æœ‰ä¸¤ä¸ªæ ‡å¿—ä½æ¥ç”¨äºLRUæœºåˆ¶çš„åˆ¤æ–­ï¼Œåˆ†åˆ«æ˜¯PG_activeå’ŒPG_referencedï¼Œ - PG_activeï¼šæ ‡å¿—ä½æŒ‡ç¤ºäº†è¯¥é¡µå—åº”è¯¥åœ¨é‚£ä¸ªLRUé“¾è¡¨ï¼Œä¸º1åœ¨activeé“¾è¡¨ï¼Œ0åœ¨inactiveé“¾è¡¨ã€‚ - PG_referencedï¼šæŒ‡ç¤ºé¡µæ¡†æ˜¯å¦è¢«ä½¿ç”¨ï¼Œå½“é¡µæ¡†è¢«è®¿é—®æ˜¯ï¼Œä¼šç½®ä¸º1ã€‚ Linuxä¸­å®ç°LRUé“¾è¡¨ä¹‹é—´çš„ç§»åŠ¨é¡µé¢ä½¿ç”¨å¦‚ä¸‹å…³é”®å‡½æ•°ï¼š - mark_page_accessed()ï¼šè®¿é—®ä¸€ä¸ªé¡µé¢æ—¶ï¼Œè°ƒç”¨è¯¥å‡½æ•°ä¿®æ”¹PG_activeå’ŒPG_refenrenced - page_refenrenced():ç³»ç»Ÿåœ¨è¿›è¡Œæ‰«æé¡µé¢æ—¶ï¼Œè°ƒç”¨è¯¥å‡½æ•°åˆ¤æ–­PG_referencedä½ï¼Œå¦‚æœè¯¥ä½è¢«ç½®ä½ä½†æ˜¯é•¿æ—¶é—´æ²¡æœ‰è¢«å†æ¬¡è®¿é—®ï¼Œè¯¥ä½å°±ä¼šè¢«æ¸…é™¤ã€‚ - active_page():å°†é¡µé¢æ”¾åˆ°activeé“¾è¡¨ä¸Šå»ã€‚ shrink_active_list():å°†é¡µé¢ç§»åŠ¨åˆ°inactiveé“¾è¡¨ä¸Šå»ã€‚</p>
<h3 id="lru_2">LRUç¼“å­˜</h3>
<p>ç³»ç»Ÿå†…æ ¸æ ¹æ®å…¶æ´»è·ƒç¨‹åº¦å°†é¡µé¢æ¥activeå’Œinactiveé“¾è¡¨ä¹‹é—´æ¥å›ç§»åŠ¨ï¼Œéšç€å½“å‰çš„ç¡¬ä»¶ç³»ç»Ÿå¤§å¤šéƒ½æ˜¯å¤šcpuå¤„ç†å™¨ï¼Œæ‰€ä»¥éœ€è¦ä¿è¯å¤šæ ¸ä¹‹é—´çš„å¹¶å‘è®¿é—®ï¼Œå› æ­¤éœ€è¦é€šè¿‡è‡ªæ—‹é”æ¥é˜²æ­¢å¹¶å‘æ“ä½œã€‚ç”±äºè‡ªæ—‹é”ä¼šå¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹é™ï¼Œä¸ºäº†å‡å°‘å…¶å½±å“ï¼Œäºæ˜¯å†…æ ¸å¼•å…¥äº†LRUç¼“å­˜ï¼Œæ¯æ¬¡å¤„ç†é¡µé¢ç§»åŠ¨æ—¶ï¼Œè¿›è¡Œæ‰¹é‡å¤„ç†ï¼Œå½“ç´¯è®¡åˆ°ä¸€å®šæ•°é‡åæ‰ä¼šç»Ÿä¸€è¿ç§»ï¼Œè¿™æ ·å°±èƒ½é™ä½é”çš„ç«äº‰ï¼Œæå‡ç³»ç»Ÿçš„æ€§èƒ½ã€‚LRUç¼“å­˜ä½¿ç”¨çš„æ—¶struct pagevecç»“æ„ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">pagevec</span><span class="p">.</span><span class="n">h</span>
<span class="cp">#define PAGEVEC_SIZE    15</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">pagevec</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">nr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">percpu_pvec_drained</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">pages</span><span class="p">[</span><span class="n">PAGEVEC_SIZE</span><span class="p">];</span><span class="w"> </span><span class="c1">//å­˜æ”¾14ä¸ªpage</span>
<span class="p">};</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_732223ceca45e9e72a4152ad8b88919b.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_732223ceca45e9e72a4152ad8b88919b.jpg"/></a></p>
<p>é¡µé¢æ‰¹é‡æœ€ç»ˆé€šè¿‡list_addå‡½æ•°æ·»åŠ åˆ°LRUé“¾è¡¨ä¸­ï¼Œlist_addä¼šå°†æˆå‘˜æ·»åŠ åˆ°é“¾è¡¨å¤´ã€‚</p>
<h3 id="_27">é¡µé¢å›æ”¶æ—¶æœº</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_5050b347715550ca7bb94d408a7029d2.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/ä¼™ä¼´ç³»ç»Ÿç›¸å…³ç»“æ„ä½“/images/wp_editor_md_5050b347715550ca7bb94d408a7029d2.jpg"/></a></p>
<p>ç³»ç»Ÿä¸­é€šå¸¸ä»¥ä¸‹3ç§æœºåˆ¶ä¼šè§¦å‘è¿›è¡Œé¡µé¢å›æ”¶ï¼ˆå®é™…ä¸Šä¸æ°´ä½æœ‰å…³ç³»ï¼Œè§2.4.2.4ï¼‰ä¸‰ç§æ–¹å¼è§¦å‘é¡µé¢å›æ”¶ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨shrink_nodeï¼š - å¿«é€Ÿå›æ”¶ï¼šå¿«é€Ÿè·¯å¾„åšå†…å­˜åˆ†é…æ—¶å¤±è´¥ï¼Œè°ƒç”¨node_reclaimè¿›è¡Œé¡µé¢å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™ä¸å›æ”¶è„æ–‡ä»¶é¡µï¼ŒåŠ é€Ÿå†…å­˜åˆ†é…é€Ÿåº¦ï¼Œé¿å…å›å†™ç£ç›˜è€—æ—¶çš„IOæ“ä½œã€‚ - å¼‚æ­¥å›æ”¶ï¼ˆKswapdå†…æ ¸çº¿ç¨‹ï¼‰ï¼šæ…¢é€Ÿè·¯å¾„å†…å­˜åˆ†é…æ—¶ï¼Œä¼šå”¤é†’å†…æ ¸çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹å°±ä¼šåœ¨åå°è¿›è¡Œé¡µé¢å›æ”¶å¤„ç†ã€‚ ç›´æ¥å›æ”¶ï¼šæ…¢é€Ÿè·¯å¾„å†…å­˜åˆ†é…æ—¶ï¼Œç»è¿‡å¤šè½®å°è¯•ä¾æ—§æ— æ³•åˆ†é…å†…å­˜ï¼ˆæ°´ä½ä½äºminåŒºï¼‰ï¼Œå°±ä¼šè§¦å‘è¿›è¡Œç›´æ¥å›æ”¶ã€‚ï¼ˆåŒæ­¥ï¼‰</p>
<h3 id="_28">å›æ”¶ç­–ç•¥</h3>
<p>å†…å­˜çš„å›æ”¶å¹¶ä¸æ˜¯å›æ”¶çš„è¶Šå¤šè¶Šå¥½ï¼Œç³»ç»Ÿä¸­å¾ˆå¤šéƒ½ä¼šç”¨åˆ°ç‰©ç†å†…å­˜ï¼Œç³»ç»Ÿå°½å¯èƒ½çš„ç”¨ç©ºé—´æ¢æ—¶é—´æœ€å¤§åŒ–æé«˜è¿è¡Œé€Ÿç‡ï¼Œæ¯”å¦‚å¯¹ç£ç›˜IOçš„è¯»å†™ä½¿ç”¨ç‰©ç†å†…å­˜ç¼“å­˜ã€‚å„ä¸ªé¡µé¢çš„å›æ”¶æ•ˆç‡æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯”å¦‚å›æ”¶å¹²å‡€çš„æ–‡ä»¶é¡µæ•ˆç‡æ˜¯æœ€é«˜çš„ï¼ŒåŒ¿åé¡µå’Œè„æ–‡ä»¶å¤¹éƒ½éœ€è¦åˆ·å†™æ•°æ®åˆ°ç£ç›˜ã€‚ç»¼ä¸Šï¼Œç³»ç»Ÿéœ€è¦ç¡®å®šä¸€ä¸‹å›æ”¶çš„ç­–ç•¥ã€‚å¦‚è¦å›æ”¶å¤šå°‘é¡µé¢åˆé€‚ï¼Ÿå›æ”¶åŒ¿åé¡µé¢è¿˜æ˜¯æ–‡ä»¶é¡µé¢ç­‰ç­‰ã€‚</p>
<h4 id="struct-scan_control">struct scan_control</h4>
<p>è¯¥ç»“æ„ä½“æè¿°äº†ä¸é¡µé¢ç›¸å…³çš„ä¿¡æ¯struct scan_controlã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">scan_control</span><span class="w"> </span><span class="p">{</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_to_reclaim</span><span class="p">;</span><span class="w">  </span><span class="n">éœ€è¦å›æ”¶çš„é¡µé¢æ•°é‡</span>
<span class="n">nodemask_t</span><span class="w">  </span><span class="o">*</span><span class="n">nodemask</span><span class="p">;</span><span class="w"> </span><span class="n">å†…å­˜èŠ‚ç‚¹æ©ç </span><span class="err">ï¼ˆ</span><span class="n">ç¡®å®šå›æ”¶çš„èŠ‚ç‚¹</span><span class="err">ï¼‰ï¼Œ</span><span class="n">å¦‚æœä¸ºNULL</span><span class="err">ï¼Œ</span><span class="n">åˆ™æ˜¯æ‰€æœ‰èŠ‚ç‚¹</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">mem_cgroup</span><span class="w"> </span><span class="o">*</span><span class="n">target_mem_cgroup</span><span class="p">;</span><span class="n">ç›®æ ‡memcg</span><span class="err">ï¼Œ</span><span class="n">å¦‚æœé’ˆå¯¹æ•´ä¸ªzoneè¿›è¡Œ</span><span class="err">ï¼Œ</span><span class="n">åˆ™ä¸ºNULL</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">may_writepage</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="n">å…è®¸æ–‡ä»¶è„é¡µå†™å›ç£ç›˜çš„æ–¹å¼å›æ”¶</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">may_unmap</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="n">å…è®¸å–æ¶ˆé¡µé¢æ˜ å°„çš„æ–¹å¼å›æ”¶</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">may_swap</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="n">å…è®¸ä½¿ç”¨åŒ¿åé¡µäº¤æ¢swapåˆ†åŒºæ–¹å¼å›æ”¶</span>
<span class="n">s8</span><span class="w"> </span><span class="n">order</span><span class="p">;</span><span class="n">ç”³è¯·åˆ†é…å†…å­˜çš„é˜¶</span>
<span class="n">s8</span><span class="w"> </span><span class="n">priority</span><span class="p">;</span><span class="n">æ‰«æLRUçš„ä¼˜å…ˆçº§</span><span class="err">ï¼Œ</span><span class="n">ç”¨äºè®¡ç®—æ¯æ¬¡æ‰«æé¡µé¢çš„æ•°é‡</span>
<span class="n">s8</span><span class="w"> </span><span class="n">reclaim_idx</span><span class="p">;</span>
<span class="n">gfp_t</span><span class="w"> </span><span class="n">gfp_mask</span><span class="p">;</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_scanned</span><span class="p">;</span><span class="n">ç»Ÿè®¡æ‰«æè¿‡çš„éæ´»åŠ¨é¡µé¢æ€»æ•°</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_reclaimed</span><span class="p">;</span><span class="n">ç»Ÿè®¡å›æ”¶äº†é¡µé¢çš„æ€»æ•°</span>
<span class="p">};</span>
</code></pre></div>
<h4 id="scan_balance">scan_balance</h4>
<p>å›æ”¶çš„é¡µè¦ä¹ˆæ˜¯æ–‡ä»¶é¡µè¦ä¹ˆæ˜¯åŒ¿åé¡µï¼Œç³»ç»Ÿä¸­å¯¹äºé¡µé¢å›æ”¶çš„ç±»å‹æœ‰å››ç§åŸºæœ¬ç­–ç•¥ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">enum</span><span class="w"> </span><span class="n">scan_balance</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SCAN_EQUAL</span><span class="p">,</span><span class="w"> </span><span class="n">è®¡ç®—å‡ºæ‰«æå€¼åŸæ ·ä½¿ç”¨</span>
<span class="w">    </span><span class="n">SCAN_FRACT</span><span class="p">,</span><span class="w"> </span><span class="n">æŒ‰åˆ†æ•°çš„åº”ç”¨è®¡ç®—æ‰«æå€¼</span>
<span class="w">    </span><span class="n">SCAN_ANON</span><span class="p">,</span><span class="w"> </span><span class="n">åªå›æ”¶åŒ¿åé¡µ</span>
<span class="w">    </span><span class="n">SCAN_FILE</span><span class="p">,</span><span class="w">   </span><span class="n">åªå›æ”¶æ–‡ä»¶é¡µ</span>
<span class="p">};</span>
</code></pre></div>
<p>scan_controlåªæ˜¯ä¸€ä¸ªéœ€æ±‚ï¼ŒçœŸæ­£è¦æ€ä¹ˆå›æ”¶è¿˜è¦ç»¼åˆè€ƒè™‘ï¼Œæ ¹æ®get_scan_countæ¥æŠŠæ§ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * Determine how aggressively the anon and file LRU lists should be</span>
<span class="cm"> * scanned.  The relative value of each set of LRU lists is determined</span>
<span class="cm"> * by looking at the fraction of the pages scanned we did rotate back</span>
<span class="cm"> * onto the active list instead of evict.</span>
<span class="cm"> *</span>
<span class="cm"> * nr[0] = anon inactive pages to scan; nr[1] = anon active pages to scan</span>
<span class="cm"> * nr[2] = file inactive pages to scan; nr[3] = file active pages to scan</span>
<span class="cm"> */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">get_scan_count</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">lruvec</span><span class="w"> </span><span class="o">*</span><span class="n">lruvec</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">scan_control</span><span class="w"> </span><span class="o">*</span><span class="n">sc</span><span class="p">,</span>
<span class="w">               </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">nr</span><span class="p">)</span>
</code></pre></div>
<p>åœ¨ç¡®å®šæ¯ä¸ªLRUé“¾è¡¨çš„æ‰«æåŠ›åº¦ä¹‹å‰ï¼Œget_scan_countæ ¹æ®scan_controlå‚æ•°ä»¥åŠå…¶ä»–å‚æ•°ç»¼åˆåˆ¤æ–­å†³å®šæ‰«æçš„ç­–ç•¥ï¼Œä»ä¸Šå¯çŸ¥unsigned long *nræ•°ç»„åˆ†åˆ«è¡¨ç¤ºæ¯ä¸ªLRUé“¾è¡¨çš„æ‰«æåŠ›åº¦ï¼Œget_scan_countå°±æ˜¯ç”¨äºå¡«å……nrçš„æ•°ç»„ã€‚é‚£å…¶ç­–ç•¥è¿˜ä¼šå—ä»€ä¹ˆå½±å“äº†ï¼Ÿä¼šå—swappinesså½±å“ã€‚ swappiness:å†³å®šç€åŒ¿åé¡µäº¤æ¢åˆ°swapåˆ†åŒºçš„é¢‘ç‡ï¼Œå€¼çš„èŒƒå›´0~100ï¼ˆé»˜è®¤å€¼ä¸€èˆ¬60ï¼‰ã€‚å€¼è¶Šé«˜ï¼Œåˆ™åŒ¿åé¡µäº¤æ¢åˆ°swapåˆ†åŒºçš„æ¦‚ç‡å°±è¶Šé«˜ã€‚ å½“å€¼ä¸º0æ—¶ï¼Œé‚£å°±è¡¨ç¤ºä¸æ‰«æå›æ”¶åŒ¿åé¡µï¼Œåªå›æ”¶æ–‡ä»¶é¡µï¼ˆå½“ç„¶ä¸ç»å¯¹ï¼Œå½“ç³»ç»Ÿç¡®å®å·²ç»åˆ†é…ä¸åˆ°å†…å­˜äº†ï¼Œå°±ä¸ä¼šå†ç®¡swappinesså€¼ï¼‰ã€‚å½“å€¼ä¸º100æ—¶ï¼ŒåŒ¿åé¡µçš„å›æ”¶ä¼˜å…ˆçº§å°±ç­‰äºæ–‡ä»¶é¡µçš„ä¼˜å…ˆçº§çš„ã€‚ ç³»ç»Ÿé»˜è®¤è®¾ç½®çš„å€¼ä¸º60ï¼Œæ‰€ä»¥ç³»ç»Ÿæ›´å€¾å‘ä¸å›æ”¶æ–‡ä»¶é¡µã€‚å‰é¢è¯´äº†å›æ”¶æ–‡ä»¶é¡µçš„ä»£ä»·æ›´æ›´ä½ï¼Œå› ä¸ºæ–‡ä»¶é¡µå¤§éƒ¨åˆ†é¡µéƒ½æ˜¯å¹²å‡€é¡µï¼Œå¯ç›´æ¥é‡Šæ”¾å†…å­˜ï¼Œä¸éœ€è¦åˆ·å›åˆ°ç£ç›˜ã€‚ å¯ä»¥é€šè¿‡èŠ‚ç‚¹/proc/sys/vm/swappinessè·å–æˆ–è°ƒèŠ‚swappinesså€¼ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">root</span><span class="err">@</span><span class="n">TinaLinux</span><span class="o">:/</span><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">swappiness</span><span class="w"> </span>
<span class="mi">60</span>
</code></pre></div>
<h3 id="_29">å¿«é€Ÿé¡µé¢å›æ”¶</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">__node_reclaim</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pglist_data</span><span class="w"> </span><span class="o">*</span><span class="n">pgdat</span><span class="p">,</span><span class="w"> </span><span class="n">gfp_t</span><span class="w"> </span><span class="n">gfp_mask</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* Minimum pages needed in order to stay on node */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">order</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">noreclaim_flag</span><span class="p">;</span>
<span class="err">ï¼ˆ</span><span class="mi">1</span><span class="err">ï¼‰</span><span class="n">è®¾ç½®å›æ”¶ç­–ç•¥</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">scan_control</span><span class="w"> </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">nr_to_reclaim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">nr_pages</span><span class="p">,</span><span class="w"> </span><span class="n">SWAP_CLUSTER_MAX</span><span class="p">),</span><span class="n">å›æ”¶é¡µé¢æ•°é‡</span><span class="err">ï¼Œ</span><span class="n">ä¸€èˆ¬æ˜¯32</span><span class="err">ã€‚</span>
<span class="w">        </span><span class="p">.</span><span class="n">gfp_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_gfp_context</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">order</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NODE_RECLAIM_PRIORITY</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">may_writepage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="n">node_reclaim_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">RECLAIM_WRITE</span><span class="p">),</span>
<span class="n">å¦‚æœæ²¡æœ‰ä½¿ç”¨NUMAæ¶æ„</span><span class="err">ï¼Œ</span><span class="n">node_reclaim_mode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">æ‰€ä»¥ä¸å…è®¸ä½¿ç”¨å†™å›ç£ç›˜æ–¹å¼å›æ”¶é¡µé¢</span><span class="err">ã€‚</span>
<span class="w">        </span><span class="p">.</span><span class="n">may_unmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="n">node_reclaim_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">RECLAIM_UNMAP</span><span class="p">),</span>
<span class="n">ä¸å…è®¸ä½¿ç”¨å–æ¶ˆæ¸…é™¤é¡µè¡¨çš„æ–¹å¼å›æ”¶é¡µé¢</span><span class="err">ã€‚</span>
<span class="w">        </span><span class="p">.</span><span class="n">may_swap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">reclaim_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gfp_zone</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">),</span>
<span class="n">æŒ‡å®šzoneè¿›è¡Œé¡µé¢å›æ”¶</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pflags</span><span class="p">;</span>

<span class="w">    </span><span class="n">trace_mm_vmscan_node_reclaim_begin</span><span class="p">(</span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">node_id</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">,</span>
<span class="w">                       </span><span class="n">sc</span><span class="p">.</span><span class="n">gfp_mask</span><span class="p">);</span>

<span class="w">    </span><span class="n">cond_resched</span><span class="p">();</span>
<span class="w">    </span><span class="n">psi_memstall_enter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pflags</span><span class="p">);</span>
<span class="w">    </span><span class="n">fs_reclaim_acquire</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">gfp_mask</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * We need to be able to allocate from the reserves for RECLAIM_UNMAP</span>
<span class="cm">     * and we also need to be able to write out pages for RECLAIM_WRITE</span>
<span class="cm">     * and RECLAIM_UNMAP.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">noreclaim_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memalloc_noreclaim_save</span><span class="p">();</span>
<span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PF_SWAPWRITE</span><span class="p">;</span>
<span class="w">    </span><span class="n">set_task_reclaim_state</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sc</span><span class="p">.</span><span class="n">reclaim_state</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node_pagecache_reclaimable</span><span class="p">(</span><span class="n">pgdat</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">min_unmapped_pages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Free memory by calling shrink node with increasing</span>
<span class="cm">         * priorities until we have enough memory freed.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">shrink_node</span><span class="p">(</span><span class="n">pgdat</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sc</span><span class="p">);</span>
<span class="err">ï¼ˆ</span><span class="mi">2</span><span class="err">ï¼‰</span><span class="n">é€šè¿‡scæ§åˆ¶è¯¥èŠ‚ç‚¹è¿›è¡Œå†…å­˜å›æ”¶</span><span class="err">ã€‚</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">nr_reclaimed</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr_pages</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">--</span><span class="n">sc</span><span class="p">.</span><span class="n">priority</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="err">ï¼ˆ</span><span class="mi">3</span><span class="err">ï¼‰</span><span class="n">å›æ”¶çš„é¡µæ¡†æ•°å¤§äºæœ¬æ¬¡åˆ†é…ä»»åŠ¡çš„é¡µæ¡†æ•°æˆ–è€…sc</span><span class="p">.</span><span class="n">priorityä¼˜å…ˆçº§é™ä¸º0å³å®Œæˆé¡µé¢å›æ”¶</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">set_task_reclaim_state</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">PF_SWAPWRITE</span><span class="p">;</span>
<span class="w">    </span><span class="n">memalloc_noreclaim_restore</span><span class="p">(</span><span class="n">noreclaim_flag</span><span class="p">);</span>
<span class="w">    </span><span class="n">fs_reclaim_release</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">gfp_mask</span><span class="p">);</span>
<span class="w">    </span><span class="n">psi_memstall_leave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pflags</span><span class="p">);</span>

<span class="w">    </span><span class="n">trace_mm_vmscan_node_reclaim_end</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">nr_reclaimed</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sc</span><span class="p">.</span><span class="n">nr_reclaimed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nr_pages</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>å¿«é€Ÿå†…å­˜å›æ”¶éœ€è¦æ ¹æ®node_reclaim_modeæ¥å†³å®šunmapã€writebackæ“ä½œï¼Œarm64æ¶æ„ä¸Šé€šå¸¸æ˜¯å•èŠ‚ç‚¹æ‰€ä»¥è¯¥å€¼ä¸º0ï¼Œå› æ­¤ä¸èƒ½unmapå°±ç›¸å½“äºä¸èƒ½é‡Šæ”¾é¡µè¡¨ï¼Œä¸èƒ½writebackç›¸å½“äºä¸èƒ½é‡Šæ”¾è„é¡µå’ŒåŒ¿åé¡µï¼Œé‚£å®é™…ä¸Šå°±åªèƒ½å›æ”¶å¹²å‡€çš„æ–‡ä»¶é¡µäº†ï¼ŒåŒæ—¶å¿«é€Ÿå†…å­˜å›æ”¶æŒ‡å®šäº†zoneåŒºè¿›è¡Œå›æ”¶ã€‚</p>
<h3 id="kswpad">kswpadå›æ”¶</h3>
<p>å¾…è¡¥å……</p>
<h3 id="_30">ç›´æ¥é¡µé¢å›æ”¶</h3>
<p>å¾…è¡¥å……</p>
<h3 id="shrink_node">shrink_node</h3>
<p>å¾…è¡¥å……</p></div>
  <div class="post-nav">
    <a class="prev" href="slubåˆ†é…å™¨.html">â† slubåˆ†é…å™¨</a>
    <a class="next" href="å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–.html">å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ– â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

