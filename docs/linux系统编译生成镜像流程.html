<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Linux系统编译生成镜像流程 - Laumy的技术栈</title>
    <link rel="stylesheet" href="../../assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="../../">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="../../">首页</a></div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#_1">编译内核</a><ul><li><a href="#_2">清除内核</a></li><li><a href="#defconfig">配置defconfig</a></li><li><a href="#_3">编译</a></li><li><a href="#modules">安装modules</a></li><li><a href="#_4">额外编译</a></li></ul></li><li><a href="#_5">设备树</a><ul></ul></li><li><a href="#dtbimg">将内核与dtb打包生成img</a><ul></ul></li><li><a href="#_6">根文件系统</a><ul></ul></li><li><a href="#uboot">编译uboot</a><ul></ul></li><li><a href="#_7">打包整个镜像</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>Linux系统编译生成镜像流程</h1>
  <div class="meta">2024-11-15 · 调试</div>
  <div class="post-content"><h2 id="_1">编译内核</h2>
<h3 id="_2">清除内核</h3>
<p>命令</p>
<div class="codehilite"><pre><span></span><code><span class="n">$</span><span class="p">{</span><span class="n">MAKE</span><span class="p">}</span><span class="w"> </span><span class="n">O</span><span class="o">=</span><span class="w"> </span><span class="n">mrproper</span>
</code></pre></div>
<p>示例</p>
<div class="codehilite"><pre><span></span><code><span class="n">make</span><span class="w"> </span><span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">riscv32</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="w"> </span><span class="n">ARCH</span><span class="o">=</span><span class="n">riscv</span><span class="w"> </span><span class="o">-</span><span class="n">j16</span><span class="w"> </span>
<span class="n">O</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">build</span><span class="w"> </span><span class="n">KERNEL_SRC</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">linux</span><span class="mf">-5.4</span>
<span class="n">INSTALL_MOD_PATH</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">staging</span><span class="w"> </span><span class="n">O</span><span class="o">=</span><span class="w"> </span><span class="n">mrproper</span>
</code></pre></div>
<h3 id="defconfig">配置defconfig</h3>
<p>命令</p>
<div class="codehilite"><pre><span></span><code><span class="n">defconfig</span><span class="err">：</span><span class="n">$</span><span class="p">{</span><span class="n">MAKE</span><span class="p">}</span><span class="w"> </span><span class="n">defconfig</span><span class="w"> </span><span class="n">KBUILD_DEFCONFIG</span><span class="o">=</span><span class="n">$</span><span class="p">{</span><span class="n">LICHEE_KERN_DEFCONF_RELATIVE</span><span class="p">}</span>
</code></pre></div>
<p>示例</p>
<div class="codehilite"><pre><span></span><code><span class="n">make</span><span class="w"> </span><span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">nds32le</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">glibc</span><span class="o">-</span><span class="n">v5d</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">riscv32</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="w"> </span><span class="n">ARCH</span><span class="o">=</span><span class="n">riscv</span><span class="w"> </span><span class="o">-</span><span class="n">j16</span><span class="w"> </span>
<span class="n">O</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">build</span><span class="w"> </span><span class="n">KERNEL_SRC</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">linux</span><span class="mf">-5.4</span>
<span class="n">INSTALL_MOD_PATH</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">staging</span><span class="w"> </span><span class="n">defconfig</span>
<span class="n">KBUILD_DEFCONFIG</span><span class="o">=</span><span class="n">linux</span><span class="mf">-5.4</span><span class="o">/</span><span class="n">xxx_defconfig</span>
</code></pre></div>
<h3 id="_3">编译</h3>
<div class="codehilite"><pre><span></span><code><span class="n">$</span><span class="p">{</span><span class="n">MAKE</span><span class="p">}</span><span class="w"> </span><span class="n">$MAKE_ARGS</span>
</code></pre></div>
<p>示例</p>
<div class="codehilite"><pre><span></span><code><span class="n">MAKE_ARGS</span><span class="o">+=</span><span class="err">'</span><span class="w"> </span><span class="n">INSTALL_HDR_PATH</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">user_headers</span><span class="w"> </span><span class="n">headers_install</span><span class="err">'</span>
<span class="n">$COMP_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Image</span><span class="p">.</span><span class="n">bz2</span><span class="o">/</span><span class="n">Image</span><span class="p">.</span><span class="n">lz4</span><span class="w">  </span><span class="n">根据LICHEE_COMPRESS是bzip2</span><span class="p">,</span><span class="n">gzip等</span><span class="err">。</span><span class="n">这里的rv选择的是Image</span><span class="p">.</span><span class="n">gz</span>
<span class="n">MAKE_ARGS</span><span class="o">+</span><span class="n">$COMP_TYPE</span>

<span class="n">make</span><span class="w"> </span><span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">nds32le</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">glibc</span><span class="o">-</span><span class="n">v5d</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">riscv32</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="w"> </span><span class="n">ARCH</span><span class="o">=</span><span class="n">riscv</span><span class="w"> </span><span class="o">-</span><span class="n">j16</span>
<span class="n">O</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">build</span><span class="w"> </span><span class="n">KERNEL_SRC</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">linux</span><span class="mf">-5.4</span>
<span class="n">INSTALL_MOD_PATH</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">staging</span><span class="w"> </span><span class="n">modules</span><span class="w"> </span><span class="n">all</span><span class="w"> </span>
<span class="n">INSTALL_HDR_PATH</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">user_headers</span><span class="w"> </span><span class="n">headers_install</span><span class="w"> </span><span class="n">Image</span><span class="p">.</span><span class="n">gz</span>
</code></pre></div>
<h3 id="modules">安装modules</h3>
<p>命令</p>
<div class="codehilite"><pre><span></span><code><span class="n">$</span><span class="p">{</span><span class="n">MAKE</span><span class="p">}</span><span class="w"> </span><span class="n">modules_install</span>
</code></pre></div>
<p>示例</p>
<div class="codehilite"><pre><span></span><code><span class="n">make</span><span class="w"> </span><span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">nds32le</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">glibc</span><span class="o">-</span><span class="n">v5d</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">riscv32</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="w"> </span><span class="n">ARCH</span><span class="o">=</span><span class="n">riscv</span><span class="w"> </span><span class="o">-</span><span class="n">j16</span><span class="w"> </span>
<span class="w"> </span><span class="n">O</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">build</span><span class="w"> </span><span class="n">KERNEL_SRC</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">linux</span><span class="mf">-5.4</span>
<span class="w"> </span><span class="n">INSTALL_MOD_PATH</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">staging</span><span class="w"> </span><span class="n">modules_install</span>
</code></pre></div>
<h3 id="_4">额外编译</h3>
<p>单独额外编译的模块</p>
<div class="codehilite"><pre><span></span><code><span class="n">make</span><span class="w"> </span><span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">nds32le</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">glibc</span><span class="o">-</span><span class="n">v5d</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">riscv32</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="w"> </span><span class="n">ARCH</span><span class="o">=</span><span class="n">riscv</span><span class="w"> </span><span class="o">-</span><span class="n">j16</span><span class="w"> </span>
<span class="n">O</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">build</span><span class="w"> </span><span class="n">KERNEL_SRC</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">linux</span><span class="mf">-5.4</span>
<span class="n">INSTALL_MOD_PATH</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">staging</span><span class="w"> </span><span class="o">-</span><span class="n">C</span><span class="w"> </span><span class="n">kernel</span><span class="o">/</span><span class="n">linux</span><span class="mf">-5.4</span><span class="o">/</span><span class="n">xxx</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">nand</span><span class="w"> </span>
<span class="n">M</span><span class="o">=</span><span class="n">kernel</span><span class="o">/</span><span class="n">linux</span><span class="mf">-5.4</span><span class="o">/</span><span class="n">xxx</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">nand</span><span class="w"> </span><span class="o">-</span><span class="n">j1</span>
</code></pre></div>
<h2 id="_5">设备树</h2>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="n">cpp</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">Wp</span><span class="p">,</span><span class="o">-</span><span class="n">MD</span><span class="p">,</span><span class="n">$</span><span class="p">{</span><span class="n">dep</span><span class="p">}</span><span class="o">/</span><span class="p">.</span><span class="n">$</span><span class="p">{</span><span class="n">outname</span><span class="p">}.</span><span class="n">d</span><span class="p">.</span><span class="n">pre</span><span class="p">.</span><span class="n">tmp</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">nostdinc</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">I</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">LICHEE_KERN_DIR</span><span class="p">}</span><span class="o">/</span><span class="n">include</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">I</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">LICHEE_KERN_DIR</span><span class="p">}</span><span class="o">/</span><span class="n">bsp</span><span class="o">/</span><span class="n">include</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">I</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">die_dtsi_path</span><span class="p">}</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">I</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">chip_dtsi_path</span><span class="p">}</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">undef</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">D__DTS__</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="n">assembler</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">cpp</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">dep</span><span class="p">}</span><span class="o">/</span><span class="p">.</span><span class="n">$</span><span class="p">{</span><span class="n">outname</span><span class="p">}.</span><span class="n">dts</span><span class="p">.</span><span class="n">tmp</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="n">$</span><span class="p">{</span><span class="n">dtsfile</span><span class="p">}</span>

<span class="w">    </span><span class="n">$DTC</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">dtb</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">outpath</span><span class="p">}</span><span class="o">/</span><span class="n">$</span><span class="p">{</span><span class="n">outname</span><span class="p">}</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">no</span><span class="o">-</span><span class="n">unit_address_vs_reg</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">no</span><span class="o">-</span><span class="n">unit_address_format</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">no</span><span class="o">-</span><span class="n">unique_unit_address</span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">no</span><span class="o">-</span><span class="n">graph_child_address</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">no</span><span class="o">-</span><span class="n">simple_bus_reg</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">b</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="err">@</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">LICHEE_CHIP_CONFIG_DIR</span><span class="p">}</span><span class="o">/</span><span class="n">configs</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">$</span><span class="p">{</span><span class="n">LICHEE_KERN_VER</span><span class="p">}</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">dep</span><span class="p">}</span><span class="o">/</span><span class="p">.</span><span class="n">$</span><span class="p">{</span><span class="n">outname</span><span class="p">}.</span><span class="n">d</span><span class="p">.</span><span class="n">dtc</span><span class="p">.</span><span class="n">tmp</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">dep</span><span class="p">}</span><span class="o">/</span><span class="p">.</span><span class="n">$</span><span class="p">{</span><span class="n">outname</span><span class="p">}.</span><span class="n">dts</span><span class="p">.</span><span class="n">tmp</span>
</code></pre></div>
<p>示例</p>
<div class="codehilite"><pre><span></span><code><span class="n">cpp</span><span class="w"> </span><span class="o">-</span><span class="n">Wp</span><span class="p">,</span><span class="o">-</span><span class="n">MD</span><span class="p">,</span><span class="n">kernel</span><span class="o">/</span><span class="n">staging</span><span class="o">/</span><span class="n">dts_dep</span><span class="o">/</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">dtb</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">pre</span><span class="p">.</span><span class="n">tmp</span><span class="w"> </span><span class="o">-</span><span class="n">nostdinc</span><span class="w"> </span><span class="o">-</span><span class="n">I</span><span class="w"> </span>
<span class="n">kernel</span><span class="o">/</span><span class="n">linux</span><span class="mf">-5.4</span><span class="o">/</span><span class="n">include</span><span class="w"> </span><span class="o">-</span><span class="n">I</span><span class="w"> </span><span class="n">kernel</span><span class="o">/</span><span class="n">linux</span><span class="mf">-5.4</span><span class="o">/</span><span class="n">bsp</span><span class="o">/</span><span class="n">include</span><span class="w"> </span>
<span class="o">-</span><span class="n">I</span><span class="w"> </span><span class="n">bsp</span><span class="o">/</span><span class="n">configs</span><span class="o">/</span><span class="n">linux</span><span class="mf">-5.4</span><span class="w"> </span><span class="o">-</span><span class="n">I</span><span class="w"> </span><span class="n">configs</span><span class="o">/</span><span class="k">default</span>
<span class="w"> </span><span class="o">-</span><span class="n">undef</span><span class="w"> </span><span class="o">-</span><span class="n">D__DTS__</span><span class="w"> </span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="n">assembler</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">cpp</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">kernel</span><span class="o">/</span><span class="n">staging</span><span class="o">/</span><span class="n">dts_dep</span><span class="o">/</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">dtb</span><span class="p">.</span><span class="n">dts</span><span class="p">.</span><span class="n">tmp</span>
<span class="w"> </span><span class="n">configs</span><span class="o">/</span><span class="n">perf2</span><span class="o">/</span><span class="n">board</span><span class="p">.</span><span class="n">dts</span>

<span class="n">scripts</span><span class="o">/</span><span class="n">dtc</span><span class="o">/</span><span class="n">dtc</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">dtb</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">kernel</span><span class="o">/</span><span class="n">staging</span><span class="o">/</span><span class="n">xxx</span><span class="p">.</span><span class="n">dtb</span>
<span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">no</span><span class="o">-</span><span class="n">unit_address_vs_reg</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">no</span><span class="o">-</span><span class="n">unit_address_format</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">no</span><span class="o">-</span><span class="n">unique_unit_address</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">no</span><span class="o">-</span><span class="n">graph_child_address</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">no</span><span class="o">-</span><span class="n">simple_bus_reg</span><span class="w"> </span><span class="o">-</span><span class="n">b</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="err">@</span><span class="w"> </span><span class="o">-</span><span class="n">i</span>
<span class="w"> </span><span class="n">configs</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">linux</span><span class="mf">-5.4</span>
<span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">kernel</span><span class="o">/</span><span class="n">staging</span><span class="o">/</span><span class="n">dts_dep</span><span class="o">/</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">dtb</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">dtc</span><span class="p">.</span><span class="n">tmp</span>
<span class="w"> </span><span class="n">kernel</span><span class="o">/</span><span class="n">staging</span><span class="o">/</span><span class="n">dts_dep</span><span class="o">/</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">dtb</span><span class="p">.</span><span class="n">dts</span><span class="p">.</span><span class="n">tmp</span>
</code></pre></div>
<h2 id="dtbimg">将内核与dtb打包生成img</h2>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="n">$</span><span class="p">{</span><span class="n">MKBOOTIMG</span><span class="p">}</span><span class="w"> </span><span class="o">--</span><span class="n">kernel</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">BIMAGE</span><span class="p">}</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="n">$</span><span class="p">(</span><span class="n">check_whether_use_ramdisk</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="s">"--ramdisk $RAMDISK"</span><span class="p">)</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">--</span><span class="n">board</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">CHIP</span><span class="p">}</span><span class="n">_$</span><span class="p">{</span><span class="n">LICHEE_ARCH</span><span class="p">}</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">--</span><span class="n">base</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">BASE</span><span class="p">}</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">--</span><span class="n">kernel_offset</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">KERNEL_OFFSET</span><span class="p">}</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="n">$</span><span class="p">(</span><span class="n">check_whether_use_ramdisk</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="s">"--ramdisk_offset ${RAMDISK_OFFSET}"</span><span class="p">)</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">--</span><span class="n">dtb</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">DTB</span><span class="p">}</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">--</span><span class="n">dtb_offset</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">DTB_OFFSET</span><span class="p">}</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">--</span><span class="n">header_version</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>\
<span class="w">        </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">$STAGING_DIR</span><span class="o">/</span><span class="n">$</span><span class="p">{</span><span class="n">IMAGE_NAME</span><span class="p">}</span>
</code></pre></div>
<p>示例</p>
<div class="codehilite"><pre><span></span><code><span class="n">tools</span><span class="o">/</span><span class="n">pack</span><span class="o">/</span><span class="n">pctools</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">mkbootimg</span><span class="w"> </span><span class="o">--</span><span class="n">kernel</span><span class="w"> </span><span class="n">kernel</span><span class="o">/</span><span class="n">staging</span><span class="o">/</span><span class="n">Image</span><span class="p">.</span><span class="n">gz</span><span class="w"> </span>
<span class="o">--</span><span class="n">board</span><span class="w"> </span><span class="n">xxx300i_riscv32</span><span class="w"> </span><span class="o">--</span><span class="n">base</span><span class="w"> </span><span class="mh">0x80000000</span><span class="w"> </span><span class="o">--</span><span class="n">kernel_offset</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">--</span><span class="n">dtb</span><span class="w"> </span><span class="n">kernel</span><span class="o">/</span><span class="n">staging</span><span class="o">/</span><span class="n">sunxi</span><span class="p">.</span><span class="n">dtb</span>
<span class="o">--</span><span class="n">dtb_offset</span><span class="w"> </span><span class="mi">10485760</span><span class="w"> </span><span class="o">--</span><span class="n">header_version</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">kernel</span><span class="o">/</span><span class="n">staging</span><span class="o">/</span><span class="n">boot</span><span class="p">.</span><span class="n">img</span>
</code></pre></div>
<h2 id="_6">根文件系统</h2>
<p>制作根文件系统</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">mksquashfs4</span><span class="w"> </span><span class="p">[</span><span class="n">rootfs</span><span class="o">-</span><span class="n">dir</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">img</span><span class="o">-</span><span class="n">name</span><span class="p">]</span><span class="w"> </span>
<span class="w">     </span><span class="o">-</span><span class="n">noappend</span><span class="err">：‌</span><span class="n">不将squashfs选项传递给内核</span>
<span class="w">     </span><span class="o">-</span><span class="n">root</span><span class="o">-</span><span class="n">owned</span><span class="err">：‌</span><span class="n">设置root目录为root所有</span>
<span class="w">     </span><span class="o">-</span><span class="n">comp</span><span class="w"> </span><span class="n">xz</span><span class="err">：‌</span><span class="n">使用xz压缩算法</span>
<span class="w">     </span><span class="o">-</span><span class="n">b</span><span class="w"> </span><span class="mi">256</span><span class="n">k</span><span class="err">：‌</span><span class="n">设置块大小为256KB</span>
<span class="w">     </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="err">'</span><span class="o">/</span><span class="n">dev</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="mi">755</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="err">'</span><span class="w"> </span><span class="n">和</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="err">'</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">console</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="mi">600</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">1</span><span class="err">'：‌</span><span class="n">设置文件系统的权限和所有权</span><span class="err">。‌</span>
<span class="w">     </span><span class="o">-</span><span class="n">processors</span><span class="w"> </span><span class="mi">1</span><span class="err">：‌</span><span class="n">使用一个处理器进行压缩</span><span class="err">。‌</span>
</code></pre></div>
<p>使用dd of生成rootfs.img</p>
<div class="codehilite"><pre><span></span><code><span class="n">dd</span><span class="w"> </span><span class="k">if</span><span class="o">=</span><span class="n">root</span><span class="p">.</span><span class="n">squashfs</span>
<span class="w"> </span><span class="n">of</span><span class="o">=</span><span class="n">openwrt</span><span class="o">/</span><span class="n">rootfs</span><span class="p">.</span><span class="n">img</span><span class="w"> </span><span class="n">bs</span><span class="o">=</span><span class="mi">128</span><span class="n">k</span><span class="w"> </span><span class="n">conv</span><span class="o">=</span><span class="n">sync</span>
</code></pre></div>
<h2 id="uboot">编译uboot</h2>
<p>略</p>
<h2 id="_7">打包整个镜像</h2>
<div class="codehilite"><pre><span></span><code><span class="n">命令</span><span class="err">：</span><span class="w"> </span><span class="n">dragonxx</span><span class="w"> </span><span class="n">imagexx</span><span class="p">.</span><span class="n">cfg</span><span class="w"> </span><span class="n">partitionxx</span><span class="p">.</span><span class="n">fex</span>
</code></pre></div>
<p>使用打包工具dragonxx进行打包，其中image.cfg和partition.fex中的内容为要打包的文件。</p></div>
  <div class="post-nav">
    <a class="prev" href="../../ssl证书更新.html">← SSL证书更新</a>
    <a class="next" href="../../随记.html">随记 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="../../assets/site.js"></script>
  </body>
  </html>

