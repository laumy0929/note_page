<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆä¸€ï¼‰ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">å—è®¾å¤‡é©±åŠ¨ç®€ä»‹</a><ul></ul></li><li><a href="#_2">å…³é”®æ•°æ®ç»“æ„</a><ul><li><a href="#block_device">block_device</a></li><li><a href="#gendisk">gendisk</a></li></ul></li><li><a href="#biorequestrequest_queue">bio,request,request_queue</a><ul><li><a href="#generic-block-layer">Generic Block layer</a></li><li><a href="#io-scheduler-layer">I/O Scheduler Layer</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆä¸€ï¼‰</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-06-03
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">å—è®¾å¤‡é©±åŠ¨ç®€ä»‹</h2>
<p>åœ¨linuxç³»ç»Ÿä¸­ï¼Œæœ‰3å¤§é©±åŠ¨ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ï¼šå­—ç¬¦è®¾å¤‡é©±åŠ¨ã€å—è®¾å¤‡é©±åŠ¨ã€ç½‘ç»œè®¾å¤‡é©±åŠ¨ã€‚å—è®¾å¤‡é©±åŠ¨ä¸æ–‡ä»¶ç³»ç»Ÿæœ‰ç€å¯†ä¸å¯åˆ†çš„å…³ç³»ï¼Œå—è®¾å¤‡æ˜¯æ–‡ä»¶ç³»ç»Ÿå®é™…çš„æ•°æ®ä¼ è¾“å•ä½ï¼Œé€šå¸¸å­˜å‚¨è®¾å¤‡æœ‰eMMCï¼ŒNand/Nor flashï¼Œæœºæ¢°ç¡¬ç›˜ï¼Œå›ºæ€ç¡¬ç›˜ç­‰ï¼Œè¿™é‡Œæ‰€è¯´çš„å—è®¾å¤‡é©±åŠ¨ï¼Œå®é™…å°±æ˜¯è¿™äº›å­˜å‚¨è®¾å¤‡é©±åŠ¨ã€‚å—è®¾å¤‡é©±åŠ¨ä¸å­—ç¬¦è®¾å¤‡é©±åŠ¨æœ‰è¾ƒå¤§å·®å¼‚ï¼Œå—è®¾å¤‡é©±åŠ¨æ˜¯ä»¥å—ä½å•ä½è¿›è¡Œè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡é©±åŠ¨ä»¥å­—èŠ‚ä¸ºå•ä½è¿›è¡Œä¼ è¾“ã€‚å—è®¾å¤‡é©±åŠ¨å¯ä»¥è¿›è¡Œéšæœºè®¿é—®ï¼Œå—è®¾å¤‡é©±åŠ¨ä¸€èˆ¬éƒ½æœ‰ç¼“å†²åŒºæ¥æš‚å­˜æ•°æ®ï¼Œå½“å¯¹å—è®¾å¤‡è¿›è¡Œå†™å…¥æ—¶ä¼šå…ˆå°†æ•°æ®å†™åˆ°ç¼“å†²åŒºä¸­ï¼Œç´¯è®¡åˆ°ä¸€å®šæ•°æ®é‡åæ‰ä¸€æ¬¡æ€§åˆ·åˆ°è®¾å¤‡ä¸­ï¼Œè¿™æ ·æ—¢å¯ä»¥æé«˜è¯»å†™çš„é€Ÿåº¦ä¹Ÿå¯ä»¥æé«˜å¿«è®¾å¤‡é©±åŠ¨çš„å¯¿å‘½ï¼›ç›¸å¯¹å­—ç¬¦è®¾å¤‡æ•°æ®çš„æ“ä½œéƒ½æ˜¯å­—èŠ‚æµçš„æ–¹å¼ï¼Œå­—ç¬¦è®¾å¤‡æ²¡æœ‰ç¼“å†²åŒºã€‚</p>
<h2 id="_2">å…³é”®æ•°æ®ç»“æ„</h2>
<h3 id="block_device">block_device</h3>
<p>linuxç³»ç»Ÿä¸­ä½¿ç”¨strcut block_deviceæ¥è¡¨ç¤ºå—è®¾å¤‡,å¯ä»¥è¡¨ç¤ºç£ç›˜æˆ–ä¸€ä¸ªç‰¹å®šçš„åˆ†åŒºã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹strcut block_deviceæ•°æ®ç»“æ„ï¼Œè¯¥æ•°æ®ç»“æ„è¡¨ç¤ºå—è®¾å¤‡ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sector_t</span><span class="w">        </span><span class="n">bd_start_sect</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_stats</span><span class="w"> </span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">bd_stats</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">bd_stamp</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">            </span><span class="n">bd_read_only</span><span class="p">;</span><span class="w">   </span><span class="cm">/* read-only policy */</span>
<span class="w">    </span><span class="kt">dev_t</span><span class="w">           </span><span class="n">bd_dev</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w">         </span><span class="n">bd_openers</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="w">      </span><span class="n">bd_inode</span><span class="p">;</span><span class="w">   </span><span class="cm">/* will die */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="w">    </span><span class="n">bd_super</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w">          </span><span class="n">bd_claiming</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w">       </span><span class="n">bd_device</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w">          </span><span class="n">bd_holder</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w">         </span><span class="n">bd_holders</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">            </span><span class="n">bd_write_holder</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w">      </span><span class="o">*</span><span class="n">bd_holder_dir</span><span class="p">;</span>
<span class="w">    </span><span class="n">u8</span><span class="w">          </span><span class="n">bd_partno</span><span class="p">;</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w">      </span><span class="n">bd_size_lock</span><span class="p">;</span><span class="w"> </span><span class="cm">/* for bd_inode-&gt;i_size updates */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="w">    </span><span class="n">bd_disk</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* The counter of freeze processes */</span>
<span class="w">    </span><span class="kt">int</span><span class="w">         </span><span class="n">bd_fsfreeze_count</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* Mutex for freeze */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w">        </span><span class="n">bd_fsfreeze_mutex</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w">  </span><span class="o">*</span><span class="n">bd_fsfreeze_sb</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">partition_meta_info</span><span class="w"> </span><span class="o">*</span><span class="n">bd_meta_info</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FAIL_MAKE_REQUEST</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">            </span><span class="n">bd_make_it_fail</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="p">}</span><span class="w"> </span><span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></div>
<ul>
<li>bd_dev: è¯¥å—è®¾å¤‡ï¼ˆåˆ†åŒºï¼‰çš„è®¾å¤‡å·</li>
<li>bd_inode: è®¾å¤‡çš„æ–‡ä»¶inodeï¼Œbdevæ–‡ä»¶ç³»ç»Ÿå°†é€šè¿‡è¯¥inodeæ¥æ ‡è¯†å—è®¾å¤‡ã€‚</li>
<li>bd_disk: æŒ‡å‘æè¿°æ•´ä¸ªè®¾å¤‡çš„gendiskã€‚</li>
</ul>
<p>block_deviceæ˜¯bdevfsä¼ªæ–‡ä»¶ç³»ç»Ÿå¯¹å—è®¾å¤‡æˆ–è®¾å¤‡åˆ†åŒºçš„æŠ½è±¡ï¼Œå®ƒä¸è®¾å¤‡å·å”¯ä¸€å¯¹åº”ã€‚</p>
<h3 id="gendisk">gendisk</h3>
<p>linuxç³»ç»Ÿä¸­ï¼Œstruct gendiskæ˜¯é€šç”¨å­˜å‚¨è®¾å¤‡æè¿°ï¼Œè·Ÿå…·ä½“çš„ç¡¬ä»¶è®¾å¤‡å…³è”ï¼Œä¸€ä¸ªå…·ä½“çš„ç¡¬ä»¶å­˜å‚¨è®¾å¤‡å¯ä»¥åˆ†ä¸ºå¤šä¸ªåˆ†åŒºï¼Œè€Œæ¯ä¸ªåˆ†åŒºçš„å¯¹åº”ç”¨block_deviceæè¿°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* major, first_minor and minors are input parameters only,</span>
<span class="cm">     * don't use directly.  Use disk_devt() and disk_max_parts().</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">major</span><span class="p">;</span><span class="w">          </span><span class="cm">/* major number of driver */</span><span class="n">ç£ç›˜ä¸»è®¾å¤‡å·</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">first_minor</span><span class="p">;</span><span class="w">    </span><span class="n">ç£ç›˜ç¬¬ä¸€ä¸ªæ¬¡è®¾å¤‡</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">minors</span><span class="p">;</span><span class="w">                     </span><span class="cm">/* maximum number of minors, =1 for æ¬¡è®¾å¤‡çš„æ•°é‡ï¼Œä¹Ÿæ˜¯åˆ†åŒºæ•°é‡</span>
<span class="cm">                                         * disks that can't be partitioned. */</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">disk_name</span><span class="p">[</span><span class="n">DISK_NAME_LEN</span><span class="p">];</span><span class="w">  </span><span class="cm">/* name of major driver */</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">events</span><span class="p">;</span><span class="w">      </span><span class="cm">/* supported events */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">event_flags</span><span class="p">;</span><span class="w"> </span><span class="cm">/* flags related to event processing */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">xarray</span><span class="w"> </span><span class="n">part_tbl</span><span class="p">;</span><span class="w"> </span><span class="n">å¯¹åº”åˆ†åŒºè¡¨</span><span class="err">ï¼Œ</span><span class="n">æ¯ä¸€é¡¹å¯¹åº”è¦ç»™åˆ†åŒºä¿¡æ¯</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="n">part0</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device_operations</span><span class="w"> </span><span class="o">*</span><span class="n">fops</span><span class="p">;</span><span class="n">ç£ç›˜æ“ä½œå‡½æ•°é›†</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">queue</span><span class="p">;</span><span class="w"> </span><span class="n">ç£ç›˜å¯¹åº”çš„è¯·æ±‚é˜Ÿåˆ—</span><span class="err">ï¼Œ</span><span class="n">å¯¹ç£ç›˜æ“ä½œçš„è¯·æ±‚éƒ½æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">private_data</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="cp">#define GD_NEED_PART_SCAN       0</span>
<span class="cp">#define GD_READ_ONLY            1</span>
<span class="cp">#define GD_DEAD             2</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w"> </span><span class="n">open_mutex</span><span class="p">;</span><span class="w">    </span><span class="cm">/* open/close mutex */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">open_partitions</span><span class="p">;</span><span class="w">   </span><span class="cm">/* number of open partitions */</span><span class="w"> </span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">backing_dev_info</span><span class="w"> </span><span class="o">*</span><span class="n">bdi</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">slave_dir</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_BLOCK_HOLDER_DEPRECATED</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">slave_bdevs</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timer_rand_state</span><span class="w"> </span><span class="o">*</span><span class="n">random</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">sync_io</span><span class="p">;</span><span class="w">       </span><span class="cm">/* RAID */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_events</span><span class="w"> </span><span class="o">*</span><span class="n">ev</span><span class="p">;</span>
<span class="cp">#ifdef  CONFIG_BLK_DEV_INTEGRITY</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="n">integrity_kobj</span><span class="p">;</span>
<span class="cp">#endif  </span><span class="cm">/* CONFIG_BLK_DEV_INTEGRITY */</span>
<span class="cp">#if IS_ENABLED(CONFIG_CDROM)</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cdrom_device_info</span><span class="w"> </span><span class="o">*</span><span class="n">cdi</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">node_id</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">badblocks</span><span class="w"> </span><span class="o">*</span><span class="n">bb</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lockdep_map</span><span class="w"> </span><span class="n">lockdep_map</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">diskseq</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>major: å­˜å‚¨è®¾å¤‡çš„ä¸»è®¾å¤‡å·</li>
<li>first_minor: å­˜å‚¨è®¾å¤‡çš„ç¬¬ä¸€ä¸ªæ¬¡è®¾å¤‡å·</li>
<li>minors:å­˜å‚¨è®¾å¤‡çš„æ¬¡è®¾å¤‡å·æ•°é‡ï¼Œä¹Ÿå¯¹åº”å­˜å‚¨è®¾å¤‡çš„åˆ†åŒºæ•°é‡ã€‚</li>
<li>part_tbl:å­˜å‚¨è®¾å¤‡å¯¹åº”çš„åˆ†åŒºè¡¨</li>
<li>fops:å­˜å‚¨è®¾å¤‡å—æ“ä½œé›†åˆï¼Œä¸å­—ç¬¦è®¾å¤‡çš„file_operationsä¸€æ ·ã€‚</li>
<li>queue:å­˜å‚¨è®¾å¤‡å¯¹åº”çš„è¯·æ±‚é˜Ÿåˆ—ï¼Œå¯¹ç£ç›˜çš„è¯·æ±‚éƒ½ä¼šæ”¾åˆ°è¯¥é˜Ÿåˆ—ä¸­ã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯ç£ç›˜çš„æ“ä½œå‡½æ•°é›†åˆblock_device_operationsï¼Œä¸å­—ç¬¦è®¾å¤‡é©±åŠ¨file_operationsç±»ä¼¼ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">block_device_operations</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">blk_qc_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">submit_bio</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">rw_page</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">sector_t</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ioctl</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">compat_ioctl</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="nf">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">check_events</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">,</span>
<span class="w">                      </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">clearing</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">unlock_native_capacity</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">getgeo</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">hd_geometry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">set_read_only</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="n">bdev</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ro</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/* this callback is with swap_lock and sometimes page table lock held */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">swap_slot_free_notify</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">report_zones</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">sector_t</span><span class="w"> </span><span class="n">sector</span><span class="p">,</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_zones</span><span class="p">,</span><span class="w"> </span><span class="n">report_zones_cb</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">devnode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="n">umode_t</span><span class="w"> </span><span class="o">*</span><span class="n">mode</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pr_ops</span><span class="w"> </span><span class="o">*</span><span class="n">pr_ops</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Special callback for probing GPT entry at a given sector.</span>
<span class="cm">     * Needed by Android devices, used by GPT scanner and MMC blk</span>
<span class="cm">     * driver.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">alternative_gpt_sector</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="n">sector_t</span><span class="w"> </span><span class="o">*</span><span class="n">sector</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<ul>
<li>submit_bio: å¯¹å­˜å‚¨è®¾å¤‡è¯»å†™æ“ä½œï¼Œä½†ä¸ä¸€å®šä¼šä½¿ç”¨submit_bioæ¥ä¼ è¾“ï¼Œè€Œæ˜¯é€šè¿‡è¯·æ±‚é˜Ÿåˆ—æ¥å®Œæˆã€‚</li>
<li>open: æ‰“å¼€æŒ‡å®šçš„å—è®¾å¤‡</li>
<li>rw_page:è¯»å†™æŒ‡å®šçš„é¡µ</li>
<li>ioctl:å—è®¾å¤‡çš„I/Oæ§åˆ¶</li>
</ul>
<p>åœ¨block_device_operationsç»“æ„ä¸­ä¸åƒå­—ç¬¦è®¾å¤‡é©±åŠ¨æœ‰å¯¹åº”çš„readå’Œwriteå‡½æ•°ï¼Œæœ‰äº›å†…æ ¸ç‰ˆæœ¬ç”šè‡³æ²¡æœ‰submit_bioï¼Œå¯¹äºå—è®¾å¤‡çš„è¯»å†™æ“ä½œï¼Œä¸»è¦æ˜¯é€šè¿‡request_queueï¼Œrequestå’Œbioæ¥å®ç°çš„ã€‚</p>
<ul>
<li>request_queue:å†…æ ¸å¯¹å­˜å‚¨è®¾å¤‡çš„è¯»å†™æ“ä½œä¼šå…ˆå‘é€åˆ°request_queueä¸­ï¼Œè¯¥é˜Ÿåˆ—ä¸­åŒ…å«æœ‰ä¸€ç³»åˆ—çš„requestï¼Œåœ¨requestä¸­å…·ä½“çš„åŸºæœ¬å•å…ƒæ˜¯bioï¼Œbioä¿å­˜äº†å¯¹å­˜å‚¨è®¾å¤‡è¯»å†™çš„å®é™…æ•°æ®ï¼ŒåŒ…æ‹¬ä»å­˜å‚¨è®¾å¤‡çš„é‚£ä¸ªåœ°å€è¯»å†™ï¼Œå…·ä½“çš„é•¿åº¦ç­‰ä¿¡æ¯ã€‚</li>
<li>request: å­˜å‚¨è®¾å¤‡çš„è¯·æ±‚é˜Ÿåˆ—ä¸­ï¼ŒåŒ…å«å¤šä¸ªå†…æ ¸å¯¹å­˜å‚¨è®¾å¤‡çš„å¤šä¸ªrequestï¼Œæ¯ä¸ªè¯·æ±‚åŒ…å«å¤šä¸ªbioã€‚</li>
<li>bio:å†…æ ¸å¯¹å­˜å‚¨è®¾å¤‡è¯»å†™ä¼šæ„é€ ä¸€ä¸ªæˆ–è€…å¤šä¸ªçš„bioï¼Œbioæ•°æ®ç»“æ„åŒ…å«äº†å¯¹å­˜å‚¨è®¾å¤‡å…·ä½“çš„è¯»å†™ä½ç½®å’Œé•¿åº¦ç­‰ä¿¡æ¯ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥å°†å•ç‹¬å¯¹ä¸‰è€…å…³ç³»è¿›è¡Œæ·±å…¥æè¿°ã€‚</p>
<h2 id="biorequestrequest_queue">bio,request,request_queue</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_6e9f2cd13fec0f8325a29151ea196e01.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡/images/wp_editor_md_6e9f2cd13fec0f8325a29151ea196e01.jpg"/></a></p>
<h3 id="generic-block-layer">Generic Block layer</h3>
<p>æ–‡ä»¶ç³»ç»Ÿå‘ä¸‹å°±æ˜¯Generic Block Layerï¼Œæ–‡ä»¶ç³»ç»Ÿè¯·æ±‚è¯»å†™çš„æ–‡ä»¶ä½ç½®éœ€è¦è¢«è½¬æ¢åˆ°å¯¹åº”çš„å­˜å‚¨ä»‹è´¨çš„ä½ç½®ï¼ˆå¦‚ç£ç›˜çš„æ‰‡åŒºå·ï¼‰ã€‚å¦‚ä¸‹æ˜¯æ–‡ä»¶ç³»ç»Ÿå†™è¿‡ç¨‹ï¼Œå°†å†™è¯·æ±‚æ ¹æ®æ–‡ä»¶çš„posä½è½¬åŒ–ä¸ºbioã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">__block_write_begin</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">len</span><span class="p">,</span>
<span class="w">        </span><span class="n">get_block_t</span><span class="w"> </span><span class="o">*</span><span class="n">get_block</span><span class="p">)</span>

<span class="w">    </span><span class="o">--&gt;</span><span class="k">return</span><span class="w"> </span><span class="n">__block_write_begin_int</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">get_block</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">        </span><span class="o">--&gt;</span><span class="n">ll_rw_block</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">op_flags</span><span class="p">,</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nr</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">buffer_head</span><span class="w"> </span><span class="o">*</span><span class="n">bhs</span><span class="p">[])</span>

<span class="w">            </span><span class="o">--&gt;</span><span class="kt">int</span><span class="w"> </span><span class="n">submit_bh</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">op_flags</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">buffer_head</span><span class="w"> </span><span class="o">*</span><span class="n">bh</span><span class="p">)</span>

<span class="w">                    </span><span class="o">--&gt;</span><span class="n">submit_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span>
</code></pre></div>
<p>bioæ˜¯å—è®¾å¤‡æ•°æ®ä¼ è¾“æœ€å°å•å…ƒï¼Œä¸‹é¢æ˜¯struct bioçš„æ•°æ®ç»“æ„ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_fef97739b4f80ac0b84dbf1e1518686b.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡/images/wp_editor_md_fef97739b4f80ac0b84dbf1e1518686b.jpg"/></a></p>
<ul>
<li>bio_vec:æ ‡è¯†å­˜å‚¨è®¾å¤‡ä¸­æ•°æ®ç¼“å­˜åœ¨pageçš„ä½ç½®ï¼Œæè¿°IOè¯·æ±‚åœ¨å†…å­˜æ®µçš„æ•°æ®ä½ç½®å±æ€§ï¼ˆpageåœ°å€ï¼Œé¡µå†…åç§»ï¼Œé•¿åº¦ï¼‰ã€‚</li>
<li>bvec_iterï¼šæ ‡è¯†æ“ä½œæ•°æ®åœ¨å­˜å‚¨è®¾å¤‡çš„ä½ç½®ï¼Œæè¿°IOè¯·æ±‚åœ¨å­˜å‚¨å™¨æ®µçš„æ•°æ®ä½ç½®å±æ€§ï¼ˆèµ·å§‹sectorï¼Œé•¿åº¦ï¼‰ã€‚</li>
</ul>
<h3 id="io-scheduler-layer">I/O Scheduler Layer</h3>
<p>ä»submit_bioè°ƒç”¨å¼€å§‹ï¼Œbioè¢«blockå±‚æŠ½è±¡ä¸ºrequestè¿›è¡Œç®¡ç†ï¼Œrequestä¼šè¢«ç»„ç»‡åˆ°request queueä¸­ã€‚IOè°ƒåº¦å™¨çš„ç›®çš„æ˜¯åœ¨ç°æœ‰è¯·æ±‚ä¸‹ï¼Œè®©å°½å¯èƒ½å°‘æ“ä½œå­˜å‚¨è®¾å¤‡ï¼Œæé«˜å­˜å‚¨è®¾å¤‡çš„è¯»å†™æ•ˆç‡ã€‚åœ¨IOè°ƒåº¦å™¨ä¸­ï¼Œä»æ–‡ä»¶ç³»ç»Ÿæäº¤ä¸‹æ¥çš„bioè¢«æ„é€ æˆrequestç»“æ„ï¼Œä¸€ä¸ªrequestç»“æ„åŒ…å«äº†å¤šä¸ªbioï¼Œè€Œç‰©ç†å­˜å‚¨è®¾å¤‡éƒ½ä¼šæœ‰å¯¹åº”çš„request queueï¼Œé‡Œé¢å­˜æ”¾ç€ç›¸å…³çš„requestï¼Œæ–°çš„bioå¯èƒ½è¢«åˆå¹¶åˆ°request queueç°æœ‰çš„requestç»“æ„ä¸­ï¼Œä¹Ÿæœ‰å¯èƒ½ç”Ÿæˆæ–°çš„requestï¼Œå¦‚ä½•åˆå¹¶ã€æ’å…¥ç­‰å–å†³äºè®¾å¤‡é©±åŠ¨é€‰æ‹©çš„IOè°ƒåº¦ç®—æ³•ã€‚</p>
<h4 id="io">I/Oè¯·æ±‚</h4>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_2a74945cf47ccdb99af4b4756648d7b8.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡/images/wp_editor_md_2a74945cf47ccdb99af4b4756648d7b8.jpg"/></a></p>
<p>æ—©æœŸé˜¶æ®µï¼Œåªæœ‰ä¸€ä¸ªå•é˜Ÿåˆ—single-queueï¼Œéšç€å¤šæ ¸ä½“ç³»ç»“æ„çš„å‘å±•ï¼Œå•é˜Ÿåˆ—çš„æš´éœ²äº†è¾ƒå¤šåŠ£åŠ¿ï¼Œå¦‚å¤šæ ¸è¯·æ±‚é˜Ÿåˆ—æ—¶ï¼Œéœ€è¦ä½¿ç”¨spinlockæ¥åšåŒæ­¥ï¼Œé”çš„ç«äº‰å¸¦æ¥æ¯”è¾ƒé«˜çš„é¢å¤–å¼€é”€ï¼Œå› æ­¤åæ¥å¼•å…¥äº†multi-queueï¼Œå°†å•ä¸ªé˜Ÿåˆ—è¯·æ±‚é”çš„ç«äº‰åˆ†æ•£åˆ°å¤šä¸ªé˜Ÿåˆ—ä¸­ï¼Œè¿™æ ·å°±æå¤§æé«˜äº†å¹¶å‘IOçš„å¤„ç†èƒ½åŠ›ã€‚</p>
<p>multi-queueç»“æ„åˆ†ä¸ºä¸¤å±‚é˜Ÿåˆ—è®¾è®¡ï¼Œåˆ†åˆ«æ˜¯Per-CPUçº§åˆ«çš„è½¯ä»¶æš‚å­˜é˜Ÿåˆ—ï¼ˆSoftware staging queueï¼ŒPer CPUï¼‰å’Œå­˜å‚¨è®¾å¤‡ç¡¬ä»¶æ´¾å‘é˜Ÿåˆ—ï¼ˆHardware Dispatch queueï¼ŒPer Disk Per channelï¼‰ï¼›</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_cdcee2f38ff80b89823cb696631b3762.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡/images/wp_editor_md_cdcee2f38ff80b89823cb696631b3762.jpg"/></a></p>
<ul>
<li>
<p>è½¯ä»¶æš‚å­˜é˜Ÿåˆ—ï¼ˆctxï¼‰ï¼šå¯¹åº”çš„æ•°æ®ç»“æ„blk_mq_ctx,ä¸ºæ¯ä¸ªcpuåˆ†é…ä¸€ä¸ªè½¯ä»¶é˜Ÿåˆ—ï¼Œå°†bioç”Ÿæˆä¸€ä¸ªæ–°çš„requestæˆ–åˆå¹¶åˆ°å·²æœ‰çš„requestä¸­ã€‚bioçš„æäº¤/å®Œæˆå¤„ç†ã€IOè¯·æ±‚åˆå¹¶/æ’åº/æ ‡è®°ã€è°ƒåº¦è®°è´¦ç­‰block layeræ“ä½œéƒ½åœ¨è¯¥é˜Ÿåˆ—ä¸­è¿›è¡Œã€‚é˜Ÿåˆ—æ˜¯Per CPUï¼Œæ‰€ä»¥æ¯ä¸ªCPU ioè¯·æ±‚å¹¶å‘çš„æ—¶å€™ä¸å­˜åœ¨é”ç«äº‰é—®é¢˜ã€‚</p>
</li>
<li>
<p>ç¡¬ä»¶æ´¾å‘é˜Ÿåˆ—ï¼ˆhctxï¼‰ï¼šå¯¹åº”çš„æ•°æ®ç»“æ„blk_mq_hw_ctx,æ¯ä¸ªå­˜å‚¨è®¾å¤‡çš„æ¯ä¸ªç¡¬ä»¶é˜Ÿåˆ—ï¼ˆé€šå¸¸ä¸ºä¸€ä¸ªï¼‰åˆ†é…ä¸€ä¸ªç¡¬ä»¶æ´¾å‘é˜Ÿåˆ—ï¼Œç”¨äºå¤„ç†ä¸Šå±‚è½¯ä»¶æš‚å­˜é˜Ÿåˆ—ä¸‹å‘çš„ioè¯·æ±‚ã€‚åœ¨å­˜å‚¨è®¾å¤‡é©±åŠ¨åˆå§‹åŒ–æ—¶ï¼Œblk-mqä¼šå°†ä¸€ä¸ªæˆ–å¤šä¸ªè½¯ä»¶æš‚å­˜é˜Ÿåˆ—å›ºå®šæ˜ å°„åˆ°ä¸€ä¸ªç¡¬ä»¶æ´¾å‘é˜Ÿåˆ—ï¼Œåç»­è½¯ä»¶é˜Ÿåˆ—ä¸Šçš„ioè¯·æ±‚å°±ä¼šç›´æ¥å¾€æ˜ å°„çš„ç¡¬ä»¶æ´¾å‘é˜Ÿåˆ—ä¸‹å‘,æœ€ç»ˆä¸‹å‘åˆ°ç¡¬ä»¶å­˜å‚¨è®¾å¤‡ã€‚</p>
</li>
</ul>
<p><a href="https://blog.csdn.net/morecrazylove/article/details/128712522">https://blog.csdn.net/morecrazylove/article/details/128712522</a></p>
<p><a href="https://blog.csdn.net/juS3Ve/article/details/79890688">https://blog.csdn.net/juS3Ve/article/details/79890688</a></p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_08f19f9823ab9bce38fb1c551f2671a8.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡/images/wp_editor_md_08f19f9823ab9bce38fb1c551f2671a8.jpg"/></a></p></div>
  <div class="post-nav">
    <a class="prev" href="å†…å­˜ç®¡ç†æ¦‚è¿°.html">â† å†…å­˜ç®¡ç†æ¦‚è¿°</a>
    <a class="next" href="ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å­—ç¬¦è®¾å¤‡.html">ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å­—ç¬¦è®¾å¤‡ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

