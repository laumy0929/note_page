<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RISC-V架构与FreeRTOS任务栈变化 - Laumy的技术栈</title>
    <link rel="stylesheet" href="../assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="../">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="../">首页</a></div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#_1">栈的基本概念</a><ul></ul></li><li><a href="#_2">任务栈空间开辟</a><ul></ul></li><li><a href="#_3">初始化栈</a><ul></ul></li><li><a href="#_4">第一个任务栈恢复</a><ul></ul></li><li><a href="#_5">任务切换栈变化</a><ul></ul></li><li><a href="#_6">跟踪一个任务运行栈的变化实例</a><ul><li><a href="#_7">初始化栈</a></li><li><a href="#_8">调度得到运行</a></li><li><a href="#_9">恢复上下文</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>RISC-V架构与FreeRTOS任务栈变化</h1>
  <div class="meta">2024-05-10 · risc-v</div>
  <div class="post-content"><h2 id="_1">栈的基本概念</h2>
<p>在FreeRTOS中，每个任务有一个全局的tskTCB实例，pxCurrentTCB指针指向的是正在运行的任务实例，有三个和栈相关的变量pxTopOfStack和pxStack，pxEndOfStack。</p>
<ul>
<li>
<p>pxTopOfStack指向当前堆栈栈顶，随着进栈出栈，pxTopOfStack指向的位置是会变化的；</p>
</li>
<li>
<p>pxStack指向当前堆栈的起始位置，一经分配后，堆栈起始位置就固定了，不会被改变了。</p>
</li>
<li>
<p>pxEndOfStack 标记着栈结束位置，任务创建完成后就固定了</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="nl">adress</span><span class="p">:</span><span class="mi">0</span><span class="o">+</span><span class="n">ulStackDepth</span><span class="w">       </span><span class="o">-------------------</span><span class="w"> </span><span class="n">pxEndOfStack</span><span class="err">（</span><span class="n">栈底</span><span class="err">）</span>
<span class="w">                            </span><span class="o">|</span><span class="n">XXXXXXXXXXXXXXXXXX</span><span class="o">|</span>
<span class="nl">adress</span><span class="p">:</span><span class="mi">0</span><span class="o">+</span><span class="n">x</span><span class="w">                  </span><span class="o">--------------------</span><span class="n">pxTopOfStack</span><span class="p">(</span><span class="n">栈顶</span><span class="p">)</span>
<span class="w">                            </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span>
<span class="w">                            </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span>
<span class="w">                            </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span>
<span class="nl">adress</span><span class="p">:</span><span class="mi">0</span><span class="w">                    </span><span class="o">-------------------</span><span class="w"> </span><span class="n">pxStack</span>
</code></pre></div>
<h2 id="_2">任务栈空间开辟</h2>
<div class="codehilite"><pre><span></span><code><span class="n">xTaskCreate</span><span class="w"> </span>
<span class="w">   </span><span class="mf">1.</span><span class="w"> </span><span class="n">分配一个栈空间</span>
<span class="w">    </span><span class="cm">/* Allocate space for the stack used by the task being created. */</span>
<span class="w">    </span><span class="n">pxStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pvPortMalloc</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">usStackDepth</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="w"> </span><span class="n">StackType_t</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="n">pxNewTCB</span><span class="o">-&gt;</span><span class="n">pxStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pxStack</span><span class="p">;</span>
<span class="w">    </span><span class="mf">2.</span><span class="w"> </span><span class="n">初始化新任务</span>
<span class="w">    </span><span class="n">prvInitialiseNewTask</span><span class="p">(</span><span class="w"> </span><span class="n">pxTaskCode</span><span class="p">,</span><span class="w"> </span><span class="n">pcName</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">usStackDepth</span><span class="p">,</span><span class="w"> </span><span class="n">pvParameters</span><span class="p">,</span><span class="w"> </span><span class="n">uxPriority</span><span class="p">,</span><span class="w"> </span><span class="n">pxCreatedTask</span><span class="p">,</span><span class="w"> </span><span class="n">pxNewTCB</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="mf">2.1</span><span class="w"> </span><span class="n">更新pxTopOfStack</span>
<span class="w">        </span><span class="n">pxTopOfStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="w"> </span><span class="n">pxNewTCB</span><span class="o">-&gt;</span><span class="n">pxStack</span><span class="p">[</span><span class="w"> </span><span class="n">ulStackDepth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="n">pxTopOfStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">StackType_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">portPOINTER_SIZE_TYPE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">pxTopOfStack</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">portPOINTER_SIZE_TYPE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">portBYTE_ALIGNMENT_MASK</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="mf">2.2</span><span class="w"> </span><span class="n">初始化栈</span>
<span class="w">        </span><span class="n">pxNewTCB</span><span class="o">-&gt;</span><span class="n">pxTopOfStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pxPortInitialiseStack</span><span class="p">(</span><span class="w"> </span><span class="n">pxTopOfStack</span><span class="p">,</span><span class="w"> </span><span class="n">pxTaskCode</span><span class="p">,</span><span class="w"> </span><span class="n">pvParameters</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="n">初始化栈后</span><span class="err">，</span><span class="n">pxNewTCB</span><span class="o">-&gt;</span><span class="n">pxTopOfStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pxTopOfStack</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">Size</span>
</code></pre></div>
<h2 id="_3">初始化栈</h2>
<div class="codehilite"><pre><span></span><code><span class="nl">pxPortInitialiseStack</span><span class="p">:</span>
<span class="cp">#if defined(CONFIG_ARCH_RISCV_FPU) &amp;&amp; !defined(CONFIG_SAVE_RISCV_FPU_CONTEXT_IN_TCB)</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">FPU_CONTEXT_SIZE</span><span class="p">)</span>
<span class="w">    </span><span class="cm">/* set fpu rounding mode field to 0(Round to Nearest, ties to Even) when create new thread,</span>
<span class="cm">     * otherwise it\'s possible that the rounding mode filed is invalid and</span>
<span class="cm">     * cause the illegal instruction exception when restore the fcsr.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">FPU_CTX_FCSR_OFFSET</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span>
<span class="w">    </span><span class="n">csrr</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">mstatus</span><span class="w">                    </span><span class="cm">/* Obtain current mstatus value. */</span>
<span class="w">    </span><span class="n">andi</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="mh">0x8</span><span class="w">                   </span><span class="cm">/* Ensure interrupts are disabled when the stack is restored within an ISR.  Required when a task is created after the schedulre has been started, otherwise interrupts would be disabled anyway. */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x188</span><span class="w">                  </span><span class="cm">/* Generate the value 0x1880, which are the MPIE and MPP bits to set in mstatus. */</span>
<span class="w">    </span><span class="n">slli</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="n">or</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="w">                       </span><span class="cm">/* Set MPIE and MPP bits in mstatus value. */</span>

<span class="cp">#ifdef CONFIG_SAVE_RISCV_FPU_CONTEXT_IN_TCB</span>
<span class="w">    </span><span class="cm">/* set FS filed(in thread stack) to initial state for skip save/restore FPU context operation */</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">SR_FS</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">SR_FS_INITIAL</span>
<span class="w">    </span><span class="n">not</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span>
<span class="w">    </span><span class="n">and</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t3</span>
<span class="w">    </span><span class="n">or</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span><span class="w">                   </span><span class="cm">/* mstatus onto the stack. */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="mi">22</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">)</span><span class="w">  </span><span class="cm">/* Space for registers x11-x31. */</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span><span class="w">                   </span><span class="cm">/* Task parameters (pvParameters parameter) goes into register X10/a0 on the stack. */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">)</span><span class="w">   </span><span class="cm">/* Space for registers x5-x9. */</span>
<span class="w">    </span><span class="n">la</span><span class="w">   </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">portTASK_RETURN_ADDRESS</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span><span class="w">                   </span><span class="cm">/* Return address onto the stack, could be portTASK_RETURN_ADDRESS */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">portasmADDITIONAL_CONTEXT_SIZE</span><span class="w"> </span><span class="cm">/* The number of chip specific additional registers. */</span>
<span class="nl">chip_specific_stack_frame</span><span class="p">:</span><span class="w">              </span><span class="cm">/* First add any chip specific registers to the stack frame being created. */</span>
<span class="w">    </span><span class="n">beq</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mf">1f</span><span class="w">                      </span><span class="cm">/* No more chip specific registers to save. */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span><span class="w">         </span><span class="cm">/* Make space for chip specific register. */</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span><span class="w">                   </span><span class="cm">/* Give the chip specific register an initial value of zero. */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="w">                     </span><span class="cm">/* Decrement the count of chip specific registers remaining. */</span>
<span class="w">    </span><span class="n">j</span><span class="w"> </span><span class="n">chip_specific_stack_frame</span><span class="w">         </span><span class="cm">/* Until no more chip specific registers. */</span>
<span class="mi">1</span><span class="o">:</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span><span class="w">                   </span><span class="cm">/* mret value (pxCode parameter) onto the stack. */</span><span class="w"> </span>
<span class="w">    </span><span class="n">ret</span>
<span class="w">    </span><span class="p">.</span><span class="n">endfunc</span>
</code></pre></div>
<p>经过pxPortInitialiseStack初始化后存储布局如下：</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_287d5adca82e4cebb65d666347e94fd1.jpg"><img alt="" src="../assets/doc/02-risc-v/risc-v架构与freertos任务调度/images/wp_editor_md_287d5adca82e4cebb65d666347e94fd1.jpg"/></a></p>
<h2 id="_4">第一个任务栈恢复</h2>
<div class="codehilite"><pre><span></span><code><span class="nl">xPortStartFirstTask</span><span class="p">:</span>

<span class="cp">#if( portasmHAS_SIFIVE_CLINT != 0 )</span>
<span class="w">    </span><span class="cm">/* If there is a clint then interrupts can branch directly to the FreeRTOS</span>
<span class="cm">    trap handler.  Otherwise the interrupt controller will need to be configured</span>
<span class="cm">    outside of this file. */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">freertos_risc_v_trap_handler</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mtvec</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>
<span class="cp">#endif </span><span class="cm">/* portasmHAS_CLILNT */</span>

<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">pxCurrentTCB</span><span class="w">            </span><span class="cm">/* 加载当前TCB */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">t0</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* 获取当前TCB的栈空间*/</span>

<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* 加载返回地址，即任务入口函数 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* t1 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* t2 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* s0/fp */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* s1 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x10</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">    </span><span class="cm">/* a0 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">    </span><span class="cm">/* a1 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">    </span><span class="cm">/* a2 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x13</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a3 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x14</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a4 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x15</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a5 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x16</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a6 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a7 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x18</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s2 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x19</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s3 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x20</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s4 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x21</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s5 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x22</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s6 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x23</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s7 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s8 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x25</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s9 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x26</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s10 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x27</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s11 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x28</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t3 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t4 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t5 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x31</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t6 */</span>

<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">    </span><span class="cm">/* Initial mstatus into x5 (t0) */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span><span class="w">                       </span><span class="cm">/* Set MIE bit so the first task starts with interrupts enabled - required as returns with ret not eret. */</span>
<span class="w">    </span><span class="n">csrrw</span><span class="w">  </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">mstatus</span><span class="p">,</span><span class="w"> </span><span class="n">x5</span><span class="w">                  </span><span class="cm">/* Interrupts enabled from here! */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* Initial x5 (t0) value. */</span>

<span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">portCONTEXT_SIZE</span><span class="w">         </span><span class="cm">/*销毁栈空间，SP已经更新*/</span>
<span class="cp">#if 0</span>
<span class="c">    load_x      t0, pxCurrentTCB        /* Load pxCurrentTCB. */</span>
<span class="c">    store_x     sp, 0( t0 )             /* Write sp to first TCB member. */</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">更新栈顶指针</span><span class="err">，</span><span class="n">上面两句不执行也行</span><span class="err">，</span><span class="n">因为任务执行时</span><span class="err">，</span><span class="n">sp的值已经更新了</span><span class="err">，</span><span class="n">任务用的是SP</span><span class="err">，</span>
<span class="w">    </span><span class="n">而不是pxCurrentTCB</span><span class="o">-&gt;</span><span class="n">pxTopOfStack</span><span class="err">。</span>
<span class="w">    </span><span class="n">ret</span>
<span class="w">    </span><span class="p">.</span><span class="n">endfunc</span>
<span class="cm">/*-----------------------------------------------------------*/</span>
</code></pre></div>
<h2 id="_5">任务切换栈变化</h2>
<div class="codehilite"><pre><span></span><code><span class="nl">clic_interrupt_handler</span><span class="p">:</span>
<span class="w">    </span><span class="mf">1.</span><span class="w"> </span><span class="n">任务在运行过程中</span><span class="err">，</span><span class="n">被中断打断</span><span class="err">，</span><span class="n">先分配一块栈帧</span><span class="err">，</span><span class="n">保存现场</span><span class="err">。</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portCONTEXT_SIZE</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x5</span><span class="p">,</span><span class="w">  </span><span class="mi">2</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x6</span><span class="p">,</span><span class="w">  </span><span class="mi">3</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x7</span><span class="p">,</span><span class="w">  </span><span class="mi">4</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x8</span><span class="p">,</span><span class="w">  </span><span class="mi">5</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x9</span><span class="p">,</span><span class="w">  </span><span class="mi">6</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x10</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x13</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x14</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x15</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x16</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x18</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x19</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x20</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x21</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x22</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x23</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x25</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x26</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x27</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x28</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x31</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w">  </span><span class="mi">31</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w">  </span><span class="mi">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>

<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">portCONTEXT_SIZE</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w">  </span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>

<span class="w">    </span><span class="n">csrr</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">mepc</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">csrr</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">mscratch</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>

<span class="w">    </span><span class="n">csrr</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">mstatus</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>

<span class="w">    </span><span class="mf">2.</span><span class="w"> </span><span class="n">因为分配了一段栈空间</span><span class="err">，</span><span class="n">所以需要将栈顶指针更新到pxCurrentTCB</span><span class="o">-&gt;</span><span class="n">pxTopOfStack</span>
<span class="w">       </span><span class="n">到这里</span><span class="err">，</span><span class="n">这样任务的上下文就保存好了</span><span class="err">，</span><span class="n">可以运行中断函数</span><span class="err">，</span><span class="n">或切换到其他任务</span><span class="err">。</span>
<span class="w">    </span><span class="n">lw</span><span class="w">      </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">pxCurrentTCB</span><span class="w">        </span><span class="cm">/* Load pxCurrentTCB. */</span>
<span class="w">    </span><span class="n">sw</span><span class="w">      </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="w"> </span><span class="n">t0</span><span class="w"> </span><span class="p">)</span><span class="w">             </span><span class="cm">/* Write sp to first TCB member. */</span>

<span class="w">    </span><span class="mf">3.</span><span class="w"> </span><span class="n">加载中断的栈空间</span><span class="err">，</span><span class="n">执行中断处理函数</span><span class="err">。</span>
<span class="w">    </span><span class="n">load_x</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">xISRStackTop</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">enter_interrupt_handler</span>
<span class="w">    </span><span class="n">csrr</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">mcause</span>
<span class="w">    </span><span class="n">andi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7FF</span><span class="w">           </span><span class="cm">/* If the CLIC support more than 2048 interrupts, we need to use the mask value saved in register */</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">irq_core_handle_root_ic_irq</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">exit_interrupt_handler</span>

<span class="w">    </span><span class="mf">4.</span><span class="w"> </span><span class="n">获取任务的控制块</span><span class="err">，</span><span class="n">这里的任务可能是原来的任务</span><span class="err">，</span><span class="n">也可能是新的任务</span>
<span class="w">    </span><span class="n">在中断处理函数中</span><span class="err">，</span><span class="n">会进行调度</span><span class="err">，</span><span class="n">更新pxCurrentTCB</span><span class="p">,</span><span class="n">之后获取pxCurrentTCB</span><span class="o">-&gt;</span><span class="n">pxTopOfStack</span>
<span class="w">    </span><span class="n">这样就找到了新任务的栈空间</span>
<span class="w">    </span><span class="n">lw</span><span class="w">      </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">pxCurrentTCB</span><span class="w">            </span><span class="cm">/* Load pxCurrentTCB. */</span>
<span class="w">    </span><span class="n">lw</span><span class="w">      </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="p">)</span><span class="w">                 </span><span class="cm">/* Read sp from first TCB member. */</span>

<span class="w">    </span><span class="mf">5.</span><span class="w"> </span><span class="n">栈空间的第一个保存的开始要运行的地址</span><span class="err">，</span><span class="n">加载出来写入到mepc中</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mepc</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>

<span class="w">    </span><span class="cm">/* Load mstatus with the interrupt enable bits used by the task. */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mstatus</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>

<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mscratch</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>

<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x1</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x5</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">       </span><span class="cm">/* t0 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x6</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">       </span><span class="cm">/* t1 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x7</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">       </span><span class="cm">/* t2 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x8</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">       </span><span class="cm">/* s0/fp */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x9</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">       </span><span class="cm">/* s1 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x10</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a0 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a1 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a2 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x13</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a3 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x14</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a4 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x15</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a5 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x16</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a6 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a7 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x18</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s2 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x19</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s3 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x20</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s4 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x21</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s5 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x22</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s6 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x23</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s7 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s8 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x25</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s9 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x26</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s10 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x27</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s11 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x28</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t3 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t4 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t5 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x31</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t6 */</span>

<span class="w">   </span><span class="mf">6.</span><span class="n">上下文已经恢复</span><span class="err">，</span><span class="n">销毁掉栈空间</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">portCONTEXT_SIZE</span>

<span class="w">   </span><span class="mf">7.</span><span class="w"> </span><span class="n">下面两句</span><span class="err">，</span><span class="n">可以不执行</span><span class="err">，</span><span class="n">因为mret之后就切到任务中运行了</span><span class="err">，</span><span class="n">sp已经更新</span><span class="err">。</span>
<span class="cp">#if 0</span>
<span class="c">    load_x      t0, pxCurrentTCB        /* Load pxCurrentTCB. */</span>
<span class="c">    store_x     sp, 0( t0 )             /* Write sp to first TCB member. */</span>
<span class="cp">#endif</span>

<span class="w">   </span><span class="mf">8.</span><span class="w"> </span><span class="n">返回到任务中运行</span><span class="err">，</span>
<span class="w">    </span><span class="n">mret</span>
</code></pre></div>
<p>pxCurrentTCB-&gt;pxTopOfStack的变化</p>
<ol>
<li>pxPortInitialiseStack初始化栈，分配一段栈空间，设置pxCurrentTCB-&gt;pxTopOfStack初值。这段栈空间在任务得到运行时会将pxCurrentTCB-&gt;pxTopOfStack赋值为sp，接着恢复上下文运行。任务得到运行有两种场景</li>
</ol>
<ul>
<li>xPortStartFirstTask：这种任务是优先级比较高，系统初始化完成后会挑选第一个任务进行运行，在该函数中会恢复上下文，接着更新sp的值进而销毁栈空间，但是没有更新pxCurrentTCB-&gt;pxTopOfStack的值（该值是否更新不影响，sp已经更新了）。</li>
<li>其他任务让出得到调度：这种场景是得到调度机会，在中断中进行恢复上下文（上面代码的第4点点开始），</li>
</ul>
<ol start="2">
<li>运行过程中被中断打断（可能是中断，也有可能是时间片用完），分配一段栈空间用于保存上下文信息。上面代码第1点就是开辟一段栈空间，进行保存上下文，保存上下文后，因为可能会让出调度，因此需要更新pxCurrentTCB-&gt;pxTopOfStack，上述代码的第二点。</li>
</ol>
<p>为什么只看到第1点中SP开辟了，更新到pxCurrentTCB-&gt;pxTopOfStack后，没有见哪里归还，是否有栈泄露？ 答：在任务再次得到运行的时候，会进行归还，上面第6点就是，SP进行的增加，释放的栈空间，只是没有写到pxCurrentTCB-&gt;pxTopOfStack，而当任务在运行过程中被打断进入中断后，sp是已经释放后的sp，而即使在第1点中开辟空间，也是归还后，再开辟的，所以不存在泄露。</p>
<h2 id="_6">跟踪一个任务运行栈的变化实例</h2>
<h3 id="_7">初始化栈</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_b643046527b646f1aae2523cbeb3094c.jpg"><img alt="" src="../assets/doc/02-risc-v/risc-v架构与freertos任务调度/images/wp_editor_md_b643046527b646f1aae2523cbeb3094c.jpg"/></a></p>
<p>初始化时开辟了一个栈空间，栈帧指向0x6007af78位置。</p>
<h3 id="_8">调度得到运行</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_46a035fdb69ff2ed6e06238e8c672f1c.jpg"><img alt="" src="../assets/doc/02-risc-v/risc-v架构与freertos任务调度/images/wp_editor_md_46a035fdb69ff2ed6e06238e8c672f1c.jpg"/></a></p>
<h3 id="_9">恢复上下文</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_5f7ec07ec58c4cdfc85a901159c901dd.jpg"><img alt="" src="../assets/doc/02-risc-v/risc-v架构与freertos任务调度/images/wp_editor_md_5f7ec07ec58c4cdfc85a901159c901dd.jpg"/></a></p></div>
  <div class="post-nav">
    <a class="prev" href="../qemu-opensbi-uboot-linux-busybox启动环境搭建.html">← qemu+opensbi+uboot+linux+busybox启动环境搭建</a>
    <a class="next" href="../平头哥e90x的head-s分析.html">平头哥E90X的head.S分析 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="../assets/site.js"></script>
  </body>
  </html>

