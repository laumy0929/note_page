<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RISC-Væ¶æ„ä¸FreeRTOSä»»åŠ¡æ ˆå˜åŒ– - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">æ ˆçš„åŸºæœ¬æ¦‚å¿µ</a><ul></ul></li><li><a href="#_2">ä»»åŠ¡æ ˆç©ºé—´å¼€è¾Ÿ</a><ul></ul></li><li><a href="#_3">åˆå§‹åŒ–æ ˆ</a><ul></ul></li><li><a href="#_4">ç¬¬ä¸€ä¸ªä»»åŠ¡æ ˆæ¢å¤</a><ul></ul></li><li><a href="#_5">ä»»åŠ¡åˆ‡æ¢æ ˆå˜åŒ–</a><ul></ul></li><li><a href="#_6">è·Ÿè¸ªä¸€ä¸ªä»»åŠ¡è¿è¡Œæ ˆçš„å˜åŒ–å®ä¾‹</a><ul><li><a href="#_7">åˆå§‹åŒ–æ ˆ</a></li><li><a href="#_8">è°ƒåº¦å¾—åˆ°è¿è¡Œ</a></li><li><a href="#_9">æ¢å¤ä¸Šä¸‹æ–‡</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>RISC-Væ¶æ„ä¸FreeRTOSä»»åŠ¡æ ˆå˜åŒ–</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-05-10
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      risc-v
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">æ ˆçš„åŸºæœ¬æ¦‚å¿µ</h2>
<p>åœ¨FreeRTOSä¸­ï¼Œæ¯ä¸ªä»»åŠ¡æœ‰ä¸€ä¸ªå…¨å±€çš„tskTCBå®ä¾‹ï¼ŒpxCurrentTCBæŒ‡é’ˆæŒ‡å‘çš„æ˜¯æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡å®ä¾‹ï¼Œæœ‰ä¸‰ä¸ªå’Œæ ˆç›¸å…³çš„å˜é‡pxTopOfStackå’ŒpxStackï¼ŒpxEndOfStackã€‚</p>
<ul>
<li>
<p>pxTopOfStackæŒ‡å‘å½“å‰å †æ ˆæ ˆé¡¶ï¼Œéšç€è¿›æ ˆå‡ºæ ˆï¼ŒpxTopOfStackæŒ‡å‘çš„ä½ç½®æ˜¯ä¼šå˜åŒ–çš„ï¼›</p>
</li>
<li>
<p>pxStackæŒ‡å‘å½“å‰å †æ ˆçš„èµ·å§‹ä½ç½®ï¼Œä¸€ç»åˆ†é…åï¼Œå †æ ˆèµ·å§‹ä½ç½®å°±å›ºå®šäº†ï¼Œä¸ä¼šè¢«æ”¹å˜äº†ã€‚</p>
</li>
<li>
<p>pxEndOfStack æ ‡è®°ç€æ ˆç»“æŸä½ç½®ï¼Œä»»åŠ¡åˆ›å»ºå®Œæˆåå°±å›ºå®šäº†</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="nl">adress</span><span class="p">:</span><span class="mi">0</span><span class="o">+</span><span class="n">ulStackDepth</span><span class="w">       </span><span class="o">-------------------</span><span class="w"> </span><span class="n">pxEndOfStack</span><span class="err">ï¼ˆ</span><span class="n">æ ˆåº•</span><span class="err">ï¼‰</span>
<span class="w">                            </span><span class="o">|</span><span class="n">XXXXXXXXXXXXXXXXXX</span><span class="o">|</span>
<span class="nl">adress</span><span class="p">:</span><span class="mi">0</span><span class="o">+</span><span class="n">x</span><span class="w">                  </span><span class="o">--------------------</span><span class="n">pxTopOfStack</span><span class="p">(</span><span class="n">æ ˆé¡¶</span><span class="p">)</span>
<span class="w">                            </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span>
<span class="w">                            </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span>
<span class="w">                            </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span>
<span class="nl">adress</span><span class="p">:</span><span class="mi">0</span><span class="w">                    </span><span class="o">-------------------</span><span class="w"> </span><span class="n">pxStack</span>
</code></pre></div>
<h2 id="_2">ä»»åŠ¡æ ˆç©ºé—´å¼€è¾Ÿ</h2>
<div class="codehilite"><pre><span></span><code><span class="n">xTaskCreate</span><span class="w"> </span>
<span class="w">   </span><span class="mf">1.</span><span class="w"> </span><span class="n">åˆ†é…ä¸€ä¸ªæ ˆç©ºé—´</span>
<span class="w">    </span><span class="cm">/* Allocate space for the stack used by the task being created. */</span>
<span class="w">    </span><span class="n">pxStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pvPortMalloc</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">usStackDepth</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="w"> </span><span class="n">StackType_t</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="n">pxNewTCB</span><span class="o">-&gt;</span><span class="n">pxStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pxStack</span><span class="p">;</span>
<span class="w">    </span><span class="mf">2.</span><span class="w"> </span><span class="n">åˆå§‹åŒ–æ–°ä»»åŠ¡</span>
<span class="w">    </span><span class="n">prvInitialiseNewTask</span><span class="p">(</span><span class="w"> </span><span class="n">pxTaskCode</span><span class="p">,</span><span class="w"> </span><span class="n">pcName</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">usStackDepth</span><span class="p">,</span><span class="w"> </span><span class="n">pvParameters</span><span class="p">,</span><span class="w"> </span><span class="n">uxPriority</span><span class="p">,</span><span class="w"> </span><span class="n">pxCreatedTask</span><span class="p">,</span><span class="w"> </span><span class="n">pxNewTCB</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="mf">2.1</span><span class="w"> </span><span class="n">æ›´æ–°pxTopOfStack</span>
<span class="w">        </span><span class="n">pxTopOfStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="w"> </span><span class="n">pxNewTCB</span><span class="o">-&gt;</span><span class="n">pxStack</span><span class="p">[</span><span class="w"> </span><span class="n">ulStackDepth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="n">pxTopOfStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">StackType_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">portPOINTER_SIZE_TYPE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">pxTopOfStack</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">portPOINTER_SIZE_TYPE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">portBYTE_ALIGNMENT_MASK</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="mf">2.2</span><span class="w"> </span><span class="n">åˆå§‹åŒ–æ ˆ</span>
<span class="w">        </span><span class="n">pxNewTCB</span><span class="o">-&gt;</span><span class="n">pxTopOfStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pxPortInitialiseStack</span><span class="p">(</span><span class="w"> </span><span class="n">pxTopOfStack</span><span class="p">,</span><span class="w"> </span><span class="n">pxTaskCode</span><span class="p">,</span><span class="w"> </span><span class="n">pvParameters</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="n">åˆå§‹åŒ–æ ˆå</span><span class="err">ï¼Œ</span><span class="n">pxNewTCB</span><span class="o">-&gt;</span><span class="n">pxTopOfStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pxTopOfStack</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">Size</span>
</code></pre></div>
<h2 id="_3">åˆå§‹åŒ–æ ˆ</h2>
<div class="codehilite"><pre><span></span><code><span class="nl">pxPortInitialiseStack</span><span class="p">:</span>
<span class="cp">#if defined(CONFIG_ARCH_RISCV_FPU) &amp;&amp; !defined(CONFIG_SAVE_RISCV_FPU_CONTEXT_IN_TCB)</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">FPU_CONTEXT_SIZE</span><span class="p">)</span>
<span class="w">    </span><span class="cm">/* set fpu rounding mode field to 0(Round to Nearest, ties to Even) when create new thread,</span>
<span class="cm">     * otherwise it\'s possible that the rounding mode filed is invalid and</span>
<span class="cm">     * cause the illegal instruction exception when restore the fcsr.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">FPU_CTX_FCSR_OFFSET</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span>
<span class="w">    </span><span class="n">csrr</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">mstatus</span><span class="w">                    </span><span class="cm">/* Obtain current mstatus value. */</span>
<span class="w">    </span><span class="n">andi</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="mh">0x8</span><span class="w">                   </span><span class="cm">/* Ensure interrupts are disabled when the stack is restored within an ISR.  Required when a task is created after the schedulre has been started, otherwise interrupts would be disabled anyway. */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x188</span><span class="w">                  </span><span class="cm">/* Generate the value 0x1880, which are the MPIE and MPP bits to set in mstatus. */</span>
<span class="w">    </span><span class="n">slli</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="n">or</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="w">                       </span><span class="cm">/* Set MPIE and MPP bits in mstatus value. */</span>

<span class="cp">#ifdef CONFIG_SAVE_RISCV_FPU_CONTEXT_IN_TCB</span>
<span class="w">    </span><span class="cm">/* set FS filed(in thread stack) to initial state for skip save/restore FPU context operation */</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">SR_FS</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">SR_FS_INITIAL</span>
<span class="w">    </span><span class="n">not</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span>
<span class="w">    </span><span class="n">and</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t3</span>
<span class="w">    </span><span class="n">or</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span><span class="w">                   </span><span class="cm">/* mstatus onto the stack. */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="mi">22</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">)</span><span class="w">  </span><span class="cm">/* Space for registers x11-x31. */</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span><span class="w">                   </span><span class="cm">/* Task parameters (pvParameters parameter) goes into register X10/a0 on the stack. */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">)</span><span class="w">   </span><span class="cm">/* Space for registers x5-x9. */</span>
<span class="w">    </span><span class="n">la</span><span class="w">   </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">portTASK_RETURN_ADDRESS</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span><span class="w">                   </span><span class="cm">/* Return address onto the stack, could be portTASK_RETURN_ADDRESS */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">portasmADDITIONAL_CONTEXT_SIZE</span><span class="w"> </span><span class="cm">/* The number of chip specific additional registers. */</span>
<span class="nl">chip_specific_stack_frame</span><span class="p">:</span><span class="w">              </span><span class="cm">/* First add any chip specific registers to the stack frame being created. */</span>
<span class="w">    </span><span class="n">beq</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mf">1f</span><span class="w">                      </span><span class="cm">/* No more chip specific registers to save. */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span><span class="w">         </span><span class="cm">/* Make space for chip specific register. */</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span><span class="w">                   </span><span class="cm">/* Give the chip specific register an initial value of zero. */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="w">                     </span><span class="cm">/* Decrement the count of chip specific registers remaining. */</span>
<span class="w">    </span><span class="n">j</span><span class="w"> </span><span class="n">chip_specific_stack_frame</span><span class="w">         </span><span class="cm">/* Until no more chip specific registers. */</span>
<span class="mi">1</span><span class="o">:</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portWORD_SIZE</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span><span class="w">                   </span><span class="cm">/* mret value (pxCode parameter) onto the stack. */</span><span class="w"> </span>
<span class="w">    </span><span class="n">ret</span>
<span class="w">    </span><span class="p">.</span><span class="n">endfunc</span>
</code></pre></div>
<p>ç»è¿‡pxPortInitialiseStackåˆå§‹åŒ–åå­˜å‚¨å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_287d5adca82e4cebb65d666347e94fd1.jpg"><img alt="" src="assets/doc/02-risc-v/risc-væ¶æ„ä¸freertosä»»åŠ¡è°ƒåº¦/images/wp_editor_md_287d5adca82e4cebb65d666347e94fd1.jpg"/></a></p>
<h2 id="_4">ç¬¬ä¸€ä¸ªä»»åŠ¡æ ˆæ¢å¤</h2>
<div class="codehilite"><pre><span></span><code><span class="nl">xPortStartFirstTask</span><span class="p">:</span>

<span class="cp">#if( portasmHAS_SIFIVE_CLINT != 0 )</span>
<span class="w">    </span><span class="cm">/* If there is a clint then interrupts can branch directly to the FreeRTOS</span>
<span class="cm">    trap handler.  Otherwise the interrupt controller will need to be configured</span>
<span class="cm">    outside of this file. */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">freertos_risc_v_trap_handler</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mtvec</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>
<span class="cp">#endif </span><span class="cm">/* portasmHAS_CLILNT */</span>

<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">pxCurrentTCB</span><span class="w">            </span><span class="cm">/* åŠ è½½å½“å‰TCB */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">t0</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* è·å–å½“å‰TCBçš„æ ˆç©ºé—´*/</span>

<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* åŠ è½½è¿”å›åœ°å€ï¼Œå³ä»»åŠ¡å…¥å£å‡½æ•° */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* t1 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* t2 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* s0/fp */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* s1 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x10</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">    </span><span class="cm">/* a0 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">    </span><span class="cm">/* a1 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">    </span><span class="cm">/* a2 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x13</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a3 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x14</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a4 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x15</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a5 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x16</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a6 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a7 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x18</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s2 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x19</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s3 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x20</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s4 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x21</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s5 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x22</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s6 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x23</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s7 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s8 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x25</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s9 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x26</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s10 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x27</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s11 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x28</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t3 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t4 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t5 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x31</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t6 */</span>

<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">    </span><span class="cm">/* Initial mstatus into x5 (t0) */</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span><span class="w">                       </span><span class="cm">/* Set MIE bit so the first task starts with interrupts enabled - required as returns with ret not eret. */</span>
<span class="w">    </span><span class="n">csrrw</span><span class="w">  </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">mstatus</span><span class="p">,</span><span class="w"> </span><span class="n">x5</span><span class="w">                  </span><span class="cm">/* Interrupts enabled from here! */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="cm">/* Initial x5 (t0) value. */</span>

<span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">portCONTEXT_SIZE</span><span class="w">         </span><span class="cm">/*é”€æ¯æ ˆç©ºé—´ï¼ŒSPå·²ç»æ›´æ–°*/</span>
<span class="cp">#if 0</span>
<span class="c">    load_x      t0, pxCurrentTCB        /* Load pxCurrentTCB. */</span>
<span class="c">    store_x     sp, 0( t0 )             /* Write sp to first TCB member. */</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">æ›´æ–°æ ˆé¡¶æŒ‡é’ˆ</span><span class="err">ï¼Œ</span><span class="n">ä¸Šé¢ä¸¤å¥ä¸æ‰§è¡Œä¹Ÿè¡Œ</span><span class="err">ï¼Œ</span><span class="n">å› ä¸ºä»»åŠ¡æ‰§è¡Œæ—¶</span><span class="err">ï¼Œ</span><span class="n">spçš„å€¼å·²ç»æ›´æ–°äº†</span><span class="err">ï¼Œ</span><span class="n">ä»»åŠ¡ç”¨çš„æ˜¯SP</span><span class="err">ï¼Œ</span>
<span class="w">    </span><span class="n">è€Œä¸æ˜¯pxCurrentTCB</span><span class="o">-&gt;</span><span class="n">pxTopOfStack</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">ret</span>
<span class="w">    </span><span class="p">.</span><span class="n">endfunc</span>
<span class="cm">/*-----------------------------------------------------------*/</span>
</code></pre></div>
<h2 id="_5">ä»»åŠ¡åˆ‡æ¢æ ˆå˜åŒ–</h2>
<div class="codehilite"><pre><span></span><code><span class="nl">clic_interrupt_handler</span><span class="p">:</span>
<span class="w">    </span><span class="mf">1.</span><span class="w"> </span><span class="n">ä»»åŠ¡åœ¨è¿è¡Œè¿‡ç¨‹ä¸­</span><span class="err">ï¼Œ</span><span class="n">è¢«ä¸­æ–­æ‰“æ–­</span><span class="err">ï¼Œ</span><span class="n">å…ˆåˆ†é…ä¸€å—æ ˆå¸§</span><span class="err">ï¼Œ</span><span class="n">ä¿å­˜ç°åœº</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">portCONTEXT_SIZE</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x5</span><span class="p">,</span><span class="w">  </span><span class="mi">2</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x6</span><span class="p">,</span><span class="w">  </span><span class="mi">3</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x7</span><span class="p">,</span><span class="w">  </span><span class="mi">4</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x8</span><span class="p">,</span><span class="w">  </span><span class="mi">5</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x9</span><span class="p">,</span><span class="w">  </span><span class="mi">6</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x10</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x13</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x14</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x15</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x16</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x18</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x19</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x20</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x21</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x22</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x23</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x25</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x26</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x27</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x28</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x31</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w">  </span><span class="mi">31</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w">  </span><span class="mi">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>

<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">portCONTEXT_SIZE</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w">  </span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>

<span class="w">    </span><span class="n">csrr</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">mepc</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">csrr</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">mscratch</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>

<span class="w">    </span><span class="n">csrr</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">mstatus</span>
<span class="w">    </span><span class="n">store_x</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>

<span class="w">    </span><span class="mf">2.</span><span class="w"> </span><span class="n">å› ä¸ºåˆ†é…äº†ä¸€æ®µæ ˆç©ºé—´</span><span class="err">ï¼Œ</span><span class="n">æ‰€ä»¥éœ€è¦å°†æ ˆé¡¶æŒ‡é’ˆæ›´æ–°åˆ°pxCurrentTCB</span><span class="o">-&gt;</span><span class="n">pxTopOfStack</span>
<span class="w">       </span><span class="n">åˆ°è¿™é‡Œ</span><span class="err">ï¼Œ</span><span class="n">è¿™æ ·ä»»åŠ¡çš„ä¸Šä¸‹æ–‡å°±ä¿å­˜å¥½äº†</span><span class="err">ï¼Œ</span><span class="n">å¯ä»¥è¿è¡Œä¸­æ–­å‡½æ•°</span><span class="err">ï¼Œ</span><span class="n">æˆ–åˆ‡æ¢åˆ°å…¶ä»–ä»»åŠ¡</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">lw</span><span class="w">      </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">pxCurrentTCB</span><span class="w">        </span><span class="cm">/* Load pxCurrentTCB. */</span>
<span class="w">    </span><span class="n">sw</span><span class="w">      </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="w"> </span><span class="n">t0</span><span class="w"> </span><span class="p">)</span><span class="w">             </span><span class="cm">/* Write sp to first TCB member. */</span>

<span class="w">    </span><span class="mf">3.</span><span class="w"> </span><span class="n">åŠ è½½ä¸­æ–­çš„æ ˆç©ºé—´</span><span class="err">ï¼Œ</span><span class="n">æ‰§è¡Œä¸­æ–­å¤„ç†å‡½æ•°</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">load_x</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">xISRStackTop</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">enter_interrupt_handler</span>
<span class="w">    </span><span class="n">csrr</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">mcause</span>
<span class="w">    </span><span class="n">andi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7FF</span><span class="w">           </span><span class="cm">/* If the CLIC support more than 2048 interrupts, we need to use the mask value saved in register */</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">irq_core_handle_root_ic_irq</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">exit_interrupt_handler</span>

<span class="w">    </span><span class="mf">4.</span><span class="w"> </span><span class="n">è·å–ä»»åŠ¡çš„æ§åˆ¶å—</span><span class="err">ï¼Œ</span><span class="n">è¿™é‡Œçš„ä»»åŠ¡å¯èƒ½æ˜¯åŸæ¥çš„ä»»åŠ¡</span><span class="err">ï¼Œ</span><span class="n">ä¹Ÿå¯èƒ½æ˜¯æ–°çš„ä»»åŠ¡</span>
<span class="w">    </span><span class="n">åœ¨ä¸­æ–­å¤„ç†å‡½æ•°ä¸­</span><span class="err">ï¼Œ</span><span class="n">ä¼šè¿›è¡Œè°ƒåº¦</span><span class="err">ï¼Œ</span><span class="n">æ›´æ–°pxCurrentTCB</span><span class="p">,</span><span class="n">ä¹‹åè·å–pxCurrentTCB</span><span class="o">-&gt;</span><span class="n">pxTopOfStack</span>
<span class="w">    </span><span class="n">è¿™æ ·å°±æ‰¾åˆ°äº†æ–°ä»»åŠ¡çš„æ ˆç©ºé—´</span>
<span class="w">    </span><span class="n">lw</span><span class="w">      </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">pxCurrentTCB</span><span class="w">            </span><span class="cm">/* Load pxCurrentTCB. */</span>
<span class="w">    </span><span class="n">lw</span><span class="w">      </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="p">)</span><span class="w">                 </span><span class="cm">/* Read sp from first TCB member. */</span>

<span class="w">    </span><span class="mf">5.</span><span class="w"> </span><span class="n">æ ˆç©ºé—´çš„ç¬¬ä¸€ä¸ªä¿å­˜çš„å¼€å§‹è¦è¿è¡Œçš„åœ°å€</span><span class="err">ï¼Œ</span><span class="n">åŠ è½½å‡ºæ¥å†™å…¥åˆ°mepcä¸­</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mepc</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>

<span class="w">    </span><span class="cm">/* Load mstatus with the interrupt enable bits used by the task. */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mstatus</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>

<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mscratch</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>

<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x1</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x5</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">       </span><span class="cm">/* t0 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x6</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">       </span><span class="cm">/* t1 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x7</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">       </span><span class="cm">/* t2 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x8</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">       </span><span class="cm">/* s0/fp */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x9</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">       </span><span class="cm">/* s1 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x10</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a0 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a1 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a2 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x13</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a3 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x14</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a4 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x15</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a5 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x16</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a6 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* a7 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x18</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s2 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x19</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s3 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x20</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s4 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x21</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s5 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x22</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s6 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x23</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s7 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s8 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x25</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s9 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x26</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s10 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x27</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* s11 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x28</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t3 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t4 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t5 */</span>
<span class="w">    </span><span class="n">load_x</span><span class="w">  </span><span class="n">x31</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">portWORD_SIZE</span><span class="p">(</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="cm">/* t6 */</span>

<span class="w">   </span><span class="mf">6.</span><span class="n">ä¸Šä¸‹æ–‡å·²ç»æ¢å¤</span><span class="err">ï¼Œ</span><span class="n">é”€æ¯æ‰æ ˆç©ºé—´</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">portCONTEXT_SIZE</span>

<span class="w">   </span><span class="mf">7.</span><span class="w"> </span><span class="n">ä¸‹é¢ä¸¤å¥</span><span class="err">ï¼Œ</span><span class="n">å¯ä»¥ä¸æ‰§è¡Œ</span><span class="err">ï¼Œ</span><span class="n">å› ä¸ºmretä¹‹åå°±åˆ‡åˆ°ä»»åŠ¡ä¸­è¿è¡Œäº†</span><span class="err">ï¼Œ</span><span class="n">spå·²ç»æ›´æ–°</span><span class="err">ã€‚</span>
<span class="cp">#if 0</span>
<span class="c">    load_x      t0, pxCurrentTCB        /* Load pxCurrentTCB. */</span>
<span class="c">    store_x     sp, 0( t0 )             /* Write sp to first TCB member. */</span>
<span class="cp">#endif</span>

<span class="w">   </span><span class="mf">8.</span><span class="w"> </span><span class="n">è¿”å›åˆ°ä»»åŠ¡ä¸­è¿è¡Œ</span><span class="err">ï¼Œ</span>
<span class="w">    </span><span class="n">mret</span>
</code></pre></div>
<p>pxCurrentTCB-&gt;pxTopOfStackçš„å˜åŒ–</p>
<ol>
<li>pxPortInitialiseStackåˆå§‹åŒ–æ ˆï¼Œåˆ†é…ä¸€æ®µæ ˆç©ºé—´ï¼Œè®¾ç½®pxCurrentTCB-&gt;pxTopOfStackåˆå€¼ã€‚è¿™æ®µæ ˆç©ºé—´åœ¨ä»»åŠ¡å¾—åˆ°è¿è¡Œæ—¶ä¼šå°†pxCurrentTCB-&gt;pxTopOfStackèµ‹å€¼ä¸ºspï¼Œæ¥ç€æ¢å¤ä¸Šä¸‹æ–‡è¿è¡Œã€‚ä»»åŠ¡å¾—åˆ°è¿è¡Œæœ‰ä¸¤ç§åœºæ™¯</li>
</ol>
<ul>
<li>xPortStartFirstTaskï¼šè¿™ç§ä»»åŠ¡æ˜¯ä¼˜å…ˆçº§æ¯”è¾ƒé«˜ï¼Œç³»ç»Ÿåˆå§‹åŒ–å®Œæˆåä¼šæŒ‘é€‰ç¬¬ä¸€ä¸ªä»»åŠ¡è¿›è¡Œè¿è¡Œï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä¼šæ¢å¤ä¸Šä¸‹æ–‡ï¼Œæ¥ç€æ›´æ–°spçš„å€¼è¿›è€Œé”€æ¯æ ˆç©ºé—´ï¼Œä½†æ˜¯æ²¡æœ‰æ›´æ–°pxCurrentTCB-&gt;pxTopOfStackçš„å€¼ï¼ˆè¯¥å€¼æ˜¯å¦æ›´æ–°ä¸å½±å“ï¼Œspå·²ç»æ›´æ–°äº†ï¼‰ã€‚</li>
<li>å…¶ä»–ä»»åŠ¡è®©å‡ºå¾—åˆ°è°ƒåº¦ï¼šè¿™ç§åœºæ™¯æ˜¯å¾—åˆ°è°ƒåº¦æœºä¼šï¼Œåœ¨ä¸­æ–­ä¸­è¿›è¡Œæ¢å¤ä¸Šä¸‹æ–‡ï¼ˆä¸Šé¢ä»£ç çš„ç¬¬4ç‚¹ç‚¹å¼€å§‹ï¼‰ï¼Œ</li>
</ul>
<ol start="2">
<li>è¿è¡Œè¿‡ç¨‹ä¸­è¢«ä¸­æ–­æ‰“æ–­ï¼ˆå¯èƒ½æ˜¯ä¸­æ–­ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ—¶é—´ç‰‡ç”¨å®Œï¼‰ï¼Œåˆ†é…ä¸€æ®µæ ˆç©ºé—´ç”¨äºä¿å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ä¸Šé¢ä»£ç ç¬¬1ç‚¹å°±æ˜¯å¼€è¾Ÿä¸€æ®µæ ˆç©ºé—´ï¼Œè¿›è¡Œä¿å­˜ä¸Šä¸‹æ–‡ï¼Œä¿å­˜ä¸Šä¸‹æ–‡åï¼Œå› ä¸ºå¯èƒ½ä¼šè®©å‡ºè°ƒåº¦ï¼Œå› æ­¤éœ€è¦æ›´æ–°pxCurrentTCB-&gt;pxTopOfStackï¼Œä¸Šè¿°ä»£ç çš„ç¬¬äºŒç‚¹ã€‚</li>
</ol>
<p>ä¸ºä»€ä¹ˆåªçœ‹åˆ°ç¬¬1ç‚¹ä¸­SPå¼€è¾Ÿäº†ï¼Œæ›´æ–°åˆ°pxCurrentTCB-&gt;pxTopOfStackåï¼Œæ²¡æœ‰è§å“ªé‡Œå½’è¿˜ï¼Œæ˜¯å¦æœ‰æ ˆæ³„éœ²ï¼Ÿ ç­”ï¼šåœ¨ä»»åŠ¡å†æ¬¡å¾—åˆ°è¿è¡Œçš„æ—¶å€™ï¼Œä¼šè¿›è¡Œå½’è¿˜ï¼Œä¸Šé¢ç¬¬6ç‚¹å°±æ˜¯ï¼ŒSPè¿›è¡Œçš„å¢åŠ ï¼Œé‡Šæ”¾çš„æ ˆç©ºé—´ï¼Œåªæ˜¯æ²¡æœ‰å†™åˆ°pxCurrentTCB-&gt;pxTopOfStackï¼Œè€Œå½“ä»»åŠ¡åœ¨è¿è¡Œè¿‡ç¨‹ä¸­è¢«æ‰“æ–­è¿›å…¥ä¸­æ–­åï¼Œspæ˜¯å·²ç»é‡Šæ”¾åçš„spï¼Œè€Œå³ä½¿åœ¨ç¬¬1ç‚¹ä¸­å¼€è¾Ÿç©ºé—´ï¼Œä¹Ÿæ˜¯å½’è¿˜åï¼Œå†å¼€è¾Ÿçš„ï¼Œæ‰€ä»¥ä¸å­˜åœ¨æ³„éœ²ã€‚</p>
<h2 id="_6">è·Ÿè¸ªä¸€ä¸ªä»»åŠ¡è¿è¡Œæ ˆçš„å˜åŒ–å®ä¾‹</h2>
<h3 id="_7">åˆå§‹åŒ–æ ˆ</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_b643046527b646f1aae2523cbeb3094c.jpg"><img alt="" src="assets/doc/02-risc-v/risc-væ¶æ„ä¸freertosä»»åŠ¡è°ƒåº¦/images/wp_editor_md_b643046527b646f1aae2523cbeb3094c.jpg"/></a></p>
<p>åˆå§‹åŒ–æ—¶å¼€è¾Ÿäº†ä¸€ä¸ªæ ˆç©ºé—´ï¼Œæ ˆå¸§æŒ‡å‘0x6007af78ä½ç½®ã€‚</p>
<h3 id="_8">è°ƒåº¦å¾—åˆ°è¿è¡Œ</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_46a035fdb69ff2ed6e06238e8c672f1c.jpg"><img alt="" src="assets/doc/02-risc-v/risc-væ¶æ„ä¸freertosä»»åŠ¡è°ƒåº¦/images/wp_editor_md_46a035fdb69ff2ed6e06238e8c672f1c.jpg"/></a></p>
<h3 id="_9">æ¢å¤ä¸Šä¸‹æ–‡</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_5f7ec07ec58c4cdfc85a901159c901dd.jpg"><img alt="" src="assets/doc/02-risc-v/risc-væ¶æ„ä¸freertosä»»åŠ¡è°ƒåº¦/images/wp_editor_md_5f7ec07ec58c4cdfc85a901159c901dd.jpg"/></a></p></div>
  <div class="post-nav">
    <a class="prev" href="qemu-opensbi-uboot-linux-busyboxå¯åŠ¨ç¯å¢ƒæ­å»º.html">â† qemu+opensbi+uboot+linux+busyboxå¯åŠ¨ç¯å¢ƒæ­å»º</a>
    <a class="next" href="å¹³å¤´å“¥e90xçš„head-såˆ†æ.html">å¹³å¤´å“¥E90Xçš„head.Såˆ†æ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

