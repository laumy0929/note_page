<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>lerobot ACTå®ç°åˆ†æ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#actconfig">é…ç½®ç±»ACTConfig</a><ul><li><a href="#_1">è¾“å…¥/è¾“å‡ºç»“æ„</a></li><li><a href="#_2">æ¶æ„é…ç½®</a></li></ul></li><li><a href="#actpolicy">ç­–ç•¥å…¥å£ç±»ACTPolicy</a><ul><li><a href="#_3">åˆå§‹åŒ–é€»è¾‘</a></li><li><a href="#_4">æ¨ç†é€»è¾‘</a></li><li><a href="#_5">è®­ç»ƒæŸå¤±è®¡ç®—</a></li></ul></li><li><a href="#act">æ ¸å¿ƒç®—æ³•ACT</a><ul><li><a href="#_6">æ•´ä½“ç»“æ„</a></li><li><a href="#forward">forwardæ–¹æ³•</a></li></ul></li><li><a href="#act_1">ACTç¼–ç å™¨</a><ul><li><a href="#actencoder">ACTEncoder</a></li><li><a href="#actencoderlayer">ACTEncoderLayer</a></li></ul></li><li><a href="#act_2">ACTè§£ç å™¨</a><ul><li><a href="#actdecoder">ACTDecoder</a></li><li><a href="#actdecoderlayer">ACTDecoderLayer</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>lerobot ACTå®ç°åˆ†æ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2025-08-04
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      ai
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="actconfig">é…ç½®ç±»ACTConfig</h2>
<div class="codehilite"><pre><span></span><code><span class="nd">@PreTrainedConfig</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">"act"</span><span class="p">)</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ACTConfig</span><span class="p">(</span><span class="n">PreTrainedConfig</span><span class="p">):</span>
    <span class="c1"># è¾“å…¥/è¾“å‡ºç»“æ„</span>
    <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># åŠ¨ä½œå—é•¿åº¦ï¼ˆæ¯æ¬¡é¢„æµ‹çš„åŠ¨ä½œåºåˆ—é•¿åº¦ï¼‰</span>
    <span class="n">n_action_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># æ¯æ¬¡ç­–ç•¥è°ƒç”¨æ‰§è¡Œçš„åŠ¨ä½œæ­¥æ•°ï¼ˆâ‰¤ chunk_sizeï¼‰</span>
    <span class="n">temporal_ensemble_coeff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># æ—¶åºé›†æˆç³»æ•°ï¼ˆNoneè¡¨ç¤ºç¦ç”¨ï¼‰</span>

    <span class="c1"># VAEé…ç½®</span>
    <span class="n">use_vae</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># æ˜¯å¦å¯ç”¨VAEï¼ˆå¢å¼ºåŠ¨ä½œå¤šæ ·æ€§ï¼‰</span>
    <span class="n">latent_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># æ½œåœ¨ç©ºé—´ç»´åº¦</span>
    <span class="n">kl_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span>  <span class="c1"># KLæ•£åº¦æŸå¤±æƒé‡</span>

    <span class="c1"># Transformeré…ç½®</span>
    <span class="n">dim_model</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span>  <span class="c1"># Transformeréšè—ç»´åº¦</span>
    <span class="n">n_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># æ³¨æ„åŠ›å¤´æ•°</span>
    <span class="n">n_encoder_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># ç¼–ç å™¨å±‚æ•°</span>
    <span class="n">n_decoder_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># è§£ç å™¨å±‚æ•°ï¼ˆåŸå§‹å®ç°bugï¼Œä»…ç”¨ç¬¬1å±‚ï¼‰</span>

    <span class="c1"># è§†è§‰Backbone</span>
    <span class="n">vision_backbone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"resnet18"</span>  <span class="c1"># å›¾åƒç‰¹å¾æå–ç½‘ç»œ</span>
    <span class="o">......</span>
</code></pre></div>
<p>ACTConfigæ˜¯ACTç®—æ³•æ ¸å¿ƒé…ç½®ç±»ï¼Œä¸»è¦å®šä¹‰äº†æ¨¡å‹ç»“æ„ã€è¾“å…¥è¾“å‡ºæ ¼å¼ã€è®­ç»ƒå‚æ•°å’Œæ¨ç†é€»è¾‘ç­‰ã€‚</p>
<h3 id="_1">è¾“å…¥/è¾“å‡ºç»“æ„</h3>
<p>å‚æ•°ä¸»è¦é…ç½®æ¨¡å‹è¾“å…¥è§‚æµ‹ã€è¾“å‡ºåŠ¨ä½œçš„åŸºæœ¬æ ¼å¼ï¼Œæ˜¯è¿æ¥ç¯å¢ƒä¸æ¨¡å‹çš„æ¡¥æ¢ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Input / output structure.</span>
<span class="n">n_obs_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># è¾“å…¥è§‚æµ‹çš„æ—¶é—´æ­¥æ•°ï¼ˆå½“å‰ä»…æ”¯æŒ1æ­¥è§‚æµ‹ï¼Œå³å½“å‰æ—¶åˆ»è§‚æµ‹ï¼‰</span>
<span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># åŠ¨ä½œå—é•¿åº¦ï¼šæ¯æ¬¡é¢„æµ‹çš„è¿ç»­åŠ¨ä½œåºåˆ—é•¿åº¦ï¼ˆæ ¸å¿ƒå‚æ•°ï¼Œå†³å®šåˆ†å—ç²’åº¦ï¼‰</span>
<span class="n">n_action_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># æ¯æ¬¡ç­–ç•¥è°ƒç”¨æ‰§è¡Œçš„åŠ¨ä½œæ­¥æ•°ï¼ˆâ‰¤ chunk_sizeï¼Œé»˜è®¤ä¸chunk_sizeä¸€è‡´ï¼Œå³ä¸€æ¬¡æ‰§è¡Œæ•´æ®µåŠ¨ä½œå—ï¼‰</span>

<span class="n">normalization_mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NormalizationMode</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
    <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"VISUAL"</span><span class="p">:</span> <span class="n">NormalizationMode</span><span class="o">.</span><span class="n">MEAN_STD</span><span class="p">,</span>  <span class="c1"># å›¾åƒç‰¹å¾å½’ä¸€åŒ–ï¼šå‡å‡å€¼é™¤æ ‡å‡†å·®</span>
        <span class="s2">"STATE"</span><span class="p">:</span> <span class="n">NormalizationMode</span><span class="o">.</span><span class="n">MEAN_STD</span><span class="p">,</span>   <span class="c1"># çŠ¶æ€ç‰¹å¾ï¼ˆå¦‚æœºå™¨äººå…³èŠ‚è§’ï¼‰å½’ä¸€åŒ–ï¼šåŒä¸Š</span>
        <span class="s2">"ACTION"</span><span class="p">:</span> <span class="n">NormalizationMode</span><span class="o">.</span><span class="n">MEAN_STD</span><span class="p">,</span>  <span class="c1"># åŠ¨ä½œå½’ä¸€åŒ–ï¼šåŒä¸Šï¼ˆç¡®ä¿è®­ç»ƒæ—¶è¾“å…¥åˆ†å¸ƒç¨³å®šï¼‰</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div>
<ul>
<li>chunk_size æ˜¯ ACT ç®—æ³•çš„æ ¸å¿ƒè®¾è®¡ï¼šå°†é•¿æ—¶åºåŠ¨ä½œç”Ÿæˆåˆ†è§£ä¸ºå›ºå®šé•¿åº¦çš„â€œåŠ¨ä½œå—â€ï¼ˆå¦‚100æ­¥ï¼‰ï¼Œé¿å…ä¸€æ¬¡æ€§è§„åˆ’æ•´ä¸ªä»»åŠ¡åºåˆ—ï¼Œé™ä½è®¡ç®—å¤æ‚åº¦ã€‚</li>
<li>n_action_steps æ§åˆ¶æ¯æ¬¡ç­–ç•¥è°ƒç”¨åå®é™…æ‰§è¡Œçš„åŠ¨ä½œæ­¥æ•°ã€‚ä¾‹å¦‚ï¼Œè‹¥ chunk_size=100 ä¸” n_action_steps=50ï¼Œåˆ™æ¨¡å‹é¢„æµ‹100æ­¥åŠ¨ä½œï¼Œæ‰§è¡Œå‰50æ­¥ï¼Œä¸¢å¼ƒå50æ­¥ï¼ˆé€‚ç”¨äºéœ€è¦é¢‘ç¹é‡æ–°è§„åˆ’çš„åœºæ™¯ï¼‰ã€‚</li>
</ul>
<h3 id="_2">æ¶æ„é…ç½®</h3>
<p>ä»æ­¤å‰çš„<a href="https://www.laumy.tech/2431.html" title="ä¸Šä¸€ç¯‡æ–‡ç« ">å…·èº«æ™ºèƒ½ACTç®—æ³•</a>æˆ‘ä»¬çŸ¥é“ACTæ¨¡å‹ç®—æ³•ä¸»è¦æ˜¯åŸºäºtransformerç»“æ„ï¼Œä»å®ç°ä¸Šæ¨¡å‹çš„æ ¸å¿ƒç»„ä»¶å¯ä»¥åˆ†ä¸ºè§†è§‰backboneã€transformerã€VAEç»“æ„ã€‚</p>
<p><strong>ï¼ˆ1ï¼‰è§†è§‰backboneé…ç½®</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Vision backbone.</span>
<span class="n">vision_backbone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"resnet18"</span>  <span class="c1"># è§†è§‰ç‰¹å¾æå–ç½‘ç»œï¼šä½¿ç”¨ResNet18ï¼ˆè½»é‡çº§ï¼Œé€‚åˆå®æ—¶æ§åˆ¶ï¼‰</span>
<span class="n">pretrained_backbone_weights</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">"ResNet18_Weights.IMAGENET1K_V1"</span>  <span class="c1"># é¢„è®­ç»ƒæƒé‡ï¼šä½¿ç”¨ImageNet-1Ké¢„è®­ç»ƒå‚æ•°åˆå§‹åŒ–ï¼Œæå‡ç‰¹å¾æå–èƒ½åŠ›</span>
<span class="n">replace_final_stride_with_dilation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># æ˜¯å¦ç”¨ç©ºæ´å·ç§¯æ›¿æ¢ResNetçš„æœ€ç»ˆ2x2 strideï¼ˆé»˜è®¤å…³é—­ï¼Œä¿æŒç‰¹å¾å›¾åˆ†è¾¨ç‡ï¼‰</span>
</code></pre></div>
<p>ä¸Šé¢çš„å‚æ•°æ˜¯ACTç®—æ³•ä¸­ç”¨äºå›¾åƒç‰¹å¾æå–æ¨¡å—çš„æ ¸å¿ƒé…ç½®ï¼Œå½±å“æ¨¡å‹å¯¹è§†è§‰è¾“å…¥çš„ç†è§£èƒ½åŠ›å’Œè®¡ç®—æ•ˆç‡ã€‚</p>
<p>é¦–å…ˆæŒ‡å®šäº†å›¾åƒç‰¹å¾æå–çš„éª¨å¹²ç½‘ç»œä¸ºresnet18ï¼Œå…¶ä»…æœ‰18å±‚ç½‘ç»œï¼Œå‚æ•°é‡çº¦1100ä¸‡ï¼Œå¸¸ç”¨äºå®æ—¶æœºå™¨äººæ§åˆ¶åœºæ™¯ï¼ŒResNetæ˜¯é€šè¿‡æ®‹å·®è¿æ¥ç¼“è§£æ·±å±‚ç½‘ç»œæ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œèƒ½æœ‰æ•ˆæå–å¤šå°ºåº¦å›¾åƒç‰¹å¾åŒ…æ‹¬è¾¹ç¼˜çº¹ç†åˆ°è¯­ä¹‰ä¿¡æ¯ã€‚è§†è§‰ Backbone çš„è¾“å‡ºï¼ˆå¦‚ ResNet-18 çš„ layer4 ç‰¹å¾å›¾ï¼‰ä¼šè¢«å±•å¹³ä¸ºåºåˆ—ï¼Œä¸æœºå™¨äººçŠ¶æ€ã€æ½œåœ¨å‘é‡ç­‰å¤šæ¨¡æ€ç‰¹å¾æ‹¼æ¥åè¾“å…¥ Transformer ç¼–ç å™¨ã€‚</p>
<p>å…¶æ¬¡æŒ‡å®šäº†resnet18é¢„è®­ç»ƒæƒé‡çš„æ¥æºï¼Œé»˜è®¤ä½¿ç”¨ä½¿ç”¨ ImageNet-1K æ•°æ®é›†é¢„è®­ç»ƒçš„æƒé‡ã€‚</p>
<p>æœ€åçš„replace_final_stride_with_dilationé»˜è®¤å…³é—­ï¼Œä¸»è¦æ˜¯æ§åˆ¶æ˜¯å¦ç”¨â€œç©ºæ´å·ç§¯â€æ›¿æ¢resnetæœ€åä¸€å±‚çš„2*2æ­¥å¹…å·ç§¯ã€‚å…³é—­ç©ºæ´å·ç§¯é€‚åˆå¯¹å®æ—¶æ€§è¦æ±‚é«˜ã€ç‰¹å¾åˆ†è¾¨ç‡è¦æ±‚ä½çš„åœºæ™¯ï¼Œå¦‚ç²—ç²’åº¦æŠ“å–ä»»åŠ¡ã€‚å¦‚æœæ‰“å¼€å¯ä¿ç•™æ›´å¤šçš„ç©ºæ´ç»†èŠ‚ï¼ˆå¦‚ç‰©ä½“è¾¹ç¼˜ã€çº¹ç†ï¼‰ï¼Œé€‚åˆç²¾ç»†æ“ä½œå¦‚èºä¸æ‹§å…¥ã€é›¶ä»¶å¯¹é½ã€ä½†æ˜¯éœ€è¦æƒè¡¡è®¡ç®—é‡å¢åŠ å’Œå†…å­˜çš„å ç”¨ã€‚</p>
<p><strong>ï¼ˆ2ï¼‰transformeré…ç½®</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Transformer layers.</span>
<span class="n">pre_norm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Transformerå—å½’ä¸€åŒ–ä½ç½®ï¼šFalse=åå½’ä¸€åŒ–ï¼ˆåŸå§‹ACTå®ç°ï¼‰ï¼ŒTrue=å‰å½’ä¸€åŒ–ï¼ˆæ›´ç¨³å®šä½†éœ€è°ƒå‚ï¼‰</span>
<span class="n">dim_model</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span>    <span class="c1"># Transformeréšè—å±‚ç»´åº¦ï¼ˆç‰¹å¾ç»´åº¦ï¼‰</span>
<span class="n">n_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>        <span class="c1"># å¤šå¤´æ³¨æ„åŠ›å¤´æ•°ï¼ˆ8å¤´ï¼Œæ€»æ³¨æ„åŠ›ç»´åº¦=512/8=64/å¤´ï¼‰</span>
<span class="n">dim_feedforward</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3200</span>  <span class="c1"># å‰é¦ˆç½‘ç»œä¸­é—´ç»´åº¦ï¼ˆé€šå¸¸ä¸ºdim_modelçš„4-6å€ï¼Œæ­¤å¤„3200=512*6.25ï¼‰</span>
<span class="n">feedforward_activation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"relu"</span>  <span class="c1"># å‰é¦ˆç½‘ç»œæ¿€æ´»å‡½æ•°ï¼ˆReLUï¼ŒåŸå§‹ACTå®ç°ï¼‰</span>
<span class="n">n_encoder_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># Transformerç¼–ç å™¨å±‚æ•°ï¼ˆ4å±‚ï¼Œç”¨äºèåˆå¤šæ¨¡æ€è¾“å…¥ç‰¹å¾ï¼‰</span>
<span class="c1"># æ³¨ï¼šåŸå§‹ACTå®ç°ä¸­n_decoder_layers=7ï¼Œä½†å› ä»£ç bugä»…ä½¿ç”¨ç¬¬1å±‚ï¼Œæ­¤å¤„å¯¹é½åŸå§‹å®ç°è®¾ä¸º1</span>
<span class="n">n_decoder_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Transformerè§£ç å™¨å±‚æ•°ï¼ˆ1å±‚ï¼Œç”¨äºç”ŸæˆåŠ¨ä½œå—åºåˆ—ï¼‰</span>
</code></pre></div>
<p>ä¸Šé¢å‚æ•°å®šä¹‰äº†ACTç®—æ³•ä¸­Transformer ç¼–ç å™¨/è§£ç å™¨çš„æ ¸å¿ƒç»“æ„å‚æ•°ï¼Œç›´æ¥å†³å®šæ¨¡å‹çš„åºåˆ—å»ºæ¨¡èƒ½åŠ›ã€è®¡ç®—æ•ˆç‡å’Œç‰¹å¾èåˆæ•ˆæœã€‚</p>
<ul>
<li>pre_norm: å½’ä¸€åŒ–ä½ç½® ï¼ŒFalse=åŸå§‹è¡Œä¸ºï¼ŒTrue=è®­ç»ƒæ›´ç¨³å®šï¼ˆéœ€é‡æ–°è°ƒå‚ï¼‰ï¼Œè‹¥è®­ç»ƒå‘æ•£ï¼Œå¯å°è¯•è®¾ä¸º Trueã€‚</li>
<li>dim_model:ç‰¹å¾ç»´åº¦ï¼ˆæ¨¡å‹å®¹é‡ï¼‰ï¼Œå¢å¤§â†’æ›´å¼ºè¡¨è¾¾èƒ½åŠ›ï¼Œä½†è®¡ç®—/å†…å­˜æˆæœ¬å¹³æ–¹çº§å¢é•¿ï¼Œæœºå™¨äººå®æ—¶åœºæ™¯å»ºè®® â‰¤ 1024ã€‚</li>
<li>n_heads:æ³¨æ„åŠ›å¹¶è¡Œå¤´æ•°ï¼Œå¢å¤šæ›´ç»†ç²’åº¦å…³æ³¨ï¼Œä½†é€šä¿¡å¼€é”€å¢å¤§ ï¼Œä¿æŒ dim_model/n_heads = 64ï¼ˆå¦‚ 512/8=64ï¼‰ã€‚</li>
<li>n_encoder_layers: ç‰¹å¾èåˆæ·±åº¦ï¼Œå¢å¤šèåˆæ›´å……åˆ†ï¼Œä½†æ¨ç†å»¶è¿Ÿå¢åŠ ï¼Œæœºæ¢°è‡‚æ“ä½œå»ºè®® 4-6 å±‚ã€‚</li>
<li>n_decoder_layers: åŠ¨ä½œç”Ÿæˆæ·±åº¦ï¼Œå—åŸå§‹ bug é™åˆ¶ï¼Œå›ºå®šä¸º 1 ä»¥å¯¹é½è¡Œä¸ºï¼Œè‹¥ä¿®å¤åŸå§‹ bugï¼Œå¯å°è¯•å¢è‡³ 3-4 å±‚ã€‚</li>
</ul>
<p><strong>ï¼ˆ3ï¼‰VAEå˜åˆ†è‡ªç¼–ç é…ç½®</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># VAE.</span>
<span class="n">use_vae</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>          <span class="c1"># æ˜¯å¦å¯ç”¨VAEï¼ˆé»˜è®¤å¯ç”¨ï¼Œé€šè¿‡æ½œåœ¨ç©ºé—´å»ºæ¨¡åŠ¨ä½œåˆ†å¸ƒï¼‰</span>
<span class="n">latent_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>          <span class="c1"># VAEæ½œåœ¨ç©ºé—´ç»´åº¦ï¼ˆ32ç»´ï¼Œå‹ç¼©åŠ¨ä½œåºåˆ—ä¿¡æ¯ï¼‰</span>
<span class="n">n_vae_encoder_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># VAEç¼–ç å™¨å±‚æ•°ï¼ˆ4å±‚Transformerï¼Œç”¨äºå°†åŠ¨ä½œå—ç¼–ç ä¸ºæ½œåœ¨åˆ†å¸ƒï¼‰</span>
</code></pre></div>
<p><strong>ï¼ˆ4ï¼‰æ¨ç†é…ç½®</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Inference.</span>
<span class="c1"># Note: ACTåŸè®ºæ–‡ä¸­å¯ç”¨æ—¶åºé›†æˆæ—¶é»˜è®¤å€¼ä¸º0.01</span>
<span class="n">temporal_ensemble_coeff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># æ—¶åºé›†æˆç³»æ•°ï¼šNone=ç¦ç”¨ï¼Œ&gt;0=å¯ç”¨ï¼ˆæŒ‡æ•°åŠ æƒå¹³å‡å¹³æ»‘åŠ¨ä½œï¼‰</span>
</code></pre></div>
<p>è¯¥å‚æ•°å°±æ˜¯æ˜¯å¦å¯åŠ¨ACTçš„Temporal Ensemblingæœºåˆ¶ï¼Œæ—¶åºé›†æˆï¼ˆTemporal Ensemblingï¼‰ åŠŸèƒ½çš„å¯ç”¨ä¸æƒé‡è®¡ç®—æ–¹å¼ï¼Œç”¨äºåœ¨æ¨ç†æ—¶å¹³æ»‘åŠ¨ä½œåºåˆ—ï¼Œé¿å…æœºå™¨äººæ‰§è¡Œçªå˜åŠ¨ä½œï¼ˆå°¤å…¶é€‚ç”¨äºç²¾ç»†æ“ä½œå¦‚æœºæ¢°è‡‚æŠ“å–ã€æ’å…¥ç­‰ä»»åŠ¡ï¼‰ã€‚</p>
<p>è¦å¯åŠ¨Temporal Ensemblingæœºåˆ¶éœ€æ˜¾å¼è®¾ç½®è¯¥å‚æ•°ä¸ºé None çš„æµ®ç‚¹å€¼ï¼ˆå¦‚ 0.01ï¼‰ï¼Œä¸”éœ€æ»¡è¶³n_action_steps å¿…é¡»è®¾ä¸º 1ï¼ˆæ¯æ¬¡ç­–ç•¥è°ƒç”¨ä»…æ‰§è¡Œ 1 æ­¥åŠ¨ä½œï¼Œç¡®ä¿æ¯æ­¥éƒ½é€šè¿‡é›†æˆä¼˜åŒ–ï¼‰ã€‚</p>
<p>å½“ temporal_ensemble_coeff = Î±ï¼ˆå¦‚ 0.01ï¼‰æ—¶ï¼ŒACTTemporalEnsembler ä¼šå¯¹è¿ç»­å¤šè½®é¢„æµ‹çš„åŠ¨ä½œå—ï¼ˆchunk_size é•¿åº¦ï¼‰è¿›è¡Œ æŒ‡æ•°åŠ æƒå¹³å‡ã€‚</p>
<p><strong>ï¼ˆ5ï¼‰è®­ç»ƒæŸå¤±é…ç½®</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># Training and loss computation.</span>
    <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">kl_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span>
</code></pre></div>
<p>dropoutæ§åˆ¶ Transformer å±‚çš„ éšæœºå¤±æ´»æ¦‚ç‡ï¼Œç”¨äºæ­£åˆ™åŒ–ï¼Œé˜²æ­¢æ¨¡å‹è¿‡æ‹Ÿåˆè®­ç»ƒæ•°æ®ã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œä»¥ dropout æ¦‚ç‡ï¼ˆæ­¤å¤„ 10%ï¼‰éšæœºå°† Transformer å±‚ï¼ˆå¦‚å¤šå¤´æ³¨æ„åŠ›è¾“å‡ºã€å‰é¦ˆç½‘ç»œè¾“å‡ºï¼‰çš„éƒ¨åˆ†ç¥ç»å…ƒæ¿€æ´»å€¼è®¾ä¸º 0ï¼Œå¼ºåˆ¶æ¨¡å‹å­¦ä¹ æ›´é²æ£’çš„ç‰¹å¾ï¼ˆä¸ä¾èµ–ç‰¹å®šç¥ç»å…ƒç»„åˆï¼‰</p>
<p>kl_weightæ§åˆ¶ KL æ•£åº¦æŸå¤±ï¼ˆKL-divergence Lossï¼‰ çš„æƒé‡ï¼Œä»…åœ¨å¯ç”¨ VAEï¼ˆuse_vae=Trueï¼Œé»˜è®¤å¯ç”¨ï¼‰æ—¶ç”Ÿæ•ˆã€‚10.0 æ˜¯ä¸€ä¸ªè¾ƒå¤§çš„æƒé‡ï¼Œè¡¨æ˜åŸå§‹ ACT å®ç°ä¸­æ›´æ³¨é‡çº¦æŸæ½œåœ¨åˆ†å¸ƒçš„â€œè§„èŒƒæ€§â€ï¼ˆæ¥è¿‘æ ‡å‡†æ­£æ€ï¼‰ï¼Œä»¥ç¡®ä¿ VAE èƒ½ç”Ÿæˆå¤šæ ·åŒ–çš„åŠ¨ä½œåºåˆ—ï¼Œé¿å…æ¨¡å‹ä»…è®°å¿†è®­ç»ƒæ•°æ®ä¸­çš„åŠ¨ä½œæ¨¡å¼ã€‚</p>
<p><strong>ï¼ˆ6ï¼‰è®­ç»ƒä¼˜åŒ–</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># Training preset</span>
    <span class="n">optimizer_lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span>
    <span class="n">optimizer_weight_decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span>
    <span class="n">optimizer_lr_backbone</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span>
</code></pre></div>
<p>optimizer_lræ§åˆ¶é™¤è§†è§‰Backboneå¤–æ‰€æœ‰å‚æ•°ï¼ˆå¦‚Transformerç¼–ç å™¨/è§£ç å™¨ã€VAEå±‚ç­‰ï¼‰çš„æ¢¯åº¦æ›´æ–°æ­¥é•¿ã€‚å­¦ä¹ ç‡è¿‡å¤§ä¼šå¯¼è‡´è®­ç»ƒä¸ç¨³å®šï¼ˆLosséœ‡è¡ï¼‰ï¼Œè¿‡å°åˆ™æ”¶æ•›ç¼“æ…¢ã€‚1e-5ï¼ˆ0.00001ï¼‰æ˜¯è®­ç»ƒTransformerç±»æ¨¡å‹çš„ç»å…¸å­¦ä¹ ç‡ï¼ˆå¦‚BERTã€GPTç­‰ï¼‰ï¼Œå°¤å…¶é€‚ç”¨äºã€‚</p>
<p>optimizer_weight_decayæƒé‡è¡°å‡ï¼ˆL2æ­£åˆ™åŒ–ï¼‰ç³»æ•°ï¼Œç”¨äºæŠ‘åˆ¶è¿‡æ‹Ÿåˆã€‚è¿‡å°ï¼ˆå¦‚1e-5ï¼‰ï¼šæ­£åˆ™åŒ–ä¸è¶³ï¼Œæ˜“è¿‡æ‹Ÿåˆè®­ç»ƒæ•°æ®ã€‚è¿‡å¤§ï¼ˆå¦‚1e-3ï¼‰ï¼šè¿‡åº¦æŠ‘åˆ¶å‚æ•°æ›´æ–°ï¼Œå¯¼è‡´æ¨¡å‹æ¬ æ‹Ÿåˆã€‚é€‚ç”¨äºæœºå™¨äººæ“ä½œä»»åŠ¡ï¼Œè®­ç»ƒæ•°æ®é€šå¸¸åŒ…å«å™ªå£°ï¼ˆå¦‚ä¼ æ„Ÿå™¨è¯¯å·®ã€åŠ¨ä½œæŠ–åŠ¨ï¼‰ï¼Œæƒé‡è¡°å‡å¯æå‡æ¨¡å‹å¯¹å™ªå£°çš„é²æ£’æ€§ã€‚</p>
<p>optimizer_lr_backboneè§†è§‰Backboneï¼ˆå¦‚ResNet18ï¼‰å‚æ•°çš„ä¸“ç”¨å­¦ä¹ ç‡ã€‚ACTåŸè®ºæ–‡ä¸­Backboneä¸ä¸»æ¨¡å‹è”åˆè®­ç»ƒï¼Œæœªä½¿ç”¨æ›´å°çš„Backboneå­¦ä¹ ç‡ã€‚</p>
<p>åœ¨å®é™…çš„å·¥ç¨‹ä¸­ï¼Œå¯åœ¨get_optim_params ä¸­æ˜¾å¼åŒºåˆ†Backboneä¸éBackboneå‚æ•°ï¼Œåº”ç”¨ä¸åŒå­¦ä¹ ç‡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_optim_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">"params"</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"model.backbone"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">],</span>
            <span class="s2">"lr"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">optimizer_lr</span><span class="p">,</span>  <span class="c1"># ä¸»å‚æ•°å­¦ä¹ ç‡</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">"params"</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"model.backbone"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">],</span>
            <span class="s2">"lr"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">optimizer_lr_backbone</span><span class="p">,</span>  <span class="c1"># Backboneä¸“ç”¨å­¦ä¹ ç‡</span>
        <span class="p">},</span>
    <span class="p">]</span>
</code></pre></div>
<h2 id="actpolicy">ç­–ç•¥å…¥å£ç±»ACTPolicy</h2>
<h3 id="_3">åˆå§‹åŒ–é€»è¾‘</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ACTPolicy</span><span class="p">(</span><span class="n">PreTrainedPolicy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ACTConfig</span><span class="p">,</span> <span class="n">dataset_stats</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="c1"># è¾“å…¥/è¾“å‡ºå½’ä¸€åŒ–ï¼ˆæ ‡å‡†åŒ–æ•°æ®åˆ†å¸ƒï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize_inputs</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">input_features</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">normalization_mapping</span><span class="p">,</span> <span class="n">dataset_stats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unnormalize_outputs</span> <span class="o">=</span> <span class="n">Unnormalize</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">output_features</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">normalization_mapping</span><span class="p">,</span> <span class="n">dataset_stats</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">ACT</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>  <span class="c1"># åŠ è½½ACTç¥ç»ç½‘ç»œ</span>

        <span class="c1"># åˆå§‹åŒ–æ—¶åºé›†æˆå™¨ï¼ˆè‹¥å¯ç”¨ï¼‰</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">temporal_ensemble_coeff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temporal_ensembler</span> <span class="o">=</span> <span class="n">ACTTemporalEnsembler</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">temporal_ensemble_coeff</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>  <span class="c1"># é‡ç½®åŠ¨ä½œé˜Ÿåˆ—/é›†æˆå™¨</span>
</code></pre></div>
<p>è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªåŸºäºAction Chunking Transformer (ACT)çš„ç­–ç•¥ç±»ï¼Œä¸»è¦ç”¨äºæœºå™¨äººæ“ä½œä»»åŠ¡çš„åŠ¨ä½œç”Ÿæˆã€‚</p>
<p>self.normalize_inputsã€self.normalize_targetsã€self.unnormalize_outputsã€‚è¿™3ä¸ªå‚æ•°ç”¨äºæ•°æ®é¢„å¤„ç†å’Œåå¤„ç†çš„å…³é”®ç»„ä»¶ï¼Œè´Ÿè´£è¾“å…¥ç‰¹å¾çš„å½’ä¸€åŒ–ã€ç›®æ ‡åŠ¨ä½œçš„å½’ä¸€åŒ–ä»¥åŠæ¨¡å‹è¾“å‡ºåŠ¨ä½œçš„åå½’ä¸€åŒ–ã€‚</p>
<p>æ ¹æ®config.temporal_ensemble_coeffæ¡ä»¶æ¥åˆ¤æ–­æ˜¯å¦åˆå§‹åŒ–temporal ensemblerï¼Œç”¨äºè”ç³»é¢„æµ‹çš„åŠ¨ä½œå—è¿›è¡ŒåŠ æƒå¹³å‡ï¼Œæå‡åŠ¨ä½œè¾“å‡ºçš„ç¨³å®šæ€§ã€‚ACTTemporalEnsembleré€šè¿‡æŒ‡æ•°æƒé‡ï¼ˆexp(-temporal_ensemble_coeff * i)ï¼‰å¯¹å†å²åŠ¨ä½œè¿›è¡ŒåŠ æƒï¼Œ olderåŠ¨ä½œæƒé‡æ›´é«˜ï¼ˆåŸè®ºæ–‡é»˜è®¤ç³»æ•°0.01ï¼‰ã€‚</p>
<h3 id="_4">æ¨ç†é€»è¾‘</h3>
<p>select_actionæ˜¯ACTPolicyç±»çš„æ ¸å¿ƒæ–¹æ³•ï¼Œä¸»è¦çš„ç›®çš„å°±æ˜¯æ ¹æ®ç¯å¢ƒè§‚æµ‹(batch)ç„¶åé¢„æµ‹è¾“å‡ºæœºå™¨äººè¦æ‰§è¡Œçš„åŠ¨ä½œã€‚ç”Ÿæˆé¢„æµ‹çš„åŠ¨ä½œæœ‰ä¸¤ç§æ¨¡å¼ï¼Œä¸€ä¸ªæ˜¯å¯ç”¨temporal ensembleæ–¹å¼å¦å¤–ä¸€ç§ä¸å¯ç”¨ã€‚</p>
<p>åœ¨è¿›å…¥é¢„æµ‹ç”ŸæˆåŠ¨ä½œä¹‹å‰å…ˆè°ƒç”¨self.eval()å¼ºåˆ¶ç­–ç•¥è¿›å…¥è¯„ä¼°æ¨¡å¼ï¼ˆæ¨ç†ï¼‰ï¼Œå› ä¸ºç­–ç•¥å¤„äºè®­ç»ƒæ¨¡å¼ï¼ˆå¯ç”¨dropoutç­‰ï¼‰ã€‚</p>
<p><strong>ï¼ˆ1ï¼‰æ—¶é—´é›†æˆæ¨¡å¼</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">select_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">temporal_ensemble_coeff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_action_chunk</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>  <span class="c1"># ç”ŸæˆåŠ¨ä½œå—</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_ensembler</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>  <span class="c1"># æ—¶åºé›†æˆå¹³æ»‘</span>
        <span class="k">return</span> <span class="n">action</span>
</code></pre></div>
<p>å¼€å¯temporal ensembleï¼šæ ¹æ®é…ç½®ä¸­temporal_ensemble_coeffæ¡ä»¶ä¼˜å…ˆèµ°temporal ensembleæ¨¡å¼ã€‚è¯¥æ¨¡å¼å…ˆè°ƒç”¨self.predict_action_chunk(batch)è°ƒç”¨æ¨¡å‹é¢„æµ‹ä¸€ä¸ªåŠ¨ä½œå—ï¼ˆ(batch_size, chunk_size, action_dim)ï¼‰ï¼Œå³ä¸€æ¬¡æ€§é¢„æµ‹å¤šä¸ªè¿ç»­åŠ¨ä½œã€‚ç„¶åè°ƒç”¨self.temporal_ensembler.update(actions)é€šè¿‡æ—¶é—´é›†æˆå™¨å¯¹åŠ¨ä½œå—è¿›è¡ŒåŠ æƒå¹³æ»‘ï¼ˆ older åŠ¨ä½œæƒé‡æ›´é«˜ï¼ŒåŸè®ºæ–‡é»˜è®¤ç³»æ•° 0.01ï¼‰ï¼Œè¾“å‡ºå•ä¸ªç¨³å®šåŠ¨ä½œã€‚ä¸»è¦çš„ç›®çš„å°±æ˜¯è®ºæ–‡ä¸­çš„å‡å°‘åŠ¨ä½œæŠ–åŠ¨ï¼Œæå‡æœºå™¨äººæ§åˆ¶å¹³æ»‘æ€§ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœå¼€å¯äº†è¯¥æ¨¡å¼ï¼Œn_action_steps å¿…é¡»ä¸º 1ï¼Œå¦åˆ™ä¼šç ´åé›†æˆå™¨çš„æ—¶åºåŠ æƒé€»è¾‘ã€‚</p>
<p>æ—¶é—´é›†æˆæ ¸å¿ƒå®ç°</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ACTTemporalEnsembler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temporal_ensemble_coeff</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># æŒ‡æ•°æƒé‡ï¼šw_i = exp(-coeff * i)ï¼Œiä¸ºåŠ¨ä½œç´¢å¼•ï¼ˆ0ä¸ºæœ€æ—§åŠ¨ä½œï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">temporal_ensemble_coeff</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_weights_cumsum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_weights</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># æƒé‡ç´¯åŠ å’Œï¼ˆç”¨äºå½’ä¸€åŒ–ï¼‰</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actions</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="c1"># actions: (batch_size, chunk_size, action_dim)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensembled_actions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensembled_actions</span> <span class="o">=</span> <span class="n">actions</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>  <span class="c1"># åˆå§‹åŒ–é›†æˆåŠ¨ä½œ</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># åœ¨çº¿åŠ æƒæ›´æ–°ï¼šå†å²åŠ¨ä½œ * ç´¯è®¡æƒé‡ + æ–°åŠ¨ä½œ * å½“å‰æƒé‡ï¼Œå†å½’ä¸€åŒ–</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensembled_actions</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_weights_cumsum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembled_actions_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensembled_actions</span> <span class="o">+=</span> <span class="n">actions</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembled_actions_count</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensembled_actions</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_weights_cumsum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembled_actions_count</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensembled_actions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># è¿”å›é›†æˆåçš„é¦–æ­¥åŠ¨ä½œ</span>
</code></pre></div>
<p><strong>ï¼ˆ2ï¼‰åŠ¨ä½œé˜Ÿåˆ—æ¨¡å¼</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">select_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># ç”ŸæˆåŠ¨ä½œå—ï¼ˆchunk_sizeæ­¥ï¼‰ï¼Œå–å‰n_action_stepsæ­¥å­˜å…¥é˜Ÿåˆ—</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_action_chunk</span><span class="p">(</span><span class="n">batch</span><span class="p">)[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_action_steps</span><span class="p">]</span>
        <span class="c1"># é˜Ÿåˆ—å½¢çŠ¶ï¼š(n_action_steps, batch_size, action_dim)ï¼Œæ•…è½¬ç½®åå…¥é˜Ÿ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action_queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">actions</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>  <span class="c1"># æ¯æ¬¡å¼¹å‡ºé˜Ÿåˆ—é¦–æ­¥åŠ¨ä½œ</span>
</code></pre></div>
<p>å…³é—­temporal ensembleï¼šæœªå¯ç”¨æ—¶é—´é›†æˆå™¨æ˜¯ï¼Œä½¿ç”¨ç®€å•çš„åŠ¨ä½œé˜Ÿåˆ—ç¼“å­˜åŠ¨ä½œå—å¹¶é€æ­¥è¾“å‡ºã€‚é¦–å…ˆè°ƒç”¨è°ƒç”¨ predict_action_chunk è·å–åŠ¨ä½œå—ï¼Œè¿™é‡Œå°†ä¼šè¾“å‡ºä¸€ä¸ªchunkçš„åŠ¨ä½œã€‚ä½†æ˜¯å¹¶ä¸æ˜¯æŠŠè¿™ä¸ªchunkçš„é›†åˆå…¨éƒ½é€å…¥é˜Ÿåˆ—ï¼Œè€Œæ˜¯æˆªå–å‰ n_action_steps ä¸ªåŠ¨ä½œï¼ˆn_action_steps ä¸ºæ¯æ¬¡é¢„æµ‹çš„åŠ¨ä½œæ­¥æ•°ï¼Œé€šå¸¸ â‰¤ chunk_sizeï¼‰ã€‚ä¸¾ä¸ªä¾‹å­å¦‚æœchunk_sizeæ˜¯100ï¼Œä½†æ˜¯n_action_stepsæ˜¯50ï¼Œé‚£ä¹ˆç­–ç•¥ä¸€æ¬¡é¢„æµ‹å‡º100ä¸ªåºåˆ—åŠ¨ä½œï¼Œä½†æ˜¯åªå–å‰é¢çš„50ä¸ªã€‚æœ€åæŠŠè¿™åŠ¨ä½œå—è¿›è¡Œè½¬ç½®ååŠ å…¥é˜Ÿåˆ—ï¼Œä¹‹æ‰€ä»¥è½¬ç½®æ˜¯å› ä¸ºæ¨¡å‹è¾“å‡ºåŠ¨ä½œå—å½¢çŠ¶ä¸º (batch_size, n_action_steps, action_dim)ï¼Œè€Œé˜Ÿåˆ—éœ€è¦æŒ‰æ—¶é—´æ­¥é¡ºåºå­˜å‚¨ï¼ˆå³ (n_action_steps, batch_size, action_dim)ï¼‰ï¼Œå› æ­¤é€šè¿‡ transpose(0, 1) äº¤æ¢å‰ä¸¤ç»´ã€‚</p>
<p>ä¸ºä»€ä¹ˆé¢„æµ‹äº†chunkå—ï¼Œè¦ç”¨n_action_stepsåšé™åˆ¶äº†ï¼Ÿ</p>
<p>å¯èƒ½æ˜¯å› ä¸ºåˆ©ç”¨äº†æ‰¹é‡æ¨ç†çš„æ•ˆç‡ï¼Œé¿å…å› åŠ¨ä½œå—è¿‡é•¿å¯¼è‡´ç¯å¢ƒçŠ¶æ€å˜åŒ–ï¼ˆå¦‚ç‰©ä½“ç§»åŠ¨ã€æœºå™¨äººä½å§¿åç§»ï¼‰æ—¶åŠ¨ä½œå¤±æ•ˆã€‚åŒæ—¶é™åˆ¶å•æ¬¡æ‰§è¡Œçš„åŠ¨ä½œæ­¥æ•°ï¼Œå¼ºåˆ¶æ¨¡å‹åœ¨ n_action_steps æ­¥åé‡æ–°æ¨ç†ï¼ˆåŸºäºæœ€æ–°è§‚æµ‹ï¼‰ï¼Œç¡®ä¿åŠ¨ä½œä¸ç¯å¢ƒçŠ¶æ€åŒæ­¥ã€‚</p>
<h3 id="_5">è®­ç»ƒæŸå¤±è®¡ç®—</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_inputs</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>  <span class="c1"># è¾“å…¥å½’ä¸€åŒ–</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_targets</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>  <span class="c1"># ç›®æ ‡åŠ¨ä½œå½’ä¸€åŒ–</span>

    <span class="n">actions_hat</span><span class="p">,</span> <span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">log_sigma_x2</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>  <span class="c1"># æ¨¡å‹è¾“å‡ºï¼šé¢„æµ‹åŠ¨ä½œã€VAEåˆ†å¸ƒå‚æ•°</span>

    <span class="c1"># L1æŸå¤±ï¼ˆå¿½ç•¥å¡«å……åŠ¨ä½œï¼‰</span>
    <span class="n">l1_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">l1_loss</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">ACTION</span><span class="p">],</span> <span class="n">actions_hat</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span> <span class="o">*</span> <span class="o">~</span><span class="n">batch</span><span class="p">[</span><span class="s2">"action_is_pad"</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"l1_loss"</span><span class="p">:</span> <span class="n">l1_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()}</span>

    <span class="c1"># VAE KLæ•£åº¦æŸå¤±ï¼ˆè‹¥å¯ç”¨ï¼‰</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_vae</span><span class="p">:</span>
        <span class="n">mean_kld</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">log_sigma_x2</span> <span class="o">-</span> <span class="n">mu</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_sigma_x2</span><span class="o">.</span><span class="n">exp</span><span class="p">()))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss_dict</span><span class="p">[</span><span class="s2">"kld_loss"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_kld</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">l1_loss</span> <span class="o">+</span> <span class="n">mean_kld</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">kl_weight</span>  <span class="c1"># æ€»æŸå¤± = é‡æ„æŸå¤± + KLæƒé‡ * KLæŸå¤±</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">l1_loss</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">loss_dict</span>
</code></pre></div>
<p>è¿™æ˜¯ACTPolicyç±»è®­ç»ƒæ¨¡å‹çš„æ¥å£ï¼Œè´Ÿè´£æ¥æ”¶è¾“å…¥æ•°æ®ã€é€šè¿‡æ¨¡æ¨ç†ç”ŸæˆåŠ¨ä½œé¢„æµ‹ã€è®¡ç®—æŸå¤±å¹¶è¿”å›æ€»æŸå¤±åŠæŸå¤±ç»„ä»¶å­—å…¸ã€‚</p>
<p>é¦–å…ˆå¯¹è¾“å…¥çš„è§‚æµ‹æ•°æ®è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼Œnormalize_inputs åŸºäºæ•°æ®é›†ç»Ÿè®¡ä¿¡æ¯ï¼ˆå‡å€¼ã€æ ‡å‡†å·®ï¼‰å°†è¾“å…¥ç‰¹å¾ç¼©æ”¾åˆ°æ ‡å‡†åˆ†å¸ƒï¼ˆé€šå¸¸å‡å€¼ä¸º0ã€æ–¹å·®ä¸º1ï¼‰ï¼Œç¡®ä¿æ¨¡å‹è®­ç»ƒæ—¶è¾“å…¥æ•°æ®åˆ†å¸ƒç¨³å®šã€‚</p>
<p>æ¥ç€å°†å›¾åƒç‰¹å¾ç»Ÿä¸€æ•´ç†åˆ°åˆ° batch[OBS_IMAGES] åˆ—è¡¨ä¸­ï¼Œä¾¿äºæ¨¡å‹åç»­æå–å›¾åƒç‰¹å¾ã€‚</p>
<p>å…¶æ¬¡è°ƒç”¨self.model(batch)è¿›è¡Œæ¨¡å‹æ¨ç†è¿”å›æ¨¡å‹é¢„æµ‹çš„å½’ä¸€åŒ–åŠ¨ä½œåºåˆ—ï¼Œå·²ç»å¦‚æœå¯ç”¨äº†VAEè¿”å›latentåˆ†å¸ƒçš„å‡å€¼å’Œå¯¹æ•°æ–¹å·®ã€‚</p>
<p>è®¡ç®—é¢„æµ‹åŠ¨ä½œï¼ˆactions_hatï¼‰ä¸çœŸå®åŠ¨ä½œï¼ˆbatch[ACTION]ï¼‰çš„ L1 æŸå¤±ï¼ˆå¹³å‡ç»å¯¹è¯¯å·®ï¼‰ã€‚KLæ•£åº¦çš„ç†è®ºæ„ä¹‰åœ¨äºåº¦é‡ä¸¤ä¸ªæ¦‚ç‡åˆ†å¸ƒä¹‹é—´çš„å·®å¼‚ç¨‹åº¦ï¼Œå½“KLæ•£åº¦è¶Šå¤§çš„æ—¶å€™ï¼Œè¯´æ˜ä¸¤è€…çš„å·®å¼‚ç¨‹åº¦è¶Šå¤§ï¼›è€Œå½“KLæ•£åº¦å°çš„æ—¶å€™ï¼Œåˆ™è¯´æ˜ä¸¤è€…çš„å·®å¼‚ç¨‹åº¦å°ã€‚å¦‚æœä¸¤è€…ç›¸åŒçš„è¯ï¼Œåˆ™è¯¥KLæ•£åº¦åº”è¯¥ä¸º0ã€‚å¦‚æœå¯åŠ¨äº†VAEï¼Œéœ€è¦å†è®¡ç®—KLæ•£åº¦ï¼Œæ€»çš„æŸå¤±ä¸ºL1æŸå¤±ä¸åŠ æƒKLæŸå¤±çŸ¥ä¹ï¼Œå…¶ä¸­kl_weightæ˜¯æ§åˆ¶æŸå¤±æƒé‡çš„è¶…å‚æ•°ã€‚å¦‚æœæ²¡æœ‰å¯åŠ¨VAEç›´æ¥è¿”å›L1æŸå¤±ã€‚</p>
<h2 id="act">æ ¸å¿ƒç®—æ³•ACT</h2>
<h3 id="_6">æ•´ä½“ç»“æ„</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ACT</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ACTConfig</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="c1"># VAEç¼–ç å™¨ï¼ˆå¯é€‰ï¼‰ï¼šå°†åŠ¨ä½œåºåˆ—ç¼–ç ä¸ºæ½œåœ¨åˆ†å¸ƒ</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">use_vae</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vae_encoder</span> <span class="o">=</span> <span class="n">ACTEncoder</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_vae_encoder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vae_encoder_latent_output_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">latent_dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># è¾“å‡ºmuå’Œlog(sigmaÂ²)</span>

        <span class="c1"># è§†è§‰Backboneï¼šResNetæå–å›¾åƒç‰¹å¾</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">image_features</span><span class="p">:</span>
            <span class="n">backbone_model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">vision_backbone</span><span class="p">)(</span><span class="n">weights</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">pretrained_backbone_weights</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span> <span class="o">=</span> <span class="n">IntermediateLayerGetter</span><span class="p">(</span><span class="n">backbone_model</span><span class="p">,</span> <span class="n">return_layers</span><span class="o">=</span><span class="p">{</span><span class="s2">"layer4"</span><span class="p">:</span> <span class="s2">"feature_map"</span><span class="p">})</span>  <span class="c1"># å–layer4ç‰¹å¾å›¾</span>

        <span class="c1"># Transformerç¼–ç å™¨-è§£ç å™¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">ACTEncoder</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>  <span class="c1"># å¤„ç†å¤šæ¨¡æ€è¾“å…¥ï¼ˆå›¾åƒã€çŠ¶æ€ã€æ½œåœ¨å‘é‡ï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">ACTDecoder</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>  <span class="c1"># ç”ŸæˆåŠ¨ä½œå—</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">action_feature</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># åŠ¨ä½œè¾“å‡ºå¤´</span>
</code></pre></div>
<p>è¿™æ®µä»£ç æ˜¯ACTç±»çš„æ„é€ å‡½æ•°ï¼Œä¸»è¦æ˜¯è´Ÿè´£åˆå§‹åŒ–æ¨¡å‹çš„æ ¸å¿ƒç»„ä»¶ï¼ŒåŒ…æ‹¬VAEç¼–ç å™¨ã€è§†è§‰backboneã€transformerç¼–ç å™¨/è§£ç å™¨ã€è¾“å…¥æŠ•å½±å±‚ã€ä½ç½®åµŒå…¥å’ŒåŠ¨ä½œé¢„æµ‹å¤´ç­‰ã€‚</p>
<p><strong>ï¼ˆ1ï¼‰VAEç¼–ç å™¨åˆå§‹åŒ–</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_vae</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vae_encoder</span> <span class="o">=</span> <span class="n">ACTEncoder</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_vae_encoder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># VAE ç¼–ç å™¨ï¼ˆTransformer æ¶æ„ï¼‰</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vae_encoder_cls_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">)</span>  <span class="c1"># CLS æ ‡è®°åµŒå…¥ï¼ˆç”¨äº latent åˆ†å¸ƒå‚æ•°ï¼‰</span>
    <span class="c1"># æœºå™¨äººçŠ¶æ€æŠ•å½±å±‚ï¼šå°†å…³èŠ‚çŠ¶æ€ç‰¹å¾æ˜ å°„åˆ°æ¨¡å‹éšè—ç»´åº¦</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">robot_state_feature</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vae_encoder_robot_state_input_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">robot_state_feature</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">dim_model</span>
        <span class="p">)</span>
    <span class="c1"># åŠ¨ä½œæŠ•å½±å±‚ï¼šå°†åŠ¨ä½œç‰¹å¾æ˜ å°„åˆ°æ¨¡å‹éšè—ç»´åº¦</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vae_encoder_action_input_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">action_feature</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">dim_model</span>
    <span class="p">)</span>
    <span class="c1"># Latent åˆ†å¸ƒæŠ•å½±å±‚ï¼šå°† VAE ç¼–ç å™¨è¾“å‡ºæ˜ å°„ä¸º latent å‡å€¼å’Œæ–¹å·®ï¼ˆç»´åº¦=2*latent_dimï¼‰</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vae_encoder_latent_output_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">latent_dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># å›ºå®šæ­£å¼¦ä½ç½®åµŒå…¥ï¼šä¸º VAE ç¼–ç å™¨è¾“å…¥åºåˆ—æ·»åŠ ä½ç½®ä¿¡æ¯ï¼ˆCLS + æœºå™¨äººçŠ¶æ€ + åŠ¨ä½œåºåˆ—ï¼‰</span>
    <span class="n">num_input_token_encoder</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">chunk_size</span>  <span class="c1"># 1ï¼ˆCLSï¼‰ + chunk_sizeï¼ˆåŠ¨ä½œåºåˆ—é•¿åº¦ï¼‰</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">robot_state_feature</span><span class="p">:</span>
        <span class="n">num_input_token_encoder</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># è‹¥åŒ…å«æœºå™¨äººçŠ¶æ€ï¼Œå¢åŠ  1 ä¸ª token</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span>
        <span class="s2">"vae_encoder_pos_enc"</span><span class="p">,</span>  <span class="c1"># æ³¨å†Œä¸ºç¼“å†²åŒºï¼ˆä¸å‚ä¸æ¢¯åº¦æ›´æ–°ï¼‰</span>
        <span class="n">create_sinusoidal_pos_embedding</span><span class="p">(</span><span class="n">num_input_token_encoder</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
<p>è°ƒç”¨ACTEncoderåˆå§‹åŒ–ä¸€ä¸ªVAEç¼–ç å™¨ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªtransformerç¼–ç å™¨ï¼Œå…¶å‚æ•°is_vae_encoder=True æ ‡å¿—ç”¨äºåŒºåˆ†è¯¥ç¼–ç å™¨ä¸º VAE ä¸“ç”¨ï¼ˆå½±å“å±‚æ•°ã€æ³¨æ„åŠ›æœºåˆ¶ç­‰é…ç½®ï¼Œå…·ä½“è§ ACTEncoder å®ç°ï¼‰ã€‚</p>
<p>å®šä¹‰ä¸€ä¸ªå¯å­¦ä¹ çš„CLSæ ‡è®°ï¼Œç±»ä¼¼BERTä¸­çš„[CLS],ç”¨äºèšåˆVAEç¼–ç å™¨è¾“å…¥åºåˆ—çš„å…¨å±€ä¿¡æ¯ï¼Œæœ€ç»ˆç”Ÿæˆlatentåˆ†å¸ƒå‚æ•°ï¼ˆå‡å€¼å’Œæ–¹å·®ï¼‰ï¼Œnn.Embedding(1, config.dim_model) åˆ›å»ºä¸€ä¸ªå•å…ƒç´ åµŒå…¥è¡¨ï¼Œè¾“å‡ºç»´åº¦ä¸ºæ¨¡å‹éšè—ç»´åº¦ dim_modelã€‚</p>
<p>å½“è¾“å…¥åŒ…å«æœºå™¨äººçŠ¶æ€ç‰¹å¾ï¼ˆå¦‚å…³èŠ‚è§’åº¦ã€é€Ÿåº¦ï¼‰æ—¶å¯ç”¨ã€‚é€šè¿‡çº¿æ€§å±‚å°†æœºå™¨äººçŠ¶æ€ç‰¹å¾ï¼ˆåŸå§‹ç»´åº¦ï¼‰æ˜ å°„åˆ°æ¨¡å‹éšè—ç»´åº¦ dim_modelï¼Œç¡®ä¿ä¸å…¶ä»–è¾“å…¥ tokenï¼ˆå¦‚åŠ¨ä½œåºåˆ—ï¼‰ç»´åº¦ä¸€è‡´ï¼Œå¯æ‹¼æ¥ä¸ºåºåˆ—è¾“å…¥ã€‚</p>
<p>åŒç†å°†åŠ¨ä½œåºåˆ—ä¸­çš„æ¯ä¸ªåŠ¨ä½œï¼ˆåŸå§‹ç»´åº¦ï¼Œå¦‚æœºå™¨äººå…³èŠ‚æ§åˆ¶ç»´åº¦ï¼‰é€šè¿‡çº¿æ€§å±‚æ˜ å°„åˆ° dim_modelï¼Œè½¬æ¢ä¸º Transformer å¯å¤„ç†çš„ token åºåˆ—ã€‚</p>
<p>å°† VAE ç¼–ç å™¨è¾“å‡ºçš„ CLS æ ‡è®°ç‰¹å¾ï¼ˆç»´åº¦ dim_modelï¼‰æ˜ å°„åˆ° latent åˆ†å¸ƒçš„å‚æ•°ç©ºé—´ã€‚</p>
<p>æœ€åçš„å›ºå®šæ­£å¼¦ä½ç½®åµŒå…¥ï¼Œå…¶ä½œç”¨æ˜¯ä¸º VAE ç¼–ç å™¨çš„è¾“å…¥åºåˆ—æ·»åŠ å›ºå®šä½ç½®ä¿¡æ¯ï¼Œå¸®åŠ© Transformer åŒºåˆ†ä¸åŒä½ç½®çš„ tokenï¼ˆCLSã€æœºå™¨äººçŠ¶æ€ã€åŠ¨ä½œåºåˆ—ä¸­çš„ä¸åŒæ—¶é—´æ­¥ï¼‰ã€‚</p>
<p><strong>ï¼ˆ2ï¼‰è§†è§‰backboneåˆå§‹åŒ–</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">image_features</span><span class="p">:</span>
    <span class="n">backbone_model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">vision_backbone</span><span class="p">)(</span>
        <span class="n">replace_stride_with_dilation</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">replace_final_stride_with_dilation</span><span class="p">],</span>  <span class="c1"># æ§åˆ¶æœ€åä¸€å±‚æ˜¯å¦ä½¿ç”¨ç©ºæ´å·ç§¯</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">pretrained_backbone_weights</span><span class="p">,</span>  <span class="c1"># é¢„è®­ç»ƒæƒé‡ï¼ˆå¦‚ ImageNetï¼‰</span>
        <span class="n">norm_layer</span><span class="o">=</span><span class="n">FrozenBatchNorm2d</span><span class="p">,</span>  <span class="c1"># å†»ç»“ BatchNorm å±‚ï¼ˆé¿å…å¾®è°ƒæ—¶ç ´åé¢„è®­ç»ƒåˆ†å¸ƒï¼‰</span>
    <span class="p">)</span>
    <span class="c1"># æå– ResNet çš„ layer4 è¾“å‡ºä½œä¸ºå›¾åƒç‰¹å¾å›¾ï¼ˆé«˜å±‚è¯­ä¹‰ç‰¹å¾ï¼‰</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span> <span class="o">=</span> <span class="n">IntermediateLayerGetter</span><span class="p">(</span><span class="n">backbone_model</span><span class="p">,</span> <span class="n">return_layers</span><span class="o">=</span><span class="p">{</span><span class="s2">"layer4"</span><span class="p">:</span> <span class="s2">"feature_map"</span><span class="p">})</span>
</code></pre></div>
<p>å½“ACTç±»ä¸­é…ç½®åŒ…å«å›¾åƒç‰¹å¾ï¼Œåˆå§‹åŒ–å›¾åƒç‰¹å¾æå–éª¨å¹²ç½‘ç»œï¼Œå¹¶é€šè¿‡ IntermediateLayerGetter æå–é«˜å±‚è§†è§‰ç‰¹å¾ä¾›åç»­ Transformer å¤„ç†ã€‚</p>
<p>é¦–å…ˆè°ƒç”¨getattråŠ¨æ€åŠ è½½ torchvision.models ä¸­çš„ ResNet æ¨¡å‹ï¼ˆå¦‚ resnet18ã€resnet50ï¼‰ï¼Œå…·ä½“å‹å·ç”±é…ç½® config.vision_backbone æŒ‡å®šã€‚</p>
<p>ç„¶åä½¿ç”¨ torchvision.ops.misc.IntermediateLayerGetter ä» ResNet ä¸­æå–æŒ‡å®šå±‚çš„è¾“å‡ºï¼Œä½œä¸ºå›¾åƒçš„é«˜å±‚ç‰¹å¾ã€‚return_layers={"layer4": "feature_map"}æŒ‡å®šæå– ResNet çš„ layer4ï¼ˆæœ€åä¸€ä¸ªæ®‹å·®å—ï¼‰è¾“å‡ºï¼Œå¹¶å°†å…¶é‡å‘½åä¸º feature_mapã€‚ResNet çš„ layer4 è¾“å‡ºåŒ…å«æœ€æŠ½è±¡çš„è§†è§‰è¯­ä¹‰ä¿¡æ¯ï¼ˆå¦‚ç‰©ä½“è½®å»“ã€çº¹ç†ï¼‰ï¼Œæ˜¯ä¸‹æ¸¸ä»»åŠ¡ï¼ˆå¦‚ Transformer ç¼–ç ï¼‰çš„å…³é”®è¾“å…¥ã€‚self.backbone è°ƒç”¨æ—¶è¿”å›å­—å…¸ {"feature_map": tensor}ï¼Œå…¶ä¸­ tensor ä¸ºå½¢çŠ¶ (B, C, H, W) çš„ç‰¹å¾å›¾ï¼ˆB ä¸º batch å¤§å°ï¼ŒC ä¸ºé€šé“æ•°ï¼ŒH/W ä¸ºç‰¹å¾å›¾é«˜/å®½ï¼‰ã€‚</p>
<p><strong>ï¼ˆ3ï¼‰transformerç¼–ç å™¨/è§£ç å™¨åˆå§‹åŒ–</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Transformer ç¼–ç å™¨ï¼šå¤„ç†è¾“å…¥ç‰¹å¾ï¼ˆlatentã€æœºå™¨äººçŠ¶æ€ã€ç¯å¢ƒçŠ¶æ€ã€å›¾åƒç‰¹å¾ï¼‰</span>
<span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">ACTEncoder</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="c1"># Transformer è§£ç å™¨ï¼šç”ŸæˆåŠ¨ä½œåºåˆ—ï¼ˆä½œä¸º VAE è§£ç å™¨æ—¶ï¼Œè¾“å…¥ä¸º latentï¼›å¦åˆ™ç›´æ¥å¤„ç†ç¼–ç å™¨è¾“å‡ºï¼‰</span>
<span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">ACTDecoder</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>
<p>è¿™ä¸¤è¡Œä»£ç æ˜¯åˆå§‹åŒ–ACTæ ¸å¿ƒç»„ä»¶transformerç¼–ç å™¨å’Œè§£ç å™¨ã€‚</p>
<p><strong>ï¼ˆ4ï¼‰è¾“å…¥æŠ•å½±å±‚</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æœºå™¨äººçŠ¶æ€æŠ•å½±ï¼šå°†æœºå™¨äººå…³èŠ‚çŠ¶æ€ç‰¹å¾ï¼ˆå¦‚å…³èŠ‚è§’åº¦ã€é€Ÿåº¦ï¼‰æ˜ å°„åˆ° dim_model</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">robot_state_feature</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">encoder_robot_state_input_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">robot_state_feature</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">dim_model</span>
    <span class="p">)</span>
<span class="c1"># ç¯å¢ƒçŠ¶æ€æŠ•å½±ï¼šå°†ç¯å¢ƒçŠ¶æ€ç‰¹å¾ï¼ˆå¦‚ç‰©ä½“ä½ç½®ï¼‰æ˜ å°„åˆ° dim_model</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">env_state_feature</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">encoder_env_state_input_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">env_state_feature</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">dim_model</span>
    <span class="p">)</span>
<span class="c1"># Latent æŠ•å½±ï¼šå°† VAE è¾“å‡ºçš„ latent å‘é‡æ˜ å°„åˆ° dim_model</span>
<span class="bp">self</span><span class="o">.</span><span class="n">encoder_latent_input_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">)</span>
<span class="c1"># å›¾åƒç‰¹å¾æŠ•å½±ï¼šé€šè¿‡ 1x1 å·ç§¯å°† Backbone è¾“å‡ºçš„ç‰¹å¾å›¾ï¼ˆCÃ—HÃ—Wï¼‰æ˜ å°„åˆ° dim_model</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">image_features</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">encoder_img_feat_input_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
        <span class="n">backbone_model</span><span class="o">.</span><span class="n">fc</span><span class="o">.</span><span class="n">in_features</span><span class="p">,</span>  <span class="c1"># Backbone è¾“å‡ºé€šé“æ•°ï¼ˆå¦‚ ResNet18 çš„ layer4 è¾“å‡ºä¸º 512ï¼‰</span>
        <span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">,</span> 
        <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span>  <span class="c1"># 1x1 å·ç§¯ä¸æ”¹å˜ç©ºé—´ç»´åº¦ï¼Œä»…è°ƒæ•´é€šé“æ•°</span>
    <span class="p">)</span>
</code></pre></div>
<p>åœ¨ Transformer ç¼–ç å™¨ä¸­ï¼Œè¦æ±‚æ‰€æœ‰è¾“å…¥ token å…·æœ‰ç›¸åŒçš„ç»´åº¦ï¼ˆdim_modelï¼‰ï¼Œè€Œä¸åŒè¾“å…¥ç‰¹å¾ï¼ˆçŠ¶æ€ã€å›¾åƒã€latent ç­‰ï¼‰çš„åŸå§‹ç»´åº¦å„å¼‚ï¼ŒæŠ•å½±å±‚é€šè¿‡çº¿æ€§/å·ç§¯å˜æ¢å®ç°ç»´åº¦å¯¹é½ã€‚ æŠ•å½±å±‚ï¼ˆProjection Layerï¼‰ æ˜¯ä¸€ç±»ç”¨äºå°†ä¸åŒç±»å‹çš„è¾“å…¥ç‰¹å¾ï¼ˆå¦‚æœºå™¨äººçŠ¶æ€ã€ç¯å¢ƒçŠ¶æ€ã€ latent å‘é‡ã€å›¾åƒç‰¹å¾ç­‰ï¼‰æ˜ å°„åˆ°ç»Ÿä¸€ç»´åº¦çš„ç¥ç»ç½‘ç»œå±‚ã€‚å…¶æ ¸å¿ƒä½œç”¨æ˜¯å°†åŸå§‹è¾“å…¥ç‰¹å¾çš„ç»´åº¦è½¬æ¢ä¸º Transformer ç¼–ç å™¨èƒ½å¤Ÿå¤„ç†çš„éšè—ç»´åº¦ï¼ˆå³ä»£ç ä¸­çš„ config.dim_modelï¼‰ï¼Œç¡®ä¿å¤šæ¨¡æ€è¾“å…¥ï¼ˆå¦‚çŠ¶æ€ã€å›¾åƒï¼‰èƒ½è¢«ç¼–ç å™¨ç»Ÿä¸€å¤„ç†ã€‚</p>
<p>åœ¨ACTç±»ä¸­å®šä¹‰äº†å¤šä¸ªæŠ•å½±å±‚</p>
<ul>
<li>self.config.robot_state_featureï¼šè¾“å…¥ä¸ºæœºå™¨äººçŠ¶æ€ç‰¹å¾ï¼ˆå¦‚å…³èŠ‚è§’åº¦ã€é€Ÿåº¦ï¼‰ï¼ŒåŸå§‹ç»´åº¦ä¸º self.config.robot_state_feature.shape[0]ï¼Œé€šè¿‡çº¿æ€§å±‚ï¼ˆnn.Linearï¼‰å°†æœºå™¨äººçŠ¶æ€çš„åŸå§‹ç»´åº¦æ˜ å°„åˆ° dim_modelï¼Œä½¿å…¶æˆä¸º Transformer ç¼–ç å™¨å¯æ¥æ”¶çš„ tokenã€‚</li>
<li>self.config.env_state_feature:ç¯å¢ƒçŠ¶æ€ç‰¹å¾ï¼ˆå¦‚ç‰©ä½“ä½ç½®ã€åœºæ™¯å‚æ•°ï¼‰ï¼ŒåŸå§‹ç»´åº¦ä¸º self.config.env_state_feature.shape[0]ï¼Œä¸æœºå™¨äººçŠ¶æ€æŠ•å½±å±‚ç±»ä¼¼ï¼Œé€šè¿‡çº¿æ€§å±‚å°†ç¯å¢ƒçŠ¶æ€æ˜ å°„åˆ° dim_modelï¼Œå®ç°å¤šæ¨¡æ€ç‰¹å¾çš„ç»´åº¦ç»Ÿä¸€ã€‚</li>
<li>self.encoder_latent_input_projï¼šè¾“å…¥æ˜¯Latent å‘é‡ï¼ˆæ¥è‡ª VAE é‡‡æ ·æˆ–é›¶å‘é‡ï¼‰ï¼Œç»´åº¦ä¸º config.latent_dimï¼Œå°† latent å‘é‡ä» latent ç©ºé—´ç»´åº¦æ˜ å°„åˆ° dim_modelï¼Œä½œä¸º Transformer ç¼–ç å™¨çš„æ ¸å¿ƒè¾“å…¥ token ä¹‹ä¸€ã€‚</li>
<li>self.encoder_img_feat_input_projï¼šè¾“å…¥æ˜¯å›¾åƒç‰¹å¾å›¾ï¼ˆæ¥è‡ª ResNet éª¨å¹²ç½‘ç»œçš„ layer4 è¾“å‡ºï¼‰ï¼Œé€šé“æ•°ä¸º backbone_model.fc.in_featuresï¼ˆå¦‚ ResNet18 ä¸º 512ï¼‰ï¼Œé€šè¿‡ 1x1 å·ç§¯å±‚ï¼ˆnn.Conv2dï¼‰å°†å›¾åƒç‰¹å¾å›¾çš„é€šé“æ•°è°ƒæ•´ä¸º dim_modelï¼ŒåŒæ—¶ä¿æŒç©ºé—´ç»´åº¦ï¼ˆHÃ—Wï¼‰ä¸å˜ï¼Œä»¥ä¾¿å±•å¹³ä¸ºåºåˆ— token è¾“å…¥ Transformerã€‚</li>
</ul>
<p><strong>ï¼ˆ5ï¼‰ä½ç½®åµŒå…¥</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1D ä½ç½®åµŒå…¥ï¼šç”¨äº latentã€æœºå™¨äººçŠ¶æ€ã€ç¯å¢ƒçŠ¶æ€ç­‰éå›¾åƒç‰¹å¾ï¼ˆå…± n_1d_tokens ä¸ª tokenï¼‰</span>
<span class="n">n_1d_tokens</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># latent å  1 ä¸ª token</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">robot_state_feature</span><span class="p">:</span>
    <span class="n">n_1d_tokens</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># æœºå™¨äººçŠ¶æ€å  1 ä¸ª token</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">env_state_feature</span><span class="p">:</span>
    <span class="n">n_1d_tokens</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># ç¯å¢ƒçŠ¶æ€å  1 ä¸ª token</span>
<span class="bp">self</span><span class="o">.</span><span class="n">encoder_1d_feature_pos_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">n_1d_tokens</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">)</span>  <span class="c1"># å¯å­¦ä¹ çš„ 1D ä½ç½®åµŒå…¥</span>

<span class="c1"># 2D ä½ç½®åµŒå…¥ï¼šç”¨äºå›¾åƒç‰¹å¾å›¾ï¼ˆHÃ—W ç©ºé—´ä½ç½®ï¼‰</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">image_features</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">encoder_cam_feat_pos_embed</span> <span class="o">=</span> <span class="n">ACTSinusoidalPositionEmbedding2d</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># æ­£å¼¦ 2D ä½ç½®åµŒå…¥</span>
</code></pre></div>
<p>ä½ç½®åµŒå…¥æ˜¯ Transformer çš„å…³é”®ç»„ä»¶ï¼Œç”¨äºè§£å†³è‡ªæ³¨æ„åŠ›æœºåˆ¶ å¯¹è¾“å…¥åºåˆ—é¡ºåºä¸æ•æ„Ÿ çš„é—®é¢˜ã€‚æœ¬ä»£ç ä¸­æœ‰ä¸€ä¸ª1Dç‰¹å¾ä½ç½®åµŒå…¥å±‚å’Œå›¾åƒç‰¹å¾ä½ç½®åµŒå…¥å¼å±‚ã€‚</p>
<ul>
<li>1D ç‰¹å¾ä½ç½®åµŒå…¥å¼å±‚ï¼šä¸º 1D ç‰¹å¾ token æä¾› å¯å­¦ä¹ çš„ä½ç½®åµŒå…¥ï¼Œå¸®åŠ© Transformer åŒºåˆ†ä¸åŒç±»å‹ token çš„ä½ç½®ï¼ˆå¦‚ latent æ˜¯ç¬¬ 1 ä¸ª tokenï¼Œæœºå™¨äººçŠ¶æ€æ˜¯ç¬¬ 2 ä¸ªç­‰ï¼‰ã€‚</li>
<li>2D å›¾åƒç‰¹å¾ä½ç½®åµŒå…¥å±‚ï¼šä¸ºå›¾åƒç‰¹å¾å›¾çš„ 2D ç©ºé—´åƒç´  æä¾› æ­£å¼¦ä½ç½®åµŒå…¥ï¼Œç¼–ç åƒç´ åœ¨ç‰¹å¾å›¾ä¸­çš„ (é«˜åº¦, å®½åº¦) ç©ºé—´ä½ç½®ä¿¡æ¯ã€‚</li>
</ul>
<p><strong>ï¼ˆ6ï¼‰è§£ç å™¨ä½ç½®åµŒå…¥ä¸åŠ¨ä½œé¢„æµ‹å¤´</strong></p>
<div class="codehilite"><pre><span></span><code><span class="bp">self</span><span class="o">.</span><span class="n">decoder_pos_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">)</span>  <span class="c1"># chunk_size ä¸ºåŠ¨ä½œåºåˆ—é•¿åº¦</span>

<span class="bp">self</span><span class="o">.</span><span class="n">action_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">action_feature</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div>
<ul>
<li>self.decoder_pos_embedï¼šä¸ºè§£ç å™¨ç”Ÿæˆçš„åŠ¨ä½œåºåˆ—ï¼ˆaction chunkï¼‰æä¾› å¯å­¦ä¹ çš„ä½ç½®åµŒå…¥ï¼Œå¸®åŠ© Transformer è§£ç å™¨åŒºåˆ†åŠ¨ä½œåºåˆ—ä¸­ä¸åŒæ—¶é—´æ­¥çš„ä½ç½®ä¿¡æ¯ï¼ˆå¦‚ç¬¬ 1 ä¸ªåŠ¨ä½œã€ç¬¬ 2 ä¸ªåŠ¨ä½œç­‰ï¼‰ã€‚</li>
<li>self.action_headï¼šå°†è§£ç å™¨è¾“å‡ºçš„é«˜ç»´ç‰¹å¾ï¼ˆconfig.dim_model ç»´åº¦ï¼‰æŠ•å½±åˆ°å®é™…åŠ¨ä½œç©ºé—´ç»´åº¦ï¼Œç”Ÿæˆæœ€ç»ˆå¯æ‰§è¡Œçš„åŠ¨ä½œåºåˆ—ã€‚</li>
</ul>
<h3 id="forward">forwardæ–¹æ³•</h3>
<p>forwardè´Ÿè´£æ‰§è¡Œ Action Chunking Transformer çš„å®Œæ•´å‰å‘ä¼ æ’­æµç¨‹ï¼Œæ¶µç›– VAE ç¼–ç ï¼ˆå¯é€‰ï¼‰ã€å¤šæ¨¡æ€è¾“å…¥å¤„ç†ã€Transformer ç¼–ç å™¨-è§£ç å™¨è®¡ç®—ï¼Œæœ€ç»ˆè¾“å‡ºåŠ¨ä½œåºåˆ—åŠæ½œåœ¨å˜é‡åˆ†å¸ƒå‚æ•°ï¼ˆè‹¥å¯ç”¨ VAEï¼‰ã€‚ä»¥ä¸‹æ˜¯åˆ†æ­¥éª¤è§£æã€‚</p>
<p><strong>ï¼ˆ1ï¼‰è¾“å…¥éªŒè¯ä¸ batch_size ç¡®å®š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_vae</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
    <span class="k">assert</span> <span class="s2">"action"</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">,</span> <span class="s2">"actions must be provided when using the variational objective in training mode."</span>

<span class="k">if</span> <span class="s2">"observation.images"</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">"observation.images"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">"observation.environment_state"</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
<p>è‹¥å¯ç”¨å˜åˆ†ç›®æ ‡ï¼ˆVAEï¼‰ä¸”å¤„äºè®­ç»ƒæ¨¡å¼ï¼Œéœ€ç¡®ä¿è¾“å…¥åŒ…å«åŠ¨ä½œåºåˆ—ï¼ˆ"action"ï¼‰ï¼Œå› ä¸º VAE ç¼–ç å™¨éœ€ä»¥åŠ¨ä½œåºåˆ—ä¸ºç›®æ ‡æ•°æ®ã€‚ç¡®å®šbatch_sizeï¼Œæ ¹æ®è¾“å…¥æ¨¡æ€ï¼ˆå›¾åƒæˆ–ç¯å¢ƒçŠ¶æ€ï¼‰ç¡®å®šæ‰¹æ¬¡å¤§å°ï¼Œç¡®ä¿åç»­å¼ é‡æ“ä½œç»´åº¦å¯¹é½ã€‚</p>
<p><strong>ï¼ˆ2ï¼‰ Latent å‘é‡ç”Ÿæˆï¼ˆVAE ç¼–ç é€»è¾‘ï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ„å»º VAE ç¼–ç å™¨è¾“å…¥ï¼š[cls_token, æœºå™¨äººçŠ¶æ€ï¼ˆå¯é€‰ï¼‰, åŠ¨ä½œåºåˆ—]</span>
<span class="n">cls_embed</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae_encoder_cls_embed</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="s2">"1 d -&gt; b 1 d"</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>  <span class="c1"># (B, 1, D)</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">robot_state_feature</span><span class="p">:</span>
    <span class="n">robot_state_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_encoder_robot_state_input_proj</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">"observation.state"</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (B, 1, D)</span>
<span class="n">action_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_encoder_action_input_proj</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">"action"</span><span class="p">])</span>  <span class="c1"># (B, S, D)</span>
<span class="n">vae_encoder_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">cls_embed</span><span class="p">,</span> <span class="n">robot_state_embed</span><span class="p">,</span> <span class="n">action_embed</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">robot_state_feature</span> <span class="k">else</span> <span class="p">[</span><span class="n">cls_embed</span><span class="p">,</span> <span class="n">action_embed</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (B, S+2, D) æˆ– (B, S+1, D)</span>

<span class="c1"># æ·»åŠ å›ºå®šæ­£å¼¦ä½ç½®åµŒå…¥</span>
<span class="n">pos_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_encoder_pos_enc</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># (S+2, 1, D)</span>

<span class="c1"># æ„å»ºæ³¨æ„åŠ›æ©ç ï¼ˆå¿½ç•¥å¡«å…… tokenï¼‰</span>
<span class="n">cls_joint_is_pad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">robot_state_feature</span> <span class="k">else</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">False</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">"observation.state"</span><span class="p">]</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="n">key_padding_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">cls_joint_is_pad</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s2">"action_is_pad"</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (B, S+2) æˆ– (B, S+1)</span>

<span class="c1"># VAE ç¼–ç å™¨å‰å‘ä¼ æ’­ï¼Œæå– cls token è¾“å‡º</span>
<span class="n">cls_token_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_encoder</span><span class="p">(</span><span class="n">vae_encoder_input</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">pos_embed</span><span class="o">=</span><span class="n">pos_embed</span><span class="p">,</span> <span class="n">key_padding_mask</span><span class="o">=</span><span class="n">key_padding_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># (B, D)</span>
<span class="n">latent_pdf_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_encoder_latent_output_proj</span><span class="p">(</span><span class="n">cls_token_out</span><span class="p">)</span>  <span class="c1"># (B, 2*latent_dim)</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">latent_pdf_params</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">]</span>  <span class="c1"># å‡å€¼ (B, latent_dim)</span>
<span class="n">log_sigma_x2</span> <span class="o">=</span> <span class="n">latent_pdf_params</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">:]</span>  <span class="c1"># 2*log(æ ‡å‡†å·®) (B, latent_dim)</span>

<span class="c1"># é‡å‚æ•°åŒ–é‡‡æ · latent å‘é‡</span>
<span class="n">latent_sample</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">log_sigma_x2</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>  <span class="c1"># (B, latent_dim)</span>
</code></pre></div>
<p>å°†åŠ¨ä½œåºåˆ—ç¼–ç ä¸º latent åˆ†å¸ƒï¼ˆå‡å€¼ muã€æ–¹å·®ç›¸å…³å‚æ•° log_sigma_x2ï¼‰ï¼Œå¹¶é€šè¿‡é‡å‚æ•°åŒ–æŠ€å·§é‡‡æ ·å¾—åˆ° latent å‘é‡ï¼Œä½œä¸º Transformer ç¼–ç å™¨çš„æ ¸å¿ƒè¾“å…¥ã€‚</p>
<p><strong>ï¼ˆ3ï¼‰æ— VAEæ—¶çš„latentå‘é‡åˆå§‹åŒ–</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">mu</span> <span class="o">=</span> <span class="n">log_sigma_x2</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">latent_sample</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">"observation.state"</span><span class="p">]</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</code></pre></div>
<p>å¦‚æœä¸å¯ç”¨VAEæˆ–éè®­ç»ƒæ¨¡å¼ï¼Œç›´æ¥ä½¿ç”¨é›¶å‘é‡ä½œä¸ºlatentè¾“å…¥ã€‚</p>
<p><strong>ï¼ˆ4ï¼‰transformerç¼–ç å™¨è¾“å…¥æ„å»º</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">encoder_in_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder_latent_input_proj</span><span class="p">(</span><span class="n">latent_sample</span><span class="p">)]</span>  <span class="c1"># latent æŠ•å½±ï¼š(B, latent_dim) â†’ (B, dim_model)</span>
<span class="n">encoder_in_pos_embed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder_1d_feature_pos_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># 1D token ä½ç½®åµŒå…¥ï¼š(n_1d_tokens, 1, dim_model)</span>

<span class="c1"># æ·»åŠ æœºå™¨äººçŠ¶æ€ tokenï¼ˆè‹¥å¯ç”¨ï¼‰</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">robot_state_feature</span><span class="p">:</span>
    <span class="n">encoder_in_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder_robot_state_input_proj</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">"observation.state"</span><span class="p">]))</span>  <span class="c1"># (B, dim_model)</span>

<span class="c1"># æ·»åŠ ç¯å¢ƒçŠ¶æ€ tokenï¼ˆè‹¥å¯ç”¨ï¼‰</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">env_state_feature</span><span class="p">:</span>
    <span class="n">encoder_in_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder_env_state_input_proj</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">"observation.environment_state"</span><span class="p">]))</span>  <span class="c1"># (B, dim_model)</span>
</code></pre></div>
<p>1Dç‰¹å¾tokenå¤„ç†ï¼Œé€šè¿‡çº¿æ€§å±‚ï¼ˆnn.Linearï¼‰å°† latent å‘é‡ã€æœºå™¨äºº/ç¯å¢ƒçŠ¶æ€çš„åŸå§‹ç»´åº¦æ˜ å°„åˆ°æ¨¡å‹éšè—ç»´åº¦ dim_modelï¼Œç¡®ä¿å„ token ç»´åº¦ä¸€è‡´ã€‚ä¸ºæ¯ä¸ª 1D tokenï¼ˆlatentã€çŠ¶æ€ï¼‰åˆ†é…å¯å­¦ä¹ çš„ä½ç½®åµŒå…¥ï¼Œç¼–ç å…¶åœ¨åºåˆ—ä¸­çš„ä½ç½®ä¿¡æ¯ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">image_features</span><span class="p">:</span>
    <span class="n">all_cam_features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_cam_pos_embeds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">"observation.images"</span><span class="p">]:</span>  <span class="c1"># éå†å¤šç›¸æœºå›¾åƒ</span>
        <span class="c1"># éª¨å¹²ç½‘ç»œæå–ç‰¹å¾å›¾ï¼ˆå¦‚ ResNet layer4 è¾“å‡ºï¼‰</span>
        <span class="n">cam_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="s2">"feature_map"</span><span class="p">]</span>  <span class="c1"># (B, C_backbone, H, W)</span>
        <span class="c1"># å›¾åƒä½ç½®åµŒå…¥ï¼ˆ2D æ­£å¼¦ä½ç½®ç¼–ç ï¼‰</span>
        <span class="n">cam_pos_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_cam_feat_pos_embed</span><span class="p">(</span><span class="n">cam_features</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">cam_features</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>  <span class="c1"># (1, dim_model, H, W)</span>
        <span class="c1"># ç‰¹å¾æŠ•å½±ï¼šè°ƒæ•´é€šé“æ•°è‡³ dim_model</span>
        <span class="n">cam_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_img_feat_input_proj</span><span class="p">(</span><span class="n">cam_features</span><span class="p">)</span>  <span class="c1"># (B, dim_model, H, W)</span>
        <span class="c1"># å±•å¹³ä¸ºåºåˆ—ï¼š(H*W, B, dim_model)</span>
        <span class="n">cam_features</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">cam_features</span><span class="p">,</span> <span class="s2">"b c h w -&gt; (h w) b c"</span><span class="p">)</span>
        <span class="n">cam_pos_embed</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">cam_pos_embed</span><span class="p">,</span> <span class="s2">"b c h w -&gt; (h w) b c"</span><span class="p">)</span>
        <span class="n">all_cam_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cam_features</span><span class="p">)</span>
        <span class="n">all_cam_pos_embeds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cam_pos_embed</span><span class="p">)</span>
    <span class="c1"># æ‹¼æ¥å¤šç›¸æœºç‰¹å¾</span>
    <span class="n">encoder_in_tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">all_cam_features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">encoder_in_pos_embed</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">all_cam_pos_embeds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>
<p>å¯¹äºå›¾åƒçš„ç‰¹å¾è¾“å…¥ï¼Œå¯ç”¨å›¾åƒè¾“å…¥ï¼Œé€šè¿‡è§†è§‰éª¨å¹²ç½‘ç»œæå–ç‰¹å¾å¹¶è½¬æ¢ä¸ºåºåˆ— tokenã€‚é€šè¿‡ 1x1 å·ç§¯ï¼ˆencoder_img_feat_input_projï¼‰å°†ç‰¹å¾å›¾é€šé“æ•°è°ƒæ•´ä¸º dim_modelï¼Œå†å±•å¹³ä¸ºåºåˆ— tokenï¼ˆH*W ä¸ªåƒç´  tokenï¼‰ã€‚é€šè¿‡ ACTSinusoidalPositionEmbedding2d ä¸ºåƒç´  token æ·»åŠ ç©ºé—´ä½ç½®ä¿¡æ¯ï¼Œç¼–ç å…¶åœ¨ç‰¹å¾å›¾ä¸­çš„ (H, W) åæ ‡ã€‚</p>
<p><strong>ï¼ˆ5ï¼‰transformerç¼–ç å™¨-è§£ç å™¨å‰å‘ä¼ æ’­</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å †å æ‰€æœ‰è¾“å…¥ token å’Œä½ç½®åµŒå…¥</span>
<span class="n">encoder_in_tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">encoder_in_tokens</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (seq_len, B, dim_model)</span>
<span class="n">encoder_in_pos_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">encoder_in_pos_embed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (seq_len, 1, dim_model)</span>

<span class="c1"># ç¼–ç å™¨å‰å‘ä¼ æ’­</span>
<span class="n">encoder_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">encoder_in_tokens</span><span class="p">,</span> <span class="n">pos_embed</span><span class="o">=</span><span class="n">encoder_in_pos_embed</span><span class="p">)</span>  <span class="c1"># (seq_len, B, dim_model)</span>
</code></pre></div>
<p>ä¸Šé¢ä¸ºç¼–ç å™¨è¾“å‡ºï¼Œè¾“å…¥åºåˆ—ä¸ºåŒ…å« 1D ç‰¹å¾ tokenï¼ˆlatentã€çŠ¶æ€ï¼‰å’Œå›¾åƒåƒç´  tokenï¼Œæ€»é•¿åº¦ä¸º seq_len = n_1d_tokens + sum(H*W for å„ç›¸æœº)ã€‚é€šè¿‡è‡ªæ³¨æ„åŠ›æœºåˆ¶èåˆå¤šæ¨¡æ€è¾“å…¥ï¼Œè¾“å‡ºåŒ…å«å…¨å±€ä¸Šä¸‹æ–‡çš„ç‰¹å¾åºåˆ— encoder_outã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è§£ç å™¨è¾“å…¥åˆå§‹åŒ–ä¸ºé›¶å‘é‡ï¼ˆç±»ä¼¼ DETR çš„ç›®æ ‡æŸ¥è¯¢ï¼‰</span>
<span class="n">decoder_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">encoder_in_pos_embed</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">encoder_in_pos_embed</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># (chunk_size, B, dim_model)</span>

<span class="c1"># è§£ç å™¨å‰å‘ä¼ æ’­ï¼ˆäº¤å‰æ³¨æ„åŠ›èåˆç¼–ç å™¨è¾“å‡ºï¼‰</span>
<span class="n">decoder_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
    <span class="n">decoder_in</span><span class="p">,</span>
    <span class="n">encoder_out</span><span class="p">,</span>
    <span class="n">encoder_pos_embed</span><span class="o">=</span><span class="n">encoder_in_pos_embed</span><span class="p">,</span>  <span class="c1"># ç¼–ç å™¨ä½ç½®åµŒå…¥</span>
    <span class="n">decoder_pos_embed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder_pos_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># è§£ç å™¨åŠ¨ä½œåºåˆ—ä½ç½®åµŒå…¥</span>
<span class="p">)</span>  <span class="c1"># (chunk_size, B, dim_model)</span>

<span class="c1"># è½¬æ¢ç»´åº¦å¹¶æŠ•å½±åˆ°åŠ¨ä½œç©ºé—´</span>
<span class="n">decoder_out</span> <span class="o">=</span> <span class="n">decoder_out</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (B, chunk_size, dim_model)</span>
<span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_head</span><span class="p">(</span><span class="n">decoder_out</span><span class="p">)</span>  <span class="c1"># (B, chunk_size, action_dim)</span>

<span class="k">return</span> <span class="n">actions</span><span class="p">,</span> <span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">log_sigma_x2</span><span class="p">)</span>
</code></pre></div>
<p>è§£ç å™¨éƒ¨åˆ†ï¼Œåˆå§‹åŒ–ä¸ºé›¶å‘é‡åºåˆ—ï¼ˆé•¿åº¦ chunk_sizeï¼Œå³ä¸€æ¬¡é¢„æµ‹çš„åŠ¨ä½œæ•°é‡ï¼‰ï¼Œç±»ä¼¼ DETR çš„â€œç›®æ ‡æŸ¥è¯¢â€ã€‚è§£ç å™¨é€šè¿‡äº¤å‰æ³¨æ„åŠ›æœºåˆ¶å…³æ³¨ç¼–ç å™¨è¾“å‡ºçš„ä¸Šä¸‹æ–‡ç‰¹å¾ï¼Œç”ŸæˆåŠ¨ä½œåºåˆ—ç‰¹å¾ã€‚é€šè¿‡ action_headï¼ˆçº¿æ€§å±‚ï¼‰å°†è§£ç å™¨è¾“å‡ºçš„é«˜ç»´ç‰¹å¾æŠ•å½±åˆ°æœºå™¨äººåŠ¨ä½œç©ºé—´ç»´åº¦ï¼ˆaction_dimï¼‰ï¼Œå¾—åˆ°æœ€ç»ˆåŠ¨ä½œåºåˆ—ã€‚</p>
<p>æœ€ç»ˆè¿”å›actionså’Œ(mu, log_sigma_x2)ã€‚å‰è€…æ˜¯å½¢çŠ¶ (B, chunk_size, action_dim)ï¼Œé¢„æµ‹çš„åŠ¨ä½œåºåˆ—ï¼›åè€…æ˜¯è‹¥å¯ç”¨ VAEï¼Œè¿”å› latent åˆ†å¸ƒçš„å‡å€¼å’Œæ–¹å·®å‚æ•°ï¼ˆlog_sigma_x2 = 2*log(Ïƒ)ï¼‰ï¼Œå¦åˆ™ä¸º (None, None)ã€‚</p>
<h2 id="act_1">ACTç¼–ç å™¨</h2>
<h3 id="actencoder">ACTEncoder</h3>
<p>ACTEncoder æ˜¯ Transformer ç¼–ç å™¨çš„é¡¶å±‚å®¹å™¨ï¼Œè´Ÿè´£å †å å¤šä¸ª ACTEncoderLayerï¼ˆç¼–ç å™¨å±‚ï¼‰å¹¶æ‰§è¡Œæœ€ç»ˆå½’ä¸€åŒ–ï¼Œæ”¯æŒ VAE ç¼–ç å™¨ å’Œ ä¸» Transformer ç¼–ç å™¨ ä¸¤ç§è§’è‰²ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ACTEncoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ACTConfig</span><span class="p">,</span> <span class="n">is_vae_encoder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_vae_encoder</span> <span class="o">=</span> <span class="n">is_vae_encoder</span>
        <span class="c1"># æ ¹æ®è§’è‰²é€‰æ‹©ç¼–ç å™¨å±‚æ•°ï¼ˆVAE ç¼–ç å™¨ vs ä¸»ç¼–ç å™¨ï¼‰</span>
        <span class="n">num_layers</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">n_vae_encoder_layers</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_vae_encoder</span> <span class="k">else</span> <span class="n">config</span><span class="o">.</span><span class="n">n_encoder_layers</span>
        <span class="c1"># å †å  num_layers ä¸ªç¼–ç å™¨å±‚</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">ACTEncoderLayer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">)])</span>
        <span class="c1"># æœ€ç»ˆå½’ä¸€åŒ–ï¼ˆé¢„å½’ä¸€åŒ–æ¨¡å¼ä¸‹å¯ç”¨ï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">)</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">pre_norm</span> <span class="k">else</span> <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
</code></pre></div>
<p>é€šè¿‡ is_vae_encoder åŒºåˆ†è§’è‰²ï¼Œåˆ†åˆ«ä½¿ç”¨ n_vae_encoder_layersï¼ˆVAE ä¸“ç”¨å±‚æ•°ï¼‰æˆ– n_encoder_layersï¼ˆä¸»ç¼–ç å™¨å±‚æ•°ï¼‰ã€‚é€šè¿‡ nn.ModuleList ç®¡ç†å¤šä¸ª ACTEncoderLayerï¼Œå½¢æˆæ·±åº¦ç¼–ç å™¨ç»“æ„ã€‚è‹¥ config.pre_norm=Trueï¼ˆé¢„å½’ä¸€åŒ–ï¼‰ï¼Œå¯¹æ‰€æœ‰å±‚è¾“å‡ºåšæœ€ç»ˆå½’ä¸€åŒ–ï¼›å¦åˆ™ä½¿ç”¨ nn.Identityï¼ˆæ— æ“ä½œï¼‰ï¼Œæ­¤æ—¶å½’ä¸€åŒ–åœ¨æ¯å±‚å†…éƒ¨å®Œæˆï¼ˆåå½’ä¸€åŒ–ï¼‰ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">pos_embed</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">key_padding_mask</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pos_embed</span><span class="o">=</span><span class="n">pos_embed</span><span class="p">,</span> <span class="n">key_padding_mask</span><span class="o">=</span><span class="n">key_padding_mask</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div>
<ul>
<li>é€å±‚ç‰¹å¾æå–ï¼šè¾“å…¥å¼ é‡ xï¼ˆå½¢çŠ¶é€šå¸¸ä¸º (seq_len, batch_size, dim_model)ï¼‰ä¾æ¬¡é€šè¿‡æ‰€æœ‰ ACTEncoderLayerï¼Œæ¯å±‚èåˆè‡ªæ³¨æ„åŠ›å’Œå‰é¦ˆç½‘ç»œç‰¹å¾ã€‚</li>
<li>ä½ç½®åµŒå…¥ä¸æ©ç ï¼špos_embed æä¾›åºåˆ—ä½ç½®ä¿¡æ¯ï¼Œkey_padding_mask æ ‡è®°éœ€å¿½ç•¥çš„å¡«å……ä½ç½®ï¼Œä¸¤è€…å‡ä¼ é€’ç»™æ¯å±‚ã€‚</li>
<li>æœ€ç»ˆå½’ä¸€åŒ–ï¼šæ‰€æœ‰å±‚å¤„ç†å®Œæ¯•åï¼Œé€šè¿‡ self.norm è¾“å‡ºæœ€ç»ˆç‰¹å¾ã€‚</li>
</ul>
<h3 id="actencoderlayer">ACTEncoderLayer</h3>
<p>ä¸‹é¢æ˜¯å•ä¸ªç¼–ç å™¨å±‚çš„å®ç°</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ACTEncoderLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ACTConfig</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># è‡ªæ³¨æ„åŠ›æ¨¡å—</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">n_heads</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
        <span class="c1"># å‰é¦ˆç½‘ç»œï¼ˆLinear -&gt; Activation -&gt; Dropout -&gt; Linearï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">dim_feedforward</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_feedforward</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">)</span>
        <span class="c1"># å½’ä¸€åŒ–ä¸ dropout å±‚</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
        <span class="c1"># æ¿€æ´»å‡½æ•°ä¸å½’ä¸€åŒ–æ¨¡å¼æ ‡è®°</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">get_activation_fn</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">feedforward_activation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_norm</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pre_norm</span>
</code></pre></div>
<p>ACTEncoderLayer æ˜¯ç¼–ç å™¨çš„æ ¸å¿ƒè®¡ç®—å•å…ƒï¼ŒåŒ…å« è‡ªæ³¨æ„åŠ›æœºåˆ¶ã€å‰é¦ˆç½‘ç»œ å’Œ æ®‹å·®è¿æ¥ï¼Œæ”¯æŒé¢„å½’ä¸€åŒ–ï¼ˆPreNormï¼‰æˆ–åå½’ä¸€åŒ–ï¼ˆPostNormï¼‰æ¨¡å¼ã€‚</p>
<ul>
<li>è‡ªæ³¨æ„åŠ›ï¼šnn.MultiheadAttention å®ç°å¤šå¤´æ³¨æ„åŠ›ï¼Œè¾“å…¥ç»´åº¦ dim_modelï¼Œå¤´æ•° n_headsã€‚</li>
<li>å‰é¦ˆç½‘ç»œï¼šå°†ç‰¹å¾ä» dim_model æ˜ å°„åˆ° dim_feedforwardï¼ˆæ‰©å±•ç»´åº¦ï¼‰ï¼Œç»æ¿€æ´»å’Œ dropout åæ˜ å°„å› dim_modelã€‚</li>
<li>å½’ä¸€åŒ–ä¸ dropoutï¼šæ¯å±‚åŒ…å«ä¸¤ä¸ªå½’ä¸€åŒ–å±‚ï¼ˆnorm1 ç”¨äºæ³¨æ„åŠ›ï¼Œnorm2 ç”¨äºå‰é¦ˆç½‘ç»œï¼‰å’Œä¸¤ä¸ª dropout å±‚ï¼Œå¢å¼ºè®­ç»ƒç¨³å®šæ€§ã€‚</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">pos_embed</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">key_padding_mask</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="c1"># è‡ªæ³¨æ„åŠ›æ¨¡å— + æ®‹å·®è¿æ¥</span>
    <span class="n">skip</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_norm</span><span class="p">:</span>  <span class="c1"># é¢„å½’ä¸€åŒ–ï¼šå…ˆå½’ä¸€åŒ–å†è®¡ç®—æ³¨æ„åŠ›</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="n">x</span> <span class="k">if</span> <span class="n">pos_embed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span> <span class="o">+</span> <span class="n">pos_embed</span>  <span class="c1">#  query å’Œ key èåˆä½ç½®åµŒå…¥</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">key_padding_mask</span><span class="o">=</span><span class="n">key_padding_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># å–æ³¨æ„åŠ›è¾“å‡ºï¼ˆå¿½ç•¥æƒé‡ï¼‰</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">skip</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># æ®‹å·®è¿æ¥ + dropout</span>

    <span class="c1"># å‰é¦ˆç½‘ç»œæ¨¡å— + æ®‹å·®è¿æ¥</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_norm</span><span class="p">:</span>  <span class="c1"># é¢„å½’ä¸€åŒ–ï¼šå…ˆå½’ä¸€åŒ–å†è®¡ç®—å‰é¦ˆ</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># åå½’ä¸€åŒ–ï¼šå…ˆè®¡ç®—æ³¨æ„åŠ›å†å½’ä¸€åŒ–</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear1</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>  <span class="c1"># å‰é¦ˆç½‘ç»œ</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">skip</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># æ®‹å·®è¿æ¥ + dropout</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_norm</span><span class="p">:</span>  <span class="c1"># åå½’ä¸€åŒ–ï¼šæœ€åå½’ä¸€åŒ–è¾“å‡º</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div>
<p>ä¸Šé¢æ˜¯forwardæ–¹æ³•ï¼Œå¯ä»¥åˆ†ä¸ºè‡ªæ³¨æ„åŠ›é˜¶æ®µå’Œå‰é¦ˆç½‘ç»œé˜¶æ®µã€‚</p>
<ul>
<li>è‡ªæ³¨æ„åŠ›é˜¶æ®µï¼šæ®‹å·®è¿æ¥ï¼Œskip ä¿å­˜è¾“å…¥ï¼Œæ³¨æ„åŠ›è¾“å‡ºç» dropout1 åä¸ skip ç›¸åŠ ã€‚ä½ç½®åµŒå…¥ï¼Œq å’Œ k è‹¥æœ‰ pos_embed åˆ™å åŠ ä½ç½®ä¿¡æ¯ï¼Œå¸®åŠ©æ¨¡å‹æ•æ‰åºåˆ—é¡ºåºã€‚å½’ä¸€åŒ–æ—¶æœºï¼Œpre_norm=True æ—¶ï¼Œå…ˆå¯¹ x å½’ä¸€åŒ–ï¼ˆnorm1ï¼‰å†è®¡ç®—æ³¨æ„åŠ›ï¼›å¦åˆ™åå½’ä¸€åŒ–ï¼ˆæ³¨æ„åŠ›åé€šè¿‡ norm1 å½’ä¸€åŒ–ï¼‰ã€‚</li>
<li>å‰é¦ˆç½‘ç»œé˜¶æ®µï¼šå‰é¦ˆè®¡ç®—ï¼Œx ç»çº¿æ€§å±‚æ‰©å±•ç»´åº¦ã€æ¿€æ´»ï¼ˆå¦‚ ReLU/GELUï¼‰ã€dropoutã€çº¿æ€§å±‚å‹ç¼©ç»´åº¦ã€‚æ®‹å·®ä¸å½’ä¸€åŒ–ï¼Œç±»ä¼¼æ³¨æ„åŠ›é˜¶æ®µï¼Œpre_norm å†³å®šå½’ä¸€åŒ–æ—¶æœºï¼Œæœ€ç»ˆè¾“å‡ºèåˆæ®‹å·®çš„ç‰¹å¾ã€‚</li>
</ul>
<p>æ€»ç»“ä¸€ä¸‹ï¼ŒACTEncoderï¼Œé€šè¿‡å †å å¤šä¸ª ACTEncoderLayer å®ç°æ·±åº¦ç¼–ç ï¼ŒåŠ¨æ€é€‚é… VAE æˆ–ä¸»ç¼–ç å™¨è§’è‰²ï¼Œè¾“å‡ºèåˆå…¨å±€ä¾èµ–çš„åºåˆ—ç‰¹å¾ã€‚ACTEncoderLayerï¼Œå•ä¸ªç¼–ç å™¨å±‚æ ¸å¿ƒï¼Œé€šè¿‡â€œè‡ªæ³¨æ„åŠ›+å‰é¦ˆç½‘ç»œ+æ®‹å·®è¿æ¥â€æå–å±€éƒ¨ä¸å…¨å±€ç‰¹å¾ï¼Œæ”¯æŒé¢„/åå½’ä¸€åŒ–æ¨¡å¼ï¼Œæ˜¯ Transformer ç¼–ç å™¨çš„åŸºç¡€ç»„ä»¶ã€‚ä¸¤è€…ååŒæ„æˆ ACT æ¨¡å‹çš„ç¼–ç å™¨éƒ¨åˆ†ï¼Œè´Ÿè´£å°†å¤šæ¨¡æ€è¾“å…¥ï¼ˆå¦‚å›¾åƒã€çŠ¶æ€ï¼‰ç¼–ç ä¸ºä¸Šä¸‹æ–‡ç‰¹å¾ï¼Œä¾›è§£ç å™¨ç”ŸæˆåŠ¨ä½œåºåˆ—ã€‚</p>
<h2 id="act_2">ACTè§£ç å™¨</h2>
<h3 id="actdecoder">ACTDecoder</h3>
<p>ACTDecoder æ˜¯ Transformer è§£ç å™¨çš„é¡¶å±‚æ¨¡å—ï¼Œè´Ÿè´£å †å å¤šä¸ª ACTDecoderLayerï¼ˆè§£ç å™¨å­å±‚ï¼‰å¹¶å¯¹æœ€ç»ˆè¾“å‡ºè¿›è¡Œå½’ä¸€åŒ–ï¼Œå®ç°ä»ç¼–ç å™¨ä¸Šä¸‹æ–‡ç‰¹å¾åˆ°åŠ¨ä½œåºåˆ—çš„æ˜ å°„ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ACTDecoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ACTConfig</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">ACTDecoderLayer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">n_decoder_layers</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">)</span>
</code></pre></div>
<p>é€šè¿‡ nn.ModuleList åˆ›å»º config.n_decoder_layers ä¸ª ACTDecoderLayer å®ä¾‹ï¼Œæ„æˆæ·±åº¦è§£ç å™¨ï¼ˆæ¯å±‚åŒ…å«è‡ªæ³¨æ„åŠ›ã€äº¤å‰æ³¨æ„åŠ›å’Œå‰é¦ˆç½‘ç»œï¼‰ã€‚ä½¿ç”¨ nn.LayerNorm å¯¹æ‰€æœ‰è§£ç å™¨å±‚çš„è¾“å‡ºè¿›è¡Œå½’ä¸€åŒ–ï¼Œç¨³å®šè®­ç»ƒè¿‡ç¨‹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
    <span class="n">encoder_out</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
    <span class="n">decoder_pos_embed</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">encoder_pos_embed</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">encoder_out</span><span class="p">,</span> <span class="n">decoder_pos_embed</span><span class="o">=</span><span class="n">decoder_pos_embed</span><span class="p">,</span> <span class="n">encoder_pos_embed</span><span class="o">=</span><span class="n">encoder_pos_embed</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div>
<p>è¾“å…¥å‚æ•°å¦‚ä¸‹ï¼š</p>
<ul>
<li>xï¼šè§£ç å™¨è¾“å…¥åºåˆ—ï¼ˆåˆå§‹ä¸ºé›¶å‘é‡ï¼Œå½¢çŠ¶ (chunk_size, batch_size, dim_model)ï¼Œchunk_size ä¸ºåŠ¨ä½œåºåˆ—é•¿åº¦ï¼‰ï¼›</li>
<li>encoder_outï¼šç¼–ç å™¨è¾“å‡ºç‰¹å¾ï¼ˆå½¢çŠ¶ (encoder_seq_len, batch_size, dim_model)ï¼‰ï¼›</li>
<li>decoder_pos_embedï¼šè§£ç å™¨ä½ç½®åµŒå…¥ï¼ˆä¸ºåŠ¨ä½œåºåˆ—æä¾›æ—¶åºä½ç½®ä¿¡æ¯ï¼‰ï¼›</li>
<li>encoder_pos_embedï¼šç¼–ç å™¨ä½ç½®åµŒå…¥ï¼ˆä¸ºç¼–ç å™¨ç‰¹å¾æä¾›ä½ç½®ä¿¡æ¯ï¼Œè¾…åŠ©äº¤å‰æ³¨æ„åŠ›ï¼‰ã€‚</li>
</ul>
<p>å°†è¾“å…¥ xã€ç¼–ç å™¨è¾“å‡º encoder_out åŠä½ç½®åµŒå…¥ä¾æ¬¡ä¼ å…¥æ¯ä¸ª ACTDecoderLayerï¼Œæ›´æ–° x ä¸ºæ¯å±‚è¾“å‡ºã€‚æ‰€æœ‰å±‚å¤„ç†å®Œæ¯•åï¼Œé€šè¿‡ self.norm å¯¹è¾“å‡ºè¿›è¡Œå½’ä¸€åŒ–ï¼Œè¿”å›å½¢çŠ¶ä¸º (chunk_size, batch_size, dim_model) çš„ç‰¹å¾å¼ é‡ï¼ˆåç»­å°†æ˜ å°„ä¸ºåŠ¨ä½œåºåˆ—ï¼‰ã€‚</p>
<h3 id="actdecoderlayer">ACTDecoderLayer</h3>
<p>ä¸‹é¢å†ä»‹ç»ä¸‹ACTDecoderLayerã€‚</p>
<p>ACTDecoderLayer æ˜¯è§£ç å™¨çš„åŸºç¡€å•å…ƒï¼ŒåŒ…å« è‡ªæ³¨æ„åŠ›ï¼ˆæ•æ‰åŠ¨ä½œåºåˆ—å†…éƒ¨ä¾èµ–ï¼‰ã€äº¤å‰æ³¨æ„åŠ›ï¼ˆèåˆç¼–ç å™¨ä¸Šä¸‹æ–‡ç‰¹å¾ï¼‰å’Œ å‰é¦ˆç½‘ç»œï¼ˆå¢å¼ºç‰¹å¾è¡¨è¾¾èƒ½åŠ›ï¼‰ä¸‰å¤§æ¨¡å—ï¼Œæ”¯æŒé¢„å½’ä¸€åŒ–ï¼ˆPreNormï¼‰æˆ–åå½’ä¸€åŒ–ï¼ˆPostNormï¼‰æ¨¡å¼ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ACTDecoderLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ACTConfig</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># è‡ªæ³¨æ„åŠ›ï¼ˆè§£ç å™¨å†…éƒ¨æ—¶åºä¾èµ–å»ºæ¨¡ï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">n_heads</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
        <span class="c1"># äº¤å‰æ³¨æ„åŠ›ï¼ˆèåˆç¼–ç å™¨è¾“å‡ºç‰¹å¾ï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multihead_attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">n_heads</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
        <span class="c1"># å‰é¦ˆç½‘ç»œï¼ˆç‰¹å¾å˜æ¢ä¸å¢å¼ºï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">dim_feedforward</span><span class="p">)</span>  <span class="c1"># å‡ç»´</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_feedforward</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">)</span>  <span class="c1"># é™ç»´</span>
        <span class="c1"># å½’ä¸€åŒ–å±‚ï¼ˆ3ä¸ªï¼Œåˆ†åˆ«å¯¹åº”è‡ªæ³¨æ„åŠ›ã€äº¤å‰æ³¨æ„åŠ›ã€å‰é¦ˆç½‘ç»œï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm3</span> <span class="o">=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dim_model</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="c1"># Dropoutå±‚ï¼ˆ3ä¸ªï¼Œå¢å¼ºæ­£åˆ™åŒ–ï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout3</span> <span class="o">=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="c1"># æ¿€æ´»å‡½æ•°ï¼ˆå¦‚ReLU/GELUï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">get_activation_fn</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">feedforward_activation</span><span class="p">)</span>
        <span class="c1"># å½’ä¸€åŒ–æ¨¡å¼æ ‡è®°ï¼ˆPreNorm/PostNormï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_norm</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pre_norm</span>
</code></pre></div>
<p>å‰å‘ä¼ æ’­forwardå¯ä»¥åˆ†ä¸º3ä¸ªé˜¶æ®µï¼Œåˆ†ä¸ºè‡ªæ³¨æ„åŠ›-&gt;äº¤å‰æ³¨æ„åŠ›-&gt;å‰é¦ˆç½‘ç»œï¼Œæ¯ä¸ªé˜¶æ®µéƒ½åŒ…å«å½’ä¸€åŒ–-&gt;è®¡ç®—-&gt;dropout-&gt;æ®‹å·®è¿æ¥çš„é€»è¾‘ã€‚</p>
<p><strong>ï¼ˆ1ï¼‰è‡ªæ³¨æ„åŠ›é˜¶æ®µ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">skip</span> <span class="o">=</span> <span class="n">x</span>  <span class="c1"># æ®‹å·®è¿æ¥çš„è¾“å…¥</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_norm</span><span class="p">:</span>  <span class="c1"># é¢„å½’ä¸€åŒ–ï¼šå…ˆå½’ä¸€åŒ–ï¼Œå†è®¡ç®—æ³¨æ„åŠ›</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1"># Queryå’ŒKeyèåˆä½ç½®åµŒå…¥ï¼ˆValueä¸èåˆï¼Œä¿æŒåŸå§‹ç‰¹å¾ï¼‰</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_add_pos_embed</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">decoder_pos_embed</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># è‡ªæ³¨æ„åŠ›è¾“å‡ºï¼ˆå¿½ç•¥æ³¨æ„åŠ›æƒé‡ï¼‰</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">skip</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># æ®‹å·®è¿æ¥ + Dropout</span>
</code></pre></div>
<p><strong>ï¼ˆ2ï¼‰äº¤å‰æ³¨æ„åŠ›é˜¶æ®µ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_norm</span><span class="p">:</span>  <span class="c1"># é¢„å½’ä¸€åŒ–ï¼šæ›´æ–°æ®‹å·®è¾“å…¥ï¼Œå½’ä¸€åŒ–å½“å‰ç‰¹å¾</span>
    <span class="n">skip</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># åå½’ä¸€åŒ–ï¼šå…ˆå½’ä¸€åŒ–è‡ªæ³¨æ„åŠ›è¾“å‡ºï¼Œå†æ›´æ–°æ®‹å·®è¾“å…¥</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">skip</span> <span class="o">=</span> <span class="n">x</span>
<span class="c1"># Queryï¼ˆè§£ç å™¨ç‰¹å¾ï¼‰èåˆè§£ç å™¨ä½ç½®åµŒå…¥ï¼ŒKeyï¼ˆç¼–ç å™¨ç‰¹å¾ï¼‰èåˆç¼–ç å™¨ä½ç½®åµŒå…¥</span>
<span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multihead_attn</span><span class="p">(</span>
    <span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maybe_add_pos_embed</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">decoder_pos_embed</span><span class="p">),</span>
    <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maybe_add_pos_embed</span><span class="p">(</span><span class="n">encoder_out</span><span class="p">,</span> <span class="n">encoder_pos_embed</span><span class="p">),</span>
    <span class="n">value</span><span class="o">=</span><span class="n">encoder_out</span><span class="p">,</span>
<span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># äº¤å‰æ³¨æ„åŠ›è¾“å‡ºï¼ˆå¿½ç•¥æƒé‡ï¼‰</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">skip</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># æ®‹å·®è¿æ¥ + Dropout</span>
</code></pre></div>
<p><strong>ï¼ˆ3ï¼‰å‰é¦ˆç½‘ç»œ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_norm</span><span class="p">:</span>  <span class="c1"># é¢„å½’ä¸€åŒ–ï¼šæ›´æ–°æ®‹å·®è¾“å…¥ï¼Œå½’ä¸€åŒ–å½“å‰ç‰¹å¾</span>
    <span class="n">skip</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># åå½’ä¸€åŒ–ï¼šå…ˆå½’ä¸€åŒ–äº¤å‰æ³¨æ„åŠ›è¾“å‡ºï¼Œå†æ›´æ–°æ®‹å·®è¾“å…¥</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">skip</span> <span class="o">=</span> <span class="n">x</span>
<span class="c1"># å‰é¦ˆç½‘ç»œï¼šå‡ç»´â†’æ¿€æ´»â†’Dropoutâ†’é™ç»´</span>
<span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear1</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">skip</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># æ®‹å·®è¿æ¥ + Dropout</span>
<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_norm</span><span class="p">:</span>  <span class="c1"># åå½’ä¸€åŒ–ï¼šæœ€åå½’ä¸€åŒ–å‰é¦ˆç½‘ç»œè¾“å‡º</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="å†è®ºtransformeråŸç†.html">â† å†è®ºtransformeråŸç†</a>
    <a class="next" href="å…·èº«æ™ºèƒ½actç®—æ³•.html">å…·èº«æ™ºèƒ½ACTç®—æ³• â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

