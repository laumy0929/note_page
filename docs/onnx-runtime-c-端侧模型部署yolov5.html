<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ONNX Runtime C++ç«¯ä¾§æ¨¡å‹éƒ¨ç½²YOLOv5 - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">åŠ è½½å‡†å¤‡</a><ul><li><a href="#onnxruntime">åˆå§‹åŒ–ONNXRuntimeç¯å¢ƒ</a></li><li><a href="#_2">è®¾ç½®ä¼šè¯å‚æ•°</a></li></ul></li><li><a href="#_3">æ¨¡å‹åŠ è½½</a><ul></ul></li><li><a href="#_4">è·å–è¾“å…¥å’Œè¾“å‡ºä¿¡æ¯</a><ul><li><a href="#_5">è¾“å…¥åç§°</a></li><li><a href="#_6">è¾“å…¥å¼ é‡ç»´åº¦</a></li><li><a href="#_7">è¾“å‡ºåç§°</a></li></ul></li><li><a href="#_8">è¾“å…¥é¢„å¤„ç†</a><ul></ul></li><li><a href="#_9">æ¨¡å‹æ¨ç†</a><ul></ul></li><li><a href="#_10">è¾“å‡ºåå¤„ç†</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>ONNX Runtime C++ç«¯ä¾§æ¨¡å‹éƒ¨ç½²YOLOv5</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2025-06-19
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      ai
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">åŠ è½½å‡†å¤‡</h2>
<h3 id="onnxruntime">åˆå§‹åŒ–ONNXRuntimeç¯å¢ƒ</h3>
<div class="codehilite"><pre><span></span><code><span class="n">Ort</span><span class="o">::</span><span class="n">Env</span><span class="w"> </span><span class="n">env</span><span class="p">(</span><span class="n">ORT_LOGGING_LEVEL_WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">"YOLOv5Inference"</span><span class="p">);</span>
</code></pre></div>
<p>Ort::Env æ˜¯ ONNX Runtime C++ API ä¸­ç”¨äºåˆå§‹åŒ–è¿è¡Œç¯å¢ƒçš„ç±»ï¼Œæœ‰å¤šä¸ªé‡è½½çš„æ„é€ å‡½æ•°ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°åŸå‹åŠå‚æ•°ä½œç”¨å¦‚ä¸‹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">Ort</span><span class="o">::</span><span class="n">Env</span><span class="p">(</span>
<span class="w">    </span><span class="n">OrtLoggingLevel</span><span class="w"> </span><span class="n">logging_level</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">logid</span><span class="p">,</span>
<span class="w">    </span><span class="n">OrtLoggingFunction</span><span class="w"> </span><span class="n">logging_fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">logger_param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span>
<span class="p">);</span>
</code></pre></div>
<ul>
<li>logging_level:æ§åˆ¶æ—¥å¿—è¾“å‡ºçº§åˆ«</li>
<li>logid: è‡ªå®šä¹‰æ—¥å¿—æ ‡ç­¾ï¼Œç”¨äºåŒºåˆ†ä¸åŒæ¨¡å—çš„æ—¥å¿—æ¥æº</li>
<li>logging_fn:è‡ªå®šä¹‰æ—¥å¿—å›è°ƒå‡½æ•°ï¼Œè‹¥ä¸º nullptr åˆ™ä½¿ç”¨é»˜è®¤æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚</li>
<li>logger_param:ä¼ é€’ç»™è‡ªå®šä¹‰æ—¥å¿—å‡½æ•°çš„ç”¨æˆ·å‚æ•°ï¼ˆå¦‚ä¸Šä¸‹æ–‡å¯¹è±¡ï¼‰</li>
</ul>
<h3 id="_2">è®¾ç½®ä¼šè¯å‚æ•°</h3>
<div class="codehilite"><pre><span></span><code><span class="n">Ort</span><span class="o">::</span><span class="n">SessionOptions</span><span class="w"> </span><span class="n">session_options</span><span class="p">;</span>

<span class="n">session_options</span><span class="p">.</span><span class="n">SetIntraOpNumThreads</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">session_options</span><span class="p">.</span><span class="n">SetGraphOptimizationLevel</span><span class="p">(</span><span class="n">GraphOptimizationLevel</span><span class="o">::</span><span class="n">ORT_ENABLE_ALL</span><span class="p">);</span>
</code></pre></div>
<p>åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ä¼šè¯é…ç½®å¯¹è±¡session_optionsï¼ŒSetIntraOpNumThreadsé™åˆ¶å•ä¸ªç®—å­ï¼ˆIntra-opï¼‰å†…éƒ¨ä½¿ç”¨çš„çº¿ç¨‹æ•°ä¸º 1ï¼Œé€‚ç”¨äºè½»é‡çº§ä»»åŠ¡æˆ–é¿å…å¤šçº¿ç¨‹ç«äº‰ï¼ŒSetGraphOptimizationLevelå¯ç”¨æ‰€æœ‰å›¾ä¼˜åŒ–ç­–ç•¥ï¼ˆå¦‚ç®—å­èåˆã€å¸¸é‡æŠ˜å ï¼‰ï¼Œæå‡æ¨ç†æ€§èƒ½ã€‚</p>
<h2 id="_3">æ¨¡å‹åŠ è½½</h2>
<div class="codehilite"><pre><span></span><code><span class="n">Ort</span><span class="o">::</span><span class="n">Session</span><span class="w"> </span><span class="nf">session_</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">modelPath</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">session_options</span><span class="p">);</span>
</code></pre></div>
<p>Ort::Session æ˜¯ ONNX Runtime C++ API ä¸­ç”¨äºåŠ è½½ ONNX æ¨¡å‹å¹¶åˆ›å»ºæ¨ç†ä¼šè¯çš„æ ¸å¿ƒç±»ï¼Œå…¶åŠŸèƒ½åˆ†è§£å¦‚ä¸‹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">Ort</span><span class="o">::</span><span class="n">Session</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Ort</span><span class="o">::</span><span class="n">Env</span><span class="o">&amp;</span><span class="w"> </span><span class="n">env</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">model_path</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Ort</span><span class="o">::</span><span class="n">SessionOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span>
<span class="p">);</span>
</code></pre></div>
<ul>
<li>envï¼šå…¨å±€è¿è¡Œç¯å¢ƒå¯¹è±¡ï¼Œç®¡ç†çº¿ç¨‹æ± å’Œå†…å­˜åˆ†é…ç­‰èµ„æºï¼Œéœ€ä¼˜å…ˆåˆå§‹åŒ–ã€‚</li>
<li>model_pathï¼šONNX æ¨¡å‹æ–‡ä»¶çš„è·¯å¾„ï¼Œcè¯­è¨€çš„å­—ç¬¦ä¸²ç±»å‹ã€‚</li>
<li>optionsï¼šä¼šè¯å‚æ•°ï¼Œé…ç½®ä¼šè¯è¡Œä¸ºï¼Œå¦‚çº¿ç¨‹æ•°ã€ä¼˜åŒ–çº§åˆ«ã€ç¡¬ä»¶åç«¯ç­‰ã€‚</li>
</ul>
<h2 id="_4">è·å–è¾“å…¥å’Œè¾“å‡ºä¿¡æ¯</h2>
<h3 id="_5">è¾“å…¥åç§°</h3>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">Ort</span><span class="o">::</span><span class="n">AllocatorWithDefaultOptions</span><span class="w"> </span><span class="n">allocator</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//åˆ›å»ºé»˜è®¤å†…å­˜åˆ†é…å™¨å¯¹è±¡ï¼Œç”¨äºç®¡ç† ONNX Runtime ä¸­çš„å†…å­˜åˆ†é…ï¼ˆå¦‚èŠ‚ç‚¹åç§°å­—ç¬¦ä¸²çš„å†…å­˜</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">input_node_names_</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//å­˜å‚¨ C é£æ ¼å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œç”¨äºç›´æ¥ä¼ é€’ç»™ ONNX Runtime çš„æ¨ç†æ¥å£</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input_names_</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//å­˜å‚¨æ ‡å‡†å­—ç¬¦ä¸²å¯¹è±¡çš„vectorï¼Œç”¨äºé•¿æœŸç»´æŠ¤å­—ç¬¦ä¸²å†…å­˜</span>

<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">num_inputs_</span><span class="p">;</span>
<span class="w">    </span><span class="n">num_inputs_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session_</span><span class="p">.</span><span class="n">GetInputCount</span><span class="p">();</span>
<span class="w">    </span><span class="c1">//è·å–è¾“å…¥èŠ‚ç‚¹çš„ä¸ªæ•°ï¼Œæœ‰å¤šå°‘ä¸ªèŠ‚ç‚¹å°±å†³å®šäº†å¤šä¸ªä¸ªnameï¼Œä¸€èˆ¬éƒ½æ˜¯1ä¸ªã€‚</span>
<span class="w">    </span><span class="n">input_node_names_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">num_inputs_</span><span class="p">);</span>
<span class="w">    </span><span class="n">input_names_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">num_inputs_</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//é¢„åˆ†é…å®¹å™¨ç©ºé—´ï¼Œé¿å…åŠ¨æ€æ‰©å®¹çš„å¼€é”€</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"num_inputs = "</span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">num_inputs_</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_inputs_</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">input_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session_</span><span class="p">.</span><span class="n">GetInputNameAllocated</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">allocator</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//é€šè¿‡åˆ†é…å™¨å®‰å…¨è·å–ç¬¬ i ä¸ªè¾“å…¥èŠ‚ç‚¹çš„åç§°ï¼ˆè¿”å› Ort::AllocatedStringPtr å¯¹è±¡ï¼‰</span>
<span class="w">        </span><span class="n">input_names_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">input_name</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="w">        </span><span class="c1">//è·å–åç§°çš„åŸå§‹æŒ‡é’ˆï¼Œå­˜å…¥ input_names_ çš„å­—ç¬¦ä¸²ä¸­</span>
<span class="w">        </span><span class="n">input_node_names_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_names_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">c_str</span><span class="p">();</span>
<span class="w">        </span><span class="c1">//å°† std::string è½¬æ¢ä¸º C é£æ ¼æŒ‡é’ˆï¼Œä¾› input_node_names_ ä½¿ç”¨</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>ä¸Šé¢å‡½æ•°ç¤ºä¾‹äº†å¦‚ä½•è·å–è¾“å…¥èŠ‚ç‚¹nameï¼Œé¦–å…ˆé€šè¿‡session_.GetInputCount()è·å–åˆ°è¾“å…¥çš„èŠ‚ç‚¹ï¼Œç„¶åä½¿ç”¨forå¾ªç¯è¿›è¡Œéå†æ¯ä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡session_.GetInputNameAllocated(i, allocator)è·å–æ¯ä¸ªèŠ‚ç‚¹çš„åç§°ï¼Œè¿”å›ä¸€ä¸ªOrt::AllocatedStringPtræ™ºèƒ½æŒ‡é’ˆï¼Œéœ€è¦é€šè¿‡.getæ–¹æ³•è¿”å›cå­—ç¬¦ä¸²ï¼Œç”±äºæ™ºèƒ½æŒ‡é’ˆæŒ‡å‘çš„å­˜å‚¨ç©ºé—´é€€å‡ºforåä¼šé”€æ¯ï¼Œæ‰€ä»¥ä¸Šè¿°ä»£ç å°†å…¶å¤åˆ¶åˆ°input_names_ä¸­ã€‚</p>
<h3 id="_6">è¾“å…¥å¼ é‡ç»´åº¦</h3>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">Ort</span><span class="o">::</span><span class="n">TypeInfo</span><span class="w"> </span><span class="n">input_type_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session_</span><span class="p">.</span><span class="n">GetInputTypeInfo</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//è·å–æ¨¡å‹ç¬¬0ä¸ªè¾“å…¥èŠ‚ç‚¹çš„ç±»å‹ä¿¡æ¯å¯¹è±¡ï¼Œè¿”å›Ort::TypeInfoç±»å‹</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">input_tensor_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_type_info</span><span class="p">.</span><span class="n">GetTensorTypeAndShapeInfo</span><span class="p">();</span>
<span class="w">    </span><span class="c1">//ä»ç±»å‹ä¿¡æ¯ä¸­æå–å¼ é‡ç›¸å…³çš„å½¢çŠ¶å’Œæ•°æ®ç±»å‹ä¿¡æ¯ï¼Œè¿”å›Ort::TensorTypeAndShapeInfoå¯¹è±¡</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input_dims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_tensor_info</span><span class="p">.</span><span class="n">GetShape</span><span class="p">();</span>
<span class="w">    </span><span class="c1">//è·å–è¾“å…¥å¼ é‡çš„ç»´åº¦ä¿¡æ¯ï¼Œè¿”å›std::vector&lt;int64_t&gt;å®¹å™¨ï¼Œå­˜å‚¨å„ç»´åº¦å¤§å°</span>
<span class="w">    </span><span class="c1">//å…¸å‹YOLOæ¨¡å‹çš„è¾“å…¥ç»´åº¦ä¸º[batch, channel, height, width]</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">inputWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">inputHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</code></pre></div>
<p>ä¸Šé¢å‡½æ•°ç¤ºä¾‹è·å–è¾“å…¥å¼ é‡å½¢çŠ¶ï¼Œæœ€ç»ˆé€šè¿‡å¼ é‡çš„å½¢çŠ¶è·å–åˆ°äº†è¾“å…¥å›¾åƒçš„å®½å’Œé«˜ã€‚å®é™…ä¸Šå¯ä»¥ç®€åŒ–ä¸€ä¸‹ï¼ŒæŒ‰ç…§ä¸‹é¢çš„æ–¹å¼ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">auto</span><span class="w"> </span><span class="n">inputShapeInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session_</span><span class="p">.</span><span class="n">GetInputTypeInfo</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">GetTensorTypeAndShapeInfo</span><span class="p">().</span><span class="n">GetShape</span><span class="p">();</span>
<span class="kt">int</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputShapeInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">inputWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputShapeInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">inputHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputShapeInfo</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</code></pre></div>
<h3 id="_7">è¾“å‡ºåç§°</h3>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">output_node_names_</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//å­˜å‚¨Cé£æ ¼å­—ç¬¦ä¸²æŒ‡é’ˆçš„vectorï¼Œç”¨äºå…¼å®¹éœ€è¦const char*çš„ONNX Runtime APIè°ƒç”¨</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">output_names_</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//å­˜å‚¨æ ‡å‡†å­—ç¬¦ä¸²å¯¹è±¡çš„vectorï¼Œç”¨äºé•¿æœŸç»´æŠ¤å­—ç¬¦ä¸²å†…å­˜</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">num_outputs_</span><span class="p">;</span>
<span class="w">    </span><span class="n">num_outputs_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session_</span><span class="p">.</span><span class="n">GetOutputCount</span><span class="p">();</span>
<span class="w">    </span><span class="c1">//è·å–æ¨¡å‹è¾“å‡ºèŠ‚ç‚¹æ•°é‡</span>
<span class="w">    </span><span class="n">output_node_names_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">num_outputs_</span><span class="p">);</span>
<span class="w">    </span><span class="n">output_names_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">num_outputs_</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//é¢„åˆ†é…ä¸¤ä¸ªvectorçš„ç©ºé—´</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_outputs_</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">output_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session_</span><span class="p">.</span><span class="n">GetOutputNameAllocated</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">allocator</span><span class="p">);</span>
<span class="w">        </span><span class="n">output_names_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">output_name</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="w">        </span><span class="c1">//å°†åç§°å­˜å…¥std::stringä¿è¯ç”Ÿå‘½å‘¨æœŸ</span>
<span class="w">        </span><span class="n">output_node_names_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output_names_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">c_str</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//å¾ªç¯è·å–æ¯ä¸ªè¾“å‡ºèŠ‚ç‚¹åç§°</span>
</code></pre></div>
<p>ä¸Šé¢ç¤ºä¾‹äº†è·å–è¾“å‡ºåç§°ï¼Œä¸è¾“å…¥æ–¹æ³•ç±»ä¼¼ã€‚</p>
<h2 id="_8">è¾“å…¥é¢„å¤„ç†</h2>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">imread</span><span class="p">(</span><span class="n">imagePath</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Error: Could not read image."</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">originalImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="w"> </span><span class="n">image_shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">originalImage</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// å›¾åƒé¢„å¤„ç†</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">inputTensor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">preprocess</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">inputWidth</span><span class="p">,</span><span class="w"> </span><span class="n">inputHeight</span><span class="p">);</span>
</code></pre></div>
<p>ä½¿ç”¨opencvè¯»å–å›¾åƒï¼Œè°ƒç”¨preprocessè¿›è¡Œé¢„å¤„ç†ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">preprocess</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">inputWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">320</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">inputHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">320</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">resizedImage</span><span class="p">;</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">resizedImage</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">(</span><span class="n">inputWidth</span><span class="p">,</span><span class="w"> </span><span class="n">inputHeight</span><span class="p">));</span>
<span class="w">    </span><span class="c1">//å›¾åƒç¼©æ”¾ï¼šä½¿ç”¨OpenCVçš„resizeå‡½æ•°å°†å›¾åƒè°ƒæ•´ä¸ºæŒ‡å®šå°ºå¯¸ï¼ˆé»˜è®¤320x320ï¼‰</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">resizedImage</span><span class="p">,</span><span class="w"> </span><span class="n">resizedImage</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">COLOR_BGR2RGB</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//é¢œè‰²ç©ºé—´è½¬æ¢ï¼šä»BGRè½¬æ¢ä¸ºRGBæ ¼å¼ï¼ˆå¤šæ•°æ·±åº¦å­¦ä¹ æ¨¡å‹ä½¿ç”¨RGBè¾“å…¥ï¼‰</span>
<span class="w">    </span><span class="n">resizedImage</span><span class="p">.</span><span class="n">convertTo</span><span class="p">(</span><span class="n">resizedImage</span><span class="p">,</span><span class="w"> </span><span class="n">CV_32F</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255.0</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//æ•°å€¼å½’ä¸€åŒ–ï¼šé€šè¿‡convertToå°†åƒç´ å€¼ä»[0,255]å½’ä¸€åŒ–åˆ°[0,1]èŒƒå›´</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">inputTensor</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">inputHeight</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">inputWidth</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputTensor</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">resizedImage</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Vec3f</span><span class="o">&gt;</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">)[</span><span class="n">c</span><span class="p">]);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//é€šè¿‡ä¸‰é‡å¾ªç¯å°†OpenCVçš„HWCæ ¼å¼ï¼ˆHeight-Width-Channelï¼‰è½¬æ¢ä¸ºCHWæ ¼å¼</span>
<span class="w">    </span><span class="c1">//å†…å­˜å¸ƒå±€å˜ä¸ºè¿ç»­é€šé“æ•°æ®ï¼šRRR...GGG...BBB,æœ€ç»ˆè¾“å‡ºstd::vector&lt;float&gt;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">inputTensor</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>ä¸Šé¢çš„ä»£ç å®ç°äº†æ¨¡å‹å¯¹è¾“å…¥æ•°æ®çš„éƒ¨åˆ†é¢„å¤„ç†ï¼ŒåŒ…æ‹¬è¾“å…¥å›¾ç‰‡ç¼©æ”¾å›ºå®šå°ºå¯¸ï¼Œæ•°å€¼å½’ä¸€åŒ–ï¼Œä»¥åŠå°†æ ¼å¼è½¬æ¢ä¸ºCHWå¼ é‡æ ¼å¼ï¼Œä½†æ˜¯å¯¹äºè¾“å…¥æ¨¡å‹ï¼Œéœ€è¦çš„æ•°æ®æ ¼å¼ä¸ºOrt::Valueç±»å‹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input_shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">inputHeight</span><span class="p">,</span><span class="w"> </span><span class="n">inputWidth</span><span class="p">};</span>
<span class="c1">//input_shapeé‡‡ç”¨NCHWæ ¼å¼ï¼ˆæ‰¹æ¬¡æ•°-é€šé“-é«˜åº¦-å®½åº¦ï¼‰ï¼Œè¿™æ˜¯æ·±åº¦å­¦ä¹ æ¨¡å‹çš„é€šç”¨è¾“å…¥å¸ƒå±€</span>
<span class="k">auto</span><span class="w"> </span><span class="n">memory_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ort</span><span class="o">::</span><span class="n">MemoryInfo</span><span class="o">::</span><span class="n">CreateCpu</span><span class="p">(</span><span class="n">OrtArenaAllocator</span><span class="p">,</span><span class="w"> </span><span class="n">OrtMemTypeDefault</span><span class="p">);</span>
<span class="c1">//æè¿°ç”¨äºæè¿°å†…å­˜åˆ†é…çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å†…å­˜çš„ä½ç½®(CPU æˆ– GPU)ä»¥åŠå†…å­˜çš„å…·ä½“ç±»å‹(å›ºå®šå†…å­˜æˆ–å¸¸è§„å†…å­˜)</span>

<span class="n">Ort</span><span class="o">::</span><span class="n">Value</span><span class="w"> </span><span class="n">input_tensor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ort</span><span class="o">::</span><span class="n">Value</span><span class="o">::</span><span class="n">CreateTensor</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">memory_info</span><span class="p">,</span>
<span class="w">        </span><span class="n">inputTensor</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">inputTensor</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span>
<span class="w">        </span><span class="n">input_shape</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">input_shape</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</code></pre></div>
<p>å…³äºCreateTensorå¯¹è±¡è§£æå¦‚ä¸‹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">Ort</span><span class="o">::</span><span class="n">Value</span><span class="w"> </span><span class="n">CreateTensor</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">MemoryInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">memory_info</span><span class="p">,</span><span class="w">  </span><span class="c1">// å†…å­˜ç®¡ç†ç­–ç•¥</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">p_data</span><span class="p">,</span><span class="w">                  </span><span class="c1">// è¾“å…¥æ•°æ®æŒ‡é’ˆ</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">p_data_length</span><span class="p">,</span><span class="w">           </span><span class="c1">// è¾“å…¥çš„å¤§å°</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int64_t</span><span class="o">*</span><span class="w"> </span><span class="n">shape</span><span class="p">,</span><span class="w">           </span><span class="c1">// ç»´åº¦æ•°ç»„æŒ‡é’ˆ</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">shape_length</span><span class="w">             </span><span class="c1">// ç»´åº¦æ•°é‡</span>
<span class="p">);</span>
</code></pre></div>
<ul>
<li>memory_infoï¼šæŒ‡å®šå¼ é‡å†…å­˜åˆ†é…ç­–ç•¥ï¼Œé€šå¸¸ç”±Ort::MemoryInfo::CreateCpuåˆ›å»ºã€‚</li>
<li>inputTensor.data()ï¼šè¾“å…¥æ•°æ®çš„åœ°å€ï¼ˆéœ€ç¡®ä¿å†…å­˜è¿ç»­ï¼‰ã€‚</li>
<li>inputTensor.size()ï¼šè¾“å…¥æ•°æ®çš„å¤§å°ã€‚</li>
<li>input_shape.data()ï¼šè¾“å…¥å¼ é‡çš„å½¢çŠ¶æ•°ç»„ä¿¡æ¯ï¼ˆå¦‚NCHWæ ¼å¼çš„{1,3,640,640}ï¼‰ã€‚</li>
<li>shape_length: è¾“å…¥å¼ é‡çš„å½¢çŠ¶ä¿¡æ¯ç»´åº¦æ•°</li>
</ul>
<h2 id="_9">æ¨¡å‹æ¨ç†</h2>
<div class="codehilite"><pre><span></span><code><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Ort</span><span class="o">::</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">outputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session_</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span>
<span class="w">    </span><span class="n">Ort</span><span class="o">::</span><span class="n">RunOptions</span><span class="p">{</span><span class="k">nullptr</span><span class="p">},</span>
<span class="w">    </span><span class="n">input_node_names_</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">input_tensor</span><span class="p">,</span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">output_node_names_</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span>
<span class="w">    </span><span class="n">output_node_names_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</code></pre></div>
<p>ä¸‹é¢æ˜¯å‡½æ•°çš„å‚æ•°</p>
<div class="codehilite"><pre><span></span><code><span class="n">OrtStatus</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">OrtApi</span><span class="o">::</span><span class="n">Run</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">OrtRunOptions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">run_options</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">input_names</span><span class="p">,</span><span class="w">  </span><span class="c1">//è¾“å…¥èŠ‚ç‚¹åç§°çš„æ•°ç»„</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">OrtValue</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">inputs</span><span class="p">,</span><span class="w">   </span><span class="c1">//æ¨¡å‹è¾“å…¥çš„æ•°æ®Ort::Valueç±»å‹</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w">  </span><span class="n">input_len</span><span class="p">,</span><span class="w">  </span><span class="c1">//è¾“å…¥å¼ é‡æ•°é‡ï¼Œéœ€ä¸input_namesæ•°ç»„é•¿åº¦ä¸€è‡´</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">output_names</span><span class="p">,</span><span class="c1">//è¾“å‡ºèŠ‚ç‚¹åç§°æ•°ç»„</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w">  </span><span class="n">output_names_len</span><span class="p">,</span><span class="c1">//è¾“å‡ºèŠ‚ç‚¹åç§°çš„æ•°é‡ï¼Œä¸output_namesæ•°ç»„æ•°é‡ä¿æŒä¸€è‡´ã€‚</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="_10">è¾“å‡ºåå¤„ç†</h2>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="c1">//å¼ é‡ä¿¡æ¯æå–ï¼Œoutputs[0]æŒ‡å‘åæ ‡ã€åˆ†æ•°å¼ é‡æŒ‡é’ˆï¼Œoutputs[1]æŒ‡å‘ç±»åˆ«å¼ é‡çš„æŒ‡é’ˆ</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">dets_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">GetTensorMutableData</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="c1">//åæ ‡ï¼ˆæ ¼å¼ä¸º[x1,y1,x2,y2,score]ï¼‰</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">labels_pred_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">GetTensorMutableData</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="c1">//ç±»åˆ«</span>

<span class="w">    </span><span class="c1">//å¼ é‡ç»´åº¦çš„è§£æï¼Œç”¨äºè·å–æ£€æµ‹æ¡†çš„æ•°é‡</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">dets_tensor_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">GetTensorTypeAndShapeInfo</span><span class="p">();</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dets_dims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dets_tensor_info</span><span class="p">.</span><span class="n">GetShape</span><span class="p">();</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">num_detections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dets_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="c1">//ç»“æ„åŒ–é‡ç»„ï¼Œè§£æè¾“å‡ºçš„å¼ é‡å°†å…¶å­˜å‚¨detsã€scoresã€lables_pred</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">dets</span><span class="p">(</span><span class="n">num_detections</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">scores</span><span class="p">(</span><span class="n">num_detections</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">labels_pred</span><span class="p">(</span><span class="n">num_detections</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//éå†è§£æå­˜å‚¨åæ ‡detsã€åˆ†æ•°scoresã€æ ‡ç­¾ç±»åˆ«lables_pred</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_detections</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dets_data</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dets_data</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">];</span>
<span class="w">        </span><span class="n">labels_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">labels_pred_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//å°†åæ ‡ä¿¡æ¯è¿›è¡Œç¼©æ”¾ä»¥é€‚åº”æ­£å¸¸çš„å›¾ç‰‡å¤§å°ã€‚</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">scale_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">image_shape</span><span class="p">.</span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">inputWidth</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">scale_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">image_shape</span><span class="p">.</span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">inputHeight</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">det</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">dets</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">det</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">scale_x</span><span class="p">;</span>
<span class="w">        </span><span class="n">det</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">scale_y</span><span class="p">;</span>
<span class="w">        </span><span class="n">det</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">scale_x</span><span class="p">;</span>
<span class="w">        </span><span class="n">det</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">scale_y</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>ä¸Šé¢çš„ä»£ç ä»è¾“å‡ºå¼ é‡ä¿¡æ¯ä¸­è¿›è¡Œè§£æï¼Œå°†åæ ‡ã€åˆ†æ•°ã€æ ‡ç­¾ç±»åˆ«ä¾æ¬¡å­˜å‚¨åˆ°detsã€scoresã€lables_predä¸­ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">visualizeResults</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&gt;&amp;</span><span class="w"> </span><span class="n">dets</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">scores</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">labels_pred</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">conf_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dets</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">det</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">conf_threshold</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">class_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labels_pred</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">y2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labels</span><span class="p">[</span><span class="n">class_id</span><span class="p">];</span>
<span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">rectangle</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">y1</span><span class="p">),</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">y2</span><span class="p">),</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">putText</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">": "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">score</span><span class="p">),</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span><span class="w"> </span><span class="mf">0.9</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>æœ€ç»ˆå°†è·å–åˆ°çš„å°†åæ ‡ã€åˆ†æ•°ã€æ ‡ç­¾ç±»åˆ«ä¼ å…¥åˆ°visualizeResultsè¿›è¡Œç»˜åˆ¶ã€‚</p>
<p>å‘ç°ä¸€ä¸ªå¼€æºçš„ai toolkitï¼Œç›¸å¯¹æ¯”è¾ƒå…¨ã€‚<a href="https://github.com/xlite-dev/lite.ai.toolkit/tree/main">https://github.com/xlite-dev/lite.ai.toolkit/tree/main</a></p></div>
  <div class="post-nav">
    <a class="prev" href="pip-install.html">â† pip install</a>
    <a class="next" href="onnx-runtime-pythonç«¯ä¾§æ¨¡å‹éƒ¨ç½²yolov5.html">ONNX Runtime Pythonç«¯ä¾§æ¨¡å‹éƒ¨ç½²YOLOv5 â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

