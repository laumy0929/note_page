<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Linux系统RISC-V架构启动流程分析之概述 - Laumy的技术栈</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="">首页</a></div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>Linux系统RISC-V架构启动流程分析之概述</h1>
  <div class="meta">2024-07-07 · risc-v</div>
  <div class="post-content"><p><a href="https://www.laumy.tech/wp-content/uploads/2024/07/wp_editor_md_916371e84407b542dab3272d403af53f.jpg"><img alt="" src="assets/doc/02-risc-v/一、linux系统risc-v架构启动流程分析之概述/images/wp_editor_md_916371e84407b542dab3272d403af53f.jpg"/></a> 典型的linux系统启动流程如上，但本文主要探讨的是OS的启动流程，opensbi，uboot暂不涉及。主要围绕arch/riscv/kernel/head.S进行分析。</p>
<div class="codehilite"><pre><span></span><code><span class="n">_start</span>
<span class="w">  </span><span class="n">j</span><span class="w"> </span><span class="n">_start_kernel</span>

<span class="n">_start_kernel</span>
<span class="w">  </span><span class="n">arch</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="c1">//关中断，关浮点检测，挑选一个主hart启动初始化序列</span>
<span class="w">  </span><span class="n">clear</span><span class="w"> </span><span class="n">bss</span><span class="c1">//清除BSS</span>
<span class="w">  </span><span class="n">setup_vm</span><span class="c1">//为打开MMU做准备，fixmap映射，内核粗粒度映射，fdt映射</span>
<span class="n">fixmap</span><span class="w"> </span><span class="n">mapping</span>
<span class="n">trampoline</span><span class="w"> </span><span class="n">mapping</span>
<span class="n">early</span><span class="w"> </span><span class="n">Kernel</span><span class="w"> </span><span class="n">mapping</span>
<span class="n">映射的页表</span><span class="err">：</span><span class="n">粗粒度映射</span><span class="err">，</span><span class="n">只使用到PMD</span><span class="err">，</span><span class="n">不会用到PTE</span>
<span class="w">            </span><span class="n">early_pg_dir</span><span class="p">[</span><span class="n">PTRS_PER_PGD</span><span class="p">]</span>
<span class="n">trampoline_pmd</span><span class="p">[</span><span class="n">PTRS_PER_PMD</span><span class="p">]</span>
<span class="n">early_pmd</span><span class="p">[</span><span class="n">PTRS_PER_PMD</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">NUM_EARLY_PMDS</span><span class="p">]</span>

<span class="n">fixed</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">fdt</span>
<span class="n">虚拟地址是FIX_FDT</span><span class="p">,</span><span class="w"> </span><span class="n">将DBT的物理地址到填充fixmap_pte</span><span class="p">[</span><span class="n">PTRS_PER_PTE</span><span class="p">]</span>

<span class="w">  </span><span class="n">Relocate</span>
<span class="w">     </span><span class="n">使能MMU</span><span class="err">，</span><span class="n">切换到虚拟地址运行</span>

<span class="w">  </span><span class="n">parse_dtb</span><span class="w"> </span><span class="c1">//解析设备树</span>
<span class="w">     </span><span class="n">early_init_dt_scan</span>
<span class="w">  </span><span class="n">start_kernel</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">start_kernel</span>
<span class="w">   </span><span class="n">setup_arch</span>
<span class="w">      </span><span class="n">setup_bootmem</span>
<span class="w">     </span><span class="n">paging_init</span><span class="p">()</span>
<span class="w">   </span><span class="n">trap_init</span><span class="w"> </span><span class="c1">//异常初始化</span>
<span class="w">   </span><span class="n">mm_init</span><span class="w"> </span><span class="c1">//kernel 内存初始化</span>
<span class="w">   </span><span class="n">sched_init</span><span class="w"> </span><span class="c1">//调度初始化</span>
<span class="w">   </span><span class="n">early_irq_init</span><span class="w"> </span><span class="c1">//irq初始化</span>
<span class="w">   </span><span class="n">init_IQR</span>
<span class="w">   </span><span class="n">tick_init</span>
<span class="w">   </span><span class="n">init_times</span><span class="w"> </span><span class="c1">//timer初始化</span>
<span class="w">   </span><span class="n">hrtimer_init</span>
<span class="w">   </span><span class="n">softirq_init</span>
<span class="w">   </span><span class="n">time_init</span>
<span class="w">   </span><span class="n">arch_call_rest_init</span>
<span class="w">     </span><span class="n">rest_init</span>
<span class="w">       </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="n">kernel_init</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">CLONE_FS</span><span class="p">);</span><span class="w"> </span>
<span class="w">         </span><span class="n">kernel_init</span>
<span class="w">           </span><span class="nf">kernel_init_freeable</span><span class="p">();</span><span class="w"> </span>
<span class="w">             </span><span class="n">prepare_namespace</span>
<span class="w">               </span><span class="n">mount_root</span><span class="p">()</span><span class="w"> </span><span class="c1">//挂载根文件系统</span>
<span class="w">         </span><span class="n">run_init_process</span><span class="p">(</span><span class="n">execute_command</span><span class="p">)</span><span class="w"> </span><span class="c1">//启动第一个应用进程</span>
</code></pre></div>
<p>系统初始化的时候，有一个关键环节是使能MMU，而使能MMU就需要使用虚拟地址，那么就会遇到以下问题，如何解决了？ 1.内存管理没准备好。 2.需要分配页表。 3.开了MMU后，分配的页表能够用虚拟地址访问，否则访问不了页表无法填充。 4.开了MMU后，要能够用虚拟地址访问内核代码，无法无法运行。 5.开了MMU后，能够用虚拟地址访问设备树，无法读取内核内存的相关信息。</p></div>
  <div class="post-nav">
    <a class="prev" href="虚拟地址与物理地址概念.html">← 虚拟地址与物理地址概念</a>
    <a class="next" href="启动第一个应用进程.html">启动第一个应用进程 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

