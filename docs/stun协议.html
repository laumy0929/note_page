<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>STUN协议 - Laumy的技术栈</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="">首页</a></div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#nat">NAT墙</a><ul><li><a href="#_1">完全锥形</a></li><li><a href="#ip">IP限制型锥形</a></li><li><a href="#_2">端口限制型锥形</a></li><li><a href="#_3">对称型</a></li></ul></li><li><a href="#nat_1">NAT穿透</a><ul></ul></li><li><a href="#stun">STUN协议简介</a><ul><li><a href="#_4">绑定请求与响应</a></li><li><a href="#_5">连接检查</a></li><li><a href="#_6">实践流程分析</a></li><li><a href="#a_1">板子A请求检查</a></li></ul></li><li><a href="#turn">TURN协议</a><ul><li><a href="#allocate">Allocate</a></li><li><a href="#send">Send机制</a></li><li><a href="#chanel">Chanel机制</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>STUN协议</h1>
  <div class="meta">2024-11-26 · 网络</div>
  <div class="post-content"><h2 id="nat">NAT墙</h2>
<h3 id="_1">完全锥形</h3>
<h3 id="ip">IP限制型锥形</h3>
<h3 id="_2">端口限制型锥形</h3>
<h3 id="_3">对称型</h3>
<h2 id="nat_1">NAT穿透</h2>
<h2 id="stun">STUN协议简介</h2>
<p>STUN（Session Traversal Utilities for NAT）是一个用于帮助客户端发现其所在NAT之后的公网IP地址和端口号。通信的双方都能知道所在的公网IP，并且能够让公网的NAT帮助转发，从而实现NAT穿透。STUN协议广泛应用在WebRTC实时通信系统中。STUN交互过程主要有以下几个步骤：</p>
<ul>
<li>客户端向 STUN 服务器发送请求。</li>
<li>STUN 服务器处理并响应。</li>
<li>客户端接收响应并解析公共IP和端口。</li>
<li>客户端根据收到的公共 IP 和端口进行 NAT 穿越和路径选择。</li>
</ul>
<h3 id="_4">绑定请求与响应</h3>
<h4 id="stun_1">客户端发STUN请求</h4>
<p>客户端发送STUN请求，包的类型为Binding Request。请求的目标是让STUN 服务器返回客户端的公网IP地址和端口。</p>
<div class="codehilite"><pre><span></span><code><span class="n">STUN</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Header</span><span class="o">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Type</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0001</span><span class="w"> </span><span class="p">(</span><span class="n">Binding</span><span class="w"> </span><span class="n">Request</span><span class="p">)</span><span class="w"> </span><span class="c1">//类型</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Length</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0000</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Magic</span><span class="w"> </span><span class="n">Cookie</span><span class="o">:</span><span class="w"> </span><span class="mh">0x2112A442</span><span class="w">               </span><span class="c1">//固定值，用于标识STUN</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Transaction</span><span class="w"> </span><span class="n">ID</span><span class="o">:</span><span class="w"> </span><span class="mh">0x63f96d584f90a66d18b68202</span><span class="w"> </span><span class="c1">//用于唯一标识该请求的ID，匹配响应</span>

<span class="n">STUN</span><span class="w"> </span><span class="n">Attributes</span><span class="w"> </span><span class="p">(</span><span class="n">Optional</span><span class="p">)</span><span class="o">:</span><span class="w">  </span><span class="c1">//以下是附加信息</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Username</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Integrity</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">HMAC</span><span class="o">-</span><span class="n">SHA1</span><span class="w"> </span><span class="n">signature</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Fingerprint</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">CRC</span><span class="mi">-32</span><span class="n">C</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">message</span><span class="o">&gt;</span>
</code></pre></div>
<h4 id="stun_2">STUN服务端响应</h4>
<p>STUN服务器收到客户端的请求后，会放binding response回复，内容中携带了客户端的公网IP和端口号。</p>
<div class="codehilite"><pre><span></span><code><span class="n">STUN</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Header</span><span class="o">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Type</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0101</span><span class="w"> </span><span class="p">(</span><span class="n">Binding</span><span class="w"> </span><span class="n">Response</span><span class="p">)</span><span class="w">  </span><span class="c1">//表明是一个 Binding Response</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Length</span><span class="o">:</span><span class="w"> </span><span class="mh">0x000C</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Magic</span><span class="w"> </span><span class="n">Cookie</span><span class="o">:</span><span class="w"> </span><span class="mh">0x2112A442</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Transaction</span><span class="w"> </span><span class="n">ID</span><span class="o">:</span><span class="w"> </span><span class="mh">0x63f96d584f90a66d18b68202</span>

<span class="n">STUN</span><span class="w"> </span><span class="n">Attributes</span><span class="o">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Mapped</span><span class="w"> </span><span class="n">Address</span><span class="o">:</span><span class="w"> </span>
<span class="w">      </span><span class="nl">Family</span><span class="p">:</span><span class="w"> </span><span class="n">IPv4</span>
<span class="w">      </span><span class="nl">Address</span><span class="p">:</span><span class="w"> </span><span class="mf">203.0.113.1</span><span class="w">     </span><span class="c1">//公网的IP</span>
<span class="w">      </span><span class="nl">Port</span><span class="p">:</span><span class="w"> </span><span class="mi">3478</span><span class="w">               </span><span class="c1">//公网的端口</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Username</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Integrity</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">HMAC</span><span class="o">-</span><span class="n">SHA1</span><span class="w"> </span><span class="n">signature</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Fingerprint</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">CRC</span><span class="mi">-32</span><span class="n">C</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">message</span><span class="o">&gt;</span>
</code></pre></div>
<h3 id="_5">连接检查</h3>
<p>以webrtc举例，当需要通信的双方，通过信令交互SDP（在libpeer文章中，是通过mqtt）中交互的双方各自的公网IP地址信息后，可以使用STUN的binding request和binding response检查P2P的连通性，以确保P2P链路可达。</p>
<p>首先一般由一端率先发起binding request。</p>
<div class="codehilite"><pre><span></span><code><span class="n">STUN</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Header</span><span class="o">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Type</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0001</span><span class="w"> </span><span class="p">(</span><span class="n">Binding</span><span class="w"> </span><span class="n">Request</span><span class="p">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Length</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0008</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Magic</span><span class="w"> </span><span class="n">Cookie</span><span class="o">:</span><span class="w"> </span><span class="mh">0x2112A442</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Transaction</span><span class="w"> </span><span class="n">ID</span><span class="o">:</span><span class="w"> </span><span class="mh">0x63f96d584f90a32d18b68202</span>

<span class="n">STUN</span><span class="w"> </span><span class="n">Attributes</span><span class="o">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Username</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">peer</span><span class="o">-</span><span class="n">username</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Integrity</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">HMAC</span><span class="o">-</span><span class="n">SHA1</span><span class="w"> </span><span class="n">signature</span><span class="o">&gt;</span>
</code></pre></div>
<p>接着等待对端回复binding response</p>
<div class="codehilite"><pre><span></span><code><span class="n">STUN</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Header</span><span class="o">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Type</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0101</span><span class="w"> </span><span class="p">(</span><span class="n">Binding</span><span class="w"> </span><span class="n">Response</span><span class="p">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Length</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0008</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Magic</span><span class="w"> </span><span class="n">Cookie</span><span class="o">:</span><span class="w"> </span><span class="mh">0x2112A442</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Transaction</span><span class="w"> </span><span class="n">ID</span><span class="o">:</span><span class="w"> </span><span class="mh">0x63f96d584f90a32d18b68202</span>

<span class="n">STUN</span><span class="w"> </span><span class="n">Attributes</span><span class="o">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Mapped</span><span class="w"> </span><span class="n">Address</span><span class="o">:</span><span class="w"> </span>
<span class="w">      </span><span class="nl">Family</span><span class="p">:</span><span class="w"> </span><span class="n">IPv4</span>
<span class="w">      </span><span class="nl">Address</span><span class="p">:</span><span class="w"> </span><span class="mf">203.0.113.10</span>
<span class="w">      </span><span class="nl">Port</span><span class="p">:</span><span class="w"> </span><span class="mi">3479</span>
</code></pre></div>
<p>当发起方接受到binding response后，表明连通性正常，下面是代码的流程示例。</p>
<div class="codehilite"><pre><span></span><code><span class="n">agent_connectivity_check</span><span class="err">（）</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/*1. 发送 binding request*/</span>
<span class="w">    </span><span class="n">agent_create_binding_request</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span>
<span class="w">        </span><span class="n">stun_msg_create</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">STUN_CLASS_REQUEST</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">STUN_METHOD_BINDING</span><span class="p">);</span>
<span class="w">        </span><span class="n">stun_msg_write_attr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">STUN_ATTR_TYPE_USERNAME</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">username</span><span class="p">),</span><span class="w"> </span><span class="n">username</span><span class="p">);</span>
<span class="w">        </span><span class="n">stun_msg_write_attr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">STUN_ATTR_TYPE_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">nominated_pair</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
<span class="w">        </span><span class="n">stun_msg_finish</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">STUN_CREDENTIAL_SHORT_TERM</span><span class="p">,</span><span class="w"> </span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">remote_upwd</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">remote_upwd</span><span class="p">));</span>
<span class="w">    </span><span class="n">agent_socket_send</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">nominated_pair</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="n">size</span><span class="p">);</span><span class="c1">//发送，这里目标的ip和端口就是对端的ip地址和端口号。</span>

<span class="w">    </span><span class="cm">/*2. 等待接受*/</span>
<span class="w">    </span><span class="n">agent_recv</span>
<span class="w">        </span><span class="nf">switch</span><span class="w"> </span><span class="p">(</span><span class="n">stun_msg</span><span class="p">.</span><span class="n">stunclass</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/*收到对端发送的binding request，构建一个response发送回去。*/</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">STUN_CLASS_REQUEST</span><span class="p">:</span>
<span class="w">                </span><span class="n">agent_process_stun_request</span>
<span class="w">                    </span><span class="n">agent_create_binding_response</span>
<span class="w">                    </span><span class="n">stun_set_mapped_address</span>
<span class="w">                    </span><span class="n">agent_socket_send</span>
<span class="w">            </span><span class="cm">/*收到对端回复的binding response，将state设置为success*/</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">STUN_CLASS_RESPONSE</span><span class="err">：</span>
<span class="w">                </span><span class="no">agent_process_stun_response</span>
<span class="w">                    </span><span class="no">agent</span><span class="o">-&gt;</span><span class="no">nominated_pair</span><span class="o">-&gt;</span><span class="no">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ICE_CANDIDATE_STATE_SUCCEEDED</span><span class="err">;</span>
<span class="w">        </span><span class="err">}</span>
<span class="err">}</span>
</code></pre></div>
<h3 id="_6">实践流程分析</h3>
<p>本次实验使用的stun服务器是，有两个设备，设备A是一块开发板，设备B是电脑，分别连接到同一个路由器上。</p>
<div class="codehilite"><pre><span></span><code><span class="n">Resolved</span><span class="w"> </span><span class="n">stun</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mf">74.125.250.129</span><span class="err">，</span>
<span class="n">Resolved</span><span class="w"> </span><span class="n">stun</span><span class="o">/</span><span class="n">turn</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="mf">74.125.250.129</span><span class="o">:</span><span class="mi">19302</span>
</code></pre></div>
<p>设备A（开发板）的IP地址信息是</p>
<div class="codehilite"><pre><span></span><code><span class="n">inet</span><span class="w"> </span><span class="n">addr</span><span class="o">:</span><span class="mf">192.168.51.127</span>
</code></pre></div>
<p>设备B（电脑）的IP地址信息是</p>
<div class="codehilite"><pre><span></span><code><span class="mf">192.168.51.227</span>
</code></pre></div>
<h4 id="stun_3">设备发送向STUN服务端发送请求</h4>
<h5 id="binding-request">开发板发送binding request</h5>
<p>这里是设备向stun.l.google.com：74.125.250.129:19302服务发送binding request请求。</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/12/wp_editor_md_ab489a74a77e9b82ed1d9d7fa6aa9b2c.jpg"><img alt="" src="assets/doc/08-网络/stun协议/images/wp_editor_md_ab489a74a77e9b82ed1d9d7fa6aa9b2c.jpg"/></a></p>
<h5 id="binding-request_1">电脑发送binding request</h5>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/12/wp_editor_md_06efcf8e4abbfd6e9ee2e25e832782c9.jpg"><img alt="" src="assets/doc/08-网络/stun协议/images/wp_editor_md_06efcf8e4abbfd6e9ee2e25e832782c9.jpg"/></a></p>
<p>设备的电脑一下发了3个binding request，其中一个是发送给google stun服务器的，但是另外两个实际上是发给设备A的本地IP和NAT墙的IP，可能是此前连接过，浏览器缓存了信息。</p>
<h4 id="_7">服务端回复</h4>
<h5 id="a">设备A收到回复</h5>
<p>stun.l.google.com回复了binding success response。并表明了设备的公网IP为120.236.240.177，其端口为8139。</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/12/wp_editor_md_abac79e966c195b9025bfe2393e04773.jpg"><img alt="" src="assets/doc/08-网络/stun协议/images/wp_editor_md_abac79e966c195b9025bfe2393e04773.jpg"/></a></p>
<h5 id="b">电脑B收到回复</h5>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/12/wp_editor_md_f4a29ee31d223286727656e53d4580fe.jpg"><img alt="" src="assets/doc/08-网络/stun协议/images/wp_editor_md_f4a29ee31d223286727656e53d4580fe.jpg"/></a></p>
<p>通过message transaction ID可以看到电脑收到了Google STUN回复的binding success response，告知其NAT地址为120.236.240.177，端口号是8140。因为连接的是同一个路由器，所以NAT是一样的。同时板子A设备192.168.51.127也对齐回复了binding success response，告知其地址为192.168.51.227:59777。</p>
<h3 id="a_1">板子A请求检查</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/12/wp_editor_md_a46fc1700d926970a5daf3cd7024a542.jpg"><img alt="" src="assets/doc/08-网络/stun协议/images/wp_editor_md_a46fc1700d926970a5daf3cd7024a542.jpg"/></a></p>
<p>板子A发送了一个binding request，对端回复了一个binding success response，则表示联通已建立。</p>
<h2 id="turn">TURN协议</h2>
<p>TURN协议是在STUN的基础上增加了中继功能，解决的是对称型NAT无法穿透的问题。如下图的结构体，需要注意的是，使用TURN作为中继转发，传输的设备一方式TURN Client，另一方是Peer A。即TURN Client需要与TURN Server建立TURN协议交互，而Peer A与TURN Server只需要做STUN协议交互。此前调试了两个通信设备，两端都是使用TURN协议发起连接，导致一端checking失败，最后将一端修改为STUN协议交互即可。</p>
<div class="codehilite"><pre><span></span><code><span class="w">                                        </span><span class="n">Peer</span><span class="w"> </span><span class="n">A</span>
<span class="w">                                        </span><span class="n">Server</span><span class="o">-</span><span class="n">Reflexive</span><span class="w">    </span><span class="o">+---------+</span>
<span class="w">                                        </span><span class="n">Transport</span><span class="w"> </span><span class="n">Address</span><span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="o">|</span>
<span class="w">                                        </span><span class="mf">192.0.2.150</span><span class="o">:</span><span class="mi">32102</span><span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="o">|</span>
<span class="w">                                            </span><span class="o">|</span><span class="w">              </span><span class="o">/|</span><span class="w">         </span><span class="o">|</span>
<span class="w">                          </span><span class="n">TURN</span><span class="w">              </span><span class="o">|</span><span class="w">            </span><span class="o">/</span><span class="w"> </span><span class="o">^|</span><span class="w">  </span><span class="n">Peer</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">|</span>
<span class="w">    </span><span class="n">Client</span><span class="err">’</span><span class="n">s</span><span class="w">              </span><span class="n">Server</span><span class="w">            </span><span class="o">|</span><span class="w">           </span><span class="o">/</span><span class="w">  </span><span class="o">||</span><span class="w">         </span><span class="o">|</span>
<span class="w">    </span><span class="n">Host</span><span class="w"> </span><span class="n">Transport</span><span class="w">        </span><span class="n">Transport</span><span class="w">         </span><span class="o">|</span><span class="w">         </span><span class="c1">//   ||         |</span>
<span class="w">    </span><span class="n">Address</span><span class="w">               </span><span class="n">Address</span><span class="w">           </span><span class="o">|</span><span class="w">       </span><span class="c1">//     |+---------+</span>
<span class="w">   </span><span class="mf">10.1.1.2</span><span class="o">:</span><span class="mi">49721</span><span class="w">       </span><span class="mf">192.0.2.15</span><span class="o">:</span><span class="mi">3478</span><span class="w">     </span><span class="o">|+-+</span><span class="w">  </span><span class="c1">//     Peer A</span>
<span class="w">            </span><span class="o">|</span><span class="w">               </span><span class="o">|</span><span class="w">               </span><span class="o">||</span><span class="n">N</span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="w">       </span><span class="n">Host</span><span class="w"> </span><span class="n">Transport</span>
<span class="w">            </span><span class="o">|</span><span class="w">   </span><span class="o">+-+</span><span class="w">         </span><span class="o">|</span><span class="w">               </span><span class="o">||</span><span class="n">A</span><span class="o">|/</span><span class="w">        </span><span class="n">Address</span>
<span class="w">            </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">               </span><span class="n">v</span><span class="o">|</span><span class="n">T</span><span class="o">|</span><span class="w">     </span><span class="mf">192.168.100.2</span><span class="o">:</span><span class="mi">49582</span>
<span class="w">            </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">               </span><span class="o">/+-+</span>
<span class="w"> </span><span class="o">+---------+|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="o">|+---------+</span><span class="w">   </span><span class="o">/</span><span class="w">              </span><span class="o">+---------+</span>
<span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="o">||</span><span class="w">   </span><span class="o">|</span><span class="n">N</span><span class="o">|</span><span class="w">         </span><span class="o">||</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="c1">//               |         |</span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">TURN</span><span class="w">    </span><span class="o">|</span><span class="n">v</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="n">v</span><span class="o">|</span><span class="w"> </span><span class="n">TURN</span><span class="w">    </span><span class="o">|/</span><span class="w">                 </span><span class="o">|</span><span class="w">         </span><span class="o">|</span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Client</span><span class="w">  </span><span class="o">|----|</span><span class="n">A</span><span class="o">|----------|</span><span class="w"> </span><span class="n">Server</span><span class="w">  </span><span class="o">|------------------|</span><span class="w">  </span><span class="n">Peer</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">|</span>
<span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">|^</span><span class="w">         </span><span class="o">|</span><span class="w">         </span><span class="o">|^</span><span class="w">                </span><span class="o">^|</span><span class="w">         </span><span class="o">|</span>
<span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">    </span><span class="o">|</span><span class="n">T</span><span class="o">||</span><span class="w">         </span><span class="o">|</span><span class="w">         </span><span class="o">||</span><span class="w">                </span><span class="o">||</span><span class="w">         </span><span class="o">|</span>
<span class="w"> </span><span class="o">+---------+</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">||</span><span class="w">         </span><span class="o">+---------+|</span><span class="w">                </span><span class="o">|+---------+</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="o">||</span><span class="w">                    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="o">||</span><span class="w">                    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span>
<span class="w">                </span><span class="o">+-+|</span><span class="w">                    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w">                    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w">                    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span>
<span class="w">             </span><span class="n">Client</span><span class="err">’</span><span class="n">s</span><span class="w">                   </span><span class="o">|</span><span class="w">            </span><span class="n">Peer</span><span class="w"> </span><span class="n">B</span>
<span class="w">             </span><span class="n">Server</span><span class="o">-</span><span class="n">Reflexive</span><span class="w">    </span><span class="n">Relayed</span><span class="w">             </span><span class="n">Transport</span>
<span class="w">             </span><span class="n">Transport</span><span class="w"> </span><span class="n">Address</span><span class="w">   </span><span class="n">Transport</span><span class="w"> </span><span class="n">Address</span><span class="w">   </span><span class="n">Address</span>
<span class="w">             </span><span class="mf">192.0.2.1</span><span class="o">:</span><span class="mi">7000</span><span class="w">      </span><span class="mf">192.0.2.15</span><span class="o">:</span><span class="mi">50000</span><span class="w">     </span><span class="mf">192.0.2.210</span><span class="o">:</span><span class="mi">49191</span>
</code></pre></div>
<h3 id="allocate">Allocate</h3>
<p>请求服务器，分配一个中继服务。中继建立连接后，客户端需要进行保活，定期发送refresh request给服务器端。</p>
<div class="codehilite"><pre><span></span><code><span class="n">TURN</span><span class="w">                                 </span><span class="n">TURN</span><span class="w">           </span><span class="n">Peer</span><span class="w">          </span><span class="n">Peer</span>
<span class="n">client</span><span class="w">                               </span><span class="n">server</span><span class="w">          </span><span class="n">A</span><span class="w">             </span><span class="n">B</span>
<span class="w">  </span><span class="o">|--</span><span class="w"> </span><span class="n">Allocate</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">---------------&gt;|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|&lt;---------------</span><span class="w"> </span><span class="n">Allocate</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="o">--|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                 </span><span class="p">(</span><span class="mi">401</span><span class="w"> </span><span class="n">Unauthorized</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|--</span><span class="w"> </span><span class="n">Allocate</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">---------------&gt;|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|&lt;----------</span><span class="w"> </span><span class="n">Allocate</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">--|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">            </span><span class="p">(</span><span class="mf">192.0.2.15</span><span class="o">:</span><span class="mi">50000</span><span class="p">)</span><span class="w">      </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">/</span><span class="w">                                   </span><span class="o">/</span><span class="w">            </span><span class="o">/</span><span class="w">            </span><span class="o">/</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|--</span><span class="w"> </span><span class="n">Refresh</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">----------------&gt;|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|&lt;-----------</span><span class="w"> </span><span class="n">Refresh</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">--|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
</code></pre></div>
<p>如上示例，客户端先发送不带验证信息的Allocate请求，此时STUN服务器会返回error response，客户端收到错误后加上验证信息再次请求。以IPC通信为例，摄像头端是Peer A（资源有限，不支持证书请求等协议），发起的是STUN协议，而手机预览端是TURN Client，发起的是TURN交互协议。</p>
<h3 id="send">Send机制</h3>
<p>客户端和peer直接通信可以通过TURN server进行转发信息，主要有两种方式，第一种是使用Send/data方式，第二种是使用channels方式。其主要目的是通过某种方式告知服务器，从client接收到的数据应该发给那个peer。下面是Send/data机制。</p>
<p>TURN Server在进行转发前，需要client先安装一个到对等端的许可(permission),许可证可以通过CreatePermission request/resp来进行交互。</p>
<div class="codehilite"><pre><span></span><code><span class="n">TURN</span><span class="w">                                 </span><span class="n">TURN</span><span class="w">           </span><span class="n">Peer</span><span class="w">          </span><span class="n">Peer</span>
<span class="n">client</span><span class="w">                               </span><span class="n">server</span><span class="w">          </span><span class="n">A</span><span class="w">             </span><span class="n">B</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|--</span><span class="w"> </span><span class="n">CreatePermission</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="p">(</span><span class="n">Peer</span><span class="w"> </span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="o">--&gt;|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|&lt;--</span><span class="w"> </span><span class="n">CreatePermission</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">--|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|---</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">ind</span><span class="w"> </span><span class="p">(</span><span class="n">Peer</span><span class="w"> </span><span class="n">A</span><span class="p">)</span><span class="o">--------------&gt;|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|===</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">===&gt;|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|&lt;==</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">====|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|&lt;--------------</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="n">ind</span><span class="w"> </span><span class="p">(</span><span class="n">Peer</span><span class="w"> </span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="o">--|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|---</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">ind</span><span class="w"> </span><span class="p">(</span><span class="n">Peer</span><span class="w"> </span><span class="n">B</span><span class="p">)</span><span class="o">--------------&gt;|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w"> </span><span class="n">dropped</span><span class="w">     </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|&lt;==</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">==================|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                            </span><span class="n">dropped</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
</code></pre></div>
<h3 id="chanel">Chanel机制</h3>
<p>等同于send/data机制。</p>
<div class="codehilite"><pre><span></span><code><span class="n">TURN</span><span class="w">                                 </span><span class="n">TURN</span><span class="w">           </span><span class="n">Peer</span><span class="w">          </span><span class="n">Peer</span>
<span class="n">client</span><span class="w">                               </span><span class="n">server</span><span class="w">          </span><span class="n">A</span><span class="w">             </span><span class="n">B</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|--</span><span class="w"> </span><span class="n">ChannelBind</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="o">----------------&gt;|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">Peer</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mh">0x4001</span><span class="p">)</span><span class="w">                 </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|&lt;----------</span><span class="w"> </span><span class="n">ChannelBind</span><span class="w"> </span><span class="n">succ</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">--|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|--</span><span class="w"> </span><span class="p">[</span><span class="mh">0x4001</span><span class="p">]</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">------------------&gt;|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|===</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">===&gt;|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|&lt;==</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">====|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|&lt;------------------</span><span class="w"> </span><span class="p">[</span><span class="mh">0x4001</span><span class="p">]</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">--|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|---</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">ind</span><span class="w"> </span><span class="p">(</span><span class="n">Peer</span><span class="w"> </span><span class="n">A</span><span class="p">)</span><span class="o">--------------&gt;|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|===</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">===&gt;|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|&lt;==</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">====|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|&lt;------------------</span><span class="w"> </span><span class="p">[</span><span class="mh">0x4001</span><span class="p">]</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">--|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                    </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="o">|</span>
</code></pre></div>
<p>参考：</p>
<ol>
<li>
<p><a href="https://mp.weixin.qq.com/s/XMhSDABc74dpALIHrPPt7w">https://mp.weixin.qq.com/s/XMhSDABc74dpALIHrPPt7w</a></p>
</li>
<li>
<p><a href="https://www.ctyun.cn/developer/article/586260405821509">https://www.ctyun.cn/developer/article/586260405821509</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/pannengzhi/p/5048965.html">https://www.cnblogs.com/pannengzhi/p/5048965.html</a></p>
</li>
</ol></div>
  <div class="post-nav">
    <a class="prev" href="coturn安装.html">← coturn安装</a>
    <a class="next" href="libpeer分析.html">libpeer分析 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

