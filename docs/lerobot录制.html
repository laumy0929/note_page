<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>lerobotå½•åˆ¶ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">ç®€ä»‹</a><ul></ul></li><li><a href="#_2">å…³é”®é…ç½®ç±»</a><ul><li><a href="#recordconfig">RecordConfig</a></li><li><a href="#robotconfig">RobotConfig</a></li><li><a href="#datasetrecordconfig">DatasetRecordConfig</a></li><li><a href="#teleoperatorconfig">TeleoperatorConfig</a></li><li><a href="#pretrainedconfig">PreTrainedConfig</a></li></ul></li><li><a href="#_3">å‚æ•°è§£æ</a><ul></ul></li><li><a href="#_4">ç¡¬ä»¶åˆå§‹åŒ–ä¸è¿æ¥</a><ul></ul></li><li><a href="#_5">æ•°æ®é›†åˆ›å»º</a><ul><li><a href="#_6">æ•°æ®ç‰¹å¾å®šä¹‰</a></li><li><a href="#_9">åˆ›å»ºæ•°æ®é›†</a></li><li><a href="#_10">åŠ è½½æ•°æ®é›†</a></li></ul></li><li><a href="#_11">å½•åˆ¶æµç¨‹</a><ul></ul></li><li><a href="#_12">å½•åˆ¶å¾ªç¯</a><ul><li><a href="#_13">åˆå§‹åŒ–ä¸å‚æ•°æ ¡éªŒ</a></li><li><a href="#_14">ä¸»å¾ªç¯æ§åˆ¶ä¸æ•°æ®é‡‡é›†</a></li></ul></li><li><a href="#_15">æ•°æ®å­˜å‚¨</a><ul><li><a href="#_16">å†™å…¥ç¼“å­˜</a></li><li><a href="#_17">å†™å…¥ç£ç›˜</a></li></ul></li><li><a href="#_18">ç»“æŸé‡‡é›†</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>lerobotå½•åˆ¶</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2025-07-29
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      ai
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">ç®€ä»‹</h2>
<p>lerobot recordæ˜¯å…³é”®æ ¸å¿ƒæµç¨‹ï¼Œå…¶åŒ…æ‹¬äº†æ•°æ®çš„é‡‡é›†å’Œæ¨¡å‹æ¨ç†ä¸¤éƒ¨åˆ†ã€‚</p>
<p>å¦‚æœæ˜¯æ•°æ®é‡‡é›†æ¨¡å¼ï¼Œå‘½ä»¤å¯åŠ¨å¦‚ä¸‹</p>
<div class="codehilite"><pre><span></span><code><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">lerobot</span><span class="o">.</span><span class="n">record</span> \
    <span class="o">--</span><span class="n">robot</span><span class="o">.</span><span class="n">disable_torque_on_disconnect</span><span class="o">=</span><span class="n">true</span> \
    <span class="o">--</span><span class="n">robot</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="n">so101_follower</span> \
    <span class="o">--</span><span class="n">robot</span><span class="o">.</span><span class="n">port</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">ttyACM0</span> \
    <span class="o">--</span><span class="n">robot</span><span class="o">.</span><span class="n">id</span><span class="o">=</span><span class="n">R12252801</span> \
    <span class="o">--</span><span class="n">robot</span><span class="o">.</span><span class="n">cameras</span><span class="o">=</span><span class="s2">"{ handeye: {type: opencv, index_or_path: 6, width: 640, height: 480, fps: 30}, fixed: {type: opencv, index_or_path: 0, width: 640, height: 480, fps: 30}}"</span> \
    <span class="o">--</span><span class="n">teleop</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="n">so101_leader</span> \
    <span class="o">--</span><span class="n">teleop</span><span class="o">.</span><span class="n">port</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">ttyACM1</span> \
    <span class="o">--</span><span class="n">teleop</span><span class="o">.</span><span class="n">id</span><span class="o">=</span><span class="n">R07252608</span> \
    <span class="o">--</span><span class="n">dataset</span><span class="o">.</span><span class="n">repo_id</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">HF_USER</span><span class="p">}</span><span class="o">/</span><span class="n">record</span><span class="o">-</span><span class="mi">07271148</span>\
    <span class="o">--</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_episodes</span><span class="o">=</span><span class="mi">10</span> \
    <span class="o">--</span><span class="n">dataset</span><span class="o">.</span><span class="n">reset_time_s</span><span class="o">=</span><span class="mi">5</span> \
    <span class="o">--</span><span class="n">dataset</span><span class="o">.</span><span class="n">push_to_hub</span><span class="o">=</span><span class="n">false</span> \
    <span class="o">--</span><span class="n">dataset</span><span class="o">.</span><span class="n">single_task</span><span class="o">=</span><span class="s2">"Grab the cube"</span> \
    <span class="o">--</span><span class="n">display_data</span><span class="o">=</span><span class="n">true</span>
</code></pre></div>
<p>å¦‚æœæ˜¯æ¨¡å‹æ¨ç†æ¨¡å¼ï¼Œåˆ™å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">lerobot</span><span class="o">.</span><span class="n">record</span>  \
  <span class="o">--</span><span class="n">robot</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="n">so101_follower</span> \
  <span class="o">--</span><span class="n">robot</span><span class="o">.</span><span class="n">disable_torque_on_disconnect</span><span class="o">=</span><span class="n">true</span> \
  <span class="o">--</span><span class="n">robot</span><span class="o">.</span><span class="n">port</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">ttyACM0</span> \
<span class="o">--</span><span class="n">robot</span><span class="o">.</span><span class="n">cameras</span><span class="o">=</span><span class="s2">"{ handeye: {type: opencv, index_or_path: 6, width: 640, height: 480, fps: 30}, fixed: {type: opencv, index_or_path: 0, width: 640, height: 480, fps: 30}}"</span> \
  <span class="o">--</span><span class="n">robot</span><span class="o">.</span><span class="n">id</span><span class="o">=</span><span class="n">R12252801</span> \
  <span class="o">--</span><span class="n">display_data</span><span class="o">=</span><span class="n">false</span> \
  <span class="o">--</span><span class="n">dataset</span><span class="o">.</span><span class="n">single_task</span><span class="o">=</span><span class="s2">"Put brick into the box"</span> \
  <span class="o">--</span><span class="n">policy</span><span class="o">.</span><span class="n">path</span><span class="o">=</span><span class="n">outputs</span><span class="o">/</span><span class="n">weigh_07280842</span><span class="o">/</span><span class="n">pretrained_model</span> \
  <span class="o">--</span><span class="n">dataset</span><span class="o">.</span><span class="n">episode_time_s</span><span class="o">=</span><span class="mi">240</span>  \
  <span class="o">--</span><span class="n">dataset</span><span class="o">.</span><span class="n">repo_id</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">HF_USER</span><span class="p">}</span><span class="o">/</span><span class="n">eval_so101_07271148</span>

<span class="n">é»˜è®¤å½•åˆ¶æ—¶é•¿æ˜¯60s</span><span class="err">ï¼Œ</span><span class="mi">60</span><span class="n">Såä¼šåœæ­¢</span><span class="err">ï¼Œ</span><span class="n">å¦‚æœè¦æ”¹é•¿åŠ ä¸Š</span><span class="o">--</span><span class="n">dataset</span><span class="o">.</span><span class="n">episode_time_s</span><span class="o">=</span><span class="mi">640</span> 
</code></pre></div>
<p>ä¸»è¦çš„åŒºåˆ«æ˜¯å¦‚æœæ˜¯é‡‡é›†æ¨¡å¼éœ€è¦ä½¿ç”¨--teleopå‚æ•°å¯åŠ¨é¥æ§æœºå™¨ï¼Œå¦‚æœæ˜¯æ¨¡å‹æ¨ç†æ¨¡å¼åˆ™ä¸éœ€è¦å¯åŠ¨é¥æ§æœºå™¨ï¼Œä½†æ˜¯éœ€è¦æŒ‡å®šæ¨¡å‹è·¯å¾„--policy.pathï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æœºå™¨äººçš„åŠ¨ä½œæŒ‡ä»¤æ¥æºäºå“ªé‡Œï¼Œè¦ä¹ˆæ¥ä¹‹é¥æ§å™¨çš„ï¼Œè¦ä¹ˆæ¥è‡ªæ¨¡å‹æ¨ç†å‡ºæ¥çš„ã€‚</p>
<p>åœ¨é˜…è¯»æœ¬æ–‡å‰ï¼Œè¿™é‡Œå…ˆåšä¸€ä¸ªæ€»ç»“ï¼š</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/07/wp_editor_md_643928e8d5da2fdf1d721700de6bbb9e.jpg"><img alt="" src="assets/doc/04-ai/lerobot/lerobotæ•°æ®é‡‡é›†ä¸æ¨¡å‹æµ‹è¯•/images/wp_editor_md_643928e8d5da2fdf1d721700de6bbb9e.jpg"/></a></p>
<p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºæ•´ä¸ªå½•åˆ¶æµç¨‹ä¸»è¦å›´ç»•æœºå™¨è®¾å¤‡ã€é¥æ§è®¾å¤‡ã€æ¨¡å‹ã€æ•°æ®é›†å››ä¸ªè¦ç´ è¿›è¡Œå±•å¼€ã€‚</p>
<ul>
<li>æœºå™¨ï¼šæœ‰SO101Followerã€LeKiwiç­‰æœºå™¨ï¼Œéƒ½ç»§æ‰¿Robotç±»ã€‚é€šè¿‡å‘½ä»¤è¡Œå‚æ•°robot.typeè°ƒç”¨make_robot_from_configå‡½æ•°é€‰æ‹©åˆ›å»ºå…·ä½“çš„å®ä¾‹è®¾å¤‡ï¼Œå‡½æ•°è¿”å›çš„è¿˜æ˜¯Robotä½†æ˜¯æŒ‡å‘çš„æ˜¯å…·ä½“çš„æœºå™¨å®ä¾‹å¦‚SO101Followerï¼Œåˆ©ç”¨äº†å¤šæ€çš„ç‰¹æ€§åšåˆ°äº†è§£è€¦ï¼Œå¦‚æœè¦æ–°æ·»æœºå™¨æ—¶ï¼Œåªéœ€è¦å‚è€ƒSO101Followeræ·»åŠ ä¸€ä¸ªæ–°çš„è®¾å¤‡å³å¯ã€‚åœ¨åˆ›å»ºæœºå™¨å®ä¾‹æ—¶ä¼ é€’RobotConfigå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°ä¾æ—§æ˜¯æŠ½è±¡åŸºç±»ï¼Œå…¶ç»§æ‰¿äº†draccus.ChoiceRregistryï¼Œé€šè¿‡å‘½ä»¤è¡Œå‚æ•°robot.typeé€‰æ‹©æ³¨å†Œå…·ä½“çš„é…ç½®å¦‚SO101FollowerConfigã€‚</li>
<li>é¥æ§ï¼šç”¨äºæ§åˆ¶æœºå™¨ï¼Œå¸¸ç”¨äºæ•°æ®çš„é‡‡é›†ã€‚è¿™é‡ŒåŒæ ·é€šè¿‡å‘½ä»¤è¡Œå‚æ•°teleop.typeè°ƒç”¨make_teleoperator_from_configå‡½æ•°é€‰æ‹©åˆ›å»ºå…·ä½“çš„è®¾å¤‡å®ä¾‹ï¼Œåˆ›å»ºå®ä¾‹æ—¶éœ€è¦ä¼ é€’TeleoperatorConfigå‚æ•°ï¼Œå…¶ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡åŸºç±»ï¼ŒåŸºäºå‘½ä»¤é€‰æ‹©æ³¨å†Œå®ä¾‹åŒ–çš„é…ç½®ç±»å‚æ•°ï¼Œå¦‚SO101LeaderConfigã€‚</li>
<li>æ¨¡å‹ï¼šæ¨¡å‹ç”¨äºå†³ç­–æ¨ç†åŠ¨ä½œï¼Œå…¶å’Œé¥æ§äºŒé€‰ä¸€ï¼Œå¦‚æœæŒ‡å®šäº†é¥æ§äº†ï¼Œæ¨¡å‹å°±ä¸éœ€è¦æŒ‡å®šäº†ã€‚é€šç”¨ä½¿ç”¨äº†æœºå™¨ã€é¥æ§çš„è§£è€¦æœºåˆ¶ï¼Œå…·ä½“çš„å®ä¾‹åŒ–ä¸ºACTæˆ–DiffusionPolicyç­‰ã€‚</li>
<li>æ•°æ®ï¼šé€šè¿‡å‚æ•°dataset.xxxå°†å‚æ•°æ„å»ºä¸ºDataRecordConfigç±»ï¼Œç„¶åå°†å…¶ä¸­çš„ä¿¡æ¯ä¼ é€’ç»™LeRobotDatasetã€‚</li>
</ul>
<p>lerobotçš„æ•´ä¸ªä»£ç æ¡†æ¶å°†å…·ä½“çš„è®¾å¤‡ã€é…ç½®ã€æ¨¡å‹ç­‰åšåˆ°äº†è§£è€¦ï¼Œæ–¹ä¾¿æ‹“å±•æ–°çš„è®¾å¤‡ï¼Œå…¶è®¾è®¡æ€æƒ³å€¼å¾—å€Ÿé‰´ã€‚ä¸‹é¢æœ¬æ–‡å°†å…ˆæŒ‰ç…§æ‰§è¡Œå‘½ä»¤å¯åŠ¨æµç¨‹å¯ä»¥åˆ†ä¸ºå‚æ•°è§£æã€ç¡¬ä»¶è®¾å¤‡åˆå§‹åŒ–ä¸è¿æ¥ã€æ•°æ®é›†åˆå§‹åŒ–ã€é‡‡é›†å¾ªç¯ã€æ•°æ®ä¿å­˜ç­‰å‡ ä¸ªé˜¶æ®µï¼Œæ¥ä¸‹æ¥å°†æŒ‰ç…§è¿™å‡ ä¸ªé˜¶æ®µè¿›è¡Œä»‹ç»ã€‚</p>
<h2 id="_2">å…³é”®é…ç½®ç±»</h2>
<p>åœ¨ä»‹ç»å…³é”®æµç¨‹æ—¶ï¼Œå…ˆæ¥æ€»ç»“ä¸€ä¸‹å…³é”®recordæµç¨‹éœ€è¦çš„é…ç½®ç±»æ•°æ®ç»“æ„ï¼Œè¿™äº›Configç±»ä¸»è¦ç”¨äºæœºå™¨ã€é¥æ§ã€æ¨¡å‹å®ä¾‹åŒ–ä¼ é€’çš„å‚æ•°ã€‚</p>
<h3 id="recordconfig">RecordConfig</h3>
<p>RecordConfigæ˜¯æ•´ä¸ªrecordå…¥å£å‡½æ•°çš„ä¼ é€’å‚æ•°ï¼Œå…¶é€šè¿‡å‘½ä»¤è¡Œçš„å‚æ•°æ„å»ºå½¢æˆRecordConfigå¯¹è±¡ä¼ é€’ç»™å‡½æ•°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">RecordConfig</span><span class="p">:</span>
    <span class="c1"># 1. æ ¸å¿ƒä»¥æ¥é…ç½®</span>
    <span class="c1"># æœºå™¨äººç¡¬ä»¶é…ç½®å¦‚å‹å·ã€ç«¯å£ã€ç›¸æœºå‚æ•°ç­‰ï¼Œæœ‰RobotConfigç±»å®šä¹‰</span>
    <span class="c1"># å¦‚s101_folloerçš„é€šä¿¡ç«¯å£ã€å…³èŠ‚é™åˆ¶ç­‰ï¼Œå¿…ç°é€šè¿‡å‘½ä»¤è¡Œæˆ–ä»£ç æ˜¾å¼ä¼ å…¥ã€‚</span>
    <span class="n">robot</span><span class="p">:</span> <span class="n">RobotConfig</span>
    <span class="c1">#æ•°æ®é›†å½•åˆ¶é…ç½®ï¼Œå¦‚repo_idï¼Œnum_episodesã€fpsdengï¼Œå¿…ç°æ˜¾å¼ä¼ å…¥ã€‚</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="n">DatasetRecordConfig</span>
    <span class="c1"># 2.æ§åˆ¶æ–¹å¼é…ç½®ï¼ˆå¯é€‰ï¼‰</span>
    <span class="c1"># é¥æ§æ“ä½œå™¨é…ç½®ï¼Œå¦‚So100_leaderï¼Œå¯é€‰ã€‚</span>
    <span class="n">teleop</span><span class="p">:</span> <span class="n">TeleoperatorConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># é¢„è®­ç»ƒç­–ç•¥é…ç½®ï¼Œå¦‚æ¨¡å‹è·¯å¾„ã€æ¨ç†è®¾å¤‡ç­‰ã€‚</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n">PreTrainedConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#3. UIä¸åé¦ˆé…ç½®ï¼ˆå¯é€‰ï¼‰</span>
    <span class="c1"># æ˜¯å¦å®æ—¶æ˜¾ç¤ºç›¸æœºç”»é¢ï¼Œé€šè¿‡rerunå¯è§†åŒ–å·¥å…·</span>
    <span class="n">display_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># æ˜¯å¦å¯ç”¨è¯­éŸ³åˆæˆåé¦ˆï¼Œäººæœºçš„æç¤ºå£°ï¼Œé»˜è®¤å¼€å¯ã€‚</span>
    <span class="n">play_sounds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># æ˜¯å¦ä»ç°æœ‰æ•°æ®é›†ç»­å½•</span>
    <span class="n">resume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># å¦‚æœæŒ‡å®šäº†policyï¼Œåˆ™è¿›è¡ŒåŠ è½½æ¨¡å‹</span>
        <span class="n">policy_path</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_path_arg</span><span class="p">(</span><span class="s2">"policy"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">policy_path</span><span class="p">:</span>
            <span class="n">cli_overrides</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_cli_overrides</span><span class="p">(</span><span class="s2">"policy"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">PreTrainedConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">policy_path</span><span class="p">,</span> <span class="n">cli_overrides</span><span class="o">=</span><span class="n">cli_overrides</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">pretrained_path</span> <span class="o">=</span> <span class="n">policy_path</span>
         <span class="c1"># teleopå’Œpolicyå¿…é¡»è¦æŒ‡å®šä¸€ä¸ª</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">teleop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Choose a policy, a teleoperator or both to control the robot"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__get_path_fields__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""This enables the parser to load config from the policy using `--policy.path=local/dir`"""</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">"policy"</span><span class="p">]</span>
</code></pre></div>
<p>RecordConfigä¸­æœ‰å‡ ä¸ªå…³é”®çš„æˆå‘˜ï¼Œåˆ†åˆ«æ˜¯RobotConfigï¼ŒDatasetRrcordConfigã€TeleoperatorConfigã€PreTrainedConfigã€‚å…¶ä¸­é™¤äº†DatasetRrcordConfigå¤–çš„å…¶ä»–å‡ ä¸ªéƒ½æ˜¯ç»§æ‰¿draccus.ChoiceRegistry å’Œ abc.ABCï¼Œæ˜¯ä¸€ä¸ªæŠ½è±¡åŸºç±»ï¼Œéœ€é€šè¿‡æ³¨å†Œçš„å­ç±»ï¼ˆå¦‚ç‰¹å®šæœºå™¨äººå‹å·çš„é…ç½®ç±»ï¼‰å®ä¾‹åŒ–ï¼Œç§è®¾è®¡æ—¢ä¿è¯äº†é…ç½®çš„ç»“æ„åŒ–ï¼ˆç»§æ‰¿ abc.ABCï¼‰ï¼Œåˆæ”¯æŒçµæ´»çš„å­ç±»é€‰æ‹©ï¼ˆé€šè¿‡ draccus.ChoiceRegistry å®ç°é…ç½®æ³¨å†Œä¸è§£æï¼‰ã€‚</p>
<ul>
<li>RobotConfig æ§åˆ¶ç¡¬ä»¶æ¥å£ï¼Œç¡®ä¿æœºå™¨äººæ­£ç¡®è¿æ¥å’Œæ•°æ®é‡‡é›†ï¼›</li>
<li>DatasetRecordConfig æ§åˆ¶æ•°æ®å­˜å‚¨ï¼Œå®šä¹‰æ•°æ®é›†æ ¼å¼å’Œå…ƒä¿¡æ¯ï¼›</li>
<li>TeleoperatorConfig å’Œ PreTrainedConfig æ§åˆ¶æœºå™¨äººè¡Œä¸ºï¼Œåˆ†åˆ«å¯¹åº”æ‰‹åŠ¨å’Œè‡ªåŠ¨æ§åˆ¶æ¨¡å¼ã€‚</li>
</ul>
<h3 id="robotconfig">RobotConfig</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">#æ ‡è®°ä¸ºæ•°æ®ç±»ï¼Œæ‰€æœ‰å­—æ®µå¿…ç°é€šè¿‡å…³é”®å‚æ•°ä¼ å…¥ï¼Œè‡ªåŠ¨ç”Ÿæˆ__init__ç­‰æ–¹æ³•</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#ç»§æ‰¿draccusæ¡†æ¶é€‰æ‹©æ³¨å†Œæœºåˆ¶ï¼Œå…è®¸å­ç±»å¦‚SO100FollowerConfigã€KochFollowerConfig</span>
<span class="c1">#ä½œä¸ºå¯é€‰æœºå™¨äººå‹å·æ³¨å†Œï¼Œæ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶æˆ–å‘½ä»¤è¡Œå‚æ•°</span>
<span class="c1">#åŠ¨æ€é€‰æ‹©ä¾‹å¦‚--robot.type=s101_follower</span>
<span class="c1">#abc.ABCæŠ½è±¡åŸºç±»ï¼Œä¸å¯ç›´æ¥å®ä¾‹åŒ–ï¼Œå¿…ç°é€šè¿‡å­ç±»å…·ä½“æœºå™¨äººå‹å·é…ç½®ä½¿ç”¨ã€‚</span>
<span class="k">class</span> <span class="nc">RobotConfig</span><span class="p">(</span><span class="n">draccus</span><span class="o">.</span><span class="n">ChoiceRegistry</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="c1"># æœºå™¨çš„å”¯ä¸€æ ‡è¯†å®ä¾‹</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># æ ‡å®šæ–‡ä»¶å­˜å‚¨ç›®å½•</span>
    <span class="n">calibration_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#æ˜¯ dataclass çš„åˆå§‹åŒ–åé’©å­ï¼Œç”¨äºè¡¥å……å‚æ•°æ ¡éªŒé€»è¾‘ï¼Œç¡®ä¿æœºå™¨äººé…ç½®çš„åˆæ³•æ€§ã€‚</span>
    <span class="c1">#ä¸»è¦æ˜¯æ£€æŸ¥camerasä¸­çš„å®½é«˜ã€å¸§ç‡ç­‰ã€‚</span>
    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"cameras"</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cameras</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cameras</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"width"</span><span class="p">,</span> <span class="s2">"height"</span><span class="p">,</span> <span class="s2">"fps"</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">"Specifying '</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">' is required for the camera to be used in a robot"</span>
                        <span class="p">)</span>
    <span class="c1">#é€šè¿‡ draccus.ChoiceRegistry çš„ get_choice_name æ–¹æ³•ï¼ŒåŠ¨æ€è¿”å›å­ç±»çš„æ³¨å†Œåç§°ï¼ˆå³æœºå™¨äººå‹å·ï¼‰ã€‚</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_choice_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
</code></pre></div>
<p>RobotConfig æ˜¯æŠ½è±¡åŸºç±»ï¼ˆABCï¼‰ï¼Œä»…å®šä¹‰æ‰€æœ‰æœºå™¨å…±æœ‰çš„é€šç”¨é…ç½®å­—æ®µï¼Œå¦‚idã€calibration_dirã€‚å…¶ç»§æ‰¿äº†draccus.ChoiceRegistryå®ç°äº†ä¸åŒæœºå™¨äººå‹å·çš„åŠ¨æ€æ³¨å†Œä¸é€‰æ‹©ã€‚</p>
<p>ä¸‹é¢ä»¥ä¸€ä¸ªç»§æ‰¿å®ä¾‹è¯´æ˜</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@RobotConfig</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">"so101_follower"</span><span class="p">)</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SO101FollowerConfig</span><span class="p">(</span><span class="n">RobotConfig</span><span class="p">):</span>
    <span class="c1"># æœºå™¨çš„é€šä¿¡ç«¯å£ï¼Œå¦‚/dev/ttyACM0ï¼Œé€šè¿‡--robot.portå‘½ä»¤ä¼ å…¥</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># æ–­å¼€è¿æ¥æ—¶æ˜¯å¦å…³é—­ç”µæœºæ‰­çŸ©ï¼Œé€šè¿‡å‘½ä»¤--robot.disable_torque_on_disconnect</span>
    <span class="n">disable_torque_on_disconnect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># ç”µæœºç›¸å¯¹ä½ç½®ç›®æ ‡å®‰å…¨ä¸Šé™ï¼Œé˜²æ­¢è¿åŠ¨å¹…åº¦è¿‡å¤§ã€‚</span>
    <span class="n">max_relative_target</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># ç›¸æœºçš„é…ç½®é€šè¿‡å­—å…¸çš„æ–¹å¼ã€‚</span>
    <span class="n">cameras</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CameraConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1">#--robot.cameras="{ handeye: {type: opencv, index_or_path: 6, width: 640, height: 480, fps: 30}, fixed: {type: opencv, index_or_path: 0, width: 640, height: 480, fps: 30}}</span>

    <span class="c1"># æ˜¯å¦ä½¿ç”¨è§’åº¦åˆ¶è€Œéå¼§åº¦åˆ¶</span>
    <span class="n">use_degrees</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
<p>è¿™æ˜¯æ¡†æ¶è‡ªå®šä¹‰çš„å­ç±»æ³¨å†Œè£…é¥°å™¨ï¼Œä½œç”¨æ˜¯å°† SO101FollowerConfig ç±»ä¸å­—ç¬¦ä¸² so101_follower ç»‘å®šï¼Œä½¿å…¶æˆä¸º RobotConfig çš„å¯é€‰å‹å·ã€‚è£…é¥°å™¨å†…éƒ¨ä¼šå°† SO101FollowerConfig ç±»æ·»åŠ åˆ° RobotConfig çš„â€œå­ç±»æ³¨å†Œè¡¨â€ä¸­ï¼Œé”®ä¸º so101_followerï¼Œå€¼ä¸ºç±»æœ¬èº«ã€‚å½“ç”¨æˆ·é€šè¿‡å‘½ä»¤è¡Œä¼ å…¥ --robot.type=so101_follower æ—¶ï¼Œæ¡†æ¶ä¼šä»æ³¨å†Œè¡¨ä¸­æŸ¥æ‰¾å¹¶å®ä¾‹åŒ–è¯¥ç±»ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼ŒRobotConfigæ˜¯æœºå™¨çš„ç¡¬ä»¶é…ç½®ï¼Œä½†æ˜¯å…¶æ˜¯ä¸€ä¸ªè™šæ‹ŸåŸºç±»ï¼Œå…¶å…·ä½“å®ä¾‹çš„æœºå™¨å‹å·é€šè¿‡å­ç±»ç»§æ‰¿RobotConfigï¼Œæœ‰å¾ˆå¤šå‹å·çš„å­ç±»ï¼Œå…¶å·§å¦™çš„ä½¿ç”¨äº†draccus.ChoiceRegistryæ³¨å†Œæœºåˆ¶ï¼ˆRobotConfigç»§æ‰¿ï¼‰ï¼Œé€šè¿‡å‚æ•°--robot.typeæ¥æŒ‡å®šå…·ä½“å®ä¾‹åŒ–çš„è®¾å¤‡ã€‚åŒæ—¶è¿™é‡Œä¹Ÿä½¿ç”¨äº†å¤šæ€çš„ç‰¹æ€§ï¼Œé€šè¿‡ç»Ÿä¸€çš„RobotConfigæ¥å£æ“ä½œä¸åŒå®ä¾‹çš„å…·ä½“å®ç°ï¼Œå¦‚é€šè¿‡ robot.type å±æ€§ï¼ˆåŸºç±»å®šä¹‰ï¼‰ï¼Œå¯ä»¥åŠ¨æ€åˆ¤æ–­å…·ä½“å­ç±»ç±»å‹ï¼Œå¹¶æ‰§è¡Œå¯¹åº”é€»è¾‘ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"so101_follower"</span><span class="p">:</span>  <span class="c1"># é€šè¿‡åŸºç±»æ¥å£è·å–å­ç±»ç±»å‹</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"SO101 ç‰¹æœ‰ç«¯å£: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>  <span class="c1"># è®¿é—®å­ç±»ç‰¹æœ‰å±æ€§</span>
<span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"so100_follower"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"SO100 ç‰¹æœ‰IP: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>  <span class="c1"># å¦ä¸€å­ç±»çš„ç‰¹æœ‰å±æ€§</span>
</code></pre></div>
<h3 id="datasetrecordconfig">DatasetRecordConfig</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DatasetRecordConfig</span><span class="p">:</span>
    <span class="c1">#1. æ•°æ®é›†æ ‡è¯†ä¸å­˜å‚¨</span>
    <span class="c1">#æ•°æ®é›†å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ ¼å¼ä¸º '{hf_username}/{dataset_name}' (e.g. `lerobot/test`)ï¼Œç”¨äºå®šä½hugging Face Hubä»“åº“æˆ–æœ¬åœ°è·¯å¾„</span>
    <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span>
   <span class="c1">#å½•åˆ¶ä»»åŠ¡çš„æ–‡å­—æè¿°ï¼Œç”¨äºæ ‡æ³¨æ•°æ®ç”¨é€”ã€‚</span>
    <span class="n">single_task</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># æ•°æ®é›†æœ¬åœ°å­˜å‚¨æ ¹ç›®å½•ï¼Œå¦‚æœæœªæŒ‡å®šä½¿ç”¨~/.cache/huggingface/datasets</span>
    <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># 2.å½•åˆ¶æ§åˆ¶å‚æ•°</span>
    <span class="c1"># å½•åˆ¶çš„å¸§ç‡ï¼Œæ§åˆ¶æ•°æ®é‡‡é›†å¸§ç‡ã€‚</span>
    <span class="n">fps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="c1"># å•æ®µå½•åˆ¶æ—¶é•¿ï¼Œé»˜è®¤60S</span>
    <span class="n">episode_time_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="c1"># é‡ç½®ç¯å¢ƒæ—¶é•¿ï¼Œä¸¤ç«¯å½•åˆ¶ä¹‹é—´é¢„ç•™ç¯å¢ƒé‡ç½®æ—¶é—´ã€‚</span>
    <span class="n">reset_time_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="c1"># æ€»å½•åˆ¶æ®µæ•°ï¼Œæ§åˆ¶æ•°æ®é›†åŒ…å«æ ·æœ¬æ•°é‡ï¼ˆå¦‚50æ®µ*60S=3000Sæ€»æ•°æ®ï¼‰</span>
    <span class="n">num_episodes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="c1">#3. æ•°æ®å¤„ç†ä¸ä¸Šä¼ </span>
    <span class="c1"># æ˜¯å¦å°†å½•åˆ¶å›¾åƒå¸§ç¼–ç ä¸ºè§†é¢‘æ–‡ä»¶ï¼Œé»˜è®¤å¼€å¯</span>
    <span class="n">video</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># æ˜¯å¦ä¸Šä¼ æ•°æ®é›†åˆ°hugging Face Hubï¼Œé»˜è®¤è‡ªåŠ¨ä¸Šä¼ ã€‚</span>
    <span class="n">push_to_hub</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Hubä»“åº“æ˜¯å¦è®¾ç½®ä¸ºç§æœ‰ï¼Œé»˜è®¤æ˜¯å…¬å¼€</span>
    <span class="n">private</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># ä¸Šä¼ åˆ°hubä¸Šçš„æ•°æ®é›†æ ‡ç­¾</span>
    <span class="n">tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#4. å›¾åƒå­˜å‚¨æ€§èƒ½å‚æ•°</span>
    <span class="c1">#å›¾åƒå†™å…¥çš„çº¿ç¨‹æ•°</span>
    <span class="n">num_image_writer_processes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#æ¯ä¸ªç›¸æœºå›¾åƒå†™å…¥çš„çº¿ç¨‹æ•°</span>
    <span class="n">num_image_writer_threads_per_camera</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"You need to provide a task as argument in `single_task`."</span><span class="p">)</span>
    <span class="c1">#__post_init__ æ˜¯ dataclass çš„åˆå§‹åŒ–åé’©å­æ–¹æ³•ï¼Œåœ¨ __init__ åˆå§‹åŒ–æ‰€æœ‰å­—æ®µåè‡ªåŠ¨æ‰§è¡Œï¼Œ</span>
    <span class="c1"># ç”¨äºè¡¥å……æ ¡éªŒé€»è¾‘ã€‚</span>
    <span class="c1"># ç¡®ä¿ single_task å­—æ®µä¸ä¸ºç©ºã€‚å› ä¸º single_task æ˜¯æè¿°å½•åˆ¶ä»»åŠ¡çš„æ ¸å¿ƒå…ƒæ•°æ®ï¼ˆæ— é»˜è®¤å€¼ä¸”å¿…é€‰ï¼‰ï¼Œ</span>
    <span class="c1"># è‹¥æœªæä¾›åˆ™ç›´æ¥æŠ›å‡ºé”™è¯¯ï¼Œé¿å…åç»­æ•°æ®æ ‡æ³¨ç¼ºå¤±å…³é”®ä¿¡æ¯ã€‚</span>
</code></pre></div>
<p>DatasetRecordConfig æ˜¯æ•°æ®é›†å½•åˆ¶ä»»åŠ¡çš„å‚æ•°å®¹å™¨ï¼Œè¢«åµŒå¥—åœ¨ RecordConfig ä¸­ï¼ˆä½œä¸º RecordConfig.dataset å­—æ®µï¼‰ï¼Œæœ€ç»ˆé€šè¿‡ parser.wrap() è£…é¥°å™¨ä»å‘½ä»¤è¡Œå‚æ•°è§£æç”Ÿæˆå®ä¾‹ã€‚</p>
<p>ä¾‹å¦‚ï¼Œç”¨æˆ·é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="o">--</span><span class="n">dataset</span><span class="o">.</span><span class="n">repo_id</span><span class="o">=</span><span class="n">aliberts</span><span class="o">/</span><span class="n">record</span><span class="o">-</span><span class="n">test</span> <span class="o">--</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_episodes</span><span class="o">=</span><span class="mi">2</span> <span class="o">--</span><span class="n">dataset</span><span class="o">.</span><span class="n">single_task</span><span class="o">=</span><span class="s2">"Grab the cube"</span>
</code></pre></div>
<p>è¿™äº›å‚æ•°ä¼šè¢«è§£æä¸º DatasetRecordConfig å®ä¾‹ï¼Œå…¶å­—æ®µå€¼ï¼ˆå¦‚ num_episodes=2ï¼‰ç›´æ¥æ§åˆ¶å½•åˆ¶é€»è¾‘ï¼ˆå¦‚ record_loop å‡½æ•°çš„å¾ªç¯æ¬¡æ•°ï¼‰ã€‚</p>
<h3 id="teleoperatorconfig">TeleoperatorConfig</h3>
<div class="codehilite"><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TeleoperatorConfig</span><span class="p">(</span><span class="n">draccus</span><span class="o">.</span><span class="n">ChoiceRegistry</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="c1"># Allows to distinguish between different teleoperators of the same type</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Directory to store calibration file</span>
    <span class="n">calibration_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_choice_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
</code></pre></div>
<p>TeleoperatorConfig æ˜¯è¿œç¨‹é¥æ§æ“ä½œå™¨ï¼ˆå¦‚æ‰‹æŸ„ã€é”®ç›˜ã€ leader æœºå™¨äººï¼‰çš„æŠ½è±¡é…ç½®åŸºç±»ï¼Œç”¨äºå®šä¹‰æ‰€æœ‰é¥æ“ä½œå™¨å…±æœ‰çš„é€šç”¨é…ç½®å­—æ®µå’ŒåŠ¨æ€é€‰æ‹©æœºåˆ¶ã€‚å®ƒä¸RobotConfigç±»ä¼¼ï¼ŒåŒæ ·ç»§æ‰¿äº†draccus.ChoiceRegistry å®ç°äº†æ³¨å†Œæœºåˆ¶ï¼Œå…¶å…·ä½“çš„å­ç±»åˆç»§æ‰¿TeleoperatorConfigã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@TeleoperatorConfig</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">"so101_leader"</span><span class="p">)</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SO101LeaderConfig</span><span class="p">(</span><span class="n">TeleoperatorConfig</span><span class="p">):</span>
    <span class="c1"># Port to connect to the arm</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">str</span>

    <span class="n">use_degrees</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
<p>ç”¨æˆ·é€šè¿‡-teleop.typeæŒ‡å®šæ¥å®ä¾‹åŒ–å…·ä½“çš„æ“ä½œè®¾å¤‡ï¼Œå¦‚--teleop.type=so101_leaderæ—¶ï¼Œå…·ä½“çš„æµç¨‹å¦‚ä¸‹ã€‚</p>
<ul>
<li>æ¡†æ¶é€šè¿‡ draccus.ChoiceRegistry æŸ¥æ‰¾æ³¨å†Œåç§°ä¸º so101_leader çš„å­ç±»ï¼ˆå¦‚ SO101LeaderConfigï¼‰ï¼›</li>
<li>å®ä¾‹åŒ–è¯¥å­ç±»ï¼Œæ¥æ”¶å‘½ä»¤è¡Œå‚æ•°ï¼ˆå¦‚ --teleop.port=/dev/ttyACM0ï¼‰å¹¶åˆå§‹åŒ–ç‰¹æœ‰å­—æ®µï¼ˆå¦‚ portï¼‰ï¼›</li>
<li>æœ€ç»ˆé€šè¿‡ TeleoperatorConfig åŸºç±»å¼•ç”¨ï¼ˆå¦‚ cfg.teleopï¼‰ä¼ å…¥ make_teleoperator_from_config å‡½æ•°ï¼Œåˆ›å»ºå…·ä½“é¥æ“ä½œå™¨å®ä¾‹ã€‚</li>
</ul>
<h3 id="pretrainedconfig">PreTrainedConfig</h3>
<div class="codehilite"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PreTrainedConfig</span><span class="p">(</span><span class="n">draccus</span><span class="o">.</span><span class="n">ChoiceRegistry</span><span class="p">,</span> <span class="n">HubMixin</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="c1">#1. è§‚æµ‹ä¸ç‰¹å¾é…ç½®</span>
    <span class="c1"># ç­–ç•¥è¾“å…¥çš„è§‚æµ‹éƒ¨ç½²ï¼Œå¦‚=2è¡¨ç¤ºè¾“å…¥å½“å‰+å‰1æ­¥è§‚æµ‹</span>
    <span class="n">n_obs_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">#ç‰¹å¾å½’ä¸€åŒ–æ¨¡å¼æ˜ å°„{"image":"mead_std"}</span>
    <span class="n">normalization_mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NormalizationMode</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
   <span class="c1">#è¾“å…¥ç‰¹å¾çš„è§„èŒƒ{"image": PolicyFeature(type=VISUAL, shape=(3, 224, 224))}ï¼‰</span>
    <span class="n">input_features</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">PolicyFeature</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1">#è¾“å‡ºç‰¹å¾è§„èŒƒè¾“å‡ºç‰¹å¾è§„èŒƒï¼ˆå®šä¹‰ç­–ç•¥è¾“å‡ºçš„ç‰¹å¾ç±»å‹ï¼Œå¦‚ {"action": PolicyFeature(type=ACTION, shape=(6,))}ï¼‰</span>
    <span class="n">output_features</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">PolicyFeature</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="c1">#2. è®¾å¤‡ä¸æ€§èƒ½é…ç½®</span>
    <span class="c1"># ç­–ç•¥è¿è¡Œè®¾å¤‡å¦‚æ˜¯å¦ä½¿ç”¨cudaæˆ–cpu</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># cuda | cpu | mp</span>
    <span class="c1">#æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ··åˆç²¾åº¦è®­ç»ƒ</span>
    <span class="n">use_amp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#3. hugging face Hubç»§æ‰¿</span>
    <span class="c1">#æ˜¯å¦å°†é…ç½®ä¸Šä¼ åˆ°Hub</span>
    <span class="n">push_to_hub</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1">#Hubçš„id</span>
    <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># ä»“åº“æ˜¯å¦ç§æœ‰</span>
    <span class="n">private</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># ä»“åº“çš„æ ‡ç­¾</span>
    <span class="n">tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Add tags to your policy on the hub.</span>
    <span class="n">license</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#æ–¹æ³•åœ¨__init__åæ‰§è¡Œï¼Œå¤„ç†è¿è¡Œè®¾å¤‡é€‰æ‹©å’ŒAMPçš„å¯ç”¨æ€§</span>
    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#è‡ªåŠ¨é€‰æ‹©å¯ç”¨è®¾å¤‡ï¼Œå¦‚æœç”¨æˆ·æŒ‡å®šçš„è®¾å¤‡ä¸å¯ç”¨ã€‚</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_torch_device_available</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">):</span>
            <span class="n">auto_device</span> <span class="o">=</span> <span class="n">auto_select_torch_device</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Device '</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">' is not available. Switching to '</span><span class="si">{</span><span class="n">auto_device</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">auto_device</span><span class="o">.</span><span class="n">type</span>

        <span class="c1">#è‡ªåŠ¨ç¦ç”¨ä¸æ”¯æŒAMP</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_amp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_amp_available</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Automatic Mixed Precision (amp) is not available on device '</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">'. Deactivating AMP."</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_amp</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#é€šè¿‡ draccus.ChoiceRegistry çš„ get_choice_name æ–¹æ³•ï¼Œè¿”å›å­ç±»æ³¨å†Œçš„ç­–ç•¥å‹å·åç§°ï¼ˆå¦‚ sacã€tdmpcï¼‰ï¼Œç”¨äºæ—¥å¿—æ‰“å°å’Œç­–ç•¥é€‰æ‹©é€»è¾‘</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_choice_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>

    <span class="c1">#æŠ½è±¡æ–¹æ³•</span>
    <span class="n">observation_delta_indices</span><span class="p">:</span><span class="n">è¿”å›è§‚æµ‹ç‰¹å¾çš„å·®åˆ†ç´¢å¼•</span>
    <span class="n">action_delta_indices</span> <span class="p">:</span> <span class="n">è¿”å›åŠ¨ä½œç‰¹å¾çš„å·®åˆ†ç´¢å¼•</span>
    <span class="n">reward_delta_indices</span> <span class="p">:</span> <span class="n">è¿”å›å¥–åŠ±ç‰¹å¾çš„å·®åˆ†ç´¢å¼•</span>
    <span class="n">et_optimizer_preset</span><span class="p">()</span> <span class="p">:</span> <span class="n">è¿”å›ä¼˜åŒ–å™¨é…ç½®</span>
    <span class="n">get_scheduler_preset</span><span class="p">()</span> <span class="p">:</span> <span class="n">è¿”å›å­¦ä¹ ç‡è°ƒåº¦å™¨é…ç½®</span><span class="err">ï¼ˆ</span><span class="n">å¦‚</span> <span class="n">CosineAnnealing</span><span class="err">ï¼‰ã€‚</span>
    <span class="n">validate_features</span><span class="p">()</span> <span class="p">:</span><span class="n">æ ¡éªŒ</span> <span class="n">input_features</span> <span class="n">å’Œ</span> <span class="n">output_features</span> <span class="n">çš„åˆæ³•æ€§</span><span class="err">ï¼ˆ</span><span class="n">å¦‚å½¢çŠ¶åŒ¹é…</span><span class="err">ï¼‰</span>

    <span class="c1">#å°†ç­–ç•¥é…ç½®å®ä¾‹ï¼ˆå«è¶…å‚æ•°ã€ç‰¹å¾è§„èŒƒã€è®¾å¤‡è®¾ç½®ç­‰ï¼‰åºåˆ—åŒ–</span>
    <span class="c1">#ä¸ºæ ‡å‡† JSON æ–‡ä»¶ config.jsonï¼Œå­˜å‚¨åˆ°æŒ‡å®šç›®å½•ã€‚è¿™æ˜¯ç­–ç•¥é…</span>
    <span class="c1">#ç½®ä¸Šä¼ åˆ° Hugging Face Hub çš„å‰ç½®æ­¥éª¤â€”â€”Hub è¦æ±‚æ¨¡å‹/é…</span>
    <span class="c1">#ç½®å¿…é¡»åŒ…å« config.json ä»¥æè¿°å…¶å‚æ•°ï¼Œè€Œ _save_pretrained æ­£</span>
    <span class="c1">#æ˜¯ç”Ÿæˆè¯¥æ–‡ä»¶çš„æ ‡å‡†åŒ–å®ç°ã€‚ä¾‹å¦‚ï¼Œå½“è°ƒç”¨</span>
    <span class="c1">#config.push_to_hub() æ—¶ï¼Œæ¡†æ¶ä¼šå…ˆè°ƒç”¨ _save_pretrained å°†</span>
    <span class="c1">#é…ç½®ä¿å­˜åˆ°ä¸´æ—¶ç›®å½•ï¼Œå†å°†è¯¥ç›®å½•ä¸Šä¼ åˆ° Hubï¼Œæœ€ç»ˆç”¨æˆ·å¯é€š</span>
    <span class="c1">#è¿‡ PreTrainedConfig.from_pretrained("repo_id") åŠ è½½æ­¤ JSON</span>
    <span class="c1">#é…ç½®ã€‚</span>
    <span class="k">def</span> <span class="nf">_save_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_directory</span> <span class="o">/</span> <span class="n">CONFIG_NAME</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="n">draccus</span><span class="o">.</span><span class="n">config_type</span><span class="p">(</span><span class="s2">"json"</span><span class="p">):</span>
            <span class="n">draccus</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="c1">#from_pretrained æ˜¯ PreTrainedConfig çš„ æ ¸å¿ƒç±»æ–¹æ³•ï¼Œç”¨äºä» </span>
    <span class="c1">#æœ¬åœ°ç›®å½• æˆ– Hugging Face Hub åŠ è½½é¢„è®­ç»ƒç­–ç•¥çš„é…ç½®æ–‡ä»¶</span>
    <span class="c1">#ï¼ˆconfig.jsonï¼‰ï¼Œå¹¶å®ä¾‹åŒ–ä¸ºå…·ä½“çš„é…ç½®å¯¹è±¡ï¼ˆå¦‚ SACConfigã€</span>
    <span class="c1">#TDMPCConfigï¼‰ã€‚å®ƒæ˜¯ç­–ç•¥é…ç½®â€œå¤ç”¨ä¸å…±äº«â€çš„å…¥å£ï¼Œæ”¯æŒé€šè¿‡</span>
    <span class="c1">#å‘½ä»¤è¡Œå‚æ•°è¦†ç›–é…ç½®ï¼Œå®ç°çµæ´»çš„å‚æ•°è°ƒæ•´ã€‚</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pretrained</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span>
        <span class="n">pretrained_name_or_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">force_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">resume_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxies</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">local_files_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">revision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">policy_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pretrained_name_or_path</span><span class="p">)</span>
        <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#ä»æœ¬åœ°ç›®å½•åŠ è½½</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">CONFIG_NAME</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">model_id</span><span class="p">):</span>
                <span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">CONFIG_NAME</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">CONFIG_NAME</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="c1">#ä»hugging face hubä¸‹è½½</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">config_file</span> <span class="o">=</span> <span class="n">hf_hub_download</span><span class="p">(</span>
                    <span class="n">repo_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">CONFIG_NAME</span><span class="p">,</span>
                    <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span>
                    <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
                    <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span><span class="p">,</span>
                    <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span>
                    <span class="n">resume_download</span><span class="o">=</span><span class="n">resume_download</span><span class="p">,</span>
                    <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
                    <span class="n">local_files_only</span><span class="o">=</span><span class="n">local_files_only</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">HfHubHTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">CONFIG_NAME</span><span class="si">}</span><span class="s2"> not found on the HuggingFace Hub in </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># HACK: this is very ugly, ideally we'd like to be able to do that natively with draccus</span>
        <span class="c1"># something like --policy.path (in addition to --policy.type)</span>
        <span class="n">cli_overrides</span> <span class="o">=</span> <span class="n">policy_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"cli_overrides"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">with</span> <span class="n">draccus</span><span class="o">.</span><span class="n">config_type</span><span class="p">(</span><span class="s2">"json"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">draccus</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config_file</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cli_overrides</span><span class="p">)</span>
</code></pre></div>
<p>PreTrainedConfigæ˜¯æ‰€æœ‰ç­–ç•¥æ¨¡å‹å¦‚ACT,TDMPCçš„æŠ½è±¡é…ç½®ç±»ï¼Œå®šä¹‰äº†ç­–ç•¥è®­ç»ƒ/æ¨ç†æ‰€éœ€çš„é€šç”¨å‚æ•°ï¼Œç‰¹å¾è§„èŒƒã€è®¾å¤‡é…ç½®åŠHugging Face Hubäº¤äº’æœºåˆ¶ã€‚å®ƒé€šè¿‡ dataclassã€draccus.ChoiceRegistry å’Œ abc.ABC å®ç°â€œé…ç½®æ ‡å‡†åŒ–â€â€œå¤šç­–ç•¥å…¼å®¹â€å’Œâ€œHub é›†æˆâ€ï¼Œæ˜¯ç­–ç•¥åˆå§‹åŒ–çš„æ ¸å¿ƒå‚æ•°è½½ä½“ã€‚</p>
<ul>
<li>draccus.ChoiceRegistryï¼šé€šç”¨è·Ÿå‰é¢çš„RobotConfigç±»ä¼¼ï¼Œæ”¯æŒåŠ¨æ€å­ç±»æ³¨å†Œï¼Œå…è®¸å­ç±»ï¼ˆå¦‚ SACConfigã€TDMPCConfigï¼‰ä½œä¸ºâ€œç­–ç•¥é€‰é¡¹â€æ³¨å†Œï¼Œæ”¯æŒé€šè¿‡ --policy.type=sac åŠ¨æ€é€‰æ‹©ã€‚</li>
<li>HubMixinï¼šHugging Face Hub äº¤äº’æ··å…¥ç±»ï¼Œæä¾› from_pretrainedï¼ˆä» Hub/æœ¬åœ°åŠ è½½é…ç½®ï¼‰å’Œ _save_pretrainedï¼ˆä¿å­˜é…ç½®åˆ° Hub/æœ¬åœ°ï¼‰æ–¹æ³•ï¼Œå®ç°ç­–ç•¥é…ç½®çš„å…±äº«ä¸å¤ç”¨ã€‚</li>
<li>abc.ABCï¼šæŠ½è±¡åŸºç±»ï¼ŒåŒ…å«æœªå®ç°çš„æŠ½è±¡æ–¹æ³•ï¼ˆå¦‚ get_optimizer_presetï¼‰ï¼Œå¼ºåˆ¶å­ç±»å¿…é¡»å®ç°æ ¸å¿ƒé€»è¾‘ï¼Œç¡®ä¿ç­–ç•¥é…ç½®çš„å®Œæ•´æ€§ã€‚</li>
</ul>
<h2 id="_3">å‚æ•°è§£æ</h2>
<p>è¾“å…¥çš„å‚æ•°ä¼šdraccus è§£æå™¨è¯»å–æ‰€æœ‰ --xxx å‚æ•°ï¼Œæ˜ å°„åˆ° RecordConfig ç±»ï¼ˆå®šä¹‰åœ¨ record.py ä¸­ï¼‰ï¼Œç”Ÿæˆç»“æ„åŒ–é…ç½®å¯¹è±¡ RecordConfigç±»å‹çš„cfgå®ä¾‹ï¼Œå…³é”®çš„é…ç½®é¡¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>robot.type=so101_followerï¼šæŒ‡å®šæœºå™¨äººç±»å‹ä¸º so101_followerï¼ˆä»åŠ¨æœºå™¨äººï¼‰ã€‚</li>
<li>teleop.type=so101_leaderï¼šæŒ‡å®šé¥æ“ä½œå™¨ç±»å‹ä¸º so101_leaderï¼ˆä¸»åŠ¨é¥æ“ä½œå™¨ï¼‰ã€‚</li>
<li>dataset.num_episodes=10ï¼šé‡‡é›†10ä¸ªå›åˆæ•°æ®ã€‚</li>
<li>display_data=trueï¼šå¯ç”¨ Rerun å¯è§†åŒ–å·¥å…·æ˜¾ç¤ºæ‘„åƒå¤´ç”»é¢å’Œæœºå™¨äººçŠ¶æ€ã€‚</li>
</ul>
<p>RecordConfigçš„cfgå®ä¾‹æ„é€ æ˜¯ï¼Œä¼šè°ƒç”¨RecordConfig.<strong>post_init</strong> æ£€æŸ¥å¦‚single_taskï¼Œ--teleop.typeä»¥åŠ-policy.typeå¿…ç°è¦é€‰æ‹©ä¸€ä¸ªã€‚å› ä¸ºå½•åˆ¶è¦ä¹ˆå°±æ˜¯éªŒè¯æ¨¡å¼ï¼Œè¦ä¹ˆå°±æ˜¯æ•°æ®é‡‡é›†æ¨¡å¼ã€‚éªŒè¯æ¨¡å¼å°±æ˜¯é€šè¿‡å¤§æ¨¡å‹æ¨ç†å¾—åˆ°çš„åŠ¨ä½œæ•°æ®ï¼Œè€Œé‡‡é›†æ¨¡å¼é€šè¿‡é¥æ§è‡‚å¾—åˆ°çš„æ•°æ®æ§åˆ¶è®¾å¤‡ã€‚</p>
<h2 id="_4">ç¡¬ä»¶åˆå§‹åŒ–ä¸è¿æ¥</h2>
<p><strong>æœºå™¨äººçš„åˆå§‹åŒ–so101_follower</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">robot</span> <span class="o">=</span> <span class="n">make_robot_from_config</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">robot</span><span class="p">)</span>
<span class="n">robot</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</code></pre></div>
<p>ä¼ å…¥çš„å‚æ•°æ˜¯cfg.robotï¼Œcfg.robotæ˜¯ä¸€ä¸ªåŸºç±»ï¼Œå®é™…å®ä¾‹åŒ–ä¸ºso101_followerçš„å®ä¾‹ï¼Œè¿™é‡Œä½¿ç”¨äº†å¤šæ€çš„ç‰¹æ€§ã€‚æ ¹æ®ä¼ å…¥çš„å‚æ•°--robot.port=/dev/ttyACM0 è¿æ¥åˆ°æœºå™¨äººä¸²å£ï¼Œåˆå§‹åŒ–é€šä¿¡åè®®ï¼ˆå¦‚ ROS æˆ–è‡ªå®šä¹‰ä¸²å£åè®®ï¼‰ã€‚æ ¹æ® --robot.cameras é…ç½®ä¸¤ä¸ª OpenCV æ‘„åƒå¤´ã€‚--robot.disable_torque_on_disconnect=true ç¡®ä¿ç¨‹åºé€€å‡ºæ—¶æœºå™¨äººæ–­ç”µï¼Œé¿å…ç¢°æ’é£é™©ã€‚</p>
<p><strong>é¥æ§æœºå™¨åˆå§‹åŒ–so101_leader</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">teleop</span> <span class="o">=</span> <span class="n">make_teleoperator_from_config</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">teleop</span><span class="p">)</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">teleop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<span class="n">teleop</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</code></pre></div>
<p>é¥æ§æœºå™¨åˆå§‹åŒ–æ˜¯å¯é€‰çš„ï¼Œå¦‚æœæŒ‡å®šäº†æ¨¡å‹å³æ˜¯éªŒè¯çš„æ–¹å¼ï¼Œé‚£ä¹ˆå°±ä¸ç”¨å¯åŠ¨é¥æ§æœºå™¨äº†ï¼Œåªæœ‰é‡‡é›†æ•°æ®çš„æ—¶å€™æ‰éœ€è¦é¥æ§æœºå™¨ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œé€šè¿‡make_robot_from_configæ ¹æ®ä¼ å…¥çš„robot.typeåˆ›å»ºä¸€ä¸ªæœºå™¨å®ä¾‹,è¿™é‡Œæ˜¯class SO101Follower(Robot)ã€‚å¦‚æœæ˜¯é‡‡é›†æ¨¡å¼è¿˜ä¼šåˆ›å»ºä¸€ä¸ªé¥æ§æœºå™¨äººå®ä¾‹ï¼Œé€šè¿‡make_teleoperator_from_configç”Ÿæˆå®ä¾‹class SO101Leader(Teleoperator)ã€‚</p>
<h2 id="_5">æ•°æ®é›†åˆ›å»º</h2>
<h3 id="_6">æ•°æ®ç‰¹å¾å®šä¹‰</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># åŠ¨ä½œç‰¹å¾-&gt;æ•°æ®é›†åŠ¨ä½œç‰¹å¾</span>
<span class="n">action_features</span> <span class="o">=</span> <span class="n">hw_to_dataset_features</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">action_features</span><span class="p">,</span> <span class="s2">"action"</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">video</span><span class="p">)</span>
<span class="c1"># è§‚æµ‹ç‰¹å¾-&gt;æ•°æ®é›†è§‚æµ‹ç‰¹å¾</span>
<span class="n">obs_features</span> <span class="o">=</span> <span class="n">hw_to_dataset_features</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">observation_features</span><span class="p">,</span> <span class="s2">"observation"</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">video</span><span class="p">)</span>
<span class="c1"># æ•´ä¸ªåŠ¨ä½œç‰¹å¾ã€è§‚æµ‹ç‰¹å¾</span>
<span class="n">dataset_features</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">action_features</span><span class="p">,</span> <span class="o">**</span><span class="n">obs_features</span><span class="p">}</span>

    <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Action Features:"</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">action_features</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Observation Features:"</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">obs_features</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Dataset Features:"</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">dataset_features</span><span class="p">)</span>
</code></pre></div>
<p>æ•°æ®åº”è¯¥é•¿ä»€ä¹ˆæ ·ï¼Ÿ è¿™æ€»çš„è¦æ ¼å¼è¦æ±‚å§ï¼Ÿ hw_to_dataset_featureså°±æ˜¯å°†æœºå™¨ç¡¬ä»¶ç‰¹å¾ï¼ˆç”µæœºä½ç½®ã€æ‘„åƒå¤´å›¾åƒï¼‰è½¬æ¢ä¸ºæ•°æ®é›†ç‰¹å¾æè¿°ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®è¦æŒ‰ç…§è¿™ä¸ªæ ¼å¼æ¥ã€‚æ ¼å¼åŒ…å«æ•°æ®ç±»å‹dtypeã€å½¢çŠ¶shapeç­‰ã€‚ä¸‹é¢æ ¹æ®ç›´æ¥æ‰“å°action_featuresã€obs_featuresã€dataset_featuresçš„æ‰“å°çš„ç»“æœæ¥åˆ†åˆ«åˆ†æã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="err">Ac</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="w"> </span><span class="err">Fea</span><span class="kc">tures</span><span class="p">:</span>
<span class="p">{</span>
<span class="w">    </span><span class="err">'ac</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="err">'d</span><span class="kc">t</span><span class="err">ype'</span><span class="p">:</span><span class="w"> </span><span class="err">'</span><span class="kc">fl</span><span class="err">oa</span><span class="kc">t</span><span class="mi">32</span><span class="err">'</span><span class="p">,</span>
<span class="w">            </span><span class="err">'shape'</span><span class="p">:</span><span class="w"> </span><span class="err">(</span><span class="mi">6</span><span class="p">,</span><span class="err">)</span><span class="p">,</span>
<span class="w">            </span><span class="err">'</span><span class="kc">na</span><span class="err">mes'</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">'shoulder_pa</span><span class="kc">n</span><span class="err">.pos'</span><span class="p">,</span>
<span class="w">                      </span><span class="err">'shoulder_li</span><span class="kc">ft</span><span class="err">.pos'</span><span class="p">,</span>
<span class="w">                      </span><span class="err">'elbow_</span><span class="kc">fle</span><span class="err">x.pos'</span><span class="p">,</span>
<span class="w">                      </span><span class="err">'wris</span><span class="kc">t</span><span class="err">_</span><span class="kc">fle</span><span class="err">x.pos'</span><span class="p">,</span>
<span class="w">                      </span><span class="err">'wris</span><span class="kc">t</span><span class="err">_roll.pos'</span><span class="p">,</span>
<span class="w">                      </span><span class="err">'gripper.pos'</span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="p">}</span>

<span class="err">Observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="w"> </span><span class="err">Fea</span><span class="kc">tures</span><span class="p">:</span>
<span class="p">{</span>
<span class="w">    </span><span class="err">'observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">.s</span><span class="kc">tate</span><span class="err">'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="err">æœºå™¨äººå…³èŠ‚çŠ¶æ€</span>
<span class="w">        </span><span class="err">'d</span><span class="kc">t</span><span class="err">ype'</span><span class="p">:</span><span class="w"> </span><span class="err">'</span><span class="kc">fl</span><span class="err">oa</span><span class="kc">t</span><span class="mi">32</span><span class="err">'</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="err">'shape'</span><span class="p">:</span><span class="w"> </span><span class="err">(</span><span class="mi">6</span><span class="p">,</span><span class="err">)</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="err">'</span><span class="kc">na</span><span class="err">mes'</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">'shoulder_pa</span><span class="kc">n</span><span class="err">.pos'</span><span class="p">,</span><span class="w"> </span><span class="err">...</span><span class="p">,</span><span class="w"> </span><span class="err">'gripper.pos'</span><span class="p">]</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="err">ä¸åŠ¨ä½œç‰¹å¾ç”µæœºåç§°ä¸€è‡´</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="err">'observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">.images.ha</span><span class="kc">n</span><span class="err">deye'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="err">æ‰‹çœ¼ç›¸æœºå›¾åƒ</span>
<span class="w">        </span><span class="err">'d</span><span class="kc">t</span><span class="err">ype'</span><span class="p">:</span><span class="w"> </span><span class="err">'video'</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="err">'shape'</span><span class="p">:</span><span class="w"> </span><span class="err">(</span><span class="mi">480</span><span class="p">,</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="err">)</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="err">'</span><span class="kc">na</span><span class="err">mes'</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">'heigh</span><span class="kc">t</span><span class="err">'</span><span class="p">,</span><span class="w"> </span><span class="err">'wid</span><span class="kc">t</span><span class="err">h'</span><span class="p">,</span><span class="w"> </span><span class="err">'cha</span><span class="kc">nnels</span><span class="err">'</span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="err">'observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">.images.</span><span class="kc">f</span><span class="err">ixed'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="err">å›ºå®šè§†è§’ç›¸æœºå›¾åƒ</span>
<span class="w">        </span><span class="err">'d</span><span class="kc">t</span><span class="err">ype'</span><span class="p">:</span><span class="w"> </span><span class="err">'video'</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="err">'shape'</span><span class="p">:</span><span class="w"> </span><span class="err">(</span><span class="mi">480</span><span class="p">,</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="err">)</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="err">'</span><span class="kc">na</span><span class="err">mes'</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">'heigh</span><span class="kc">t</span><span class="err">'</span><span class="p">,</span><span class="w"> </span><span class="err">'wid</span><span class="kc">t</span><span class="err">h'</span><span class="p">,</span><span class="w"> </span><span class="err">'cha</span><span class="kc">nnels</span><span class="err">'</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_7">åŠ¨ä½œä¸è§‚æµ‹ç‰¹å¾</h4>
<p>ç”Ÿæˆaction_featuresã€obs_featureséƒ½æ˜¯è°ƒç”¨hw_to_dataset_featureså‡½æ•°ï¼Œä¸‹é¢æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„å®ç°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å‡½æ•°å…¥å‚ä¸º3ä¸ª</span>
<span class="c1">#  -hw_features: dict[str, type | tuple] æœºå™¨ç¡¬ä»¶ç‰¹å¾å­—å…¸ï¼Œé”®ä¸ºç‰¹å¾åç§°å¦‚å…³èŠ‚åã€æ‘„åƒå¤´åï¼Œå€¼ä¸ºç‰¹å¾çš„ç±»å‹å¦‚floatæˆ–å›¾åƒå°ºå¯¸å…ƒç»„ï¼ˆheightï¼Œwidthï¼Œchannelsï¼‰ï¼Œæ³¨æ„è¿™é‡Œçš„typeæ˜¯ç±»å‹ä¸æ˜¯å®é™…çš„æ•°å€¼</span>
<span class="c1">#  -prefix: str ç‰¹å¾å‰ç¼€ï¼Œç”¨äºåŒºåˆ†æ•°æ®é›†ä¸åŒçš„éƒ¨åˆ†</span>
<span class="c1">#  -use_video: bool æ˜¯å¦å°†æ‘„åƒå¤´å›¾åƒç¼–ç ä¸ºè§†é¢‘</span>
<span class="k">def</span> <span class="nf">hw_to_dataset_features</span><span class="p">(</span>
    <span class="n">hw_features</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">],</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_video</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># 1.ç¡¬ä»¶ç‰¹å¾åˆ†ç±»ï¼Œå°†å…³èŠ‚ç‰¹å¾å’Œå›¾åƒç‰¹å¾åˆ†å‡ºæ¥</span>
    <span class="c1"># jointfsæ˜¯å…³é”®ç‰¹å¾ï¼Œé€šè¿‡forå¾ªç¯éå†hw_features.items()æ»¡è¶³ftypeä¸ºfloatã€‚ç„¶åå°†keyå’Œftypeé€šè¿‡æ–°çš„é”®å€¼å¯¹å­˜å‚¨åˆ°joint_fsä¸­ã€‚</span>
    <span class="c1">#ç¤ºä¾‹è¾“å‡ºï¼š{"shoulder_pan.pos": float, "shoulder_lift.pos": float, ..., "gripper.pos": float}ï¼ˆå…±6ä¸ªå…³èŠ‚ï¼‰ã€‚</span>
    <span class="n">joint_fts</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">ftype</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="n">hw_features</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">ftype</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">}</span>
    <span class="c1">#cam_fsæ˜¯æ‘„åƒå¤´çš„å›¾åƒç‰¹å¾ï¼Œå€¼ä¸º(height, width, channels)å…ƒç»„ã€‚</span>
    <span class="c1">#ç¤ºä¾‹è¾“å‡ºï¼š{"handeye": (480, 640, 3), "fixed": (480, 640, 3)}ï¼ˆä¸¤ä¸ªæ‘„åƒå¤´ï¼Œåˆ†è¾¨ç‡480Ã—640ï¼ŒRGBä¸‰é€šé“ï¼‰ã€‚</span>
    <span class="n">cam_fts</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">shape</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">hw_features</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)}</span>

    <span class="c1">#2. å…³èŠ‚ç‰¹å¾è½¬æ¢æ•°å€¼å‹</span>
    <span class="c1">#æ ¹æ®ä¼ å…¥çš„actionåŠ¨ä½œæŒ‡ä»¤ï¼Œæ„å»ºä¸€ä¸ªæ–°çš„é”®å€¼å¯¹ï¼Œé”®ä¸ºactionã€‚</span>
    <span class="k">if</span> <span class="n">joint_fts</span> <span class="ow">and</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s2">"action"</span><span class="p">:</span>
        <span class="n">features</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"dtype"</span><span class="p">:</span> <span class="s2">"float32"</span><span class="p">,</span> <span class="c1">#ç»Ÿä¸€æ•°å€¼ç±»å‹ä¸ºfloat32ï¼Œé€‚åˆæ¨¡å‹è®­ç»ƒ</span>
            <span class="s2">"shape"</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_fts</span><span class="p">),),</span><span class="c1">#å½¢çŠ¶å…³é”®æ•°é‡ï¼Œå¦‚6ä¸ªå…³é”®ï¼Œ(6,)</span>
            <span class="s2">"names"</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">joint_fts</span><span class="p">),</span><span class="c1">#å…³èŠ‚åç§°åˆ—è¡¨ï¼Œä¸æœºäººç”µæœºæ„ä¹‰å¯¹åº”</span>
        <span class="p">}</span>

    <span class="c1">#3. è§‚æµ‹è£…ç‰¹ç‰¹å¾ï¼Œä¸å‰é¢actionç»“æ„ç±»ä¼¼ï¼Œåªæ˜¯é”®å€¼ä¸ºobservation.state</span>
    <span class="k">if</span> <span class="n">joint_fts</span> <span class="ow">and</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s2">"observation"</span><span class="p">:</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">.state"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"dtype"</span><span class="p">:</span> <span class="s2">"float32"</span><span class="p">,</span>
            <span class="s2">"shape"</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_fts</span><span class="p">),),</span>
            <span class="s2">"names"</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">joint_fts</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="c1">#4. æ‘„åƒå¤´ç‰¹å¾è½¬æ¢ï¼Œä¸ºæ¯ä¸ªæ‘„åƒå¤´ç”Ÿæˆå›¾åƒ/è§†é¢‘å­˜å‚¨ç‰¹å¾</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">cam_fts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">.images.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"dtype"</span><span class="p">:</span> <span class="s2">"video"</span> <span class="k">if</span> <span class="n">use_video</span> <span class="k">else</span> <span class="s2">"image"</span><span class="p">,</span> <span class="c1">#å­˜å‚¨ç±»å‹ï¼šè§†é¢‘æˆ–å›¾åƒ</span>
            <span class="s2">"shape"</span><span class="p">:</span> <span class="n">shape</span><span class="p">,</span> <span class="c1">#å›¾åƒå°ºå¯¸(height, width, channels)</span>
            <span class="s2">"names"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"height"</span><span class="p">,</span> <span class="s2">"width"</span><span class="p">,</span> <span class="s2">"channels"</span><span class="p">],</span><span class="c1">#å½¢çŠ¶ç»´åº¦åç§°</span>
        <span class="p">}</span>

    <span class="n">_validate_feature_names</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span>
</code></pre></div>
<p>æ•°æ®é›†çš„åˆ›å»ºå…³é”®æ¥æºhw_features: dict[str, type | tuple]å‚æ•°ï¼Œè¯¥å€¼æ¥æºäºrobot.action_featuresã€robot.observation_featuresï¼Œæ ¹æ®å‚æ•°çš„å®ä¾‹åŒ–ä»¥SO101Followerå®ä¾‹ä¸ºä¾‹ã€‚</p>
<div class="codehilite"><pre><span></span><code>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_motors_ft</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">motor</span><span class="si">}</span><span class="s2">.pos"</span><span class="p">:</span> <span class="nb">float</span> <span class="k">for</span> <span class="n">motor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">motors</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_cameras_ft</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">cam</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cameras</span><span class="p">[</span><span class="n">cam</span><span class="p">]</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cameras</span><span class="p">[</span><span class="n">cam</span><span class="p">]</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">cam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cameras</span>
        <span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">observation_features</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_motors_ft</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_cameras_ft</span><span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">action_features</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motors_ft</span>
</code></pre></div>
<p><strong>ç”µæœºä½ç½®ç‰¹å¾ç»“æ„</strong>_motors_ftå®šä¹‰äº†ç”µæœºä½ç½®ç‰¹å¾ç»“æ„ï¼Œæè¿°å…³èŠ‚è¿åŠ¨çš„çŠ¶æ€ï¼Œå…¶æ¥æºäºself.bus.motorsç®¡ç†çš„ç”µæœºåˆ—è¡¨ï¼Œåœ¨<strong>Init</strong>ä¸­åˆå§‹åŒ–ï¼ŒåŒ…å«6ä¸ªå…³èŠ‚ç”µæœºï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">motors</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">"shoulder_pan"</span><span class="p">:</span> <span class="n">Motor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"sts3215"</span><span class="p">,</span> <span class="o">...</span><span class="p">),</span>  <span class="c1"># è‚©è½¬</span>
    <span class="s2">"shoulder_lift"</span><span class="p">:</span> <span class="n">Motor</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"sts3215"</span><span class="p">,</span> <span class="o">...</span><span class="p">),</span> <span class="c1"># è‚©æŠ¬</span>
    <span class="s2">"elbow_flex"</span><span class="p">:</span> <span class="n">Motor</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"sts3215"</span><span class="p">,</span> <span class="o">...</span><span class="p">),</span>   <span class="c1"># è‚˜å¼¯</span>
    <span class="s2">"wrist_flex"</span><span class="p">:</span> <span class="n">Motor</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">"sts3215"</span><span class="p">,</span> <span class="o">...</span><span class="p">),</span>   <span class="c1"># è…•å¼¯</span>
    <span class="s2">"wrist_roll"</span><span class="p">:</span> <span class="n">Motor</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">"sts3215"</span><span class="p">,</span> <span class="o">...</span><span class="p">),</span>   <span class="c1"># è…•è½¬</span>
    <span class="s2">"gripper"</span><span class="p">:</span> <span class="n">Motor</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s2">"sts3215"</span><span class="p">,</span> <span class="o">...</span><span class="p">),</span>      <span class="c1"># å¤¹çˆª</span>
<span class="p">}</span>
</code></pre></div>
<p>å…¶è¾“å‡ºæ ¼å¼è¿”å›å­—å…¸ {ç”µæœºå.pos: æ•°æ®ç±»å‹}ï¼Œä¾‹å¦‚ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
    <span class="s2">"shoulder_pan.pos"</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
    <span class="s2">"shoulder_lift.pos"</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
    <span class="o">...</span><span class="p">,</span> 
    <span class="s2">"gripper.pos"</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">}</span>
</code></pre></div>
<p>floatè¡¨ç¤ºç”µæœºä½ç½®æ˜¯æµ®ç‚¹æ•°å€¼ã€‚</p>
<p><strong>æ‘„åƒå¤´å›¾åƒç‰¹å¾</strong>å®šä¹‰æœºå™¨äººæ‘„åƒå¤´å›¾åƒç‰¹å¾çš„ç»“æ„ï¼Œç”¨äºæè¿°è§†è§‰ä¼ æ„Ÿå™¨æ•°æ®æ ¼å¼ã€‚æ¥æºself.cameras æ˜¯ç”± make_cameras_from_configs åˆ›å»ºçš„æ‘„åƒå¤´å®ä¾‹ï¼ˆå¦‚ handeyeã€fixed æ‘„åƒå¤´ï¼‰ï¼Œé…ç½®æ¥è‡ª self.config.camerasï¼ˆåŒ…å«åˆ†è¾¨ç‡ç­‰å‚æ•°ï¼‰ã€‚å…¶è¾“å‡ºæ ¼å¼ä¸ºè¿”å›å­—å…¸ {æ‘„åƒå¤´å: (é«˜åº¦, å®½åº¦, é€šé“æ•°)}ï¼Œä¾‹å¦‚ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
    <span class="s2">"handeye"</span><span class="p">:</span> <span class="p">(</span><span class="mi">480</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>  <span class="c1"># 480pxé«˜ã€640pxå®½ã€RGBä¸‰é€šé“</span>
    <span class="s2">"fixed"</span><span class="p">:</span> <span class="p">(</span><span class="mi">480</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>è§‚æµ‹ç‰¹å¾</strong>observation_featuresæ•´åˆäº†ç”µæœºä½ç½®å’Œæ‘„åƒå¤´å›¾åƒç‰¹å¾ï¼Œå®šä¹‰æœºå™¨äººå®Œæ•´å¯è§‚æµ‹è£…ç‰¹ï¼Œæä¾›æ•°æ®é›†å½•åˆ¶å’Œç­–ç•¥å†³ç­–ã€‚é€šè¿‡å­—å…¸è§£åŒ…ï¼ˆ**ï¼‰åˆå¹¶ _motors_ftï¼ˆç”µæœºä½ç½®ï¼‰å’Œ _cameras_ftï¼ˆæ‘„åƒå¤´å›¾åƒï¼‰ï¼Œè¾“å‡ºç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
    <span class="c1"># ç”µæœºä½ç½®ç‰¹å¾ï¼ˆæ¥è‡ª _motors_ftï¼‰</span>
    <span class="s2">"shoulder_pan.pos"</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
    <span class="s2">"shoulder_lift.pos"</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
    <span class="o">...</span><span class="p">,</span> 
    <span class="s2">"gripper.pos"</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
    <span class="c1"># æ‘„åƒå¤´å›¾åƒç‰¹å¾ï¼ˆæ¥è‡ª _cameras_ftï¼‰</span>
    <span class="s2">"handeye"</span><span class="p">:</span> <span class="p">(</span><span class="mi">480</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> 
    <span class="s2">"fixed"</span><span class="p">:</span> <span class="p">(</span><span class="mi">480</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>åŠ¨ä½œç‰¹å¾</strong>action_featureså®šä¹‰æœºå™¨äººçš„åŠ¨ä½œæŒ‡ä»¤æ ¼å¼ï¼Œå³é¥æ§æœºå™¨äººã€‚å…¶ç›´æ¥æœç”¨_motors_ftï¼Œè¯´æ˜åŠ¨ä½œæŒ‡ä»¤å°±æ˜¯ç”µæœºç›®æ ‡ä½ç½®ã€‚</p>
<h4 id="_8">æ•°æ®é›†ç‰¹å¾åˆå¹¶</h4>
<div class="codehilite"><pre><span></span><code><span class="n">dataset_features</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">action_features</span><span class="p">,</span> <span class="o">**</span><span class="n">obs_features</span><span class="p">}</span>
</code></pre></div>
<p>åˆå¹¶åŠ¨ä½œç‰¹å¾ä¸è§‚æµ‹ç‰¹å¾ï¼Œå½¢æˆæ•°æ®é›†å®Œæ•´å­˜å‚¨ç»“æ„ï¼Œç”¨äºåˆå§‹åŒ– LeRobotDatasetã€‚ç¡®ä¿æ¯ä¸ªæ—¶é—´æ­¥çš„è®°å½•åŒ…å«ã€Œè§‚æµ‹â†’åŠ¨ä½œã€çš„å®Œæ•´é…å¯¹ï¼Œæ»¡è¶³è®­ç»ƒéœ€æ±‚ï¼ˆå¦‚æ¨¡ä»¿å­¦ä¹ ä¸­ï¼Œè§‚æµ‹ä¸ºè¾“å…¥ï¼ŒåŠ¨ä½œä¸ºæ ‡ç­¾ï¼‰ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="err">Da</span><span class="kc">taset</span><span class="w"> </span><span class="err">Fea</span><span class="kc">tures</span><span class="p">:</span>
<span class="p">{</span>
<span class="w">    </span><span class="err">'ac</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">'d</span><span class="kc">t</span><span class="err">ype'</span><span class="p">:</span><span class="w"> </span><span class="err">'</span><span class="kc">fl</span><span class="err">oa</span><span class="kc">t</span><span class="mi">32</span><span class="err">'</span><span class="p">,</span>
<span class="w">        </span><span class="err">'shape'</span><span class="p">:</span><span class="w"> </span><span class="err">(</span><span class="mi">6</span><span class="p">,</span><span class="err">)</span><span class="p">,</span>
<span class="w">        </span><span class="err">'</span><span class="kc">na</span><span class="err">mes'</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="err">'shoulder_pa</span><span class="kc">n</span><span class="err">.pos'</span><span class="p">,</span>
<span class="w">            </span><span class="err">'shoulder_li</span><span class="kc">ft</span><span class="err">.pos'</span><span class="p">,</span>
<span class="w">            </span><span class="err">'elbow_</span><span class="kc">fle</span><span class="err">x.pos'</span><span class="p">,</span>
<span class="w">            </span><span class="err">'wris</span><span class="kc">t</span><span class="err">_</span><span class="kc">fle</span><span class="err">x.pos'</span><span class="p">,</span>
<span class="w">            </span><span class="err">'wris</span><span class="kc">t</span><span class="err">_roll.pos'</span><span class="p">,</span>
<span class="w">            </span><span class="err">'gripper.pos'</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="err">'observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">.s</span><span class="kc">tate</span><span class="err">'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">'d</span><span class="kc">t</span><span class="err">ype'</span><span class="p">:</span><span class="w"> </span><span class="err">'</span><span class="kc">fl</span><span class="err">oa</span><span class="kc">t</span><span class="mi">32</span><span class="err">'</span><span class="p">,</span>
<span class="w">        </span><span class="err">'shape'</span><span class="p">:</span><span class="w"> </span><span class="err">(</span><span class="mi">6</span><span class="p">,</span><span class="err">)</span><span class="p">,</span>
<span class="w">        </span><span class="err">'</span><span class="kc">na</span><span class="err">mes'</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="err">'shoulder_pa</span><span class="kc">n</span><span class="err">.pos'</span><span class="p">,</span>
<span class="w">            </span><span class="err">'shoulder_li</span><span class="kc">ft</span><span class="err">.pos'</span><span class="p">,</span>
<span class="w">            </span><span class="err">'elbow_</span><span class="kc">fle</span><span class="err">x.pos'</span><span class="p">,</span>
<span class="w">            </span><span class="err">'wris</span><span class="kc">t</span><span class="err">_</span><span class="kc">fle</span><span class="err">x.pos'</span><span class="p">,</span>
<span class="w">            </span><span class="err">'wris</span><span class="kc">t</span><span class="err">_roll.pos'</span><span class="p">,</span>
<span class="w">            </span><span class="err">'gripper.pos'</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="err">'observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">.images.ha</span><span class="kc">n</span><span class="err">deye'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">'d</span><span class="kc">t</span><span class="err">ype'</span><span class="p">:</span><span class="w"> </span><span class="err">'video'</span><span class="p">,</span>
<span class="w">        </span><span class="err">'shape'</span><span class="p">:</span><span class="w"> </span><span class="err">(</span><span class="mi">480</span><span class="p">,</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="err">)</span><span class="p">,</span>
<span class="w">        </span><span class="err">'</span><span class="kc">na</span><span class="err">mes'</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">'heigh</span><span class="kc">t</span><span class="err">'</span><span class="p">,</span><span class="w"> </span><span class="err">'wid</span><span class="kc">t</span><span class="err">h'</span><span class="p">,</span><span class="w"> </span><span class="err">'cha</span><span class="kc">nnels</span><span class="err">'</span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="err">'observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">.images.</span><span class="kc">f</span><span class="err">ixed'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">'d</span><span class="kc">t</span><span class="err">ype'</span><span class="p">:</span><span class="w"> </span><span class="err">'video'</span><span class="p">,</span>
<span class="w">        </span><span class="err">'shape'</span><span class="p">:</span><span class="w"> </span><span class="err">(</span><span class="mi">480</span><span class="p">,</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="err">)</span><span class="p">,</span>
<span class="w">        </span><span class="err">'</span><span class="kc">na</span><span class="err">mes'</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">'heigh</span><span class="kc">t</span><span class="err">'</span><span class="p">,</span><span class="w"> </span><span class="err">'wid</span><span class="kc">t</span><span class="err">h'</span><span class="p">,</span><span class="w"> </span><span class="err">'cha</span><span class="kc">nnels</span><span class="err">'</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>actionï¼šæ˜¯é¥æ§æ“ä½œæœºå™¨ï¼ˆå¦‚SO101Leaderï¼‰çš„å…³èŠ‚ä½ç½®æ•°æ®</li>
<li>observation.stateï¼šæœºå™¨äººï¼ˆå¦‚S0101Followerï¼‰å®æ—¶é‡‡é›†çš„å…³èŠ‚ä½ç½®æ•°æ®ã€‚</li>
<li>observation.images.xx:æœºå™¨äººå®æ—¶é‡‡é›†çš„å›¾åƒæ•°æ®ï¼Œå¯æœ‰å¤šä¸ªã€‚</li>
</ul>
<h3 id="_9">åˆ›å»ºæ•°æ®é›†</h3>
<p>åˆ›å»ºæ•°æ®é›†ï¼Œæ˜¯åˆ›å»ºä¸€ä¸ªç©ºçš„æ•°æ®é›†ã€‚ ä¼ å…¥çš„å‚æ•°æœ‰repo_idæ ‡è¯†äº†æ•°æ®é›†çš„ç›®å½•ï¼Œrootä¸ºæ•°æ®é›†çš„æ ¹ç›®å½•ç­‰ç­‰ï¼Œå…·ä½“å¦‚ä¸‹é˜è¿°ã€‚</p>
<div class="codehilite"><pre><span></span><code>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">LeRobotDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">repo_id</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span>
            <span class="n">root</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
            <span class="n">robot_type</span><span class="o">=</span><span class="n">robot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">dataset_features</span><span class="p">,</span>
            <span class="n">use_videos</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">video</span><span class="p">,</span>
            <span class="n">image_writer_processes</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_image_writer_processes</span><span class="p">,</span>
            <span class="n">image_writer_threads</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_image_writer_threads_per_camera</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">cameras</span><span class="p">),</span>
        <span class="p">)</span>
</code></pre></div>
<ul>
<li>cfg.dataset.repo_id: æ•°æ®é›†çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºæœ¬åœ°ç²—æ‰èƒ½è·¯å¾„æ ‡è¯†å’Œä¸Šä¼ hugging Face Hubä¸Šä¼ çš„ä»“åº“åç§°</li>
<li>cfg.dataset.fps:å½•åˆ¶å¸§ç‡ã€‚</li>
<li>root=cfg.dataset.root:æœ¬åœ°å­˜å‚¨çš„è·¯å¾„ï¼Œå¯ä»¥é€šè¿‡--dataset.rootæŒ‡å®šï¼Œå¦‚æœæ²¡æœ‰æä¾›ï¼Œåˆ™é»˜è®¤ä½¿ç”¨ç¼“å­˜ç›®å½•~/.cache/huggingface/</li>
<li>robot_type=robot.name:æœºå™¨çš„å”¯ä¸€æ ‡è¯†ï¼Œä¼šå†™å…¥åˆ°meta.jsonä¸­ã€‚</li>
<li>features=dataset_featuresï¼šæ ¸å¿ƒå‚æ•°ï¼Œæ•°æ®é›†ç‰¹å¾å®šä¹‰ï¼Œç”±ä¸Šä¸€ç« èŠ‚åˆå¹¶ç‰¹å¾ã€‚</li>
<li>use_videos=cfg.dataset.video: å›¾åƒçš„å­˜å‚¨æ ¼å¼ï¼Œtrueè¡¨ç¤ºä½¿ç”¨mpræ ¼å¼ã€‚Falseä¿ç•™ä¸ºPNGæ ¼å¼ï¼Œå ç”¨ç©ºé—´å¤§ã€‚å†…éƒ¨åœ¨å½•åˆ¶ç»“æŸåï¼Œé€šè¿‡encode_episode_videos è°ƒç”¨ ffmpeg å°† PNG åºåˆ—è½¬ä¸ºè§†é¢‘ï¼ˆå®šä¹‰äº lerobot_dataset.py).</li>
<li>image_writer_processes: å›¾åƒå†™å…¥çš„è¿›ç¨‹æ•°é‡ï¼Œé»˜è®¤0ï¼Œä»…ä½¿ç”¨çº¿ç¨‹å³ä¸€ä¸ªè¿›ç¨‹ã€‚</li>
<li>image_writer_threadsï¼šå›¾åƒå†™å…¥çš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤4çº¿ç¨‹/æ‘„åƒå¤´ Ã— Næ‘„åƒå¤´ã€‚</li>
</ul>
<h4 id="lerobotdatasetcreate">LeRobotDataset.create</h4>
<p>LeRobotDataset.createè¿”å›çš„æ˜¯ä¸€ä¸ªLeRobotDatasetå¯¹è±¡å®ä¾‹ã€‚</p>
<p>å…¸å‹çš„LeRobotDatasetæœ¬åœ°å­˜å‚¨ä¸ºï¼š</p>
<div class="codehilite"><pre><span></span><code>        <span class="o">.</span>
        <span class="err">â”œâ”€â”€</span> <span class="n">data</span>
        <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">chunk</span><span class="o">-</span><span class="mi">000</span>
        <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">episode_000000</span><span class="o">.</span><span class="n">parquet</span>
        <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">episode_000001</span><span class="o">.</span><span class="n">parquet</span>
        <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">episode_000002</span><span class="o">.</span><span class="n">parquet</span>
        <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="o">...</span>
        <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">chunk</span><span class="o">-</span><span class="mi">001</span>
        <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">episode_001000</span><span class="o">.</span><span class="n">parquet</span>
        <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">episode_001001</span><span class="o">.</span><span class="n">parquet</span>
        <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">episode_001002</span><span class="o">.</span><span class="n">parquet</span>
        <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="o">...</span>
        <span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="o">...</span>
        <span class="err">â”œâ”€â”€</span> <span class="n">meta</span>
        <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">episodes</span><span class="o">.</span><span class="n">jsonl</span>
        <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">info</span><span class="o">.</span><span class="n">json</span>
        <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">stats</span><span class="o">.</span><span class="n">json</span>
        <span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="n">tasks</span><span class="o">.</span><span class="n">jsonl</span>
        <span class="err">â””â”€â”€</span> <span class="n">videos</span>
            <span class="err">â”œâ”€â”€</span> <span class="n">chunk</span><span class="o">-</span><span class="mi">000</span>
            <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">observation</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">laptop</span>
            <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">episode_000000</span><span class="o">.</span><span class="n">mp4</span>
            <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">episode_000001</span><span class="o">.</span><span class="n">mp4</span>
            <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">episode_000002</span><span class="o">.</span><span class="n">mp4</span>
            <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="o">...</span>
            <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">observation</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">phone</span>
            <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">episode_000000</span><span class="o">.</span><span class="n">mp4</span>
            <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">episode_000001</span><span class="o">.</span><span class="n">mp4</span>
            <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">episode_000002</span><span class="o">.</span><span class="n">mp4</span>
            <span class="err">â”‚</span>   <span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="o">...</span>
            <span class="err">â”œâ”€â”€</span> <span class="n">chunk</span><span class="o">-</span><span class="mi">001</span>
            <span class="err">â””â”€â”€</span> <span class="o">...</span>
</code></pre></div>
<p><strong>æ ¸å¿ƒå±æ€§</strong></p>
<ul>
<li>metaï¼š LeRobotDatasetMetadataç±»ï¼Œå…ƒæ•°æ®ç®¡ç†å™¨ï¼Œå­˜å‚¨æ•°æ®é›†â€œè¯´æ˜ä¹¦â€ï¼šç‰¹å¾å®šä¹‰ï¼ˆåŠ¨ä½œ/è§‚æµ‹ç»´åº¦ï¼‰ã€å¸§ç‡ã€æœºå™¨äººç±»å‹ã€ä»»åŠ¡æè¿°ç­‰ã€‚</li>
<li>repo_id: strç±»å‹ï¼Œæ•°æ®é›†å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ lerobot/pick_cubeï¼‰ï¼Œç”¨äº Hugging Face Hub å®šä½å’Œæœ¬åœ°è·¯å¾„æ ‡è¯†ã€‚</li>
<li>root:Pathï¼Œæœ¬åœ°å­˜å‚¨æ ¹è·¯å¾„ï¼ˆé»˜è®¤ï¼š~/.cache/huggingface/lerobot/{repo_id}ï¼‰ï¼ŒåŒ…å« data/ï¼ˆParquetï¼‰ã€meta/ï¼ˆå…ƒæ•°æ®ï¼‰ã€videos/ï¼ˆè§†é¢‘ï¼‰ã€‚</li>
<li>revisionï¼š strç±»å‹ï¼Œè¡¨ç¤ºæ•°æ®é›†çš„ç‰ˆæœ¬ï¼Œé»˜è®¤ä»£ç åº“ç‰ˆæœ¬ä¸ºv2.1ã€‚</li>
<li>tolerance_sï¼šfloatç±»å‹ï¼Œæ—¶é—´æˆ³æ ¡éªŒå®¹å·®ï¼Œç¡®ä¿å½•åˆ¶è§†é¢‘å¸§ç‡ç¨³å®šæ€§ã€‚</li>
<li>hf_dataset: Hugging Face Dataset å¯¹è±¡ï¼Œå­˜å‚¨éå›¾åƒæ•°æ®ï¼ˆå…³èŠ‚ä½ç½®ã€æ—¶é—´æˆ³ç­‰ï¼‰ï¼Œä»¥ Parquet æ ¼å¼ã€‚</li>
<li>episode_data_indexï¼š dircç±»å‹ï¼Œepisode ç´¢å¼•æ˜ å°„è¡¨ï¼Œè®°å½•æ¯ä¸ª episode çš„èµ·å§‹/ç»“æŸå¸§ä½ç½®ï¼ˆå¦‚ {"from": [0, 300], "to": [299, 599]}ï¼‰ï¼ŒåŠ é€Ÿå¸§æ£€ç´¢ã€‚</li>
<li>delta_indicesï¼š dictç±»å‹ï¼Œæ—¶é—´æˆ³åç§»ç´¢å¼•ï¼ˆå¦‚ {"past": [-2, -1], "future": [1, 2]}ï¼‰ï¼Œç”¨äºå¤šæ¨¡æ€æ•°æ®åŒæ­¥ï¼ˆå¦‚åŠ¨ä½œä¸å›¾åƒå¯¹é½ï¼‰ã€‚</li>
<li>episode_bufferï¼š dictç±»å‹ï¼Œå†…å­˜ç¼“å†²åŒºï¼Œä¸´æ—¶å­˜å‚¨å½“å‰å½•åˆ¶çš„å¸§æ•°æ®ï¼ˆå¦‚ {"action": [], "observation.images.handeye": [], "timestamp": []}ï¼‰ã€‚</li>
<li>image_writer:AsyncImageWriter,å¼‚æ­¥å›¾åƒå†™å…¥å™¨ï¼ˆå¤šçº¿ç¨‹/å¤šè¿›ç¨‹ï¼‰ï¼Œé¿å…å›¾åƒå­˜å‚¨é˜»å¡ä¸»æ§åˆ¶å¾ªç¯ï¼ˆç¡®ä¿å½•åˆ¶å¸§ç‡ç¨³å®šï¼‰ã€‚</li>
<li>image_transforms:å›¾åƒé¢„å¤„ç†å‡½æ•°ï¼ˆå¦‚ torchvision.transforms.Resizeã€Normalizeï¼‰ï¼Œè®­ç»ƒæ—¶åŠ¨æ€åº”ç”¨äºæ‘„åƒå¤´å›¾åƒã€‚</li>
<li>video_backend: strç±»å‹ï¼Œè§†é¢‘è§£ç åç«¯ï¼ˆé»˜è®¤ torchcodec æˆ– pyavï¼‰ï¼Œæ”¯æŒä» MP4 ä¸­ç²¾å‡†æå–æŒ‡å®šæ—¶é—´æˆ³çš„å¸§ã€‚</li>
</ul>
<p><strong>æ ¸å¿ƒæ–¹æ³•</strong></p>
<ul>
<li><strong>init</strong>: æ•°æ®é›†åŠ è½½çš„å…¥å£ï¼Œæ ¹æ®æœ¬åœ°ç¼“å­˜çŠ¶æ€å®Œæˆå…ƒæ•°æ®æ ¡éªŒã€æ•°æ®ä¸‹è½½ï¼ˆè‹¥ç¼ºå¤±ï¼‰ å’Œæ—¶é—´æˆ³åŒæ­¥æ£€æŸ¥ï¼Œç¡®ä¿æ•°æ®é›†å¯ç”¨ã€‚</li>
<li>add_frame:é€å¸§æ·»åŠ æ•°æ®åˆ°ç¼“å†²åŒºï¼Œå½•åˆ¶æ—¶å°†å•å¸§æ•°æ®ï¼ˆåŠ¨ä½œã€è§‚æµ‹ã€å›¾åƒï¼‰æ·»åŠ åˆ° episode_bufferï¼Œå¹¶å¼‚æ­¥å†™å…¥å›¾åƒï¼ˆé¿å…é˜»å¡æ§åˆ¶å¾ªç¯ï¼‰ã€‚</li>
<li>save_episode:å†™å…¥åˆ°ç£ç›˜ï¼Œå½•åˆ¶å®Œæˆä¸€ä¸ª episode åï¼Œå°† episode_buffer ä¸­çš„æ•°æ®å†™å…¥ç£ç›˜ã€‚åŒ…æ‹¬éå›¾åƒæ•°æ®è½¬æ¢ä¸ºParquetæ–‡ä»¶å­˜å‚¨åˆ°xxx.parquetï¼Œå›¾åƒæ•°æ®ç¼–ç ä¸ºMP4å­˜å‚¨ï¼Œå…ƒæ•°æ®æ›´æ–°info.json,episodes.jsonlï¼Œepisodes_stats.jsonlã€‚</li>
<li><strong>getiterm</strong>ï¼šæ•°æ®çš„åŠ è½½ä¸è®­ç»ƒé€‚é…ï¼Œå®ç° torch.utils.data.Dataset æ¥å£ï¼Œæ”¯æŒé€šè¿‡ DataLoader åŠ è½½æ•°æ®ç”¨äºè®­ç»ƒã€‚</li>
<li>push_to_hubï¼šå°†æ•°æ®é›†ï¼ˆå…ƒæ•°æ®ã€Parquetã€è§†é¢‘ï¼‰ä¸Šä¼ è‡³ Hugging Face Hubï¼Œè‡ªåŠ¨ç”Ÿæˆæ•°æ®é›†å¡ç‰‡ï¼ˆREADME.mdï¼‰ï¼ŒåŒ…å«ç‰¹å¾è¯´æ˜ã€ç¡¬ä»¶å…¼å®¹æ€§å’Œç»Ÿè®¡ä¿¡æ¯</li>
<li>pull_from_repo:ä» Hub æ‹‰å–æŒ‡å®šç‰ˆæœ¬çš„æ•°æ®é›†ï¼Œæ”¯æŒæŒ‰ allow_patterns ç­›é€‰æ–‡ä»¶ï¼ˆå¦‚ä»…æ‹‰å–å…ƒæ•°æ® meta/ æˆ–ç‰¹å®š episodeï¼‰ã€‚</li>
<li>start_image_writer/stop_image_writer:ä¸ºé¿å…å›¾åƒå­˜å‚¨é˜»å¡å½•åˆ¶ä¸»å¾ªç¯ï¼ˆå¯¼è‡´å¸§ç‡æ³¢åŠ¨ï¼‰ï¼Œé€šè¿‡ AsyncImageWriter å¯åŠ¨å¤šçº¿ç¨‹/å¤šè¿›ç¨‹å†™å…¥å™¨ã€‚</li>
<li>create:æ•°æ®çš„æ–°å»ºæˆ–åŠ è½½ï¼Œæ˜¯åˆå§‹åŒ–çš„ç±»æ–¹æ³•ã€‚</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># æ•°æ®é›†æ ‡è¯†ï¼ˆç”¨æˆ·æŒ‡å®šï¼‰</span>
    <span class="n">fps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>  <span class="c1"># å¸§ç‡ï¼ˆé»˜è®¤ 30 FPSï¼‰</span>
    <span class="n">features</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>  <span class="c1"># ç‰¹å¾å®šä¹‰ï¼ˆåŠ¨ä½œ+è§‚æµ‹ï¼Œæ¥è‡ªæœºå™¨äººç¡¬ä»¶ï¼‰</span>
    <span class="n">root</span><span class="p">:</span> <span class="o">...</span><span class="p">,</span>  <span class="c1"># æœ¬åœ°è·¯å¾„</span>
    <span class="n">robot_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># æœºå™¨äººç±»å‹ï¼ˆå¦‚ "so101_follower"ï¼‰</span>
    <span class="n">use_videos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># æ˜¯å¦ç¼–ç è§†é¢‘ï¼ˆé»˜è®¤ Trueï¼‰</span>
    <span class="n">image_writer_processes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># å›¾åƒå†™å…¥è¿›ç¨‹æ•°</span>
    <span class="n">image_writer_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">cameras</span><span class="p">),</span>  <span class="c1"># å›¾åƒå†™å…¥çº¿ç¨‹æ•°</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"LeRobotDataset"</span><span class="p">:</span>
    <span class="c1"># 1. åˆå§‹åŒ–å…ƒæ•°æ®ï¼ˆè°ƒç”¨ LeRobotDatasetMetadata.createï¼‰</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">LeRobotDatasetMetadata</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">robot_type</span><span class="o">=</span><span class="n">robot_type</span><span class="p">,</span> <span class="n">use_videos</span><span class="o">=</span><span class="n">use_videos</span>
    <span class="p">)</span>
    <span class="c1"># 2. å¯åŠ¨å›¾åƒå†™å…¥å™¨ï¼ˆå¼‚æ­¥å†™å…¥ï¼‰</span>
    <span class="k">if</span> <span class="n">image_writer_processes</span> <span class="ow">or</span> <span class="n">image_writer_threads</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">start_image_writer</span><span class="p">(</span><span class="n">image_writer_processes</span><span class="p">,</span> <span class="n">image_writer_threads</span><span class="p">)</span>
    <span class="c1"># 3. åˆå§‹åŒ– episode ç¼“å†²åŒºï¼ˆå†…å­˜ä¸´æ—¶å­˜å‚¨ï¼‰</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">episode_buffer</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">create_episode_buffer</span><span class="p">()</span>
    <span class="c1"># 4. åˆ›å»ºç©º HF Datasetï¼ˆå­˜å‚¨éå›¾åƒæ•°æ®ï¼‰</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">hf_dataset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">create_hf_dataset</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">obj</span>
</code></pre></div>
<ul>
<li>å…ƒæ•°æ®é©±åŠ¨ï¼šé€šè¿‡ LeRobotDatasetMetadata.create ç¡®ä¿æ•°æ®é›†ç‰¹å¾ä¸æœºå™¨äººç¡¬ä»¶ä¸¥æ ¼å¯¹é½ï¼Œé¿å…å½•åˆ¶åå› ç‰¹å¾ä¸åŒ¹é…å¯¼è‡´è®­ç»ƒé”™è¯¯ã€‚</li>
<li>æ€§èƒ½ä¼˜åŒ–ï¼šå¼‚æ­¥å›¾åƒå†™å…¥å™¨ï¼ˆå¤šçº¿ç¨‹/å¤šè¿›ç¨‹ï¼‰è§£å†³äº†å½•åˆ¶æ—¶ I/O é˜»å¡é—®é¢˜ï¼Œä¿éšœå®æ—¶æ§åˆ¶å¾ªç¯çš„ç¨³å®šæ€§ã€‚</li>
<li>æ ‡å‡†åŒ–å­˜å‚¨ï¼šç»Ÿä¸€ Parquet+MP4 æ ¼å¼ï¼Œå…¼å®¹ Hugging Face Hub ç”Ÿæ€å’Œ PyTorch DataLoaderï¼Œç®€åŒ–â€œå½•åˆ¶-è®­ç»ƒâ€æµç¨‹ã€‚</li>
</ul>
<p>LeRobotDataset.create æ˜¯ä¸€ä¸ªç±»æ–¹æ³•ï¼Œé€šè¿‡ @classmethod è£…é¥°ï¼Œå…¶æ ¸å¿ƒç‰¹æ€§æ˜¯æ— éœ€å…ˆå®ä¾‹åŒ–LeRobotDataset ç±»å³å¯è°ƒç”¨ï¼Œç›´æ¥é€šè¿‡ç±»å LeRobotDataset.create(...) è§¦å‘ï¼Œå¹¶è¿”å›ä¸€ä¸ªåˆå§‹åŒ–å®Œæˆçš„ LeRobotDataset å®ä¾‹ï¼Œé€šå¸¸ç”¨äºå·¥å‚æ¨¡å¼æˆ–å•ä¾‹æ¨¡å¼çš„åœºæ™¯ã€‚</p>
<p>ç±»æ–¹æ³•ï¼ˆ@classmethodï¼‰çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ clsï¼ˆä»£è¡¨ç±»æœ¬èº«ï¼‰ï¼Œå› æ­¤å¯ä»¥ç›´æ¥é€šè¿‡ç±»åè§¦å‘ï¼Œè€Œéå®ä¾‹ã€‚LeRobotDataset.create çš„ä½œç”¨æ­£æ˜¯ç»•å¼€æ™®é€šæ„é€ å‡½æ•° <strong>init</strong>ï¼Œä¸ºæ–°å»ºæ•°æ®é›†æ‰§è¡Œç‰¹æ®Šåˆå§‹åŒ–é€»è¾‘ï¼ˆå¦‚å…ƒæ•°æ®åˆ›å»ºã€ç›®å½•ç»“æ„æ­å»ºã€å¼‚æ­¥å†™å…¥å™¨å¯åŠ¨ç­‰ï¼‰ï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ªå®Œæ•´çš„ LeRobotDataset å®ä¾‹ã€‚</p>
<h4 id="lerobotdatasetmetadatacreate">LeRobotDatasetMetadata.create</h4>
<p>åœ¨LeRobotDatasetä¸­ä¼šè°ƒç”¨åˆ°obj.meta = LeRobotDatasetMetadata.createåˆ›å»ºä¸€ä¸ªLeRobotDatasetMetadataå¯¹è±¡ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯ä¸ºå…¨æ–°æ•°æ®é›†åˆå§‹åŒ–å…ƒæ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬ç›®å½•åˆ›å»ºã€ç‰¹å¾å®šä¹‰åˆå¹¶ã€å…ƒæ•°æ®æ–‡ä»¶ç”Ÿæˆï¼ˆå¦‚ meta/info.jsonï¼‰å’Œç¡¬ä»¶å…¼å®¹æ€§æ ¡éªŒï¼Œç¡®ä¿åç»­æœºå™¨äººæ•°æ®å½•åˆ¶ï¼ˆå…³èŠ‚çŠ¶æ€ã€æ‘„åƒå¤´å›¾åƒç­‰ï¼‰ä¸å­˜å‚¨æ ¼å¼ä¸¥æ ¼å¯¹é½ã€‚</p>
<div class="codehilite"><pre><span></span><code>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">fps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">features</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">robot_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_videos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"LeRobotDatasetMetadata"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Creates metadata for a LeRobotDataset."""</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="c1">#åˆ›å»ºç©ºçš„ LeRobotDatasetMetadata å®ä¾‹ï¼ˆä¸è§¦å‘ __init__ï¼Œé¿å…åŠ è½½ç°æœ‰å…ƒæ•°æ®ï¼‰</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">repo_id</span> <span class="o">=</span> <span class="n">repo_id</span>
        <span class="c1"># æ•°æ®é›†æ ‡è¯†ï¼ˆå¦‚ "username/pick_cube"ï¼‰</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">HF_LEROBOT_HOME</span> <span class="o">/</span> <span class="n">repo_id</span>
        <span class="c1"># æœ¬åœ°è·¯å¾„ï¼ˆé»˜è®¤ç¼“å­˜ç›®å½•ï¼‰</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># TODO(aliberts, rcadene): implement sanity check for features</span>
        <span class="c1"># åˆå¹¶ç”¨æˆ·æä¾›çš„ç‰¹å¾ä¸é»˜è®¤ç‰¹å¾ï¼ˆè¡¥å……å¿…é€‰å­—æ®µï¼‰</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">features</span><span class="p">,</span> <span class="o">**</span><span class="n">DEFAULT_FEATURES</span><span class="p">}</span>
        <span class="n">_validate_feature_names</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="c1"># æ ¡éªŒç‰¹å¾åç§°åˆæ³•æ€§ï¼ˆå¦‚ç¦æ­¢å«ç©ºæ ¼ã€ç‰¹æ®Šå­—ç¬¦ï¼Œç¡®ä¿ä¸ç¡¬ä»¶æ¥å£ä¸€è‡´ï¼‰</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">task_to_task_index</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="c1"># ä»»åŠ¡åˆ—è¡¨ï¼ˆå¦‚ {"pick": 0, "place": 1}ï¼‰åŠç´¢å¼•æ˜ å°„</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">episodes_stats</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">episodes</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="c1"># åˆå§‹åŒ– episode ç»Ÿè®¡ä¿¡æ¯ã€å…¨å±€ç»Ÿè®¡ã€episode åˆ—è¡¨</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">create_empty_dataset_info</span><span class="p">(</span><span class="n">CODEBASE_VERSION</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">use_videos</span><span class="p">,</span> <span class="n">robot_type</span><span class="p">)</span>
     <span class="c1">#ç”Ÿæˆæ•°æ®é›†çš„â€œæ€»è¯´æ˜ä¹¦â€ï¼ˆmeta/info.jsonï¼‰ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®ä¿¡æ¯</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">video_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_videos</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
        <span class="n">write_json</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="n">INFO_PATH</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">revision</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">obj</span>
</code></pre></div>
<p>LeRobotDatasetMetadata.create æ˜¯æ–°å»ºæ•°æ®é›†çš„â€œå…ƒæ•°æ®åŸºçŸ³â€ï¼Œé€šè¿‡æ ‡å‡†åŒ–ç›®å½•ç»“æ„ã€ç‰¹å¾å®šä¹‰å’Œå…¼å®¹æ€§æ ¡éªŒï¼Œç¡®ä¿æœºå™¨äººå½•åˆ¶æ•°æ®ï¼ˆåŠ¨ä½œã€å›¾åƒã€çŠ¶æ€ï¼‰çš„å­˜å‚¨æ ¼å¼ä¸ç¡¬ä»¶ç‰¹å¾ä¸¥æ ¼å¯¹é½ã€‚å…¶è¾“å‡ºçš„ LeRobotDatasetMetadata å®ä¾‹æ˜¯è¿æ¥æœºå™¨äººç¡¬ä»¶ä¸æ•°æ®é›†æ–‡ä»¶ç³»ç»Ÿçš„æ ¸å¿ƒæ¡¥æ¢ï¼Œä¸ºåç»­æ•°æ®å½•åˆ¶ã€ç¼–ç å’Œè®­ç»ƒåŠ è½½æä¾›ç»Ÿä¸€çš„å…ƒä¿¡æ¯æè¿°ã€‚</p>
<h3 id="_10">åŠ è½½æ•°æ®é›†</h3>
<p>åŠ è½½æ•°æ®é›†æ˜¯åŠ è½½å·²ç»å­˜åœ¨çš„æ•°æ®é›†ï¼Œé’ˆå¯¹çš„åœºæ™¯æ˜¯é’ˆå¯¹æ­¤å‰çš„å½•åˆ¶åœºæ™¯æ¥ç€å½•åˆ¶ï¼Œä¸åˆ›å»ºæ•°æ®é›†ä¸åŒï¼Œåˆ›å»ºæ•°æ®é›†æ˜¯ä»å¤´å¼€å§‹ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„æ•°æ®é›†ã€‚é‚£ä¹ˆlerobotæ€ä¹ˆè¿›è¡Œæ¢å¤äº†ï¼Ÿ</p>
<p>å‰é¢ç« èŠ‚æ— è®ºæ˜¯LeRobotDataset.create è¿˜æ˜¯LeRobotDatasetMetadata.createéƒ½ä¼šç»•è¿‡ç±»çš„æ„é€ å‡½æ•°xxx.<strong>init</strong>çš„è¿è¡Œï¼Œé‚£ä¹ˆxxx.<strong>init</strong>åœ¨å“ªé‡Œè¿è¡Œäº†ï¼Ÿ</p>
<p>LeRobotDataset.<strong>init</strong> æ˜¯ç±»çš„é»˜è®¤æ„é€ å‡½æ•°ï¼Œä»…åœ¨ç›´æ¥å®ä¾‹åŒ– LeRobotDataset æ—¶è°ƒç”¨ï¼Œæ ¸å¿ƒåœºæ™¯æ˜¯ æ¢å¤å·²æœ‰æ•°æ®é›†çš„å½•åˆ¶æˆ–åŠ è½½ã€‚è€Œ LeRobotDataset.create æ˜¯ç±»æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºå…¨æ–°æ•°æ®é›†ï¼ŒäºŒè€…åˆ†å·¥æ˜ç¡®ï¼Œå¯¹åº”ä¸åŒçš„ç”¨æˆ·éœ€æ±‚ã€‚æ¥ä¸‹æ¥é’ˆå¯¹æ¢å¤çš„åœºæ™¯æ¥è¯´æ˜ã€‚</p>
<p>å½“è¾“å…¥å‚æ•°--resume=trueï¼Œå³åœ¨åŸæ¥çš„æ•°æ®é›†åŸºç¡€ä¸Šè¿›è¡Œã€‚</p>
<div class="codehilite"><pre><span></span><code>   <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>
       <span class="c1">#èµ°æ¢å¤æ¨¡å¼</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">LeRobotDataset</span><span class="p">(</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">repo_id</span><span class="p">,</span><span class="c1"># æ•°æ®é›†æ ‡è¯†ï¼ˆå¦‚ "lerobot/pick_cube"ï¼‰</span>
            <span class="n">root</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="c1"># æœ¬åœ°å­˜å‚¨è·¯å¾„ï¼ˆé»˜è®¤ï¼š~/.cache/huggingface/lerobot/{repo_id}ï¼‰</span>
<span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="s2">"cameras"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">cameras</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">start_image_writer</span><span class="p">(</span>
                <span class="n">num_processes</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_image_writer_processes</span><span class="p">,</span>
                <span class="n">num_threads</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_image_writer_threads_per_camera</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">cameras</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="n">sanity_check_dataset_robot_compatibility</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span> <span class="n">dataset_features</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">LeRobotDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">......</span><span class="p">)</span>
</code></pre></div>
<p>å…³é”®æµç¨‹æ˜¯å®ä¾‹åŒ–LeRobotDatasetï¼Œè§¦å‘LeRobotDataset.<strong>init</strong> æ–¹æ³•ï¼ŒLeRobotDatasetç±»çš„åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ã€‚</p>
<h4 id="lerobotdatasetinit">LeRobotDataset.<strong>init</strong></h4>
<div class="codehilite"><pre><span></span><code><span class="n">LeRobotDataset</span><span class="err">ï¼š</span>

<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># æ•°æ®é›†æ ‡è¯†ï¼ˆå¦‚ "lerobot/pick_cube"ï¼‰</span>
    <span class="n">root</span><span class="p">:</span> <span class="o">...</span><span class="p">,</span>  <span class="c1"># æœ¬åœ°å­˜å‚¨è·¯å¾„ï¼ˆé»˜è®¤ï¼š~/.cache/huggingface/lerobot/{repo_id}ï¼‰</span>
    <span class="n">episodes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æŒ‡å®šåŠ è½½çš„ episode ç´¢å¼•ï¼ˆå¦‚ [0, 2, 5]ï¼‰</span>
    <span class="n">image_transforms</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># å›¾åƒé¢„å¤„ç†ï¼ˆå¦‚ Resizeã€Normalizeï¼‰</span>
    <span class="n">delta_timestamps</span><span class="p">:</span> <span class="o">...</span><span class="p">,</span>  <span class="c1"># æ—¶é—´æˆ³åç§»ï¼ˆç”¨äºå¤šæ¨¡æ€æ•°æ®åŒæ­¥ï¼‰</span>
    <span class="n">tolerance_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>  <span class="c1"># æ—¶é—´æˆ³æ ¡éªŒå®¹å·®ï¼ˆç¡®ä¿å¸§ç‡ç¨³å®šæ€§ï¼‰</span>
    <span class="n">revision</span><span class="p">:</span> <span class="o">...</span><span class="p">,</span>  <span class="c1"># æ•°æ®é›†ç‰ˆæœ¬ï¼ˆé»˜è®¤ä»£ç åº“ç‰ˆæœ¬ v2.1ï¼‰</span>
    <span class="n">force_cache_sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># å¼ºåˆ¶åŒæ­¥ç¼“å­˜ï¼ˆå¿½ç•¥æœ¬åœ°æ–‡ä»¶ï¼Œé‡æ–°æ‹‰å–ï¼‰</span>
    <span class="n">download_videos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># æ˜¯å¦ä¸‹è½½è§†é¢‘æ–‡ä»¶</span>
    <span class="n">video_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># è§†é¢‘è§£ç åç«¯ï¼ˆå¦‚ "pyav"ã€"torchcodec"ï¼‰</span>
<span class="p">):</span>
    <span class="c1"># 1. åˆå§‹åŒ–åŸºç¡€è·¯å¾„ä¸é…ç½®</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span> <span class="o">=</span> <span class="n">repo_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="ow">or</span> <span class="n">HF_LEROBOT_HOME</span> <span class="o">/</span> <span class="n">repo_id</span>  <span class="c1"># æœ¬åœ°è·¯å¾„</span>
    <span class="c1">#æ²¡æœ‰åˆ›å»ºçš„è¯é»˜è®¤å°±æ˜¯~/.cache/huggingface/lerobot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># åˆ›å»ºç›®å½•ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰</span>

    <span class="c1"># 2. åŠ è½½å…ƒæ•°æ®ï¼ˆé€šè¿‡ LeRobotDatasetMetadataï¼‰</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">LeRobotDatasetMetadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">revision</span><span class="p">,</span> <span class="n">force_cache_sync</span><span class="o">=</span><span class="n">force_cache_sync</span>
    <span class="p">)</span>

    <span class="c1"># 3. åŠ è½½å®é™…æ•°æ®ï¼ˆä¼˜å…ˆæœ¬åœ°ç¼“å­˜ï¼Œç¼ºå¤±åˆ™ä» Hub ä¸‹è½½ï¼‰</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">force_cache_sync</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span>  <span class="c1"># å¼ºåˆ¶åŒæ­¥æ—¶è·³è¿‡æœ¬åœ°ç¼“å­˜</span>
        <span class="c1"># éªŒè¯æœ¬åœ°æ•°æ®æ–‡ä»¶å®Œæ•´æ€§</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="n">fpath</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="k">for</span> <span class="n">fpath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_episodes_file_paths</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hf_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_hf_dataset</span><span class="p">()</span>  <span class="c1"># åŠ è½½ Parquet æ ¼å¼æ•°æ®ï¼ˆéå›¾åƒï¼‰</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
        <span class="c1"># ä» Hub ä¸‹è½½æ•°æ®ï¼ˆå« Parquet å’Œè§†é¢‘æ–‡ä»¶ï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision</span> <span class="o">=</span> <span class="n">get_safe_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">revision</span><span class="p">)</span>  <span class="c1"># æ ¡éªŒç‰ˆæœ¬åˆæ³•æ€§</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_episodes</span><span class="p">(</span><span class="n">download_videos</span><span class="p">)</span>  <span class="c1"># ä¸‹è½½æŒ‡å®š episode æ•°æ®</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hf_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_hf_dataset</span><span class="p">()</span>  <span class="c1"># é‡æ–°åŠ è½½æ•°æ®</span>

    <span class="c1"># 4. æ•°æ®æ ¡éªŒï¼ˆç¡®ä¿æ—¶é—´æˆ³ä¸å¸§ç‡åŒ¹é…ï¼‰</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hf_dataset</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">]))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">episode_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hf_dataset</span><span class="p">[</span><span class="s2">"episode_index"</span><span class="p">]))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">check_timestamps_sync</span><span class="p">(</span>  <span class="c1"># æ ¡éªŒæ¯å¸§æ—¶é—´é—´éš”æ˜¯å¦ä¸º 1/fps Â± tolerance_s</span>
        <span class="n">timestamps</span><span class="p">,</span> <span class="n">episode_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_data_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance_s</span>
    <span class="p">)</span>
</code></pre></div>
<p>LeRobotDataset ç±»çš„æ„é€ å‡½æ•°ï¼ˆ<strong>init</strong> æ–¹æ³•ï¼‰ï¼Œå…¶æ ¸å¿ƒä½œç”¨æ˜¯åŠ è½½å·²å­˜åœ¨çš„æœºå™¨äººæ•°æ®é›†ï¼ˆæœ¬åœ°æˆ– Hugging Face Hubï¼‰ï¼Œå¹¶å®Œæˆå…ƒæ•°æ®æ ¡éªŒã€æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ã€æ—¶é—´æˆ³åŒæ­¥ç­‰å…³é”®æ­¥éª¤ï¼Œä¸ºåç»­æ•°æ®è®¿é—®ï¼ˆå¦‚è®­ç»ƒã€å¯è§†åŒ–ï¼‰æä¾›ç»Ÿä¸€æ¥å£ã€‚è¯¥æ–¹æ³•æ˜¯ LeRobotDataset ç±»çš„â€œå…¥å£â€ï¼Œä»…åœ¨æ¢å¤å·²æœ‰æ•°æ®é›†æˆ–åŠ è½½æ•°æ®é›†ç”¨äºè®­ç»ƒæ—¶è°ƒç”¨ã€‚</p>
<p>LeRobotDataset æ˜¯åŸºäº PyTorch Dataset çš„å­ç±»ï¼Œä¸“ä¸ºæœºå™¨äººæ•°æ®è®¾è®¡ï¼Œæ”¯æŒä¸¤ç§åœºæ™¯ï¼š</p>
<ul>
<li>åŠ è½½æœ¬åœ°å·²æœ‰æ•°æ®é›†ï¼šä»æŒ‡å®šè·¯å¾„ï¼ˆrootï¼‰ç›´æ¥è¯»å–å…ƒæ•°æ®å’Œæ•°æ®æ–‡ä»¶ã€‚</li>
<li>ä» Hugging Face Hub ä¸‹è½½æ•°æ®é›†ï¼šè‹¥æœ¬åœ°æ•°æ®ç¼ºå¤±ï¼Œè‡ªåŠ¨ä» Hub æ‹‰å–å¹¶åŠ è½½ã€‚</li>
</ul>
<p>æ— è®ºå“ªç§åœºæ™¯ï¼Œ<strong>init</strong> å‡ç¡®ä¿æ•°æ®é›†çš„å…ƒæ•°æ®ä¸€è‡´æ€§ï¼ˆå¦‚æœºå™¨äººç±»å‹ã€å¸§ç‡ï¼‰ã€æ•°æ®å®Œæ•´æ€§ï¼ˆæ–‡ä»¶ä¸ç¼ºå¤±ï¼‰å’Œæ—¶é—´æˆ³æœ‰æ•ˆæ€§ï¼ˆç¬¦åˆå½•åˆ¶å¸§ç‡ï¼‰ï¼Œä¸ºä¸‹æ¸¸ä»»åŠ¡ï¼ˆå¦‚ç­–ç•¥è®­ç»ƒï¼‰æä¾›å¯é æ•°æ®ã€‚</p>
<h4 id="lerobotdatasetmetadatainit">LeRobotDatasetMetadata.<strong>init</strong></h4>
<p>åœ¨LeRobotDataset.<strong>init</strong>ä¸­å®ä¾‹åŒ–äº†self.meta = LeRobotDatasetMetadataï¼Œè¯¥ç±»åˆ›å»ºæ—¶ä¼šè°ƒç”¨æ„é€ å‡½æ•°LeRobotDatasetMetadata.<strong>init</strong>ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">lass</span> <span class="n">LeRobotDatasetMetadata</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">revision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">force_cache_sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span> <span class="o">=</span> <span class="n">repo_id</span> <span class="c1"># æ•°æ®é›†å”¯ä¸€æ ‡è¯†</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision</span> <span class="o">=</span> <span class="n">revision</span> <span class="k">if</span> <span class="n">revision</span> <span class="k">else</span> <span class="n">CODEBASE_VERSION</span>
        <span class="c1"># ç‰ˆæœ¬ï¼ˆé»˜è®¤ä»£ç åº“ç‰ˆæœ¬ï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">HF_LEROBOT_HOME</span> <span class="o">/</span> <span class="n">repo_id</span>
        <span class="c1">#æœ¬åœ°è·¯å¾„ï¼ˆé»˜è®¤ç¼“å­˜ç›®å½•ï¼‰</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force_cache_sync</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_metadata</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">NotADirectoryError</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_valid_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">revision</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">revision</span> <span class="o">=</span> <span class="n">get_safe_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">revision</span><span class="p">)</span>

            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="s2">"meta"</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pull_from_repo</span><span class="p">(</span><span class="n">allow_patterns</span><span class="o">=</span><span class="s2">"meta/"</span><span class="p">)</span>
            <span class="c1"># åŠ è½½æœ¬åœ°å…ƒæ•°æ®</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_metadata</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">load_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="n">check_version_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span><span class="p">,</span> <span class="n">CODEBASE_VERSION</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_to_task_index</span> <span class="o">=</span> <span class="n">load_tasks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">episodes</span> <span class="o">=</span> <span class="n">load_episodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&lt;</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">"v2.1"</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">load_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">episodes_stats</span> <span class="o">=</span> <span class="n">backward_compatible_episodes_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">episodes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">episodes_stats</span> <span class="o">=</span> <span class="n">load_episodes_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">aggregate_stats</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episodes_stats</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">load_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">load_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="n">check_version_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span><span class="p">,</span> <span class="n">CODEBASE_VERSION</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_to_task_index</span> <span class="o">=</span> <span class="n">load_tasks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">episodes</span> <span class="o">=</span> <span class="n">load_episodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&lt;</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">"v2.1"</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">load_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">episodes_stats</span> <span class="o">=</span> <span class="n">backward_compatible_episodes_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">episodes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">episodes_stats</span> <span class="o">=</span> <span class="n">load_episodes_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">aggregate_stats</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episodes_stats</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</code></pre></div>
<p>ä» self.root/meta ç›®å½•åŠ è½½æ ¸å¿ƒå…ƒæ•°æ®æ–‡ä»¶ï¼ˆinfo.jsonã€tasks.jsonlã€episodes.jsonl ç­‰ï¼‰ï¼Œå¹¶æ ¡éªŒå…ƒæ•°æ®ç‰ˆæœ¬ä¸å½“å‰ä»£ç åº“å…¼å®¹æ€§ï¼ˆcheck_version_compatibilityï¼‰</p>
<h2 id="_11">å½•åˆ¶æµç¨‹</h2>
<div class="codehilite"><pre><span></span><code>    <span class="n">policy</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">policy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">make_policy</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">policy</span><span class="p">,</span> <span class="n">ds_meta</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>
    <span class="c1">#å¦‚æœæ˜¯èƒ½äº†ç­–ç•¥æ¨¡å‹ï¼Œè¿›è¡Œå®ä¾‹åˆ›å»º</span>
    <span class="n">listener</span><span class="p">,</span> <span class="n">events</span> <span class="o">=</span> <span class="n">init_keyboard_listener</span><span class="p">()</span>
    <span class="c1">#åˆå§‹åŒ–ç›‘å¬é”®ç›˜äº‹ä»¶</span>
</code></pre></div>
<p>å…ˆåˆ¤æ–­æ˜¯å¦æŒ‡å®šäº†ç­–ç•¥æ¨¡å‹ï¼Œå¦‚æœæŒ‡å®šäº†è¿›è¡Œåˆ›å»ºå®ä¾‹ã€‚åŒæ—¶åˆå§‹åŒ–é”®ç›˜ç›‘å¬å™¨</p>
<div class="codehilite"><pre><span></span><code><span class="n">recorded_episodes</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="n">recorded_episodes</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_episodes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">events</span><span class="p">[</span><span class="s2">"stop_recording"</span><span class="p">]:</span>
    <span class="c1"># å½•åˆ¶å½“å‰å›åˆæ•°æ®</span>
    <span class="n">log_say</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Recording episode </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_episodes</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">play_sounds</span><span class="p">)</span>  <span class="c1"># è¯­éŸ³æç¤ºå¼€å§‹å½•åˆ¶</span>
    <span class="n">record_loop</span><span class="p">(</span>  <span class="c1"># æ ¸å¿ƒæ•°æ®é‡‡é›†å‡½æ•°</span>
        <span class="n">robot</span><span class="o">=</span><span class="n">robot</span><span class="p">,</span>
        <span class="n">teleop</span><span class="o">=</span><span class="n">teleop</span><span class="p">,</span>  <span class="c1"># é¥æ“ä½œå™¨è¾“å…¥ï¼ˆæˆ–ç­–ç•¥ç”ŸæˆåŠ¨ä½œï¼‰</span>
        <span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">,</span>
        <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>  <span class="c1"># æ•°æ®å†™å…¥ç›®æ ‡</span>
        <span class="n">control_time_s</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">episode_time_s</span><span class="p">,</span>  <span class="c1"># å•å›åˆå½•åˆ¶æ—¶é•¿ï¼ˆé»˜è®¤60ç§’ï¼‰</span>
        <span class="n">display_data</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">display_data</span><span class="p">,</span>  <span class="c1"># å®æ—¶å¯è§†åŒ–</span>
    <span class="p">)</span>

    <span class="c1"># å›åˆé—´ç¯å¢ƒé‡ç½®ï¼ˆç»™ç”¨æˆ·è°ƒæ•´ç‰©ä½“ä½ç½®çš„æ—¶é—´ï¼‰</span>
    <span class="c1"># è¯¥é˜¶æ®µä¸å†™å…¥æ•°æ®ï¼Œç”¨äºç”¨æˆ·é‡ç½®ç¯å¢ƒã€‚</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">[</span><span class="s2">"stop_recording"</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="n">log_say</span><span class="p">(</span><span class="s2">"Reset the environment"</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">play_sounds</span><span class="p">)</span>
        <span class="n">record_loop</span><span class="p">(</span>  <span class="c1"># é‡ç½®é˜¶æ®µä¸è®°å½•æ•°æ®ï¼ˆdataset=Noneï¼‰</span>
            <span class="n">robot</span><span class="o">=</span><span class="n">robot</span><span class="p">,</span>
            <span class="n">teleop</span><span class="o">=</span><span class="n">teleop</span><span class="p">,</span>
            <span class="n">control_time_s</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">reset_time_s</span><span class="p">,</span>  <span class="c1"># é‡ç½®æ—¶é•¿ï¼ˆç”¨æˆ·æŒ‡å®š5ç§’ï¼‰</span>
            <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># ç¦ç”¨æ•°æ®å†™å…¥</span>
        <span class="p">)</span>

    <span class="c1"># å¤„ç†é‡å½•äº‹ä»¶ï¼ˆç”¨æˆ·æŒ‰ 'r' è§¦å‘ï¼‰</span>
    <span class="k">if</span> <span class="n">events</span><span class="p">[</span><span class="s2">"rerecord_episode"</span><span class="p">]:</span>
        <span class="n">log_say</span><span class="p">(</span><span class="s2">"Re-record episode"</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">play_sounds</span><span class="p">)</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">clear_episode_buffer</span><span class="p">()</span>  <span class="c1"># æ¸…ç©ºå½“å‰å›åˆæ— æ•ˆæ•°æ®</span>
        <span class="k">continue</span>  <span class="c1"># é‡æ–°å½•åˆ¶å½“å‰å›åˆ</span>

    <span class="n">dataset</span><span class="o">.</span><span class="n">save_episode</span><span class="p">()</span>  <span class="c1"># ä¿å­˜å½“å‰å›åˆæ•°æ®åˆ°ç£ç›˜ï¼ˆå›¾åƒã€çŠ¶æ€ã€åŠ¨ä½œï¼‰</span>
    <span class="n">recorded_episodes</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># å›åˆè®¡æ•°+1</span>
</code></pre></div>
<p>æ ¸å¿ƒæ˜¯è°ƒç”¨record_loopè¿›è¡Œé‡‡é›†å½•åˆ¶ï¼Œè¿‡ç¨‹ä¸­ç›‘å¬ç”¨æˆ·è¾“å…¥çš„é”®ç›˜å€¼å¤„ç†ç›¸å…³é€»è¾‘å¦‚å³é”®ç»“æŸå•æ¬¡å½•åˆ¶ï¼Œå·¦é”®é‡å¤å½•åˆ¶ï¼ŒESCé€€å‡ºæµç¨‹ã€‚</p>
<p>å½“å‰å›åˆå½•åˆ¶ç»“æŸåï¼Œç»§ç»­è°ƒç”¨record_loopåªæ˜¯ä¼ é€’çš„å‚æ•°ä¸ä¸€æ ·ï¼Œç­‰å¾…ç¯å¢ƒå¤ä½ã€‚å½•åˆ¶å®Œå½“å‰å›åˆåï¼Œè°ƒç”¨dataset.save_episode()å°†æ•°æ®å†™å…¥åˆ°ç£ç›˜ä¸­ã€‚</p>
<h2 id="_12">å½•åˆ¶å¾ªç¯</h2>
<p>record_loopå‡½æ•°åœ¨ä¸¤ç§åœºæ™¯ä¸‹è¢«è°ƒç”¨ï¼Œä¸»è¦çš„ä½œç”¨æ˜¯åè°ƒæœºå™¨äººæ§åˆ¶ï¼ˆé¥æ“ä½œ/ç­–ç•¥ï¼‰ã€æ•°æ®é‡‡é›†ä¸å­˜å‚¨ï¼Œç¡®ä¿æ•°æ®å¸§ç‡ç¨³å®šä¸”æ ¼å¼ç¬¦åˆæ•°æ®é›†è¦æ±‚ã€‚</p>
<ul>
<li>æ­£å¸¸å½•åˆ¶ï¼šæŒ‰é…ç½®æ—¶é•¿ï¼ˆcontrol_time_sï¼‰å½•åˆ¶ episode æ•°æ®ï¼Œä¿å­˜åˆ°æ•°æ®é›†ã€‚</li>
<li>ç¯å¢ƒé‡ç½®ï¼šå½•åˆ¶ç»“æŸåï¼Œæ‰§è¡Œä¸€æ®µæ— æ•°æ®ä¿å­˜çš„æ§åˆ¶ï¼ˆè®©ç”¨æˆ·æ‰‹åŠ¨é‡ç½®ç¯å¢ƒï¼‰ã€‚</li>
</ul>
<h3 id="_13">åˆå§‹åŒ–ä¸å‚æ•°æ ¡éªŒ</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ ¡éªŒæ•°æ®é›†å¸§ç‡ä¸å½•åˆ¶å¸§ç‡ä¸€è‡´æ€§</span>
<span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dataset</span><span class="o">.</span><span class="n">fps</span> <span class="o">!=</span> <span class="n">fps</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The dataset fps should be equal to requested fps (</span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">fps</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">fps</span><span class="si">}</span><span class="s2">)."</span><span class="p">)</span>

<span class="c1"># å¤šé¥æ“ä½œå™¨å¤„ç†ï¼ˆå¦‚æœºæ¢°è‡‚é¥æ“ä½œ + é”®ç›˜åº•ç›˜æ§åˆ¶ï¼‰</span>
<span class="n">teleop_arm</span> <span class="o">=</span> <span class="n">teleop_keyboard</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">teleop</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
    <span class="c1"># åˆ†ç¦»é”®ç›˜é¥æ“ä½œå™¨å’Œæœºæ¢°è‡‚é¥æ“ä½œå™¨</span>
    <span class="n">teleop_keyboard</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">teleop</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">KeyboardTeleop</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">teleop_arm</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">teleop</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">SO100Leader</span><span class="p">,</span> <span class="o">...</span><span class="p">))),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># æ ¡éªŒï¼šä»…æ”¯æŒ LeKiwi æœºå™¨äººï¼Œä¸”å¿…é¡»åŒ…å« 1 ä¸ªé”®ç›˜é¥æ“ä½œå™¨ + 1 ä¸ªæœºæ¢°è‡‚é¥æ“ä½œå™¨</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">teleop_arm</span> <span class="ow">and</span> <span class="n">teleop_keyboard</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">teleop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">robot</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"lekiwi_client"</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># ç­–ç•¥é‡ç½®ï¼ˆè‹¥ä½¿ç”¨ç­–ç•¥æ§åˆ¶ï¼Œç¡®ä¿åˆå§‹çŠ¶æ€ä¸€è‡´ï¼‰</span>
<span class="k">if</span> <span class="n">policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">policy</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</code></pre></div>
<p>é¦–å…ˆæ ¡éªŒä¸€ä¸‹æ•°æ®é›†çš„å¸§ç‡ä¸å½•åˆ¶å¸§ç‡æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœé¥æ§æœºå™¨äººæœ‰å¤šä¸ªå®ä¾‹ï¼Œæ¯”å¦‚ä¸»è‡‚+é”®ç›˜ï¼Œä¸€èˆ¬è¿™ç§ç»„åˆç”¨äºlekiwiï¼ŒåŒ…å«ä¸€ä¸ªé”®ç›˜é¥æ§æ“ä½œå™¨å’Œ1ä¸ªæœºæ¢°è‡‚é¥æ§æ“ä½œå™¨ã€‚æœ€ååˆ¤æ–­æ˜¯å¦ä½¿ç”¨æ¨¡å‹æ¨ç†æ§åˆ¶ï¼Œå¦‚æœæ˜¯ä½¿ç”¨äº†å…ˆè¿›è¡Œå¤ä½ã€‚</p>
<h3 id="_14">ä¸»å¾ªç¯æ§åˆ¶ä¸æ•°æ®é‡‡é›†</h3>
<div class="codehilite"><pre><span></span><code><span class="n">timestamp</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1">#  episode å·²å½•åˆ¶æ—¶é•¿ï¼ˆç§’ï¼‰</span>
<span class="n">start_episode_t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># èµ·å§‹æ—¶é—´æˆ³</span>
<span class="k">while</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">control_time_s</span><span class="p">:</span>
    <span class="n">start_loop_t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># æœ¬è½®å¾ªç¯èµ·å§‹æ—¶é—´</span>

    <span class="c1"># æ£€æŸ¥æ˜¯å¦æå‰é€€å‡ºï¼ˆå¦‚ç”¨æˆ·æŒ‰ç‰¹å®šæŒ‰é”®ï¼‰</span>
    <span class="k">if</span> <span class="n">events</span><span class="p">[</span><span class="s2">"exit_early"</span><span class="p">]:</span>
        <span class="n">events</span><span class="p">[</span><span class="s2">"exit_early"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">break</span>

    <span class="c1"># 1. è·å–æœºå™¨äººè§‚æµ‹ï¼ˆä¼ æ„Ÿå™¨æ•°æ®ï¼šæ‘„åƒå¤´å›¾åƒã€å…³èŠ‚è§’åº¦ç­‰ï¼‰</span>
    <span class="n">observation</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_observation</span><span class="p">()</span>

    <span class="c1"># 2. æ„å»ºè§‚æµ‹å¸§ï¼ˆç¬¦åˆæ•°æ®é›†æ ¼å¼ï¼‰</span>
    <span class="k">if</span> <span class="n">policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">observation_frame</span> <span class="o">=</span> <span class="n">build_dataset_frame</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">"observation"</span><span class="p">)</span>

    <span class="c1"># 3. ç”ŸæˆåŠ¨ä½œï¼ˆç­–ç•¥/é¥æ“ä½œå™¨äºŒé€‰ä¸€ï¼‰</span>
    <span class="k">if</span> <span class="n">policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># ç­–ç•¥ç”ŸæˆåŠ¨ä½œï¼šè¾“å…¥è§‚æµ‹å¸§ï¼Œè¾“å‡ºåŠ¨ä½œå€¼</span>
        <span class="n">action_values</span> <span class="o">=</span> <span class="n">predict_action</span><span class="p">(</span>
            <span class="n">observation_frame</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">get_safe_torch_device</span><span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="o">...</span>
        <span class="p">)</span>
        <span class="c1"># æ ¼å¼åŒ–åŠ¨ä½œï¼šæŒ‰æœºå™¨äººåŠ¨ä½œç‰¹å¾ï¼ˆå¦‚å…³èŠ‚åç§°ï¼‰æ„å»ºå­—å…¸</span>
        <span class="n">action</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">action_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">action_features</span><span class="p">)}</span>
    <span class="k">elif</span> <span class="n">policy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">teleop</span><span class="p">,</span> <span class="n">Teleoperator</span><span class="p">):</span>
        <span class="c1"># å•é¥æ“ä½œå™¨ï¼šç›´æ¥è·å–åŠ¨ä½œ</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">teleop</span><span class="o">.</span><span class="n">get_action</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">policy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">teleop</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># å¤šé¥æ“ä½œå™¨ï¼šåˆå¹¶æœºæ¢°è‡‚åŠ¨ä½œå’Œåº•ç›˜åŠ¨ä½œ</span>
        <span class="n">arm_action</span> <span class="o">=</span> <span class="n">teleop_arm</span><span class="o">.</span><span class="n">get_action</span><span class="p">()</span>  <span class="c1"># æœºæ¢°è‡‚åŠ¨ä½œ</span>
        <span class="n">base_action</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">_from_keyboard_to_base_action</span><span class="p">(</span><span class="n">teleop_keyboard</span><span class="o">.</span><span class="n">get_action</span><span class="p">())</span>  <span class="c1"># åº•ç›˜åŠ¨ä½œ</span>
        <span class="n">action</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">arm_action</span><span class="p">,</span> <span class="o">**</span><span class="n">base_action</span><span class="p">}</span>  <span class="c1"># åˆå¹¶åŠ¨ä½œ</span>

    <span class="c1"># 4. æ‰§è¡ŒåŠ¨ä½œå¹¶è®°å½•å®é™…å‘é€çš„åŠ¨ä½œï¼ˆå¯èƒ½å› å®‰å…¨é™åˆ¶è¢«è£å‰ªï¼‰</span>
    <span class="n">sent_action</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">send_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

    <span class="c1"># 5. ä¿å­˜æ•°æ®åˆ°æ•°æ®é›†ï¼ˆè‹¥å¯ç”¨ï¼‰</span>
    <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">action_frame</span> <span class="o">=</span> <span class="n">build_dataset_frame</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">sent_action</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">"action"</span><span class="p">)</span>  <span class="c1"># åŠ¨ä½œå¸§</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">observation_frame</span><span class="p">,</span> <span class="o">**</span><span class="n">action_frame</span><span class="p">}</span>  <span class="c1"># åˆå¹¶è§‚æµ‹ä¸åŠ¨ä½œ</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">add_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">single_task</span><span class="p">)</span>  <span class="c1"># æ·»åŠ åˆ°æ•°æ®é›†</span>

    <span class="c1"># 6. å¯è§†åŒ–æ•°æ®ï¼ˆè‹¥å¯ç”¨ï¼‰</span>
    <span class="k">if</span> <span class="n">display_data</span><span class="p">:</span>
        <span class="n">log_rerun_data</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>  <span class="c1"># è®°å½•æ•°æ®ç”¨äº Rerun å¯è§†åŒ–</span>

    <span class="c1"># 7. ç»´æŒå¸§ç‡ï¼šç­‰å¾…å‰©ä½™æ—¶é—´ä»¥ç¡®ä¿å¾ªç¯å‘¨æœŸä¸º 1/FPS ç§’</span>
    <span class="n">dt_s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_loop_t</span>  <span class="c1"># æœ¬è½®å¾ªç¯è€—æ—¶</span>
    <span class="n">busy_wait</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">fps</span> <span class="o">-</span> <span class="n">dt_s</span><span class="p">)</span>  <span class="c1">#  busy ç­‰å¾…ä»¥è¡¥è¶³æ—¶é—´</span>

    <span class="c1"># æ›´æ–° episode å·²å½•åˆ¶æ—¶é•¿</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_episode_t</span>
</code></pre></div>
<p>è¿™é‡Œåˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼Œä¸€ä¸ªæ˜¯æ¨¡å‹æ¨ç†æ¨¡å¼å’Œé¥æ§æ“ä½œæ¨¡å¼ï¼Œå‰è€…æ˜¯ä½¿ç”¨å¤§æ¨¡å‹è¿›è¡Œé¢„æµ‹äº§ç”ŸåŠ¨ä½œå¤„ç†ï¼Œåè€…æ˜¯ç”¨äºå¤§æ¨¡å‹è®­ç»ƒé‡‡é›†æ•°æ®ã€‚</p>
<p>å¯¹äº<strong>é‡‡é›†æ•°æ®æ¨¡å¼æµç¨‹</strong>å¦‚ä¸‹ï¼š</p>
<ul>
<li>è·å–è§‚æµ‹åŸå§‹æ•°æ®ï¼šè°ƒç”¨robot.get_observation()è·å–è§‚æµ‹æ•°æ®ï¼ŒåŒ…æ‹¬æœºå™¨å…³èŠ‚çš„æ•°æ®ã€æ‘„åƒå¤´æ•°æ®ç­‰ã€‚ç”¨äºåç»­çš„æ•°æ®å­˜å‚¨ã€‚</li>
<li>è·å–é¥æ§æœºå™¨äººçš„åŠ¨ä½œæ•°æ®ï¼šè°ƒç”¨action = teleop.get_action()è·å–åˆ°åŠ¨ä½œæ•°æ®ã€‚å¦‚æœæ˜¯å¤šé¥æ§æ“ä½œå™¨ï¼Œéœ€è¦å°†å…¶åˆå¹¶åŠ¨ä½œã€‚</li>
<li>å‘é€æœºå™¨äººæ‰§è¡ŒåŠ¨ä½œï¼šè°ƒç”¨sent_action = robot.send_action(action)æ‰§è¡ŒåŠ¨ä½œã€‚</li>
<li>ä¿å­˜æ•°æ®é›†ï¼šå…ˆè°ƒç”¨build_dataset_frameæ„å»ºé¥æ§è‡‚çš„æ•°æ®actionï¼Œç„¶åå°†actionä¸ä»è‡‚æœºå™¨çš„è§‚æµ‹æ•°æ®action_valuesè¿›è¡Œåˆå¹¶frameï¼Œæœ€åè°ƒç”¨dataset.add_frameæ·»åŠ åˆ°æ•°æ®é›†ä¸­ã€‚</li>
<li>å¯è§†åŒ–æ•°æ®ï¼šå¦‚æœå¯åŠ¨äº†å¯è§†åŒ–æ•°æ®ï¼Œè°ƒç”¨log_rerun_dataè®°å½•æ•°æ®ç”¨äºrerunå¯è§†åŒ–ã€‚</li>
<li>æ—¶é•¿æ›´æ–°ï¼šå½•åˆ¶ä¸€è½®æœ‰ä¸€ä¸ªé»˜è®¤çš„ç­‰å¾…æ—¶é•¿ï¼Œè°ƒç”¨busy_waitè¿›è¡Œç­‰å¾…ã€‚</li>
</ul>
<p>å¯¹äº<strong>æ¨¡å‹æ¨ç†æ¨¡å¼æµç¨‹</strong>å¦‚ä¸‹ï¼š</p>
<ul>
<li>è·å–è§‚æµ‹åŸå§‹æ•°æ®ï¼šè°ƒç”¨robot.get_observation()è·å–è§‚æµ‹æ•°æ®ï¼ŒåŒ…æ‹¬æœºå™¨å…³èŠ‚çš„æ•°æ®ã€æ‘„åƒå¤´æ•°æ®ç­‰ã€‚</li>
<li>æ„å»ºæ¨¡å‹è¾“å…¥æ•°æ®ï¼šè¦èƒ½å¤Ÿå–‚ç»™æ¨¡å‹åšé¢„æµ‹åŠ¨ä½œï¼Œéœ€è¦å°†æ•°æ®è½¬æ¢ä¸ºæ¨¡å‹å¯æ¥æ”¶çš„æ ¼å¼ï¼Œè°ƒç”¨build_dataset_frameå°†è§‚æµ‹åŸå§‹æ•°æ®è¿›è¡Œè½¬æ¢ã€‚</li>
<li>æ¨¡å‹ç”Ÿæˆé¢„æµ‹åŠ¨ä½œï¼šè°ƒç”¨predict_actionå¾—åˆ°é¢„æµ‹åŠ¨ä½œaction_valuesï¼Œæ¥ç€å°†action_valuesè½¬æ¢ä¸ºæœºå™¨çš„åŠ¨ä½œç‰¹å¾actionã€‚</li>
<li>å‘é€é¢„æµ‹åŠ¨ä½œï¼šè°ƒç”¨robot.send_action(action)å°†é¢„æµ‹åŠ¨ä½œå‘é€ç»™æœºå™¨è¿›è¡Œæ‰§è¡Œã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯observation = robot.get_observation()è¿”å›çš„æ•°æ®æ ¼å¼ï¼Œä¸»è¦åŒ…æ‹¬çš„æ˜¯6ä¸ªèˆµæœºå…³èŠ‚ä½ç½®ä¿¡æ¯+ä¸¤ä¸ªç›¸æœºçš„å›¾åƒä¿¡æ¯ï¼Œä¸€å…±8ä¸ªé”®å€¼å¯¹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="err">observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span>
<span class="p">{</span><span class="err">'elbow_</span><span class="kc">fle</span><span class="err">x.pos'</span><span class="p">:</span><span class="w"> </span><span class="mf">99.54710144927537</span><span class="p">,</span>
<span class="w"> </span><span class="err">'</span><span class="kc">f</span><span class="err">ixed'</span><span class="p">:</span><span class="w"> </span><span class="err">array(</span><span class="p">[[[</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w">  </span><span class="mi">48</span><span class="p">,</span><span class="w">  </span><span class="mi">39</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span><span class="w">  </span><span class="mi">46</span><span class="p">,</span><span class="w">  </span><span class="mi">37</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w">  </span><span class="mi">39</span><span class="p">,</span><span class="w">  </span><span class="mi">29</span><span class="p">],</span>
<span class="w">        </span><span class="err">...</span><span class="p">,</span>
<span class="w">        </span><span class="err">...</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w">  </span><span class="mi">81</span><span class="p">,</span><span class="w">  </span><span class="mi">69</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">54</span><span class="p">,</span><span class="w">  </span><span class="mi">87</span><span class="p">,</span><span class="w">  </span><span class="mi">76</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w">  </span><span class="mi">88</span><span class="p">,</span><span class="w">  </span><span class="mi">77</span><span class="p">]]],</span><span class="w"> </span><span class="err">shape=(</span><span class="mi">480</span><span class="p">,</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="err">d</span><span class="kc">t</span><span class="err">ype=ui</span><span class="kc">nt</span><span class="mi">8</span><span class="err">)</span><span class="p">,</span>
<span class="w"> </span><span class="err">'gripper.pos'</span><span class="p">:</span><span class="w"> </span><span class="mf">2.666666666666667</span><span class="p">,</span>
<span class="w"> </span><span class="err">'ha</span><span class="kc">n</span><span class="err">deye'</span><span class="p">:</span><span class="w"> </span><span class="err">array(</span><span class="p">[[[</span><span class="mi">76</span><span class="p">,</span><span class="w"> </span><span class="mi">71</span><span class="p">,</span><span class="w"> </span><span class="mi">75</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">75</span><span class="p">,</span><span class="w"> </span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">74</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">69</span><span class="p">,</span><span class="w"> </span><span class="mi">67</span><span class="p">,</span><span class="w"> </span><span class="mi">70</span><span class="p">],</span>
<span class="w">        </span><span class="err">...</span><span class="p">,</span>
<span class="w">        </span><span class="err">...</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="mi">38</span><span class="p">,</span><span class="w"> </span><span class="mi">73</span><span class="p">,</span><span class="w"> </span><span class="mi">31</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="mi">68</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="mi">63</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">]]],</span><span class="w"> </span><span class="err">shape=(</span><span class="mi">480</span><span class="p">,</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="err">d</span><span class="kc">t</span><span class="err">ype=ui</span><span class="kc">nt</span><span class="mi">8</span><span class="err">)</span><span class="p">,</span>
<span class="w"> </span><span class="err">'shoulder_li</span><span class="kc">ft</span><span class="err">.pos'</span><span class="p">:</span><span class="w"> </span><span class="mf">-98.65771812080537</span><span class="p">,</span>
<span class="w"> </span><span class="err">'shoulder_pa</span><span class="kc">n</span><span class="err">.pos'</span><span class="p">:</span><span class="w"> </span><span class="mf">-10.490956072351423</span><span class="p">,</span>
<span class="w"> </span><span class="err">'wris</span><span class="kc">t</span><span class="err">_</span><span class="kc">fle</span><span class="err">x.pos'</span><span class="p">:</span><span class="w"> </span><span class="mf">54.17743324720067</span><span class="p">,</span>
<span class="w"> </span><span class="err">'wris</span><span class="kc">t</span><span class="err">_roll.pos'</span><span class="p">:</span><span class="w"> </span><span class="mf">-3.5714285714285694</span><span class="p">}</span>
</code></pre></div>
<p>åŸå§‹çš„è§‚æµ‹æ•°æ®ï¼Œè¦ç»è¿‡å¤„ç†ï¼Œä»¥ä¾¿å–‚ç»™æ¨¡å‹æˆ–è€…å­˜å‚¨åˆ°æœ¬åœ°ï¼Œè¾“å‡ºçš„æ•°æ®å¦‚ä¸‹ï¼Œä¸€å…±æœ‰3ä¸ªé”®å€¼å¯¹ï¼ŒåŒ…æ‹¬2ä¸ªæ‘„åƒå¤´çš„é”®å€¼å¯¹å’Œä¸€ä¸ªèˆµæœºå…³èŠ‚ä½ç½®çš„ï¼Œå¯ä»¥çœ‹åˆ°å°†å‰é¢6ä¸ªèˆµæœºçš„åˆå¹¶ä¸ºä¸€ä¸ªé”®å€¼å¯¹äº†ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="err">observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">_</span><span class="kc">fra</span><span class="err">me</span><span class="p">:</span>
<span class="p">{</span><span class="err">'observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">.images.</span><span class="kc">f</span><span class="err">ixed'</span><span class="p">:</span><span class="w"> </span><span class="err">array(</span><span class="p">[[[</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w">  </span><span class="mi">55</span><span class="p">,</span><span class="w">  </span><span class="mi">61</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">73</span><span class="p">,</span><span class="w">  </span><span class="mi">48</span><span class="p">,</span><span class="w">  </span><span class="mi">54</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">68</span><span class="p">,</span><span class="w">  </span><span class="mi">48</span><span class="p">,</span><span class="w">  </span><span class="mi">49</span><span class="p">],</span>
<span class="w">        </span><span class="err">...</span><span class="p">,</span>
<span class="w">        </span><span class="err">...</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">62</span><span class="p">,</span><span class="w">  </span><span class="mi">82</span><span class="p">,</span><span class="w">  </span><span class="mi">73</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">69</span><span class="p">,</span><span class="w">  </span><span class="mi">89</span><span class="p">,</span><span class="w">  </span><span class="mi">80</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">73</span><span class="p">,</span><span class="w">  </span><span class="mi">90</span><span class="p">,</span><span class="w">  </span><span class="mi">82</span><span class="p">]]],</span><span class="w"> </span><span class="err">shape=(</span><span class="mi">480</span><span class="p">,</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="err">d</span><span class="kc">t</span><span class="err">ype=ui</span><span class="kc">nt</span><span class="mi">8</span><span class="err">)</span><span class="p">,</span>
<span class="w"> </span><span class="err">'observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">.images.ha</span><span class="kc">n</span><span class="err">deye'</span><span class="p">:</span><span class="w"> </span><span class="err">array(</span><span class="p">[[[</span><span class="mi">67</span><span class="p">,</span><span class="w"> </span><span class="mi">78</span><span class="p">,</span><span class="w"> </span><span class="mi">72</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">72</span><span class="p">,</span><span class="w"> </span><span class="mi">83</span><span class="p">,</span><span class="w"> </span><span class="mi">77</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">69</span><span class="p">,</span><span class="w"> </span><span class="mi">85</span><span class="p">,</span><span class="w"> </span><span class="mi">75</span><span class="p">],</span>
<span class="w">        </span><span class="err">...</span><span class="p">,</span>
<span class="w">        </span><span class="err">...</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="mi">51</span><span class="p">,</span><span class="w"> </span><span class="mi">71</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">39</span><span class="p">,</span><span class="w"> </span><span class="mi">59</span><span class="p">,</span><span class="w">  </span><span class="mi">6</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="mi">63</span><span class="p">,</span><span class="w">  </span><span class="mi">7</span><span class="p">]]],</span><span class="w"> </span><span class="err">shape=(</span><span class="mi">480</span><span class="p">,</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="err">d</span><span class="kc">t</span><span class="err">ype=ui</span><span class="kc">nt</span><span class="mi">8</span><span class="err">)</span><span class="p">,</span>
<span class="w"> </span><span class="err">'observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">.s</span><span class="kc">tate</span><span class="err">'</span><span class="p">:</span><span class="w"> </span><span class="err">array(</span><span class="p">[</span><span class="mf">-10.490956</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mf">-98.657715</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="mf">99.547104</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="mf">54.177433</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="mf">-3.5714285</span><span class="p">,</span>
<span class="w">         </span><span class="mf">2.6666667</span><span class="p">],</span><span class="w"> </span><span class="err">d</span><span class="kc">t</span><span class="err">ype=</span><span class="kc">fl</span><span class="err">oa</span><span class="kc">t</span><span class="mi">32</span><span class="err">)</span><span class="p">}</span>
</code></pre></div>
<p>å‘é€ç»™æœºå™¨äººçš„åŠ¨ä½œæ•°æ®ï¼Œæ¯”è¾ƒç®€å•å¦‚ä¸‹ï¼Œä¹Ÿå°±æ˜¯6ä¸ªèˆµæœºçš„å…³èŠ‚ä½ç½®ä¿¡æ¯ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="err">se</span><span class="kc">nt</span><span class="err">_ac</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span>
<span class="p">{</span><span class="err">'elbow_</span><span class="kc">fle</span><span class="err">x.pos'</span><span class="p">:</span><span class="w"> </span><span class="mf">99.63685882886972</span><span class="p">,</span>
<span class="w"> </span><span class="err">'gripper.pos'</span><span class="p">:</span><span class="w"> </span><span class="mf">0.6509357200976403</span><span class="p">,</span>
<span class="w"> </span><span class="err">'shoulder_li</span><span class="kc">ft</span><span class="err">.pos'</span><span class="p">:</span><span class="w"> </span><span class="mf">-99.36102236421725</span><span class="p">,</span>
<span class="w"> </span><span class="err">'shoulder_pa</span><span class="kc">n</span><span class="err">.pos'</span><span class="p">:</span><span class="w"> </span><span class="mf">-10.0</span><span class="p">,</span>
<span class="w"> </span><span class="err">'wris</span><span class="kc">t</span><span class="err">_</span><span class="kc">fle</span><span class="err">x.pos'</span><span class="p">:</span><span class="w"> </span><span class="mf">53.53886235345203</span><span class="p">,</span>
<span class="w"> </span><span class="err">'wris</span><span class="kc">t</span><span class="err">_roll.pos'</span><span class="p">:</span><span class="w"> </span><span class="mf">-3.598634095087988</span><span class="p">}</span>
</code></pre></div>
<p>å­˜å‚¨å½•åˆ¶æ•°æ®æ—¶ï¼Œéœ€è¦é¥æ§æœºå™¨action_frameã€è§‚æµ‹æœºå™¨abservation_frameï¼ˆå‰é¢å·²ç»åˆ—å‡ºäº†ï¼‰ï¼Œä¸‹é¢çœ‹çœ‹ç›¸å…³æ•°æ®çš„æ ¼å¼ã€‚</p>
<p>action_frameæ˜¯é¥æ§æœºå™¨çš„sent_actionè½¬æ¢è€Œæ¥ï¼Œè°ƒç”¨action_frame = build_dataset_frame(dataset.features, sent_action, prefix="action")ï¼Œå®é™…ä¸Šå°±æ˜¯å°†sent_actionæ•°æ®6ä¸ªé”®å€¼å¯¹æ”¹ä¸º1ä¸ªé”®å€¼å¯¹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="err">ac</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">_</span><span class="kc">fra</span><span class="err">me</span><span class="p">:</span>
<span class="p">{</span><span class="err">'ac</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">'</span><span class="p">:</span><span class="w"> </span><span class="err">array(</span><span class="p">[</span><span class="mf">-10.</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mf">-99.36102</span><span class="w">  </span><span class="p">,</span><span class="w">  </span><span class="mf">99.636856</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="mf">53.538864</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="mf">-3.598634</span><span class="w"> </span><span class="p">,</span>
<span class="w">         </span><span class="mf">0.6509357</span><span class="p">],</span><span class="w"> </span><span class="err">d</span><span class="kc">t</span><span class="err">ype=</span><span class="kc">fl</span><span class="err">oa</span><span class="kc">t</span><span class="mi">32</span><span class="err">)</span><span class="p">}</span>
</code></pre></div>
<p>æœ€åå°†ç»è¿‡å¤„ç†çš„ä¸€ä¸ªé¥æ§æœºå™¨æ•°æ®å’Œç»è¿‡å¤„ç†çš„è§‚æµ‹æ•°æ®è¿›è¡Œåˆå¹¶ï¼Œæœ€ç»ˆå¾—åˆ°å¦‚ä¸‹4ä¸ªé”®å€¼å¯¹çš„æ•°æ®ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kc">fra</span><span class="err">me</span><span class="p">:</span>
<span class="p">{</span><span class="err">'ac</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">'</span><span class="p">:</span><span class="w"> </span><span class="err">array(</span><span class="p">[</span><span class="mf">-10.</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mf">-99.36102</span><span class="w">  </span><span class="p">,</span><span class="w">  </span><span class="mf">99.636856</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="mf">53.538864</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="mf">-3.598634</span><span class="w"> </span><span class="p">,</span>
<span class="w">         </span><span class="mf">0.6509357</span><span class="p">],</span><span class="w"> </span><span class="err">d</span><span class="kc">t</span><span class="err">ype=</span><span class="kc">fl</span><span class="err">oa</span><span class="kc">t</span><span class="mi">32</span><span class="err">)</span><span class="p">,</span>
<span class="w"> </span><span class="err">'observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">.images.</span><span class="kc">f</span><span class="err">ixed'</span><span class="p">:</span><span class="w"> </span><span class="err">array(</span><span class="p">[[[</span><span class="w"> </span><span class="mi">70</span><span class="p">,</span><span class="w">  </span><span class="mi">62</span><span class="p">,</span><span class="w">  </span><span class="mi">51</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">63</span><span class="p">,</span><span class="w">  </span><span class="mi">55</span><span class="p">,</span><span class="w">  </span><span class="mi">44</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">61</span><span class="p">,</span><span class="w">  </span><span class="mi">54</span><span class="p">,</span><span class="w">  </span><span class="mi">44</span><span class="p">],</span>
<span class="w">        </span><span class="err">...</span><span class="p">,</span>
<span class="w">        </span><span class="err">...</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">53</span><span class="p">,</span><span class="w">  </span><span class="mi">95</span><span class="p">,</span><span class="w">  </span><span class="mi">83</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w">  </span><span class="mi">90</span><span class="p">,</span><span class="w">  </span><span class="mi">80</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="mi">104</span><span class="p">,</span><span class="w">  </span><span class="mi">93</span><span class="p">]]],</span><span class="w"> </span><span class="err">shape=(</span><span class="mi">480</span><span class="p">,</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="err">d</span><span class="kc">t</span><span class="err">ype=ui</span><span class="kc">nt</span><span class="mi">8</span><span class="err">)</span><span class="p">,</span>
<span class="w"> </span><span class="err">'observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">.images.ha</span><span class="kc">n</span><span class="err">deye'</span><span class="p">:</span><span class="w"> </span><span class="err">array(</span><span class="p">[[[</span><span class="mi">76</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">78</span><span class="p">,</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span><span class="w"> </span><span class="mi">59</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">77</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">],</span>
<span class="w">        </span><span class="err">...</span><span class="p">,</span>
<span class="w">        </span><span class="err">...</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="mi">52</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">66</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="p">]]],</span><span class="w"> </span><span class="err">shape=(</span><span class="mi">480</span><span class="p">,</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="err">d</span><span class="kc">t</span><span class="err">ype=ui</span><span class="kc">nt</span><span class="mi">8</span><span class="err">)</span><span class="p">,</span>
<span class="w"> </span><span class="err">'observa</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">.s</span><span class="kc">tate</span><span class="err">'</span><span class="p">:</span><span class="w"> </span><span class="err">array(</span><span class="p">[</span><span class="mf">-10.490956</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mf">-98.657715</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="mf">99.547104</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="mf">54.177433</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="mf">-3.5714285</span><span class="p">,</span>
<span class="w">         </span><span class="mf">2.6666667</span><span class="p">],</span><span class="w"> </span><span class="err">d</span><span class="kc">t</span><span class="err">ype=</span><span class="kc">fl</span><span class="err">oa</span><span class="kc">t</span><span class="mi">32</span><span class="err">)</span><span class="p">}</span>
</code></pre></div>
<p><strong>å¯è§†åŒ–æ˜¾ç¤º</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># 6. å¯è§†åŒ–æ•°æ®ï¼ˆè‹¥å¯ç”¨ï¼‰</span>
    <span class="k">if</span> <span class="n">display_data</span><span class="p">:</span>
        <span class="n">log_rerun_data</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>  <span class="c1"># è®°å½•æ•°æ®ç”¨äº Rerun å¯è§†åŒ–</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/08/wp_editor_md_6f48aacc8f8cb50e0cf1732fb3e741c9.jpg"><img alt="" src="assets/doc/04-ai/lerobot/lerobotæ•°æ®é‡‡é›†ä¸æ¨¡å‹æµ‹è¯•/images/wp_editor_md_6f48aacc8f8cb50e0cf1732fb3e741c9.jpg"/></a></p>
<p>å¯ä»¥çœ‹åˆ°ç•Œé¢æ˜¾ç¤ºçš„observation.xxxå’Œaction.xxxå°±æ˜¯è°ƒç”¨çš„è¿™é‡Œlog_rerun_dataå‡½æ•°ï¼Œç†è®ºä¸Šæ¥è¯´observationå’Œactionè¦è¶Šå»åˆè¶Šå¥½ï¼Œå› ä¸ºactionæ˜¯æ¨¡å‹æ¨ç†æˆ–ä¸»è‡‚çš„åŠ¨ä½œï¼Œobservationæ˜¯å®é™…çš„åŠ¨ä½œã€‚</p>
<h2 id="_15">æ•°æ®å­˜å‚¨</h2>
<p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œå¾ªåºå½•åˆ¶è¿‡ç¨‹ä¸­ï¼Œå°†ç»è¿‡å¤„ç†çš„é¥æ§æœºå™¨æ•°æ®action_frameå’Œç»è¿‡å¤„ç†åçš„æœºå™¨è§‚æµ‹æ•°æ®observation_frameåˆå¹¶å¾—åˆ°çš„æ•°æ®frameï¼Œç„¶åå…ˆè°ƒç”¨dataset.add_frame(frame, task=single_task)å†™å…¥ï¼Œæœ€åè°ƒç”¨save_episodeæ–¹æ³•å°†ç¼“å­˜æ•°æ®å†™å…¥ç£ç›˜ã€‚</p>
<h3 id="_16">å†™å…¥ç¼“å­˜</h3>
<p>add_frame æ˜¯ LeRobotDataset ç±»çš„æ ¸å¿ƒæ–¹æ³•ä¹‹ä¸€ï¼Œè´Ÿè´£å°†å•å¸§æœºå™¨äººæ•°æ®æš‚å­˜åˆ°å†…å­˜ç¼“å†²åŒºï¼ˆepisode_bufferï¼‰ï¼Œå¹¶å¯¹å›¾åƒæ•°æ®è¿›è¡Œé¢„å¤„ç†ï¼ˆå¦‚æ ¼å¼è½¬æ¢ã€ä¸´æ—¶å­˜å‚¨ï¼‰ã€‚è¯¥æ–¹æ³•æ˜¯æ•°æ®å½•åˆ¶æµç¨‹ä¸­çš„å…³é”®ç¯èŠ‚ï¼Œç¡®ä¿æ¯å¸§æ•°æ®ç¬¦åˆæ•°æ®é›†æ ¼å¼è¦æ±‚ï¼Œå¹¶ä¸ºåç»­çš„ save_episode æ–¹æ³•ï¼ˆå°†ç¼“å†²åŒºæ•°æ®å†™å…¥ç£ç›˜ï¼‰åšå‡†å¤‡ã€‚</p>
<div class="codehilite"><pre><span></span><code>   <span class="k">def</span> <span class="nf">add_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># 1. æ•°æ®æ ¼å¼è½¬æ¢PyTorch Tensor â†’ NumPy æ•°ç»„</span>
        <span class="c1"># ç›®çš„æ˜¯ç»Ÿä¸€æ•°æ®æ ¼å¼ä¸º NumPy æ•°ç»„ï¼ˆæ•°æ®é›†åº•å±‚å­˜å‚¨æ ¼å¼ï¼‰ï¼Œé¿å…å› æ··åˆ Tensor/NumPy ç±»å‹å¯¼è‡´åç»­å¤„ç†å¼‚å¸¸ã€‚</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">frame</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">frame</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

       <span class="c1">#2. æ•°æ®æ ¡éªŒï¼Œç¡®ä¿å¸§æ ¼å¼ç¬¦åˆæ•°æ®é›†å®šä¹‰</span>
       <span class="c1">#æ£€æŸ¥ frame ä¸­çš„æ‰€æœ‰ç‰¹å¾ï¼ˆå¦‚ observation.stateã€actionï¼‰</span>
        <span class="c1">#æ˜¯å¦ä¸ self.features ä¸­å®šä¹‰çš„ dtypeï¼ˆæ•°æ®ç±»å‹ï¼‰ã€shape</span>
        <span class="c1">#ï¼ˆç»´åº¦ï¼‰ä¸€è‡´ã€‚ä¾‹å¦‚ï¼Œè‹¥ self.features å®šä¹‰ action ä¸º </span>
        <span class="c1">#float32 ä¸”å½¢çŠ¶ä¸º (6,)ï¼Œåˆ™æ ¡éªŒ frame["action"] æ˜¯å¦æ»¡è¶³è¿™äº›</span>
        <span class="c1">#æ¡ä»¶ï¼Œç¡®ä¿æ•°æ®è§„èŒƒæ€§ã€‚</span>
        <span class="n">validate_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>

        <span class="c1">#3. å¦‚æœæ²¡æœ‰åˆå§‹åŒ– episode ç¼“å†²åŒºï¼Œåˆ™åˆå§‹åŒ–åˆ›å»º</span>
        <span class="c1"># å†…å­˜ç¼“å†²åŒºï¼Œç”¨äºç´¯ç§¯å½“å‰ episode çš„æ‰€æœ‰å¸§æ•°æ®ã€‚ç»“æ„</span>
        <span class="c1">#ä¸ self.features å¯¹åº”ï¼Œä¾‹å¦‚åŒ…å« observation.stateã€</span>
        <span class="c1">#actionã€timestamp ç­‰é”®ï¼Œæ¯ä¸ªé”®çš„å€¼ä¸ºåˆ—è¡¨ï¼ˆæŒ‰å¸§é¡ºåºå­˜</span>
        <span class="c1">#å‚¨æ•°æ®ï¼‰</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">episode_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_episode_buffer</span><span class="p">()</span>

        <span class="c1"># 4. è®°å½•å¸§ç´¢å¼•ä¸æ—¶é—´æˆ³</span>
        <span class="c1"># æœªæä¾› timestampï¼Œé»˜è®¤æŒ‰å¸§ç‡ï¼ˆself.fpsï¼‰è®¡ç®—ç›¸å¯¹æ—¶é—´</span>
        <span class="c1">#ï¼ˆå¦‚ 30 FPS æ—¶ï¼Œç¬¬ 0 å¸§ä¸º 0sï¼Œç¬¬ 1 å¸§ä¸º 1/30 â‰ˆ0.033sï¼‰ï¼Œç¡®ä¿æ—¶é—´åºåˆ—è¿ç»­æ€§</span>
        <span class="n">frame_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_buffer</span><span class="p">[</span><span class="s2">"size"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">frame_index</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fps</span>
        <span class="c1"># è®°å½•å­˜å‚¨frame_indexï¼Œtimestampï¼Œtask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">episode_buffer</span><span class="p">[</span><span class="s2">"frame_index"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">episode_buffer</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">episode_buffer</span><span class="p">[</span><span class="s2">"task"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="c1"># 5. æ·»åŠ ä¸€å¸§æ•°æ®åˆ°episode_buffer</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">frame</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"An element of the frame is not in the features. '</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">' not in '</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">'."</span>
                <span class="p">)</span>
           <span class="c1"># å¦‚æœæ˜¯å›¾åƒï¼Œå¤„ç†è¿½åŠ åˆ°æ•°æ®ç¼“å†²åŒº</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"dtype"</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"image"</span><span class="p">,</span> <span class="s2">"video"</span><span class="p">]:</span>
                <span class="n">img_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_image_file_path</span><span class="p">(</span>
                    <span class="n">episode_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_buffer</span><span class="p">[</span><span class="s2">"episode_index"</span><span class="p">],</span> <span class="n">image_key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">frame_index</span><span class="o">=</span><span class="n">frame_index</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">frame_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">img_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1">#é€šè¿‡ _get_image_file_path ç”Ÿæˆæ ‡å‡†åŒ–è·¯å¾„ï¼Œè°ƒç”¨å­˜å‚¨å›¾ç‰‡,å¯åŒæ­¥å¯å¼‚æ­¥ã€‚</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_image</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">img_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">episode_buffer</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">img_path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
            <span class="c1">#  å¦‚æœæ˜¯åŠ¨ä½œç‰¹å¾æ•°æ®ç›´æ¥è¿½åŠ åˆ°åŸå§‹æ•°æ®ç¼“å†²åŒº</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">episode_buffer</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
       <span class="c1">#6. æœ€åæ›´æ–°ç¼“å†²åŒºå¤§å°</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">episode_buffer</span><span class="p">[</span><span class="s2">"size"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
<p>add_frame æ˜¯æœºå™¨äººæ•°æ®å½•åˆ¶çš„â€œæ•°æ®æš‚å­˜ä¸­æ¢â€ï¼Œé€šè¿‡å†…å­˜ç¼“å†²åŒºç´¯ç§¯å¸§æ•°æ®ã€é¢„å¤„ç†å›¾åƒå¹¶æ ¡éªŒæ•°æ®æ ¼å¼ï¼Œä¸ºåç»­æŒä¹…åŒ–å­˜å‚¨å¥ å®šåŸºç¡€ã€‚å…¶è®¾è®¡å…¼é¡¾äº†å½•åˆ¶æ•ˆç‡ï¼ˆå¼‚æ­¥å›¾åƒå†™å…¥ï¼‰å’Œæ•°æ®å¯é æ€§ï¼ˆæ ¼å¼æ ¡éªŒï¼‰ï¼Œæ˜¯æ„å»ºæ ‡å‡†åŒ–æœºå™¨äººæ•°æ®é›†çš„æ ¸å¿ƒç¯èŠ‚ï¼Œå…¶è®¾è®¡ï¼Œæ€»ç»“æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ•°æ®æš‚å­˜ä¸ç´¯ç§¯ï¼šé€šè¿‡ episode_buffer åœ¨å†…å­˜ä¸­ä¸´æ—¶å­˜å‚¨ä¸€æ•´æ®µ episode çš„æ•°æ®ï¼Œé¿å…é¢‘ç¹ç£ç›˜ I/O å½±å“å½•åˆ¶å¸§ç‡ã€‚</li>
<li>å›¾åƒé¢„å¤„ç†è§£è€¦ï¼šå°†å›¾åƒä¿å­˜ä¸æ•°æ®è®°å½•åˆ†ç¦»ï¼Œæ”¯æŒå¼‚æ­¥å›¾åƒå†™å…¥ï¼ˆAsyncImageWriterï¼‰ï¼Œç¡®ä¿ä¸»å½•åˆ¶å¾ªç¯ï¼ˆrecord_loopï¼‰ä¸å—å›¾åƒå­˜å‚¨é€Ÿåº¦å½±å“ï¼Œç»´æŒç¨³å®šå¸§ç‡ã€‚</li>
<li>æ•°æ®ä¸€è‡´æ€§æ ¡éªŒï¼šé€šè¿‡ validate_frame æå‰è¿‡æ»¤æ— æ•ˆæ•°æ®ï¼Œé¿å…é”™è¯¯æ•°æ®è¿›å…¥åç»­æµç¨‹ï¼ˆå¦‚ save_episode å†™å…¥ç£ç›˜ï¼‰</li>
</ul>
<h3 id="_17">å†™å…¥ç£ç›˜</h3>
<p>å½•åˆ¶å®Œä¸€è½®ï¼Œä¼šè°ƒç”¨dataset.save_episode()è¿›è¡Œå­˜å‚¨å†™å…¥ç£ç›˜ã€‚</p>
<div class="codehilite"><pre><span></span><code>   <span class="k">def</span> <span class="nf">save_episode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">episode_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#1. è¾“å…¥å¤„ç†ä¸æ•°æ®æ ¡éªŒ</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">episode_data</span><span class="p">:</span>
            <span class="n">episode_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_buffer</span> <span class="c1">#ä½¿ç”¨å†…å­˜ç¼“å†²åŒºæ•°æ®ï¼ˆé»˜è®¤æµç¨‹ï¼‰</span>
        <span class="c1">#æ ¡éªŒç¼“å†²åŒºæ•°æ®çš„å®Œæ•´æ€§ï¼Œç¡®ä¿æ‰€æœ‰ç‰¹å¾ï¼ˆå¦‚ </span>
        <span class="c1">#observation.stateã€actionï¼‰çš„é•¿åº¦ä¸€è‡´ï¼ˆä¸ episode æ€»å¸§</span>
        <span class="c1">#æ•°åŒ¹é…ï¼‰ï¼Œä¸” episode_index æœªè¶…å‡ºå½“å‰æ•°æ®é›†èŒƒå›´</span>
        <span class="n">validate_episode_buffer</span><span class="p">(</span><span class="n">episode_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">total_episodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>

        <span class="c1"># 2.ä»ç¼“å†²åŒºä¸­æå–éç‰¹å¾æ•°æ®ï¼ˆè¿™äº›é”®ä¸ç›´æ¥å­˜å‚¨åˆ° Parquetï¼‰</span>
        <span class="n">episode_length</span> <span class="o">=</span> <span class="n">episode_buffer</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"size"</span><span class="p">)</span><span class="c1"># å½“å‰ episode çš„æ€»å¸§æ•°</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="n">episode_buffer</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"task"</span><span class="p">)</span><span class="c1"># æ¯å¸§çš„ä»»åŠ¡æ ‡ç­¾åˆ—è¡¨ï¼ˆå¯èƒ½é‡å¤ï¼‰</span>
        <span class="n">episode_tasks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span><span class="c1"># å½“å‰ episode æ¶‰åŠçš„å”¯ä¸€ä»»åŠ¡åˆ—è¡¨</span>
        <span class="n">episode_index</span> <span class="o">=</span> <span class="n">episode_buffer</span><span class="p">[</span><span class="s2">"episode_index"</span><span class="p">]</span> <span class="c1"># å½“å‰ episode çš„ç´¢å¼•</span>
        <span class="c1">#3. æ„å»ºå…¨å±€ç´¢å¼•ä¸episodeæ ‡è¯†ï¼Œç¡®ä¿æ¯å¸§åœ¨æ•´ä¸ªæ•°æ®é›†ä¸­æœ‰å”¯ä¸€æ ‡è¯†ï¼Œä¾¿äºåç»­æ•°æ®åŠ è½½æ—¶å®šä½ã€‚</span>
        <span class="c1"># ç”Ÿæˆå…¨å±€å¸§ç´¢å¼•ï¼ˆä»æ•°æ®é›†æ€»å¸§æ•°å¼€å§‹ç´¯åŠ ï¼‰</span>
        <span class="n">episode_buffer</span><span class="p">[</span><span class="s2">"index"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">total_frames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">total_frames</span> <span class="o">+</span> <span class="n">episode_length</span><span class="p">)</span>
        <span class="c1">#ç”Ÿæˆ episode_index æ•°ç»„ï¼ˆæ‰€æœ‰å¸§å‡å±äºå½“å‰ episodeï¼‰</span>
        <span class="n">episode_buffer</span><span class="p">[</span><span class="s2">"episode_index"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">episode_length</span><span class="p">,),</span> <span class="n">episode_index</span><span class="p">)</span>

        <span class="c1"># 4. ä»»åŠ¡æ ‡ç­¾å¤„ç†ä¸å…ƒæ•°æ®æ›´æ–°</span>
        <span class="c1"># æ·»åŠ æ–°ä»»åŠ¡åˆ°å…ƒæ•°æ®ï¼ˆè‹¥ä»»åŠ¡ä¸å­˜åœ¨ï¼‰</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">episode_tasks</span><span class="p">:</span>
            <span class="n">task_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get_task_index</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="c1"># æ–°å¢ä»»åŠ¡å¹¶æ›´æ–° tasks.jsonl</span>

        <span class="c1"># ç”Ÿæˆ task_index æ•°ç»„ï¼ˆå°†æ¯å¸§çš„ä»»åŠ¡æ ‡ç­¾æ˜ å°„ä¸ºæ•´æ•°ç´¢å¼•ï¼‰</span>
        <span class="n">episode_buffer</span><span class="p">[</span><span class="s2">"task_index"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get_task_index</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">])</span>
        <span class="c1"># 5.æ•°å€¼ç‰¹å¾æ•°æ®æ ¼å¼åŒ–</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># è·³è¿‡ç´¢å¼•ç±»ç‰¹å¾ã€å›¾åƒå’Œè§†é¢‘ï¼ˆè¿™äº›ç”±å…¶ä»–é€»è¾‘å¤„ç†ï¼‰</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"index"</span><span class="p">,</span> <span class="s2">"episode_index"</span><span class="p">,</span> <span class="s2">"task_index"</span><span class="p">]</span> <span class="ow">or</span> <span class="n">ft</span><span class="p">[</span><span class="s2">"dtype"</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"image"</span><span class="p">,</span> <span class="s2">"video"</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="c1"># å°†åˆ—è¡¨å½¢å¼çš„å¸§æ•°æ®å †å ä¸ºäºŒç»´æ•°ç»„ï¼ˆshape: [episode_length, feature_dim]ï¼‰</span>
            <span class="n">episode_buffer</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">episode_buffer</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
          <span class="c1">#è‹¥ action ç‰¹å¾ä¸ºé•¿åº¦ 6 çš„å‘é‡ï¼Œepisode_buffer["action"] </span>
        <span class="c1"># ä¼šä» [ [a0], [a1], ..., [aN] ] å †å ä¸º [ [a0_0, ..., a0_5], ..., [aN_0, ..., aN_5] ]ï¼Œç¬¦åˆ Parquet å­˜å‚¨æ ¼å¼ã€‚</span>

        <span class="c1">#6. ç­‰å¾…å¼‚æ­¥å›¾åƒå†™å…¥å®Œæˆ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_image_writer</span><span class="p">()</span><span class="c1"># ç¡®ä¿æ‰€æœ‰ä¸´æ—¶å›¾åƒæ–‡ä»¶å·²å†™å…¥ç£ç›˜</span>
        <span class="c1"># ä¿å­˜æ•°å€¼åˆ°Parquetæ–‡ä»¶</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_episode_table</span><span class="p">(</span><span class="n">episode_buffer</span><span class="p">,</span> <span class="n">episode_index</span><span class="p">)</span>
        <span class="n">ep_stats</span> <span class="o">=</span> <span class="n">compute_episode_stats</span><span class="p">(</span><span class="n">episode_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
          <span class="c1"># _save_episode_table è¡Œä¸º</span>
          <span class="c1">#      ä»ç¼“å†²åŒºæå–ç‰¹å¾æ•°æ®ï¼Œæ„é€  datasets.Dataset å¯¹è±¡ã€‚</span>
          <span class="c1">#      å°†æ•°æ®å†™å…¥ Parquet æ–‡ä»¶ï¼ˆè·¯å¾„ç”±å…ƒæ•°æ®çš„ get_data_file_path ç”Ÿæˆï¼Œå¦‚ data/chunk-000/episode_000000.parquetï¼‰ã€‚</span>
          <span class="c1">#      æ›´æ–°å†…å­˜ä¸­çš„ hf_datasetï¼ˆæ‹¼æ¥æ–° episode æ•°æ®ï¼‰ã€‚</span>

        <span class="c1">#8. è‹¥å¯ç”¨è§†é¢‘æ¨¡å¼ï¼Œå°†å›¾åƒç¼–ç å­˜å‚¨ä¸ºè§†é¢‘æ–‡ä»¶</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">video_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">video_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_episode_videos</span><span class="p">(</span><span class="n">episode_index</span><span class="p">)</span> <span class="c1"># å°†ä¸´æ—¶å›¾åƒç¼–ç ä¸º MP4</span>
    <span class="c1">#è°ƒç”¨ ffmpeg å°†ä¸´æ—¶ç›®å½•ä¸‹çš„å›¾åƒå¸§ï¼ˆå¦‚ images/observation.images.laptop/episode_000000/frame_*.pngï¼‰</span>
    <span class="c1">#ç¼–ç ä¸º MP4 è§†é¢‘ï¼Œå­˜å‚¨è·¯å¾„ç”±å…ƒæ•°æ®çš„ get_video_file_path å®šä¹‰</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">video_keys</span><span class="p">:</span>
                <span class="n">episode_buffer</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_paths</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="c1"># è®°å½•è§†é¢‘æ–‡ä»¶è·¯å¾„</span>

        <span class="c1"># `meta.save_episode` be executed after encoding the videos</span>

        <span class="c1">#9. æ›´æ–°å…ƒæ•°æ®ä¸æ ¡éªŒæ—¶é—´æˆ³</span>
        <span class="c1"># æ›´æ–°å…ƒæ•°æ®ï¼ˆæ€» episodesã€æ€» framesã€chunks ç­‰ï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">save_episode</span><span class="p">(</span><span class="n">episode_index</span><span class="p">,</span> <span class="n">episode_length</span><span class="p">,</span> <span class="n">episode_tasks</span><span class="p">,</span> <span class="n">ep_stats</span><span class="p">)</span>
        <span class="c1"># æ ¡éªŒæ—¶é—´æˆ³è¿ç»­æ€§ï¼ˆç¡®ä¿å¸§é—´éš”ç¬¦åˆå¸§ç‡ 1/fps Â± tolerance_sï¼‰</span>
        <span class="n">ep_data_index</span> <span class="o">=</span> <span class="n">get_episode_data_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">episodes</span><span class="p">,</span> <span class="p">[</span><span class="n">episode_index</span><span class="p">])</span>
        <span class="n">ep_data_index_np</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ep_data_index</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">check_timestamps_sync</span><span class="p">(</span>
            <span class="n">episode_buffer</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">],</span><span class="c1"># å¸§æ—¶é—´æˆ³æ•°ç»„</span>
            <span class="n">episode_buffer</span><span class="p">[</span><span class="s2">"episode_index"</span><span class="p">],</span><span class="c1"># episode ç´¢å¼•æ•°ç»„</span>
            <span class="n">ep_data_index_np</span><span class="p">,</span><span class="c1"># episode å¸§èŒƒå›´</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span><span class="c1"># å¸§ç‡</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tolerance_s</span><span class="p">,</span><span class="c1"># æ—¶é—´å®¹å·®</span>
        <span class="p">)</span>
       <span class="c1">#10. æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒä¸èµ„æºæ¸…ç†</span>
       <span class="c1"># éªŒè¯è§†é¢‘æ–‡ä»¶æ•°é‡ï¼ˆæ¯ä¸ª episode Ã— æ¯ä¸ªè§†é¢‘ key åº”å¯¹åº”ä¸€ä¸ª MP4ï¼‰</span>
        <span class="n">video_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">"*.mp4"</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">video_files</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_episodes</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">video_keys</span><span class="p">)</span>
       <span class="c1"># éªŒè¯ Parquet æ–‡ä»¶æ•°é‡ï¼ˆæ¯ä¸ª episode å¯¹åº”ä¸€ä¸ª Parquetï¼‰</span>
        <span class="n">parquet_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">"*.parquet"</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">parquet_files</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_episodes</span>

        <span class="c1"># åˆ é™¤ä¸´æ—¶å›¾åƒç›®å½•ï¼ˆå·²ç¼–ç ä¸ºè§†é¢‘ï¼Œæ— éœ€ä¿ç•™ï¼‰</span>
        <span class="n">img_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="s2">"images"</span>
        <span class="k">if</span> <span class="n">img_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="s2">"images"</span><span class="p">)</span>
        <span class="c1"># é‡ç½®ç¼“å†²åŒºï¼Œå‡†å¤‡ä¸‹ä¸€æ®µ episode å½•åˆ¶</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">episode_data</span><span class="p">:</span>  <span class="c1"># Reset the buffer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">episode_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_episode_buffer</span><span class="p">()</span>
</code></pre></div>
<p>save_episode æ˜¯ LeRobotDataset ç±»çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè´Ÿè´£å°†å†…å­˜ç¼“å†²åŒºï¼ˆepisode_bufferï¼‰ä¸­ç´¯ç§¯çš„å•æ®µ episode æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼ŒåŒæ—¶æ›´æ–°å…ƒæ•°æ®ã€ç”Ÿæˆè§†é¢‘æ–‡ä»¶ã€æ ¡éªŒæ•°æ®å®Œæ•´æ€§ï¼Œå¹¶é‡ç½®ç¼“å†²åŒºä»¥å‡†å¤‡ä¸‹ä¸€æ®µå½•åˆ¶ã€‚è¯¥æ–¹æ³•æ˜¯æ•°æ®å½•åˆ¶æµç¨‹çš„â€œæ”¶å°¾ç¯èŠ‚â€ï¼Œç¡®ä¿æ¯æ®µ episode æ•°æ®ç¬¦åˆ LeRobot æ•°æ®é›†æ ¼å¼è§„èŒƒã€‚ä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ•°æ®æŒä¹…åŒ–ï¼šå°†å†…å­˜ä¸­çš„å¸§æ•°æ®ï¼ˆæ•°å€¼ç‰¹å¾ã€å›¾åƒè·¯å¾„ï¼‰å†™å…¥ Parquet æ–‡ä»¶ï¼ˆç»“æ„åŒ–æ•°æ®ï¼‰å’Œ MP4 æ–‡ä»¶ï¼ˆè§†é¢‘æ•°æ®ï¼‰ã€‚</li>
<li>å…ƒæ•°æ®æ›´æ–°ï¼šæ›´æ–°æ•°æ®é›†å…ƒä¿¡æ¯ï¼ˆå¦‚æ€» episode æ•°ã€æ€»å¸§æ•°ã€ä»»åŠ¡æ ‡ç­¾ï¼‰ï¼Œç¡®ä¿å…ƒæ•°æ®ä¸å®é™…æ•°æ®ä¸€è‡´ã€‚</li>
<li>æ•°æ®æ ¡éªŒï¼šéªŒè¯æ—¶é—´æˆ³è¿ç»­æ€§ã€æ–‡ä»¶å®Œæ•´æ€§ï¼ˆå¦‚è§†é¢‘/Parquet æ–‡ä»¶æ•°é‡åŒ¹é…é¢„æœŸï¼‰ï¼Œé¿å…æ— æ•ˆæ•°æ®å…¥åº“ã€‚</li>
<li>èµ„æºæ¸…ç†ï¼šåˆ é™¤ä¸´æ—¶å›¾åƒæ–‡ä»¶ï¼ˆå·²ç¼–ç ä¸ºè§†é¢‘ï¼‰ï¼Œé‡Šæ”¾å†…å­˜ç¼“å†²åŒºã€‚</li>
</ul>
<p>save_episode æ˜¯ LeRobot æ•°æ®é›†å½•åˆ¶çš„â€œæœ€ç»ˆæ‰§è¡Œè€…â€ï¼Œé€šè¿‡ç³»ç»ŸåŒ–çš„æ•°æ®æ ¼å¼åŒ–ã€ç¼–ç ã€æ ¡éªŒå’Œæ¸…ç†ï¼Œå°†å†…å­˜ä¸­çš„ä¸´æ—¶å¸§æ•°æ®è½¬åŒ–ä¸ºç¬¦åˆè§„èŒƒçš„ç£ç›˜å­˜å‚¨ï¼ŒåŒæ—¶ç»´æŠ¤å…ƒæ•°æ®ä¸€è‡´æ€§å’Œæ•°æ®å®Œæ•´æ€§ã€‚å…¶è®¾è®¡ç¡®ä¿äº†å½•åˆ¶æ•°æ®çš„å¯é æ€§ã€å­˜å‚¨æ•ˆç‡å’Œä¸‹æ¸¸å¯ç”¨æ€§ï¼Œæ˜¯è¿æ¥å®æ—¶å½•åˆ¶ä¸ç¦»çº¿æ•°æ®ä½¿ç”¨çš„å…³é”®æ¡¥æ¢ã€‚</p>
<h2 id="_18">ç»“æŸé‡‡é›†</h2>
<div class="codehilite"><pre><span></span><code><span class="n">log_say</span><span class="p">(</span><span class="s2">"Stop recording"</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">play_sounds</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># è¯­éŸ³æç¤ºç»“æŸå½•åˆ¶</span>
<span class="n">robot</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>  <span class="c1"># æ–­å¼€æœºå™¨äººè¿æ¥ï¼ˆç¦ç”¨æ‰­çŸ©ï¼Œç¡®ä¿å®‰å…¨ï¼‰</span>
<span class="k">if</span> <span class="n">teleop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">teleop</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>  <span class="c1"># æ–­å¼€é¥æ“ä½œå™¨è¿æ¥</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">is_headless</span><span class="p">()</span> <span class="ow">and</span> <span class="n">listener</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">listener</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>  <span class="c1"># åœæ­¢é”®ç›˜ç›‘å¬å™¨</span>
</code></pre></div>
<p>æ–­å¼€è®¾å¤‡ï¼Œåœæ­¢é”®ç›˜ç›‘å¬ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">:</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span> <span class="n">private</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">private</span><span class="p">)</span>  <span class="c1"># ä¸Šä¼ æ•°æ®é›†åˆ° Hugging Face Hub</span>
</code></pre></div>
<p>å°†æ•°æ®ä¸Šä¼ åˆ°hugging Face Hubä¸Šã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="lerobotè®­ç»ƒ.html">â† lerobotè®­ç»ƒ</a>
    <a class="next" href="pythonè¡¥ä¹ .html">pythonè¡¥ä¹  â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

