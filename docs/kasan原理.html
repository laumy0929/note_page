<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>kasanåŸç† - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#kasan">kasanæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆåŸºæœ¬åŸç†ï¼‰</a><ul></ul></li><li><a href="#kasan_1">kasanä½•æ—¶è®¾ç½®å½±å­åŒº</a><ul><li><a href="#_1">ç”³è¯·å†…å­˜</a></li><li><a href="#_2">é‡Šæ”¾å†…å­˜</a></li></ul></li><li><a href="#kasan_2">kasanå¦‚ä½•æ£€æŸ¥å†…å­˜åˆæ³•æ€§</a><ul><li><a href="#_3">åˆå§‹åŒ–</a></li><li><a href="#_4">å½±å­åŒºæ˜ å°„</a></li><li><a href="#__asan_loadstore">__asan_load/storeå®šä¹‰</a></li><li><a href="#_5">æ£€æµ‹</a></li></ul></li><li><a href="#kasan_3">kasanå…¨å±€å˜é‡å®ç°</a><ul><li><a href="#_6">å…¨å±€å˜é‡å½±å­åŒºåˆå§‹åŒ–</a></li></ul></li><li><a href="#kasan_4">kasanå±€éƒ¨å˜é‡å®ç°</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>kasanåŸç†</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-05-24
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      è°ƒè¯•
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="kasan">kasanæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆåŸºæœ¬åŸç†ï¼‰</h2>
<p>kasanæ˜¯ç”¨äºå†…å­˜æ£€æµ‹çš„å·¥å…·ï¼Œèƒ½å¤Ÿæ£€æµ‹å†…å­˜ä»¥ä¸‹å¼‚å¸¸ã€‚</p>
<ul>
<li>buffer-overflow in heap,stack and globals</li>
<li>use-after-free</li>
<li>uninitialized-memory-read</li>
<li>user-memory-access</li>
</ul>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_54ee3f7bb483f2711bf976d7be7473a8.jpg"><img alt="" src="assets/doc/08-è°ƒè¯•/kasanåŸç†/images/wp_editor_md_54ee3f7bb483f2711bf976d7be7473a8.jpg"/></a></p>
<p>å¦‚è‹¥è¦æ”¯æŒkasanéœ€è¦å¤šåˆ’åˆ†1/8çš„å†…å­˜ç”¨äºå†…å­˜æ£€æµ‹çš„ç®¡ç†ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚åˆ†é…çš„å†…å­˜åœ°å€éƒ½æ˜¯æŒ‰å­—èŠ‚å¯¹é½çš„ï¼Œè¿™æ ·åšä¸ºäº†æé«˜cpuçš„æ•ˆç‡ï¼Œæœ¬ç« é»˜è®¤æ˜¯8å­—èŠ‚å¯¹é½ã€‚</p>
<p>å¦‚ä½•å®ç°åˆ†é…å†…å­˜åœ°å€å¯¹é½äº†ï¼Ÿé¦–å…ˆåœ¨åˆå§‹åŒ–å†…å­˜æ—¶ï¼Œä¼šåœ¨å‰åèˆå¼ƒä¸€å®šçš„å­—èŠ‚æ•°ï¼Œä¿è¯æ•´ä¸ªåœ°å€ç©ºé—´èµ·å§‹å’Œç»“æŸåœ°å€æ˜¯8å­—èŠ‚å¯¹é½çš„ï¼Œåœ¨åˆ†é…å†…å­˜æ—¶ï¼Œåˆ†é…çš„å¤§å°ä¹ŸæŒ‰ç…§å­—èŠ‚å¯¹é½æ¥åˆ†é…ï¼Œå¦‚åˆ†é…3å­—èŠ‚æ—¶ï¼Œä¼šè‡ªåŠ¨è¡¥é½5å­—èŠ‚ï¼Œå³å®é™…åˆ†é…åˆ°çš„ç©ºé—´æ˜¯8å­—èŠ‚ï¼Œåªæ˜¯5å­—èŠ‚å¯¹ç”³è¯·è€…ä¸å¯è§ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°åˆ†é…çš„å†…å­˜åœ°å€æ˜¯æŒ‰8å­—èŠ‚å¯¹é½çš„äº†ã€‚</p>
<p>å› ä¸ºå†…å­˜åˆ†é…éƒ½æ˜¯æŒ‰ç…§8å­—èŠ‚å¯¹é½çš„ï¼Œè€Œç”¨æˆ·ç”³è¯·çš„ç©ºé—´å¹¶ä¸æ˜¯æŒ‰ç…§8å­—èŠ‚æ¥ï¼Œæ­£å¦‚ä¸Šæ‰€è¯´è¯·æ±‚åˆ†é…äº†3å­—èŠ‚ï¼Œå®é™…åˆ†é…åˆ°8å­—èŠ‚ï¼Œå‰©ä½™5å­—èŠ‚å¯¹ç”¨æˆ·ä¸å¯è§ï¼Œå½“ç”¨æˆ·å†™åˆ°äº†è¯¥5å­—èŠ‚çš„å†…å­˜ä¹Ÿæ˜¯ä¸åˆæ³•ï¼Œæ‰€ä»¥äº†å¯¹åº”å†…å­˜çš„çŠ¶æ€ä¸€å…±æœ‰ä»¥ä¸‹9ç§ï¼Œå½±å­åŒº1å­—èŠ‚å°±å¯ä»¥è®°å½•è¿™9ç§çŠ¶æ€ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_5cf4456a5576a4100ac616284a6b8ea3.jpg"><img alt="" src="assets/doc/08-è°ƒè¯•/kasanåŸç†/images/wp_editor_md_5cf4456a5576a4100ac616284a6b8ea3.jpg"/></a></p>
<ul>
<li>0å­—èŠ‚å¯è®¿é—®ï¼šè¯´æ˜è¿™8å­—èŠ‚å†…å­˜éƒ½ä¸å¯è®¿é—®ï¼Œå½±å­åŒºè®°å½•ä¸º-1ã€‚</li>
<li>å‰Kå­—èŠ‚å¯ä»¥è®¿é—®ï¼šKå€¼è®°å½•åœ¨å½±å­åŒºï¼Œå¦‚å½“Kä¸º2ï¼Œè¡¨ç¤º0~1å­—èŠ‚å¯è®¿é—®ã€‚Kå–å€¼ä¸º1~7ã€‚</li>
<li>å…¨éƒ½å¯ä»¥è®¿é—®ï¼šå½±å­åŒºå†™0ã€‚</li>
</ul>
<p>ä»ä¸Šå¯çŸ¥ï¼Œå¯¹è®¿é—®å†…å­˜åˆæ³•æ€§çš„å¯ä»¥æ ¹æ®å½±å­åŒºçš„å€¼æ¥åˆ¤æ–­ã€‚åˆ¤æ–­å…¬å¼å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆ1ï¼‰ å¯¹äºåˆ†é…çš„å†…å­˜æ˜¯8å­—èŠ‚æƒ…å†µ</p>
<div class="codehilite"><pre><span></span><code><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">a</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">shadow</span><span class="p">)</span>
<span class="w">    </span><span class="n">report_error</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">....</span>
</code></pre></div>
<p>ï¼ˆ2ï¼‰å¯¹äºåˆ†é…å†…å­˜å°äº8å­—èŠ‚æƒ…å†µ</p>
<div class="codehilite"><pre><span></span><code><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>

<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Offset</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">N</span><span class="p">)</span>
<span class="w">    </span><span class="n">report_error</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_4725f29515a120e2f4a7157045d4e575.jpg"><img alt="" src="assets/doc/08-è°ƒè¯•/kasanåŸç†/images/wp_editor_md_4725f29515a120e2f4a7157045d4e575.jpg"/></a></p>
<p>ç¤ºä¾‹å¦‚ä¸Šå›¾ï¼Œä¾æ—§æ˜¯ç”¨æˆ·ç”³è¯·äº†3ä¸ªå­—èŠ‚ç©ºé—´ï¼Œ_shadow = 3ã€‚å½“å®¢æˆ·ä»ç¬¬2ä¸ªç©ºé—´è®¿é—®2å­—èŠ‚æ—¶ï¼Œä½†æ˜¯_shadow &lt; 1 + 2ï¼Œæ¡ä»¶ä¸æˆç«‹ï¼Œå› æ­¤åˆæ³•ã€‚å¦‚æœä»2ä¸ªç©ºé—´è®¿é—®3å­—èŠ‚æ—¶ï¼Œ*shadow &lt; 1 + 3,æ¡ä»¶æˆç«‹ï¼Œå³ä¸ºéæ³•ã€‚</p>
<p>é€šè¿‡ä¸Šé¢çš„æ–¹æ³•å¯ä»¥è§£å†³use-after-freeçš„é—®é¢˜ï¼Œä½†æ˜¯è¿˜ä¸èƒ½è§£å†³buffer-overflowçš„é—®é¢˜ã€‚è§£å†³buffer-overflowï¼Œå°±æ˜¯åœ¨åˆ†é…å†…å­˜çš„å‰åå¡«å……redzoneï¼Œè¿™æ®µå¡«åŒºä¹Ÿå°†è¿›è¡Œå½±å­åŒºæ˜ å°„ï¼Œé‚£ä¹ˆå½“è®¿é—®è¶Šç•Œæ—¶å°±ä¼šæ£€æŸ¥åˆ°å½±å­åŒºçš„å†…å­˜ï¼Œæç¤ºéæ³•ï¼Œå®ç°åŸç†å‚è€ƒä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_eb62adc16a86d0873c192cbb5106fe52.jpg"><img alt="" src="assets/doc/08-è°ƒè¯•/kasanåŸç†/images/wp_editor_md_eb62adc16a86d0873c192cbb5106fe52.jpg"/></a></p>
<p>ç®€å•å°ç»“ä¸€ä¸‹kasançš„åŸºæœ¬åŸç†ï¼š</p>
<ul>
<li>å†…å­˜åˆ†é…åœ°å€å’Œç©ºé—´éƒ½æ˜¯8nå­—èŠ‚å¯¹é½çš„ï¼Œæœ¬ç« é»˜è®¤8å­—èŠ‚å¯¹é½ã€‚</li>
<li>æ€»å†…å­˜è¢«åˆ†ä¸ºnä»½ï¼Œæ¯ä»½å¤§å°ä¸º8å­—èŠ‚å†…å­˜ï¼Œæ¯ä»½ç”¨1å­—èŠ‚å†…å­˜æ ‡è¯†ï¼Œå½¢æˆä¸€ä¸€æ˜ å°„å…³ç³»ï¼Œæ ‡è¯†åŒºç§°ä¸ºå½±å­åŒºåŸŸã€‚</li>
<li>å½“è¯·æ±‚å­—èŠ‚ä¸æ˜¯8çš„æ•´æ•°å€æ—¶ï¼Œå¦‚åˆ†é…äº†3å­—èŠ‚ï¼Œå®é™…åˆ†é…çš„ä¹Ÿæ˜¯8å­—èŠ‚ï¼Œä»…æ˜¯å¦å¤–5å­—èŠ‚å¯¹åˆ†é…è€…éæ³•ã€‚å› æ­¤8å­—èŠ‚å†…å­˜çš„è®¿é—®æƒé™ä¸€å…±æœ‰9ç§çŠ¶æ€ï¼Œå…¶å½“å‰çš„çŠ¶æ€åœ¨åˆ†é…å†…å­˜æ—¶è®°å½•åˆ°æ˜ å°„çš„å½±å­åŒºåŸŸä¸­ã€‚</li>
<li>åœ¨åˆ†é…å†…å­˜æ—¶ï¼Œä¸ºäº†æ”¯æŒè¶Šç•Œè®¿é—®æ“ä½œï¼Œä¼šåœ¨è¯·æ±‚å†…å­˜çš„å‰åå¡«å……red zoneï¼Œred zoneä¸€èˆ¬å‰åå„8å­—èŠ‚ï¼Œä¹Ÿæœ‰å¯¹åº”çš„å½±å­åŒºåŸŸï¼Œè¯¥å€¼å¡«å……0xfeã€‚</li>
<li>ç¼–è¯‘å™¨ä¼šåœ¨æŒ‡ä»¤è®¿é—®ï¼ˆè¯»å†™ï¼‰å†…å­˜æ—¶ï¼Œè¿›è¡Œè‡ªåŠ¨æ’æ¡©ä»£ç ï¼Œæ£€æŸ¥è¦è®¿é—®çš„ç›®æ ‡å†…å­˜å¯¹åº”çš„å½±å­åŒºï¼Œåˆ¤æ–­æ˜¯å¦åˆæ³•ï¼Œå½“æ£€æŸ¥éæ³•æ—¶å°±ä¼šæŠ¥é”™ã€‚</li>
</ul>
<h2 id="kasan_1">kasanä½•æ—¶è®¾ç½®å½±å­åŒº</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_63679c7321621b44f5b0e88fcbe03cd3.jpg"><img alt="" src="assets/doc/08-è°ƒè¯•/kasanåŸç†/images/wp_editor_md_63679c7321621b44f5b0e88fcbe03cd3.jpg"/></a></p>
<p>ï¼ˆ1ï¼‰mallocçš„æ—¶å€™ä¼šåˆ†é…2* redsize + wantsizeï¼Œå¹¶å¯¹å†…å­˜è¿›è¡Œæ˜ å°„å¡«å……å€¼ã€‚ redzoneæ˜ å°„åŒºåŸŸå¡«å……0xfe,è¯»å†™åŒºè‹¥8å­—èŠ‚å¯¹é½åˆ™å…¨å¡«å……0x0;è‹¥ä¸å¯¹é½ï¼Œä½™ä¸‹ä¸è¶³8å­—èŠ‚çš„å®é™…å€¼å¡«å……åˆ°æœ€å1å­—èŠ‚çš„å½±å­åŒºåŸŸã€‚å†…å­˜å®é™…åˆ†é…çš„è¿˜æ˜¯8å­—èŠ‚å¯¹é½çš„ï¼Œåªæ˜¯å¯¹åº”åº”ç”¨æ¥è¯´ï¼Œå¯è®¿é—®çš„ä¸è¶³8å­—èŠ‚ï¼Œå‰©ä¸‹çš„å½“redzoneã€‚ ï¼ˆ2ï¼‰freeçš„æ—¶å€™å¯¹é½å¯¹åº”çš„å½±å­åŒºå¡«å……0xffã€‚</p>
<h3 id="_1">ç”³è¯·å†…å­˜</h3>
<div class="codehilite"><pre><span></span><code><span class="n">malloc</span><span class="w"> </span>
<span class="w">    </span><span class="n">_malloc_r</span>
<span class="w">        </span><span class="n">pvPortMalloc</span>
<span class="w">            </span><span class="n">__internal_malloc</span>
<span class="w">                </span><span class="n">kasan_malloc_small</span><span class="w"> </span><span class="c1">//addr = 0xc178938, size = 16</span>
<span class="w">                    </span><span class="n">kasan_unpoison_shadow</span>
<span class="w">                        </span><span class="n">kasan_poison_shadow</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">//åˆ†é…ç©ºé—´å¯¹åº”çš„åœ°å€è®¾ç½®ä¸º0</span>
<span class="w">                            </span><span class="n">shadow_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kasan_mem_to_shadow</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
<span class="w">                            </span><span class="n">shadow_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kasan_mem_to_shadow</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">                            </span><span class="n">memset</span><span class="p">(</span><span class="n">shadow_start</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">shadow_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shadow_start</span><span class="p">);</span>
<span class="w">                        </span><span class="n">kasan_poison_shadow</span><span class="p">(</span><span class="n">left_rz</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">debug_magic</span><span class="p">.</span><span class="n">redzone</span><span class="p">),</span><span class="w"> </span><span class="n">KASAN_KMALLOC_REDZONE</span><span class="p">);</span>
<span class="w">                        </span><span class="c1">//è®¾ç½®å†…å­˜å·¦redzone</span>
<span class="w">                        </span><span class="n">kasan_poison_shadow</span><span class="p">(</span><span class="n">right_rz</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">debug_magic</span><span class="p">.</span><span class="n">redzone</span><span class="p">),</span><span class="w"> </span><span class="n">KASAN_KMALLOC_REDZONE</span><span class="p">);</span>
<span class="w">                        </span><span class="c1">//è®¾ç½®å†…å­˜å³redzone</span>
<span class="w">                        </span><span class="c1">//å®é™…åˆ†é…å†…å­˜å·¦å³é¢„ç•™ä¸€ä¸ªç©ºé—´ï¼Œç„¶åè¿™é¢„ç•™çš„ç©ºé—´å¯¹åº”çš„shadowåŒºåŸŸä¹Ÿè¦å¡«å……å€¼ï¼Œå‡è®¾åˆ†é…äº†16å­—èŠ‚ï¼Œå®é™…åˆ†é…äº†8+16+8=32å­—èŠ‚ç©ºé—´ã€‚ç„¶åå¯¹åº”çš„shadowåŒºåŸŸæ˜¯1+2+1å­—èŠ‚å¤§å°ã€‚åœ¨heap4ä¸­mallocå‡½æ•°ä¸­ï¼Œä¼šå¤šåˆ†é…16å­—èŠ‚é•¿åº¦ï¼Œå¦‚ä¸‹ã€‚</span>
<span class="w">                    </span><span class="n">_internal_malloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">xWanteSize</span><span class="p">)</span>
<span class="w">                        </span><span class="n">xWantSize</span><span class="w"> </span><span class="o">+=</span><span class="mi">2</span><span class="o">*</span><span class="n">xSlabDegbuMgicSize</span><span class="p">;</span>
</code></pre></div>
<p>ç”³è¯·å†…å­˜ï¼Œå‰åçš„å†…å­˜redzoneå¯¹åº”çš„shadowåŒºåŸŸå†™0xFE,è¡¨ç¤ºè¡¨ç¤ºçº¢åŒºã€‚å®é™…å†…å­˜å¯¹åº”çš„shadowåŒºåŸŸå†™0ï¼Œè¡¨ç¤ºå†…å­˜å·²ç»è¢«ç”³è¯·ï¼Œè¡¨ç¤ºå¯å†™ã€‚</p>
<h3 id="_2">é‡Šæ”¾å†…å­˜</h3>
<div class="codehilite"><pre><span></span><code><span class="n">free</span>
<span class="w">    </span><span class="n">__internal_free</span><span class="w"> </span>
<span class="w">        </span><span class="n">kasan_free_large</span>
<span class="w">            </span><span class="n">kasan_poison_shadow</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">KASAN_FREE_PAGE</span><span class="p">);</span>
<span class="w">            </span><span class="c1">//è®¾ç½®0xffåˆ°å¯¹åº”çš„shadowåŒºåŸŸï¼Œè¡¨ç¤ºè¯¥å†…å­˜å·²ç»é‡Šæ”¾ã€‚ä¸èƒ½å†å†™äº†ã€‚</span>
</code></pre></div>
<h2 id="kasan_2">kasanå¦‚ä½•æ£€æŸ¥å†…å­˜åˆæ³•æ€§</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_a2a6515514e5256811518902d5b0ec53.jpg"><img alt="" src="assets/doc/08-è°ƒè¯•/kasanåŸç†/images/wp_editor_md_a2a6515514e5256811518902d5b0ec53.jpg"/></a></p>
<h3 id="_3">åˆå§‹åŒ–</h3>
<div class="codehilite"><pre><span></span><code><span class="n">åˆå§‹åŒ–éƒ¨åˆ†kasan_early_init</span><span class="o">/</span><span class="n">kasan_init</span><span class="o">/</span><span class="n">do_ctors</span>

<span class="n">kasan_early_init</span>
<span class="w">    </span><span class="n">kasan_shadow_init_nommu</span>
<span class="w">        </span><span class="k">for</span><span class="p">()</span>
<span class="w">            </span><span class="o">*</span><span class="p">(</span><span class="n">xxx</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="n">å°†æ‰€æœ‰çš„shadaow</span><span class="w"> </span><span class="n">memoryè®¾ç½®ä¸º0</span>

<span class="n">kasan_init</span>
<span class="w">    </span><span class="n">kasan_init_nommu</span>
<span class="w">        </span><span class="n">kasan_init_report</span>
<span class="w">            </span><span class="n">kasan_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">KASAN_REPORT_INIT_FLAG</span><span class="p">;</span><span class="w"> </span><span class="c1">//è®¾ç½®kasanæ ‡å¿—ä½</span>
<span class="w">        </span><span class="n">kasan_enable_report</span>
<span class="w">            </span><span class="n">kasan_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">KASAN_REPORT_SHOW_FLAG</span><span class="p">;</span>
<span class="w">        </span><span class="n">rt_malloc_small_sethook</span><span class="p">(</span><span class="n">rt_malloc_small_func_hook</span><span class="p">);</span>
<span class="w">            </span><span class="n">rt_malloc_small_hook</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hook</span><span class="p">;</span><span class="w"> </span><span class="c1">//è®¾ç½®å›è°ƒå‡½æ•°ï¼Œheap4 __internal_mallocçš„æ—¶å€™è°ƒç”¨</span>
<span class="w">        </span><span class="n">rt_free_small_sethook</span><span class="p">(</span><span class="n">rt_free_small_func_hook</span><span class="p">);</span>
<span class="w">            </span><span class="n">rt_free_small_hook</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hook</span><span class="p">;</span><span class="w">   </span><span class="c1">//è®¾ç½®å›è°ƒå‡½æ•°ï¼Œheap4 __internal_freeçš„æ—¶å€™è°ƒç”¨</span>
</code></pre></div>
<h3 id="_4">å½±å­åŒºæ˜ å°„</h3>
<div class="codehilite"><pre><span></span><code><span class="nl">adress</span><span class="p">:</span><span class="mi">0</span><span class="o">+</span><span class="n">CONFIG_ARCH_MEM_LENGTH</span><span class="w">   </span><span class="o">-------------------</span><span class="w"> </span>
<span class="w">                                  </span><span class="o">|</span><span class="n">XXXXXXXXXXXXXXXXXX</span><span class="o">|</span>
<span class="nl">adress</span><span class="p">:</span><span class="mi">0</span><span class="o">+</span><span class="n">x</span><span class="w">                        </span><span class="o">--------------------</span><span class="w"> </span><span class="n">KASAN_SHADOW_START</span>
<span class="w">                                  </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span>
<span class="w">                                  </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"> </span>
<span class="w">                                  </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span>
<span class="nl">adress</span><span class="p">:</span><span class="mi">0</span><span class="w">                          </span><span class="o">-------------------</span><span class="w"> </span><span class="n">CONFIG_ARCH_START_ADDRESS</span>

<span class="cp">#define KASAN_SHADOW_SIZE   (CONFIG_ARCH_MEM_LENGTH&gt;&gt;3) </span><span class="c1">// ç›¸å½“äºé™¤ä»¥8</span>
<span class="cp">#define KASAN_SHADOW_START  (CONFIG_ARCH_START_ADDRESS + CONFIG_ARCH_MEM_LENGTH - KASAN_SHADOW_SIZE)</span>
<span class="cp">#define KASAN_SHADOW_OFFSET   (KASAN_SHADOW_START - (CONFIG_ARCH_START_ADDRESS&gt;&gt;3))</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">kasan_mem_to_shadow</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">KASAN_SHADOW_SCALE_SHIFT</span><span class="p">)</span>
<span class="w">           </span><span class="o">+</span><span class="w"> </span><span class="n">KASAN_SHADOW_OFFSET</span><span class="p">;</span>
<span class="w">    </span><span class="n">å®é™…</span><span class="o">=</span><span class="w"> </span><span class="n">KASAN_SHADOW_START</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">KASAN_SHADOW_SCALE_SHIFT</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">CONFIG_ARCH_START_ADDRESS</span><span class="o">&gt;&gt;</span><span class="mi">3</span>
<span class="w">    </span><span class="n">addrè‚¯å®šæ¯”CONFIG_ARCH_START_ADDRESSè¦å¤§</span><span class="err">ï¼Œ</span><span class="n">ä¹Ÿå°±æ˜¯è¯´</span><span class="err">ï¼Œ</span><span class="n">shadowçš„å¼€å§‹åœ°å€è¦å…ˆå‡æ‰</span>
<span class="w">    </span><span class="n">arch_startä¹‹å‰çš„åœ°å€</span><span class="err">ï¼Œ</span><span class="n">è¿™æ ·é¿å…æµªè´¹ç©ºé—´</span><span class="err">ã€‚</span>
<span class="p">}</span>

<span class="n">é€šè¿‡åˆ†é…çš„åœ°å€æŸ¥æ‰¾å¯¹åº”shadowåœ°å€</span><span class="err">ï¼Œ</span><span class="n">å†…å­˜åˆ†é…æ˜¯8å­—èŠ‚å¯¹é½åˆ†é…</span><span class="err">ï¼Œ</span><span class="n">å¦‚åˆ†é…3å­—èŠ‚</span><span class="err">ï¼Œ</span><span class="n">å®é™…ä¹Ÿæ˜¯8å­—èŠ‚ç©ºé—´</span><span class="err">ã€‚</span>
</code></pre></div>
<h3 id="__asan_loadstore">__asan_load/storeå®šä¹‰</h3>
<div class="codehilite"><pre><span></span><code><span class="cp">#define DEFINE_ASAN_LOAD_STORE(size)                    \\</span>
<span class="cp">    void __asan_load##size(unsigned long addr)          \\</span>
<span class="cp">    {                               \\</span>
<span class="cp">    KASAN_CHECK_ADDR_FILTER(addr);\\</span>
<span class="cp">        check_memory_region_inline(addr, size, false, _RET_IP_);\\</span>
<span class="cp">    }                               \\</span>
<span class="cp">    __alias(__asan_load##size)                  \\</span>
<span class="cp">    void __asan_load##size##_noabort(unsigned long);        \\</span>
<span class="cp">    void __asan_store##size(unsigned long addr)         \\</span>
<span class="cp">    {                               \\</span>
<span class="cp">    KASAN_CHECK_ADDR_FILTER(addr);\\</span>
<span class="cp">        check_memory_region_inline(addr, size, true, _RET_IP_); \\</span>
<span class="cp">    }                               \\</span>
<span class="cp">    __alias(__asan_store##size)                 \\</span>
<span class="cp">    void __asan_store##size##_noabort(unsigned long);       \\</span>

<span class="n">DEFINE_ASAN_LOAD_STORE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">DEFINE_ASAN_LOAD_STORE</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">DEFINE_ASAN_LOAD_STORE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="n">DEFINE_ASAN_LOAD_STORE</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="n">DEFINE_ASAN_LOAD_STORE</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
</code></pre></div>
<p>ä¸Šé¢çš„å‡½æ•°å±•å¼€åå¾—åˆ°</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">__asan_load1</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">KASAN_CHECK_ADDR_FILTER</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="n">check_memory_region_inline</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">_RET_IP_</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">__alias</span><span class="p">(</span><span class="n">__asan_load1</span><span class="p">)</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__asan_load1_noabort</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">__asan_store1</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">KASAN_CHECK_ADDR_FILTER</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="n">check_memory_region_inline</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">_RET_IP_</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">__alias</span><span class="p">(</span><span class="n">__asan_store1</span><span class="p">)</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__asan_store1_noabort</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">__asan_load2</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">KASAN_CHECK_ADDR_FILTER</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="n">check_memory_region_inline</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">_RET_IP_</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">__alias</span><span class="p">(</span><span class="n">__asan_load2</span><span class="p">)</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__asan_load2_noabort</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">__asan_store2</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">KASAN_CHECK_ADDR_FILTER</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="n">check_memory_region_inline</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">_RET_IP_</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">__alias</span><span class="p">(</span><span class="n">__asan_store2</span><span class="p">)</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__asan_store2_noabort</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">__asan_load4</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">KASAN_CHECK_ADDR_FILTER</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="n">check_memory_region_inline</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">_RET_IP_</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">__alias</span><span class="p">(</span><span class="n">__asan_load4</span><span class="p">)</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__asan_load4_noabort</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">__asan_store4</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">KASAN_CHECK_ADDR_FILTER</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="n">check_memory_region_inline</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">_RET_IP_</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">__alias</span><span class="p">(</span><span class="n">__asan_store4</span><span class="p">)</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__asan_store4_noabort</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">__asan_load8</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">KASAN_CHECK_ADDR_FILTER</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="n">check_memory_region_inline</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">_RET_IP_</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">__alias</span><span class="p">(</span><span class="n">__asan_load8</span><span class="p">)</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__asan_load8_noabort</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">__asan_store8</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">KASAN_CHECK_ADDR_FILTER</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="n">check_memory_region_inline</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">_RET_IP_</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">__alias</span><span class="p">(</span><span class="n">__asan_store8</span><span class="p">)</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__asan_store8_noabort</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">__asan_load16</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">KASAN_CHECK_ADDR_FILTER</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="n">check_memory_region_inline</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">_RET_IP_</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">__alias</span><span class="p">(</span><span class="n">__asan_load16</span><span class="p">)</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__asan_load16_noabort</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">__asan_store16</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">KASAN_CHECK_ADDR_FILTER</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="n">check_memory_region_inline</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">_RET_IP_</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">__alias</span><span class="p">(</span><span class="n">__asan_store16</span><span class="p">)</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__asan_store16_noabort</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
</code></pre></div>
<p>__aliasæ˜¯ç»™å‡½æ•°èµ·ä¸€ä¸ªåˆ«åï¼Œä»ä¸Šå¯çŸ¥ï¼Œå®šä¹‰äº†å¦‚ä¸‹å‡ ä¸ªå‡½æ•°çš„å®ç°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">__asan_loadx</span>

<span class="n">__asan_loadx</span>
<span class="n">__asan_loadx_noabort</span>

<span class="n">å…¶ä¸­xä¸º1</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="mi">16</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">__asan_loadx</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">KASAN_CHECK_ADDR_FILTER</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">CONFIG_ARCH_START_ADDRESS</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">CONFIG_ARCH_START_ADDRESS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CONFIG_ARCH_MEM_LENGTH</span><span class="p">)))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="n">ä¸Šé¢ä»£ç çš„æ„æ€å°±æ˜¯</span><span class="err">ï¼Œ</span><span class="n">åªå¯¹ç‰¹å®šèŒƒå›´çš„åœ°å€åšæ£€æµ‹</span><span class="err">ï¼Œ</span><span class="n">ä¸å†è¯¥èŒƒå›´çš„ä¸æ£€æŸ¥</span><span class="err">ï¼Œ</span><span class="n">æ¯”å¦‚XIPçš„ä»£ç </span><span class="err">ï¼Œ</span><span class="n">æ²¡å¿…è¦æ£€æµ‹</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">check_memory_region_inline</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">_RET_IP_</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_5">æ£€æµ‹</h3>
<h4 id="124816">1/2/4/8/16å­—èŠ‚</h4>
<p>ä»¥4å­—èŠ‚çš„æ¥åšç¤ºä¾‹åˆ†æï¼Œå…¶ä»–çš„ç±»ä¼¼ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">memory_is_poisoned_4</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">kasan_mem_to_shadow</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//è·å–å½±å­åŒºçš„å€¼</span>
<span class="w">    </span><span class="c1">//å¦‚æœå½±å­åŒºçš„å€¼ä¸ç­‰äºç»§ç»­æ£€æŸ¥ï¼Œå¯èƒ½æ˜¯ä¸å¯¹é½çš„æƒ…å†µï¼Œæ¯”å¦‚åˆ†é…äº†3å­—èŠ‚ï¼Œæœ‰5å­—èŠ‚å±äºredzone</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">shadow_addr</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//åˆ¤æ–­ç¬¬4ä¸ªå­—èŠ‚æ˜¯å¦å¯è®¿é—®ï¼Œå¦‚æœä¸å¯è®¿é—®è¯´æ˜éæ³•ã€‚</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memory_is_poisoned_1</span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * If single shadow byte covers 4-byte access, we don't</span>
<span class="cm">         * need to do anything more. Otherwise, test the first</span>
<span class="cm">         * shadow byte.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="c1">//å¦‚æœç¬¬4å­—èŠ‚ä¸ºåˆæ³•ï¼Œæ»¡è¶³*shadow &gt;= (addr &amp; 7) + N åˆ™åˆæ³•ï¼Œå¦åˆ™éæ³•ã€‚</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(((</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KASAN_SHADOW_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shadow_addr</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">memory_is_poisoned_1</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int8_t</span><span class="w"> </span><span class="n">shadow_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">kasan_mem_to_shadow</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//è·å–å½±å­åŒºçš„å€¼</span>
<span class="w">    </span><span class="c1">//å¦‚æœå½±å­åŒºçš„å€¼ä¸ç­‰äº0ï¼Œå³è¿›ä¸€æ­¥åˆ¤æ–­</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">shadow_value</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//åˆ¤æ–­åŸç†ä¸å‰é¢ç®—æ³•ä¸€è‡´ï¼š *shadow &lt; (addr &amp; 7) + Nä¸ºéæ³•ï¼Œå¦åˆ™ä¸ºåˆæ³•ã€‚</span>
<span class="w">        </span><span class="kt">int8_t</span><span class="w"> </span><span class="n">last_accessible_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KASAN_SHADOW_MASK</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">unlikely</span><span class="p">(</span><span class="n">last_accessible_byte</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">shadow_value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="n">Nå­—èŠ‚</h4>
<div class="codehilite"><pre><span></span><code><span class="o">*</span><span class="w"> </span><span class="n">åˆ¤æ–­å†…å­˜å¯¹åº”çš„å½±å­å†…å­˜ä¸­</span><span class="err">ï¼Œ</span><span class="n">èµ·å§‹å’Œç»“æŸshadowå€¼æ˜¯å¦éƒ½ä¸º</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span>
<span class="w">  </span><span class="n">ç»“æŸåœ°å€æ˜¯å¯¹åº”åœ°å€é•¿åº¦çš„å½±å­åœ°å€çš„ä¸‹ä¸€ä¸ªå½±å­åœ°å€</span><span class="w"> </span><span class="o">*/</span>
<span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory_is_zero</span><span class="p">(</span><span class="n">kasan_mem_to_shadow</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">),</span>
<span class="w">              </span><span class="n">kasan_mem_to_shadow</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">last_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">last_shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">kasan_mem_to_shadow</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">last_byte</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/*å¦‚æœret!=last_shadow é‚£ä¹ˆåœ¨è¿ç»­çš„å†…å­˜æ£€æµ‹è¿‡ç¨‹ä¸­ï¼Œå°±å·²ç»æ£€æµ‹åˆ°äº†</span>
<span class="cm">    ä¸€ä¸ªéæ³•æƒé™ï¼Œå³æœ‰é—®é¢˜ */</span>
<span class="w">    </span><span class="cm">/* ||åé¢çš„æ£€æµ‹æ–¹æ¡ˆå’Œ memory_is_poisoned_1 å®ç°æ˜¯ç›¸åŒçš„ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">last_shadow</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="n">last_byte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KASAN_SHADOW_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">*</span><span class="n">last_shadow</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="kasan_3">kasanå…¨å±€å˜é‡å®ç°</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_387e97af1705c9901836896aa4d1d771.jpg"><img alt="" src="assets/doc/08-è°ƒè¯•/kasanåŸç†/images/wp_editor_md_387e97af1705c9901836896aa4d1d771.jpg"/></a></p>
<p>ï¼ˆ1ï¼‰å½“ä½¿èƒ½ä½¿èƒ½äº†asan-globals=1å‚æ•°åï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªå…¨å±€å˜é‡å¡«å……red_zoneã€‚ redzoneçš„å¤§å°ä¸º63-(size-1)%32ï¼Œä¸ºäº†ä¿è¯ä¸32å­—èŠ‚å¯¹é½ã€‚ ï¼ˆ2ï¼‰å¡«å……redzoneåï¼Œç¼–è¯‘å™¨ä¼šä¸ºæ¯ä¸ªå˜é‡è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªxxx_nameçš„æ„é€ å‡½æ•°ï¼Œè¯¥æ„é€ å‡½æ•°ä¼šè°ƒç”¨__asan_register_globalsè¿›è¡Œæ³¨å†Œï¼Œå°†å…¨å±€å˜é‡çš„å†…å­˜åŒºåŸŸä¸å½±å­åŒºåŸŸå»ºç«‹æ˜ å°„å¹¶å¡«å……å½±å­åŒºçš„å€¼ï¼Œå¡«å……æ–¹æ³•ä¸heapä¸€è‡´ã€‚</p>
<p>ä»¥ä¸Šæ“ä½œå…¨æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨è¡Œä¸ºï¼Œåº”ç”¨å±‚æœ€ç»ˆè°ƒç”¨do_ctorså›è°ƒè°ƒç”¨æ„é€ å‡½æ•°å³å¯ã€‚è®¿é—®æ—¶åˆ¤æ–­å†…å­˜åˆæ³•æ€§ä¸å‰é¢ç®—æ³•ä¸€è‡´ã€‚</p>
<h3 id="_6">å…¨å±€å˜é‡å½±å­åŒºåˆå§‹åŒ–</h3>
<div class="codehilite"><pre><span></span><code><span class="n">do_ctors</span>
<span class="w">    </span><span class="o">*</span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_ctors_start</span>
<span class="w">    </span><span class="k">for</span><span class="p">(;</span><span class="n">fn</span><span class="o">&lt;</span><span class="w"> </span><span class="n">_ctors_end</span><span class="p">;</span><span class="n">fn</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)();</span>
<span class="w">    </span><span class="n">è°ƒç”¨_ctors_startå’Œ_ctors_endç›´æ¥çš„å›è°ƒå‡½æ•°</span><span class="err">ï¼Œ</span><span class="n">ç”¨äºåˆå§‹åŒ–å…¨å±€å˜é‡çš„shadow</span>
<span class="w">    </span><span class="n">ä¸Šé¢çš„åœ°å€åœ¨é“¾æ¥è„šæœ¬çš„</span>
<span class="cp">#if (defined(CONFIG_KASAN))</span>
<span class="w">        </span><span class="cm">/* .ctors */</span>
<span class="w">        </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="w">    </span><span class="n">__ctors_start__</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span>
<span class="w">    </span><span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(.</span><span class="n">ctors</span><span class="p">))</span>
<span class="w">    </span><span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(.</span><span class="n">init_array</span><span class="p">.</span><span class="o">*</span><span class="p">)))</span>
<span class="w">    </span><span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(.</span><span class="n">init_array</span><span class="p">))</span>
<span class="w">    </span><span class="n">__ctors_end__</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span>
<span class="cp">#endif</span>
</code></pre></div>
<p>å…ˆè°ƒç”¨do_ctorsï¼Œè°ƒç”¨æ¯ä¸ªå·¥å…·é“¾ä¸ºæ¯ä¸ªå˜é‡ç”Ÿæˆçš„æ„é€ å‡½æ•°ï¼Œæ„é€ å‡½æ•°è°ƒç”¨__asan_register_globalsã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">register_global</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kasan_global</span><span class="w"> </span><span class="o">*</span><span class="n">global</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">KASAN_CHECK_ADDR_FILTER</span><span class="p">(</span><span class="n">global</span><span class="o">-&gt;</span><span class="n">beg</span><span class="p">);</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">aligned_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round_up</span><span class="p">(</span><span class="n">global</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">KASAN_SHADOW_SCALE_SIZE</span><span class="p">);</span>

<span class="w">    </span><span class="n">kasan_unpoison_shadow</span><span class="p">(</span><span class="n">global</span><span class="o">-&gt;</span><span class="n">beg</span><span class="p">,</span><span class="w"> </span><span class="n">global</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

<span class="w">    </span><span class="n">kasan_poison_shadow</span><span class="p">(</span><span class="n">global</span><span class="o">-&gt;</span><span class="n">beg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">aligned_size</span><span class="p">,</span>
<span class="w">                        </span><span class="n">global</span><span class="o">-&gt;</span><span class="n">size_with_redzone</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">aligned_size</span><span class="p">,</span>
<span class="w">                        </span><span class="n">KASAN_GLOBAL_REDZONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">__asan_register_globals</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kasan_global</span><span class="w"> </span><span class="o">*</span><span class="n">globals</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">register_global</span><span class="p">(</span><span class="o">&amp;</span><span class="n">globals</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="kasan_4">kasanå±€éƒ¨å˜é‡å®ç°</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_04e317ed980539fbc6aa6a9d75b6e2f8.jpg"><img alt="" src="assets/doc/08-è°ƒè¯•/kasanåŸç†/images/wp_editor_md_04e317ed980539fbc6aa6a9d75b6e2f8.jpg"/></a></p>
<ul>
<li>å·¦è¾¹å¡«å……32å­—èŠ‚ï¼Œå³è¾¹å¡«å……63-(size-1)% 32 å­—èŠ‚ã€‚</li>
<li>shadowåŒºåŸŸè®¡ç®—å…¬å¼ï¼š shadow = (addr &gt;&gt;3) +koffsetã€‚</li>
<li>koffsetç”±ç¼–è¯‘å‚æ•°-fasan-shadow-offset=xxxæŒ‡å®šã€‚</li>
<li>shadowåŒºåŸŸ KSAN_STACK_å¯è¯»å†™åŒº 0x00 KASAN_STACK_LEFT 0xF1 KASAN_STACK_MID 0xF2 --åªæœ‰ä¸€ä¸ªå˜é‡ä¸”æ˜¯32å­—èŠ‚å¯¹é½çš„ï¼Œä¸ä¼šå¡«å…… KASAN_STACK_RIGHT 0xF3 KASAN_STACK_PARTAL 0xF4</li>
</ul>
<p>ç¤ºä¾‹ï¼š ï¼ˆint *) (0xc18a6d0 &gt;&gt; 3 + 0xaf00000) = KASAN_STACK_LEFT ä»¥ä¸Šæ“ä½œå…¨æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨è¡Œä¸ºï¼Œç”¨æˆ·åªéœ€è¦ä½¿èƒ½ç¼–è¯‘å‚æ•°å³å¯ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">rz1</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="w"> </span><span class="c1">// 32-byte aligned</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">328</span><span class="p">];</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">rz2</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">rz3</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">rz1</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kOffset</span><span class="p">;</span><span class="w">   </span><span class="c1">//è®¡ç®—å˜é‡æ˜ å°„shadowåŒºçš„èµ·å§‹åœ°å€</span>
<span class="w">    </span><span class="n">shadow</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span><span class="w"> </span><span class="c1">// poison rz1</span>
<span class="w">    </span><span class="n">shadow</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffffff00</span><span class="p">;</span><span class="w"> </span><span class="c1">// poison rz2</span>
<span class="w">    </span><span class="n">shadow</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span><span class="w"> </span><span class="c1">// poison rz3</span>
<span class="w">    </span><span class="o">&lt;-------------</span><span class="w"> </span><span class="n">CODE</span><span class="w"> </span><span class="o">-------------&gt;</span>
<span class="w">    </span><span class="n">shadow</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shadow</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shadow</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span>
<span class="p">}</span>
</code></pre></div>
<p>å®˜æ–¹è§£é‡Šç®—æ³•å¦‚ä¸Šï¼Œå½“å·¥å…·é“¾æ¥åŠ ä¸Š--param asan-stack=1ï¼Œå±€éƒ¨å˜é‡redzoneå¡«å……ä»¥åŠshadowæ˜ å°„å¡«å……å€¼å…¨å·¥å…·é“¾è‡ªåŠ¨å®Œæˆã€‚å¯¹åº”å±€éƒ¨å˜é‡éœ€è¦å·¦å³éƒ½éœ€è¦å¡«å……redzoneï¼Œæ‰€ä»¥å¯ä»¥åˆ’åˆ†ä¸ºä»¥ä¸‹4ä¸ªéƒ¨åˆ†ã€‚</p>
<ul>
<li>left redzoneï¼š 32å­—èŠ‚ã€‚</li>
<li>å˜é‡é•¿åº¦ï¼šå®é™…çš„å˜é‡é•¿åº¦</li>
<li>mid redzoneï¼šè¯¥åŒºåŸŸæœ‰ä¸¤ä¸ªç”¨é€”â‘ æ˜¯è¡¥é½å˜é‡é•¿åº¦ï¼Œè®©å…¶32å­—èŠ‚å¯¹é½ã€‚â‘¡æ˜¯å½“å­˜åœ¨å¤šä¸ªå˜é‡æ—¶ï¼Œç”¨äºä¸­é—´åŒºåŸŸçš„éš”ç¦»ã€‚å½“å˜é‡é•¿åº¦ä¸æ˜¯32å­—èŠ‚å¯¹é½çš„ï¼Œå¡«å……é•¿åº¦æ˜¯å˜é‡é•¿åº¦+mid redzoneé•¿åº¦èƒ½å¤Ÿ32å­—èŠ‚å¯¹é½ã€‚mid redzone= 63-(size-1)%32 -32ã€‚å½“å­˜åœ¨å¤šä¸ªå˜é‡ä¸­ï¼Œå˜é‡ä¸å˜é‡ä¹‹é—´è‡³å°‘è¦æœ‰32å­—èŠ‚ç”¨äºéš”ç¦»ã€‚</li>
<li>right redzone:32å­—èŠ‚ã€‚</li>
</ul>
<p>å¯¹äºä¸Šé¢4ä¸ªå†…å­˜åŒºåŸŸï¼Œä¹Ÿå¯ä»¥å°†shadowæ˜ å°„åŒºåˆ’åˆ†ä¸º4ä¸ªéƒ¨åˆ†</p>
<ul>
<li>left redzone shadow: å¡«å……0xF1</li>
<li>å˜é‡é•¿åº¦ï¼šéƒ½å¡«å……0x0;</li>
<li>mid redzone: å¡«å……0xF2</li>
<li>right redzone: å¡«å……0xF3ï¼›</li>
</ul>
<p>æ³¨æ„ï¼š å½“åªæœ‰ä¸€ä¸ªå˜é‡ä¸”è¯¥å˜é‡é•¿åº¦æ˜¯32å­—èŠ‚å¯¹é½ï¼Œåˆ™æ²¡æœ‰mid redzoneåŒºåŸŸã€‚ <a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_87f6f4408686414982d8cc31ae1f23c4.jpg"><img alt="" src="assets/doc/08-è°ƒè¯•/kasanåŸç†/images/wp_editor_md_87f6f4408686414982d8cc31ae1f23c4.jpg"/></a></p>
<p>ä¸‹é¢æ¥æ®µå®éªŒï¼Œå®šä¹‰äº†è¿™ä¹ˆä¸€æ®µä»£ç ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">test_asan_xxx</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">328</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mi">328</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>ä¸‹é¢æ˜¯åæ±‡ç¼–çš„ç»“æœ</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">test_asan_xxx</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w"> </span><span class="nl">c0efd34</span><span class="p">:</span><span class="w">   </span><span class="mi">7121</span><span class="w">                    </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">-448</span><span class="w">   </span><span class="c1">//å¼€è¾Ÿ448ç©ºé—´å†…å­˜</span>
<span class="w"> </span><span class="nl">c0efd36</span><span class="p">:</span><span class="w">   </span><span class="n">f1f1f7b7</span><span class="w">            </span><span class="n">lui</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="mh">0xf1f1f</span><span class="w">           </span><span class="c1">//a5=0xf1f1f&lt;&lt;12</span>
<span class="w"> </span><span class="nl">c0efd3a</span><span class="p">:</span><span class="w">   </span><span class="n">fb22</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s0</span><span class="p">,</span><span class="mi">432</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="w">       </span><span class="c1">//å°†s0å­˜å‚¨åˆ°sp+432ä½ç½®</span>
<span class="w"> </span><span class="nl">c0efd3c</span><span class="p">:</span><span class="w">   </span><span class="n">f726</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s1</span><span class="p">,</span><span class="mi">424</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="w">       </span><span class="c1">//å°†s1å­˜å‚¨åˆ°sp+424ä½ç½®</span>
<span class="w"> </span><span class="nl">c0efd3e</span><span class="p">:</span><span class="w">   </span><span class="n">f34a</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s2</span><span class="p">,</span><span class="mi">416</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="w">       </span><span class="c1">//å°†s2å­˜å‚¨åˆ°sp+416ä½ç½®</span>
<span class="w"> </span><span class="nl">c0efd40</span><span class="p">:</span><span class="w">   </span><span class="n">ff06</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">ra</span><span class="p">,</span><span class="mi">440</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="w">       </span><span class="c1">//å°†raå­˜å‚¨åˆ°sp+440ä½ç½®</span>
<span class="w"> </span><span class="c1">//å¼€è¾Ÿä¸€ä¸ªæ ˆç©ºé—´ä¸º448å­—èŠ‚ï¼Œå¹¶ä¸”å°†a5=0xf1f1f000</span>
<span class="w"> </span><span class="c1">//å°†s0,s1,s2,raå‹å…¥æ ˆä¸­ã€‚</span>

<span class="w"> </span><span class="nl">c0efd42</span><span class="p">:</span><span class="w">   </span><span class="mi">840</span><span class="n">a</span><span class="w">                    </span><span class="n">mv</span><span class="w">  </span><span class="n">s0</span><span class="p">,</span><span class="n">sp</span><span class="w">            </span><span class="c1">//s0æŒ‡å‘spï¼Œå³å¡«å……32å­—èŠ‚çš„åœ°å€</span>
<span class="w"> </span><span class="nl">c0efd44</span><span class="p">:</span><span class="w">   </span><span class="mf">1f</span><span class="mi">17879</span><span class="n">b</span><span class="w">            </span><span class="n">addiw</span><span class="w">   </span><span class="n">a5</span><span class="p">,</span><span class="n">a5</span><span class="p">,</span><span class="mi">497</span><span class="w">        </span><span class="c1">//a5 = 0xf1f1f1f1</span>
<span class="w"> </span><span class="nl">c0efd48</span><span class="p">:</span><span class="w">   </span><span class="mi">800</span><span class="n">d</span><span class="w">                    </span><span class="n">srli</span><span class="w">    </span><span class="n">s0</span><span class="p">,</span><span class="n">s0</span><span class="p">,</span><span class="mh">0x3</span><span class="w">    </span><span class="c1">//s0 = s0 &gt;&gt; 3</span>
<span class="w"> </span><span class="nl">c0efd4a</span><span class="p">:</span><span class="w">   </span><span class="mi">0</span><span class="n">af00937</span><span class="w">            </span><span class="n">lui</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="mh">0xaf00</span><span class="w">            </span><span class="c1">//s2 = 0xaf00000,å³koffset</span>
<span class="w"> </span><span class="nl">c0efd4e</span><span class="p">:</span><span class="w">   </span><span class="mi">4089578</span><span class="n">b</span><span class="w">            </span><span class="n">srw</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s0</span><span class="p">,</span><span class="mi">0</span><span class="w">           </span><span class="c1">//*(s0&gt;&gt;0 + s2)=a5</span>
<span class="w"> </span><span class="c1">//å†™KASAN_STACK_LEFT</span>
<span class="w"> </span><span class="c1">//å¯¹å˜é‡çš„å‰32å­—èŠ‚ shadowæ˜ å°„åŒºå¡«å……0xf1f1f1f1(8å­—èŠ‚æ˜ å°„1å­—èŠ‚)</span>
<span class="w"> </span><span class="c1">//int *shadow = (sp &gt;&gt; 3) + koffset;</span>
<span class="w"> </span><span class="c1">//shadowåŒºåŸŸæ˜¯æŒ‰ç…§4å­—èŠ‚å¯¹é½å­˜å‚¨ï¼Œå¯¹åº”çš„å˜é‡å°±æ˜¯32å­—èŠ‚ã€‚</span>
<span class="w"> </span><span class="c1">// shadow[0] = 0xf1f1f1f1</span>

<span class="w"> </span><span class="nl">c0efd52</span><span class="p">:</span><span class="w">   </span><span class="n">f2f2f7b7</span><span class="w">            </span><span class="n">lui</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="mh">0xf2f2f</span><span class="w">    </span><span class="c1">//a5 = 0xf2f2f000</span>
<span class="w"> </span><span class="nl">c0efd56</span><span class="p">:</span><span class="w">   </span><span class="mi">2007879</span><span class="n">b</span><span class="w">            </span><span class="n">addiw</span><span class="w">   </span><span class="n">a5</span><span class="p">,</span><span class="n">a5</span><span class="p">,</span><span class="mi">512</span><span class="w"> </span><span class="c1">//a5 = 0xf2f2f200</span>
<span class="w"> </span><span class="nl">c0efd5a</span><span class="p">:</span><span class="w">   </span><span class="mo">00</span><span class="mi">8904</span><span class="n">b3</span><span class="w">            </span><span class="n">add</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s0</span><span class="w">      </span><span class="c1">//s1 = s2 +s0ï¼Œå³32å­—èŠ‚æ˜ å°„åŒºåœ°å€</span>
<span class="w"> </span><span class="nl">c0efd5e</span><span class="p">:</span><span class="w">   </span><span class="n">d4dc</span><span class="w">                    </span><span class="n">sw</span><span class="w">  </span><span class="n">a5</span><span class="p">,</span><span class="mi">44</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span><span class="w"> </span><span class="c1">//ä»32å­—èŠ‚æ˜ å°„åŒºåç§»44å­—èŠ‚å†™å…¥0xf2f2f200</span>
<span class="c1">//å†™KASAN_STACK_MIDï¼ˆåŒ…å«æ•°æ®åŒºå¯¹é½32å­—èŠ‚åå‰©ä½™éƒ¨åˆ†çš„shadowï¼‰</span>
<span class="c1">//å› ä¸ºæ•°ç»„é•¿åº¦æ˜¯328å­—èŠ‚ï¼Œå¯¹åº”çš„shadowæ˜¯41å­—èŠ‚ï¼Œshodowæ˜¯æ¯4å­—èŠ‚å­˜å‚¨ï¼Œæ‰€ä»¥å‰©ä½™1å­—èŠ‚</span>
<span class="c1">//å°±éšç€REDZONEæ˜ å°„shadowåŒºåŸŸä¸€èµ·å¡«å……ï¼Œä½™ä¸‹çš„3å­—èŠ‚å°±å¡«å……f2ã€‚</span>
<span class="c1">//æ‰€ä»¥STACK_MIDå°±æ˜¯åç§»44çš„ä½ç½®ã€‚</span>

<span class="w"> </span><span class="nl">c0efd60</span><span class="p">:</span><span class="w">   </span><span class="n">f3f3f7b7</span><span class="w">            </span><span class="n">lui</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="mh">0xf3f3f</span>
<span class="w"> </span><span class="nl">c0efd64</span><span class="p">:</span><span class="w">   </span><span class="mf">3f</span><span class="mi">37879</span><span class="n">b</span><span class="w">            </span><span class="n">addiw</span><span class="w">   </span><span class="n">a5</span><span class="p">,</span><span class="n">a5</span><span class="p">,</span><span class="mi">1011</span>
<span class="w"> </span><span class="nl">c0efd68</span><span class="p">:</span><span class="w">   </span><span class="n">d89c</span><span class="w">                    </span><span class="n">sw</span><span class="w">  </span><span class="n">a5</span><span class="p">,</span><span class="mi">48</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span><span class="w">       </span><span class="c1">//0xc73150aåœ°å€å†…å®¹=0xf3f3f3f3</span>
<span class="c1">//å†™KASAN_STACK_RIGHT</span>
<span class="c1">//æœ€åä½™ä¸‹32å­—èŠ‚redzoneï¼Œå¯¹åº”4å­—èŠ‚å¡«å……f3</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">328</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mi">328</span><span class="p">);</span>
<span class="w"> </span><span class="nl">c0efd6a</span><span class="p">:</span><span class="w">   </span><span class="mi">1008</span><span class="w">                    </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">32</span>
<span class="w"> </span><span class="nl">c0efd6c</span><span class="p">:</span><span class="w">   </span><span class="mi">14800613</span><span class="w">            </span><span class="n">li</span><span class="w">  </span><span class="n">a2</span><span class="p">,</span><span class="mi">328</span>
<span class="w"> </span><span class="nl">c0efd70</span><span class="p">:</span><span class="w">   </span><span class="mi">4581</span><span class="w">                    </span><span class="n">li</span><span class="w">  </span><span class="n">a1</span><span class="p">,</span><span class="mi">0</span>
<span class="w"> </span><span class="nl">c0efd72</span><span class="p">:</span><span class="w">   </span><span class="n">acfc20ef</span><span class="w">            </span><span class="n">jal</span><span class="w"> </span><span class="n">ra</span><span class="p">,</span><span class="n">c0b2840</span><span class="w"> </span><span class="o">&lt;</span><span class="n">memset</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="w"> </span><span class="nl">c0efd76</span><span class="p">:</span><span class="w">   </span><span class="mi">4089500</span><span class="n">b</span><span class="w">            </span><span class="n">srw</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s0</span><span class="p">,</span><span class="mi">0</span>
<span class="p">}</span>
<span class="w"> </span><span class="nl">c0efd7a</span><span class="p">:</span><span class="w">   </span><span class="mf">70f</span><span class="n">a</span><span class="w">                    </span><span class="n">ld</span><span class="w">  </span><span class="n">ra</span><span class="p">,</span><span class="mi">440</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w"> </span><span class="nl">c0efd7c</span><span class="p">:</span><span class="w">   </span><span class="mi">745</span><span class="n">a</span><span class="w">                    </span><span class="n">ld</span><span class="w">  </span><span class="n">s0</span><span class="p">,</span><span class="mi">432</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w"> </span><span class="nl">c0efd7e</span><span class="p">:</span><span class="w">   </span><span class="mo">0204</span><span class="n">b623</span><span class="w">            </span><span class="n">sd</span><span class="w">  </span><span class="n">zero</span><span class="p">,</span><span class="mi">44</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
<span class="p">}</span>
<span class="w"> </span><span class="nl">c0efd82</span><span class="p">:</span><span class="w">   </span><span class="mi">791</span><span class="n">a</span><span class="w">                    </span><span class="n">ld</span><span class="w">  </span><span class="n">s2</span><span class="p">,</span><span class="mi">416</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w"> </span><span class="nl">c0efd84</span><span class="p">:</span><span class="w">   </span><span class="mi">74</span><span class="n">ba</span><span class="w">                    </span><span class="n">ld</span><span class="w">  </span><span class="n">s1</span><span class="p">,</span><span class="mi">424</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w"> </span><span class="nl">c0efd86</span><span class="p">:</span><span class="w">   </span><span class="mi">6139</span><span class="w">                    </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">448</span>
<span class="w"> </span><span class="nl">c0efd88</span><span class="p">:</span><span class="w">   </span><span class="mi">8082</span><span class="w">                    </span><span class="n">ret</span>
</code></pre></div>
<p>å½“å®šä¹‰ä¸¤ä¸ªå˜é‡æ—¶ç¤ºä¾‹</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">test_asan_xxx</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">328</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">144</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mi">328</span><span class="p">);</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mi">128</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_1fd4bc82227ef211884a3cba3f0b61c4.jpg"><img alt="" src="assets/doc/08-è°ƒè¯•/kasanåŸç†/images/wp_editor_md_1fd4bc82227ef211884a3cba3f0b61c4.jpg"/></a></p>
<p>leftå€¼ä¾æ—§æ˜¯32å­—èŠ‚æ²¡æœ‰å˜åŒ–ï¼Œåœ¨aæ•°ç»„å’Œbæ•°ç»„ä¸­é—´å¡«å……äº†48å­—èŠ‚çš„mid redzoneï¼Œå…¶ä¸­mid[16]å­—èŠ‚æ˜¯ä¸ºäº†å¯¹é½bæ•°ç»„è®©å…¶32å­—èŠ‚å¯¹é½çš„ï¼Œè€Œmid[32]æ˜¯ç”¨äºéš”ç¦»a[328]å’Œb[144]æ•°ç»„çš„ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="freertosæ ˆæº¢å‡ºæ£€æµ‹åŸç†.html">â† freertosæ ˆæº¢å‡ºæ£€æµ‹åŸç†</a>
    <a class="next" href="risc-v-backtraceå®ç°åŸç†.html">RISC-V backtraceå®ç°åŸç† â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

