<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å°æ™ºAiè¯­éŸ³äº¤äº’ç®€è¦åˆ†æ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#app-start">app start</a><ul></ul></li><li><a href="#mainloop">mainloop</a><ul></ul></li><li><a href="#_1">å½•éŸ³é€šè·¯</a><ul><li><a href="#_2">å½•éŸ³å¤„ç†</a></li><li><a href="#_3">éŸ³æ•ˆå¤„ç†</a></li></ul></li><li><a href="#_4">æ’­æ”¾é€šè·¯</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>å°æ™ºAiè¯­éŸ³äº¤äº’ç®€è¦åˆ†æ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2025-04-03
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      ai
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="app-start">app start</h2>
<p>ä¸»è¦æ˜¯åˆå§‹åŒ–æ¿çº§ã€æ˜¾ç¤ºã€WiFiè¿æ¥ã€éŸ³é¢‘codecã€ç¼–è§£ç ã€åè®®ã€éŸ³æ•ˆã€å”¤é†’å‡ ä¸ªç¯èŠ‚ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="o">::</span><span class="n">GetInstance</span><span class="p">();</span><span class="w"> </span><span class="c1">//è·å–æ¿çº§å®ä¾‹</span>
<span class="w">    </span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">kDeviceStateStarting</span><span class="p">);</span><span class="c1">//è®¾ç½®å‡ºäº‹çŠ¶æ€ä¸ºkDeviceStateStarting</span>

<span class="w">    </span><span class="cm">/* Setup the display */</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">GetDisplay</span><span class="p">();</span><span class="w"> </span><span class="c1">//è·å–æ˜¾ç¤ºå®ä¾‹</span>

<span class="w">    </span><span class="cm">/* Setup the audio codec */</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">GetAudioCodec</span><span class="p">();</span><span class="c1">//è·å–codecå®ä¾‹</span>
<span class="w">    </span><span class="n">opus_decode_sample_rate_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">output_sample_rate</span><span class="p">();</span><span class="c1">//è·å–å½“å‰codecçš„é‡‡æ ·ç‡</span>
<span class="w">    </span><span class="n">opus_decoder_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">OpusDecoderWrapper</span><span class="o">&gt;</span><span class="p">(</span><span class="n">opus_decode_sample_rate_</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="c1">//åˆå§‹åŒ–opusè§£ç ï¼Œè®¾ç½®è§£ç é‡‡æ ·ç‡</span>
<span class="w">    </span><span class="n">opus_encoder_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">OpusEncoderWrapper</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">16000</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">OPUS_FRAME_DURATION_MS</span><span class="p">);</span><span class="c1">//åˆå§‹åŒ–opusç¼–ç ï¼Œè®¾ç½®é‡‡æ ·ç‡16Khz</span>
<span class="w">    </span><span class="c1">// For ML307 boards, we use complexity 5 to save bandwidth</span>
<span class="w">    </span><span class="c1">// For other boards, we use complexity 3 to save CPU</span>
<span class="w">    </span><span class="c1">//æ ¹æ®æ¿çº§æ¥è®¾ç½®opusç¼–ç çš„å¤æ‚åº¦</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">GetBoardType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"ml307"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">"ML307 board detected, setting opus encoder complexity to 5"</span><span class="p">);</span>
<span class="w">        </span><span class="n">opus_encoder_</span><span class="o">-&gt;</span><span class="n">SetComplexity</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">"WiFi board detected, setting opus encoder complexity to 3"</span><span class="p">);</span>
<span class="w">        </span><span class="n">opus_encoder_</span><span class="o">-&gt;</span><span class="n">SetComplexity</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//å¦‚æœcodecçš„é‡‡æ ·ç‡ä¸æ˜¯16Khzï¼Œéœ€è¦è¿›è¡Œé‡é‡‡æ ·ï¼Œä¸‹é¢æ˜¯é‡é‡‡æ ·åˆå§‹åŒ–ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">input_sample_rate</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">16000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">input_resampler_</span><span class="p">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">input_sample_rate</span><span class="p">(),</span><span class="w"> </span><span class="mi">16000</span><span class="p">);</span>
<span class="w">        </span><span class="n">reference_resampler_</span><span class="p">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">input_sample_rate</span><span class="p">(),</span><span class="w"> </span><span class="mi">16000</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//æ³¨å†Œcodecè¾“å…¥éŸ³é¢‘çš„å›è°ƒï¼Œè¡¨ç¤ºæœ‰å½•éŸ³çš„pcmï¼Œè§¦å‘mainloopå¤„ç†ã€‚</span>
<span class="w">    </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">OnInputReady</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">codec</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">BaseType_t</span><span class="w"> </span><span class="n">higher_priority_task_woken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pdFALSE</span><span class="p">;</span>
<span class="w">        </span><span class="n">xEventGroupSetBitsFromISR</span><span class="p">(</span><span class="n">event_group_</span><span class="p">,</span><span class="w"> </span><span class="n">AUDIO_INPUT_READY_EVENT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">higher_priority_task_woken</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">higher_priority_task_woken</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pdTRUE</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="c1">//æ³¨å†Œcodecè¾“å‡ºéŸ³é¢‘çš„å›è°ƒï¼Œè¡¨ç¤ºæœ‰å½•éŸ³çš„pcmï¼Œè§¦å‘mainloopå¤„ç†ã€‚</span>
<span class="w">    </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">OnOutputReady</span><span class="p">([</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">BaseType_t</span><span class="w"> </span><span class="n">higher_priority_task_woken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pdFALSE</span><span class="p">;</span>
<span class="w">        </span><span class="n">xEventGroupSetBitsFromISR</span><span class="p">(</span><span class="n">event_group_</span><span class="p">,</span><span class="w"> </span><span class="n">AUDIO_OUTPUT_READY_EVENT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">higher_priority_task_woken</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">higher_priority_task_woken</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pdTRUE</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="c1">//å¯åŠ¨ç¡¬ä»¶codecï¼Œä½¿èƒ½å½•éŸ³å’Œæ’­æ”¾ã€‚</span>
<span class="w">    </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">Start</span><span class="p">();</span>
<span class="w">     </span><span class="c1">//å¼€å¯ä¸€ä¸ªmainloopçº¿ç¨‹ï¼Œå¤„ç†ä¸»è¦é€»è¾‘</span>
<span class="w">    </span><span class="cm">/* Start the main loop */</span>
<span class="w">    </span><span class="n">xTaskCreate</span><span class="p">([](</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Application</span><span class="o">*</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Application</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
<span class="w">        </span><span class="n">app</span><span class="o">-&gt;</span><span class="n">MainLoop</span><span class="p">();</span>
<span class="w">        </span><span class="n">vTaskDelete</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="s">"main_loop"</span><span class="p">,</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//ç­‰å¾…WiFiè¿æ¥å¥½</span>
<span class="w">  </span><span class="cm">/* Wait for the network to be ready */</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">StartNetwork</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Initialize the protocol</span>
<span class="w">    </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetStatus</span><span class="p">(</span><span class="n">Lang</span><span class="o">::</span><span class="n">Strings</span><span class="o">::</span><span class="n">LOADING_PROTOCOL</span><span class="p">);</span><span class="c1">//æ˜¾ç¤ºæ­£åœ¨åŠ è½½åè®®</span>
<span class="w">    </span><span class="n">æ ¹æ®ä½¿ç”¨MQTTè¿˜æ˜¯Websocetæ¥é€‰æ‹©é€šä¿¡åè®®</span>
<span class="cp">#ifdef CONFIG_CONNECTION_TYPE_WEBSOCKET</span>
<span class="w">    </span><span class="n">protocol_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">WebsocketProtocol</span><span class="o">&gt;</span><span class="p">();</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">protocol_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">MqttProtocol</span><span class="o">&gt;</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="c1">//æ³¨å†Œç½‘ç»œæ¥æ”¶å¼‚å¸¸å›è°ƒå‡½æ•°</span>
<span class="w">    </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">OnNetworkError</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">kDeviceStateIdle</span><span class="p">);</span>
<span class="w">        </span><span class="n">Alert</span><span class="p">(</span><span class="n">Lang</span><span class="o">::</span><span class="n">Strings</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">"sad"</span><span class="p">,</span><span class="w"> </span><span class="n">Lang</span><span class="o">::</span><span class="n">Sounds</span><span class="o">::</span><span class="n">P3_EXCLAMATION</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="c1">//æ³¨å†Œæ¥æ”¶éŸ³é¢‘çš„å›è°ƒå‡½æ•°ï¼Œæ¥æ”¶åˆ°éŸ³é¢‘åï¼Œå¾€åŠ å…¥è§£ç é˜Ÿåˆ—</span>
<span class="w">    </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">OnIncomingAudio</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateSpeaking</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">audio_decode_queue_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="c1">//æ³¨å†Œæ¥æ”¶åè®®æ‰“å¼€éŸ³é¢‘çš„å›è°ƒï¼Œä¸»è¦æ˜¯ä¸‹å‘è§£ç çš„çš„å±æ€§ä¿¡æ¯ï¼ŒåŒ…æ‹¬é‡‡æ ·ç‡ç­‰ã€‚</span>
<span class="w">    </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">OnAudioChannelOpened</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">codec</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">board</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">board</span><span class="p">.</span><span class="n">SetPowerSaveMode</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">server_sample_rate</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">output_sample_rate</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ESP_LOGW</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">"Server sample rate %d does not match device output sample rate %d, resampling may cause distortion"</span><span class="p">,</span>
<span class="w">                </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">server_sample_rate</span><span class="p">(),</span><span class="w"> </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">output_sample_rate</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">SetDecodeSampleRate</span><span class="p">(</span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">server_sample_rate</span><span class="p">());</span>
<span class="w">        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">thing_manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iot</span><span class="o">::</span><span class="n">ThingManager</span><span class="o">::</span><span class="n">GetInstance</span><span class="p">();</span>
<span class="w">        </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">SendIotDescriptors</span><span class="p">(</span><span class="n">thing_manager</span><span class="p">.</span><span class="n">GetDescriptorsJson</span><span class="p">());</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">states</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">thing_manager</span><span class="p">.</span><span class="n">GetStatesJson</span><span class="p">(</span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">SendIotStates</span><span class="p">(</span><span class="n">states</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="c1">//æ³¨å†ŒéŸ³é¢‘çš„å…³é—­å›è°ƒ</span>
<span class="w">    </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">OnAudioChannelClosed</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">board</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">board</span><span class="p">.</span><span class="n">SetPowerSaveMode</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">        </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="o">::</span><span class="n">GetInstance</span><span class="p">().</span><span class="n">GetDisplay</span><span class="p">();</span>
<span class="w">            </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetChatMessage</span><span class="p">(</span><span class="s">"system"</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">);</span>
<span class="w">            </span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">kDeviceStateIdle</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="c1">//æ³¨å†Œjsonè§£æå›è°ƒï¼Œé€šçŸ¥æ–‡æœ¬ï¼ŒçŠ¶æ€ç­‰ä¿¡æ¯</span>
<span class="w">    </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">OnIncomingJson</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">display</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">cJSON</span><span class="o">*</span><span class="w"> </span><span class="n">root</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Parse JSON data</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="s">"type"</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//æ–‡å­—è½¬è¯­éŸ³çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬startï¼Œstopï¼Œsentence_start/stopï¼ˆå¥å­å¼€å§‹ç»“æŸï¼‰ï¼Œ</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="s">"tts"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="s">"state"</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="s">"start"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">aborted_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateIdle</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateListening</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">kDeviceStateSpeaking</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="s">"stop"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateSpeaking</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">background_task_</span><span class="o">-&gt;</span><span class="n">WaitForCompletion</span><span class="p">();</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keep_listening_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">SendStartListening</span><span class="p">(</span><span class="n">kListeningModeAutoStop</span><span class="p">);</span>
<span class="w">                            </span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">kDeviceStateListening</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">kDeviceStateIdle</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="c1">//å¥å­å¼€å§‹</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="s">"sentence_start"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="s">"text"</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">text</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">"&lt;&lt; %s"</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">);</span>
<span class="w">                    </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">display</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">text</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">)]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetChatMessage</span><span class="p">(</span><span class="s">"assistant"</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">                    </span><span class="p">});</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="o">=</span><span class="c1">//sttï¼šè¯­éŸ³è½¬æ–‡å­—ä¿¡æ¯</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="s">"stt"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="s">"text"</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">text</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">"&gt;&gt; %s"</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">);</span>
<span class="w">                </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">display</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">text</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">)]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetChatMessage</span><span class="p">(</span><span class="s">"user"</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="s">"llm"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">emotion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="s">"emotion"</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">emotion</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">display</span><span class="p">,</span><span class="w"> </span><span class="n">emotion_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">emotion</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">)]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetEmotion</span><span class="p">(</span><span class="n">emotion_str</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="s">"iot"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="s">"commands"</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">commands</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">thing_manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iot</span><span class="o">::</span><span class="n">ThingManager</span><span class="o">::</span><span class="n">GetInstance</span><span class="p">();</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cJSON_GetArraySize</span><span class="p">(</span><span class="n">commands</span><span class="p">);</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">auto</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_GetArrayItem</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">                    </span><span class="n">thing_manager</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="c1">//å¯åŠ¨åè®®</span>
<span class="w">    </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">Start</span><span class="p">();</span>
<span class="w">    </span><span class="c1">//æ£€æµ‹OTAçš„ç‰ˆæœ¬ï¼Œå¦‚æœç‰ˆæœ¬æ¯”è¾ƒä½åˆ™è¿›è¡Œå‡çº§</span>
<span class="w">    </span><span class="c1">// Check for new firmware version or get the MQTT broker address</span>
<span class="w">    </span><span class="n">ota_</span><span class="p">.</span><span class="n">SetCheckVersionUrl</span><span class="p">(</span><span class="n">CONFIG_OTA_VERSION_URL</span><span class="p">);</span>
<span class="w">    </span><span class="n">ota_</span><span class="p">.</span><span class="n">SetHeader</span><span class="p">(</span><span class="s">"Device-Id"</span><span class="p">,</span><span class="w"> </span><span class="n">SystemInfo</span><span class="o">::</span><span class="n">GetMacAddress</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">    </span><span class="n">ota_</span><span class="p">.</span><span class="n">SetHeader</span><span class="p">(</span><span class="s">"Client-Id"</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">GetUuid</span><span class="p">());</span>
<span class="w">    </span><span class="n">ota_</span><span class="p">.</span><span class="n">SetHeader</span><span class="p">(</span><span class="s">"Accept-Language"</span><span class="p">,</span><span class="w"> </span><span class="n">Lang</span><span class="o">::</span><span class="n">CODE</span><span class="p">);</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">app_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">esp_app_get_description</span><span class="p">();</span>
<span class="w">    </span><span class="n">ota_</span><span class="p">.</span><span class="n">SetHeader</span><span class="p">(</span><span class="s">"User-Agent"</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">BOARD_NAME</span><span class="w"> </span><span class="s">"/"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">app_desc</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

<span class="w">    </span><span class="n">xTaskCreate</span><span class="p">([](</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Application</span><span class="o">*</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Application</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
<span class="w">        </span><span class="n">app</span><span class="o">-&gt;</span><span class="n">CheckNewVersion</span><span class="p">();</span>
<span class="w">        </span><span class="n">vTaskDelete</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="s">"check_new_version"</span><span class="p">,</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>

<span class="cp">#if CONFIG_USE_AUDIO_PROCESSOR</span>
<span class="w">    </span><span class="c1">//åˆå§‹åŒ–éŸ³é¢‘å¤„ç†ï¼Œä¸»è¦æ˜¯é™å™ªï¼Œå›å£°æ¶ˆé™¤ï¼ŒVADæ£€æµ‹ç­‰ã€‚</span>
<span class="w">    </span><span class="n">audio_processor_</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">input_channels</span><span class="p">(),</span><span class="w"> </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">input_reference</span><span class="p">());</span>
<span class="w">    </span><span class="n">audio_processor_</span><span class="p">.</span><span class="n">OnOutput</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">background_task_</span><span class="o">-&gt;</span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">)]()</span><span class="w"> </span><span class="k">mutable</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">opus_encoder_</span><span class="o">-&gt;</span><span class="n">Encode</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">opus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//å¦‚æœå¯åŠ¨äº†éŸ³æ•ˆå¤„ç†ï¼Œæ³¨å†Œouputçš„è¾“å‡ºå›è°ƒã€‚</span>
<span class="w">                </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">opus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">opus</span><span class="p">)]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">SendAudio</span><span class="p">(</span><span class="n">opus</span><span class="p">);</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="c1">//æ³¨å†ŒVADçŠ¶æ€å˜åŒ–</span>
<span class="w">    </span><span class="n">audio_processor_</span><span class="p">.</span><span class="n">OnVadStateChange</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="kt">bool</span><span class="w"> </span><span class="n">speaking</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateListening</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">speaking</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">speaking</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">voice_detected_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">voice_detected_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="o">::</span><span class="n">GetInstance</span><span class="p">().</span><span class="n">GetLed</span><span class="p">();</span>
<span class="w">                </span><span class="n">led</span><span class="o">-&gt;</span><span class="n">OnStateChanged</span><span class="p">();</span><span class="c1">//åªç‚¹ä¸ªç¯ï¼Ÿï¼Ÿ</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="cp">#endif</span>

<span class="cp">#if CONFIG_USE_WAKE_WORD_DETECT</span>
<span class="w">    </span><span class="c1">//å¯åŠ¨å”¤é†’æ£€æµ‹ï¼Œåˆå§‹åŒ–å”¤é†’</span>
<span class="w">    </span><span class="n">wake_word_detect_</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">input_channels</span><span class="p">(),</span><span class="w"> </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">input_reference</span><span class="p">());</span>
<span class="w">    </span><span class="c1">//å”¤é†’è¯å¤„ç†å›è°ƒå‡½æ•°ï¼Œå…¶ä¸­è·å–åˆ°çš„å”¤é†’è¯æ˜¯å­—ç¬¦ä¸²ï¼Œè¿˜åŒ…æ‹¬è·å–å¤„ç†å”¤é†’è¯çš„éŸ³é¢‘ç¼–è§£ç </span>
<span class="w">    </span><span class="c1">//å”¤é†’è¯éŸ³é¢‘éƒ¨åˆ†æ˜¯å¦ä»…ä»…æ˜¯å”¤é†’è¯éƒ¨åˆ†ï¼Œè¿˜åŒ…å«å…¶ä»–å†…å®¹æ•°æ®ï¼Ÿéœ€è¦ç¡®è®¤</span>
<span class="w">    </span><span class="n">wake_word_detect_</span><span class="p">.</span><span class="n">OnWakeWordDetected</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">wake_word</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wake_word</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//å¦‚æœæ˜¯idleçŠ¶æ€ï¼Œä¸»è¦é€»è¾‘æ˜¯ï¼Œå¤„ç†ä¸šåŠ¡ä¸ºè¿æ¥ç½‘ç»œï¼Œç¼–ç å”¤é†’è¯ï¼Œé‡å¼€å”¤é†’æ£€æµ‹</span>
<span class="w">            </span><span class="c1">//æ¨é€å”¤é†’çš„éŸ³é¢‘æ•°æ®å’Œé¢„æ–™å­—ç¬¦ä¸²åˆ°äº‘ç«¯æœåŠ¡å™¨ã€‚</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateIdle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">kDeviceStateConnecting</span><span class="p">);</span>
<span class="w">                </span><span class="c1">//å°†å”¤é†’éŸ³é¢‘å†…å®¹è¿›è¡Œç¼–ç </span>
<span class="w">                </span><span class="n">wake_word_detect_</span><span class="p">.</span><span class="n">EncodeWakeWordData</span><span class="p">();</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">OpenAudioChannel</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">//é‡æ–°å†æ¬¡æ‰“å¼€å”¤é†’æ£€æµ‹ï¼Œ</span>
<span class="w">                    </span><span class="n">wake_word_detect_</span><span class="p">.</span><span class="n">StartDetection</span><span class="p">();</span>
<span class="w">                    </span><span class="k">return</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="c1">//å“ªäº›æƒ…å†µä¼šåœæ­¢å”¤é†’æ£€æµ‹ï¼š1 æ£€æµ‹åˆ°å”¤é†’è¯åä¼šåœæ­¢ã€‚2.å¤„äºlisteningçš„æ—¶å€™ä¼šåœæ­¢ã€‚3.OTAå‡çº§è¿‡ç¨‹ä¼šåœæ­¢</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">opus</span><span class="p">;</span>
<span class="w">                </span><span class="c1">//ç¼–ç å¹¶å°†å”¤é†’æ•°æ®æ¨é€åˆ°æœåŠ¡å™¨ï¼ˆé™¤äº†å”¤é†’è¯å¯èƒ½è¿˜åŒ…æ‹¬è¯´è¯æ•°æ®ï¼Ÿï¼‰</span>
<span class="w">                </span><span class="c1">// Encode and send the wake word data to the server</span>
<span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">wake_word_detect_</span><span class="p">.</span><span class="n">GetWakeWordOpus</span><span class="p">(</span><span class="n">opus</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">SendAudio</span><span class="p">(</span><span class="n">opus</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="c1">//å‘é€å”¤é†’è¯çš„å­—ç¬¦ä¸²</span>
<span class="w">                </span><span class="c1">// Set the chat state to wake word detected</span>
<span class="w">                </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">SendWakeWordDetected</span><span class="p">(</span><span class="n">wake_word</span><span class="p">);</span>
<span class="w">                </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">"Wake word detected: %s"</span><span class="p">,</span><span class="w"> </span><span class="n">wake_word</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">                </span><span class="n">keep_listening_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">                </span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">kDeviceStateIdle</span><span class="p">);</span>

<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateSpeaking</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">//å¦‚æœè¯´è¯çŠ¶æ€ï¼Œåˆ™å°†è¯´è¯è¿›è¡Œåœæ­¢ï¼Œè®¾ç½®ä¸€ä¸ªåœæ­¢æ ‡å¿—ä½ï¼Œå¹¶å‘é€åœæ­¢speakç»™æœåŠ¡ä¸è¦å†å‘opusäº†ï¼Ÿ</span>
<span class="w">                </span><span class="n">AbortSpeaking</span><span class="p">(</span><span class="n">kAbortReasonWakeWordDetected</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateActivating</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">kDeviceStateIdle</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="c1">//å¯åŠ¨å”¤é†’æ£€æµ‹</span>
<span class="w">    </span><span class="n">wake_word_detect_</span><span class="p">.</span><span class="n">StartDetection</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="c1">//è®¾ç½®çŠ¶æ€ä¸ºIDLEçŠ¶æ€</span>
<span class="w">    </span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">kDeviceStateIdle</span><span class="p">);</span>
<span class="w">    </span><span class="n">esp_timer_start_periodic</span><span class="p">(</span><span class="n">clock_timer_handle_</span><span class="p">,</span><span class="w"> </span><span class="mi">1000000</span><span class="p">);</span>
</code></pre></div>
<h2 id="mainloop">mainloop</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Application::MainLoop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xEventGroupWaitBits</span><span class="p">(</span><span class="n">event_group_</span><span class="p">,</span>
<span class="w">            </span><span class="n">SCHEDULE_EVENT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">AUDIO_INPUT_READY_EVENT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">AUDIO_OUTPUT_READY_EVENT</span><span class="p">,</span>
<span class="w">            </span><span class="n">pdTRUE</span><span class="p">,</span><span class="w"> </span><span class="n">pdFALSE</span><span class="p">,</span><span class="w"> </span><span class="n">portMAX_DELAY</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//å¤„ç†å½•éŸ³éŸ³é¢‘å¤„ç†ï¼Œå°†æ”¶åˆ°çš„éŸ³é¢‘åšå¤„ç†é€åˆ°é˜Ÿåˆ—</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bits</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">AUDIO_INPUT_READY_EVENT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">InputAudio</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//å¤„ç†äº‘ç«¯éŸ³é¢‘å¤„ç†ï¼Œå°†ç¼–ç çš„éŸ³é¢‘è¿›è¡Œè§£ç é€æ’­æ”¾å™¨</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bits</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">AUDIO_OUTPUT_READY_EVENT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">OutputAudio</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//å¤„ç†å…¶ä»–ä»»åŠ¡çš„é˜Ÿåˆ—</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bits</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SCHEDULE_EVENT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">main_tasks_</span><span class="p">);</span>
<span class="w">            </span><span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tasks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">task</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_1">å½•éŸ³é€šè·¯</h2>
<h3 id="_2">å½•éŸ³å¤„ç†</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// I2Sæ”¶åˆ°éŸ³é¢‘ï¼Œè§¦å‘appåº”ç”¨æ³¨å†Œçš„å›è°ƒå‡½æ•°é€šçŸ¥å‡½æ•°codec-&gt;OnInputReady,å¦‚ä¸‹</span>
<span class="c1">//é€šçŸ¥æœ‰æ•°æ®äº†ï¼Œå®é™…è¯»æ•°æ®é€šè¿‡Readå»è¯»ã€‚</span>
<span class="n">IRAM_ATTR</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">AudioCodec</span><span class="o">::</span><span class="n">on_recv</span><span class="p">(</span><span class="n">i2s_chan_handle_t</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">i2s_event_data_t</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">audio_codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">AudioCodec</span><span class="o">*</span><span class="p">)</span><span class="n">user_ctx</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">audio_codec</span><span class="o">-&gt;</span><span class="n">input_enabled_</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">audio_codec</span><span class="o">-&gt;</span><span class="n">on_input_ready_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">audio_codec</span><span class="o">-&gt;</span><span class="n">on_input_ready_</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//é€šè¿‡eventsetbitè§¦å‘é€šçŸ¥mainloopçº¿ç¨‹å¤„ç†éŸ³é¢‘</span>
<span class="w">    </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">OnInputReady</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">codec</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">BaseType_t</span><span class="w"> </span><span class="n">higher_priority_task_woken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pdFALSE</span><span class="p">;</span>
<span class="w">        </span><span class="n">xEventGroupSetBitsFromISR</span><span class="p">(</span><span class="n">event_group_</span><span class="p">,</span><span class="w"> </span><span class="n">AUDIO_INPUT_READY_EVENT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">higher_priority_task_woken</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">higher_priority_task_woken</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pdTRUE</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>

<span class="c1">//åœ¨mainloopä¸­è§¦å‘Application::InputAudio()</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">Application::InputAudio</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//è·å–codecçš„å®ä¾‹</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="o">::</span><span class="n">GetInstance</span><span class="p">().</span><span class="n">GetAudioCodec</span><span class="p">();</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//è·å–codecçš„éŸ³é¢‘pcmæ•°æ®å­˜åˆ°dataä¸­ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">InputData</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="c1">//å¦‚æœæ•°æ®ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//å¦‚æœé‡‡æ ·ç‡ä¸æ˜¯16Khzï¼Œéœ€è¦è¿›è¡Œé‡é‡‡æ ·</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">input_sample_rate</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">16000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">input_channels</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">mic_channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">reference_channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mic_channel</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">mic_channel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="w">                </span><span class="n">reference_channel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">resampled_mic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">input_resampler_</span><span class="p">.</span><span class="n">GetOutputSamples</span><span class="p">(</span><span class="n">mic_channel</span><span class="p">.</span><span class="n">size</span><span class="p">()));</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">resampled_reference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">reference_resampler_</span><span class="p">.</span><span class="n">GetOutputSamples</span><span class="p">(</span><span class="n">reference_channel</span><span class="p">.</span><span class="n">size</span><span class="p">()));</span>
<span class="w">            </span><span class="n">input_resampler_</span><span class="p">.</span><span class="n">Process</span><span class="p">(</span><span class="n">mic_channel</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">mic_channel</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="n">resampled_mic</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
<span class="w">            </span><span class="n">reference_resampler_</span><span class="p">.</span><span class="n">Process</span><span class="p">(</span><span class="n">reference_channel</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">reference_channel</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="n">resampled_reference</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
<span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">resampled_mic</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resampled_reference</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">resampled_mic</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resampled_mic</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">                </span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resampled_reference</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">resampled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">input_resampler_</span><span class="p">.</span><span class="n">GetOutputSamples</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">()));</span>
<span class="w">            </span><span class="n">input_resampler_</span><span class="p">.</span><span class="n">Process</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="n">resampled</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
<span class="w">            </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">resampled</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="c1">//å¦‚æœå¯åŠ¨äº†å”¤é†’æ£€æµ‹ï¼Œåˆ¤æ–­å”¤é†’æ£€æµ‹æ˜¯å¦è¿˜åœ¨è¿è¡Œï¼Œå¦‚æœè¿˜åœ¨è¿è¡Œå°†å½“å‰çš„æ•°æ®åˆå¹¶åˆ°å”¤é†’</span>
<span class="c1">//æ£€æµ‹çš„bufferä¸­ã€‚</span>
<span class="cp">#if CONFIG_USE_WAKE_WORD_DETECT</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wake_word_detect_</span><span class="p">.</span><span class="n">IsDetectionRunning</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wake_word_detect_</span><span class="p">.</span><span class="n">Feed</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//ä¼šå°†å½“å‰çš„æ•°æ®å–‚ç»™AFEæ¥å£ï¼Œç”¨äºåšå”¤é†’è¯</span>
<span class="w">        </span><span class="c1">//å”¤é†’è¯ä¹Ÿç›´æ¥é€åˆ°äº‘ç«¯äº†ï¼Ÿï¼Ÿï¼Ÿ</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#endif</span>

<span class="c1">//å¦‚æœæ‰“å¼€äº†éŸ³æ•ˆå¤„ç†ï¼Œå°†éŸ³é¢‘æ•°æ®pushåˆ°éŸ³æ•ˆå¤„ç†ä¸­ï¼Œç›´æ¥è¿”å›</span>
<span class="cp">#if CONFIG_USE_AUDIO_PROCESSOR</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">audio_processor_</span><span class="p">.</span><span class="n">IsRunning</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">audio_processor_</span><span class="p">.</span><span class="n">Input</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#else</span>
<span class="c1">//å¦‚æœæ²¡æœ‰æ‰“å¼€éŸ³æ•ˆå¤„ç†ï¼Œåˆ¤æ–­å½“å‰çš„çŠ¶æ€æ˜¯å¦æ˜¯ç›‘å¬çŠ¶æ€ï¼Œå¦‚æœæ˜¯å°†éŸ³é¢‘è¿›è¡Œç¼–ç </span>
<span class="c1">//ç„¶åæ¨é€åˆ°è¿œç«¯æœåŠ¡ä¸­ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateListening</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">background_task_</span><span class="o">-&gt;</span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">)]()</span><span class="w"> </span><span class="k">mutable</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">opus_encoder_</span><span class="o">-&gt;</span><span class="n">Encode</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">opus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">opus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">opus</span><span class="p">)]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">SendAudio</span><span class="p">(</span><span class="n">opus</span><span class="p">);</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_3">éŸ³æ•ˆå¤„ç†</h3>
<p>ä»¥ä¸‹æ˜¯éŸ³æ•ˆå¤„ç†è¿‡ç¨‹</p>
<div class="codehilite"><pre><span></span><code><span class="c1">//å°†æ•°æ®å–‚ç»™AFEæ¨¡å—ï¼Œå½“å¤„ç†å®Œäº†ä¹‹åä¼šè§¦å‘å›è°ƒï¼Ÿ</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">AudioProcessor::Input</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">input_buffer_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">input_buffer_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">feed_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">afe_iface_</span><span class="o">-&gt;</span><span class="n">get_feed_chunksize</span><span class="p">(</span><span class="n">afe_data_</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">channels_</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">input_buffer_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">feed_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_buffer_</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
<span class="w">        </span><span class="n">afe_iface_</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">(</span><span class="n">afe_data_</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">);</span>
<span class="w">        </span><span class="n">input_buffer_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">input_buffer_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">input_buffer_</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">feed_size</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">AudioProcessor::AudioProcessorTask</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">fetch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">afe_iface_</span><span class="o">-&gt;</span><span class="n">get_fetch_chunksize</span><span class="p">(</span><span class="n">afe_data_</span><span class="p">);</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">feed_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">afe_iface_</span><span class="o">-&gt;</span><span class="n">get_feed_chunksize</span><span class="p">(</span><span class="n">afe_data_</span><span class="p">);</span>
<span class="w">    </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">"Audio communication task started, feed size: %d fetch size: %d"</span><span class="p">,</span>
<span class="w">        </span><span class="n">feed_size</span><span class="p">,</span><span class="w"> </span><span class="n">fetch_size</span><span class="p">);</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//è·å–åˆ°PROCESSOR_RUNNINGåï¼Œä¸ä¼šæ¸…é™¤bitï¼ˆç¬¬ä¸‰ä¸ªå‚æ•°ï¼‰ï¼Œä¹Ÿå°±è¯´ä¼šå†æ¬¡å¾—åˆ°è¿è¡Œã€‚</span>
<span class="w">        </span><span class="c1">//ä¹Ÿå°±æ˜¯è¯´AudioProcessor::Start()åï¼Œè¿™ä¸ªä¼šå¾ªç¯è¿è¡Œï¼Œç›´åˆ°è°ƒç”¨Stopæ¸…é™¤ã€‚</span>
<span class="w">        </span><span class="n">xEventGroupWaitBits</span><span class="p">(</span><span class="n">event_group_</span><span class="p">,</span><span class="w"> </span><span class="n">PROCESSOR_RUNNING</span><span class="p">,</span><span class="w"> </span><span class="n">pdFALSE</span><span class="p">,</span><span class="w"> </span><span class="n">pdTRUE</span><span class="p">,</span><span class="w"> </span><span class="n">portMAX_DELAY</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//ç­‰å¾…è·å–å¤„ç†åçš„æ•°æ®ã€‚</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">afe_iface_</span><span class="o">-&gt;</span><span class="n">fetch_with_delay</span><span class="p">(</span><span class="n">afe_data_</span><span class="p">,</span><span class="w"> </span><span class="n">portMAX_DELAY</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">xEventGroupGetBits</span><span class="p">(</span><span class="n">event_group_</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PROCESSOR_RUNNING</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ret_value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ESP_FAIL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">"Error code: %d"</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ret_value</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// VAD state change</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vad_state_change_callback_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">vad_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">VAD_SPEECH</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">is_speaking_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">is_speaking_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">                </span><span class="n">vad_state_change_callback_</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">vad_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">VAD_SILENCE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">is_speaking_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">is_speaking_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">                </span><span class="n">vad_state_change_callback_</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//è·å–åˆ°æ•°æ®ï¼Œå°†æ•°æ®å›è°ƒç»™app-&gt;audio_processor_.OnOutput</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">output_callback_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">output_callback_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">res</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int16_t</span><span class="p">)));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="c1">//å¤„ç†çš„éŸ³æ•ˆæ•°æ®çš„å›è°ƒï¼Œå°†æ•°æ®è¿›è¡Œç¼–ç ï¼Œç„¶åæ¨é€åˆ°äº‘ç«¯æœåŠ¡å™¨ã€‚</span>
<span class="w">    </span><span class="n">audio_processor_</span><span class="p">.</span><span class="n">OnOutput</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">background_task_</span><span class="o">-&gt;</span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">)]()</span><span class="w"> </span><span class="k">mutable</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">opus_encoder_</span><span class="o">-&gt;</span><span class="n">Encode</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">opus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">opus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">opus</span><span class="p">)]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">SendAudio</span><span class="p">(</span><span class="n">opus</span><span class="p">);</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>
</code></pre></div>
<h2 id="_4">æ’­æ”¾é€šè·¯</h2>
<div class="codehilite"><pre><span></span><code><span class="c1">//1. é€šè¿‡è§£æè¾“å…¥çš„jsonæ¥å¯åŠ¨çŠ¶æ€çš„åˆ‡æ¢ã€‚</span>
<span class="w">  </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">OnIncomingJson</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">display</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">cJSON</span><span class="o">*</span><span class="w"> </span><span class="n">root</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Parse JSON data</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="s">"type"</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="s">"tts"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="s">"state"</span><span class="p">);</span>
<span class="w">            </span><span class="c1">//æ”¶åˆ°äº‘ç«¯éŸ³é¢‘ï¼Œäº‘ç«¯ä¼šå‘é€startï¼Œéœ€è¦åˆ‡æ¢åˆ°speakingçŠ¶æ€ã€‚</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="s">"start"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">aborted_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateIdle</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateListening</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">kDeviceStateSpeaking</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="c1">//æœ¬æ¬¡è¯é¢˜ç»“æŸåï¼Œäº‘ç«¯ä¼šå‘é€stopï¼Œå¯åˆ‡æ¢åˆ°idleã€‚</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="s">"stop"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateSpeaking</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">background_task_</span><span class="o">-&gt;</span><span class="n">WaitForCompletion</span><span class="p">();</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keep_listening_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">SendStartListening</span><span class="p">(</span><span class="n">kListeningModeAutoStop</span><span class="p">);</span>
<span class="w">                            </span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">kDeviceStateListening</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">kDeviceStateIdle</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="s">"sentence_start"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="s">"text"</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">text</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">"&lt;&lt; %s"</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">);</span>
<span class="w">                    </span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">display</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">text</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">)]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetChatMessage</span><span class="p">(</span><span class="s">"assistant"</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">                    </span><span class="p">});</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="c1">//2.è§£æåˆ°äº‘ç«¯çš„jsonåï¼Œä¼šå‘ç”ŸçŠ¶æ€çš„è¿ç§»</span>
<span class="kt">void</span><span class="w"> </span><span class="n">Application</span><span class="o">::</span><span class="n">SetDeviceState</span><span class="p">(</span><span class="n">DeviceState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">clock_ticks_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">previous_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_state_</span><span class="p">;</span>
<span class="w">    </span><span class="n">device_state_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">    </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">"STATE: %s"</span><span class="p">,</span><span class="w"> </span><span class="n">STATE_STRINGS</span><span class="p">[</span><span class="n">device_state_</span><span class="p">]);</span>
<span class="w">    </span><span class="c1">// The state is changed, wait for all background tasks to finish</span>
<span class="w">    </span><span class="n">background_task_</span><span class="o">-&gt;</span><span class="n">WaitForCompletion</span><span class="p">();</span>
<span class="w">    </span><span class="c1">//å¦‚æœåå°æœ‰çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œç­‰å¾…è¿è¡Œç»“æŸ</span>

<span class="w">    </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="o">::</span><span class="n">GetInstance</span><span class="p">();</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">GetAudioCodec</span><span class="p">();</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">GetDisplay</span><span class="p">();</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">GetLed</span><span class="p">();</span>
<span class="w">    </span><span class="n">led</span><span class="o">-&gt;</span><span class="n">OnStateChanged</span><span class="p">();</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">kDeviceStateUnknown</span><span class="p">:</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">kDeviceStateIdle</span><span class="p">:</span>
<span class="w">            </span><span class="c1">//idleçŠ¶æ€ï¼Œæ˜¾ç¤º"å¾…å‘½"</span>
<span class="w">            </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetStatus</span><span class="p">(</span><span class="n">Lang</span><span class="o">::</span><span class="n">Strings</span><span class="o">::</span><span class="n">STANDBY</span><span class="p">);</span>
<span class="w">            </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetEmotion</span><span class="p">(</span><span class="s">"neutral"</span><span class="p">);</span>
<span class="cp">#if CONFIG_USE_AUDIO_PROCESSOR</span>
<span class="w">            </span><span class="c1">//å…³æ‰éŸ³æ•ˆå¤„ç†</span>
<span class="w">            </span><span class="n">audio_processor_</span><span class="p">.</span><span class="n">Stop</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="cp">#if CONFIG_USE_WAKE_WORD_DETECT</span>
<span class="w">            </span><span class="c1">//å¼€å¯è¯­éŸ³å”¤é†’æ£€æµ‹</span>
<span class="w">            </span><span class="n">wake_word_detect_</span><span class="p">.</span><span class="n">StartDetection</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">kDeviceStateConnecting</span><span class="p">:</span>
<span class="w">            </span><span class="c1">//è¿æ¥çŠ¶æ€ï¼Œè¡¨ç¤ºè¿æ¥æœåŠ¡å™¨</span>
<span class="w">            </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetStatus</span><span class="p">(</span><span class="n">Lang</span><span class="o">::</span><span class="n">Strings</span><span class="o">::</span><span class="n">CONNECTING</span><span class="p">);</span>
<span class="w">            </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetEmotion</span><span class="p">(</span><span class="s">"neutral"</span><span class="p">);</span>
<span class="w">            </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetChatMessage</span><span class="p">(</span><span class="s">"system"</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">kDeviceStateListening</span><span class="p">:</span>
<span class="w">            </span><span class="c1">//è¯´è¯çŠ¶æ€ï¼Œæ˜¾ç¤ºè¯´è¯ä¸­</span>
<span class="w">            </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetStatus</span><span class="p">(</span><span class="n">Lang</span><span class="o">::</span><span class="n">Strings</span><span class="o">::</span><span class="n">LISTENING</span><span class="p">);</span>
<span class="w">            </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetEmotion</span><span class="p">(</span><span class="s">"neutral"</span><span class="p">);</span>
<span class="w">            </span><span class="c1">//å¤ä½è§£ç å™¨ï¼Œæ¸…é™¤æ‰åŸæ¥çš„</span>
<span class="w">            </span><span class="n">ResetDecoder</span><span class="p">();</span>
<span class="w">            </span><span class="c1">//å¤ä½ç¼–ç å™¨çš„çŠ¶æ€</span>
<span class="w">            </span><span class="n">opus_encoder_</span><span class="o">-&gt;</span><span class="n">ResetState</span><span class="p">();</span>
<span class="cp">#if CONFIG_USE_AUDIO_PROCESSOR</span>
<span class="w">            </span><span class="c1">//å¯åŠ¨éŸ³æ•ˆå¤„ç†ï¼ˆå›å£°æ¶ˆé™¤ï¼Ÿï¼‰</span>
<span class="w">            </span><span class="n">audio_processor_</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="cp">#if CONFIG_USE_WAKE_WORD_DETECT</span>
<span class="w">            </span><span class="c1">//å…³é—­å”¤é†’æ£€æµ‹</span>
<span class="w">            </span><span class="n">wake_word_detect_</span><span class="p">.</span><span class="n">StopDetection</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="c1">//æ›´æ–°IOTçŠ¶æ€</span>
<span class="w">            </span><span class="n">UpdateIotStates</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">previous_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateSpeaking</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// FIXME: Wait for the speaker to empty the buffer</span>
<span class="w">                </span><span class="n">vTaskDelay</span><span class="p">(</span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">120</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">kDeviceStateSpeaking</span><span class="p">:</span>
<span class="w">            </span><span class="n">display</span><span class="o">-&gt;</span><span class="n">SetStatus</span><span class="p">(</span><span class="n">Lang</span><span class="o">::</span><span class="n">Strings</span><span class="o">::</span><span class="n">SPEAKING</span><span class="p">);</span>
<span class="w">            </span><span class="c1">//å¤ä½è§£ç å™¨</span>
<span class="w">            </span><span class="n">ResetDecoder</span><span class="p">();</span>
<span class="w">            </span><span class="c1">//ä½¿èƒ½codecè¾“å‡º</span>
<span class="w">            </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">EnableOutput</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="cp">#if CONFIG_USE_AUDIO_PROCESSOR</span>
<span class="w">            </span><span class="c1">//éŸ³æ•ˆå¤„ç†åœæ­¢</span>
<span class="w">            </span><span class="n">audio_processor_</span><span class="p">.</span><span class="n">Stop</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="cp">#if CONFIG_USE_WAKE_WORD_DETECT</span>
<span class="w">            </span><span class="c1">//å¼€å¯å”¤é†’æ£€æµ‹</span>
<span class="w">            </span><span class="n">wake_word_detect_</span><span class="p">.</span><span class="n">StartDetection</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="c1">// Do nothing</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">//3. æ¥æ”¶äº‘ç«¯éŸ³é¢‘æ•°æ®çš„å›è°ƒï¼Œå¦‚æœæ˜¯speakçŠ¶æ€ï¼Œå°†æ•°æ®å…¥é˜Ÿåˆ°é˜Ÿåˆ—</span>
<span class="w">    </span><span class="n">protocol_</span><span class="o">-&gt;</span><span class="n">OnIncomingAudio</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateSpeaking</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">audio_decode_queue_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="c1">//4.å½“éŸ³é¢‘è¾“å‡ºå‡†å¤‡å¥½åï¼Œä¸ä¼šä¸æ–­çš„è°ƒç”¨è¿™ä¸ªå›è°ƒï¼Ÿï¼Ÿè§¦å‘mainloopè°ƒç”¨OutputAudio</span>
<span class="w">    </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">OnOutputReady</span><span class="p">([</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">BaseType_t</span><span class="w"> </span><span class="n">higher_priority_task_woken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pdFALSE</span><span class="p">;</span>
<span class="w">        </span><span class="n">xEventGroupSetBitsFromISR</span><span class="p">(</span><span class="n">event_group_</span><span class="p">,</span><span class="w"> </span><span class="n">AUDIO_OUTPUT_READY_EVENT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">higher_priority_task_woken</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">higher_priority_task_woken</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pdTRUE</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>

<span class="c1">//5. outputå¤„ç†</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">Application::OutputAudio</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="o">::</span><span class="n">GetInstance</span><span class="p">().</span><span class="n">GetAudioCodec</span><span class="p">();</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_silence_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//åˆ¤æ–­è§£ç é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼ŒæŠŠcodecè¾“å‡ºå…³äº†ï¼Œä¹Ÿå°±æ˜¯ä¸è¦å†è§¦å‘å›è°ƒ</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">audio_decode_queue_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Disable the output if there is no audio data for a long time</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateIdle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_output_time_</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_silence_seconds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">EnableOutput</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//å¦‚æœæ˜¯åœ¨ç›‘å¬çŠ¶æ€ï¼Œæ¸…é™¤æ‰è§£ç é˜Ÿåˆ—ï¼Œç›´æ¥è¿”å›</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDeviceStateListening</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">audio_decode_queue_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//è·å–ç¼–ç çš„æ•°æ®</span>
<span class="w">    </span><span class="n">last_output_time_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">opus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">audio_decode_queue_</span><span class="p">.</span><span class="n">front</span><span class="p">());</span>
<span class="w">    </span><span class="n">audio_decode_queue_</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
<span class="w">    </span><span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="w">    </span><span class="c1">//å°†è§£ç æ•°æ®æ·»åŠ åˆ°è°ƒåº¦ä¸­è¿›è¡Œè§£ç æ’­æ”¾</span>
<span class="w">    </span><span class="n">background_task_</span><span class="o">-&gt;</span><span class="n">Schedule</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">codec</span><span class="p">,</span><span class="w"> </span><span class="n">opus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">opus</span><span class="p">)]()</span><span class="w"> </span><span class="k">mutable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//å¦‚æœç¦æ­¢æ ‡å¿—ä½ç½®èµ·ï¼Œç›´æ¥é€€å‡ºã€‚åœ¨æ‰“æ–­å”¤é†’çš„æ—¶å€™å›ç½®èµ·</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aborted_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pcm</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//è§£ç ä¸ºpcm</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">opus_decoder_</span><span class="o">-&gt;</span><span class="n">Decode</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">opus</span><span class="p">),</span><span class="w"> </span><span class="n">pcm</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//å¦‚æœäº‘ç«¯çš„é‡‡æ ·ç‡å’Œcodecé‡‡æ ·ç‡ä¸ä¸€æ ·ï¼Œè¿›è¡Œé‡é‡‡æ ·ã€‚</span>
<span class="w">        </span><span class="c1">// Resample if the sample rate is different</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opus_decode_sample_rate_</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">output_sample_rate</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">target_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output_resampler_</span><span class="p">.</span><span class="n">GetOutputSamples</span><span class="p">(</span><span class="n">pcm</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">resampled</span><span class="p">(</span><span class="n">target_size</span><span class="p">);</span>
<span class="w">            </span><span class="n">output_resampler_</span><span class="p">.</span><span class="n">Process</span><span class="p">(</span><span class="n">pcm</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">pcm</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="n">resampled</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
<span class="w">            </span><span class="n">pcm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">resampled</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//æ’­æ”¾éŸ³é¢‘</span>
<span class="w">        </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">OutputData</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="çº¿æ€§å›å½’å®ç°.html">â† çº¿æ€§å›å½’å®ç°</a>
    <a class="next" href="c-å›é¡¾.html">C++å›é¡¾ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

