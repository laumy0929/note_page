<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ª - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#pelt">PELTåŸºæœ¬åŸç†</a><ul><li><a href="#valyp">val*y^pè®¡ç®—</a></li><li><a href="#1024y1-y2-yp-1">1024*(y^1 + y^2 +......+ y^p-1)è®¡ç®—</a></li><li><a href="#_1">ä»£ç å®ç°</a></li></ul></li><li><a href="#_2">è´Ÿè½½æ›´æ–°</a><ul><li><a href="#_3">è§¦å‘è´Ÿè½½æ›´æ–°</a></li><li><a href="#taskcfs_rq">taskä¸cfs_rqå¹³å‡è´Ÿè½½</a></li><li><a href="#_4">è´Ÿè½½ã€è¿è¡Œè´Ÿè½½ã€åˆ©ç”¨ç‡è®¡ç®—</a></li><li><a href="#_5">è´Ÿè½½ä¼ æ’­</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ª</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-04-08
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><p>å„ä»»åŠ¡è´Ÿè½½ã€å„cpuçš„ç®—åŠ›ï¼ˆé¢‘ç‡+æ¶æ„ï¼‰ã€ä»»åŠ¡è¿ç§»å¼€é”€ï¼ˆè°ƒåº¦åŸŸï¼Œè°ƒåº¦ç»„ï¼‰ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">root</span><span class="err">@</span><span class="n">Linux</span><span class="o">:/</span><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">loadavg</span><span class="w"> </span>
<span class="mf">3.49</span><span class="w"> </span><span class="mf">3.43</span><span class="w"> </span><span class="mf">3.54</span><span class="w"> </span><span class="mi">4</span><span class="o">/</span><span class="mi">131</span><span class="w"> </span><span class="mi">3065</span>
</code></pre></div>
<p>cat /proc/loadavgå¯ä»¥è·å–CPUå…¨å±€å¹³å‡è´Ÿè½½ï¼Œå‰é¢çš„ä¸‰ä¸ªå€¼åˆ†åˆ«è¡¨ç¤ºä¸º1åˆ†é’Ÿã€5åˆ†é’Ÿã€15åˆ†é’Ÿç³»ç»Ÿå¹³å‡è´Ÿè½½ï¼Œç¬¬å››ä¸ªå­—æ®µæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ•°é‡/æ€»è¿›ç¨‹æ•°é‡ï¼Œç¬¬äº”ä¸ªå­—æ®µæœ€åä¸€ä¸ªè¿è¡Œçš„è¿›ç¨‹IDã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">å…¬å¼â‘ </span><span class="err">ï¼š</span><span class="n">CPUè´Ÿè½½</span><span class="o">=</span><span class="n">å°±ç»ªé˜Ÿåˆ—æ€»æƒé‡</span>
</code></pre></div>
<p>æ—©æœŸç³»ç»Ÿè®¡ç®—ç³»ç»Ÿè´Ÿè½½æ˜¯æ‰€æœ‰CPUä¸Šå°±ç»ªé˜Ÿåˆ—çš„æ€»æƒé‡ï¼Œä½†æ˜¯ä½¿ç”¨æƒé‡æ¥è®¡ç®—æ˜¯æ¯”è¾ƒå±€é™çš„ï¼Œå› ä¸ºè´Ÿè½½è€ƒè™‘çš„æ˜¯å¯¹CPUèµ„æºå ç”¨æƒ…å†µï¼Œè€Œæƒé‡é«˜çš„è¿›ç¨‹å¯èƒ½å¹¶ä¸ä¸€å®šä¼šä¸€ç›´è¿è¡Œï¼Œæˆ–è®¸è¿è¡Œä¸€ä¼šå°±ä¸€ç›´ç¡çœ ï¼Œå› æ­¤ä½¿ç”¨å°±ç»ªé˜Ÿåˆ—çš„æ€»æƒé‡å¹¶ä¸åˆç†ã€‚ åœ¨æƒé‡çš„åŸºç¡€ä¸Šè¿›è¡Œæ¼”åŒ–ï¼Œä»å…¨å±€è€ƒè™‘æ•´ä½“å°±ç»ªé˜Ÿåˆ—åˆ°è¿½è¸ªæ¯ä¸€ä¸ªè°ƒåº¦å®ä½“å¯¹CPUèµ„æºçš„å ç”¨ï¼Œä»è€Œè°ƒåº¦å™¨æœ‰æ›´ç²¾ç»†çš„æ§åˆ¶ã€‚åœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œå°†æ¯ä¸ªä»»åŠ¡å¯è¿è¡Œæ—¶é—´è€ƒè™‘è¿›å»ï¼ˆå¯è¿è¡Œè¡¨ç¤ºå¤„äºå°±ç»ªé˜Ÿåˆ—ä¸­ï¼Œä½†å¹¶ä¸æ˜¯åœ¨æ‰§è¡Œï¼‰ï¼Œè¿™æ ·å°±èƒ½å¤Ÿä»£è¡¨ä»»åŠ¡å¯¹CPUçš„èµ„æºå ç”¨æƒ…å†µã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">å…¬å¼â‘¡</span><span class="err">ï¼š</span><span class="n">load</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">/</span><span class="n">T</span>
</code></pre></div>
<p>é‡‡æ ·ä¸€æ®µæ—¶é—´Tï¼Œä»»åŠ¡å¤„äºè¿è¡ŒçŠ¶æ€æ—¶é—´ä¸ºt,è¯¥ä»»åŠ¡å¯¹CPUçš„è´Ÿè½½å¯è¿è¡Œæ—¶é—´ä¸é‡‡æ ·æ—¶é—´çš„æ¯”å€¼å†ä¸æƒé‡ç›¸ä¹˜ã€‚ å…¬å¼â‘¡çœ‹èµ·æ¥æ˜¯æ¯”è¾ƒåˆç†ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨é—®é¢˜ï¼Œè€ƒè™‘ä¸€äº›åœºæ™¯ï¼Œå‡è®¾ç›¸åŒä¼˜å…ˆçº§Aä»»åŠ¡å’ŒBä»»åŠ¡åœ¨æŸå¤©åŒä¸€æ—¶åˆ»å¯åŠ¨ï¼ŒAä»»åŠ¡è¿è¡Œäº†åŠå¤©å°±ä¸€ç›´ç¡çœ ï¼Œè€ŒBä»»åŠ¡ä¸€å¯åŠ¨å°±ç¡çœ åŠå¤©ï¼Œç„¶åä¸€ç›´è¿è¡Œã€‚æŒ‰ç…§å…¬å¼â‘¡çš„è®¡ç®—Aå’ŒBçš„è´Ÿè½½æ˜¯ä¸€æ ·çš„ï¼Œæ˜¾ç„¶ä¸åˆç†ï¼Œåœ¨æœ€è¿‘çš„è¿™æ®µæ—¶é—´å†…ä»»åŠ¡Bçš„è´Ÿè½½è¦é«˜äºAï¼Œå› æ­¤åŸºäºå…¬å¼å†è¿›è¡Œäº†æ¼”åŒ–ï¼ŒåŠ å…¥å†å²è¿è¡Œæƒ…å†µçš„å‚æ•°ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_b725ab47056127971680f54b86cc9316.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_b725ab47056127971680f54b86cc9316.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="n">å…¬å¼â‘¢</span><span class="err">ï¼š</span><span class="n">load</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">t0</span><span class="o">*</span><span class="n">y</span><span class="o">^</span><span class="mi">0</span><span class="o">+</span><span class="w"> </span><span class="n">t1</span><span class="o">*</span><span class="n">y</span><span class="o">^</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t2</span><span class="o">*</span><span class="n">y</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="p">...</span><span class="o">+</span><span class="n">tn</span><span class="o">*</span><span class="n">y</span><span class="o">^</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">T</span>
</code></pre></div>
<p>è´Ÿè½½è®¡ç®—å°†å†å²è¿è¡Œå› ç´ è€ƒè™‘è¿›å»ï¼Œä½†æ˜¯å†å²å› ç´ çš„å› ç´ æœ‰ä¸€ä¸ªè¡°å‡ï¼ˆdecayï¼‰è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ç¦»å½“å‰æœ€è¿‘çš„å½±å“æœ€å¤§ï¼Œç¦»å½“å‰æ—¶é—´è¶Šè¿œå½±å“ç¨‹åº¦è¶Šå°ï¼Œæ‰€ä»¥è¡°å‡å› å­y^32=0.5ã€‚ä¸ºäº†ä¾¿äºç³»ç»Ÿè®¡ç®—å¯¹å…¬å¼åœ¨è¿›è¡Œäº†é‡åŒ–ï¼Œé‡‡æ ·å‘¨æœŸä¸º1msï¼Œæ‰€ä»¥å…¬å¼ä¸º</p>
<div class="codehilite"><pre><span></span><code><span class="n">å…¬å¼â‘£L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">L1</span><span class="o">*</span><span class="n">y</span><span class="o">^</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">L2</span><span class="o">*</span><span class="n">y</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">L3</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="p">....</span><span class="w"> </span><span class="n">Ln</span><span class="o">*</span><span class="n">y</span><span class="o">^</span><span class="n">n</span><span class="err">ã€‚</span>
</code></pre></div>
<p>ä¸‹é¢æ˜¯æè¿°è°ƒåº¦å®ä½“æˆ–å°±ç»ªé˜Ÿåˆ—çš„è´Ÿè½½ä¿¡æ¯ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">sched_avg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u64</span><span class="w">             </span><span class="n">last_update_time</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="n">u64</span><span class="w">             </span><span class="n">load_sum</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="n">u64</span><span class="w">             </span><span class="n">runnable_sum</span><span class="p">;</span>
<span class="w">    </span><span class="n">u32</span><span class="w">             </span><span class="n">util_sum</span><span class="p">;</span>
<span class="w">    </span><span class="n">u32</span><span class="w">             </span><span class="n">period_contrib</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">load_avg</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">runnable_avg</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">util_avg</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">util_est</span><span class="w">         </span><span class="n">util_est</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">____cacheline_aligned</span><span class="p">;</span>
</code></pre></div>
<ul>
<li>last_update_time: ä¸Šæ¬¡æ›´æ–°è´Ÿè½½ä¿¡æ¯çš„æ—¶é—´ç‚¹ï¼Œå¯ç”¨äºè®¡ç®—å·®å€¼ã€‚</li>
<li>load_sumï¼šè°ƒåº¦å®ä½“æ¥è¯´æ˜¯ä»»åŠ¡ç´¯è®¡å†å²è¡°å‡æ€»æ—¶é—´,åŒ…æ‹¬running+runnable+blockedï¼Œå¯¹äºè°ƒåº¦é˜Ÿåˆ—æ¥è¯´æ˜¯å…¶æ‰€æœ‰ä»»åŠ¡ç´¯è®¡å·¥ä½œæ€»è´Ÿè½½ï¼Œå‰è€…ç»Ÿè®¡çš„ä»…ä»…æ˜¯æ—¶é—´ï¼Œåè€…æ˜¯å·¥ä½œè´Ÿè½½å³æ—¶é—´ä¹˜æƒé‡ã€‚</li>
<li>runnable_sum: è°ƒåº¦å®ä½“æ¥è¯´æ˜¯running+runnableç´¯è®¡å†å²è¡°å‡æ€»æ—¶é—´ï¼Œ</li>
<li>util_sum:è°ƒåº¦å®ä½“æ¥è¯´æ­£åœ¨è¿è¡ŒçŠ¶æ€ä¸‹çš„ç´¯è®¡è¡°å‡æ€»æ—¶é—´ï¼Œè°ƒåº¦é˜Ÿåˆ—æ¥è¯´å…¶æ‰€æœ‰æ­£åœ¨è¿è¡Œä»»åŠ¡çš„æ€»æ—¶é—´ã€‚</li>
<li>period_contrib: å­˜æ”¾ç€ä¸Šä¸€æ¬¡æ—¶é—´é‡‡æ ·æ—¶ï¼Œä¸èƒ½å‡‘æˆä¸€ä¸ªå‘¨æœŸçš„å‰©ä½™æ—¶é—´ã€‚</li>
<li><em>_avg/util_avg:æ ¹æ®</em>_sumè®¡ç®—å¾—åˆ°çš„è´Ÿè½½å‡å€¼ã€‚</li>
<li>util_est:è¾…åŠ©è®¡ç®—é˜»å¡ä¹‹å‰load avgä¿¡æ¯ã€‚</li>
</ul>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_d3e07f2dcf618382b3e20e3893854ec0.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_d3e07f2dcf618382b3e20e3893854ec0.jpg"/></a></p>
<p>ä¸Šé¢æ˜¯struct cfs_rq/struct sched_entity ä¸struct sched_avgä¹‹é—´çš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è®¡ç®—è´Ÿè½½æ—¶æœ‰è°ƒåº¦å®ä½“çš„è´Ÿè½½å’Œå°±ç»ªé˜Ÿåˆ—çš„è´Ÿè½½ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * sched_entity:</span>
<span class="cm"> *</span>
<span class="cm"> *   task:</span>
<span class="cm"> *     se_weight()   = se-&gt;load.weight</span>
<span class="cm"> *     se_runnable() = !!on_rq</span>
<span class="cm"> *</span>
<span class="cm"> *   group: [ see update_cfs_group() ]</span>
<span class="cm"> *     se_weight()   = tg-&gt;weight * grq-&gt;load_avg / tg-&gt;load_avg</span>
<span class="cm"> *     se_runnable() = grq-&gt;h_nr_running</span>
<span class="cm"> *</span>
<span class="cm"> *   runnable_sum = se_runnable() * runnable = grq-&gt;runnable_sum</span>
<span class="cm"> *   runnable_avg = runnable_sum</span>
<span class="cm"> *</span>
<span class="cm"> *   load_sum := runnable</span>
<span class="cm"> *   load_avg = se_weight(se) * load_sum</span>
<span class="cm"> *</span>
<span class="cm"> * cfq_rq:</span>
<span class="cm"> *</span>
<span class="cm"> *   runnable_sum = \\Sum se-&gt;avg.runnable_sum</span>
<span class="cm"> *   runnable_avg = \\Sum se-&gt;avg.runnable_avg</span>
<span class="cm"> *</span>
<span class="cm"> *   load_sum = \\Sum se_weight(se) * se-&gt;avg.load_sum</span>
<span class="cm"> *   load_avg = \\Sum se-&gt;avg.load_avg</span>
<span class="cm"> */</span>
</code></pre></div>
<h2 id="pelt">PELTåŸºæœ¬åŸç†</h2>
<div class="codehilite"><pre><span></span><code><span class="n">å…¬å¼â‘£L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">L1</span><span class="o">*</span><span class="n">y</span><span class="o">^</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">L2</span><span class="o">*</span><span class="n">y</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">L3</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="p">....</span><span class="w"> </span><span class="n">Ln</span><span class="o">*</span><span class="n">y</span><span class="o">^</span><span class="n">n</span><span class="err">ã€‚</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_04734f35001abd11014c5a2feacdeb16.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_04734f35001abd11014c5a2feacdeb16.jpg"/></a></p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_3fe802816882b87025091b235c00346e.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_3fe802816882b87025091b235c00346e.jpg"/></a></p>
<p>åœ¨è®¡ç®—è´Ÿè½½æ—¶ï¼Œè®¡ç®—æ—¶åˆ»å¹¶ä¸èƒ½è¿™ä¹ˆç²¾ç¡®ï¼Œè¿™æ¬¡è®¡ç®—çš„æ—¶é—´è·ç¦»ä¸Šä¸€æ¬¡è®¡ç®—è´Ÿè½½çš„æ—¶é—´è·¨è¶Šäº†å¤šä¸ªå‘¨æœŸï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œlast_update_timeæ—¶åˆ»è¡¨ç¤ºä¸Šä¸€æ¬¡è®¡ç®—è´Ÿè½½ï¼Œè€Œè¿™æ¬¡è®¡ç®—çš„è´Ÿè½½ä¸ºnowæ—¶åˆ»ã€‚æ—¶é—´å¯ä»¥åˆ†ä¸º3æ®µd1ã€d2ã€d3ï¼Œä¹‹æ‰€ä»¥è¿™æ ·åˆ’åˆ†å½“å‰è®¡ç®—æ—¶åˆ»ä¸ä¸Šä¸€æ¬¡è®¡ç®—è´Ÿè½½çš„æ—¶åˆ»å¹¶ä¸ä¸€å®šè½åœ¨å‘¨æœŸç‚¹ã€‚å‡è®¾last_update_timeæ—¶åˆ»çš„è®¡ç®—å‡ºæ¥çš„è´Ÿè½½ä¸ºï¼Œæ ¹æ®åˆ’åˆ†çš„3æ®µï¼Œå› æ­¤ç³»ç»Ÿçš„è´Ÿè½½è®¡ç®—ä¸ºï¼šLlastï¼Œå…ˆä¸è€ƒè™‘æƒé‡ï¼Œé‚£ä¹ˆå½“å‰æ—¶åˆ»è´Ÿè½½ä¸ºï¼š</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_b21a9590f46ed129a4f3cfabe249adb3.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_b21a9590f46ed129a4f3cfabe249adb3.jpg"/></a></p>
<p>ä»è¿™ä¸ªå…¬å¼æ¥çœ‹ï¼Œè´Ÿè½½çš„è®¡ç®—å¯ä»¥åˆ†ä¸º3æ®µã€‚</p>
<h3 id="valyp">val*y^pè®¡ç®—</h3>
<p>å…ˆæ¥çœ‹(d1+ Llast) * y^p ä¸­ä»£ç çš„å®ç°ï¼Œç”±äºy^p çš„å€¼æ˜¯æµ®ç‚¹ï¼Œä¸ºäº†é¿å…æµ®ç‚¹è¿ç®—å¯ä»¥è½¬åŒ–ä¸ºy^p = y^p * 2^32 &gt;&gt; 32ï¼Œç›¸å½“äºå…ˆä¹˜ä»¥2^32 å†å³ç§»32ï¼ˆå³ç§»å°±æ˜¯é™¤ï¼‰ï¼Œè€Œy^p * 2^32 å†ç³»ç»Ÿä¸­æå‰è®¡ç®—å¥½äº†å­˜æ”¾å†æ•°ç»„runable_avg_yN_invä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">runnable_avg_yN_inv</span><span class="p">[]</span><span class="w"> </span><span class="n">__maybe_unused</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="mh">0xffffffff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfa83b2da</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf5257d14</span><span class="p">,</span><span class="w"> </span><span class="mh">0xefe4b99a</span><span class="p">,</span><span class="w"> </span><span class="mh">0xeac0c6e6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe5b906e6</span><span class="p">,</span>
<span class="w">    </span><span class="mh">0xe0ccdeeb</span><span class="p">,</span><span class="w"> </span><span class="mh">0xdbfbb796</span><span class="p">,</span><span class="w"> </span><span class="mh">0xd744fcc9</span><span class="p">,</span><span class="w"> </span><span class="mh">0xd2a81d91</span><span class="p">,</span><span class="w"> </span><span class="mh">0xce248c14</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc9b9bd85</span><span class="p">,</span>
<span class="w">    </span><span class="mh">0xc5672a10</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc12c4cc9</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbd08a39e</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8fbaf46</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb504f333</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb123f581</span><span class="p">,</span>
<span class="w">    </span><span class="mh">0xad583ee9</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa9a15ab4</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa5fed6a9</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa2704302</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9ef5325f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9b8d39b9</span><span class="p">,</span>
<span class="w">    </span><span class="mh">0x9837f050</span><span class="p">,</span><span class="w"> </span><span class="mh">0x94f4efa8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x91c3d373</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8ea4398a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8b95c1e3</span><span class="p">,</span><span class="w"> </span><span class="mh">0x88980e80</span><span class="p">,</span>
<span class="w">    </span><span class="mh">0x85aac367</span><span class="p">,</span><span class="w"> </span><span class="mh">0x82cd8698</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_263a57dc80207216c76839960bc69825.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_263a57dc80207216c76839960bc69825.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="c1">//è®¡ç®—val * y^nï¼Œy^32 = 0.5ã€‚</span>
<span class="k">static</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="nf">decay_load</span><span class="p">(</span><span class="n">u64</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">local_n</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//ç»è¿‡LOAD_AVG_PERIOD * 63å‘¨æœŸåï¼Œå°±è¡°å‡ä¸º0äº†</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">LOAD_AVG_PERIOD</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">63</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* after bounds checking we can collapse to 32-bit */</span>
<span class="w">    </span><span class="n">local_n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//å¦‚æœè¡°å‡å‘¨æœŸå¤§äº32ï¼Œåˆ™è®¡ç®—æ–¹å¼æœ‰è°ƒæ•´å¦‚ä¸‹ï¼Œåä¹‹ç›´æ¥æŸ¥è¡¨ï¼Œ</span>
<span class="c1">//val * y^p =val * (y^32)^(p/32) * y^(p%32) * 2^32 &gt;&gt;32, p=p/32 + p%32,</span>
<span class="c1">//è€Œy^32=1/2,æ‰€ä»¥val * (y^32)^(p/32) =val &gt;&gt; (p/32),</span>
<span class="c1">//y^(p%32) * 2^32 å°±å…ˆè®¡ç®—p%32ï¼Œç„¶åä»runnable_avg_yN_invè¡¨ä¸­æŸ¥è¯¢ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">local_n</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">LOAD_AVG_PERIOD</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="n">local_n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">LOAD_AVG_PERIOD</span><span class="p">;</span><span class="w"> </span><span class="c1">//val * (y^32)^(p/32) =val &gt;&gt; (p/32)</span>
<span class="w">        </span><span class="n">local_n</span><span class="w"> </span><span class="o">%=</span><span class="w"> </span><span class="n">LOAD_AVG_PERIOD</span><span class="p">;</span><span class="w"> </span><span class="c1">//p%32,ä¾¿äºä»runnable_avg_yN_invæŸ¥è¯¢</span>
<span class="w">    </span><span class="p">}</span>

<span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mul_u64_u32_shr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">runnable_avg_yN_inv</span><span class="p">[</span><span class="n">local_n</span><span class="p">],</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<span class="c1">//val * runnable_avg_yN_inv[local_n] &gt;&gt; 32</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="1024y1-y2-yp-1">1024*(y^1 + y^2 +......+ y^p-1)è®¡ç®—</h3>
<p>ç”±ç­‰æ¯”æ±‚å’Œå…¬å¼</p>
<div class="codehilite"><pre><span></span><code><span class="n">y</span><span class="o">^</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="n">P</span><span class="o">+</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="p">......</span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="n">p</span><span class="o">+</span><span class="n">n</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="o">^</span><span class="n">p</span><span class="o">-</span><span class="n">y</span><span class="o">^</span><span class="n">p</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">),</span>
</code></pre></div>
<p>å¾—</p>
<div class="codehilite"><pre><span></span><code><span class="n">y</span><span class="o">^</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="p">......</span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="n">p</span><span class="mi">-1</span><span class="w"> </span><span class="o">=</span><span class="p">(</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="o">^</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="o">^</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="o">^</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="mi">-1</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_4c549128168cb87deb7aa84a0869dc68.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_4c549128168cb87deb7aa84a0869dc68.jpg"/></a></p>
<p>å› ä¸º0&lt;y&lt;1ï¼Œæ‰€ä»¥å½“è¶‹äº0ï¼ˆä½“éªŒä¸‹ä»€ä¹ˆå«åš0.99^nå’Œ1.11^nï¼‰ï¼Œæ‰€ä»¥ä¸Šé¢çš„å…¬å¼å†æ¬¡ç®€åŒ–ä¸ºå¦‚ä¸‹ï¼š</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_711e3a444220a43fc18f8fec06c04b3b.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_711e3a444220a43fc18f8fec06c04b3b.jpg"/></a></p>
<h3 id="_1">ä»£ç å®ç°</h3>
<div class="codehilite"><pre><span></span><code><span class="n">Lnow</span><span class="w"> </span><span class="o">=</span><span class="n">d3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1024</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">^</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="p">......</span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="n">p</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">d1</span><span class="o">+</span><span class="w"> </span><span class="n">Llast</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="n">p</span><span class="w"> </span>
<span class="o">=</span><span class="w"> </span><span class="n">Llast</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="n">p</span><span class="err">ï¼ˆ</span><span class="n">step1</span><span class="err">ï¼‰</span><span class="o">+</span><span class="w"> </span><span class="p">[</span><span class="n">d1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="o">^</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LOAD_AVG_MAX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">*</span><span class="n">LOAD_AVG_MAX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d3</span><span class="p">]</span><span class="err">ï¼ˆ</span><span class="n">step2</span><span class="err">ï¼‰</span>
</code></pre></div>
<p>accumulate_sumæ˜¯è®¡ç®—è´Ÿè½½çš„æ ¸å¿ƒå‡½æ•°ï¼Œè®¡ç®—çš„è´Ÿè½½ç»“æœå¹¶ä¸æ˜¯ä¼šå¢åŠ è€Œæœ‰å¯èƒ½æ˜¯å‡å°‘ï¼Œè´Ÿè½½çš„å˜åŒ–éƒ½åœ¨è¿™ä¸ªå‡½æ•°ä¸­å®ç°ï¼Œå½“è°ƒåº¦å®ä½“æ²¡æœ‰åœ¨å°±ç»ªé˜Ÿåˆ—æ—¶ï¼Œéšç€æ—¶é—´çš„å¢åŠ å…¶å¯¹CPUçš„è´Ÿè½½ä¼šé€æ¸å‡å¼±ï¼Œè€Œå¦‚æœè°ƒåº¦å®ä½“åœ¨å°±ç»ªé˜Ÿåˆ—æ—¶ï¼Œå¯¹CPUçš„è´Ÿè½½å°±ä¼šé€æ¸å¢åŠ ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="n">u32</span>
<span class="n">accumulate_sum</span><span class="p">(</span><span class="n">u64</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_avg</span><span class="w"> </span><span class="o">*</span><span class="n">sa</span><span class="p">,</span>
<span class="w">           </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">load</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">runnable</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">running</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">contrib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">delta</span><span class="p">;</span><span class="w"> </span><span class="cm">/* p == 0 -&gt; delta &lt; 1024 */</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">periods</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// sa-&gt;period_contribæ˜¯ä¸Šæ¬¡æ›´æ–°è´Ÿè½½ä¸è¶³1024uså‘¨æœŸçš„æ—¶é—´ï¼Œdeltaæ˜¯ä¸Šæ¬¡æ›´æ–°è´Ÿè½½åˆ°ç°åœ¨è¦è®¡ç®—è´Ÿè½½ç»è¿‡çš„æ—¶é—´ï¼Œè¦è®¡ç®—æœ‰å¤šå°‘ä¸ªå‘¨æœŸéœ€è¦åŠ ä¸Šperiod_contribï¼Œè§4.1.1çš„å›¾ã€‚</span>
<span class="w">    </span><span class="n">delta</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">period_contrib</span><span class="p">;</span>
<span class="w">    </span><span class="n">periods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delta</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span><span class="w"> </span><span class="cm">/* A period is 1024us (~1ms) */</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Step 1: decay old *_sum if we crossed period boundaries.</span>
<span class="cm">     */</span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">periods</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//step1: åˆ†åˆ«è®¡ç®— Llast * y^pï¼Œå†å²è´Ÿè½½çš„è¡°å‡</span>
<span class="w">        </span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">load_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decay_load</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">load_sum</span><span class="p">,</span><span class="w"> </span><span class="n">periods</span><span class="p">);</span>
<span class="w">        </span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">runnable_sum</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">decay_load</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">runnable_sum</span><span class="p">,</span><span class="w"> </span><span class="n">periods</span><span class="p">);</span>
<span class="w">        </span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">util_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decay_load</span><span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">util_sum</span><span class="p">),</span><span class="w"> </span><span class="n">periods</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Step 2</span>
<span class="cm">         */</span>

<span class="w">        </span><span class="n">delta</span><span class="w"> </span><span class="o">%=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//å½“load=0æ—¶ï¼Œè¯´æ˜å½“å‰çš„è°ƒåº¦å®ä½“ä¸å¤„äºrunningæˆ–runnableï¼Œå› æ­¤ä¸éœ€è¦è®¡ç®—æ–°å¢è´Ÿè½½è´Ÿè½½è´¡çŒ®ï¼Œè€Œåªè®¡ç®—è´Ÿè½½è¡°å‡ï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´å‘¨æœŸï¼Œä¸€ç›´æ²¡å¾—åˆ°è¿è¡Œï¼Œç´¯è®¡çš„è´Ÿè½½è¡°å‡step1çš„æ“ä½œå°±æ˜¯è¡°å‡ã€‚</span>
<span class="c1">//step2: è®¡ç®—[d1 * y^p + LOAD_AVG_MAX - *LOAD_AVG_MAX - 1024 +d3]ï¼Œperiodå³Pã€‚</span>
<span class="c1">//å½“load !=0ï¼Œè¯´æ˜è°ƒåº¦å®ä½“å¤„äºrunningæˆ–runnableï¼Œå°±éœ€è¦è®¡ç®—å¢åŠ çš„è´Ÿè½½è´¡çŒ®ã€‚</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">load</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//d1= 1024 - sa-&gt;period_contrib, d3=delta % 1024ã€‚</span>
<span class="w">            </span><span class="n">contrib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__accumulate_pelt_segments</span><span class="p">(</span><span class="n">periods</span><span class="p">,</span>
<span class="w">                    </span><span class="mi">1024</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">period_contrib</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="p">}</span>
<span class="c1">//æ›´æ–°ä¸è¶³ä¸€ä¸ªå‘¨æœŸè´¡çŒ®å€¼</span>
<span class="w">    </span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">period_contrib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delta</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">load</span><span class="p">)</span>
<span class="w">        </span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">load_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">contrib</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">runnable</span><span class="p">)</span>
<span class="w">        </span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">runnable_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">runnable</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">contrib</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">SCHED_CAPACITY_SHIFT</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">running</span><span class="p">)</span>
<span class="w">        </span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">util_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">contrib</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">SCHED_CAPACITY_SHIFT</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">periods</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_fab570115ff24bb938c3978344275490.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_fab570115ff24bb938c3978344275490.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="nf">__accumulate_pelt_segments</span><span class="p">(</span><span class="n">u64</span><span class="w"> </span><span class="n">periods</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">d1</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">d3</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d3</span><span class="p">;</span><span class="w"> </span><span class="cm">/* y^0 == 1 */</span>

<span class="w">    </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decay_load</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">d1</span><span class="p">,</span><span class="w"> </span><span class="n">periods</span><span class="p">);</span><span class="w"> </span><span class="c1">//è®¡ç®—d1 * y^p </span>
<span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LOAD_AVG_MAX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">decay_load</span><span class="p">(</span><span class="n">LOAD_AVG_MAX</span><span class="p">,</span><span class="w"> </span><span class="n">periods</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<span class="c1">//è®¡ç®—LOAD_AVG_MAX - *LOAD_AVG_MAX - 1024</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c3</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_2">è´Ÿè½½æ›´æ–°</h2>
<p>è´Ÿè½½ä½¿ç”¨çš„æ˜¯struct schedç»“æ„ä½“æ¥è¿›è¡Œæè¿°ï¼Œè´Ÿè½½çš„æè¿°å¯¹è±¡åˆ†ä¸ºè°ƒåº¦å®ä½“seè´Ÿè½½ï¼ˆåŒ…å«group seå’Œtask seï¼‰å’Œè°ƒåº¦å®ä½“æ‰€åœ¨çš„å°±ç»ªé˜Ÿåˆ—cfs_rqè´Ÿè½½ã€‚cfs_rqçš„è´Ÿè½½å¯ä»¥å…ˆç®€å•çš„ç†è§£ä¸ºæ˜¯å…¶é˜Ÿåˆ—ä¸­æ‰€æœ‰è°ƒåº¦å®ä½“seçš„è´¡çŒ®ï¼Œå½“ç„¶ä¸èƒ½ç®€å•æ˜¯ç›¸åŠ å…³ç³»ï¼Œéœ€è¦è€ƒè™‘æƒé‡ã€cpuç®—åŠ›ç­‰å› ç´ ï¼Œé¡¶å±‚çš„cfs_rqè´Ÿè½½å®é™…å°±ç­‰äºCPUçš„è´Ÿè½½ã€‚ â€ƒâ€ƒè¿½è¸ªè°ƒåº¦å®ä½“seçš„è´Ÿè½½æ˜¯åŸºç¡€ï¼Œå½“è°ƒåº¦å®ä½“seçš„è´Ÿè½½å˜åŒ–æ—¶è¿›è€Œä¹Ÿä¼šå½±å“åˆ°å…¶æ‰€åœ¨cfs_rqé˜Ÿåˆ—çš„è´Ÿè½½å˜åŒ–ï¼Œcfs_rq.load = f(se.load)ï¼Œè´Ÿè½½æ›´æ–°çš„æ ¸å¿ƒå‡½æ•°ä½¿ç”¨update_load_avgæ¥å®ç°ï¼Œå› æ­¤æœ¬å°ç»“ä¸»è¦å°±æ˜¯å›´ç»•è¯¥å‡½æ•°è¿›è¡Œè§£è¯»ã€‚ è´Ÿè½½çš„æ›´æ–°å®é™…æ˜¯åŸºäºæŸä¸ªæ—¶é—´åˆ»è¿›è¡Œè®¡ç®—ï¼Œå¯¹äºä¸€ä¸ªè°ƒåº¦å®ä½“æ¥è¯´å…¶æœ‰ä¸åŒçš„è¿è¡ŒçŠ¶æ€ï¼Œæ¯ä¸ªçŠ¶æ€å¯¹CPUçš„è´Ÿè½½è®¡ç®—æ˜¯ä¸ç›¸åŒçš„ã€‚ - å½“ä¸€ä¸ªä»»åŠ¡å¤„äºrunningï¼ˆæ­£åœ¨è¿è¡Œï¼‰æˆ–runnableï¼ˆå°±ç»ªé˜Ÿåˆ—ä¸­ï¼‰æ—¶ï¼Œé‚£ä¹ˆå¯¹ç³»ç»Ÿçš„è´Ÿè½½è®¡ç®—æ˜¯è´¡çŒ®çš„ï¼Œå› æ­¤è´Ÿè½½éœ€è¦åœ¨åŸæ¥çš„åŸºç¡€ä¸Šï¼ˆä¸Šä¸€ä¸ªæ—¶åˆ»çš„è´Ÿè½½è¡°å‡å€¼ï¼‰åŠ ä¸Šå½“å‰æ–°å¢çš„è´¡çŒ®è´Ÿè½½ï¼Œä¹Ÿå°±æ˜¯è¯´ä»»åŠ¡å¤„äºå°±ç»ªé˜Ÿåˆ—æˆ–è€…æ­£åœ¨è¿è¡Œå¯¹äºCPUæ¥è¯´å°±æ˜¯æœ‰è´Ÿè·çš„ã€‚ - å½“ä¸€ä¸ªä»»åŠ¡æ²¡æœ‰æ­£è¿è¡Œæˆ–æ²¡æœ‰å¤„äºå°±ç»ªé˜Ÿåˆ—ä¸­å¦‚å¤„äºç¡çœ æ€ï¼Œé‚£ä¹ˆä¹Ÿè¦è€ƒè™‘å…¶ä»»åŠ¡çš„å†å²è´Ÿè½½ï¼Œç¡çœ çš„ä»»åŠ¡å¿…ç„¶æ˜¯æ­¤å‰è¿è¡Œè¿‡å› ä¸ºå¾—ä¸åˆ°æŸä¸ªèµ„æºè€Œä»å°±ç»ªé˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œè€Œè¯¥ä»»åŠ¡æ­¤å‰çš„ä»»åŠ¡è´Ÿè½½ä¹Ÿéœ€è¦è€ƒè™‘è¿›å»ï¼Œåªä¸è¿‡ä¼šéšç€æ—¶é—´çš„å¢åŠ ï¼Œä»»åŠ¡çš„è´Ÿè½½ä¼šä¸æ–­çš„è¡°å‡ï¼Œæœ€ç»ˆè¶‹äº0ï¼ˆè¦æ˜¯ä¸­é—´æ²¡æœ‰å†æ¬¡è¿è¡Œï¼‰ã€‚ â€ƒâ€ƒå¦‚ä¸‹å›¾è´Ÿè½½æ›´æ–°å¯ä»¥åˆ†ä¸ºå››éƒ¨åˆ†ï¼Œè§¦å‘è´Ÿè½½æ›´æ–°ï¼Œæ›´æ–°taskå’Œæ‰€å±cfs_rqå¹³å‡è´Ÿè½½ï¼Œè´Ÿè½½ã€è¿è¡Œè´Ÿè½½ã€åˆ©ç”¨ç‡è®¡ç®—ï¼Œgroup seè´Ÿè½½ä¼ æ’­ï¼Œæœ¬ç« èŠ‚ä¼šæŒ‰è¿™å››ä¸ªéƒ¨åˆ†ä¾æ¬¡å±•å¼€ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_04845bd8460640853e5219ce6ca1bbd2.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_04845bd8460640853e5219ce6ca1bbd2.jpg"/></a></p>
<h3 id="_3">è§¦å‘è´Ÿè½½æ›´æ–°</h3>
<ul>
<li>en/dequeue_task_fairï¼šä»»åŠ¡è¢«å”¤é†’/ç¡çœ ã€CPU/Cgroupè¿ç§»ã€ä»»åŠ¡è°ƒåº¦å‚æ•°å˜åŒ–ç­‰ä¼šå¯¼è‡´ä»»åŠ¡å‡ºå…¥é˜Ÿå˜åŒ–å°±ä¼šè§¦å‘è´Ÿè½½æ›´æ–°ã€‚</li>
<li>set_next_entityï¼šè¿›ç¨‹åˆ‡æ¢è®¾ç½®ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„ä»»åŠ¡ã€‚</li>
<li>put_prev_entityï¼šè¿›ç¨‹åˆ‡æ¢å°†è¢«æŠ¢å çš„ä»»åŠ¡é‡æ–°æ”¾å…¥é˜Ÿåˆ—ã€‚</li>
<li>entity_tickï¼šå‘¨æœŸæ€§çš„tickè§¦å‘ã€‚</li>
<li>__sched_group_set_sharesï¼šä¿®æ”¹task groupçš„è°ƒåº¦å‚æ•°ã€‚</li>
<li>de/attach_entity_cfs_rq:å”¤é†’æ–°åˆ›å»ºä»»åŠ¡ã€éCFSè°ƒåº¦ç±»åˆ‡æ¢CFSè°ƒåº¦ç±»ç­‰ï¼Œcfs_rqåœ¨cgroupçš„è¿ç§»ç­‰ç­‰ã€‚</li>
</ul>
<p>ä¸Šé¢åˆ—å‡ºäº†ä¸€éƒ¨åˆ†åœºæ™¯ä¼šè§¦å‘è´Ÿè½½æ›´æ–°ï¼Œå¦‚ä»»åŠ¡çš„å‡ºå…¥é˜Ÿåˆ—ã€è®¾ç½®ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„ä»»åŠ¡ã€è¢«æŠ¢å çš„ä»»åŠ¡é‡æ–°å…¥é˜Ÿã€å‘¨æœŸæ€§è°ƒåº¦æ›´æ–°ç­‰ï¼Œä¸‹é¢ä»¥å‡ ä¸ªåœºæ™¯æ¥è¿›è¡Œè¯´æ˜ã€‚</p>
<p>ï¼ˆ1ï¼‰ä»»åŠ¡å…¥é˜Ÿenqueue_task_fair-&gt;enqueue_entityã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">enqueue_task_fair</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rq</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">......</span>
<span class="n">for_each_sched_entity</span><span class="p">(</span><span class="n">se</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">on_rq</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="n">enqueue_entity</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">...</span>
<span class="p">}</span>
<span class="c1">//seå…¥é˜Ÿæ‰€å±cfs_rqï¼Œå¹¶å‘ä¸Šéå†ç›´åˆ°å¯¹åº”çš„ç»„è°ƒåº¦å®ä½“è¢«åŠ å…¥åˆ°cfs_rqä¸ºæ­¢ï¼ˆseè¦è°ƒåº¦ï¼Œ//å…¶çˆ¶å®ä½“ä¹Ÿå¿…é¡»å…¥é˜Ÿï¼‰ï¼Œenqueue_entityä¸­ä¼šæ›´æ–°ä¸€æ¬¡è´Ÿè½½ï¼Œè§ä¸‹ï¼Œæ­¤æ¬¡çš„è´Ÿè½½æ›´æ–°ä¸»è¦//è´Ÿè´£ä»ä¸‹åˆ°ä¸Šå¯¹åº”çš„çˆ¶è°ƒåº¦å®ä½“åŠ å…¥åˆ°å°±ç»ªé˜Ÿåˆ—ä¸ºæ­¢ï¼Œå†å¾€ä¸Šå°±è°ƒç”¨ä¸‹é¢çš„codeæ¥è¿›è¡Œ//æ›´æ–°äº†ï¼Œå¦‚ä¸‹å›¾ç¤ºä¾‹åªæ›´æ–°åˆ°cfs_rq2å±‚çº§æƒé‡ã€‚</span>

<span class="w">    </span><span class="n">for_each_sched_entity</span><span class="p">(</span><span class="n">se</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">update_load_avg</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">UPDATE_TG</span><span class="p">);</span>
<span class="w">        </span><span class="n">se_update_runnable</span><span class="p">(</span><span class="n">se</span><span class="p">);</span><span class="w"> </span><span class="c1">//æ›´æ–°seæ‰€å±cfs_rqä¸Šçš„ä»»åŠ¡æ•°é‡ï¼Œè´Ÿè½½è·Ÿè¯¥å€¼ä¹Ÿæœ‰å…³ç³»ã€‚</span>
<span class="w">        </span><span class="n">update_cfs_group</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">//è¿™é‡Œå°±æ˜¯è¡¥å…¨äº†å†å¾€ä¸Šå±‚çº§å‰©ä½™éƒ¨åˆ†seå’Œcfs_rqè´Ÿè½½ä¿¡æ¯ï¼Œå¦‚ä¸‹å¦‚æ›´æ–°cfs_rq1+cfs_rq0</span>
<span class="c1">//æƒé‡</span>
<span class="p">....</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">enqueue_entity</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">......</span>
<span class="n">update_load_avg</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">UPDATE_TG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">DO_ATTACH</span><span class="p">);</span><span class="w"> </span>
<span class="c1">//æ›´æ–°load avgå¤šä¼ é€’äº†ä¸€ä¸ªDO_ATTACHçš„flagï¼Œå½“ä¸€ä¸ªä»»åŠ¡ä»ä¸€ä¸ªé˜Ÿåˆ—è¿ç§»åˆ°ä¸€ä¸ªæ–°é˜Ÿ</span>
<span class="c1">//åˆ—ï¼Œé‚£ä¹ˆPELTçš„å±‚çº§ç»“æ„å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™æ—¶å€™éœ€è¦è´Ÿè½½çš„ä¼ æ’­è¿‡ç¨‹ã€‚</span>
<span class="w">    </span><span class="n">se_update_runnable</span><span class="p">(</span><span class="n">se</span><span class="p">);</span><span class="w"> </span>
<span class="w">    </span><span class="n">update_cfs_group</span><span class="p">(</span><span class="n">se</span><span class="p">);</span><span class="w"> </span>
<span class="w">    </span><span class="n">account_entity_enqueue</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">);</span><span class="w"> </span>
<span class="p">....</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_a6be6f9781f30fe48c40a71973d2ea92.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_a6be6f9781f30fe48c40a71973d2ea92.jpg"/></a></p>
<p>å½“è°ƒåº¦å®ä½“seå…¥é˜Ÿæ—¶ï¼Œè‡ªç„¶è°ƒåº¦å®ä½“seçš„è´Ÿè½½æ˜¯è¦æ›´æ–°çš„ï¼Œåˆå› ä¸ºseæ‰€å±çš„cfs_rqæ˜¯å…¶ä¸‹æ‰€æœ‰seçš„è´Ÿè½½å’Œï¼Œæ‰€ä»¥å½“å…¶ä»–seå˜åŒ–æ—¶ï¼Œé‚£ä¹ˆcfs_rqçš„è´Ÿè½½ä¹Ÿéœ€è¦åšå¯¹åº”çš„æ›´æ–°ï¼Œæ‰€ä»¥å¯ä»¥åœ¨update_load_avgå‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°ä¼šå…ˆæ›´æ–°seå†æ›´æ–°seæ‰€å±çš„cfs_rqã€‚è€Œåœ¨ä¸€ä¸ªcpuçš„è°ƒåº¦é˜Ÿåˆ—ä¸­ï¼Œç”±äºç»„è°ƒåº¦çš„å¼•å…¥ï¼Œä¼šæœ‰å¤šä¸ªå±‚çº§çš„æƒ…å†µï¼Œå› æ­¤å½“æœ€åº•å±‚çš„seå˜åŒ–æ—¶ï¼Œå¯¹åº”çš„cfs_rqå˜åŒ–ç»§è€Œåœ¨å½±å“ä¸Šä¸€å±‚çº§gseå˜åŒ–ï¼Œå†å½±å“gesæ‰€å±cfs_rqçš„å˜åŒ–ç›´åˆ°æœ€é¡¶å±‚ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæœ€åº•å±‚çš„seå’Œcfs_rqè´Ÿè½½å˜åŒ–ä¼šå¯¼è‡´ä¸Šä¸€å±‚çš„seï¼ˆgseï¼‰å’Œcfs_rqè´Ÿè½½ä¹Ÿéšä¹‹å˜åŒ–ï¼Œç›´è‡³é¡¶å±‚çš„cfs_rqã€‚</p>
<p>ï¼ˆ2ï¼‰ä»»åŠ¡å‡ºé˜Ÿdequeue_task_fair-&gt;dequeue_entityã€‚ è¿™æ˜¯å…¥é˜Ÿçš„é€†è¿‡ç¨‹ï¼Œ</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">dequeue_task_fair</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rq</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">......</span>
<span class="n">for_each_sched_entity</span><span class="p">(</span><span class="n">se</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="n">dequeue_entity</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="p">...</span>
<span class="p">}</span>

<span class="w">    </span><span class="n">for_each_sched_entity</span><span class="p">(</span><span class="n">se</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">update_load_avg</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">UPDATE_TG</span><span class="p">);</span>
<span class="w">        </span><span class="n">se_update_runnable</span><span class="p">(</span><span class="n">se</span><span class="p">);</span><span class="w"> </span>
<span class="w">        </span><span class="n">update_cfs_group</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">....</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">enqueue_entity</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">......</span>
<span class="n">update_load_avg</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">UPDATE_TG</span><span class="p">);</span><span class="w"> </span>
<span class="c1">//æ›´æ–°è°ƒåº¦å®ä½“åŠæ‰€å±cfs_rqçš„è´Ÿè½½</span>
<span class="n">se_update_runnable</span><span class="p">(</span><span class="n">se</span><span class="p">);</span><span class="w"> </span>
<span class="c1">//å¦‚æœæ˜¯group seï¼Œä»»åŠ¡å·²ç»å‡ºé˜Ÿï¼ˆå¦‚è¿›å…¥é˜»å¡çŠ¶æ€ï¼‰ï¼Œé‚£ä¹ˆå…¶runnable_weightéœ€è¦æ›´æ–°ã€‚</span>
<span class="c1">//å› ä¸ºå¯¹äºgroup seï¼Œåªæœ‰åœ¨è®¡ç®—runnable_sumæ‰ä¼šè€ƒè™‘ä»»åŠ¡æ•°é‡ï¼Œä½†æ˜¯ä»»åŠ¡å·²ç»å‡ºé˜Ÿäº†</span>
<span class="c1">//å°±ä¸å†æ˜¯runnableçŠ¶æ€äº†ï¼Œæ˜¯blockæˆ–è€…deadçŠ¶æ€äº†ã€‚</span>
<span class="c1">//è¿™é‡Œå¹¶æ²¡æœ‰æ›´æ–°ï¼Œé‚£ä¹ˆä»»åŠ¡é˜»å¡å‡ºé˜Ÿcfs rqçš„è´Ÿè½½æ²¡æœ‰å˜åŒ–ï¼Œåªä¸</span>
<span class="n">account_entity_enqueue</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">);</span>
<span class="c1">//å°†è°ƒåº¦å®ä½“çš„load weightä»cfs rqä¸­åŠ ä¸Šã€‚</span>
<span class="n">update_cfs_group</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<span class="p">....</span>
<span class="p">}</span>
</code></pre></div>
<p>ä»ä¸Šè¿°é˜Ÿåˆ—å‡ºé˜Ÿæ¥çœ‹ï¼Œå¹¶æ²¡æœ‰å°†load_avgè´Ÿè½½å‡å»ï¼Œè€Œæ˜¯å˜åŒ–äº†runnableç›¸å…³çš„è´Ÿè½½è®¡ç®—ï¼Œæ‰€ä»¥å³ä½¿ä»»åŠ¡å‡ºé˜Ÿè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå…¶è´Ÿè½½ä¾æ—§åœ¨load_avgä¸­ï¼Œåªä¸è¿‡éšç€æ—¶é—´çš„å¢é•¿è€Œè¡°å‡ã€‚</p>
<h3 id="taskcfs_rq">taskä¸cfs_rqå¹³å‡è´Ÿè½½</h3>
<p>è¿™ä¸€å°èŠ‚æˆ‘ä»¬ä¸»è¦æ¥åˆ†æä¸€ä¸‹update_load_avgå‡½æ•°ä¸»è¦çš„ä½œç”¨ï¼Œç›´æ¥ä¸Šä»£ç å§ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">update_load_avg</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">u64</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq_clock_pelt</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">)</span>
<span class="c1">//è·å–å½“å‰çš„æ—¶åˆ»ï¼Œå‡å»äº†ç©ºé—²æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¯¥è°ƒåº¦å®ä½“æ—¶é—´è¿è¡Œçš„æ—¶åˆ»ã€‚</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">decayed</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Track task load average for carrying it to new CPU after migrated, and</span>
<span class="cm">     * track group sched_entity load average for task_h_load calc in migration</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="c1">//å…ˆè®¡ç®—è°ƒåº¦å®ä½“çš„è°ƒåº¦è´Ÿè½½ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">last_update_time</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SKIP_AGE_LOAD</span><span class="p">))</span>
<span class="w">        </span><span class="n">__update_load_avg_se</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="w"> </span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//è®¡ç®—è°ƒåº¦å®ä½“æ‰€å±cfs_rqçš„è´Ÿè½½ã€‚</span>
<span class="n">decayed</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">update_cfs_rq_load_avg</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="w"> </span><span class="n">cfs_rq</span><span class="p">);</span>

<span class="c1">//group seè´Ÿè½½ä¼ æ’­ï¼šå¦‚æœè°ƒåº¦å®ä½“æ˜¯group seï¼Œå…¶ä¸‹ä»»åŠ¡æœ‰æ–°å¢æˆ–ç§»é™¤ç­‰å˜åŒ–ï¼Œåˆ™éœ€è¦é‡//æ–°æ›´æ–°group seæ‰€åœ¨å±‚æ¬¡çš„è´Ÿè½½ï¼Œgroup seä¸‹çš„cfs rqï¼Œè´Ÿè½½å˜åŒ–è¦ä¼ æ’­åˆ°ä¸Šä¸€å±‚çº§ï¼ˆgroup seæ‰€åœ¨å±‚çº§ï¼‰ã€‚</span>
<span class="w">    </span><span class="n">decayed</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">propagate_entity_load_avg</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//se-&gt;avg.last_update_timeä¸º0ä¸”DO_ATTACHï¼Œè¡¨ç¤ºä»»åŠ¡ä»å…¶ä»–é˜Ÿåˆ—è¿ç§»è¿‡æ¥æ–°å…¥é˜Ÿçš„ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">last_update_time</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DO_ATTACH</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * DO_ATTACH means we\'re here from enqueue_entity().</span>
<span class="cm">         * !last_update_time means we\'ve passed through</span>
<span class="cm">         * migrate_task_rq_fair() indicating we migrated.</span>
<span class="cm">         *</span>
<span class="cm">         * IOW we\'re enqueueing a task on a new CPU.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="c1">//åˆšåŠ å…¥é˜Ÿåˆ—ï¼Œè®¡ç®—seçš„è´Ÿè½½ä¸»è¦æ˜¯æ ¹æ®å½“å‰æ‰€å±cfs_rqä»¥åŠcpuç®—åŠ›ç­‰ä¿¡æ¯è¿›è¡Œè®¡//ç®—ï¼Œæ¥ç€å†å°†seçš„è´Ÿè½½ä¿¡æ¯loadã€runnableã€tutilä¼ æ’­åˆ°æ‰€å±cfs_rqçš„è´Ÿè½½ã€‚æœ€åä¼š//è°ƒç”¨add_tg_cfs_propagateå¯åŠ¨è´Ÿè½½ä¼ æ’­ï¼Œåªæœ‰è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ä¸Šé¢çš„//propagate_entity_load_avgæ‰ä¼šå…·ä½“æ‰§è¡Œä¼ æ’­åŠ¨ä½œã€‚</span>
<span class="w">        </span><span class="n">attach_entity_load_avg</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">);</span>

<span class="w">        </span><span class="c1">//æ›´æ–°groupçš„å¹³å‡è´Ÿè½½ã€‚</span>
<span class="w">        </span><span class="n">update_tg_load_avg</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">);</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">decayed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//è´Ÿè½½æœ‰å˜åŒ–</span>
<span class="w">        </span><span class="n">cfs_rq_util_change</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">//è§¦å‘æ˜¯å¦éœ€è¦è°ƒé¢‘</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">UPDATE_TG</span><span class="p">)</span>
<span class="w">            </span><span class="n">update_tg_load_avg</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_4">è´Ÿè½½ã€è¿è¡Œè´Ÿè½½ã€åˆ©ç”¨ç‡è®¡ç®—</h3>
<p>è´Ÿè½½è®¡ç®—å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œè°ƒåº¦å®ä½“ï¼ˆtask seã€group seï¼‰å’Œè°ƒåº¦å®ä½“æ‰€å±çš„cfs_rqï¼›è°ƒåº¦å®ä½“çš„è®¡ç®—æ˜¯è°ƒç”¨å‡½æ•°__update_load_avg_seå®ç°ï¼Œcfs_rqçš„è®¡ç®—æ˜¯è°ƒç”¨__update_load_avg_cfs_rqæ¥å®ç°ï¼Œä½†æ˜¯æœ€ç»ˆéƒ½ä¼šè°ƒç”¨___update_load_sumæ¥è®¡ç®—ï¼Œåªæ˜¯ä¼ å…¥çš„å‚æ•°ä¸ä¸€æ ·ã€‚ä½†ä¸¤ç±»éƒ½ä½¿ç”¨struct sched_avgç»“æ„ä½“æ¥è¿›è¡Œæè¿°ï¼Œä¸»è¦çš„æ ¸å¿ƒå°±æ˜¯éœ€è¦å…ˆè®¡ç®—å‡º{load|runnable|utils}_sum|avgï¼Œè®¡ç®—æ–¹æ³•æ€»ç»“å¦‚ä¸‹ï¼Œåç»­çš„ä»£ç å®é™…ä¹Ÿæ˜¯å›´ç»•è¿™ä¸ªè®¡ç®—å…¬å¼æ¥æ‰§è¡Œã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_aceec63d297054f3c848cccf47e5ef8f.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_aceec63d297054f3c848cccf47e5ef8f.jpg"/></a></p>
<ul>
<li>{load|runnable|utils}_sumâ€™ï¼šä¸Šä¸€æ—¶åˆ»è®¡ç®—çš„è´Ÿè½½ã€‚</li>
<li>contribï¼šä¸Šä¸€ä¸ªæ—¶åˆ»åˆ°å½“å‰æ—¶åˆ»è´Ÿè½½è´¡çŒ®ã€‚</li>
<li>SCHED_CAPACITY_SHIFT:å½’ä¸€åŒ–å¤„ç†ï¼Œä¸€èˆ¬æ˜¯2^10=1024ã€‚</li>
<li>dividerï¼šLOAD_AVG_MAX - (1024 - avg-&gt;period_contrib)ï¼Œæœ€å¤§è´Ÿè½½ã€‚</li>
</ul>
<p>æ— è®ºload,runnable,runningä¸ºä»»ä½•å€¼ï¼Œåªè¦æ›´æ–°è´Ÿè½½ä¸Šä¸€æ—¶åˆ»è®¡ç®—çš„{load|runnable|utils}_sumâ€™éƒ½ä¼šè¡°å‡ã€‚ â€ƒâ€ƒå½“load=0æ—¶ï¼Œrunableå’Œrunningä¹Ÿéƒ½ä¸º0ï¼Œå› ä¸ºloadçš„å–å€¼ä¸ºse-&gt;on_rqï¼Œè¯¥å€¼ä¸º1å°±å·²ç»åŒ…å«äº†runnable+runningï¼›è‹¥è¯¥å€¼ä¸º0ï¼Œé‚£ä¹ˆå°±ä¸æ˜¯runnableæˆ–runningï¼Œé‚£è‡ªç„¶runnableå’Œrunningä¸º0ã€‚ â€ƒâ€ƒå½“loadâ‰ 0ï¼Œrunnableâ‰ 0æˆ–runningâ‰ 0ï¼Œå…¶å¯¹åº”çš„{load|runnable|utils}_sumä¼šæœ‰æ–°å¢è´Ÿè½½è´¡çŒ®ã€‚ â€ƒâ€ƒå¤„äºblockedçŠ¶æ€çš„è°ƒåº¦å®ä½“ï¼Œä¸ä¼šå¸¦æ¥æ–°å¢è´Ÿè½½è´¡çŒ®ï¼ˆload=runnable=running=0ï¼‰ï¼Œä½†æ˜¯ä¼šå¯¹å†å²è´Ÿè½½è¿›è¡Œè¡°å‡ï¼ˆstep1è®¡ç®—çš„å°±æ˜¯å†å²è´Ÿè½½è¡°å‡ï¼‰ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">root</span><span class="err">@</span><span class="n">TinaLinux</span><span class="o">:/</span><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="mi">1214</span><span class="o">/</span><span class="n">task</span><span class="o">/</span><span class="mi">1214</span><span class="o">/</span><span class="n">sched</span>
<span class="n">wifi_daemon</span><span class="w"> </span><span class="p">(</span><span class="mi">1214</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">threads</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="o">-------------------------------------------------------------------</span>
<span class="n">se</span><span class="p">.</span><span class="n">exec_start</span><span class="w">                                </span><span class="o">:</span><span class="w">         </span><span class="mf">19745.413299</span>
<span class="n">se</span><span class="p">.</span><span class="n">vruntime</span><span class="w">                                  </span><span class="o">:</span><span class="w">          </span><span class="mf">2705.836320</span>
<span class="n">se</span><span class="p">.</span><span class="n">sum_exec_runtime</span><span class="w">                          </span><span class="o">:</span><span class="w">             </span><span class="mf">0.599750</span>
<span class="n">se</span><span class="p">.</span><span class="n">nr_migrations</span><span class="w">                             </span><span class="o">:</span><span class="w">                    </span><span class="mi">0</span>
<span class="nl">nr_switches</span><span class="w">                                  </span><span class="p">:</span><span class="w">                    </span><span class="mi">1</span>
<span class="nl">nr_voluntary_switches</span><span class="w">                        </span><span class="p">:</span><span class="w">                    </span><span class="mi">1</span>
<span class="nl">nr_involuntary_switches</span><span class="w">                      </span><span class="p">:</span><span class="w">                    </span><span class="mi">0</span>
<span class="n">se</span><span class="p">.</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="w">                               </span><span class="o">:</span><span class="w">              </span><span class="mi">1048576</span>
<span class="n">se</span><span class="p">.</span><span class="n">avg</span><span class="p">.</span><span class="n">load_sum</span><span class="w">                              </span><span class="o">:</span><span class="w">                </span><span class="mi">47234</span>
<span class="n">se</span><span class="p">.</span><span class="n">avg</span><span class="p">.</span><span class="n">runnable_sum</span><span class="w">                          </span><span class="o">:</span><span class="w">             </span><span class="mi">17325956</span>
<span class="n">se</span><span class="p">.</span><span class="n">avg</span><span class="p">.</span><span class="n">util_sum</span><span class="w">                              </span><span class="o">:</span><span class="w">             </span><span class="mi">17325956</span>
<span class="n">se</span><span class="p">.</span><span class="n">avg</span><span class="p">.</span><span class="n">load_avg</span><span class="w">                              </span><span class="o">:</span><span class="w">                 </span><span class="mi">1024</span>
<span class="n">se</span><span class="p">.</span><span class="n">avg</span><span class="p">.</span><span class="n">runnable_avg</span><span class="w">                          </span><span class="o">:</span><span class="w">                  </span><span class="mi">361</span>
<span class="n">se</span><span class="p">.</span><span class="n">avg</span><span class="p">.</span><span class="n">util_avg</span><span class="w">                              </span><span class="o">:</span><span class="w">                  </span><span class="mi">361</span>
<span class="n">se</span><span class="p">.</span><span class="n">avg</span><span class="p">.</span><span class="n">last_update_time</span><span class="w">                      </span><span class="o">:</span><span class="w">          </span><span class="mi">19745214464</span>
<span class="n">se</span><span class="p">.</span><span class="n">avg</span><span class="p">.</span><span class="n">util_est</span><span class="p">.</span><span class="n">ewma</span><span class="w">                         </span><span class="o">:</span><span class="w">                  </span><span class="mi">361</span>
<span class="n">se</span><span class="p">.</span><span class="n">avg</span><span class="p">.</span><span class="n">util_est</span><span class="p">.</span><span class="n">enqueued</span><span class="w">                     </span><span class="o">:</span><span class="w">                  </span><span class="mi">361</span>
<span class="nl">policy</span><span class="w">                                       </span><span class="p">:</span><span class="w">                    </span><span class="mi">0</span>
<span class="nl">prio</span><span class="w">                                         </span><span class="p">:</span><span class="w">                  </span><span class="mi">120</span>
<span class="n">clock</span><span class="o">-</span><span class="n">delta</span><span class="w">                                  </span><span class="o">:</span><span class="w">                   </span><span class="mi">83</span>
</code></pre></div>
<h4 id="__update_load_avg_se">__update_load_avg_se</h4>
<p>å‚æ•°è¯´æ˜ï¼š - loadï¼šä¸ºse-&gt;on_rqï¼Œè¡¨ç¤ºå½“å‰ä»»åŠ¡æ˜¯å¦å¤„äºå¯è¿è¡Œæ€ï¼ŒåŒ…æ‹¬runnable + runningï¼Œå¯¹äºè°ƒåº¦å®ä½“æ¥è¯´loadè¦ä¹ˆä¸º0ï¼Œè¦ä¹ˆä¸º1ã€‚ - runnableï¼šä¸ºse_runnable(se)ï¼Œè°ƒåº¦å®ä½“æ˜¯task seåˆ™ä¸ºse-&gt;on_rqï¼Œå¦‚æœæ˜¯group seï¼Œåˆ™ä¸ºse-&gt;runnable_weightã€‚å¯¹äºgroup seæ¥è¯´åªè¦å…¶ä¸‹æœ‰ä¸€ä¸ªseæ˜¯runnableæˆ–runningï¼Œåˆ™group seä¸ºrunnableæˆ–runningã€‚runnable_weighç­‰äºå¤„äºrunnableæˆ–runningçš„ä»»åŠ¡æ•°é‡ã€‚ - runningï¼šä¸ºcfs_rq-&gt;curr seï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰æ˜¯å¦æœ‰ä»»åŠ¡æ­£åœ¨è¿è¡Œã€‚</p>
<p>å¯¹äºtask seæ¥è¯´load,runnable,runningé0å³1ï¼›å¯¹äºgroup seæ¥è¯´ï¼Œload,runningé0å³1ï¼Œrunnableä¸ºgroup seå…¶ä¸‹è¿è¡Œçš„ä»»åŠ¡æ•°é‡ã€‚ä»¥ä¸‹æ˜¯ä¼ å…¥çš„å‚æ•°ç¤ºä¾‹ï¼š â€ƒâ€ƒtask seï¼š load=runnable=1,running=1 â€ƒâ€ƒgroup seï¼š load = 1, runnable = se-&gt;runnable_weight, running =1</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_42aac48fc5555ee453ed5717657f29c7.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_42aac48fc5555ee453ed5717657f29c7.jpg"/></a></p>
<p>ä»ä¸Šé¢çœ‹å‡ºï¼Œå¯¹äºtask seä¸group seçš„è®¡ç®—ï¼ŒåŒºåˆ«ä¸»è¦æ˜¯runnabe_sumçš„è®¡ç®—æ–¹å¼ä¸åŒï¼Œgroup seæ–°å¢è´Ÿè½½è´¡çŒ®éœ€è¦ä¹˜ä»¥runnable_weight(group seå…¶ä¸‹çš„ä»»åŠ¡æ•°é‡)ã€‚ {load|runnable|utils}_sumè®¡ç®—çš„è´Ÿè½½åªæ˜¯æ—¶é—´æ²¡æœ‰æƒé‡ï¼Œä½†æ˜¯load_avgéœ€è¦è€ƒè™‘æƒé‡ï¼Œæ˜¯æƒé‡*æ—¶é—´ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">__update_load_avg_se</span><span class="p">(</span><span class="n">u64</span><span class="w"> </span><span class="n">now</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">se</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="c1">//è®¡ç®—{load|runnable|utils}_sumï¼Œè¿™é‡Œä¼ å…¥ä¸‰ä¸ªå‚æ•°loadï¼Œrunnableï¼Œrunningã€‚</span>
<span class="w">   </span><span class="c1">//loadï¼šä¸ºse-&gt;on_rqï¼Œse-&gt;on_rq=1è¡¨ç¤ºrunning+runnable</span>
<span class="w">   </span><span class="c1">//runnableï¼šä¸ºse_runnable(se)ï¼Œè¿™é‡Œè¦è€ƒè™‘å½“å‰çš„è°ƒåº¦å®ä½“æ˜¯group seè¿˜æ˜¯task seï¼Œå¦‚æœæ˜¯task seé‚£å°±ç­‰äºse-&gt;on_rqï¼Œä½†æ˜¯å¦‚æœæ˜¯group seåˆ™ä¸ºse-&gt;runnable_weightï¼Œè¯¥å€¼å®é™…ç­‰äºè¯¥ä»»åŠ¡ç»„ä¸­running+runnableçš„ä»»åŠ¡æ•°é‡ï¼Œå¯¹äºç»„è°ƒåº¦å®ä½“æ¥è¯´ç»„å†…å³ä½¿æœ‰ä¸€ä¸ªä»»åŠ¡å¤„äºrunningæˆ–runnableé‚£ä¹ˆgroup seå°±æ˜¯runningæˆ–runnableã€‚</span>
<span class="w">   </span><span class="c1">//runningï¼šä»£è¡¨å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">___update_load_sum</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">,</span><span class="w"> </span><span class="o">!!</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">on_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se_runnable</span><span class="p">(</span><span class="n">se</span><span class="p">),</span>
<span class="w">                </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">curr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">se</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//è®¡ç®—{load|runnable|utils}_avgï¼Œå…¶ä¸­å¯¹äºload_suméœ€è¦ä¹˜ä»¥æƒé‡se_weight(se)ã€‚</span>
<span class="w">        </span><span class="n">___update_load_avg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">,</span><span class="w"> </span><span class="n">se_weight</span><span class="p">(</span><span class="n">se</span><span class="p">));</span>
<span class="w">        </span><span class="n">cfs_se_util_change</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">);</span>
<span class="w">        </span><span class="n">trace_pelt_se_tp</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="update_cfs_rq_load_avg">update_cfs_rq_load_avg</h4>
<ul>
<li>loadï¼šä¸ºscale_load_down(cfs_rq-&gt;load.weight)ï¼Œå¯ä»¥å…ˆç®€å•ç†è§£ä¸ºcfs_rqä¸Šæ‰€æœ‰ä»»åŠ¡çš„æƒé‡å’Œã€‚</li>
<li>runnableï¼šä¸ºh_nr_runningï¼Œè¡¨ç¤ºå½“å‰åœ¨å°±ç»ªé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°é‡ï¼ŒåŒ…å«æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ã€‚</li>
<li>runningï¼šä¸ºcfs_rq-&gt;curr != NULLï¼Œcfs_rqé˜Ÿåˆ—æœ‰ä»»åŠ¡è¿è¡Œã€‚</li>
</ul>
<p>ä¸‹é¢ç¤ºä¾‹å¯¹æ¯”task seä¸cfs_rqã€‚ â€ƒâ€ƒTask se: load=runnable=1,running=1 â€ƒâ€ƒgroup seï¼šload = cfs_rq-&gt;load.weight,runnable = cfs_rq-&gt;h_nr_running, running =1</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_285567189c9839ddcf0895bd8f22ea0f.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/7-è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ªç®€ä»‹/images/wp_editor_md_285567189c9839ddcf0895bd8f22ea0f.jpg"/></a></p>
<p>ä»ä¸Šé¢å…¬å¼å¯ä»¥çœ‹å‡ºï¼Œtask seå’Œcfs-rqçš„å·®åˆ« â‘  task ï¼ˆgroupï¼‰seçš„load_sumä¸è€ƒè™‘æƒé‡åªè€ƒè™‘æ—¶é—´ï¼Œè€Œcfs_rqéœ€è¦è€ƒè™‘æ•´ä¸ªé˜Ÿåˆ—çš„æƒé‡ã€‚ â‘¡ task seæ˜¯ä¸€ä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥ runnable_sumæ–°å¢è´Ÿè½½è´¡çŒ®ä¹˜1ï¼Œè€Œtask group ã€cfs_rq è®¡ç®—çš„runnable_suméœ€è¦ä¹˜ä»¥ä»»åŠ¡æ•°é‡ã€‚ â‘¢ load_avgå¯¹äºcfs_rqæ˜¯ä¸éœ€è¦ä¹˜ä»¥æƒé‡çš„ï¼Œè€Œtask seéœ€è¦ç›¸ä¹˜æƒé‡ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">__update_load_avg_cfs_rq</span><span class="p">(</span><span class="n">u64</span><span class="w"> </span><span class="n">now</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="c1">//è®¡ç®—cfs_rqçš„{load|runnable|utils}_sumï¼Œ</span>
<span class="w">   </span><span class="c1">//load = cfs_rq-&gt;load.weightä¸ºå½“å‰cfs_rqé˜Ÿåˆ—ä¸Šçš„æƒé‡å’Œï¼Œå¯¹äº64ä¸ºç³»ç»Ÿåšäº†ç¼©æ”¾ã€‚</span>
<span class="w">   </span><span class="c1">//runnable = cfs_rq-&gt;h_nr_runningï¼Œå½“å‰é˜Ÿåˆ—ä¸Šçš„ä»»åŠ¡æ•°é‡ã€‚</span>
<span class="w">   </span><span class="c1">//running = cfs_rq-&gt;curr != NULL</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">___update_load_sum</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">,</span>
<span class="w">                </span><span class="n">scale_load_down</span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="p">),</span>
<span class="w">                </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">h_nr_running</span><span class="p">,</span>
<span class="w">                </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">curr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">___update_load_avg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">trace_pelt_cfs_tp</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>å®é™…ä¸Šcfs_rqçš„è´Ÿè½½åˆå€¼ï¼Œå°±æ˜¯å…¶ä¸‹task ï¼ˆgroupï¼‰çš„å’Œï¼Œå¾—åˆ°åˆå€¼åï¼Œå¦‚æœæ²¡æœ‰ä»»åŠ¡å‡ºå…¥é˜Ÿåˆ—çš„æƒ…å†µä¸‹ï¼Œå°±æŒ‰ç…§ä¸Šé¢çš„å…¬å¼è¿›è¡Œæ›´æ–°è´Ÿè½½ï¼Œå¦‚æœè¯´æœ‰ä»»åŠ¡å‡ºå…¥é˜Ÿåˆ—é‚£ä¹ˆå°±éœ€è¦é‡æ–°æ›´æ–°åˆå€¼ï¼Œè¿™ä¸ªè¿‡ç¨‹å«è´Ÿè½½ä¼ æ’­ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">enqueue_load_avg</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">se</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_avg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_avg</span><span class="p">;</span>
<span class="w">    </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">se_weight</span><span class="p">(</span><span class="n">se</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">util_avg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">util_avg</span><span class="p">;</span>
<span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">util_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">util_sum</span><span class="p">;</span>
<span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">runnable_avg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">runnable_avg</span><span class="p">;</span>
<span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">runnable_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">runnable_sum</span><span class="p">;</span>
</code></pre></div>
<h4 id="___update_load_sum">___update_load_sum</h4>
<p>__update_load_avg_seå’Œ__update_load_avg_cfs_rqæœ€ç»ˆéƒ½è¦è°ƒç”¨___update_load_sumæ¥è®¡ç®—è°ƒåº¦å®ä½“è´Ÿè½½ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">___update_load_sum</span><span class="p">(</span><span class="n">u64</span><span class="w"> </span><span class="n">now</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_avg</span><span class="w"> </span><span class="o">*</span><span class="n">sa</span><span class="p">,</span>
<span class="w">          </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">load</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">runnable</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">running</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">delta</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//deltaä¸ºå½“å‰æ—¶åˆ»ä¸ä¸Šä¸€æ¬¡è®¡ç®—è´Ÿè½½çš„æ—¶é—´å·®</span>
<span class="w">    </span><span class="n">delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">last_update_time</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * This should only happen when time goes backwards, which it</span>
<span class="cm">     * unfortunately does during sched clock init when we swap over to TSC.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">s64</span><span class="p">)</span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">last_update_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Use 1024ns as the unit of measurement since it\'s a reasonable</span>
<span class="cm">     * approximation of 1us and fast to compute.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">delta</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">delta</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">last_update_time</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * running is a subset of runnable (weight) so running can\'t be set if</span>
<span class="cm">     * runnable is clear. But there are some corner cases where the current</span>
<span class="cm">     * se has been already dequeued but cfs_rq-&gt;curr still points to it.</span>
<span class="cm">     * This means that weight will be 0 but not running for a sched_entity</span>
<span class="cm">     * but also for a cfs_rq if the latter becomes idle. As an example,</span>
<span class="cm">     * this happens during idle_balance() which calls</span>
<span class="cm">     * update_blocked_averages().</span>
<span class="cm">     *</span>
<span class="cm">     * Also see the comment in accumulate_sum().</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">load</span><span class="p">)</span>
<span class="w">        </span><span class="n">runnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//å¦‚æœload=0ï¼Œå³cfs_rq-&gt;0ä¸º0ï¼Œé‚£ä¹ˆä»»åŠ¡ä¸ä¼šå¤„äºrunningã€runnableï¼Œå› æ­¤ä¹Ÿä¸éœ€è¦è®¡</span>
<span class="c1">//ç®—runnableã€runningçš„æ–°å¢è´Ÿè½½è´¡çŒ®ã€‚æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡å³ä½¿å‡ºé˜Ÿäº†ï¼Œä½†æ˜¯cfs_rq=1ã€‚</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Now we know we crossed measurement unit boundaries. The *_avg</span>
<span class="cm">     * accrues by two steps:</span>
<span class="cm">     *</span>
<span class="cm">     * Step 1: accumulate *_sum since last_update_time. If we haven\'t</span>
<span class="cm">     * crossed period boundaries, finish.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="c1">//è®¡ç®—*_sumè´Ÿè½½ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">accumulate_sum</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="w"> </span><span class="n">load</span><span class="p">,</span><span class="w"> </span><span class="n">runnable</span><span class="p">,</span><span class="w"> </span><span class="n">running</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>deltaä¸ºè®¡ç®—å½“å‰ä¸ä¸Šä¸€æ¬¡æ›´æ–°è´Ÿè½½æƒé‡çš„å·®å€¼ï¼Œç”¨äºåç»­è®¡ç®—è°ƒåº¦è´Ÿè½½ä¿¡æ¯ã€‚è¯¥å‡½æ•°ä¸­ä¼šåˆ¤æ–­loadæ˜¯å¦ç­‰äº0ï¼Œå¦‚æœä¸º0ï¼Œè¯´æ˜å½“å‰è°ƒåº¦å®ä½“æ²¡æœ‰å¤„äºrunningæˆ–runnableçŠ¶æ€ï¼Œæ²¡æœ‰åœ¨å°±ç»ªé˜Ÿåˆ—ä¸­å°±ä¸éœ€è¦è®¡ç®—æ–°å¢è°ƒåº¦è´Ÿè½½è´¡çŒ®ï¼ˆæ³¨æ„æ˜¯è´¡çŒ®ï¼Œè¡¨å¢é‡ï¼‰ï¼ŒåŒæ—¶è°ƒåº¦å®ä½“åº”è¯¥è¦è¿›è¡Œè°ƒåº¦è´Ÿè½½è¡°å‡ï¼ˆæ²¡å¾—è¿è¡Œï¼Œé‚£ä¹ˆè‡ªç„¶å¯¹CPUçš„æ¶ˆè€—è¦é™ä½ï¼‰ï¼Œå› æ­¤ä¼šè°ƒç”¨decay_loadå¯¹load_sumã€runnable_sumã€util_sumè¿›è¡Œè¡°å‡ï¼›åä¹‹å¦‚æœloadä¸ä¸º0ï¼Œé‚£ä¹ˆè¯´æ˜è°ƒåº¦å®ä½“å¤„äºrunningæˆ–runnableï¼Œé‚£ä¹ˆå°±éœ€è¦è®¡ç®—è°ƒåº¦è´Ÿè½½è´¡çŒ®ï¼Œæœ€åè°ƒåº¦è´Ÿè½½ç­‰äºè¡°å‡çš„è´Ÿè½½+æ–°å¢è´¡çŒ®è´Ÿè½½ã€‚</p>
<h3 id="_5">è´Ÿè½½ä¼ æ’­</h3>
<p>å½“ä¸€ä¸ªæ–°åˆ›å»ºæˆ–ä»å…¶ä»–cpuè¿ç§»çš„task seåŠ å…¥åˆ°ä¸€ä¸ªæ–°çš„cfs_rqé˜Ÿåˆ—æ—¶ï¼Œä¼šå¯¼è‡´æ•´ä¸ªå±‚çº§çš„cfs_rqè´Ÿè½½å‘ç”Ÿå˜åŒ–ã€‚ä»»åŠ¡çš„ä¼‘çœ å¯¼è‡´å‡ºé˜Ÿçš„ä¸ç®—ï¼Ÿ â€ƒâ€ƒä¼šè°ƒç”¨attach_entity_load_avg/detach_entity_load_avgæ¥æ›´æ–°cfs_rq load_avgã€‚æœ¬ç« èŠ‚æˆ‘ä»¬ä»¥task seä»ä¸€ä¸ªcpuè¿ç§»åˆ°å¦å¤–ä¸€ä¸ªcpuçš„cfs_rqä¸ºä¾‹è¯´æ˜ï¼Œupdate_load_avg-&gt;attach_entity_load_avgã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">attach_entity_load_avg</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">se</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * cfs_rq-&gt;avg.period_contrib can be used for both cfs_rq and se.</span>
<span class="cm">     * See ___update_load_avg() for details.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">divider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pelt_divider</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * When we attach the @se to the @cfs_rq, we must align the decay</span>
<span class="cm">     * window because without that, really weird and wonderful things can</span>
<span class="cm">     * happen.</span>
<span class="cm">     *</span>
<span class="cm">     * XXX illustrate</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="c1">//å½“å‰è°ƒåº¦å®ä½“çš„å‚æ•°ä»æ‰€å±cfs_rqä¸­æ›´æ–°</span>
<span class="w">    </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">last_update_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">last_update_time</span><span class="p">;</span>
<span class="w">    </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">period_contrib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">period_contrib</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Hell(o) Nasty stuff.. we need to recompute _sum based on the new</span>
<span class="cm">     * period_contrib. This isn\'t strictly correct, but since we\'re</span>
<span class="cm">     * entirely outside of the PELT hierarchy, nobody cares if we truncate</span>
<span class="cm">     * _sum a little.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="c1">//é‡æ–°è®¡ç®—utils_sumã€runnable_sumã€load_sumã€‚</span>
<span class="w">    </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">util_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">util_avg</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">divider</span><span class="p">;</span>

<span class="w">    </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">runnable_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">runnable_avg</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">divider</span><span class="p">;</span>

<span class="w">    </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_avg</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">divider</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">se_weight</span><span class="p">(</span><span class="n">se</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_sum</span><span class="p">)</span>
<span class="w">        </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">div_u64</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_sum</span><span class="p">,</span><span class="w"> </span><span class="n">se_weight</span><span class="p">(</span><span class="n">se</span><span class="p">));</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//å°†è´Ÿè½½ä¿¡æ¯{load|runnable|util}_æ›´æ–°ç´¯åŠ åˆ°cfs_rqä¸­ã€‚</span>
<span class="w">    </span><span class="n">enqueue_load_avg</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">);</span>
<span class="w">    </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">util_avg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">util_avg</span><span class="p">;</span>
<span class="w">    </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">util_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">util_sum</span><span class="p">;</span>
<span class="w">    </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">runnable_avg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">runnable_avg</span><span class="p">;</span>
<span class="w">    </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">runnable_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">runnable_sum</span><span class="p">;</span>
<span class="c1">//å¯åŠ¨è´Ÿè½½ä¼ æ’­ï¼Œä½¿èƒ½äº†è¿™ä¸ªæ ‡å¿—ï¼Œå¯¹äºgseç±»å‹çš„è°ƒåº¦å®ä½“æ‰èƒ½è°ƒç”¨</span>
<span class="c1">//propagate_entity_load_avgè¿›è¡Œè´Ÿè½½ä¼ æ’­ã€‚</span>
<span class="w">    </span><span class="n">add_tg_cfs_propagate</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_sum</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//è§¦å‘è°ƒé¢‘</span>
<span class="w">    </span><span class="n">cfs_rq_util_change</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="n">trace_pelt_cfs_tp</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>å¯¹äºç»„ä»»åŠ¡è°ƒåº¦å®ä½“ï¼Œè¿˜éœ€è¦è°ƒç”¨propagate_entity_load_avgå‡½æ•°æ›´æ–°å½“å‰å±‚çº§çš„è´Ÿè½½ä¿¡æ¯ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">propagate_entity_load_avg</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">se</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">gcfs_rq</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//å¦‚æœæ—¶taskç›´æ¥è¿”å›ï¼Œåªæœ‰gseæ‰éœ€è¦ä¼ æ’­å’Œæ›´æ–°è´Ÿè½½ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">entity_is_task</span><span class="p">(</span><span class="n">se</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//è·å–gseå…¶ä¸‹çš„cfs_rq</span>
<span class="n">gcfs_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group_cfs_rq</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<span class="c1">//å¦‚æœæ²¡æœ‰å¯åŠ¨ä¼ æ’­ï¼Œç›´æ¥è¿”å›ï¼Œæœ‰å˜åŒ–æ‰éœ€è¦æ›´æ–°ï¼Œæ²¡æœ‰å°±ç›´æ¥è¿”å›ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gcfs_rq</span><span class="o">-&gt;</span><span class="n">propagate</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">gcfs_rq</span><span class="o">-&gt;</span><span class="n">propagate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//è·å–gseæ‰€å±çš„cfs_rq</span>
<span class="n">cfs_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq_of</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//å°†gcfs_rqä¸Šçš„runnable_sumä¼ é€’åˆ°å…¶æ‰€å±çš„cfs_rqä¸Šï¼Œåç»­ä¼šä¸æ–­çš„å¾€ä¸Šå¾ªç¯æ›´æ–°ã€‚</span>
<span class="w">    </span><span class="n">add_tg_cfs_propagate</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">gcfs_rq</span><span class="o">-&gt;</span><span class="n">prop_runnable_sum</span><span class="p">);</span>

<span class="c1">//æ›´æ–°gseçš„utis_avg/sumï¼Œæ‰€å±cfsçš„utis_avg/sum</span>
<span class="n">update_tg_cfs_util</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">gcfs_rq</span><span class="p">);</span>
<span class="c1">//æ›´æ–°gseçš„runnable_avg/sumï¼Œæ‰€å±cfsçš„runnable_avg/sum</span>
<span class="n">update_tg_cfs_runnable</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">gcfs_rq</span><span class="p">);</span>
<span class="c1">//æ›´æ–°gseçš„laod_avg/sumï¼Œæ‰€å±cfsçš„load_avg/sum</span>
<span class="w">    </span><span class="n">update_tg_cfs_load</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">gcfs_rq</span><span class="p">);</span>

<span class="w">    </span><span class="n">trace_pelt_cfs_tp</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">);</span>
<span class="w">    </span><span class="n">trace_pelt_se_tp</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>åœ¨æ›´æ–°{utils|runnable|load}_sum|avgçš„æ—¶å€™ï¼Œæ›´æ–°gseå’Œæ‰€å±çš„cfs_rqï¼Œè¿™é‡Œçš„æ›´æ–°ä¸__update_load_avg_seå’Œ__update_load_avg_cfs_rqçš„è°ƒç”¨è®¡ç®—æ˜¯ä¸æ˜¯é‡å¤äº†ï¼Ÿæ¯•ç«Ÿè°ƒç”¨å…³ç³»æ˜¯update_load_avgä¸­å…ˆè°ƒç”¨__update_load_avg_seå’Œ__update_load_avg_cfs_rqåˆ†åˆ«è®¡ç®—seå’Œcfs_rqï¼Œç„¶åå†è°ƒç”¨propagate_entity_load_avgè¿›è¡Œæ›´æ–°ã€‚ç­”æ¡ˆæ˜¾ç„¶ä¸æ˜¯ï¼Œè¿™é‡Œçš„æ›´æ–°å¯ä»¥è®¤ä¸ºæ˜¯è®¾ç½®åˆå§‹å€¼ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ¯æ¬¡éƒ½ä¼šè°ƒç”¨ä¸”å¿…é¡»æ˜¯group seç±»å‹æ‰ä¼šè°ƒç”¨propagate_entity_load_avgè®¡ç®—ã€‚__update_load_avg_seå’Œ__update_load_avg_cfs_rqæ˜¯åœ¨å…¶åˆå§‹å€¼çš„åŸºç¡€ä¸Šè¿›è¡Œæ›´æ–°è´Ÿè½½ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ.html">â† è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ</a>
    <a class="next" href="cfsè°ƒåº¦å®ç°.html">CFSè°ƒåº¦å®ç° â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

