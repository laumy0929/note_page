<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Linux risc-v head.Sè°ƒè¯•è®°å½• - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">è°ƒè¯•å‡†å¤‡</a><ul><li><a href="#gdb">gdbè°ƒè¯•</a></li><li><a href="#printk">printkè°ƒè¯•</a></li></ul></li><li><a href="#try-satp">try satpæ¨¡å¼</a><ul></ul></li><li><a href="#mmu">ä½¿èƒ½MMU</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>Linux risc-v head.Sè°ƒè¯•è®°å½•</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-06-13
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      risc-v
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">è°ƒè¯•å‡†å¤‡</h2>
<h3 id="gdb">gdbè°ƒè¯•</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/06/wp_editor_md_bea9bd944eac8755afec8ce6e48abedd.jpg"><img alt="" src="assets/doc/02-risc-v/linux-risc-v-head-sè°ƒè¯•è®°å½•/images/wp_editor_md_bea9bd944eac8755afec8ce6e48abedd.jpg"/></a></p>
<p>0x0000000080200000ä¸ºopensbiè·³è½¬æ‰§è¡Œçš„ç‰©ç†åœ°å€ï¼Œlinuxå†…æ ¸çš„imgä¼šåŠ è½½åˆ°è¿™ä¸ªåœ°å€è¿è¡Œï¼Œå¦‚æœè¦åœ¨è¿™ä¸ªåœ°æ–¹æ–­ç‚¹ï¼Œå°±b *(0x0000000080200000),æ²¡æ³•å¯¹head.Sä¸­è¿›è¡Œæ–­ç‚¹ï¼Œå› ä¸ºlinuxåŠ è½½åä¼šå˜æˆè™šæ‹Ÿåœ°å€ã€‚è°ƒè¯•çš„ç¬¦å·éœ€è¦æŠŠCONFIG_DEBUG_INFO=yæ‰“å¼€ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">li</span><span class="w">  </span><span class="n">s4</span><span class="p">,</span><span class="mi">-13</span>
<span class="n">j</span><span class="w">   </span><span class="n">_start_kernel</span><span class="w"> </span><span class="c1">//j 0x802010cc</span>

<span class="nl">_start_kernel</span><span class="p">:</span>

<span class="w">    </span><span class="c1">//å…³é—­æ‰€æœ‰çš„ä¸­æ–­</span>
<span class="w">    </span><span class="n">csrw</span><span class="w">    </span><span class="n">sie</span><span class="p">,</span><span class="n">zero</span>
<span class="w">    </span><span class="n">csrw</span><span class="w">    </span><span class="n">sip</span><span class="p">,</span><span class="n">zero</span>

<span class="w">    </span><span class="c1">//åŠ è½½gpæŒ‡é’ˆ</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">gp</span><span class="p">,</span><span class="w"> </span><span class="n">__global_pointer$</span>

<span class="w">    </span><span class="c1">//å…³æ‰æµ®ç‚¹</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">SR_FS</span>
<span class="w">    </span><span class="n">csrc</span><span class="w"> </span><span class="n">CSR_STATUS</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>

<span class="w">    </span><span class="c1">//æŒ‘é€‰ä¸€ä¸ªä¸»æ ¸æ¥è¿è¡Œåˆå§‹åŒ–çš„ä»£ç ï¼Œå…¶ä»–æ ¸è·³è½¬åˆ°Lsecondary_parkç­‰å¾…ï¼ˆè¿›å…¥wfiï¼‰</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">CONFIG_NR_CPUS</span>
<span class="w">    </span><span class="n">blt</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">Lgood_cores</span>
<span class="w">    </span><span class="n">tail</span><span class="w"> </span><span class="p">.</span><span class="n">Lsecondary_park</span>
<span class="p">.</span><span class="n">Lgood_cores</span><span class="err">ï¼š</span>
<span class="w">    </span><span class="c1">//ä½ç”µé‡æ£€æŸ¥ï¼Ÿ</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">hart_lottery</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="mi">1</span>
<span class="w">    </span><span class="n">amoadd</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a3</span><span class="p">)</span>
<span class="w">    </span><span class="n">bnez</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">Lsecondary_start</span>
</code></pre></div>
<h4 id="_2">ç›´æ¥ä½¿ç”¨ç‰©ç†åœ°å€æ–­ç‚¹</h4>
<p>è°ƒè¯•linux</p>
<p>CONFIG_DEBUG_INFO=y b *(0x0000000080200000) file linux-5.18/vmlinux</p>
<p>linuxå†…æ ¸åœ¨æ²¡ä½¿èƒ½mmuå‰çš„ä»£ç å¦‚ä½•æ‰“æ–­ç‚¹ï¼Ÿ</p>
<p>åªèƒ½æ‰“ä»£ç æ‰€åœ¨çš„ç‰©ç†åœ°å€å¦‚b *(0x0000000080200000)</p>
<p>æ€ä¹ˆç¡®å®šä»£ç çš„ç¬¦å·çš„ç‰©ç†åœ°å€ï¼Ÿ</p>
<ol>
<li>info address setup_vm è·å¾—ç¬¦å·çš„è™šæ‹Ÿåœ°å€</li>
<li>riscv64-unknown-linux-gnu-readelf -h vmlinux è·å–å†…æ ¸é•œåƒçš„å…¥å£è™šæ‹Ÿåœ°å€</li>
<li>è·å–å†…æ ¸é•œåƒçš„åŠ è½½æ‰€åœ¨ç‰©ç†åœ°å€</li>
<li>ç›®æ ‡ç¬¦å·ç‰©ç†åœ°å€ = ç¬¦å·è™šæ‹Ÿåœ°å€-é•œåƒå…¥å£è™šæ‹Ÿåœ°å€ + é•œåƒåŠ è½½çš„ç‰©ç†åœ°å€</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">info</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">setup_vm</span>
<span class="n">Symbol</span><span class="w"> </span><span class="s">"setup_vm"</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0xffffffff80804a82</span><span class="p">.</span>

<span class="n">ç›®æ ‡ç‰©ç†åœ°å€</span><span class="o">=</span><span class="mh">0xffffffff80804a82-0xffffffff80000000</span><span class="o">+</span><span class="mh">0x0000000080200000</span>

<span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="mh">0x80A04A82</span><span class="p">)</span>
</code></pre></div>
<h4 id="_3">ç¬¦å·æ–­ç‚¹</h4>
<p>riscv64-unknown-linux-gnu-readelf -h vmlinux è·å–å†…æ ¸é•œåƒçš„å…¥å£è™šæ‹Ÿåœ°å€ï¼Œç„¶åä½¿ç”¨riscv64-unknown-linux-gnu-readelf -S vmlinuxè·å–å„ä¸ªæ®µç›¸å¯¹èµ·å§‹æ®µçš„åç§»ï¼Œå„ä¸ªæ®µçš„åç§»+é•œåƒåŠ è½½çš„ç‰©ç†åœ°å€å³æ˜¯ç¬¦å·çš„åœ°å€ï¼Œæœ€åä½¿ç”¨add-symbol-fileæ·»åŠ ç¬¦å·ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span><span class="n">readelf</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="n">vmlinux</span>
<span class="n">There</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="mi">38</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">headers</span><span class="p">,</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0xb3cc860</span><span class="o">:</span>

<span class="n">Section</span><span class="w"> </span><span class="n">Headers</span><span class="o">:</span>
<span class="w">  </span><span class="p">[</span><span class="n">Nr</span><span class="p">]</span><span class="w"> </span><span class="n">Name</span><span class="w">              </span><span class="n">Type</span><span class="w">             </span><span class="n">Address</span><span class="w">           </span><span class="n">Offset</span>
<span class="w">       </span><span class="n">Size</span><span class="w">              </span><span class="n">EntSize</span><span class="w">          </span><span class="n">Flags</span><span class="w">  </span><span class="n">Link</span><span class="w">  </span><span class="n">Info</span><span class="w">  </span><span class="n">Align</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w">                   </span><span class="nb">NULL</span><span class="w">             </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="mo">00000000</span>
<span class="w">       </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">           </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">text</span><span class="w">        </span><span class="n">PROGBITS</span><span class="w">         </span><span class="n">ffffffff80000000</span><span class="w">  </span><span class="mo">00001000</span>
<span class="w">       </span><span class="mf">0000000000001e90</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">AX</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">4096</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="w">             </span><span class="n">PROGBITS</span><span class="w">         </span><span class="n">ffffffff80002000</span><span class="w">  </span><span class="mo">00003000</span>
<span class="w">       </span><span class="mo">000000000065</span><span class="n">bdb0</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">AX</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">4</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">text</span><span class="w">        </span><span class="n">PROGBITS</span><span class="w">         </span><span class="n">ffffffff80800000</span><span class="w">  </span><span class="mo">00</span><span class="mi">800000</span>
<span class="w">       </span><span class="mo">0000000000035132</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">AX</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">2097152</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">exit</span><span class="p">.</span><span class="n">text</span><span class="w">        </span><span class="n">PROGBITS</span><span class="w">         </span><span class="n">ffffffff80835138</span><span class="w">  </span><span class="mo">00</span><span class="mi">835138</span>
<span class="w">       </span><span class="mo">0000000000001</span><span class="mi">996</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">AX</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">2</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">data</span><span class="w">        </span><span class="n">PROGBITS</span><span class="w">         </span><span class="n">ffffffff80a00000</span><span class="w">  </span><span class="mo">00</span><span class="mi">837000</span>
<span class="w">       </span><span class="mf">0000000000014e38</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">WA</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">4096</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">data</span><span class="p">..</span><span class="n">percpu</span><span class="w">     </span><span class="n">PROGBITS</span><span class="w">         </span><span class="n">ffffffff80a15000</span><span class="w">  </span><span class="mo">00</span><span class="mi">84</span><span class="n">c000</span>
<span class="w">       </span><span class="mf">00000000000084f</span><span class="mi">8</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">WA</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">64</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">alternative</span><span class="w">      </span><span class="n">PROGBITS</span><span class="w">         </span><span class="n">ffffffff80a1d4f8</span><span class="w">  </span><span class="mf">008544f</span><span class="mi">8</span>
<span class="w">       </span><span class="mo">00000000000002</span><span class="mi">88</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">   </span><span class="n">A</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">1</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="n">rodata</span><span class="w">           </span><span class="n">PROGBITS</span><span class="w">         </span><span class="n">ffffffff80c00000</span><span class="w">  </span><span class="mo">00</span><span class="mi">855000</span>
<span class="w">       </span><span class="mo">00000000001</span><span class="mi">95710</span><span class="w">  </span><span class="mo">0000000000000000</span><span class="w">  </span><span class="n">WA</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">64</span>
</code></pre></div>
<p>å¦‚.textæ®µç›¸å¯¹åç§»ä¸ºffffffff80002000-ffffffff80000000=0x2000ï¼Œå› æ­¤ç¬¦å·æ·»åŠ ä½ç½®ä¸º 0x80200000 +0x2000=0x80202000</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">add</span><span class="o">-</span><span class="n">symbol</span><span class="o">-</span><span class="n">file</span><span class="w"> </span><span class="n">linux</span><span class="mf">-5.18</span><span class="o">/</span><span class="n">vmlinux</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">text</span><span class="w"> </span><span class="mh">0x80200000</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="w"> </span><span class="mh">0x80202000</span><span class="w">  </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="p">.</span><span class="n">rodata</span><span class="w"> </span><span class="mh">0x80e00000</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">text</span><span class="w"> </span><span class="mh">0x80a00000</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="mh">0x80c00000</span>
<span class="n">add</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="s">"linux-5.18/vmlinux"</span><span class="w"> </span><span class="n">at</span>
<span class="w">        </span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">text_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80200000</span>
<span class="w">        </span><span class="p">.</span><span class="n">text_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80202000</span>
<span class="w">        </span><span class="p">.</span><span class="n">rodata_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80e00000</span>
<span class="w">        </span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">text_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80a00000</span>
<span class="w">        </span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">data_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80c00000</span>
<span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="n">y</span>
<span class="n">Reading</span><span class="w"> </span><span class="n">symbols</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">linux</span><span class="mf">-5.18</span><span class="o">/</span><span class="n">vmlinux</span><span class="p">...</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">kernel_mapping</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">page_offset</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">virt_addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">phys_addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* Offset between linear mapping virtual address and kernel load address */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">va_pa_offset</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* Offset between kernel mapping virtual address and kernel load address */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">va_kernel_pa_offset</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">va_kernel_xip_pa_offset</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_XIP_KERNEL</span>
<span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">xiprom</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">xiprom_sz</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>
</code></pre></div>
<h3 id="printk">printkè°ƒè¯•</h3>
<p>æœªä½¿èƒ½MMUå¦‚ä½•ä½¿ç”¨printfï¼Ÿ</p>
<p>æƒ³è¦åœ¨setup_vmé‡Œé¢è°ƒç”¨æ‰“å°ï¼Œå‘ç°è¿™ä¸ªé˜¶æ®µæ˜¯ä¸èƒ½ä½¿ç”¨printkçš„ï¼Œå› ä¸ºmmuè¿˜æ²¡å¼€å¯ã€‚å¯ä»¥è°ƒç”¨åˆ°opensbiè¿›è¡Œæ‰“å°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="o">+</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">_sbi_ecall</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ext</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fid</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg0</span><span class="p">,</span>
<span class="o">+</span><span class="w">                       </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg1</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg2</span><span class="p">,</span>
<span class="o">+</span><span class="w">                       </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg3</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg4</span><span class="p">,</span>
<span class="o">+</span><span class="w">                       </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg5</span><span class="p">)</span>
<span class="o">+</span><span class="p">{</span>
<span class="o">+</span>
<span class="o">+</span><span class="w">       </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"a0"</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">arg0</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"a1"</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">arg1</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"a2"</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">arg2</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a3</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"a3"</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">arg3</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a4</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"a4"</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">arg4</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a5</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"a5"</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">arg5</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a6</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"a6"</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">fid</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="k">register</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">a7</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"a7"</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">ext</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">(</span><span class="s">"ecall"</span>
<span class="o">+</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="s">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">a0</span><span class="p">),</span><span class="w"> </span><span class="s">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="o">+</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="s">"r"</span><span class="w"> </span><span class="p">(</span><span class="n">a2</span><span class="p">),</span><span class="w"> </span><span class="s">"r"</span><span class="w"> </span><span class="p">(</span><span class="n">a3</span><span class="p">),</span><span class="w"> </span><span class="s">"r"</span><span class="w"> </span><span class="p">(</span><span class="n">a4</span><span class="p">),</span><span class="w"> </span><span class="s">"r"</span><span class="w"> </span><span class="p">(</span><span class="n">a5</span><span class="p">),</span><span class="w"> </span><span class="s">"r"</span><span class="w"> </span><span class="p">(</span><span class="n">a6</span><span class="p">),</span><span class="w"> </span><span class="s">"r"</span><span class="w"> </span><span class="p">(</span><span class="n">a7</span><span class="p">)</span>
<span class="o">+</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="s">"memory"</span><span class="p">);</span>
<span class="o">+</span><span class="p">}</span>
<span class="o">+</span>
<span class="o">+</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">_sbi_console_putchar</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ch</span><span class="p">)</span>
<span class="o">+</span><span class="p">{</span>
<span class="o">+</span><span class="w">       </span><span class="n">_sbi_ecall</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="o">+</span><span class="p">}</span>
<span class="o">+</span>
<span class="o">+</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">uart_puts</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="o">+</span><span class="p">{</span>
<span class="o">+</span><span class="w">       </span><span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">               </span><span class="n">_sbi_console_putchar</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="p">}</span>
<span class="o">+</span><span class="p">}</span>
<span class="o">+</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_vsnprintf</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">va_list</span><span class="w"> </span><span class="n">vl</span><span class="p">)</span>
<span class="o">+</span><span class="p">{</span>
<span class="o">+</span><span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="n">longarg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">       </span><span class="kt">size_t</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">format</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                       </span><span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                       </span><span class="k">case</span><span class="w"> </span><span class="sc">'l'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                               </span><span class="n">longarg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="k">break</span><span class="p">;</span>
<span class="o">+</span><span class="w">                       </span><span class="p">}</span>
<span class="o">+</span><span class="w">                       </span><span class="k">case</span><span class="w"> </span><span class="sc">'p'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                               </span><span class="n">longarg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                                       </span><span class="n">out</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'0'</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="p">}</span>
<span class="o">+</span><span class="w">                               </span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                                       </span><span class="n">out</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'x'</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="p">}</span>
<span class="o">+</span><span class="w">                               </span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
<span class="o">+</span><span class="w">                       </span><span class="p">}</span>
<span class="o">+</span><span class="w">                       </span><span class="k">case</span><span class="w"> </span><span class="sc">'x'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                               </span><span class="kt">long</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longarg</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">va_arg</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">va_arg</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="o">+</span><span class="w">                               </span><span class="kt">int</span><span class="w"> </span><span class="n">hexdigits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">longarg</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span><span class="mi">-1</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hexdigits</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                                       </span><span class="kt">int</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">num</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xF</span><span class="p">;</span>
<span class="o">+</span><span class="w">                                       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                                               </span><span class="n">out</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sc">'0'</span><span class="o">+</span><span class="n">d</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sc">'a'</span><span class="o">+</span><span class="n">d</span><span class="mi">-10</span><span class="p">);</span>
<span class="o">+</span><span class="w">                                       </span><span class="p">}</span>
<span class="o">+</span><span class="w">                                       </span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="p">}</span>
<span class="o">+</span><span class="w">                               </span><span class="n">longarg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="k">break</span><span class="p">;</span>
<span class="o">+</span><span class="w">                       </span><span class="p">}</span>
<span class="o">+</span><span class="w">                       </span><span class="k">case</span><span class="w"> </span><span class="sc">'d'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                               </span><span class="kt">long</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longarg</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">va_arg</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">va_arg</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="o">+</span><span class="w">                               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                                       </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">num</span><span class="p">;</span>
<span class="o">+</span><span class="w">                                       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                                               </span><span class="n">out</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'-'</span><span class="p">;</span>
<span class="o">+</span><span class="w">                                       </span><span class="p">}</span>
<span class="o">+</span><span class="w">                                       </span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="p">}</span>
<span class="o">+</span><span class="w">                               </span><span class="kt">long</span><span class="w"> </span><span class="n">digits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">nn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="p">;</span><span class="w"> </span><span class="n">nn</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">digits</span><span class="o">++</span><span class="p">);</span>
<span class="o">+</span><span class="w">                               </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digits</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                                       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                                               </span><span class="n">out</span><span class="p">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'0'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">num</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="o">+</span><span class="w">                                       </span><span class="p">}</span>
<span class="o">+</span><span class="w">                                       </span><span class="n">num</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="p">}</span>
<span class="o">+</span><span class="w">                               </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">digits</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="n">longarg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="k">break</span><span class="p">;</span>
<span class="o">+</span><span class="w">                       </span><span class="p">}</span>
<span class="o">+</span><span class="w">                       </span><span class="k">case</span><span class="w"> </span><span class="sc">'s'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">va_arg</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="p">);</span>
<span class="o">+</span><span class="w">                               </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">s2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                                       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                                               </span><span class="n">out</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">s2</span><span class="p">;</span>
<span class="o">+</span><span class="w">                                       </span><span class="p">}</span>
<span class="o">+</span><span class="w">                                       </span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
<span class="o">+</span><span class="w">                                       </span><span class="n">s2</span><span class="o">++</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="p">}</span>
<span class="o">+</span><span class="w">                               </span><span class="n">longarg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="k">break</span><span class="p">;</span>
<span class="o">+</span><span class="w">                       </span><span class="p">}</span>
<span class="o">+</span><span class="w">                       </span><span class="k">case</span><span class="w"> </span><span class="sc">'c'</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                                       </span><span class="n">out</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span><span class="kt">int</span><span class="p">);</span>
<span class="o">+</span><span class="w">                               </span><span class="p">}</span>
<span class="o">+</span><span class="w">                               </span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="n">longarg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">                               </span><span class="k">break</span><span class="p">;</span>
<span class="o">+</span><span class="w">                       </span><span class="p">}</span>
<span class="o">+</span><span class="w">                       </span><span class="k">default</span><span class="o">:</span>
<span class="o">+</span><span class="w">                               </span><span class="k">break</span><span class="p">;</span>
<span class="o">+</span><span class="w">                       </span><span class="p">}</span>
<span class="o">+</span><span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">'%'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                       </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="o">+</span><span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                               </span><span class="n">out</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">;</span>
<span class="o">+</span><span class="w">                       </span><span class="p">}</span>
<span class="o">+</span><span class="w">                       </span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
<span class="o">+</span><span class="w">               </span><span class="p">}</span>
<span class="o">+</span><span class="w">       </span><span class="p">}</span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">               </span><span class="n">out</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">       </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">               </span><span class="n">out</span><span class="p">[</span><span class="n">n</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">       </span><span class="p">}</span>
<span class="o">+</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span>
<span class="o">+</span><span class="p">}</span>
<span class="o">+</span>
<span class="o">+</span>
<span class="o">+</span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">out_buf</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span><span class="w"> </span><span class="c1">// buffer for _vprintf()</span>
<span class="o">+</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_vprintf</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">va_list</span><span class="w"> </span><span class="n">vl</span><span class="p">)</span>
<span class="o">+</span><span class="p">{</span>
<span class="o">+</span><span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_vsnprintf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">vl</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">out_buf</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">               </span><span class="n">uart_puts</span><span class="p">(</span><span class="s">"error: output string size overflow</span><span class="se">\\</span><span class="s">n"</span><span class="p">);</span>
<span class="o">+</span><span class="w">               </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="o">+</span><span class="w">       </span><span class="p">}</span>
<span class="o">+</span><span class="w">       </span><span class="n">_vsnprintf</span><span class="p">(</span><span class="n">out_buf</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">vl</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="n">uart_puts</span><span class="p">(</span><span class="n">out_buf</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="o">+</span><span class="p">}</span>
<span class="o">+</span>
<span class="o">+</span><span class="kt">int</span><span class="w"> </span><span class="n">_printf</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
<span class="o">+</span><span class="p">{</span>
<span class="o">+</span><span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="o">+</span><span class="w">       </span><span class="kt">va_list</span><span class="w"> </span><span class="n">vl</span><span class="p">;</span>
<span class="o">+</span><span class="w">       </span><span class="n">va_start</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_vprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">vl</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="n">va_end</span><span class="p">(</span><span class="n">vl</span><span class="p">);</span>
<span class="o">+</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="o">+</span><span class="p">}</span>
<span class="o">+</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">pgd_t</span><span class="w"> </span><span class="n">early_pg_dir</span><span class="p">[</span><span class="n">PTRS_PER_PGD</span><span class="p">]</span><span class="w"> </span><span class="n">__initdata</span><span class="w"> </span><span class="n">__aligned</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">);</span>

<span class="w"> </span><span class="cm">/* Number of entries in the page global directory */</span>
<span class="cp">#define PTRS_PER_PGD    (PAGE_SIZE / sizeof(pgd_t))</span>

<span class="cm">/* Number of entries in the page table */</span>
<span class="cp">#define PTRS_PER_PTE    (PAGE_SIZE / sizeof(pte_t))</span>

<span class="n">PAGE_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4096</span>
<span class="k">sizeof</span><span class="p">(</span><span class="n">pgd_t</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>

<span class="n">PTRS_PER_PGD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span>

<span class="n">PGDIR_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x8000000000</span><span class="w">  </span><span class="o">--</span><span class="mi">-512</span><span class="n">G</span>
</code></pre></div>
<h2 id="try-satp">try satpæ¨¡å¼</h2>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">set_satp_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">identity_satp</span><span class="p">,</span><span class="w"> </span><span class="n">hw_satp</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">set_satp_mode_pmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">set_satp_mode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PMD_MASK</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">check_l4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//ä¸‹é¢æ˜¯å¯¹set_satp_modeåˆ°set_satp_mode+4Mä»£ç ç©ºé—´åšè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€æ˜ å°„ï¼Œå³å¡«å……</span>
<span class="w">    </span><span class="c1">//è¿™æ®µç©ºé—´çš„é¡µè¡¨ï¼ŒP4D/PUD/PMD</span>
<span class="w">    </span><span class="n">create_p4d_mapping</span><span class="p">(</span><span class="n">early_p4d</span><span class="p">,</span>
<span class="w">            </span><span class="n">set_satp_mode_pmd</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">early_pud</span><span class="p">,</span>
<span class="w">            </span><span class="n">P4D_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_TABLE</span><span class="p">);</span>
<span class="w">    </span><span class="n">create_pud_mapping</span><span class="p">(</span><span class="n">early_pud</span><span class="p">,</span>
<span class="w">               </span><span class="n">set_satp_mode_pmd</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">early_pmd</span><span class="p">,</span>
<span class="w">               </span><span class="n">PUD_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_TABLE</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/* Handle the case where set_satp_mode straddles 2 PMDs */</span>
<span class="w">    </span><span class="c1">// å¤„ç† `set_satp_mode` è·¨è¶Šä¸¤ä¸ªPMDçš„æƒ…å†µï¼Œå³set_satp_modeå¼€å§‹+4Mçš„ç©ºé—´æ’ç­‰æ˜ å°„</span>
<span class="w">    </span><span class="c1">//PMD_SIZE = 2MBï¼Œ0x200000ï¼Œå…¶å®ä¹Ÿä¸ç”¨è¿™ä¹ˆå¤§ï¼Œ1ä¸ªè¡¨é¡¹ä¹Ÿå¤Ÿäº†ã€‚</span>
<span class="w">    </span><span class="n">create_pmd_mapping</span><span class="p">(</span><span class="n">early_pmd</span><span class="p">,</span>
<span class="w">               </span><span class="n">set_satp_mode_pmd</span><span class="p">,</span><span class="w"> </span><span class="n">set_satp_mode_pmd</span><span class="p">,</span>
<span class="w">               </span><span class="n">PMD_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_KERNEL_EXEC</span><span class="p">);</span>
<span class="w">    </span><span class="n">create_pmd_mapping</span><span class="p">(</span><span class="n">early_pmd</span><span class="p">,</span>
<span class="w">               </span><span class="n">set_satp_mode_pmd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PMD_SIZE</span><span class="p">,</span>
<span class="w">               </span><span class="n">set_satp_mode_pmd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PMD_SIZE</span><span class="p">,</span>
<span class="w">               </span><span class="n">PMD_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_KERNEL_EXEC</span><span class="p">);</span>
<span class="nl">retry</span><span class="p">:</span>
<span class="w">    </span><span class="c1">//é»˜è®¤å…ˆæŒ‰ç…§5çº§é¡µè¡¨æ¥è®¾ç½®</span>
<span class="w">    </span><span class="n">create_pgd_mapping</span><span class="p">(</span><span class="n">early_pg_dir</span><span class="p">,</span>
<span class="w">               </span><span class="n">set_satp_mode_pmd</span><span class="p">,</span>
<span class="w">               </span><span class="n">check_l4</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">early_pud</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">early_p4d</span><span class="p">,</span>
<span class="w">               </span><span class="n">PGDIR_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_TABLE</span><span class="p">);</span>

<span class="w">    </span><span class="n">identity_satp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PFN_DOWN</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">early_pg_dir</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">satp_mode</span><span class="p">;</span>

<span class="w">    </span><span class="n">local_flush_tlb_all</span><span class="p">();</span>
<span class="w">    </span><span class="n">csr_write</span><span class="p">(</span><span class="n">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="n">identity_satp</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//è®¾ç½®satpï¼Œ satp_mode = a/9ï¼Œ early_pg_dir[512]ä¸ºL0é¡µè¡¨é¡¹ç›®</span>
<span class="w">    </span><span class="c1">//æ‰§è¡Œè¯¥ä»£ç åï¼Œå°±ä½¿èƒ½äº†MMUï¼Œåç»­å–æŒ‡ä»¤çš„åœ°å€ï¼Œå°±éœ€è¦ç»è¿‡MMUè½¬åŒ–æ‰æ˜¯å®é™…çš„ç‰©ç†åœ°å€ã€‚</span>
<span class="w">    </span><span class="c1">//è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå‰é¢è¦åšset_satp_modeçš„æ’ç­‰æ˜ å°„ï¼ˆè™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€ï¼‰ã€‚</span>
<span class="w">    </span><span class="c1">//å¦‚æœå‰é¢ä¸è¿›è¡Œæ’ç­‰æ˜ å°„ï¼ŒMMUåœ¨è½¬åŒ–è¿‡ç¨‹ä¸­æŸ¥è¯¢ä¸åˆ°é¡µè¡¨ï¼Œå°±ä¼šè¿›å…¥å¼‚å¸¸</span>
<span class="w">    </span><span class="n">hw_satp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">csr_swap</span><span class="p">(</span><span class="n">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="mi">0ULL</span><span class="p">);</span><span class="w"> </span><span class="c1">//è¿™æ¡ä»£ç æ˜¯è™šæ‹Ÿåœ°å€è¿è¡Œã€‚</span>
<span class="w">    </span><span class="c1">//å°† 0ULL å†™å…¥ CSR_SATP å¯„å­˜å™¨ï¼Œè¿™æ ·å°±ç›¸å½“åˆå…³é—­äº†MMUã€‚</span>
<span class="w">    </span><span class="c1">//å°† CSR_SATP å¯„å­˜å™¨çš„æ—§å€¼è¿”å›ï¼Œå¹¶èµ‹ç»™å˜é‡ hw_satpã€‚</span>
<span class="w">    </span><span class="n">local_flush_tlb_all</span><span class="p">();</span>
<span class="w">    </span><span class="c1">//satpå…ˆé»˜è®¤è®¾ç½®ä¸º10ï¼Œå³Sv57 5çº§é¡µè¡¨ï¼Œå¦‚æœç¡¬ä»¶æ”¯æŒ5çº§é¡µè¡¨SATPå†™å…¥æ—¶è¿”å›çš„å€¼hw_satp</span>
<span class="w">    </span><span class="c1">//å³ä¸ºè®¾ç½®çš„å€¼identity_satp,å¦‚æœä¸ç­‰ï¼Œåˆ™æ˜¯4çº§é¡µè¡¨ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hw_satp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">identity_satp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">check_l4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">disable_pgtable_l5</span><span class="p">();</span>
<span class="w">            </span><span class="n">check_l4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="n">memset</span><span class="p">(</span><span class="n">early_pg_dir</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">retry</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">disable_pgtable_l4</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">early_pg_dir</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">early_p4d</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">early_pud</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">early_pmd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="n">disable_pgtable_l5</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">pgtable_l5_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">page_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PAGE_OFFSET_L4</span><span class="p">;</span>
<span class="w">    </span><span class="n">satp_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SATP_MODE_48</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//è¯´æ˜ä¸æ”¯æŒSv57æ¨¡å¼ï¼Œ5çº§é¡µè¡¨ï¼Œæ›´æ–°page offsetå’Œsatp_mode</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="n">disable_pgtable_l4</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">pgtable_l4_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">page_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PAGE_OFFSET_L3</span><span class="p">;</span>
<span class="w">    </span><span class="n">satp_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SATP_MODE_39</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//è¯´æ˜ä¸æ”¯æŒSv48,4çº§é¡µè¡¨ï¼Œæ›´æ–°page offsetå’Œsatp_modeï¼Œæœ¬ç« çš„å®éªŒæ˜¯æ”¯æŒ4çº§é¡µè¡¨ã€‚</span>
</code></pre></div>
<p>set_satp_modeä½œç”¨æ˜¯ä»5çº§/4çº§é¡µè¡¨å¼€å§‹è¿›è¡Œå°è¯•ç¡¬ä»¶æ˜¯å¦æ”¯æŒï¼Œåˆ¤æ–­çš„æ–¹æ³•æ˜¯å¦‚æœå½“å‰çš„ç­‰çº§æ”¯æŒï¼Œé‚£ä¹ˆsatpå¯„å­˜å™¨æ˜¯å¯ä»¥å†™å…¥çš„ï¼Œå¦‚æœä¸æ”¯æŒå¯„å­˜å™¨å°†æ— æ³•å†™å…¥ã€‚</p>
<p>å‰é¢create_p4d_mapping/create_pud_mapping/create_pmd_mappingä¸‰ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å…ˆå°†set_satp_modeè¿™æ®µä»£ç å¼€å§‹çš„4M(2ä¸ªPMDé¡µè¡¨é¡¹)èŒƒå›´è¿›è¡Œæ’ç­‰æ˜ å°„ï¼ˆè™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€ï¼‰ï¼Œä¹‹æ‰€ä»¥è¦è¿™ä¹ˆåšæ˜¯å› ä¸ºä¸€æ—¦å†™satpå¯„å­˜ä½¿èƒ½mmuåï¼Œå½“å‰è¿è¡Œçš„åœ°å€å°±ä¼šå˜æˆè™šæ‹Ÿåœ°å€ï¼Œè¯¥åœ°å€ä¼šç»è¿‡mmuè½¬åŒ–ä¸ºå®é™…çš„åŠ è½½åœ°å€ï¼Œè€Œå¦‚æœmmuåœ¨è½¬åŒ–è¿‡ç¨‹ä¸­æŸ¥è¯¢ä¸åˆ°è¯¥åœ°å€å¯¹åº”çš„é¡µè¡¨ï¼Œå°±ä¼šå‘ç”Ÿå¼‚å¸¸ã€‚å› æ­¤å…ˆå°†set_satp_modeè¿™æ®µä»£ç çš„é¡µè¡¨å¡«å……å¥½ï¼Œåšå¥½è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ï¼Œåœ¨ä½¿èƒ½MMUåï¼Œä»£ç å¯ä»¥ç»§ç»­æ¥ç€è¿è¡Œã€‚</p>
<ul>
<li>Sv64ï¼š6çº§é¡µè¡¨</li>
<li>Sv57: 5çº§é¡µè¡¨</li>
<li>Sv48ï¼š4çº§é¡µè¡¨</li>
<li>Sv39ï¼š3çº§é¡µè¡¨</li>
</ul>
<p>5çº§é¡µè¡¨ç»“æ„</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/06/wp_editor_md_e4793cc9908bea58f59832f83851cfd2.jpg"><img alt="" src="assets/doc/02-risc-v/linux-risc-v-head-sè°ƒè¯•è®°å½•/images/wp_editor_md_e4793cc9908bea58f59832f83851cfd2.jpg"/></a></p>
<h2 id="mmu">ä½¿èƒ½MMU</h2>
<div class="codehilite"><pre><span></span><code><span class="nl">relocate_enable_mmu</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/* Relocate return address */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_map</span><span class="w">  </span><span class="c1">//å°†ç¬¦å·kernel_mapçš„åœ°å€åŠ è½½åˆ°å¯„å­˜å™¨a1</span>
<span class="w">    </span><span class="n">XIP_FIXUP_OFFSET</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="c1">//ä¿®æ­£a1çš„åç§»ï¼Œè¿™é€šå¸¸æ˜¯ç”¨äºå¤„ç†æ‰§è¡Œåœ¨ä½ç½®æ— å…³ä»£ç ï¼ˆXIPï¼‰çš„æƒ…å†µã€‚</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">KERNEL_MAP_VIRT_ADDR</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="c1">//ä»è™šæ‹Ÿåœ°å€ä¸­åŠ è½½å€¼åˆ°å¯„å­˜å™¨a1ï¼Œè¿™æ ·æˆ‘ä»¬å°±æœ‰äº†kernel_mapçš„è™šæ‹Ÿåœ°å€ã€‚</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">_start</span><span class="w"> </span><span class="c1">//å°†ç¬¦å·_startçš„åœ°å€åŠ è½½åˆ°å¯„å­˜å™¨a2ã€‚</span>
<span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="c1">//è®¡ç®—kernel_map - _startçš„åç§»é‡ï¼Œå¹¶å­˜å‚¨åœ¨a1ä¸­ã€‚</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">ra</span><span class="p">,</span><span class="w"> </span><span class="n">ra</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="c1">//å°†è¿”å›åœ°å€raåŠ ä¸Šå‰é¢è®¡ç®—çš„åç§»é‡ï¼Œé‡æ–°å®šä½è¿”å›åœ°å€ã€‚</span>
<span class="w">                    </span><span class="c1">//å°†è¿”å›åœ°å€ä»ç‰©ç†åœ°å€è½¬åŒ–ä¸ºè™šæ‹Ÿåœ°å€</span>

<span class="w">    </span><span class="cm">/* Point stvec to virtual address of intruction after satp write */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="mf">1f</span><span class="w"> </span><span class="c1">//å°†æ ‡ç­¾1fï¼ˆå³ç¨åå®šä¹‰çš„æ ‡ç­¾1ï¼‰çš„åœ°å€åŠ è½½åˆ°a2ä¸­ã€‚</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="c1">//å°†æ ‡ç­¾çš„åœ°å€åŠ ä¸Šåç§»é‡ï¼Œå¾—åˆ°å®ƒçš„è™šæ‹Ÿåœ°å€ã€‚</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">CSR_TVEC</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="c1">//å°†a2çš„å€¼å†™å…¥CSR_TVECå¯„å­˜å™¨ï¼Œè®¾ç½®å¼‚å¸¸å‘é‡è¡¨åŸºåœ°å€ã€‚</span>
<span class="w">                        </span><span class="c1">//å¼‚å¸¸åå°†è·³è½¬åˆ°1fçš„ä½ç½®ï¼Œ1fæ˜¯è™šæ‹Ÿåœ°å€ã€‚</span>

<span class="w">    </span><span class="cm">/* Compute satp for kernel page tables, but don\'t load it yet */</span>
<span class="w">    </span><span class="n">srl</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="w"> </span><span class="c1">//å°†a0å³ç§»PAGE_SHIFTä½ï¼Œè®¡ç®—é¡µå·ï¼ˆPage Numberï¼‰</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">satp_mode</span><span class="w"> </span><span class="c1">//å°†satp_modeçš„åœ°å€åŠ è½½åˆ°å¯„å­˜å™¨a1ã€‚</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="c1">//ä»satp_modeåœ°å€å¤„åŠ è½½ä¸€ä¸ªå€¼åˆ°å¯„å­˜å™¨a1,å³æˆ–stap_modeçš„å€¼</span>
<span class="w">    </span><span class="n">or</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="c1">//å°†é¡µå·å’Œæ¨¡å¼ç»„åˆèµ·æ¥ï¼Œç”Ÿæˆæœ€ç»ˆçš„ satp å€¼ï¼Œä½†è¿˜ä¸åŠ è½½å®ƒã€‚</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Load trampoline page directory, which will cause us to trap to</span>
<span class="cm">     * stvec if VA != PA, or simply fall through if VA == PA.  We need a</span>
<span class="cm">     * full fence here because setup_vm() just wrote these PTEs and we need</span>
<span class="cm">     * to ensure the new translations are in use.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">trampoline_pg_dir</span><span class="w"> </span><span class="c1">//å°†trampoline_pg_dirçš„åœ°å€åŠ è½½åˆ°å¯„å­˜å™¨a0ã€‚</span>
<span class="w">    </span><span class="n">XIP_FIXUP_OFFSET</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="c1">//ä¿®æ­£a0çš„åç§»</span>
<span class="w">    </span><span class="n">srl</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="w"> </span><span class="c1">//å°†a0å³ç§»PAGE_SHIFTä½ï¼Œè®¡ç®—é¡µå·ã€‚</span>
<span class="w">    </span><span class="n">or</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="c1">//å°†é¡µå·å’Œæ¨¡å¼ç»„åˆèµ·æ¥ï¼Œç”Ÿæˆæœ€ç»ˆçš„ satp å€¼ã€‚</span>
<span class="w">    </span><span class="n">sfence</span><span class="p">.</span><span class="n">vma</span><span class="w"> </span><span class="c1">//æ‰§è¡Œè™šåœ°å€ç¿»è¯‘çš„åŒæ­¥æŒ‡ä»¤ï¼Œç¡®ä¿æ‰€æœ‰ä¹‹å‰çš„å˜æ›´ç”Ÿæ•ˆã€‚</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="c1">//å°†a0çš„å€¼å†™å…¥CSR_SATPå¯„å­˜å™¨ï¼ŒåŠ è½½ trampoline é¡µç›®å½•ã€‚</span>
<span class="w">                    </span><span class="c1">//è¿™é‡Œä½¿èƒ½äº†MMUï¼Œé‚£ä¹ˆä¸‹ä¸€æ¡æŒ‡ä»¤ åœ°å€PC+8éœ€è¦ç»è¿‡MMUè½¬åŒ–ååœ°å€è¿›è¡Œ</span>
<span class="w">                    </span><span class="c1">//è®¿é—®ï¼Œè€Œæ­¤æ—¶PC+8çš„åœ°å€æ˜¯æ²¡æœ‰æ˜ å°„é¡µè¡¨çš„ï¼Œé‚£ä¹ˆåœ°å€å°±ä¼šå˜æˆéæ³•è€Œ</span>
<span class="w">                    </span><span class="c1">//è¿›å…¥å¼‚å¸¸</span>
<span class="p">.</span><span class="n">align</span><span class="w"> </span><span class="mi">2</span>
<span class="mi">1</span><span class="o">:</span><span class="w">          </span><span class="c1">//ä»¥è¯¥ç‰©ç†åœ°å€æ¥å–æŒ‡\"æ ‡å·1çš„æŒ‡ä»¤\",å¼‚å¸¸  -----è¿™é‡Œéå¸¸å·§å¦™</span>
<span class="w">            </span><span class="c1">//PCè·³è½¬åˆ°\"CSR_TVECçš„å€¼\",ä»¥æ ‡å·1çš„è™šæ‹Ÿåœ°å€æ¥å–æŒ‡\"æ ‡å·1çš„æŒ‡ä»¤\",æ­£å¸¸,å¾€ä¸‹æ‰§è¡Œ</span>
<span class="w">    </span><span class="cm">/* Set trap vector to spin forever to help debug */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">Lsecondary_park</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">CSR_TVEC</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="c1">//å°† trap å‘é‡è®¾ç½®ä¸º.Lsecondary_parkã€‚</span>

<span class="w">    </span><span class="cm">/* Reload the global pointer */</span>
<span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">push</span>
<span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">norelax</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">gp</span><span class="p">,</span><span class="w"> </span><span class="n">__global_pointer$</span>
<span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">pop</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Switch to kernel page tables.  A full fence is necessary in order to</span>
<span class="cm">     * avoid using the trampoline translations, which are only correct for</span>
<span class="cm">     * the first superpage.  Fetching the fence is guaranteed to work</span>
<span class="cm">     * because that first superpage is translated the same way.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>
<span class="w">    </span><span class="n">sfence</span><span class="p">.</span><span class="n">vma</span>

<span class="w">    </span><span class="n">ret</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">asmlinkage</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="n">setup_vm</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">dtb_pa</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">pmd_t</span><span class="w"> </span><span class="n">__maybe_unused</span><span class="w"> </span><span class="n">fix_bmap_spmd</span><span class="p">,</span><span class="w"> </span><span class="n">fix_bmap_epmd</span><span class="p">;</span>

<span class="w">    </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">virt_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNEL_LINK_ADDR</span><span class="p">;</span>
<span class="w">    </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">page_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_AC</span><span class="p">(</span><span class="n">CONFIG_PAGE_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">UL</span><span class="p">);</span>
<span class="w">    </span><span class="n">_printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s,%d,virt_addr:%lx, offset:%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__func__,__LINE__,</span>
<span class="w">            </span><span class="n">KERNEL_LINK_ADDR</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">page_offset</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_XIP_KERNEL</span>
<span class="w">    </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">xiprom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">CONFIG_XIP_PHYS_ADDR</span><span class="p">;</span>
<span class="w">    </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">xiprom_sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">_exiprom</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">_xiprom</span><span class="p">);</span>

<span class="w">    </span><span class="n">phys_ram_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CONFIG_PHYS_RAM_BASE</span><span class="p">;</span>
<span class="w">    </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">phys_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">CONFIG_PHYS_RAM_BASE</span><span class="p">;</span>
<span class="w">    </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">_end</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">_sdata</span><span class="p">);</span>

<span class="w">    </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">va_kernel_xip_pa_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">virt_addr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">xiprom</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">phys_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">_start</span><span class="p">);</span>
<span class="w">    </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">_end</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">phys_addr</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">_printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s,%d,_start:%lx, _end:%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__func__,__LINE__,&amp;_start, &amp;_end);</span>

<span class="w">    </span><span class="n">_printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s,%d,phys_addr:%lx, size:%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__func__,__LINE__,</span>
<span class="w">            </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">phys_addr</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_64BIT) &amp;&amp; !defined(CONFIG_XIP_KERNEL)</span>
<span class="w">    </span><span class="n">set_satp_mode</span><span class="p">();</span>
<span class="w">    </span><span class="c1">//è®¾ç½®satpå¯„å­˜å™¨ï¼Œç¡®å®šå‡ çº§é¡µè¡¨</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">_printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s,%d,_start:%lx, _end:%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__func__,__LINE__,&amp;_start, &amp;_end);</span>

<span class="w">    </span><span class="n">_printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s,%d,phys_addr:%lx, size:%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__func__,__LINE__,</span>
<span class="w">            </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">phys_addr</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_64BIT) &amp;&amp; !defined(CONFIG_XIP_KERNEL)</span>
<span class="w">    </span><span class="n">set_satp_mode</span><span class="p">();</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">_printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s,%d,page offset%lx, kernel_map.page_offset:%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,</span>
<span class="w">            </span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">PAGE_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">page_offset</span><span class="p">);</span>

<span class="w">    </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">va_pa_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PAGE_OFFSET</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">phys_addr</span><span class="p">;</span>
<span class="w">    </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">va_kernel_pa_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">virt_addr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">phys_addr</span><span class="p">;</span>

<span class="w">    </span><span class="n">riscv_pfn_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">kernel_map</span><span class="p">.</span><span class="n">phys_addr</span><span class="p">);</span>

<span class="w">    </span><span class="n">_printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s,%d,va_pa_offset:%lx, va_kernel_pa_offset:%lx, pfn_base:%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__func__,__LINE__,</span>
<span class="w">            </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">va_pa_offset</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">va_kernel_pa_offset</span><span class="p">,</span><span class="w"> </span><span class="n">riscv_pfn_base</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * The default maximal physical memory size is KERN_VIRT_SIZE for 32-bit</span>
<span class="cm">     * kernel, whereas for 64-bit kernel, the end of the virtual address</span>
<span class="cm">     * space is occupied by the modules/BPF/kernel mappings which reduces</span>
<span class="cm">     * the available size of the linear mapping.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">memory_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERN_VIRT_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_64BIT</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">SZ_4G</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="n">_printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s,%d,memory_limit:%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__func__,__LINE__, memory_limit);</span>

<span class="w">    </span><span class="cm">/* Sanity check alignment and size */</span>
<span class="w">    </span><span class="n">BUG_ON</span><span class="p">((</span><span class="n">PAGE_OFFSET</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">PGDIR_SIZE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">BUG_ON</span><span class="p">((</span><span class="n">kernel_map</span><span class="p">.</span><span class="n">phys_addr</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">PMD_SIZE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_64BIT</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * The last 4K bytes of the addressable memory can not be mapped because</span>
<span class="cm">     * of IS_ERR_VALUE macro.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">BUG_ON</span><span class="p">((</span><span class="n">kernel_map</span><span class="p">.</span><span class="n">virt_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ADDRESS_SPACE_END</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">SZ_4K</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">pt_ops_set_early</span><span class="p">();</span>
<span class="w">    </span><span class="cm">/* Setup early PGD for fixmap */</span>
<span class="w">    </span><span class="n">_printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s,%d FIXADDR_START:%lx,fixmap_pgd_next :%lx, PGDIR_SIZE:%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__func__,__LINE__,</span>
<span class="w">            </span><span class="n">FIXADDR_START</span><span class="p">,</span><span class="w"> </span><span class="n">fixmap_pgd_next</span><span class="p">,</span><span class="w"> </span><span class="n">PGDIR_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//å› ä¸ºä¸€æ—¦ä½¿èƒ½MMUï¼Œå°±æ˜¯å–æŒ‡ä»¤çš„åœ°å€ä¸æ˜¯å®é™…çš„è¿è¡Œåœ°å€ï¼Œè€Œæ˜¯éœ€è¦ç»è¿‡MMUè½¬åŒ–æ‰èƒ½è®¿é—®</span>
<span class="w">    </span><span class="c1">//å¦‚æœè¦è®¿é—®DTBã€è®¿é—®IOå°±ä¸èƒ½è®¿é—®ï¼Œå› ä¸ºæŸ¥è¯¢ä¸åˆ°å¯¹åº”çš„é¡µè¡¨ï¼Œå› ä¸ºå†…å­˜ç®¡ç†ç³»ç»Ÿè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œ</span>
<span class="w">    </span><span class="c1">//ä¹Ÿä¸èƒ½åŠ¨æ€åˆ†é…å†…å­˜æ¥ä½œä¸ºé¡µè¡¨å¡«å……ï¼Œé‚£ä¹ˆå°±å› æ­¤å†…æ ¸å¼•å…¥fixmapï¼Œäº‹å…ˆ</span>
<span class="w">    </span><span class="c1">//åˆ†é…ä¸€æ®µè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç„¶åç»™å…¶è™šæ‹Ÿåœ°å€åˆ›å»ºå·PGD/PUD/PMDçš„é¡µè¡¨ï¼ŒPTEçš„é¡µè¡¨ç­‰é‚£ä¸ªæ¨¡å—</span>
<span class="w">    </span><span class="c1">//ï¼ˆå¦‚DTBï¼‰ä½¿ç”¨äº†å†è¿›è¡Œå¡«å……ï¼Œè¿™æ ·é€šè¿‡fixmapè¿™æ®µè™šæ‹Ÿåœ°å€å°±å¯ä»¥æŸ¥è¯¢é¡µè¡¨è®¿é—®åˆ°ç‰©ç†å†…å­˜ã€‚</span>
<span class="w">    </span><span class="c1">//å½“å‰fixmapä¸»è¦æ˜¯ç”¨äºè®¿é—®è®¾å¤‡æ ‘dtbçš„ã€‚</span>

<span class="w">    </span><span class="c1">//FIXADDR_START~FIXADDR_TOPè¿™æ®µè™šæ‹Ÿåœ°å€èŒƒå›´æ˜¯å›ºå®šçš„ï¼Œç”¨äºæ˜ å°„åˆ°FDT/EARLYCON/IO</span>
<span class="w">    </span><span class="c1">//å¡«å……fixmapçš„PGDé¡µè¡¨ï¼Œfixmapè™šæ‹Ÿåœ°å€å¯¹åº”çš„é¡µè¡¨é¡¹ä¸­å­˜å‚¨çš„æ˜¯fixmap_pgd_nextï¼Œä¸‹ä¸€çº§</span>
<span class="w">    </span><span class="c1">//é¡µè¡¨çš„åœ°å€ï¼Œå¦‚æœæ˜¯5çº§é¡µè¡¨å°±æ˜¯fixmap_p4d[PTRS_PER_P4D]ï¼Œå¦‚æœæ˜¯4çº§é¡µè¡¨å°±æ˜¯</span>
<span class="w">    </span><span class="c1">//fixmap_pud[PTRS_PER_PUD]ï¼Œæœ¬ç« å®éªŒæ˜¯4çº§é¡µè¡¨ã€‚</span>
<span class="w">    </span><span class="n">create_pgd_mapping</span><span class="p">(</span><span class="n">early_pg_dir</span><span class="p">,</span><span class="w"> </span><span class="n">FIXADDR_START</span><span class="p">,</span>
<span class="w">               </span><span class="n">fixmap_pgd_next</span><span class="p">,</span><span class="w"> </span><span class="n">PGDIR_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_TABLE</span><span class="p">);</span>

<span class="cp">#ifndef __PAGETABLE_PMD_FOLDED</span>
<span class="w">    </span><span class="n">_printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s,%d,pgtable_l5_enabled: %lx,pgtable_l5_enabled:%lx </span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,</span>
<span class="w">            </span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">pgtable_l5_enabled</span><span class="p">,</span><span class="n">pgtable_l4_enabled</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Setup fixmap P4D and PUD */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pgtable_l5_enabled</span><span class="p">)</span>
<span class="w">        </span><span class="n">create_p4d_mapping</span><span class="p">(</span><span class="n">fixmap_p4d</span><span class="p">,</span><span class="w"> </span><span class="n">FIXADDR_START</span><span class="p">,</span>
<span class="w">                   </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">fixmap_pud</span><span class="p">,</span><span class="w"> </span><span class="n">P4D_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_TABLE</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/* Setup fixmap PUD and PMD */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pgtable_l4_enabled</span><span class="p">)</span>
<span class="w">        </span><span class="n">create_pud_mapping</span><span class="p">(</span><span class="n">fixmap_pud</span><span class="p">,</span><span class="w"> </span><span class="n">FIXADDR_START</span><span class="p">,</span>
<span class="w">                   </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">fixmap_pmd</span><span class="p">,</span><span class="w"> </span><span class="n">PUD_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_TABLE</span><span class="p">);</span>
<span class="w">    </span><span class="n">create_pmd_mapping</span><span class="p">(</span><span class="n">fixmap_pmd</span><span class="p">,</span><span class="w"> </span><span class="n">FIXADDR_START</span><span class="p">,</span>
<span class="w">               </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">fixmap_pte</span><span class="p">,</span><span class="w"> </span><span class="n">PMD_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_TABLE</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/* Setup trampoline PGD and PMD */</span>
<span class="w">    </span><span class="n">create_pgd_mapping</span><span class="p">(</span><span class="n">trampoline_pg_dir</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">virt_addr</span><span class="p">,</span>
<span class="w">               </span><span class="n">trampoline_pgd_next</span><span class="p">,</span><span class="w"> </span><span class="n">PGDIR_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_TABLE</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pgtable_l5_enabled</span><span class="p">)</span>
<span class="w">        </span><span class="n">create_p4d_mapping</span><span class="p">(</span><span class="n">trampoline_p4d</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">virt_addr</span><span class="p">,</span>
<span class="w">                   </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">trampoline_pud</span><span class="p">,</span><span class="w"> </span><span class="n">P4D_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_TABLE</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pgtable_l4_enabled</span><span class="p">)</span>
<span class="w">        </span><span class="n">create_pud_mapping</span><span class="p">(</span><span class="n">trampoline_pud</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">virt_addr</span><span class="p">,</span>
<span class="w">                   </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">trampoline_pmd</span><span class="p">,</span><span class="w"> </span><span class="n">PUD_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_TABLE</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_XIP_KERNEL</span>
<span class="w">    </span><span class="n">create_pmd_mapping</span><span class="p">(</span><span class="n">trampoline_pmd</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">virt_addr</span><span class="p">,</span>
<span class="w">               </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">xiprom</span><span class="p">,</span><span class="w"> </span><span class="n">PMD_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_KERNEL_EXEC</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">create_pmd_mapping</span><span class="p">(</span><span class="n">trampoline_pmd</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">virt_addr</span><span class="p">,</span>
<span class="w">               </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">phys_addr</span><span class="p">,</span><span class="w"> </span><span class="n">PMD_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_KERNEL_EXEC</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="cm">/* Setup trampoline PGD */</span>
<span class="w">    </span><span class="n">create_pgd_mapping</span><span class="p">(</span><span class="n">trampoline_pg_dir</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">virt_addr</span><span class="p">,</span>
<span class="w">               </span><span class="n">kernel_map</span><span class="p">.</span><span class="n">phys_addr</span><span class="p">,</span><span class="w"> </span><span class="n">PGDIR_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_KERNEL_EXEC</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Setup early PGD covering entire kernel which will allow</span>
<span class="cm">     * us to reach paging_init(). We map all memory banks later</span>
<span class="cm">     * in setup_vm_final() below.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">create_kernel_page_table</span><span class="p">(</span><span class="n">early_pg_dir</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Setup early mapping for FDT early scan */</span>
<span class="w">    </span><span class="n">create_fdt_early_page_table</span><span class="p">(</span><span class="n">early_pg_dir</span><span class="p">,</span><span class="w"> </span><span class="n">dtb_pa</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Bootime fixmap only can handle PMD_SIZE mapping. Thus, boot-ioremap</span>
<span class="cm">     * range can not span multiple pmds.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">BUG_ON</span><span class="p">((</span><span class="n">__fix_to_virt</span><span class="p">(</span><span class="n">FIX_BTMAP_BEGIN</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PMD_SHIFT</span><span class="p">)</span>
<span class="w">             </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">__fix_to_virt</span><span class="p">(</span><span class="n">FIX_BTMAP_END</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PMD_SHIFT</span><span class="p">));</span>
<span class="cp">#ifndef __PAGETABLE_PMD_FOLDED</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Early ioremap fixmap is already created as it lies within first 2MB</span>
<span class="cm">     * of fixmap region. We always map PMD_SIZE. Thus, both FIX_BTMAP_END</span>
<span class="cm">     * FIX_BTMAP_BEGIN should lie in the same pmd. Verify that and warn</span>
<span class="cm">     * the user if not.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">fix_bmap_spmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixmap_pmd</span><span class="p">[</span><span class="n">pmd_index</span><span class="p">(</span><span class="n">__fix_to_virt</span><span class="p">(</span><span class="n">FIX_BTMAP_BEGIN</span><span class="p">))];</span>
<span class="w">    </span><span class="n">fix_bmap_epmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixmap_pmd</span><span class="p">[</span><span class="n">pmd_index</span><span class="p">(</span><span class="n">__fix_to_virt</span><span class="p">(</span><span class="n">FIX_BTMAP_END</span><span class="p">))];</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pmd_val</span><span class="p">(</span><span class="n">fix_bmap_spmd</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pmd_val</span><span class="p">(</span><span class="n">fix_bmap_epmd</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">pr_warn</span><span class="p">(</span><span class="err">\</span><span class="s">"fixmap btmap start [%08lx] != end [%08lx]</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,</span>
<span class="w">            </span><span class="n">pmd_val</span><span class="p">(</span><span class="n">fix_bmap_spmd</span><span class="p">),</span><span class="w"> </span><span class="n">pmd_val</span><span class="p">(</span><span class="n">fix_bmap_epmd</span><span class="p">));</span>
<span class="w">        </span><span class="n">pr_warn</span><span class="p">(</span><span class="err">\</span><span class="s">"fix_to_virt(FIX_BTMAP_BEGIN): %08lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,</span>
<span class="w">            </span><span class="n">fix_to_virt</span><span class="p">(</span><span class="n">FIX_BTMAP_BEGIN</span><span class="p">));</span>
<span class="w">        </span><span class="n">pr_warn</span><span class="p">(</span><span class="err">\</span><span class="s">"fix_to_virt(FIX_BTMAP_END):   %08lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,</span>
<span class="w">            </span><span class="n">fix_to_virt</span><span class="p">(</span><span class="n">FIX_BTMAP_END</span><span class="p">));</span>

<span class="w">        </span><span class="n">pr_warn</span><span class="p">(</span><span class="err">\</span><span class="s">"FIX_BTMAP_END:       %d</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">, FIX_BTMAP_END);</span>
<span class="w">        </span><span class="n">pr_warn</span><span class="p">(</span><span class="err">\</span><span class="s">"FIX_BTMAP_BEGIN:     %d</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">, FIX_BTMAP_BEGIN);</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">_printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s,%d start pt_ops_set_fixmap</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__func__,__LINE__);</span>

<span class="w">    </span><span class="n">pt_ops_set_fixmap</span><span class="p">();</span>

<span class="w">    </span><span class="n">_printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s,%d end pt_ops_set_fixmap</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__func__,__LINE__);</span>
<span class="p">}</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="linuxç³»ç»Ÿrisc-væ¶æ„å¯åŠ¨æµç¨‹åˆ†æä¹‹æ¦‚è¿°.html">â† Linuxç³»ç»ŸRISC-Væ¶æ„å¯åŠ¨æµç¨‹åˆ†æä¹‹æ¦‚è¿°</a>
    <a class="next" href="freertoså†…å­˜ç®¡ç†.html">freertoså†…å­˜ç®¡ç† â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

