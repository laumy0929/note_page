<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>è™šæ‹Ÿåœ°å€ç©ºé—´ä¸ç‰©ç†åœ°å€ç©ºé—´å®Œæ•´æ˜ å°„ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#setup-bootmem">setup bootmem</a><ul></ul></li><li><a href="#_1">å®Œæ•´æ˜ å°„</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>è™šæ‹Ÿåœ°å€ç©ºé—´ä¸ç‰©ç†åœ°å€ç©ºé—´å®Œæ•´æ˜ å°„</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-07-07
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      risc-v
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="setup-bootmem">setup bootmem</h2>
<p>ç‰©ç†å†…å­˜éƒ½æ·»åŠ åˆ°ç³»ç»Ÿä¹‹åï¼Œä¼šè°ƒç”¨setup_bootmemå¯¹æ•´ä¸ªç‰©ç†å†…å­˜è¿›è¡Œæ•´ç†ï¼Œä¸»è¦çš„å·¥ä½œå°±æ˜¯removeæ‰ä¸€äº›no-mapåŒºåŸŸï¼ˆä¸å½’å†…æ ¸ç®¡ç†ï¼‰ï¼ŒåŒæ—¶ä¿ç•™ä¸€äº›å…³é”®åŒºåŸŸï¼Œå¦‚å†…æ ¸é•œåƒåŒºï¼Œdtbä¸­reservedçš„å†…å­˜èŠ‚ç‚¹ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/07/wp_editor_md_2e42fa1b407a7f2adcede12a1f21e93c.jpg"><img alt="" src="assets/doc/02-risc-v/å…­ã€è™šæ‹Ÿåœ°å€ç©ºé—´ä¸ç‰©ç†åœ°å€ç©ºé—´å®Œæ•´æ˜ å°„/images/wp_editor_md_2e42fa1b407a7f2adcede12a1f21e93c.jpg"/></a></p>
<p>ä¸Šå›¾ä¸­ï¼Œæµ…ç»¿è‰²çš„å°±æ˜¯reservedéƒ¨åˆ†ï¼Œä¸èƒ½è¢«åˆ†é…ä½¿ç”¨ï¼Œè€Œå‰©ä¸‹çš„éƒ¨åˆ†å°±å¯ä»¥é€šè¿‡è°ƒç”¨ä¸Šå°ç« èŠ‚ä¸­çš„å‡½æ•°å»ä½¿ç”¨å†…å­˜äº†ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">setup_bootmem</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">memblock_region</span><span class="w"> </span><span class="o">*</span><span class="n">reg</span><span class="p">;</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">mem_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">vmlinux_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_end</span><span class="p">);</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">vmlinux_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_start</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Find the memory region containing the kernel */</span>
<span class="w">    </span><span class="n">for_each_memblock</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span><span class="w"> </span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">base</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">vmlinux_end</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">vmlinux_end</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mem_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">phys_addr_t</span><span class="p">)</span><span class="o">-</span><span class="n">PAGE_OFFSET</span><span class="p">);</span>

<span class="w">            </span><span class="cm">/*</span>
<span class="cm">             * Remove memblock from the end of usable area to the</span>
<span class="cm">             * end of region</span>
<span class="cm">             */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mem_size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">)</span>
<span class="w">                </span><span class="n">memblock_remove</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mem_size</span><span class="p">,</span>
<span class="w">                        </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">base</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mem_size</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">BUG_ON</span><span class="p">(</span><span class="n">mem_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Reserve from the start of the kernel to the end of the kernel */</span>
<span class="w">    </span><span class="n">memblock_reserve</span><span class="p">(</span><span class="n">vmlinux_start</span><span class="p">,</span><span class="w"> </span><span class="n">vmlinux_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">vmlinux_start</span><span class="p">);</span>
<span class="w">    </span><span class="n">â‘ å°†å†…æ ¸é•œåƒåœ°å€ç©ºé—´æ·»åŠ åˆ°</span><span class="o">&amp;</span><span class="n">memblock</span><span class="p">.</span><span class="n">reserved</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">set_max_mapnr</span><span class="p">(</span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">mem_size</span><span class="p">));</span>
<span class="w">    </span><span class="n">max_low_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">memblock_end_of_DRAM</span><span class="p">());</span>

<span class="cp">#ifdef CONFIG_BLK_DEV_INITRD</span>
<span class="w">    </span><span class="n">setup_initrd</span><span class="p">();</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_BLK_DEV_INITRD */</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Avoid using early_init_fdt_reserve_self() since __pa() does</span>
<span class="cm">     * not work for DTB pointers that are fixmap addresses</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">memblock_reserve</span><span class="p">(</span><span class="n">dtb_early_pa</span><span class="p">,</span><span class="w"> </span><span class="n">fdt_totalsize</span><span class="p">(</span><span class="n">dtb_early_va</span><span class="p">));</span>
<span class="w">    </span><span class="n">â‘¡å°†dtbçš„ç©ºé—´æ·»åŠ åˆ°</span><span class="o">&amp;</span><span class="n">memblock</span><span class="p">.</span><span class="n">reserved</span>
<span class="n">early_init_fdt_scan_reserved_mem</span><span class="p">();</span>
<span class="n">â‘¢éå†è®¾å¤‡æ ‘çš„èŠ‚ç‚¹</span><span class="err">ï¼Œ</span><span class="n">å°†</span><span class="o">/</span><span class="n">memreserve</span><span class="o">/</span><span class="err">ï¼Œ</span><span class="n">reserved</span><span class="o">-</span><span class="n">memoryèŠ‚ç‚¹æ·»åŠ åˆ°</span><span class="o">&amp;</span><span class="n">memblock</span><span class="p">.</span><span class="n">reserved</span>
<span class="w">    </span><span class="n">memblock_allow_resize</span><span class="p">();</span>
<span class="w">    </span><span class="n">memblock_dump_all</span><span class="p">();</span>

<span class="w">    </span><span class="n">for_each_memblock</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span><span class="w"> </span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblock_region_memory_base_pfn</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">end_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblock_region_memory_end_pfn</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

<span class="w">        </span><span class="n">memblock_set_node</span><span class="p">(</span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">start_pfn</span><span class="p">),</span>
<span class="w">                  </span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">end_pfn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_pfn</span><span class="p">),</span>
<span class="w">                  </span><span class="o">&amp;</span><span class="n">memblock</span><span class="p">.</span><span class="n">memory</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span><span class="w">  </span>

<span class="n">ä¸‹é¢æ˜¯è°ƒç”¨memblock_dump_allçš„ä¿¡æ¯</span><span class="err">ï¼š</span>
<span class="n">MEMBLOCK</span><span class="w"> </span><span class="n">configuration</span><span class="o">:</span>
<span class="n">memory</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x000000000fe00000</span><span class="w"> </span><span class="n">reserved</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x000000000091288b</span>
<span class="n">memory</span><span class="p">.</span><span class="n">cnt</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1</span>
<span class="n">memory</span><span class="p">[</span><span class="mh">0x0</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mh">0x0000000080200000-0x000000008fffffff</span><span class="p">],</span><span class="w"> </span><span class="mh">0x000000000fe00000</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">flags</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0</span>
<span class="n">reserved</span><span class="p">.</span><span class="n">cnt</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">0x3</span>
<span class="n">reserved</span><span class="p">[</span><span class="mh">0x0</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mh">0x0000000080000000-0x000000008003ffff</span><span class="p">],</span><span class="w"> </span><span class="mh">0x0000000000040000</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">flags</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0</span>
<span class="n">reserved</span><span class="p">[</span><span class="mh">0x1</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mh">0x0000000080200000-0x0000000080ad133b</span><span class="p">],</span><span class="w"> </span><span class="mh">0x00000000008d133c</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">flags</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0</span>
<span class="n">reserved</span><span class="p">[</span><span class="mh">0x2</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mh">0x0000000082200000-0x000000008220154e</span><span class="p">],</span><span class="w"> </span><span class="mh">0x000000000000154f</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">flags</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0</span>
</code></pre></div>
<p>å°ç»“ï¼š ï¼ˆ1ï¼‰ç³»ç»Ÿé€šè¿‡memblockä»¥æ•°ç»„memory typeçš„æ–¹å¼è®°å½•ç‰©ç†å†…å­˜ç©ºé—´ï¼Œæ•°ç»„ä¸­æ¯ä¸€ä¸ªå†…å­˜åŒºåŸŸæè¿°äº†ä¸€æ®µå†…å­˜ä¿¡æ¯ï¼ŒåŒ…æ‹¬baseï¼Œsizeï¼Œnode idç­‰ã€‚ ï¼ˆ2ï¼‰åœ¨memblockä¿¡æ¯ä¸­ï¼Œå·²ç»è¢«ä½¿ç”¨æˆ–è€…è¢«å†…æ ¸å®šä¹‰éœ€è¦ä¿ç•™çš„åŒºåŸŸï¼Œä¼šå­˜å‚¨åœ¨reserved æ•°ç»„ä¸­ã€‚ ï¼ˆ3ï¼‰memory typeæ•°ç»„ä¸­å¹¶ä¸æ˜¯ä»£è¡¨æ•´ä¸ªå†…æ ¸ç³»ç»Ÿçš„å†…å­˜ç©ºé—´ï¼Œå› ä¸ºéƒ¨åˆ†é©±åŠ¨ä¼šä¿ç•™ä¸€æ®µå†…å­˜åŒºåŸŸä¾›è‡ªå·±å•ç‹¬ä½¿ç”¨ï¼Œå…¶åœ¨dtsä¸­å…·æœ‰no-mapå±æ€§çš„reserved-memoryèŠ‚ç‚¹ï¼Œä¸ä¼šç”±å†…æ ¸åˆ›å»ºåœ°å€æ˜ å°„ã€‚ ï¼ˆ4ï¼‰å¯ä»¥é€šè¿‡å†…æ ¸è°ƒè¯•èŠ‚ç‚¹/sys/kernel/debug/memblockè¿›è¡ŒæŸ¥è¯¢ç›¸å…³ä¿¡æ¯</p>
<h2 id="_1">å®Œæ•´æ˜ å°„</h2>
<p>åœ¨å‰é¢éƒ¨åˆ†åªå®Œæˆäº†kernelã€dtbï¼Œéƒ¨åˆ†ä¸´æ—¶é¡µè¡¨çš„ä¸´æ—¶æ˜ å°„ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹äºå†…æ ¸æ¥è¯´ä½¿èƒ½äº†MMUåä¹Ÿåªèƒ½è®¿é—®kernelï¼Œdtbï¼Œéƒ¨åˆ†ä¸´æ—¶é¡µè¡¨ã€‚åœ¨å‰é¢é˜¶æ®µï¼Œå†…æ ¸ä¹ŸåªçŸ¥é“kernelï¼Œdtbçš„ç‰©ç†ä½ç½®ï¼Œå¯¹äºå…¶ä»–çš„å†…å­˜ä½ç½®å†…æ ¸æ˜¯ä¸æ¸…æ¥šçš„ã€‚é€šè¿‡memblockæœºåˆ¶åï¼Œå†…æ ¸ç³»ç»Ÿå·²ç»å¯¹ç‰©ç†å†…å­˜å¸ƒå±€ä¿¡æ¯æ¯”è¾ƒæ¸…æ¥šäº†ï¼Œé‚£ä¹ˆå°±éœ€è¦å¯¹å†…å­˜å®Œæˆæœ€åçš„æ˜ å°„ã€‚ä¸»è¦çš„å·¥ä½œæ˜¯ï¼Œå¯¹æ­¤å‰çš„kernelã€dtbç­‰æ˜ å°„é‡æ–°åšä¸€æ¬¡è°ƒæ•´ï¼Œç»Ÿä¸€ä½¿ç”¨swapper_pg_diræ ¹ç›®å½•é¡µè¡¨ï¼ŒåŒæ—¶å¯¹äºæ–°çº³å…¥memblockä¸­çš„å†…å­˜å»ºç«‹æ˜ å°„ï¼Œå¡«å……å¥½å¯¹åº”çš„é¡µè¡¨ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">setup_vm_final</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">map_size</span><span class="p">;</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">memblock_region</span><span class="w"> </span><span class="o">*</span><span class="n">reg</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Set mmu_enabled flag */</span>
<span class="w">    </span><span class="n">mmu_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Setup swapper PGD for fixmap */</span>
<span class="w">    </span><span class="n">create_pgd_mapping</span><span class="p">(</span><span class="n">swapper_pg_dir</span><span class="p">,</span><span class="w"> </span><span class="n">FIXADDR_START</span><span class="p">,</span>
<span class="w">               </span><span class="n">__pa</span><span class="p">(</span><span class="n">fixmap_pgd_next</span><span class="p">),</span>
<span class="w">               </span><span class="n">PGDIR_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_TABLE</span><span class="p">);</span>
<span class="w">    </span><span class="n">â‘ </span><span class="w"> </span><span class="n">å°†fixmapçš„æ˜ å°„çš„é¡µè¡¨ä»early_pg_diråˆ‡æ¢ä¸ºswapper_pg_dir</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="cm">/* Map all memory banks */</span>
<span class="w">    </span><span class="n">for_each_memblock</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span><span class="w"> </span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
<span class="w">        </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">end</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memblock_is_nomap</span><span class="p">(</span><span class="n">reg</span><span class="p">))</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">__pa</span><span class="p">(</span><span class="n">PAGE_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="n">__pa</span><span class="p">(</span><span class="n">PAGE_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">)</span>
<span class="w">            </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__pa</span><span class="p">(</span><span class="n">PAGE_OFFSET</span><span class="p">);</span>

<span class="w">        </span><span class="n">map_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">best_map_size</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">map_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
<span class="w">            </span><span class="n">create_pgd_mapping</span><span class="p">(</span><span class="n">swapper_pg_dir</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span>
<span class="w">                       </span><span class="n">map_size</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_KERNEL_EXEC</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="n">â‘¡éå†memblockä¸­çš„å†…å­˜</span><span class="err">ï¼Œ</span><span class="n">å¯¹æ‰€æœ‰çš„å†…å­˜è¿›è¡Œæ˜ å°„</span><span class="err">ï¼Œ</span><span class="n">æ ¹ç›®å½•é¡µè¡¨ä¸ºswapper_pg_dir</span><span class="err">ï¼Œ</span><span class="n">äºŒçº§é¡µè¡¨å’ŒPTEé¡µè¡¨ä¼šä½¿ç”¨memblock_phys_allocè¿›è¡Œåˆ†é…å†…å­˜</span><span class="err">ï¼Œ</span><span class="n">å¯¹å·²ç»åˆ†é…çš„å†…å­˜è®¿é—®ä¼šå…ˆåå‘æ˜ å°„åˆ°fixmapåœ°å€ç©ºé—´</span><span class="err">ï¼Œ</span><span class="n">é€šè¿‡fixmapè¿›è¡Œè®¿é—®é¡µè¡¨</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="cm">/* Clear fixmap PTE and PMD mappings */</span>
<span class="w">    </span><span class="n">clear_fixmap</span><span class="p">(</span><span class="n">FIX_PTE</span><span class="p">);</span>
<span class="w">    </span><span class="n">clear_fixmap</span><span class="p">(</span><span class="n">FIX_PMD</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Move to swapper page table */</span>
<span class="w">    </span><span class="n">csr_write</span><span class="p">(</span><span class="n">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">swapper_pg_dir</span><span class="p">))</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SATP_MODE</span><span class="p">);</span>
<span class="n">local_flush_tlb_all</span><span class="p">();</span>
<span class="n">â‘¢å°†swapper_pg_dirçš„æ ¹ç›®å½•å†™åˆ°satpå¯„å­˜å™¨</span><span class="err">ï¼Œ</span><span class="n">è¿™æ ·å°±å®Œæˆäº†æ•´ä¸ªç‰©ç†å†…å­˜åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ˜ å°„</span><span class="err">ï¼Œ</span><span class="n">æ‰€æœ‰çš„ç‰©ç†å†…å­˜ç©ºé—´éƒ½å¯ä»¥è¿›è¡Œè®¿é—®äº†</span><span class="err">ã€‚</span>
<span class="p">}</span>
</code></pre></div>
<p>åˆ°æ­¤ï¼Œå†…æ ¸é€šè¿‡memblockçŸ¥é“ç‰©ç†å†…å­˜çš„å¸ƒå±€ä¿¡æ¯ï¼Œè™šæ‹Ÿåœ°å€ç¿»è¯‘åˆ°ç‰©ç†å†…å­˜æ‰€éœ€è¦çš„é¡µè¡¨éƒ½å¡«å……å¥½äº†ï¼Œæ‰€æœ‰è¦è®¿é—®çš„ç‰©ç†å†…å­˜éƒ½æ˜ å°„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ‰€æœ‰çš„ç‰©ç†å†…å­˜éƒ½å¯ä»¥é€šè¿‡è™šæ‹Ÿåœ°å€æ­£å¸¸è®¿é—®äº†ã€‚å†…å­˜ä¸‹ä¸€é˜¶æ®µçš„åˆå§‹åŒ–ä¼šæ¶‰åŠåˆ°Nodeã€Zoneä»¥åŠä¼™ä¼´ç³»ç»Ÿç­‰ï¼Œè¿™é‡Œå°±å…ˆä¸é˜è¿°ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="archåˆå§‹åŒ–.html">â† archåˆå§‹åŒ–</a>
    <a class="next" href="å¯åŠ¨ç¬¬ä¸€ä¸ªåº”ç”¨è¿›ç¨‹.html">å¯åŠ¨ç¬¬ä¸€ä¸ªåº”ç”¨è¿›ç¨‹ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

