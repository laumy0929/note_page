<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>webrtcç½‘é¡µä»£ç åˆ†æäºŒ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">äº¤äº’æµç¨‹</a><ul></ul></li><li><a href="#url">è·å–URLå‚æ•°</a><ul></ul></li><li><a href="#_2">é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–æ“ä½œ</a><ul></ul></li><li><a href="#mqtt">MQTTæ“ä½œ</a><ul><li><a href="#_3">å‘èµ·è¿æ¥</a></li><li><a href="#_4">äº‹ä»¶å¤„ç†</a></li></ul></li><li><a href="#webrtc">WebRTCæ“ä½œ</a><ul><li><a href="#_5">åˆ›å»ºå¯¹è±¡</a></li><li><a href="#pc">è·å–PCå½•éŸ³</a></li><li><a href="#_6">è¿æ¥çŠ¶æ€</a></li><li><a href="#ice">ICEå€™é€‰è€…</a></li><li><a href="#_7">æ¥æ”¶éŸ³è§†é¢‘</a></li><li><a href="#_8">æ•°æ®é€šé“</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>webrtcç½‘é¡µä»£ç åˆ†æäºŒ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-12-14
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      å…¶ä»–
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">äº¤äº’æµç¨‹</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/12/wp_editor_md_7a3e5882d13fb51eecfaaf7fc8c53b59.jpg"><img alt="" src="assets/doc/10-å…¶ä»–/webrtcç½‘é¡µä»£ç åˆ†æäºŒ/images/wp_editor_md_7a3e5882d13fb51eecfaaf7fc8c53b59.jpg"/></a></p>
<p>ä¸Šå›¾æ˜¯å®Œæ•´çš„å¤„ç†æµç¨‹ã€‚</p>
<h2 id="url">è·å–URLå‚æ•°</h2>
<div class="codehilite"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">queryString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">window</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">search</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">urlParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">URLSearchParams</span><span class="p">(</span><span class="n">queryString</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="n">deviceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">urlParams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'deviceId'</span><span class="p">);</span>
</code></pre></div>
<p>è¿™æ®µä»£ç å…ˆè·å–å½“å‰é¡µé¢ URL ä¸­çš„æŸ¥è¯¢å­—ç¬¦ä¸²éƒ¨åˆ†ï¼ˆwindow.location.searchï¼‰ï¼Œç„¶åä½¿ç”¨ URLSearchParams å¯¹è±¡è§£ææŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œå°è¯•è·å–åä¸º deviceId çš„å‚æ•°å€¼ï¼Œåç»­å¾ˆå¤šæ“ä½œä¼šæ ¹æ®è¿™ä¸ª deviceId çš„æœ‰æ— æ¥è¿›è¡Œä¸åŒçš„é€»è¾‘å¤„ç†ã€‚</p>
<h2 id="_2">é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–æ“ä½œ</h2>
<div class="codehilite"><pre><span></span><code><span class="n">window</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deviceId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s1">'video'</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'none'</span><span class="p">;</span>
<span class="w">    </span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s1">'getting-started'</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'block'</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'canvas'</span><span class="p">)</span>
<span class="w">  </span><span class="n">canvas</span><span class="o">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">640</span>
<span class="w">  </span><span class="n">canvas</span><span class="o">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">480</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">canvas</span><span class="o">.</span><span class="n">getContext</span><span class="p">(</span><span class="s1">'2d'</span><span class="p">)</span>
<span class="w">  </span><span class="n">ctx</span><span class="o">.</span><span class="n">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'rgba(200, 200, 200, 100)'</span>
<span class="w">  </span><span class="n">ctx</span><span class="o">.</span><span class="n">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span><span class="w"> </span><span class="mi">480</span><span class="p">)</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Image</span><span class="p">(</span><span class="mi">640</span><span class="p">,</span><span class="w"> </span><span class="mi">480</span><span class="p">)</span>
<span class="w">  </span><span class="n">img</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">canvas</span><span class="o">.</span><span class="n">toDataURL</span><span class="p">()</span>

<span class="w">  </span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s1">'imgStream'</span><span class="p">)</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">img</span><span class="o">.</span><span class="n">src</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>window.onloadæ˜¯é¡µé¢åŠ è½½å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œä¸Šé¢ä½¿ç”¨çš„æ˜¯åŒ¿åå‡½æ•°ï¼Œå³å½“é¡µé¢æ‰€æœ‰å†…å®¹åŠ è½½å®Œæˆåæ‰§è¡Œçš„é€»è¾‘ã€‚å…·ä½“é€»è¾‘å¦‚ä¸‹</p>
<p>è¿™é‡Œåˆ¤æ–­å¦‚æœdeviceIdæœªå®šä¹‰ï¼ˆä¹Ÿå°±æ˜¯å¯èƒ½é¡µé¢ç›´æ¥è®¿é—®ï¼Œæ²¡æœ‰å¸¦ä¸Šå¯¹åº”çš„å‚æ•°ï¼‰ï¼Œåˆ™éšè—è§†é¢‘ç›¸å…³åŒºåŸŸï¼ˆidä¸ºvideoçš„divï¼‰ï¼Œæ˜¾ç¤ºåˆå§‹å¼•å¯¼å†…å®¹åŒºåŸŸï¼ˆid ä¸º getting-started çš„ divï¼‰ã€‚åœ¨å‡½æ•°å†…åˆ›å»ºäº†ä¸€ä¸ª canvas å…ƒç´ ï¼Œç»˜åˆ¶äº†ä¸€ä¸ªåŠé€æ˜çš„çŸ©å½¢ï¼Œå°†å…¶è½¬æ¢ä¸ºå›¾ç‰‡æ•°æ®åè®¾ç½®ç»™img id=\\\\"imgStream\\\\"å…ƒç´ ä½œä¸ºåˆå§‹æ˜¾ç¤ºå†…å®¹ã€‚</p>
<h2 id="mqtt">MQTTæ“ä½œ</h2>
<h3 id="_3">å‘èµ·è¿æ¥</h3>
<div class="codehilite"><pre><span></span><code><span class="k">var</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">keepalive</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="p">,</span>
<span class="w">  </span><span class="n">username</span><span class="p">:</span><span class="w"> </span><span class="s1">'xxx'</span><span class="p">,</span>
<span class="w">  </span><span class="n">password</span><span class="p">:</span><span class="w"> </span><span class="s1">'xxxx'</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">const</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mqtt</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">'wss://xxx.xxx.com:8084/mqtt'</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
</code></pre></div>
<p>å®šä¹‰äº† MQTTè¿æ¥çš„ç›¸å…³é€‰é¡¹ï¼ˆå¦‚ä¿æ´»æ—¶é—´ã€ç”¨æˆ·åã€å¯†ç ç­‰ï¼‰ï¼Œç„¶åå°è¯•è¿æ¥åˆ°æŒ‡å®šçš„MQTTæœåŠ¡å™¨åœ°å€ï¼ˆwss://xxx.xxx.xxx:8084/mqttï¼‰ï¼Œåç»­é€šè¿‡clientå¯¹è±¡æ¥å¤„ç† MQTT çš„å„ç§æ¶ˆæ¯æ”¶å‘ä»¥åŠç›¸å…³æ“ä½œã€‚</p>
<h3 id="_4">äº‹ä»¶å¤„ç†</h3>
<h4 id="connect">connectäº‹ä»¶</h4>
<div class="codehilite"><pre><span></span><code><span class="nt">client</span><span class="p">.</span><span class="nc">on</span><span class="o">(</span><span class="s1">'connect'</span><span class="o">,</span><span class="w"> </span><span class="nt">function</span><span class="w"> </span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="err">console.log("connected")</span>
<span class="w">  </span><span class="err">client.subscribe('webrtc/'</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">deviceId</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">'/jsonrpc-reply',</span><span class="w"> </span><span class="err">function</span><span class="w"> </span><span class="err">(err)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="err">if</span><span class="w"> </span><span class="err">(!err)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="err">}</span><span class="o">);</span>
<span class="w">  </span><span class="nt">console</span><span class="p">.</span><span class="nc">log</span><span class="o">(</span><span class="s1">'publish to webrtc/'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nt">deviceId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'/jsonrpc'</span><span class="o">);</span>
<span class="w">  </span><span class="nt">client</span><span class="p">.</span><span class="nc">publish</span><span class="o">(</span><span class="s1">'webrtc/'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nt">deviceId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'/jsonrpc'</span><span class="o">,</span><span class="w"> </span><span class="nt">JSON</span><span class="p">.</span><span class="nc">stringify</span><span class="o">(</span><span class="p">{</span>
<span class="w">    </span><span class="n">jsonrpc</span><span class="p">:</span><span class="w"> </span><span class="s1">'2.0'</span><span class="p">,</span>
<span class="w">    </span><span class="n">method</span><span class="o">:</span><span class="w"> </span><span class="s1">'offer'</span><span class="p">,</span>
<span class="w">    </span><span class="n">id</span><span class="o">:</span><span class="w"> </span><span class="n">offerId</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span><span class="o">),</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">qos</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">}</span><span class="o">);</span>
<span class="err">}</span><span class="o">)</span>
</code></pre></div>
<p>ç»“æ„ä¸ºclient.on(\\\\'connect\\\\', function () {... })ï¼› client.onè¿™é‡Œæ˜¯mqttå¯¹è±¡çš„äº‹ä»¶å›è°ƒï¼Œè¿™é‡Œå°†function(){...}ä½œä¸ºå›è°ƒå‡½æ•°æ³¨å†Œè¿›å»ï¼Œfuncitonå®ç°æ˜¯åŒ¿åå‡½æ•°çš„æ–¹å¼ã€‚å½“å‰æ”¶åˆ°connectäº‹ä»¶æ—¶ï¼Œå°±ä¼šæ‰§è¡Œfunctionçš„å†…å®¹ã€‚å…·ä½“é€»è¾‘å¦‚ä¸‹ã€‚ å½“æˆåŠŸè¿æ¥åˆ°MQTTæœåŠ¡å™¨åï¼Œå…ˆåœ¨æ§åˆ¶å°è¾“å‡º connected è¡¨ç¤ºè¿æ¥æˆåŠŸï¼Œç„¶åè®¢é˜…ä¸€ä¸ªç‰¹å®šä¸»é¢˜ï¼ˆwebrtc/\\\\' + deviceId + \\\\'/jsonrpc-replyï¼‰ç”¨äºæ¥æ”¶å›å¤æ¶ˆæ¯ï¼Œæ¥ç€å‘å¦ä¸€ä¸ªç‰¹å®šä¸»é¢˜ï¼ˆwebrtc/\\\\' + deviceId + \\\\'/jsonrpcï¼‰å‘å¸ƒä¸€æ¡åŒ…å«offerä¿¡æ¯çš„ JSON æ ¼å¼æ¶ˆæ¯ï¼ˆè®¾ç½®äº†æ¶ˆæ¯è´¨é‡ç­‰çº§ qos ä¸º 2ï¼‰ï¼Œç”¨äºå‘èµ·æŸç§äº¤äº’ï¼ˆå¯èƒ½ä¸ WebRTC ç›¸å…³çš„ä¼šè¯å»ºç«‹ç­‰æ“ä½œï¼‰ã€‚</p>
<p>ï¼ˆ1ï¼‰è®¢é˜…å‡½æ•°subscribe</p>
<div class="codehilite"><pre><span></span><code>client.subscribe(topic, options, callback);
</code></pre></div>
<ul>
<li>topic: éœ€è¦è®¢é˜…çš„ä¸»é¢˜ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…ä¸€ä¸ªä¸»é¢˜æ•°ç»„ã€‚ä¸»é¢˜æ˜¯ MQTT ä¸­ç”¨äºåˆ†ç±»æ¶ˆæ¯çš„æ–¹å¼ã€‚ä¸»é¢˜çš„å‘½åè§„åˆ™é€šå¸¸æ˜¯å±‚çº§çš„ï¼Œä½¿ç”¨æ–œæ ï¼ˆ/ï¼‰åˆ†éš”æ¯ä¸€å±‚çº§ï¼Œä¾‹å¦‚ \\\\'home/livingroom/temperature\\\\'ã€‚</li>
<li>options: å¯é€‰å‚æ•°ï¼Œé…ç½®è®¢é˜…çš„ä¸€äº›é€‰é¡¹ï¼Œå¦‚ QoSï¼ˆæœåŠ¡è´¨é‡ï¼‰çº§åˆ«ã€‚å¸¸è§çš„é€‰é¡¹åŒ…æ‹¬ï¼š -- qos: æœåŠ¡è´¨é‡ï¼ˆQuality of Serviceï¼‰çº§åˆ«ï¼Œå–å€¼èŒƒå›´æ˜¯ï¼š -- 0 - è‡³å¤šä¸€æ¬¡ï¼šæ¶ˆæ¯æœ€å¤šå‘é€ä¸€æ¬¡ï¼Œä¸åšç¡®è®¤ã€‚ -- 1 - è‡³å°‘ä¸€æ¬¡ï¼šæ¶ˆæ¯è‡³å°‘å‘é€ä¸€æ¬¡ï¼Œå¯èƒ½ä¼šé‡å¤ã€‚ -- 2 - åªæœ‰ä¸€æ¬¡ï¼šæ¶ˆæ¯åªèƒ½ä¼ é€’ä¸€æ¬¡ï¼Œä¸ä¼šä¸¢å¤±ï¼Œä¹Ÿä¸ä¼šé‡å¤ã€‚</li>
<li>callback: å¯é€‰çš„å›è°ƒå‡½æ•°ï¼Œå½“è®¢é˜…æˆåŠŸæ—¶ä¼šè¢«è°ƒç”¨ã€‚å›è°ƒå‡½æ•°æ¥å—ä¸€ä¸ªé”™è¯¯å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¦‚æœè®¢é˜…æˆåŠŸï¼Œerr ä¸º nullï¼›å¦‚æœè®¢é˜…å¤±è´¥ï¼Œåˆ™è¿”å›ç›¸åº”çš„é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<p>ï¼ˆ2ï¼‰å‘å¸ƒå‡½æ•°publish</p>
<div class="codehilite"><pre><span></span><code>client.publish(topic, message, options, callback);
</code></pre></div>
<ul>
<li>
<p>topic: éœ€è¦å‘å¸ƒæ¶ˆæ¯çš„ä¸»é¢˜ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºä¸»é¢˜åç§°ã€‚</p>
</li>
<li>
<p>message: éœ€è¦å‘å¸ƒçš„æ¶ˆæ¯å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€Bufferã€å¯¹è±¡ç­‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯ä¼šè¢«è‡ªåŠ¨è½¬æ¢ä¸ºå­—ç¬¦ä¸²æˆ– Bufferï¼ˆå¦‚æœä¼ å…¥å¯¹è±¡ï¼Œä¼šè‡ªåŠ¨é€šè¿‡ JSON.stringify() è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼‰ã€‚</p>
</li>
<li>
<p>options: å¯é€‰å‚æ•°ï¼Œé…ç½®å‘å¸ƒæ¶ˆæ¯çš„é€‰é¡¹ï¼Œå¸¸è§çš„é€‰é¡¹åŒ…æ‹¬ï¼š -- qos: æœåŠ¡è´¨é‡ï¼ˆQuality of Serviceï¼‰çº§åˆ«ï¼ˆå¦‚å‰è¿°ï¼‰ï¼Œé»˜è®¤æ˜¯ 0ã€‚ -- retain: æ˜¯å¦ä¿ç•™æ¶ˆæ¯ï¼Œè‹¥ä¸º trueï¼Œä»£ç†æœåŠ¡å™¨ä¼šä¿å­˜æ¶ˆæ¯å¹¶åœ¨æ–°è®¢é˜…è€…è¿æ¥æ—¶å‘é€è¯¥æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p>callback: å¯é€‰çš„å›è°ƒå‡½æ•°ï¼Œå‘å¸ƒæ¶ˆæ¯æˆåŠŸåä¼šè¢«è°ƒç”¨ã€‚å›è°ƒå‡½æ•°æ¥å—ä¸€ä¸ªé”™è¯¯å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¦‚æœå‘å¸ƒæˆåŠŸï¼Œerr ä¸º nullï¼›å¦‚æœå‘å¸ƒå¤±è´¥ï¼Œåˆ™è¿”å›ç›¸åº”çš„é”™è¯¯ä¿¡æ¯ã€‚</p>
</li>
</ul>
<h4 id="messange">messangeäº‹ä»¶</h4>
<p>MQTTæ¶ˆæ¯æ¥æ”¶å¤„ç†ï¼ˆclient.on(\\\\'message\\\\', function (topic, message) {... })ï¼‰ï¼Œè¯­æ³•ä¸ä¸Šé¢ç±»ä¼¼ï¼Œé€»è¾‘å¦‚ä¸‹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="err">'</span><span class="nx">message</span><span class="err">'</span><span class="p">,</span><span class="w"> </span><span class="nx">function</span><span class="w"> </span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">offerId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">sdp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">offer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="err">'</span><span class="nx">offer</span><span class="err">'</span><span class="p">,</span><span class="w"> </span><span class="nx">sdp</span><span class="p">:</span><span class="w"> </span><span class="nx">sdp</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="nx">offer</span><span class="p">);</span>
<span class="w">    </span><span class="nx">pc</span><span class="p">.</span><span class="nx">setRemoteDescription</span><span class="p">(</span><span class="nx">offer</span><span class="p">);</span>
<span class="w">    </span><span class="nx">pc</span><span class="p">.</span><span class="nx">createAnswer</span><span class="p">().</span><span class="k">then</span><span class="p">(</span><span class="nx">d</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nx">pc</span><span class="p">.</span><span class="nx">setLocalDescription</span><span class="p">(</span><span class="nx">d</span><span class="p">)).</span><span class="nx">catch</span><span class="p">(</span><span class="nx">log</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">answerId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="err">'</span><span class="nx">receive</span><span class="w"> </span><span class="nx">answer</span><span class="w"> </span><span class="nx">ok</span><span class="err">'</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</code></pre></div>
<p>å½“æ¥æ”¶åˆ°MQTTæ¶ˆæ¯æ—¶ï¼Œå…ˆå°†æ¶ˆæ¯å†…å®¹è§£æä¸º JSON å¯¹è±¡ï¼Œç„¶åæ ¹æ®æ¶ˆæ¯ä¸­çš„ id åˆ¤æ–­æ¶ˆæ¯ç±»å‹ï¼Œå¦‚æœ id ä¸ä¹‹å‰å®šä¹‰çš„ offerId ç›¸ç­‰ï¼Œè¯´æ˜æ˜¯å¯¹ä¹‹å‰ offer çš„å›å¤ï¼Œä¼šæå–å…¶ä¸­çš„ sdp ä¿¡æ¯è®¾ç½®ä¸ºè¿œç¨‹æè¿°ï¼ˆsetRemoteDescriptionï¼‰ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæœ¬åœ°å›ç­”ï¼ˆcreateAnswerï¼‰ç„¶åè®¾ç½®æœ¬åœ°æè¿°ï¼ˆsetLocalDescriptionï¼‰ï¼›å¦‚æœ id ç­‰äº answerIdï¼Œåˆ™åªæ˜¯åœ¨æ§åˆ¶å°è¾“å‡ºè¡¨ç¤ºæ¥æ”¶åˆ°äº†å›ç­”æ¶ˆæ¯ã€‚</p>
<h2 id="webrtc">WebRTCæ“ä½œ</h2>
<h3 id="_5">åˆ›å»ºå¯¹è±¡</h3>
<div class="codehilite"><pre><span></span><code><span class="k">var</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">RTCPeerConnection</span><span class="p">({</span>
<span class="w">  </span><span class="n">iceServers</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">urls</span><span class="p">:</span><span class="w"> </span><span class="s2">"turn:rtpeer.allwinnertech.com:3478"</span><span class="p">,</span>
<span class="w">      </span><span class="n">username</span><span class="p">:</span><span class="w"> </span><span class="s2">"pctest"</span><span class="p">,</span>
<span class="w">      </span><span class="n">credential</span><span class="p">:</span><span class="w"> </span><span class="s2">"Aa123456"</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">],</span>
<span class="p">});</span>
</code></pre></div>
<p>åˆ›å»ºäº†ä¸€ä¸ª RTCPeerConnection å¯¹è±¡ç”¨äºå»ºç«‹ WebRTC è¿æ¥ï¼Œé…ç½®äº† iceServersï¼Œè¿™é‡ŒæŒ‡å®šäº†ä¸€ä¸ª TURN æœåŠ¡å™¨çš„ç›¸å…³ä¿¡æ¯ï¼ˆåœ°å€ã€ç”¨æˆ·åã€å¯†ç ï¼‰ï¼Œæœ‰åŠ©äºåœ¨å¤æ‚ç½‘ç»œç¯å¢ƒï¼ˆå¦‚å­˜åœ¨ NAT ç­‰æƒ…å†µï¼‰ä¸‹å»ºç«‹ç¨³å®šçš„ç‚¹å¯¹ç‚¹è¿æ¥ï¼Œç¡®ä¿éŸ³è§†é¢‘æ•°æ®èƒ½é¡ºåˆ©ä¼ è¾“ã€‚</p>
<h3 id="pc">è·å–PCå½•éŸ³</h3>
<div class="codehilite"><pre><span></span><code><span class="nt">navigator</span><span class="p">.</span><span class="nc">mediaDevices</span><span class="p">.</span><span class="nc">getUserMedia</span><span class="o">(</span><span class="p">{</span><span class="w"> </span><span class="n">video</span><span class="p">:</span><span class="w"> </span><span class="n">false</span><span class="p">,</span><span class="w"> </span><span class="n">audio</span><span class="o">:</span><span class="w"> </span><span class="n">true</span><span class="w"> </span><span class="p">}</span><span class="o">)</span>
<span class="w"> </span><span class="p">.</span><span class="nc">then</span><span class="o">(</span><span class="nt">stream</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">stream.getTracks().forEach(track</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="err">pc.addTrack(track,</span><span class="w"> </span><span class="err">stream))</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="o">)</span><span class="p">.</span><span class="nc">catch</span><span class="o">(</span><span class="nt">log</span><span class="o">);</span>
</code></pre></div>
<p>é€šè¿‡ navigator.mediaDevices.getUserMedia æ–¹æ³•è¯·æ±‚è·å–éŸ³é¢‘åª’ä½“æµï¼ˆè¿™é‡Œæ˜ç¡®åªè¦éŸ³é¢‘ï¼Œvideo: false, audio: trueï¼‰ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œå°†éŸ³é¢‘è½¨é“æ·»åŠ åˆ° RTCPeerConnection å¯¹è±¡ï¼ˆpcï¼‰ä¸­ï¼Œä»¥ä¾¿åç»­ä¼ è¾“éŸ³é¢‘æ•°æ®ï¼Œå¦‚æœå‡ºç°é”™è¯¯åˆ™é€šè¿‡ log å‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯åœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼‰è¿›è¡Œå¤„ç†ã€‚</p>
<h3 id="_6">è¿æ¥çŠ¶æ€</h3>
<div class="codehilite"><pre><span></span><code><span class="nv">pc</span>.<span class="nv">oniceconnectionstatechange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span>{
<span class="w">  </span><span class="nv">log</span><span class="ss">(</span><span class="nv">pc</span>.<span class="nv">iceConnectionState</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">  </span><span class="nv">document</span>.<span class="nv">getElementById</span><span class="ss">(</span><span class="s1">'status'</span><span class="ss">)</span>.<span class="nv">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">pc</span>.<span class="nv">iceConnectionState</span><span class="c1">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">pc</span>.<span class="nv">iceConnectionState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'connected'</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nv">default</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">muted</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="o">!</span><span class="nv">isMuted</span><span class="ss">)</span>
<span class="w">      </span><span class="nv">onMuted</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">  </span>}
}
</code></pre></div>
<p>å½“ WebRTC è¿æ¥çš„ ICE è¿æ¥çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå…ˆåœ¨æ§åˆ¶å°è¾“å‡ºå½“å‰è¿æ¥çŠ¶æ€ï¼ˆé€šè¿‡ log å‡½æ•°ï¼‰ï¼Œç„¶åæ›´æ–°é¡µé¢ä¸Š id ä¸º status çš„å…ƒç´ æ–‡æœ¬å†…å®¹ä¸ºå½“å‰è¿æ¥çŠ¶æ€ï¼Œå¹¶ä¸”å½“è¿æ¥çŠ¶æ€å˜ä¸º connectedï¼ˆå·²è¿æ¥ï¼‰æ—¶ï¼Œå¦‚æœå½“å‰ä¸æ˜¯é™éŸ³çŠ¶æ€ï¼ˆ!isMutedï¼‰ï¼Œåˆ™è°ƒç”¨ onMuted å‡½æ•°å°†éŸ³é¢‘é™éŸ³ã€‚</p>
<h3 id="ice">ICEå€™é€‰è€…</h3>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nt">pc</span><span class="p">.</span><span class="nc">onicecandidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">event</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="err">if</span><span class="w"> </span><span class="err">(event.candidate</span><span class="w"> </span><span class="err">===</span><span class="w"> </span><span class="err">null)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="err">console.log(pc.localDescription.sdp)</span>
<span class="w">        </span><span class="err">let</span><span class="w"> </span><span class="err">json</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">          </span><span class="n">jsonrpc</span><span class="p">:</span><span class="w"> </span><span class="err">\\</span><span class="s1">'2.0\\'</span><span class="p">,</span>
<span class="w">          </span><span class="n">method</span><span class="o">:</span><span class="w"> </span><span class="err">\\</span><span class="s1">'answer\\'</span><span class="p">,</span>
<span class="w">          </span><span class="n">params</span><span class="o">:</span><span class="w"> </span><span class="n">pc</span><span class="o">.</span><span class="n">localDescription</span><span class="o">.</span><span class="n">sdp</span><span class="p">,</span>
<span class="w">          </span><span class="n">id</span><span class="o">:</span><span class="w"> </span><span class="n">answerId</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nt">console</span><span class="p">.</span><span class="nc">log</span><span class="o">(</span><span class="nt">json</span><span class="o">)</span>
<span class="w">        </span><span class="nt">client</span><span class="p">.</span><span class="nc">publish</span><span class="o">(</span><span class="err">\\</span><span class="s1">'webrtc/\\'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nt">deviceId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="err">\\</span><span class="s1">'/jsonrpc\\'</span><span class="o">,</span><span class="w"> </span><span class="nt">JSON</span><span class="p">.</span><span class="nc">stringify</span><span class="o">(</span><span class="nt">json</span><span class="o">))</span>

<span class="w">        </span><span class="nt">setInterval</span><span class="o">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="err">....</span><span class="p">}</span><span class="o">,</span><span class="w"> </span><span class="nt">1000</span><span class="o">);</span>

<span class="w">      </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
</code></pre></div>
<p>å½“æœ‰ ICE å€™é€‰è€…ä¿¡æ¯äº§ç”Ÿå¹¶ä¸”å½“å€™é€‰è€…ä¸º null æ—¶ï¼ˆæ„å‘³ç€ ICE æ”¶é›†è¿‡ç¨‹ç»“æŸï¼‰ï¼Œæ‰§è¡Œä¸€ç³»åˆ—æ“ä½œï¼ŒåŒ…æ‹¬æ‰“å° RTCPeerConnection çš„æœ¬åœ°æè¿°ä¸­çš„ sdp ä¿¡æ¯ï¼Œå‘ MQTT ç‰¹å®šä¸»é¢˜å‘å¸ƒåŒ…å«æœ¬åœ°æè¿° sdp ä¿¡æ¯çš„ JSON æ¶ˆæ¯ï¼Œå¹¶ä¸”æ¯éš” 1 ç§’è·å–è¿æ¥çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆé€šè¿‡ pc.getStats æ–¹æ³•ï¼‰ï¼Œæ•´ç†åæ›´æ–°åˆ°é¡µé¢ä¸­ id ä¸º stats-box çš„å…ƒç´ å†…å±•ç¤ºå‡ºæ¥ã€‚</p>
<p>å½“æ”¶åˆ°å¯¹ç«¯çš„offerå€™é€‰ä¿¡æ¯åï¼Œæœ¬åœ°ä¼šè¿›è¡Œä¸stun/turnæœåŠ¡äº¤äº’ï¼Œäº¤äº’è·å–åˆ°ICEä¿¡æ¯åï¼Œå°±ä¼šè§¦å‘å›è°ƒè¿™ä¸ªå‡½æ•°ï¼Œå°†è‡ªå·±SDPä¿¡æ¯ç»„è£…æˆjsoné€šè¿‡mqtt publishå‘é€ç»™å¯¹ç«¯ã€‚</p>
<h3 id="_7">æ¥æ”¶éŸ³è§†é¢‘</h3>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">pc</span><span class="o">.</span><span class="n">ontrack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">track</span><span class="o">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>\\<span class="s1">'video</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">el</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span>\\<span class="s1">'videoStream</span><span class="se">\\</span><span class="s1">'</span><span class="p">);</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">newStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MediaStream</span><span class="p">();</span>
<span class="w">        </span><span class="n">newStream</span><span class="o">.</span><span class="n">addTrack</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">track</span><span class="p">);</span>
<span class="w">        </span><span class="n">el</span><span class="o">.</span><span class="n">srcObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newStream</span><span class="p">;</span>
<span class="w">        </span><span class="n">el</span><span class="o">.</span><span class="n">autoplay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span>
<span class="w">        </span><span class="n">el</span><span class="o">.</span><span class="n">controls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span>
<span class="w">        </span><span class="n">el</span><span class="o">.</span><span class="n">muted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span>
<span class="w">        </span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span>\\<span class="s1">'imgStream</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\\<span class="s1">'none</span><span class="se">\\</span><span class="s1">'</span><span class="p">;</span>
<span class="w">        </span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span>\\<span class="s1">'videoStream</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\\<span class="s1">'block</span><span class="se">\\</span><span class="s1">'</span><span class="p">;</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="err">å½“è§†é¢‘æµæ·»åŠ æˆåŠŸåï¼Œè·å–è§†é¢‘åˆ†è¾¨ç‡å’Œç ç‡ä¿¡æ¯å¹¶æ›´æ–°æ˜¾ç¤º</span>
<span class="w">        </span><span class="n">el</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span>\\<span class="s1">'loadedmetadata</span><span class="se">\\</span><span class="s1">'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">updateVideoInfo</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">track</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">track</span><span class="o">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>\\<span class="s1">'audio</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">el</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span>\\<span class="s1">'audioStream</span><span class="se">\\</span><span class="s1">'</span><span class="p">);</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">newStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MediaStream</span><span class="p">();</span>
<span class="w">        </span><span class="n">newStream</span><span class="o">.</span><span class="n">addTrack</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">track</span><span class="p">);</span>
<span class="w">        </span><span class="n">el</span><span class="o">.</span><span class="n">srcObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newStream</span><span class="p">;</span>
<span class="w">        </span><span class="n">el</span><span class="o">.</span><span class="n">controls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span>
<span class="w">        </span><span class="n">el</span><span class="o">.</span><span class="n">muted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>å½“é€šè¿‡ RTCPeerConnection æ¥æ”¶åˆ°è¿œç«¯ä¼ æ¥çš„åª’ä½“è½¨é“ï¼ˆè§†é¢‘æˆ–éŸ³é¢‘è½¨é“ï¼‰æ—¶ï¼Œæ ¹æ®è½¨é“ç±»å‹è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚å¯¹äºè§†é¢‘è½¨é“ï¼Œè·å–é¡µé¢ä¸­çš„è§†é¢‘å…ƒç´ ï¼ˆid ä¸º videoStreamï¼‰ï¼Œåˆ›å»ºæ–°çš„ MediaStream å¯¹è±¡æ·»åŠ è½¨é“åè®¾ç½®ä¸ºè§†é¢‘å…ƒç´ çš„æ’­æ”¾æºï¼ŒåŒæ—¶è®¾ç½®è‡ªåŠ¨æ’­æ”¾ã€éšè—æ§åˆ¶æ¡ã€é™éŸ³ç­‰å±æ€§ï¼Œå¹¶åœ¨è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆåï¼ˆé€šè¿‡ loadedmetadata äº‹ä»¶ï¼‰è°ƒç”¨ updateVideoInfo å‡½æ•°æ›´æ–°è§†é¢‘åˆ†è¾¨ç‡å’Œç ç‡ä¿¡æ¯æ˜¾ç¤ºï¼›å¯¹äºéŸ³é¢‘è½¨é“ï¼Œç±»ä¼¼åœ°è·å–éŸ³é¢‘å…ƒç´ ï¼ˆid ä¸º audioStreamï¼‰ï¼Œæ·»åŠ è½¨é“åˆ°æ–°çš„ MediaStream å¯¹è±¡å¹¶è®¾ç½®ä¸ºéŸ³é¢‘å…ƒç´ æ’­æ”¾æºï¼Œè®¾ç½®ä¸æ˜¾ç¤ºæ§åˆ¶æ¡ä¸”ä¸é™éŸ³ã€‚</p>
<h3 id="_8">æ•°æ®é€šé“</h3>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="n">datachannel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc</span><span class="p">.</span><span class="n">createDataChannel</span><span class="p">(</span><span class="err">\\</span><span class="s1">'pear\\'</span><span class="p">)</span>
<span class="w">    </span><span class="n">datachannel</span><span class="p">.</span><span class="n">onclose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="err">\\</span><span class="s1">'datachannel has closed\\'</span><span class="p">);</span>
<span class="w">    </span><span class="n">datachannel</span><span class="p">.</span><span class="n">onopen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="err">\\</span><span class="s1">'datachannel has opened\\'</span><span class="p">);</span>
<span class="w">      </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="err">\\</span><span class="s1">'sending ping\\'</span><span class="p">);</span>
<span class="w">      </span><span class="n">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="err">\\</span><span class="s1">'sending ping\\'</span><span class="p">);</span>
<span class="w">        </span><span class="n">datachannel</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="err">\\</span><span class="s1">'ping\\'</span><span class="p">);</span>
<span class="w">      </span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="n">datachannel</span><span class="p">.</span><span class="n">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="k">data</span><span class="p">.</span><span class="n">byteLength</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">undefined</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="k">data</span><span class="p">);</span>
<span class="w">      </span><span class="err">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nc">binary</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="w"> </span><span class="n">mjpeg</span><span class="w"> </span><span class="n">stream</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="k">data</span><span class="p">.</span><span class="n">byteLength</span><span class="p">);</span>
<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">arrayBufferView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Uint8Array</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="k">data</span><span class="p">);</span>
<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="k">blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">Blob</span><span class="p">(</span><span class="o">[</span><span class="n">arrayBufferView</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="err">\\</span><span class="ss">"image/jpeg\\"</span><span class="w"> </span><span class="err">}</span><span class="p">);</span>
<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">urlCreator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">window</span><span class="p">.</span><span class="n">URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">window</span><span class="p">.</span><span class="n">webkitURL</span><span class="p">;</span>
<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">imageUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">urlCreator</span><span class="p">.</span><span class="n">createObjectURL</span><span class="p">(</span><span class="k">blob</span><span class="p">);</span>

<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">imageElement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span><span class="err">\\</span><span class="s1">'imgStream\\'</span><span class="p">);</span>
<span class="w">        </span><span class="n">imageElement</span><span class="p">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imageUrl</span><span class="p">;</span>
<span class="w">      </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
</code></pre></div>
<p>åˆ›å»ºäº†ä¸€ä¸ªåä¸ºpearçš„æ•°æ®é€šé“ï¼ˆconst datachannel = pc.createDataChannel(\\'pear\\')ï¼‰ï¼Œå¹¶åˆ†åˆ«å¯¹æ•°æ®é€šé“çš„æ‰“å¼€ã€å…³é—­ã€æ¥æ”¶æ¶ˆæ¯ç­‰äº‹ä»¶ç»‘å®šäº†ç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚ä¾‹å¦‚åœ¨æ•°æ®é€šé“æ‰“å¼€æ—¶ï¼ˆdatachannel.onopenï¼‰ï¼Œä¼šå®šæœŸï¼ˆæ¯éš” 1 ç§’ï¼‰å‘é€ ping æ¶ˆæ¯ç”¨äºä¿æŒè¿æ¥æˆ–æ£€æµ‹è¿æ¥çŠ¶æ€ç­‰ï¼›åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼ˆdatachannel.onmessageï¼‰ï¼Œæ ¹æ®æ¶ˆæ¯æ•°æ®ç±»å‹åˆ¤æ–­ï¼Œå¦‚æœæ˜¯æ–‡æœ¬æ¶ˆæ¯ç›´æ¥åœ¨æ§åˆ¶å°è¾“å‡ºï¼Œå¦‚æœæ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼ˆåˆ¤æ–­ä¸º MJPEG æµï¼‰ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸ºå›¾ç‰‡çš„ URL å¹¶è®¾ç½®ç»™é¡µé¢ä¸­çš„å›¾ç‰‡å…ƒç´ ï¼ˆid ä¸º imgStreamï¼‰ç”¨äºæ˜¾ç¤ºã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œæ”¯æŒmjpegçš„æ–¹å¼ï¼Œä½†æ˜¯æ˜¯é€šè¿‡æ•°æ®é€šé“æ¥å®ç°çš„ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="webrtcç½‘é¡µä»£ç åˆ†æä¸€.html">â† webrtcç½‘é¡µä»£ç åˆ†æä¸€</a>
    <a class="next" href="javascriptä¹‹dom.html">javascriptä¹‹dom â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

