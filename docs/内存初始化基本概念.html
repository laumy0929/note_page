<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å†…å­˜åˆå§‹åŒ–åŸºæœ¬æ¦‚å¿µ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#nodezonepage">ä¸‰çº§ç»“æ„Nodeã€Zoneã€Page</a><ul><li><a href="#nodeumanuma">Nodeä¸å†…å­˜æ¶æ„UMAã€NUMA</a></li></ul></li><li><a href="#_2">ä¸‰ç§å†…å­˜æ¨¡å‹</a><ul><li><a href="#flat-memory-model">FLAT memory model</a></li><li><a href="#discontiguous-memory-model">Discontiguous memory model</a></li><li><a href="#sparse-memory-model">Sparse memory model</a></li></ul></li><li><a href="#_3">å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†å¸ƒ</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>å†…å­˜åˆå§‹åŒ–åŸºæœ¬æ¦‚å¿µ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-06-10
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="nodezonepage">ä¸‰çº§ç»“æ„Nodeã€Zoneã€Page</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_6d2fb92edac71f0ea5c3246ddc3268c6.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ä¸‰çº§ç»“æ„nodeã€zoneã€page/images/wp_editor_md_6d2fb92edac71f0ea5c3246ddc3268c6.jpg"/></a></p>
<h3 id="nodeumanuma">Nodeä¸å†…å­˜æ¶æ„UMAã€NUMA</h3>
<h4 id="umauniform-memory-acces">UMAæ¶æ„ï¼ˆuniform memory accesï¼‰</h4>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_0a1c139caeb6c241c942e721cc090c95.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ä¸‰çº§ç»“æ„nodeã€zoneã€page/images/wp_editor_md_0a1c139caeb6c241c942e721cc090c95.jpg"/></a></p>
<p>ä¸€è‡´å†…å­˜è®¿é—®ï¼Œæ‰€æœ‰CPUè®¿é—®å†…å­˜éƒ½éœ€è¦è¿‡æ€»çº¿ï¼Œè·ç¦»éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æ¯ä¸ªå¤„ç†å™¨è®¿é—®å„ä¸ªå†…å­˜å—éƒ½æ˜¯åŒæ ·å¿«ã€‚å¦‚ä¸Šå›¾4ä¸ªCPUéƒ½é€šè¿‡ç³»ç»Ÿæ€»çº¿æ¥è®¿é—®ç‰©ç†å†…å­˜DDRã€‚ç›®å‰å¤§éƒ¨åˆ†åµŒå…¥å¼ç³»ç»Ÿæˆ–å°å¼æœºç³»ç»Ÿé‡‡ç”¨UMAæ¶æ„ã€‚</p>
<h4 id="numanon-uniform-memory-acces">NUMAæ¶æ„ï¼ˆNon-uniform memory accesï¼‰</h4>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_b08b157023aa1ddb245823aec5045b2b.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ä¸‰çº§ç»“æ„nodeã€zoneã€page/images/wp_editor_md_b08b157023aa1ddb245823aec5045b2b.jpg"/></a></p>
<p>éç»Ÿä¸€å†…å­˜è®¿é—®ï¼Œç³»ç»Ÿä¸­æœ‰å¤šä¸ªå†…å­˜èŠ‚ç‚¹å’Œå¤šä¸ªCPUç°‡ï¼ŒCPUè®¿é—®æœ¬åœ°å†…å­˜èŠ‚ç‚¹çš„é€Ÿåº¦æœ€å¿«ï¼Œè®¿é—®è¿œç«¯çš„å†…å­˜èŠ‚ç‚¹é€Ÿåº¦è¦æ…¢ä¸€ç‚¹ã€‚å¦‚ä¸Šå›¾è¯¥ç³»ç»Ÿä½¿ç”¨NUMAæ¶æ„ï¼Œæœ‰ä¸¤ä¸ªå†…å­˜èŠ‚ç‚¹ï¼Œå…¶ä¸­CPU0å’ŒCPU1ç»„æˆä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNode0ï¼‰,ä»–ä»¬å¯ä»¥é€šè¿‡ç³»ç»Ÿæ€»çº¿è®¿é—®æœ¬åœ°DDRç‰©ç†å†…å­˜ï¼ŒåŒç†CPU2å’ŒCPU3ç»„æˆå¦å¤–ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNode1ï¼‰,ä»–ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç³»ç»Ÿæ€»çº¿è®¿é—®æœ¬åœ°DDRç‰©ç†å†…å­˜ã€‚ä¸¤ä¸ªèŠ‚ç‚¹é€šè¿‡è¶…è·¯å¾„äº’è”æ€»çº¿è¿æ¥ï¼Œé‚£ä¹ˆCPU0å¯ä»¥é€šè¿‡è¿™ä¸ªå†…éƒ¨æ€»çº¿è®¿é—®è¿œç«¯å†…å­˜èŠ‚ç‚¹çš„ç‰©ç†å†…å­˜ï¼Œä½†æ˜¯è®¿é—®é€Ÿåº¦è¦æ¯”è®¿é—®æœ¬åœ°ç‰©ç†å†…å­˜æ…¢å¾ˆå¤šã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">mmzone</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pglist_data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="n">node_zones</span><span class="p">[</span><span class="n">MAX_NR_ZONES</span><span class="p">];</span><span class="w">  </span><span class="c1">//èŠ‚ç‚¹ä¸­ç‰©ç†å†…å­˜åŒºåŸŸ</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">zonelist</span><span class="w"> </span><span class="n">node_zonelists</span><span class="p">[</span><span class="n">MAX_ZONELISTS</span><span class="p">];</span><span class="w"> </span><span class="c1">//èŠ‚ç‚¹å¤‡ç”¨åˆ—è¡¨</span>
<span class="kt">int</span><span class="w"> </span><span class="n">nr_zones</span><span class="p">;</span><span class="w"> </span><span class="c1">//èŠ‚ç‚¹å†…å­˜åŒºåŸŸä¸ªæ•°</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">node_mem_map</span><span class="p">;</span><span class="w">  </span><span class="cm">/*NUMAèŠ‚ç‚¹å†…ç®¡ç†æ‰€æœ‰ç‰©ç†é¡µpageçš„æ•°ç»„*/</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">node_start_pfn</span><span class="p">;</span><span class="w">  </span><span class="cm">/*NUMAèŠ‚ç‚¹ç¬¬ä¸€ä¸ªç‰©ç†é¡µçš„pfn*/</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">node_present_pages</span><span class="p">;</span><span class="w"> </span><span class="cm">/* ç‰©ç†å†…å­˜é¡µçš„æ€»æ•° */</span><span class="w"> </span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">node_spanned_pages</span><span class="p">;</span><span class="w"> </span><span class="cm">/* ç‰©ç†å†…å­˜é¡µçš„æ€»é•¿åº¦ï¼ŒåŒ…å«æ´åœ¨å†… */</span><span class="w"> </span>
<span class="kt">int</span><span class="w"> </span><span class="n">node_id</span><span class="p">;</span><span class="w">  </span><span class="c1">//NUMAèŠ‚ç‚¹id</span>
<span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">kswapd_wait</span><span class="p">;</span><span class="w"> </span>
<span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">kswapd</span><span class="p">;</span><span class="w"> </span>
<span class="kt">int</span><span class="w"> </span><span class="n">kswapd_max_order</span><span class="p">;</span><span class="w"> </span>
<span class="p">......</span>
<span class="p">}</span><span class="w"> </span><span class="n">pg_data_t</span><span class="p">;</span>
</code></pre></div>
<h4 id="zone">ç‰©ç†å†…å­˜åˆ†åŒºï¼ˆzoneï¼‰</h4>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_f4956ab199544d2b9d3fb6eae04f8415.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ä¸‰çº§ç»“æ„nodeã€zoneã€page/images/wp_editor_md_f4956ab199544d2b9d3fb6eae04f8415.jpg"/></a></p>
<p>ç‰©ç†å†…å­˜æ˜¯ä»¥é¡µï¼ˆ4KBï¼‰æ¥è¿›è¡Œç®¡ç†çš„ï¼Œç†æƒ³çŠ¶æ€ä»»ä½•ç§ç±»çš„æ•°æ®éƒ½å¯ä»¥å­˜æ”¾åœ¨é¡µæ¡†ä¸­ï¼Œä½†å®é™…ä¸Šå—è®¡ç®—æœºä½“ç°ç»“æ„ç¡¬ä»¶æ–¹é¢çš„åˆ¶çº¦ï¼Œé™åˆ¶äº†é¡µæ¡†çš„ä½¿ç”¨æ–¹å¼ï¼Œå¦‚åœ¨X86ä½“ç³»ç»“æ„ä¸‹ï¼ŒISAæ€»çº¿çš„DMAæ§åˆ¶å™¨ï¼Œåªèƒ½å¯¹å†…å­˜å‰16MBè¿›è¡Œå¯»å€ï¼Œæ‰€ä»¥å¯¼è‡´ISAè®¾å¤‡ä¸èƒ½åœ¨æ•´ä¸ª32ä½åœ°å€ç©ºé—´æŒ‡å‘DMAï¼Œåªèƒ½ä½¿ç”¨ç‰©ç†å†…å­˜çš„å‰16MBè¿›è¡ŒDMAæ“ä½œï¼Œå› æ­¤ç‰©ç†å†…å­˜å‰16MBä¸“é—¨ç•™ç»™å†…æ ¸ç”¨äºDMAåˆ†é…ï¼Œç§°ä¹‹DMA ZONEã€‚ 32ä½çš„å¤„ç†å™¨åªæ”¯æŒ4Gçš„è™šæ‹Ÿåœ°å€ï¼Œå…¶ä¸­1Gçš„åœ°å€ç©ºé—´ç»™å†…æ ¸ï¼Œå¦‚æœç‰©ç†å†…å­˜å®é™…æœ‰4Gï¼Œé‚£ä¹ˆ1Gçš„å†…æ ¸ç©ºé—´åœ°å€æ— æ³•ä¸€ä¸€æ˜ å°„ï¼ŒLinuxå†…æ ¸æå‡ºçš„è§£å†³æ–¹æ¡ˆå°†ç‰©ç†å†…å­˜åˆ†æˆ2éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ç›´æ¥åšçº¿æ€§æ˜ å°„ï¼Œå¦ä¸€éƒ¨åˆ†é‡‡ç”¨åŠ¨æ€æ˜ å°„ï¼Œç§°ä¸ºé«˜ç«¯å†…å­˜ã€‚å¦‚æœæ˜¯64ä½çš„å¤„ç†å™¨ä¸€èˆ¬ä¸ä¼šæœ‰é«˜ç«¯å†…å­˜ï¼Œåº”è¯¥åœ°å€ç©ºé—´è¶³å¤Ÿå¤§ã€‚ 16~896MBçš„ç‰©ç†ç©ºé—´åŒºåŸŸè¢«ç›´æ¥æ˜ å°„åˆ°å†…æ ¸æ€è™šæ‹Ÿåœ°å€ç©ºé—´3G+16M~3G+896Mè¿™ä¸ªèŒƒå›´ã€‚ å‰©ä½™çš„128Mï¼Œæ˜¾ç„¶å‰©ä½™çš„3200Mçš„ZONE HIGHåŒºåŸŸæ˜¯æ— æ³•é€šè¿‡ç›´æ¥æ˜ å°„çš„æ–¹å¼è¿›è¡Œæ˜ å°„çš„ï¼Œå› æ­¤ç‰©ç†å†…å­˜ä¸­çš„ZONE_HIGHMEMåŒºåŸŸå°±åªèƒ½é‡‡ç”¨åŠ¨æ€æ˜ å°„çš„æ–¹å¼æ˜ å°„128Må¤§å°å†…æ ¸è™šæ‹Ÿå†…å­˜ç©ºé—´ã€‚ æ³¨æ„DMA_ZONEä¸æ˜¯è¯´åªç»™DMAç”¨ï¼ŒDMAè¦æ˜¯ä¸ç”¨è¿˜æ˜¯å¯ä»¥ç»§ç»­ç»™å…¶ä»–ç”¨ï¼Œåªè¦è®¾ç½®åˆ†é…å†…å­˜ä¸ºGFP_DMAã€‚ - ZONE_DMA(24): isaè®¾å¤‡çš„DMAæ“ä½œï¼Œå¯»å€èŒƒå›´0~16Mã€‚ - ZONE_DMA32: å¯¹äº64ä½ç³»ç»Ÿä¸­ï¼Œ16Mçš„ç©ºé—´ä¸å¤Ÿç”¨ï¼Œäºæ˜¯å®šä¹‰å¯ä»¥å¯»å€åˆ°4Gï¼Œæ»¡è¶³32ä½çš„DMAå¯»å€ã€‚ - ZONE_NORMAL: çº¿æ€§æ˜ å°„ç‰©ç†å†…å­˜ - ZONE_HIGHMEM:é«˜ç«¯å†…å­˜ï¼Œæ ‡è®°è¶…å‡ºå†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´çš„ç‰©ç†å†…å­˜æ®µã€‚64ä½æ¶æ„æ²¡æœ‰è¯¥ZONE - ZONE_MOVABLE:è™šæ‹Ÿå†…å­˜åŸŸï¼Œé˜²æ­¢å†…å­˜ç¢ç‰‡çš„æœºåˆ¶ä¸­ä¼šä½¿ç”¨åˆ°è¯¥å†…å­˜åŒºåŸŸã€‚ï¼ˆä»é€»è¾‘ä¸Šåˆ’åˆ†ï¼‰ ZONE_DEVICE:ä¸ºæ”¯æŒçƒ­æ’æ‹”è€Œåˆ†é…çš„éæ˜“å¤±æ€§å†…å­˜ã€‚ï¼ˆä»é€»è¾‘ä¸Šåˆ’åˆ†ï¼‰</p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">mmzone</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="k">enum</span><span class="w"> </span><span class="n">zone_type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="n">ZONE_DMA</span><span class="p">,</span>
<span class="n">ZONE_DMA32</span><span class="p">,</span>
<span class="n">ZONE_NORMAL</span><span class="p">,</span>
<span class="n">ZONE_HIGHMEM</span><span class="p">,</span>
<span class="n">ZONE_MOVABLE</span><span class="p">,</span>
<span class="n">ZONE_DEVICE</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="p">;</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="p">{</span>
<span class="p">...</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">pglist_data</span><span class="w">  </span><span class="o">*</span><span class="n">zone_pgdat</span><span class="p">;</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">  </span><span class="n">zone_start_pfn</span><span class="p">;</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">  </span><span class="n">spanned_pages</span><span class="p">;</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">   </span><span class="n">present_pages</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">free_area</span><span class="w">  </span><span class="n">free_area</span><span class="p">[</span><span class="n">MAX_ORDER</span><span class="p">];</span>
<span class="n">atomic_long_t</span><span class="w">   </span><span class="n">vm_stat</span><span class="p">[</span><span class="n">NR_VM_ZONE_STAT_ITEMS</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="page">page</h4>
<p>pageï¼ˆé¡µï¼‰æ˜¯linuxå†…æ ¸ç®¡ç†ç‰©ç†å†…å­˜çš„æœ€å°å•å…ƒï¼Œå†…æ ¸å°†æ•´ä¸ªç‰©ç†å†…å­˜æŒ‰ç…§é¡µå¯¹é½æ–¹å¼åˆ’åˆ†æˆæˆåƒä¸Šä¸‡ä¸ªé¡µè¿›è¡Œç®¡ç†ï¼Œå†…æ ¸ä¸ºäº†ç®¡ç†è¿™äº›é¡µå°†æ¯ä¸ªé¡µæŠ½è±¡æˆstruct pageç»“æ„ç®¡ç†æ¯ä¸ªé¡µçŠ¶æ€åŠå±æ€§ã€‚struct pageç»“æ„æœ¬èº«å°±å æœ‰ä¸€å®šå†…å­˜ï¼Œæ‰€ä»¥struct pageä¸èƒ½è¿‡å¤§ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_d6712698068a1faf1c43e2bbd75f27d7.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ä¸‰çº§ç»“æ„nodeã€zoneã€page/images/wp_editor_md_d6712698068a1faf1c43e2bbd75f27d7.jpg"/></a></p>
<p>PFNï¼ˆpage frame numberï¼‰ï¼šPFNä¸struct pageä¸€ä¸€å¯¹åº”ï¼Œå†…æ ¸æä¾›ä¸¤ä¸ªå®æ¥å®ŒæˆPFNä¸ç‰©ç†é¡µç»“æ„struct pageä¹‹é—´ç›¸äº’è½¬æ¢,åˆ†åˆ«æ˜¯page_to_pfnä¸pfn_to_pageã€‚ åœ¨Linuxå†…æ ¸ä¸­ï¼Œstruct pageæ•°æ®ç»“æ„é€šå¸¸ä¸å®é™…çš„ç‰©ç†å†…å­˜é¡µå¸§æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚Linuxå†…æ ¸ä½¿ç”¨ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥è·Ÿè¸ªæ‰€æœ‰å¯ç”¨å’Œä¸å¯ç”¨çš„ç‰©ç†é¡µé¢ã€‚ åœ¨åˆå§‹åŒ–æœŸé—´ï¼Œå†…æ ¸é€šè¿‡è°ƒç”¨\"memblock_init()\"ç­‰å‡½æ•°å°†ç³»ç»Ÿä¸­æ‰€æœ‰çš„ç‰©ç†å†…å­˜åŒºåŸŸåˆ’åˆ†ä¸ºç›¸åŒå¤§å°çš„é¡µé¢ï¼Œå¹¶ä¸ºæ¯ä¸ªé¡µé¢åˆ†é…ä¸€ä¸ªstruct pageæ•°æ®ç»“æ„ã€‚è¿™äº›é¡µé¢çš„struct pageç»“æ„ä½“è¢«ç»„ç»‡æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¹¶å­˜å‚¨åœ¨pgdat_listå…¨å±€å˜é‡ä¸­ã€‚ å½“éœ€è¦åˆ†é…ç‰©ç†é¡µé¢æ—¶ï¼Œå†…æ ¸ä¼šä»pgdat_listä¸­é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„èŠ‚ç‚¹ï¼Œå¹¶åœ¨è¯¥èŠ‚ç‚¹çš„ä¼™ä¼´ç³»ç»Ÿä¸ŠæŸ¥æ‰¾ä¸€ä¸ªå¯ç”¨çš„ç‰©ç†é¡µé¢ã€‚å¦‚æœæ‰¾åˆ°äº†ä¸€ä¸ªå¯ç”¨é¡µé¢ï¼Œåˆ™å°†è¯¥é¡µé¢çš„struct pageç»“æ„ä½“æ ‡è®°ä¸ºå·²å ç”¨ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥é¡µé¢çš„æŒ‡é’ˆã€‚åä¹‹ï¼Œåˆ™ä¼šå°è¯•ä»å…¶ä»–NUMAèŠ‚ç‚¹æˆ–è€…äº¤æ¢ç©ºé—´ä¸­è·å–å¯ç”¨é¡µé¢ã€‚ å› æ­¤ï¼Œæ— è®ºæ˜¯é€šè¿‡ä¼™ä¼´ç³»ç»Ÿè·å–ç‰©ç†é¡µé¢ï¼Œè¿˜æ˜¯ç›´æ¥è®¿é—®æŸä¸ªç‰©ç†åœ°å€ï¼Œéƒ½å¯ä»¥é€šè¿‡struct pageæ•°æ®ç»“æ„æ¥è·Ÿè¸ªå’Œç®¡ç†å®é™…çš„ç‰©ç†å†…å­˜é¡µé¢ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">mm_types</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="p">{</span>
<span class="mf">1.</span><span class="n">æ ‡å¿—ä½</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Atomic flags, some possibly</span>
<span class="cm">2.5ä¸ªå­—çš„è”åˆä½“ï¼ˆ32ä½20å­—èŠ‚ï¼Œ64ä½40å­—èŠ‚ï¼‰ï¼Œåˆ†åˆ«æœ‰8ä¸ªéƒ¨åˆ†ã€‚ç”¨äºåŒ¿åé¡µé¢ã€æ–‡ä»¶æ˜ å°„ã€slabåˆ†é…å™¨ç­‰æè¿°ã€‚</span>
<span class="cm">union {</span>
<span class="cm">    2.1 ç®¡ç†åŒ¿å/æ–‡ä»¶é¡µé¢  </span>
<span class="cm">        struct {    /* Page cache and anonymous pages */</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">lru</span><span class="p">;</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w"> </span><span class="o">*</span><span class="n">mapping</span><span class="p">;</span>
<span class="w">            </span><span class="n">pgoff_t</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Our offset within mapping. */</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">private</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="mf">2.2</span><span class="p">.</span><span class="n">ç®¡ç†ç½‘ç»œåè®®æ ˆ</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="cm">/* page_pool used by netstack */</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pp_magic</span><span class="p">;</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">page_pool</span><span class="w"> </span><span class="o">*</span><span class="n">pp</span><span class="p">;</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">_pp_mapping_pad</span><span class="p">;</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">dma_addr</span><span class="p">;</span>
<span class="w">            </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">dma_addr_upper</span><span class="p">;</span>
<span class="w">                </span><span class="n">atomic_long_t</span><span class="w"> </span><span class="n">pp_frag_count</span><span class="p">;</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="mf">2.3</span><span class="p">.</span><span class="w"> </span><span class="n">slabç›¸å…³æè¿°</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="cm">/* slab, slob and slub */</span>
<span class="w">            </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">slab_list</span><span class="p">;</span>
<span class="w">                </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="cm">/* Partial pages */</span>
<span class="w">                    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
<span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">pages</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Nr of pages left */</span>
<span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">pobjects</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Approximate count */</span>
<span class="cp">#else</span>
<span class="w">                    </span><span class="kt">short</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pages</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">short</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pobjects</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">                </span><span class="p">};</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">kmem_cache</span><span class="w"> </span><span class="o">*</span><span class="n">slab_cache</span><span class="p">;</span><span class="w"> </span><span class="cm">/* not slob */</span>
<span class="w">            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">freelist</span><span class="p">;</span><span class="w">     </span><span class="cm">/* first free object */</span>
<span class="w">            </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">s_mem</span><span class="p">;</span><span class="w">    </span><span class="cm">/* slab: first object */</span>
<span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">counters</span><span class="p">;</span><span class="w">     </span><span class="cm">/* SLUB */</span>
<span class="w">                </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">            </span><span class="cm">/* SLUB */</span>
<span class="w">                    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">inuse</span><span class="o">:</span><span class="mi">16</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">objects</span><span class="o">:</span><span class="mi">15</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">frozen</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="p">};</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="mf">2.4</span><span class="w"> </span><span class="n">ç”¨äºå¤åˆé¡µå°¾é¡µæè¿°</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="cm">/* Tail pages of compound page */</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">compound_head</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Bit zero is set */</span>

<span class="w">            </span><span class="cm">/* First tail page only */</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">compound_dtor</span><span class="p">;</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">compound_order</span><span class="p">;</span>
<span class="w">            </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">compound_mapcount</span><span class="p">;</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">compound_nr</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 1 &lt;&lt; compound_order */</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="mf">2.5</span><span class="w"> </span><span class="n">å¤åˆé¡µçš„ç¬¬äºŒä¸ªå°¾é¡µæè¿°</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="cm">/* Second tail page of compound page */</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">_compound_pad_1</span><span class="p">;</span><span class="w">  </span><span class="cm">/* compound_head */</span>
<span class="w">            </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">hpage_pinned_refcount</span><span class="p">;</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">deferred_list</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="mf">2.6</span><span class="w"> </span><span class="n">é¡µè¡¨é¡µé¢æè¿°</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="cm">/* Page table pages */</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">_pt_pad_1</span><span class="p">;</span><span class="w">    </span><span class="cm">/* compound_head */</span>
<span class="w">            </span><span class="n">pgtable_t</span><span class="w"> </span><span class="n">pmd_huge_pte</span><span class="p">;</span><span class="w"> </span><span class="cm">/* protected by page-&gt;ptl */</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">_pt_pad_2</span><span class="p">;</span><span class="w">    </span><span class="cm">/* mapping */</span>
<span class="w">            </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">pt_mm</span><span class="p">;</span><span class="w"> </span><span class="cm">/* x86 pgds only */</span>
<span class="w">                </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">pt_frag_refcount</span><span class="p">;</span><span class="w"> </span><span class="cm">/* powerpc */</span>
<span class="w">            </span><span class="p">};</span>
<span class="cp">#if ALLOC_SPLIT_PTLOCKS</span>
<span class="w">            </span><span class="n">spinlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">ptl</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">ptl</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">       </span><span class="mf">2.7</span><span class="w"> </span><span class="n">ZONE_DEVICEé¡µé¢æè¿°</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="cm">/* ZONE_DEVICE pages */</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_pagemap</span><span class="w"> </span><span class="o">*</span><span class="n">pgmap</span><span class="p">;</span>
<span class="w">            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">zone_device_data</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">      </span><span class="mf">2.8</span><span class="w"> </span><span class="n">rcuæè¿°</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w"> </span><span class="n">rcu_head</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="mf">3.4</span><span class="n">ä¸ªå­—èŠ‚çš„è”åˆä½“</span><span class="err">ï¼Œ</span><span class="n">ç”¨äºç®¡ç†_mapcountç­‰ä½¿ç”¨è®¡æ•°</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="cm">/* This union is 4 bytes in size. */</span>
<span class="w">        </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">_mapcount</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">page_type</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">active</span><span class="p">;</span><span class="w">        </span><span class="cm">/* SLAB */</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">units</span><span class="p">;</span><span class="w">          </span><span class="cm">/* SLOB */</span>
<span class="w">    </span><span class="p">};</span>
<span class="mf">4.</span><span class="n">ç”¨äºç®¡ç†å¼•ç”¨è®¡æ•°</span>
<span class="w">    </span><span class="cm">/* Usage count. *DO NOT USE DIRECTLY*. See page_ref.h */</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">_refcount</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">_struct_page_alignment</span><span class="p">;</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_f093117278494b3fa37354efe957a2a7.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ä¸‰çº§ç»“æ„nodeã€zoneã€page/images/wp_editor_md_f093117278494b3fa37354efe957a2a7.jpg"/></a></p>
<p>struct pageæ•°æ®ç»“æ„å¯ä»¥åˆ†ä¸º4ä¸ªéƒ¨åˆ†ï¼š - æ ‡å¿—ä½ï¼šé¡µé¢çš„æ ‡å¿—ä½ã€‚ - 5å­—è”åˆä½“ï¼šç”¨äºåŒ¿å/æ–‡ä»¶é¡µé¢æè¿°ï¼Œslabåˆ†é…å™¨æè¿°ç­‰8ä¸ªéƒ¨åˆ†ã€‚ - 4å­—èŠ‚è”åˆä½“ï¼šç”¨äºç®¡ç†é¡µé¢ä½¿ç”¨çš„æƒ…å†µã€‚ - 4å­—èŠ‚å¼•ç”¨ï¼šç”¨äºç®¡ç†é¡µé¢å¼•ç”¨æƒ…å†µã€‚</p>
<h5 id="_1">æ ‡å¿—ä½</h5>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">page</span><span class="o">-</span><span class="n">flags</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="k">enum</span><span class="w"> </span><span class="n">pageflags</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PG_locked</span><span class="p">,</span><span class="w">      </span><span class="cm">/* Page is locked. Don't touch. */</span>
<span class="w">    </span><span class="n">PG_referenced</span><span class="p">,</span>
<span class="w">    </span><span class="n">PG_uptodate</span><span class="p">,</span><span class="w">    </span><span class="n">è¡¨ç¤ºé¡µé¢çš„æ•°æ®å·²ç»ä»å—è®¾å¤‡æˆåŠŸè¯»å–</span>
<span class="w">    </span><span class="n">PG_dirty</span><span class="p">,</span><span class="w">        </span><span class="n">è¡¨ç¤ºé¡µé¢å†…å®¹å‘ç”Ÿæ”¹å˜</span><span class="err">ï¼Œ</span><span class="n">ä¸ºè„é¡µ</span><span class="err">ã€‚</span><span class="n">æ²¡æœ‰è·Ÿå¤–éƒ¨å­˜å‚¨å™¨åŒæ­¥</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">PG_lru</span><span class="p">,</span><span class="w">          </span><span class="n">é¡µé¢åœ¨LRUé“¾è¡¨ä¸­</span>
<span class="w">    </span><span class="n">PG_active</span><span class="p">,</span><span class="w">      </span>
<span class="w">    </span><span class="n">PG_workingset</span><span class="p">,</span>
<span class="w">    </span><span class="n">PG_waiters</span><span class="p">,</span><span class="w">     </span><span class="cm">/* Page has waiters, check its waitqueue. Must be bit #7 and in the same byte as "PG_locked" */</span>
<span class="w">    </span><span class="n">PG_error</span><span class="p">,</span>
<span class="w">    </span><span class="n">PG_slab</span><span class="p">,</span>
<span class="w">    </span><span class="n">PG_owner_priv_1</span><span class="p">,</span><span class="w">    </span><span class="cm">/* Owner use. If pagecache, fs may use*/</span>
<span class="w">    </span><span class="n">PG_arch_1</span><span class="p">,</span>
<span class="w">    </span><span class="n">PG_reserved</span><span class="p">,</span>
<span class="w">    </span><span class="n">PG_private</span><span class="p">,</span><span class="w">     </span><span class="cm">/* If pagecache, has fs-private data */</span>
<span class="w">    </span><span class="n">PG_private_2</span><span class="p">,</span><span class="w">       </span><span class="cm">/* If pagecache, has fs aux data */</span>
<span class="w">    </span><span class="n">PG_writeback</span><span class="p">,</span><span class="w">       </span><span class="cm">/* Page is under writeback */</span>
<span class="w">    </span><span class="n">PG_head</span><span class="p">,</span><span class="w">        </span><span class="cm">/* A head page */</span>
<span class="w">    </span><span class="n">PG_mappedtodisk</span><span class="p">,</span><span class="w">    </span><span class="cm">/* Has blocks allocated on-disk */</span>
<span class="w">    </span><span class="n">PG_reclaim</span><span class="p">,</span><span class="w">     </span><span class="cm">/* To be reclaimed asap */</span>
<span class="w">    </span><span class="n">PG_swapbacked</span><span class="p">,</span><span class="w">      </span><span class="cm">/* Page is backed by RAM/swap */</span>
<span class="w">    </span><span class="n">PG_unevictable</span><span class="p">,</span><span class="w">     </span><span class="cm">/* Page is "unevictable"  */</span>
<span class="cp">#ifdef CONFIG_MMU</span>
<span class="w">    </span><span class="n">PG_mlocked</span><span class="p">,</span><span class="w">     </span><span class="cm">/* Page is vma mlocked */</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ARCH_USES_PG_UNCACHED</span>
<span class="w">    </span><span class="n">PG_uncached</span><span class="p">,</span><span class="w">        </span><span class="cm">/* Page has been mapped as uncached */</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MEMORY_FAILURE</span>
<span class="w">    </span><span class="n">PG_hwpoison</span><span class="p">,</span><span class="w">        </span><span class="cm">/* hardware poisoned page. Don't touch */</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_PAGE_IDLE_FLAG) &amp;&amp; defined(CONFIG_64BIT)</span>
<span class="w">    </span><span class="n">PG_young</span><span class="p">,</span>
<span class="w">    </span><span class="n">PG_idle</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
<span class="w">    </span><span class="n">PG_arch_2</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_KASAN_HW_TAGS</span>
<span class="w">    </span><span class="n">PG_skip_kasan_poison</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
<span class="w">    </span><span class="n">PG_oem_reserved</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">__NR_PAGEFLAGS</span><span class="p">,</span>

<span class="w">    </span><span class="cm">/* Filesystems */</span>
<span class="w">    </span><span class="n">PG_checked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_owner_priv_1</span><span class="p">,</span>

<span class="w">    </span><span class="cm">/* SwapBacked */</span>
<span class="w">    </span><span class="n">PG_swapcache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_owner_priv_1</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Swap page: swp_entry_t in private */</span>

<span class="w">    </span><span class="cm">/* Two page bits are conscripted by FS-Cache to maintain local caching</span>
<span class="cm">     * state.  These bits are set on pages belonging to the netfs's inodes</span>
<span class="cm">     * when those inodes are being locally cached.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">PG_fscache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_private_2</span><span class="p">,</span><span class="w">  </span><span class="cm">/* page backed by cache */</span>

<span class="w">    </span><span class="cm">/* XEN */</span>
<span class="w">    </span><span class="cm">/* Pinned in Xen as a read-only pagetable page. */</span>
<span class="w">    </span><span class="n">PG_pinned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_owner_priv_1</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/* Pinned as part of domain save (see xen_mm_pin_all()). */</span>
<span class="w">    </span><span class="n">PG_savepinned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_dirty</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/* Has a grant mapping of another (foreign) domain's page. */</span>
<span class="w">    </span><span class="n">PG_foreign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_owner_priv_1</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/* Remapped by swiotlb-xen. */</span>
<span class="w">    </span><span class="n">PG_xen_remapped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_owner_priv_1</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/* SLOB */</span>
<span class="w">    </span><span class="n">PG_slob_free</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_private</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/* Compound pages. Stored in first tail page's flags */</span>
<span class="w">    </span><span class="n">PG_double_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_workingset</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_MEMORY_FAILURE</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Compound pages. Stored in first tail page's flags.</span>
<span class="cm">     * Indicates that at least one subpage is hwpoisoned in the</span>
<span class="cm">     * THP.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">PG_has_hwpoisoned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_mappedtodisk</span><span class="p">,</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="cm">/* non-lru isolated movable page */</span>
<span class="w">    </span><span class="n">PG_isolated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_reclaim</span><span class="p">,</span>

<span class="w">    </span><span class="cm">/* Only valid for buddy pages. Used to track pages that are reported */</span>
<span class="w">    </span><span class="n">PG_reported</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_uptodate</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p>æœ‰ç›¸å…³å‡½æ•°ç”¨äºæ“ä½œè¿™äº›æ ‡å¿—ï¼Œå¦‚ä¸‹ï¼š - Pagexxx()ï¼šç”¨äºæ£€æŸ¥é¡µé¢æ˜¯å¦è®¾ç½®äº†PG_xxxæ ‡å¿—ä½ï¼Œå¦‚PageDirtyæ£€æŸ¥æ˜¯å¦PG_dirtyè¢«ç½®ä½ã€‚ - SetPagexxx():è®¾ç½®é¡µé¢çš„PG_xxxæ ‡å¿—ä½ï¼Œå¦‚SetPageDirtyç”¨äºè®¾ç½®PG_dirtyæ ‡å¿—ä½ - ClearPagexxx():æ¸…æ¥šPG_xxxæ ‡å¿—ä½</p>
<h5 id="mapping">mapping</h5>
<p>åœ¨struct pageä¸­mappingæˆå‘˜è¡¨ç¤ºå½“å‰é¡µé¢çš„æ•°æ®æ¥æºï¼Œä¸»è¦åˆ†ä¸º3ç§æƒ…å†µï¼š - åŒ¿åé¡µé¢ï¼šmappingæŒ‡å‘VMAçš„anon_vmaæ•°æ®ç»“æ„ï¼Œæ•°æ®åŸå§‹æ¥æºäºç”¨æˆ·ç©ºé—´ã€‚ - æ–‡ä»¶é¡µé¢ï¼šmappingæŒ‡å‘æ–‡ä»¶æ‰€å±çš„address_spaceæ•°æ®ç»“æ„ï¼ŒåŒ…å«æ–‡ä»¶æ‰€å±çš„å­˜å‚¨ä»‹è´¨ä¿¡æ¯ï¼Œå¦‚inodeã€‚ - swapé¡µé¢ï¼ˆæ–‡ä»¶é¡µé¢ï¼‰ï¼šæŒ‡å‘äº¤æ¢åˆ†åŒºçš„swapper_spacesã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w">        </span><span class="o">*</span><span class="n">host</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">xarray</span><span class="w">       </span><span class="n">i_pages</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rw_semaphore</span><span class="w"> </span><span class="n">invalidate_lock</span><span class="p">;</span>
<span class="w">    </span><span class="n">gfp_t</span><span class="w">           </span><span class="n">gfp_mask</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">        </span><span class="n">i_mmap_writable</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_READ_ONLY_THP_FOR_FS</span>
<span class="w">    </span><span class="cm">/* number of thp, only for non-shmem files */</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">        </span><span class="n">nr_thps</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_root_cached</span><span class="w">   </span><span class="n">i_mmap</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rw_semaphore</span><span class="w"> </span><span class="n">i_mmap_rwsem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">nrpages</span><span class="p">;</span>
<span class="w">    </span><span class="n">pgoff_t</span><span class="w">         </span><span class="n">writeback_index</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">address_space_operations</span><span class="w"> </span><span class="o">*</span><span class="n">a_ops</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="n">errseq_t</span><span class="w">        </span><span class="n">wb_err</span><span class="p">;</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w">      </span><span class="n">private_lock</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">private_list</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w">            </span><span class="o">*</span><span class="n">private_data</span><span class="p">;</span>

<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))))</span><span class="w"> </span><span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></div>
<p>mappingæŒ‡å‘æ•°æ®çš„ä½2ä½å¯ä»¥ç”¨äºåˆ¤æ–­å½“å‰é¡µé¢çš„ç±»å‹ï¼š - bit[0]:ç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºåŒ¿åé¡µã€‚PageAnon()å‡½æ•° - bit[0]:ç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºéLRUé¡µé¢ã€‚_PageMovable()å‡½æ•° - Bit[0:1]:è‹¥éƒ½ä¸º11ï¼Œåˆ™è¡¨ç¤ºKSMé¡µé¢ã€‚PageKsm()å‡½æ•° page_mapping()è¿”å›pageæ•°æ®ç»“æ„ç§mappingæˆå‘˜æŒ‡å‘çš„åœ°å€ç©ºé—´ï¼Œå³address_spaceã€‚</p>
<h5 id="_refcount">_refcount</h5>
<p>è¡¨ç¤ºå†…æ ¸å¼•ç”¨é¡µé¢çš„æ¬¡æ•° - _refcount=0:é¡µé¢ä¸ºç©ºé—²é¡µé¢æˆ–å³å°†è¦è¢«é‡Šæ”¾çš„é¡µé¢ - _refcount&gt;0:é¡µé¢å·²ç»è¢«åˆ†é…ä¸”å†…æ ¸æ­£åœ¨ä½¿ç”¨ï¼Œæš‚æ—¶ä¸ä¼šè¢«é‡Šæ”¾ã€‚get_page()ä¼šè®©å…¶+1,put_page()è®©å…¶-1ã€‚ åœ¨ä½¿ç”¨alloc_pagesåˆ†é…é¡µé¢æ—¶ï¼Œ_refcountä¼šå˜æˆ1ã€‚å½“é¡µé¢åŠ å…¥LRUæ—¶ï¼Œé¡µé¢è¢«kswpadå†…æ ¸çº¿ç¨‹ä½¿ç”¨ä¼š+1ã€‚åœ¨é¡µé¢è¢«æ˜ å°„åˆ°å…¶ä»–ç”¨æˆ·è¿›ç¨‹çš„PTEæ—¶ï¼Œ_refcountä¼š+1ã€‚</p>
<h5 id="_mapcount">_mapcount</h5>
<p>è¡¨ç¤ºè¿™ä¸ªé¡µé¢è¢«è¿›ç¨‹æ˜ å°„çš„ä¸ªæ•°ï¼Œå³æ˜ å°„äº†å¤šå°‘ä¸ªç”¨æˆ·PTEã€‚page_mappedï¼ˆï¼‰å‡½æ•°ç”¨äºåˆ¤æ–­è¯¥é¡µé¢æ˜¯å¦æ˜ å°„åˆ°ç”¨æˆ·PTE - _mapcount=-1ï¼šæ²¡æœ‰PTEæ˜ å°„åˆ°é¡µé¢ - _mapcount=0ï¼šåªæœ‰ä¸€ä¸ªè¿›ç¨‹æ˜ å°„åˆ°é¡µé¢ - _mapcount&gt;0ï¼šæœ‰å¤šä¸ªè¿›ç¨‹æ˜ å°„åˆ°è¿™ä¸ªé¡µé¢</p>
<h2 id="_2">ä¸‰ç§å†…å­˜æ¨¡å‹</h2>
<p>ç‰©ç†å†…å­˜è¢«åˆ’åˆ†ä¸ºå¤šä¸ªç›¸åŒé•¿åº¦çš„é¡µï¼Œå¦‚ä½•ç»„ç»‡ç®¡ç†è¿™äº›é¡µçš„æ–¹å¼ç§°ä¸ºç‰©ç†å†…å­˜æ¨¡å‹ï¼Œä¸åŒçš„ç‰©ç†å†…å­˜æ¨¡å‹ï¼Œå¯¹åº”çš„page_to_pfnå’Œpfn_to_pageè®¡ç®—é€»è¾‘ä¸ä¸€æ ·ã€‚</p>
<h3 id="flat-memory-model">FLAT memory model</h3>
<p>æ‰€æœ‰çš„ç‰©ç†å†…å­˜æ˜¯è¿ç»­çš„ï¼Œä¸­é—´å†…å­˜æ²¡æœ‰ç©ºæ´ï¼Œåˆ’åˆ†å‡ºæ¥çš„ä¸€é¡µä¸€é¡µçš„ç‰©ç†é¡µå¿…ç„¶ä¹Ÿæ˜¯è¿ç»­çš„ï¼Œå¹¶ä¸”æ¯é¡µçš„å¤§å°æ˜¯å›ºå®šçš„ï¼ŒLinuxæ—©æœŸä½¿ç”¨çš„å°±æ˜¯è¿™ç§å†…å­˜æ¨¡å‹ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_1ebfe0cafce7b8f89266e5df543372b4.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ä¸‰çº§ç»“æ„nodeã€zoneã€page/images/wp_editor_md_1ebfe0cafce7b8f89266e5df543372b4.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="n">include</span><span class="o">/</span><span class="k">asm</span><span class="o">-</span><span class="n">generic</span><span class="o">/</span><span class="n">memory_model</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="cp">#if defined(CONFIG_FLATMEM)</span>

<span class="cp">#ifndef ARCH_PFN_OFFSET</span>
<span class="cp">#define ARCH_PFN_OFFSET     (0UL)</span>
<span class="cp">#endif</span>

<span class="cp">#define __pfn_to_page(pfn)  (mem_map + ((pfn) - ARCH_PFN_OFFSET))</span>
<span class="cp">#define __page_to_pfn(page) ((unsigned long)((page) - mem_map) + \\</span>
<span class="cp">                 ARCH_PFN_OFFSET)</span>
<span class="cp">#endif</span>
</code></pre></div>
<p>åœ¨å¹³å¦å†…å­˜æ¨¡å‹ä¸‹ï¼Œpage_to_pfnä¸pfn_to_pageè®¡ç®—é€»è¾‘åŸºäºmem_mapæ•°ç»„è¿›è¡Œåç§»æ“ä½œã€‚</p>
<h3 id="discontiguous-memory-model">Discontiguous memory model</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_8cf8ff134d2f47ac98a22ca7540814d0.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ä¸‰çº§ç»“æ„nodeã€zoneã€page/images/wp_editor_md_8cf8ff134d2f47ac98a22ca7540814d0.jpg"/></a> â€ƒâ€ƒå¹³å¦åº¦å†…å­˜æ¨¡å‹é€‚ç”¨äºä¸€æ•´å—è¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œè€Œå¯¹äºå¤šå—éè¿ç»­çš„ç‰©ç†å†…å­˜ä½¿ç”¨å¹³å¦åº¦å†…å­˜æ¨¡å‹ä¼šé€ æˆå¾ˆå¤§çš„ç©ºé—´æµªè´¹ï¼ˆå¹³å¦åº¦æ¨¡å‹ä½¿ç”¨æ•°ç»„mem_map[]æ¥è¿›è¡Œç®¡ç†ï¼Œè€Œæ•°ç»„æ˜¯è¿ç»­çš„ï¼Œä»0å¼€å§‹é€’å¢çš„ï¼Œè€Œç‰©ç†å†…å­˜æœ‰ç©ºæ´ï¼Œé‚£ä¹ˆä¸­é—´å°±ä¼šå‡ºç°mem_mapä¸€æ®µæŒ‡å‘ç©ºï¼Œä½†æ˜¯è¿˜å ç”¨äº†å†…å­˜ç©ºé—´ï¼‰ï¼Œæ‰€ä»¥ä¸ºäº†ç»„ç»‡å’Œç®¡ç†ä¸è¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œå†…æ ¸å¼•å…¥äº†DISCONTIGMEMéè¿ç»­å†…å­˜æ¨¡å‹ï¼Œç”¨æ¥æ¶ˆé™¤è¿™äº›ä¸è”ç³»çš„å†…å­˜åœ°å€ç©ºæ´å¯¹mem_mapçš„ç©ºé—´æµªè´¹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="n">include</span><span class="o">/</span><span class="k">asm</span><span class="o">-</span><span class="n">generic</span><span class="o">/</span><span class="n">memory_model</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="cp">#if defined(CONFIG_DISCONTIGMEM)</span>
<span class="cp">#define __pfn_to_page(pfn)          \\</span>
<span class="cp">({  unsigned long __pfn = (pfn);        \\</span>
<span class="cp">    unsigned long __nid = arch_pfn_to_nid(__pfn);  \\</span>
<span class="cp">    NODE_DATA(__nid)-&gt;node_mem_map + arch_local_page_offset(__pfn, __nid);\\</span>
<span class="cp">})</span>

<span class="cp">#define __page_to_pfn(pg)                       \\</span>
<span class="cp">({  const struct page *__pg = (pg);                 \\</span>
<span class="cp">    struct pglist_data *__pgdat = NODE_DATA(page_to_nid(__pg)); \\</span>
<span class="cp">    (unsigned long)(__pg - __pgdat-&gt;node_mem_map) +         \\</span>
<span class="cp">     __pgdat-&gt;node_start_pfn;                   \\</span>
<span class="cp">})</span>
<span class="cp">#endif</span>

<span class="mf">5.15</span><span class="n">å†…æ ¸ç‰ˆæœ¬å·²ç»æ²¡æœ‰éè¿ç»­æ€§å†…å­˜æ¨¡å‹çš„</span><span class="err">ï¼Œ</span><span class="n">ä½¿ç”¨äº†Sparse</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">modelæ›¿æ¢</span><span class="p">.</span>
</code></pre></div>
<p>é€šè¿‡arch_pfn_to_nidæ ¹æ®ç‰©ç†é¡µçš„PFNå®šä½åˆ°ç‰©ç†é¡µæ‰€åœ¨çš„nodeï¼Œå†æ ¹æ®nodeä¸­node_mem_mapç®—åç§»ã€‚ â€ƒâ€ƒé€šè¿‡page_to_nidæ ¹æ®struct pageå®šä¹‰pageæ‰€åœ¨çš„nodeã€‚</p>
<h3 id="sparse-memory-model">Sparse memory model</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_fdc496aba23c8bb7647a8eccb45c500f.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ä¸‰çº§ç»“æ„nodeã€zoneã€page/images/wp_editor_md_fdc496aba23c8bb7647a8eccb45c500f.jpg"/></a></p>
<p>éšç€å†…å­˜æŠ€æœ¯çš„å‘å±•ï¼Œå†…æ ¸å¯ä»¥æ”¯æŒç‰©ç†å†…å­˜çƒ­æ’æ‹”ï¼Œè¿™æ ·nodeèŠ‚ç‚¹ä¸­çš„ç‰©ç†å†…å­˜å¯èƒ½ä¹Ÿä¸æ˜¯è¿ç»­çš„ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå†…æ ¸åˆå¼•å…¥äº†ç¨€ç–å†…å­˜æ¨¡å‹ã€‚</p>
<p><a href="http://8.134.108.235/wp-content/uploads/2023/11/wp_editor_md_88d32e7b1f5ddb711d94581d3e5540d5.jpg"><img alt="" src="images/wp_editor_md_88d32e7b1f5ddb711d94581d3e5540d5.jpg"/></a></p>
<p>ç¨€ç–å†…å­˜æ¨¡å‹ä½¿ç”¨struct mem_sectionç»“æ„ä½“æ¥è¡¨ç¤ºï¼Œç”¨äºç®¡ç†è¿ç»­å†…å­˜å—å•å…ƒçš„è¢«ç§°ä¸ºsectionï¼Œé€šå¸¸æƒ…å†µä¸‹ç‰©ç†é¡µä¸º4Kï¼Œsectionå¤§å°ä¸º128Mï¼Œç‰©ç†é¡µ16Kï¼Œsectionå¤§å°ä¸º512Mã€‚è¿™äº›å°çš„è¿ç»­ç‰©ç†å†…å­˜é€šè¿‡æ•°ç»„çš„æ–¹å¼è¢«ç»„ç»‡ç®¡ç†ï¼Œæ¯ä¸ªstruct mem_sctionç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘sectionä¸­ç®¡ç†è¿ç»­å†…å­˜çš„pageæ•°ç»„ã€‚æ‰€æœ‰çš„mem_sectionè¢«å­˜æ”¾åœ¨ä¸€ä¸ªå…¨å±€æ•°ç»„ä¸­ï¼Œæ¯ä¸ªmem_sectionéƒ½å¯ä»¥åœ¨ç³»ç»Ÿè¿è¡Œæ—¶æ”¹å˜ç³»ç»Ÿè¿è¡Œoffline/onlineçŠ¶æ€ï¼Œä»¥æ”¯æŒçƒ­æ’æ‹”åŠŸèƒ½ã€‚ â€ƒâ€ƒä¸ºäº†å‡å°‘ç®¡ç†å†…å­˜å ç”¨çš„æ•°æ®ç»“æ„ç©ºé—´ï¼Œç¨€ç–å†…å­˜æ¨¡å‹çš„æ€æƒ³ä¸å¤šçº§é¡µè¡¨çš„æ€æƒ³ç±»ä¼¼ï¼Œä¸€çº§é¡µè¡¨æ˜¯å¿…é¡»è¦åˆ†é…å†…å­˜çš„ï¼Œä½†æ˜¯åé¢çš„å‡ çº§è¿›è¡ŒæŒ‰éœ€åˆ†é…ï¼Œè¿™é‡Œä¹Ÿç±»ä¼¼ï¼Œå…ˆå®šä¹‰ä¸€ä¸ªé™æ€çš„æ•°ç»„æŒ‡é’ˆï¼Œæ¯ä¸ªæ•°ç»„æŒ‡é’ˆç®¡ç†ä¸€å¤§å—å†…å­˜ï¼ˆ4Kç‰©ç†é¡µï¼Œå°±æ˜¯128Mï¼‰ï¼Œæ•°ç»„æŒ‡å‘çš„å®ä¾‹æ ¹æ®å®é™…è¿›è¡ŒåŠ¨æ€åˆ†é…ç©ºé—´ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="n">include</span><span class="o">/</span><span class="k">asm</span><span class="o">-</span><span class="n">generic</span><span class="o">/</span><span class="n">memory_model</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">mem_section</span><span class="w"> </span><span class="n">mem_section</span><span class="p">[</span><span class="n">NR_SECTION_ROOTS</span><span class="p">][</span><span class="n">SECTIONS_PER_ROOT</span><span class="p">]</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="n">include</span><span class="o">/</span><span class="k">asm</span><span class="o">-</span><span class="n">generic</span><span class="o">/</span><span class="n">memory_model</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="cp">#if defined(CONFIG_SPARSEMEM)</span>
<span class="cm">/*</span>
<span class="cm"> * Note: section's mem_map is encoded to reflect its start_pfn.</span>
<span class="cm"> * section[i].section_mem_map == mem_map's address - start_pfn;</span>
<span class="cm"> */</span>
<span class="cp">#define __page_to_pfn(pg)                   \\</span>
<span class="cp">({  const struct page *__pg = (pg);             \\</span>
<span class="cp">    int __sec = page_to_section(__pg);          \\</span>
<span class="cp">    (unsigned long)(__pg - __section_mem_map_addr(__nr_to_section(__sec))); \\</span>
<span class="cp">})</span>

<span class="cp">#define __pfn_to_page(pfn)              \\</span>
<span class="cp">({  unsigned long __pfn = (pfn);            \\</span>
<span class="cp">    struct mem_section *__sec = __pfn_to_section(__pfn);    \\</span>
<span class="cp">    __section_mem_map_addr(__sec) + __pfn;      \\</span>
<span class="cp">})</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FLATMEM/DISCONTIGMEM/SPARSEMEM */</span>
</code></pre></div>
<h2 id="_3">å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†å¸ƒ</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_fb6718bc276e68f64c77bea7b2344085.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ä¸‰çº§ç»“æ„nodeã€zoneã€page/images/wp_editor_md_fb6718bc276e68f64c77bea7b2344085.jpg"/></a></p>
<p>ä¸Šå›¾è¡¨ç¤ºçš„æ˜¯æ•´ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œè™šæ‹Ÿåœ°å€ä½¿ç”¨äº†48bitæ¥å¯»å€ï¼Œå› æ­¤å¯»å€èŒƒå›´ä¸º2^48=256TBã€‚åœ¨å®é™…åº”ç”¨è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡å†…æ ¸çš„é…ç½®é€‰é¡¹æ¥ç¡®å®šè™šæ‹Ÿåœ°å€çš„ä½å®½ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_f00e16d03228cad703e5e78f9390c9d5.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ä¸‰çº§ç»“æ„nodeã€zoneã€page/images/wp_editor_md_f00e16d03228cad703e5e78f9390c9d5.jpg"/></a></p>
<p>PABITSæŒ‡çš„æ˜¯ç‰©ç†åœ°å€çš„å¯»å€èŒƒå›´ï¼Œä¸€èˆ¬ç‰©ç†åœ°å€çš„å¯»å€èŒƒå›´ç”±ç¡¬ä»¶å†³å®šï¼Œå†…æ ¸åªéœ€è¦é…ç½®æˆä¸ç¡¬ä»¶ä¸€æ ·å³å¯ï¼Œé€šå¸¸ARM64ä½çš„PABITS=48ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="å†…å­˜åˆå§‹åŒ–ä¹‹é¡µè¡¨åŸºæœ¬æ“ä½œ.html">â† å†…å­˜åˆå§‹åŒ–ä¹‹é¡µè¡¨åŸºæœ¬æ“ä½œ</a>
    <a class="next" href="æ–‡ä»¶ç³»ç»Ÿç¼“å­˜.html">æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

