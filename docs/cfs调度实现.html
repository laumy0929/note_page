<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CFSè°ƒåº¦å®ç° - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">æ—¶é—´è®¡ç®—</a><ul><li><a href="#vruntimeruntime">vruntimeä¸runtime</a></li><li><a href="#ideal_runtime">ideal_runtime</a></li></ul></li><li><a href="#_2">ä»»åŠ¡åˆ›å»º</a><ul></ul></li><li><a href="#_3">ä»»åŠ¡å‡ºå…¥åˆ—</a><ul><li><a href="#_4">å…¥å°±ç»ªé˜Ÿåˆ—</a></li><li><a href="#_5">å‡ºå°±ç»ªé˜Ÿåˆ—</a></li></ul></li><li><a href="#_6">ä»»åŠ¡é€‰æ‹©</a><ul><li><a href="#cfscfs">å¼€å¯CFSç»„è°ƒåº¦ä¸”è¢«æŠ¢å çš„ä»»åŠ¡æ˜¯CFSç±»</a></li><li><a href="#cfscfs_1">æœªå¼€å¯CFSç»„è°ƒåº¦æˆ–è¢«æŠ¢å çš„ä»»åŠ¡ä¸æ˜¯CFSè°ƒåº¦ç±»</a></li><li><a href="#_7">æ²¡æœ‰è¦è¿è¡Œçš„ä»»åŠ¡</a></li><li><a href="#_8">å°ç»“</a></li></ul></li><li><a href="#_9">ä»»åŠ¡åˆ‡æ¢</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>CFSè°ƒåº¦å®ç°</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-04-02
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">æ—¶é—´è®¡ç®—</h2>
<h3 id="vruntimeruntime">vruntimeä¸runtime</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">update_curr</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rq_clock_task</span><span class="p">(</span><span class="n">rq_of</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">));</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">delta_exec</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">curr</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//å®é™…è¿è¡Œæ—¶é—´ = å½“å‰æ—¶åˆ» å‡å»ä¸Šæ¬¡æ‰§è¡Œæ—¶åˆ»</span>
<span class="w">    </span><span class="n">delta_exec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">exec_start</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">s64</span><span class="p">)</span><span class="n">delta_exec</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//é‡æ–°æ›´æ–°å¼€å§‹æ‰§è¡Œæ—¶åˆ»</span>
<span class="w">    </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">exec_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>

<span class="w">    </span><span class="n">schedstat_set</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">exec_max</span><span class="p">,</span>
<span class="w">              </span><span class="n">max</span><span class="p">(</span><span class="n">delta_exec</span><span class="p">,</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">exec_max</span><span class="p">));</span>

<span class="w">    </span><span class="c1">//ç´¯è®¡è¿›ç¨‹å®é™…è¿è¡Œçš„æ—¶é—´</span>
<span class="w">    </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">sum_exec_runtime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">delta_exec</span><span class="p">;</span>
<span class="n">schedstat_add</span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">exec_clock</span><span class="p">,</span><span class="w"> </span><span class="n">delta_exec</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//ç´¯è®¡è®¡ç®—è¿›ç¨‹çš„è™šæ‹Ÿæ—¶é—´ï¼Œå…¬å¼vruntime = delta_exec*ï¼ˆnice_0_weight/weightï¼‰</span>
<span class="n">curr</span><span class="o">-&gt;</span><span class="n">vruntime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">calc_delta_fair</span><span class="p">(</span><span class="n">delta_exec</span><span class="p">,</span><span class="w"> </span><span class="n">curr</span><span class="p">);</span>

<span class="c1">//æ›´æ–°min_vruntime</span>
<span class="w">    </span><span class="n">update_min_vruntime</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">entity_is_task</span><span class="p">(</span><span class="n">curr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">curtask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task_of</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>

<span class="w">        </span><span class="n">trace_sched_stat_runtime</span><span class="p">(</span><span class="n">curtask</span><span class="p">,</span><span class="w"> </span><span class="n">delta_exec</span><span class="p">,</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">vruntime</span><span class="p">);</span>
<span class="w">        </span><span class="n">cgroup_account_cputime</span><span class="p">(</span><span class="n">curtask</span><span class="p">,</span><span class="w"> </span><span class="n">delta_exec</span><span class="p">);</span>
<span class="w">        </span><span class="n">account_group_exec_runtime</span><span class="p">(</span><span class="n">curtask</span><span class="p">,</span><span class="w"> </span><span class="n">delta_exec</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">account_cfs_rq_runtime</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">delta_exec</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>schduer_tickæœ€ç»ˆä¼šupdate_curræ¥ä¸ªæ›´æ–°å½“å‰è¿›ç¨‹çš„ç›¸å…³æ—¶é—´ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿›ç¨‹å®é™…è¿è¡Œçš„æ—¶é—´runtimeï¼Œè™šæ‹Ÿæ—¶é—´vruntimeä¸€çº§min_vruntimeã€‚</p>
<h3 id="ideal_runtime">ideal_runtime</h3>
<p>åœ¨Linuxç³»ç»Ÿä¸­ï¼Œä¸ºäº†ä¿è¯æ¯ä¸ªè¿›ç¨‹åœ¨ä¸€æ®µæ—¶é—´å†…è‡³å°‘èƒ½å¤Ÿè¿è¡Œçš„æœºä¼šï¼Œç³»ç»Ÿä½¿ç”¨sched_periodæ¥è¡¨ç¤ºç³»ç»Ÿå‘¨æœŸï¼Œä¹Ÿå°±æ˜¯å°†æ—¶é—´åˆ’åˆ†æˆnä¸ªsched_periodï¼Œé€šå¸¸å€¼æ—¶6msï¼Œç”¨æˆ·å¯ä»¥è¿›è¡Œä¿®æ”¹ã€‚è€Œåœ¨è¿™ä¸ªperiodå‘¨æœŸå†…ï¼Œæ ¹æ®å„è¿›ç¨‹çš„æƒé‡æ¥è¿›è¡Œç“œåˆ†ã€‚ â€ƒâ€ƒIdea_runtimeè¡¨ç¤ºæ¯ä¸ªè¿›ç¨‹åœ¨è¿™ä¸ªperiodå‘¨æœŸå†…ï¼Œå¯ä»¥è°ƒåº¦çš„æ‰§è¡Œçš„æœ€é•¿æ—¶é—´ï¼Œä½†å¹¶ä¸æ˜¯ç´¯è®¡å€¼ï¼Œæ¯”å¦‚åœ¨period=15msï¼Œè¿›ç¨‹Açš„ideal_runtime=6msï¼Œå½“è¿›ç¨‹Aè¿è¡Œäº†4msç”±äºç­‰å¾…æŸä¸ªèµ„æºè®©å‡ºäº†è°ƒåº¦ï¼Œåç»­è·å¾—èµ„æºç»§ç»­è¿è¡Œå¹¶ä¸æ˜¯è¯´è¿›ç¨‹Aåªèƒ½å†è¿è¡Œ2msäº†ï¼Œè€Œæ˜¯è¿è¡Œä¸è¶…è¿‡6mså°±è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ideal_runtimeé™åˆ¶çš„æ˜¯æ¯æ¬¡è¿è¡Œä¸è¶…è¿‡çš„æ—¶é—´ï¼Œå¹¶ä¸ç®—ç´¯è®¡å€¼ã€‚ â€ƒâ€ƒåœ¨è®¡ç®—ideal_runtimeçš„æ—¶å€™ï¼Œéœ€è¦è€ƒè™‘å½“å‰è¿›ç¨‹æ˜¯å¦å¤„äºä»»åŠ¡ç»„å†…ï¼Œå¤„äºä»»åŠ¡ç»„å†…çš„è¿›ç¨‹ideal_runtimeç›¸å½“äºæ˜¯åœ¨ç»„å†…è¿›è¡ŒæŒ‰æƒé‡åˆ’åˆ†ã€‚åœ¨å¼•å…¥ä»»åŠ¡ç»„åï¼Œè¿›ç¨‹çš„ç»„ç»‡æ–¹å¼å¯ä»¥æŒ‰ç…§å±‚æ¬¡æ¥åˆ’åˆ†ï¼Œè°ƒåº¦å®ä½“åˆ†ä¸ºä»»åŠ¡è°ƒåº¦å®ä½“å’Œç»„è°ƒåº¦å®ä½“ï¼Œå½“ç„¶éƒ½æ˜¯ä½¿ç”¨struct sched_entityæ¥æè¿°ã€‚æŒ‰ç…§å±‚æ¬¡æ¥åˆ’åˆ†åï¼Œæ— è®ºè°ƒåº¦å®ä½“å¤„ç†å“ªä¸€ä¸ªå±‚æ¬¡ï¼Œå…¶è°ƒåº¦å®ä½“ideal_runtimeçš„æ—¶é—´åœ¨å…¶å¹³è¡Œå±‚æ¬¡çš„æ ‘ä¸­æŒ‰æ¯”ä¾‹æ¥è®¡ç®—è·å–ï¼Œå¯ä»¥ç®€è®¡ä¸º â€ƒâ€ƒA.ideal_runtime = A.weight / cfs_rqX.loadï¼Œå…¶ä¸­cfs_rqX.loadä¸ºè°ƒåº¦å®ä½“æ‰€å¤„å±‚çº§æ‰€æœ‰è¿›ç¨‹æƒé‡ä¹‹å’Œã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_8394a28d228bf21f49758af95b477365.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/6-cfsè°ƒåº¦å®ç°/images/wp_editor_md_8394a28d228bf21f49758af95b477365.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="n">tse</span><span class="p">.</span><span class="n">ideal_runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tse</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cfs_rq</span><span class="p">.</span><span class="n">load</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tse</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">tse</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gse</span><span class="p">.</span><span class="n">weight</span><span class="p">)</span><span class="err">ã€‚</span>

<span class="n">tse3</span><span class="p">.</span><span class="n">ideal_runtime</span><span class="o">=</span><span class="w"> </span><span class="n">gse2</span><span class="p">.</span><span class="n">ideal_runtime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tse3</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cfs_rq2</span><span class="p">.</span><span class="n">load</span>
<span class="n">gse2</span><span class="p">.</span><span class="n">ideal_runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gse</span><span class="p">.</span><span class="n">ideal_runtime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gse2</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cfs_rq1</span><span class="p">.</span><span class="n">load</span>
<span class="n">gse</span><span class="p">.</span><span class="n">ideal_runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">period</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gse</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cfs_rq0</span><span class="p">.</span><span class="n">load</span>

<span class="n">tse3</span><span class="p">.</span><span class="n">ideal_runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">period</span><span class="w"> </span><span class="o">*</span>
<span class="n">gse</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cfs_rq0</span><span class="p">.</span><span class="n">load</span><span class="w"> </span><span class="o">*</span>
<span class="n">gse2</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cfs_rq1</span><span class="p">.</span><span class="n">load</span><span class="w"> </span><span class="o">*</span>
<span class="w"> </span><span class="n">tse3</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cfs_rq2</span><span class="p">.</span><span class="n">load</span>
</code></pre></div>
<p>ç”±ä¸Šå…¬å¼ï¼Œperiodè¡¨ç¤ºå½“å‰çš„è¿è¡Œå‘¨æœŸçš„æ€»æ—¶é—´ï¼Œæ ¹æ®ä»¥ä¸Šå…¬å¼ï¼Œå› ä¸ºéƒ½æ˜¯ç›¸ä¹˜ï¼ˆA_B_Cä¸C_B_Aä¸€æ ·ï¼‰ï¼Œæ‰€ä»¥è®¡ç®—è°ƒåº¦å®ä½“çš„ideal_runtimeå¯ä»¥ä»ä¸‹å¾€ä¸Šè¿›è®¡ç®—ã€‚ â€ƒâ€ƒå¯¹äºtse3å¤„äºæœ€åº•å±‚çº§L2ï¼Œæ‰€ä»¥å…¶æƒé‡å…ˆè®¡ç®—period * tse3.weight / cfs_rq2.loadå¾—åˆ°Cï¼Œç„¶åè®¡ç®—C_gse2.weight / cfs_rq1.loadå¾—åˆ°Bï¼Œæœ€åå†è®¡ç®—B_gse.weight / cfs_rq0.loadå¾—åˆ°æœ€ç»ˆtse3çš„ideal_runtimeã€‚ â€ƒâ€ƒå¯¹äºtseå¤„äºæœ€é«˜å±‚çº§L0ï¼Œä¹Ÿå¯ä»¥ä»ä¸‹å¾€ä¸Šè®¡ç®—ï¼Œåªä¸è¿‡ä¸Šé¢æ²¡æœ‰äº†ï¼Œå› æ­¤å°±åªéå†ä¸€æ¬¡å¾—åˆ°ç»“æœideal_runtime = gse.weight / cfs_rq0.loadã€‚ â€ƒâ€ƒåœ¨è½¯ä»¶ä¸Šçš„å®ç°ä¹Ÿå°±å˜å¾—ç®€å•å¾ˆå¤šäº†ï¼Œè°ƒåº¦å®ä½“seä¸­æœ‰ä¸€ä¸ªæˆå‘˜parentæŒ‡å‘å…¶çˆ¶å®ä½“ï¼Œå¦‚æœparentä¸ºç©ºè¡¨ç¤ºæ²¡æœ‰çˆ¶å®ä½“ï¼Œä¹Ÿå°±å¤„äºæœ€é«˜å±‚çº§ï¼Œä¸å­˜åœ¨ä»»åŠ¡ç»„å†…ï¼Œå› æ­¤åœ¨ä»£ç ä¸­åªè¦æ ¹æ®seä»ä¸‹å¾€ä¸Šéå†å³å¯ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="nf">sched_slice</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">se</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">nr_running</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">slice</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sched_feat</span><span class="p">(</span><span class="n">ALT_PERIOD</span><span class="p">))</span>
<span class="w">        </span><span class="n">nr_running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rq_of</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cfs</span><span class="p">.</span><span class="n">h_nr_running</span><span class="p">;</span><span class="w">  </span><span class="n">å½“å‰å±‚çº§tseä¸gseä¸ªæ•°ä¹‹å’Œ</span>

<span class="w">    </span><span class="n">slice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__sched_period</span><span class="p">(</span><span class="n">nr_running</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">!</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">on_rq</span><span class="p">);</span><span class="w">    </span><span class="n">ä¸€ä¸ªå‘¨æœŸçš„è¿è¡Œæ—¶é—´period</span>

<span class="w">    </span><span class="n">for_each_sched_entity</span><span class="p">(</span><span class="n">se</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">load_weight</span><span class="w"> </span><span class="o">*</span><span class="n">load</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">load_weight</span><span class="w"> </span><span class="n">lw</span><span class="p">;</span>

<span class="w">        </span><span class="n">cfs_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq_of</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<span class="w">        </span><span class="n">load</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">on_rq</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">lw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>

<span class="w">            </span><span class="n">update_load_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lw</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="p">);</span>
<span class="w">            </span><span class="n">load</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lw</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//slice=slice * (se-&gt;load.weight / se-&gt;cfs_rq-&gt;load.weight)</span>
<span class="w">        </span><span class="c1">//æ ¹æ®æƒé‡æ¯”ä¾‹é€çº§å¾€ä¸Šè®¡ç®—åˆ†é…åˆ°çš„ç‰©ç†æ—¶é—´ã€‚å¦‚æœä¸æ˜¯å±äºç»„ä»»åŠ¡ï¼Œåˆ™åªæœ‰ä¸€çº§ã€‚</span>
<span class="w">        </span><span class="n">slice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__calc_delta</span><span class="p">(</span><span class="n">slice</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="p">,</span><span class="w"> </span><span class="n">load</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sched_feat</span><span class="p">(</span><span class="n">BASE_SLICE</span><span class="p">))</span>
<span class="w">        </span><span class="n">slice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">slice</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">sysctl_sched_min_granularity</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">slice</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>åœ¨è®¾ç½®æŠ¢å è°ƒåº¦æ ‡å¿—ç« èŠ‚ç³»ç»Ÿä¼šè°ƒç”¨scheduler_tickå‘¨æœŸæ€§çš„æ£€æµ‹ä»»åŠ¡æ˜¯å¦è¶…è¿‡è¿è¡Œæ—¶é—´ï¼Œå¦‚æœè¶…è¿‡äº†å°±ä¼šè®¾ç½®æŠ¢å æ ‡å¿—ä½ï¼Œè®©å‡ºè°ƒåº¦æƒã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">check_preempt_tick</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">curr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ideal_runtime</span><span class="p">,</span><span class="w"> </span><span class="n">delta_exec</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">se</span><span class="p">;</span>
<span class="w">    </span><span class="n">s64</span><span class="w"> </span><span class="n">delta</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">skip_preempt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="n">ideal_runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_slice</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">curr</span><span class="p">);</span><span class="w"> </span><span class="n">è®¡ç®—å½“å‰è¿›ç¨‹ä¸€ä¸ªå‘¨æœŸå†…å¯ä»¥è¿è¡Œçš„æ—¶é—´</span><span class="err">ã€‚</span>
<span class="n">delta_exec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">sum_exec_runtime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">prev_sum_exec_runtime</span><span class="p">;</span><span class="w"> </span><span class="n">å®é™…è¿è¡Œæ—¶é—´</span><span class="err">ã€‚</span>
<span class="n">å¦‚æœè¿è¡Œæ—¶é—´è¶…è¿‡äº†ä¸€ä¸ªå‘¨æœŸå†…å¯è°ƒåº¦çš„æ—¶é—´</span><span class="err">ï¼Œ</span><span class="n">åˆ™è®¾ç½®å¯æŠ¢å æ ‡å¿—</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">delta_exec</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ideal_runtime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">resched_curr</span><span class="p">(</span><span class="n">rq_of</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">));</span>
<span class="w">        </span><span class="n">clear_buddies</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">curr</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_2">ä»»åŠ¡åˆ›å»º</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_f9b19f68e9ad6ee401fc6020695eb40d.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/6-cfsè°ƒåº¦å®ç°/images/wp_editor_md_f9b19f68e9ad6ee401fc6020695eb40d.jpg"/></a></p>
<h2 id="_3">ä»»åŠ¡å‡ºå…¥åˆ—</h2>
<h3 id="_4">å…¥å°±ç»ªé˜Ÿåˆ—</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_08781ac4424e92548592fb3d9d53a96b.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/6-cfsè°ƒåº¦å®ç°/images/wp_editor_md_08781ac4424e92548592fb3d9d53a96b.jpg"/></a></p>
<h3 id="_5">å‡ºå°±ç»ªé˜Ÿåˆ—</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_185c9d02c704f8b3d1572c005e7ebfb8.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/6-cfsè°ƒåº¦å®ç°/images/wp_editor_md_185c9d02c704f8b3d1572c005e7ebfb8.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">dequeue_task_fair</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rq</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">task_sleep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DEQUEUE_SLEEP</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idle_h_nr_running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task_has_idle_policy</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">was_sched_idle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_idle_rq</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

<span class="w">    </span><span class="n">util_est_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cfs</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//è¿­ä»£éå†æ¯ä¸ªè°ƒåº¦å®ä½“ï¼Œå…¶ä¸­seæ˜¯å½“å‰è¿­ä»£çš„è°ƒåº¦å®ä½“</span>
<span class="w">    </span><span class="n">for_each_sched_entity</span><span class="p">(</span><span class="n">se</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cfs_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq_of</span><span class="p">(</span><span class="n">se</span><span class="p">);</span><span class="w"> </span><span class="c1">//è·å–seæ‰€å±çš„CFSå®æ—¶é˜Ÿåˆ—cfs_rq</span>
<span class="w">        </span><span class="n">dequeue_entity</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">//ä»CFSé˜Ÿåˆ—ä¸­å–å‡ºå½“å‰çš„è°ƒåº¦å®ä½“ã€‚</span>

<span class="w">        </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">h_nr_running</span><span class="o">--</span><span class="p">;</span><span class="w"> </span><span class="c1">//å‡å°‘å®æ—¶é˜Ÿåˆ—æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æ•°é‡</span>
<span class="w">        </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">idle_h_nr_running</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">idle_h_nr_running</span><span class="p">;</span><span class="w"> </span><span class="c1">//å‡å°‘ç©ºé—²ç©ºé—²çŠ¶æ€ä¸‹çš„ä»»åŠ¡æ•°é‡</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cfs_rq_is_idle</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">))</span><span class="w"> </span><span class="c1">//å¦‚æœå®æ—¶é˜Ÿåˆ—å˜ä¸ºç©ºé—²çŠ¶æ€</span>
<span class="w">            </span><span class="n">idle_h_nr_running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* end evaluation on encountering a throttled cfs_rq */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cfs_rq_throttled</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">))</span><span class="w"> </span><span class="c1">//å¦‚æœå®æ—¶é˜Ÿåˆ—è¢«é™åˆ¶ï¼Œåˆ™ç›´æ¥ç»“æŸå¤„ç†ã€‚</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">dequeue_throttle</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//å¦‚æœå®æ—¶é˜Ÿåˆ—çš„è´Ÿè½½æƒé‡å¤§äº0ï¼Œåˆ™è¯´æ˜å®æ—¶é˜Ÿåˆ—è¿˜æœ‰å…¶ä»–è°ƒåº¦å®ä½“ï¼Œå°†è°ƒåº¦å®ä½“</span>
<span class="w">        </span><span class="c1">//æ›´æ–°ä¸ºå…¶çˆ¶è°ƒåº¦å®ä½“ï¼Œå¹¶è®¾ç½®æ¥ä¸‹æ¥ä»»åŠ¡é€‰æ‹©åå‘äºä»å½“å‰å®æ—¶é˜Ÿåˆ—ä¸­é€‰æ‹©ä»»åŠ¡ã€‚    </span>
<span class="w">        </span><span class="cm">/* Don't dequeue parent if it has other entities besides us */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/* Avoid re-evaluating load for this entity: */</span>
<span class="w">            </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent_entity</span><span class="p">(</span><span class="n">se</span><span class="p">);</span><span class="w"> </span><span class="c1">//è·å–çˆ¶è°ƒåº¦å®ä½“</span>
<span class="w">            </span><span class="cm">/*</span>
<span class="cm">             * Bias pick_next to pick a task from this cfs_rq, as</span>
<span class="cm">             * p is sleeping when it is within its sched_slice.</span>
<span class="cm">             */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">task_sleep</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">throttled_hierarchy</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">))</span>
<span class="w">                </span><span class="n">set_next_buddy</span><span class="p">(</span><span class="n">se</span><span class="p">);</span><span class="w"> </span><span class="c1">//è®¾ç½®ä¸‹ä¸€ä¸ªè°ƒåº¦å®ä½“</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">DEQUEUE_SLEEP</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">trace_android_rvh_dequeue_task_fair</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="n">for_each_sched_entity</span><span class="p">(</span><span class="n">se</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cfs_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq_of</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<span class="w">       </span><span class="c1">//æ›´æ–°CFSå®æ—¶é˜Ÿåˆ—çš„è´Ÿè½½å¹³å‡å€¼</span>
<span class="w">        </span><span class="n">update_load_avg</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">UPDATE_TG</span><span class="p">);</span>
<span class="w">        </span><span class="n">se_update_runnable</span><span class="p">(</span><span class="n">se</span><span class="p">);</span><span class="c1">//æ›´æ–°è°ƒåº¦å®ä½“çš„å¯è¿è¡ŒçŠ¶æ€</span>
<span class="w">        </span><span class="n">update_cfs_group</span><span class="p">(</span><span class="n">se</span><span class="p">);</span><span class="c1">//æ›´æ–°CFSè°ƒåº¦ç»„çš„ä¿¡æ¯</span>

<span class="w">        </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">h_nr_running</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">idle_h_nr_running</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">idle_h_nr_running</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cfs_rq_is_idle</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">))</span>
<span class="w">            </span><span class="n">idle_h_nr_running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* end evaluation on encountering a throttled cfs_rq */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cfs_rq_throttled</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">))</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">dequeue_throttle</span><span class="p">;</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* At this point se is NULL and we are at root level*/</span>
<span class="w">    </span><span class="n">sub_nr_running</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* balance early to pull high priority tasks */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">was_sched_idle</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sched_idle_rq</span><span class="p">(</span><span class="n">rq</span><span class="p">)))</span>
<span class="w">        </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">next_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jiffies</span><span class="p">;</span>

<span class="nl">dequeue_throttle</span><span class="p">:</span>
<span class="w">    </span><span class="n">util_est_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cfs</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">task_sleep</span><span class="p">);</span>
<span class="w">    </span><span class="n">hrtick_update</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_6">ä»»åŠ¡é€‰æ‹©</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_d14865d21a77bad52444f698de0083c5.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/6-cfsè°ƒåº¦å®ç°/images/wp_editor_md_d14865d21a77bad52444f698de0083c5.jpg"/></a></p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_a63fdfec9aa4c67d50a7cf196edcfed9.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/6-cfsè°ƒåº¦å®ç°/images/wp_editor_md_a63fdfec9aa4c67d50a7cf196edcfed9.jpg"/></a></p>
<h3 id="cfscfs">å¼€å¯CFSç»„è°ƒåº¦ä¸”è¢«æŠ¢å çš„ä»»åŠ¡æ˜¯CFSç±»</h3>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span>
<span class="n">pick_next_task_fair</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rq</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">rq_flags</span><span class="w"> </span><span class="o">*</span><span class="n">rf</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//prevè¡¨ç¤ºå½“å‰rqä¸Šæ­£åœ¨è¿è¡Œçš„ï¼Œè¢«æŠ¢å çš„taskã€‚</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cfs</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">new_tasks</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">repick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="nl">again</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sched_fair_runnable</span><span class="p">(</span><span class="n">rq</span><span class="p">))</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">idle</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FAIR_GROUP_SCHED </span><span class="c1">//ç»„è°ƒåº¦å¤„ç†</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">prev</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">sched_class</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fair_sched_class</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">simple</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//å¦‚æœè¢«æŠ¢å taskä¸å±äºcfsï¼Œåˆ™è·³è½¬åˆ°simpleå¤„ç†ã€‚</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Because of the set_next_buddy() in dequeue_task_fair() it is rather</span>
<span class="cm">     * likely that a next task is from the same cgroup as the current.</span>
<span class="cm">     *</span>
<span class="cm">     * Therefore attempt to avoid putting and setting the entire cgroup</span>
<span class="cm">     * hierarchy, only change the part that actually changes.</span>
<span class="cm">     */</span>

<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">;</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Since we got here without doing put_prev_entity() we also</span>
<span class="cm">         * have to consider cfs_rq-&gt;curr. If it is still a runnable</span>
<span class="cm">         * entity, update_curr() will update its vruntime, otherwise</span>
<span class="cm">         * forget we've ever seen it.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="c1">//å¦‚æœå½“å‰cfs_rqé˜Ÿåˆ—ä¸­å­˜åœ¨æ­£åœ¨è¿è¡Œçš„è°ƒåº¦å®ä½“ï¼Œåˆ™éœ€è¦æ›´æ–°æ—¶é—´ï¼Œå¹¶æ£€æŸ¥å½“å‰</span>
<span class="w">        </span><span class="c1">//cfs_rqä¸Šçš„æ—¶é—´ç‰‡æ˜¯å¦ä½¿ç”¨å®Œï¼ˆå¼€å¯å¸¦å®½æ§åˆ¶ï¼‰ï¼Œå¦‚æœä½¿ç”¨å®Œï¼Œé‚£ä¹ˆcfs_rqä¸Šæ‰€æœ‰çš„//ä»»åŠ¡éƒ½ä¸èƒ½å†è°ƒåº¦ï¼Œè·³è½¬simpleå¤„ç†ã€‚</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">on_rq</span><span class="p">)</span>
<span class="w">                </span><span class="n">update_curr</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">);</span><span class="w"> </span><span class="c1">//æ›´æ–°æ—¶é—´</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">             </span><span class="c1">//æ£€æŸ¥å½“å‰cfs_rqé˜Ÿåˆ—runtimeæ˜¯å¦è¿˜æœ‰å‰©ä½™ï¼ˆcfs_rq-&gt;runtime_remaining&gt;0ï¼‰</span>
<span class="c1">//3.4.4.1æè¿°ï¼Œå¦‚æœæ²¡æœ‰å‰©ä½™ï¼Œé‚£ä¹ˆcfs_rqä¸‹æ‰€æœ‰çš„ä»»åŠ¡å°†ä¸å†å…è®¸è°ƒåº¦ã€‚</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">check_cfs_rq_runtime</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">cfs_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cfs</span><span class="p">;</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">nr_running</span><span class="p">)</span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">idle</span><span class="p">;</span>

<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">simple</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//æŒ‘é€‰ä¸‹ä¸€ä¸ªè°ƒåº¦å®ä½“ï¼Œé€‰æ‹©çº¢é»‘æ ‘æœ€å·¦è¾¹çš„</span>
<span class="w">        </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pick_next_entity</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">curr</span><span class="p">);</span>
<span class="w">        </span><span class="n">cfs_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group_cfs_rq</span><span class="p">(</span><span class="n">se</span><span class="p">);</span><span class="w"> </span><span class="c1">//å½“å‰çš„è°ƒåº¦å®ä½“æ˜¯ä¸€ä¸ªä»»åŠ¡ç»„,se-&gt;my_q !=NULL</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">);</span><span class="w"> </span><span class="c1">//å¦‚æœæ˜¯ä¸€ä¸ªä»»åŠ¡ç»„ï¼Œåˆ™ç»§ç»­ä»è¯¥ä»»åŠ¡ç»„ä»æŒ‘é€‰åˆé€‚çš„ä»»åŠ¡</span>

<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task_of</span><span class="p">(</span><span class="n">se</span><span class="p">);</span><span class="w"> </span><span class="c1">//è·å–å½“å‰è°ƒåº¦å®ä½“å¯¹åº”çš„task_structã€‚</span>
<span class="w">    </span><span class="n">trace_android_rvh_replace_next_task_fair</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">repick</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Since we haven't yet done put_prev_entity and if the selected task</span>
<span class="cm">     * is a different task than we started out with, try and touch the</span>
<span class="cm">     * least amount of cfs_rqs.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prev</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//è¢«æŠ¢å çš„ä»»åŠ¡ä¸å½“å‰æŒ‘é€‰è¦å…è®¸çš„ä»»åŠ¡ä¸åŒã€‚</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">pse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">;</span><span class="w"> </span><span class="c1">//è·å–è¢«æŠ¢å ä»»åŠ¡çš„è°ƒåº¦å®ä½“ã€‚</span>
<span class="w">        </span><span class="c1">//å¾ªç¯éå†ï¼Œç›´åˆ°å°†è¦è¿è¡Œçš„è°ƒåº¦å®ä½“ä¸è¢«æŠ¢å çš„è°ƒåº¦å®ä½“æˆ–çˆ¶å®ä½“åœ¨åŒä¸€çº§</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cfs_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is_same_group</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">pse</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">se_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">se</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span><span class="w"> </span><span class="c1">//è·å–å°†è¦è¿è¡Œçš„è°ƒåº¦å®ä½“æ‰€åœ¨å±‚æ¬¡</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">pse_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pse</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span><span class="c1">//è·å–å°†è¢«æŠ¢å ä»»åŠ¡è°ƒåº¦å®ä½“æ‰€åœ¨å±‚æ¬¡</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">se_depth</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">pse_depth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//è¦è¿è¡Œçš„è°ƒåº¦å®ä½“å±‚æ¬¡æ¯”è¢«æŠ¢å çš„è¦æµ…ï¼ˆåœ¨ä¸Šä¸€çº§ï¼‰</span>
<span class="w">                </span><span class="n">put_prev_entity</span><span class="p">(</span><span class="n">cfs_rq_of</span><span class="p">(</span><span class="n">pse</span><span class="p">),</span><span class="w"> </span><span class="n">pse</span><span class="p">);</span><span class="w"> </span>
<span class="c1">//å°†å…¶è°ƒåº¦å®ä½“è°ƒæ•´é‡æ–°å…¥é˜Ÿï¼ˆè¿è¡Œçš„æ—¶å€™æ˜¯ä¸åœ¨å°±ç»ªé˜Ÿåˆ—ä¸Šçš„ï¼Œä¸èƒ½è°ƒåº¦äº†ï¼Œ//å› æ­¤éœ€è¦åŠ å…¥åˆ°å°±ç»ªé˜Ÿåˆ—ï¼‰</span>
<span class="w">                </span><span class="n">pse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent_entity</span><span class="p">(</span><span class="n">pse</span><span class="p">);</span>
<span class="c1">//æ‰¾åˆ°å…¶çˆ¶è°ƒåº¦å®ä½“ï¼Œç»§ç»­å¾ªç¯è·Ÿå½“å‰è¦è¿è¡Œçš„è°ƒåº¦å®ä½“åœ¨åŒä¸€çº§</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">se_depth</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">pse_depth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//è¦è¿è¡Œçš„è°ƒåº¦å®ä½“å±‚æ¬¡æ¯”è¢«æŠ¢å çš„è¦æ·±ï¼ˆåœ¨ä¸‹ä¸€çº§ï¼‰</span>
<span class="w">                </span><span class="n">set_next_entity</span><span class="p">(</span><span class="n">cfs_rq_of</span><span class="p">(</span><span class="n">se</span><span class="p">),</span><span class="w"> </span><span class="n">se</span><span class="p">);</span><span class="w"> </span>
<span class="c1">//è®¾ç½®å°†è¦æ‰§è¡Œçš„è°ƒåº¦å®ä½“ï¼Œä¸»è¦åŠ¨ä½œæ˜¯å°†å½“å‰å°†è¦è°ƒåº¦çš„å®ä½“å‡ºé˜Ÿï¼Œè¦è°ƒåº¦çš„å®//ä½“ä¸åº”è¯¥åœ¨ä¿å­˜åœ¨å°±ç»ªé˜Ÿåˆ—ä¸Šï¼Œè€Œæ˜¯å­˜å‚¨åœ¨cfs-&gt;currä¸Šã€‚</span>
<span class="w">                </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent_entity</span><span class="p">(</span><span class="n">se</span><span class="p">);</span><span class="w"> </span><span class="c1">//æŒ‡å‘å…¶çˆ¶è°ƒåº¦å®ä½“</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//åˆ°æ­¤æ—¶ï¼Œå·²ç»æ‰¾åˆ°å°†è¦è°ƒåº¦çš„å®ä½“ä¸è¢«æŠ¢å çš„è°ƒåº¦å®ä½“åŒä¸€çº§çš„çˆ¶è°ƒåº¦å®ä½“</span>
<span class="w">        </span><span class="c1">//ä¸ºä»€ä¹ˆè¦æ‰¾å°†è¦è°ƒåº¦å®ä½“ä¸è¢«æŠ¢å çš„å®ä½“çš„çˆ¶/ç¥–æ‰€åœ¨åŒä¸€å±‚çº§çš„äº†ï¼Œæ˜¯å› ä¸º</span>
<span class="w">        </span><span class="c1">//è°ƒåº¦æ˜¯ä»ä¸Šå¾€ä¸‹çš„ï¼Œå…¶ä»»åŠ¡ç»„ä¸­çš„ä»»åŠ¡å®ä½“è¦èƒ½å¤Ÿè¢«è°ƒåº¦ï¼Œé‚£å¿…é¡»è¦è®©å…¶çˆ¶</span>
<span class="w">        </span><span class="c1">//æ‹¿åˆ°è°ƒåº¦æƒã€‚</span>
<span class="w">        </span><span class="n">put_prev_entity</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">pse</span><span class="p">);</span><span class="w"> </span><span class="c1">//å°†è¢«æŠ¢å çš„è°ƒåº¦å®ä½“ï¼ˆå¯èƒ½æ˜¯çˆ¶ï¼‰é‡æ–°å…¥é˜Ÿ</span>
<span class="w">        </span><span class="n">set_next_entity</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">);</span><span class="c1">//è®¾ç½®å½“å‰çš„è°ƒåº¦å®ä½“ä¸ºä¸‹ä¸€ä¸ªå°†è¦è¿è¡Œè°ƒåº¦å®ä½“ã€‚</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">done</span><span class="p">;</span>
</code></pre></div>
<h3 id="cfscfs_1">æœªå¼€å¯CFSç»„è°ƒåº¦æˆ–è¢«æŠ¢å çš„ä»»åŠ¡ä¸æ˜¯CFSè°ƒåº¦ç±»</h3>
<div class="codehilite"><pre><span></span><code><span class="nl">simple</span><span class="p">:</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prev</span><span class="p">)</span>
<span class="w">        </span><span class="n">put_prev_task</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">);</span>
<span class="c1">//å°†è¢«æŠ¢å çš„è¿›ç¨‹é‡æ–°æ”¾å›å°±ç»ªé˜Ÿåˆ—ä¸­ï¼Œè¿è¡Œçš„è¿›ç¨‹æ˜¯æ”¾åœ¨cfs_rq-&gt;currä¸Šï¼Œä¸åœ¨å°±ç»ªé˜Ÿåˆ—ä¸Šã€‚</span>
<span class="w">    </span><span class="n">trace_android_rvh_replace_next_task_fair</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">repick</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">repick</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">done</span><span class="p">;</span>

<span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="c1">//ä»cfs_rqä¸­é‡æ–°æŒ‘é€‰ä¸‹ä¸€ä¸ªè°ƒåº¦å®ä½“</span>
<span class="w">        </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pick_next_entity</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">       </span><span class="c1">//å°†æŒ‘é€‰çš„è°ƒåº¦å®ä½“è®¾ç½®æœªå°†è¦è¿è¡Œçš„è¿›ç¨‹å¹¶ç§»é™¤å°±ç»ªé˜Ÿåˆ—</span>
<span class="w">        </span><span class="n">set_next_entity</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">);</span>
<span class="w">       </span><span class="c1">//åˆ¤æ–­å½“å‰çš„è°ƒåº¦å®ä½“æ˜¯ä»»åŠ¡ç»„è°ƒåº¦å®ä½“ï¼Œå¦‚æœæ˜¯åˆ™åœ¨ä»»åŠ¡ç»„cfs_rqæŸ¥æ‰¾è°ƒåº¦å®ä½“ã€‚</span>
<span class="w">        </span><span class="n">cfs_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group_cfs_rq</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">);</span>

<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task_of</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>

<span class="nl">done</span><span class="p">:</span><span class="w"> </span><span class="n">__maybe_unused</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SMP</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Move the next running task to the front of</span>
<span class="cm">     * the list, so our cfs_tasks list becomes MRU</span>
<span class="cm">     * one.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">.</span><span class="n">group_node</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cfs_tasks</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hrtick_enabled_fair</span><span class="p">(</span><span class="n">rq</span><span class="p">))</span>
<span class="w">        </span><span class="n">hrtick_start_fair</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="n">update_misfit_status</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">rq</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</code></pre></div>
<h3 id="_7">æ²¡æœ‰è¦è¿è¡Œçš„ä»»åŠ¡</h3>
<div class="codehilite"><pre><span></span><code><span class="nl">idle</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rf</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="n">new_tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newidle_balance</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">rf</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Because newidle_balance() releases (and re-acquires) rq-&gt;lock, it is</span>
<span class="cm">     * possible for any higher priority task to appear. In that case we</span>
<span class="cm">     * must re-start the pick_next_entity() loop.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">new_tasks</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">RETRY_TASK</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">new_tasks</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">again</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * rq is about to be idle, check if we need to update the</span>
<span class="cm">     * lost_idle_time of clock_pelt</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">update_idle_rq_clock_pelt</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_8">å°ç»“</h3>
<p>ä»»åŠ¡çš„é€‰æ‹©åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼šå¼€äº†ç»„è°ƒåº¦ä¸”è¢«æŠ¢å çš„ä»»åŠ¡æ˜¯CFSç±»ï¼Œæœªå¼€ç»„è°ƒåº¦æˆ–è¢«æŠ¢å çš„ä»»åŠ¡ä¸æ˜¯CFSç±»ï¼Œæ²¡æœ‰ä»»åŠ¡å¯è¿è¡Œã€‚ â€ƒâ€ƒæŒ‘é€‰äº†ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„ä»»åŠ¡è°ƒç”¨set_next_entityæ¥è®¾ç½®å¹¶ä¸”æŠŠè¢«æŠ¢å çš„ä»»åŠ¡è°ƒç”¨put_prev_entityé‡æ–°å…¥é˜Ÿã€‚set_next_entityå’Œput_prev_entityä¸¤ä¸ªå‡½æ•°å¯ä»¥çœ‹å‡ºæ˜¯ä¸€å¯¹ï¼Œå½“è®¾ç½®è¦è¿è¡Œçš„è¿è¡Œæ—¶ï¼Œä»»åŠ¡å°†ä¼šä»å°±ç»ªé˜Ÿåˆ—å‡ºé˜Ÿï¼Œç”¨cfs_rq-&gt;curræ¥æŒ‡å‘å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„çš„æ—¶å‡ºé˜Ÿè°ƒç”¨çš„æ—¶__dequeue_entityç›´æ¥ä»çº¢é»‘æ ‘ä¸­ç§»é™¤ï¼Œè€Œä¸æ˜¯è°ƒç”¨dequeue_entityï¼Œå†å»æ›´æ–°æ—¶é—´ã€è®¡ç®—è´Ÿè½½è´¡çŒ®ç­‰ç­‰ï¼Œè¿™é‡Œå°¤å…¶è¦æ³¨æ„çš„æ˜¯se-&gt;on_rqè¿™ä¸ªå˜é‡ï¼Œåœ¨dequeue_entityè¯¥å˜é‡se-&gt;on_rq=0ï¼Œè¡¨ç¤ºä»»åŠ¡å‡ºé˜Ÿï¼Œè€Œset_next_entityç›´æ¥è°ƒç”¨__dequeue_entityè¯¥å€¼se-&gt;on_rqä¸ä¼šå˜ï¼Œè€Œæ˜¯se-&gt;on_rq=1ï¼Œå½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡å³ä½¿ä»çº¢é»‘æ ‘ä¸­è¢«ç§»é™¤çš„ï¼Œä½†æ˜¯se-&gt;on_rqä¾æ—§æ˜¯1ï¼Œæ‰€ä»¥è¯¥ä»»åŠ¡å¹¶ä¸æ˜¯å®Œå…¨æ„ä¹‰çš„å‡ºé˜Ÿåˆ—ï¼Œå› æ­¤se-&gt;on_rq=1æ„å‘³ç€ä»»åŠ¡æ˜¯runnable+runningï¼ˆrunnableè¡¨ç¤ºä»»åŠ¡å¤„äºå°±ç»ªé˜Ÿåˆ—ä¸­ï¼Œrunningè¡¨ç¤ºä»»åŠ¡æ­£åœ¨è¿è¡Œï¼‰ï¼Œè¿™å¯¹äºåç»­è´Ÿè½½è®¡ç®—çš„æ—¶å€™å½±å“è¾ƒå¤§ã€‚put_per_entityè¦åšçš„æ—¶å€™å°±æ˜¯å°†è¢«æŠ¢å çš„ä»»åŠ¡å†æ¬¡å…¥é˜Ÿä¸set_next_entityæ‰€åšäº‹æƒ…ç›¸å¯¹åº”ã€‚</p>
<h2 id="_9">ä»»åŠ¡åˆ‡æ¢</h2>
<p>å‚è€ƒï¼š <a href="https://heapdump.cn/article/2730937">https://heapdump.cn/article/2730937</a></p></div>
  <div class="post-nav">
    <a class="prev" href="è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ª.html">â† è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ª</a>
    <a class="next" href="cfsåˆ†ç»„è°ƒåº¦.html">CFSåˆ†ç»„è°ƒåº¦ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

