<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ç§»åŠ¨æ£€æµ‹ä»£ç ç¤ºä¾‹åˆ†æ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">æ•°æ®ç»“æ„</a><ul><li><a href="#vencmotionsearchparam">VencMotionSearchParam</a></li><li><a href="#vencmotionsearchregion">VencMotionSearchRegion</a></li></ul></li><li><a href="#_2">åˆå§‹åŒ–å¯åŠ¨</a><ul><li><a href="#mpp">å¯åŠ¨MPP</a></li><li><a href="#vipp">åˆ›å»ºå’Œä½¿èƒ½VIPP</a></li><li><a href="#_3">åˆ›å»ºè™šæ‹Ÿé€šé“</a></li><li><a href="#_4">åˆ›å»ºç¼–ç é€šé“</a></li><li><a href="#_5">é€šé“é€šé“ç»‘å®šä¸å¯åŠ¨</a></li></ul></li><li><a href="#_6">ç§»åŠ¨ä¾¦æµ‹</a><ul><li><a href="#_7">ä¾¦æµ‹å‚æ•°è®¾ç½®</a></li><li><a href="#_8">è·å–ä¾¦æµ‹å‚æ•°åˆ†é…å†…å­˜</a></li><li><a href="#_9">åˆ¤æ–­ä¾¦æµ‹ç»“æœ</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>ç§»åŠ¨æ£€æµ‹ä»£ç ç¤ºä¾‹åˆ†æ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-11-17
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">æ•°æ®ç»“æ„</h2>
<h3 id="vencmotionsearchparam">VencMotionSearchParam</h3>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">en_motion_search</span><span class="p">;</span><span class="w"> </span><span class="c1">// ç§»åŠ¨ä¾¦æµ‹åŠŸèƒ½ä½¿èƒ½å¼€å…³ï¼Œ1ï¼šå¼€ï¼Œ0ï¼šå…³ã€‚</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">dis_default_para</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ˜¯å¦ç¦ç”¨é»˜è®¤å‚æ•°ï¼Œ1ï¼šä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰å‚æ•°ï¼Œ0ï¼šä½¿ç”¨é»˜è®¤å‚æ•°ã€‚</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">hor_region_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ°´å¹³æ–¹å‘ä¸Šåˆ’åˆ†åŒºåŸŸçš„ä¸ªæ•°ï¼Œé»˜è®¤å€¼10ã€‚</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ver_region_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// ç«–ç›´æ–¹å‘ä¸Šåˆ’åˆ†åŒºåŸŸçš„ä¸ªæ•°ï¼Œé»˜è®¤å€¼5ã€‚</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">large_mv_th</span><span class="p">;</span><span class="w"> </span><span class="c1">// MBï¼ˆ16*16ï¼‰çš„å¤§MVé˜ˆå€¼ï¼Œå–å€¼èŒƒå›´ï¼š[0, 511]ï¼Œé»˜è®¤å€¼20ã€‚</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">large_mv_ratio_th</span><span class="p">;</span><span class="w"> </span><span class="c1">// Regionå†…å¤§MVå—å’ŒIntraå—æ‰€å çš„æ•°é‡æ¯”ä¾‹é˜ˆå€¼, å–å€¼èŒƒå›´ï¼š[0, 100]ï¼Œé»˜è®¤å€¼12.0fã€‚</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">non_zero_mv_ratio_th</span><span class="p">;</span><span class="w"> </span><span class="c1">// Regionå†…éé›¶MVå—æ‰€å çš„æ•°é‡æ¯”ä¾‹é˜ˆå€¼ï¼Œå–å€¼èŒƒå›´ï¼š[0, 100]ï¼Œé»˜è®¤å€¼20.0fã€‚</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">large_sad_ratio_th</span><span class="p">;</span><span class="w"> </span><span class="c1">// Regionå†…SADå¤§äºsVbrParam.nMovingThçš„å—çš„æ•°é‡æ¯”ä¾‹ï¼Œå–å€¼èŒƒå›´ï¼š[0, 100]ï¼Œé»˜è®¤å€¼30.0f</span>
<span class="err">ã€‚</span>
<span class="p">}</span><span class="n">VencMotionSearchParam</span><span class="p">;</span>
</code></pre></div>
<h3 id="vencmotionsearchregion">VencMotionSearchRegion</h3>
<p>ç§»åŠ¨ä¾¦æµ‹æœç´¢åŒºåŸŸ</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pix_x_bgn</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ¯ä¸ªRegionçš„çŸ©å½¢å››ä¸ªè§’ç‚¹åƒç´ åæ ‡ï¼Œå·¦ä¸Šè§’xåæ ‡</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pix_x_end</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ¯ä¸ªRegionçš„çŸ©å½¢å››ä¸ªè§’ç‚¹åƒç´ åæ ‡ï¼Œå³ä¸‹è§’xåæ ‡</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pix_y_bgn</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ¯ä¸ªRegionçš„çŸ©å½¢å››ä¸ªè§’ç‚¹åƒç´ åæ ‡ï¼Œå·¦ä¸Šè§’yåæ ‡</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pix_y_end</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ¯ä¸ªRegionçš„çŸ©å½¢å››ä¸ªè§’ç‚¹åƒç´ åæ ‡ï¼Œå³ä¸‹è§’yåæ ‡</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">total_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// è¯¥Regionæ€»MBæ•°</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">intra_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// è¯¥Regionå†…Intraå—æ•°é‡</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">large_mv_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// è¯¥Regionå†…å¤§MVçš„Interå—æ•°é‡</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">small_mv_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// è¯¥Regionå†…å°MVçš„Interå—æ•°é‡ï¼ˆä¸åŒ…æ‹¬é›¶MVï¼‰</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">zero_mv_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// è¯¥Regionå†…é›¶MVçš„Interå—æ•°é‡ï¼ˆåŒ…æ‹¬Skipå—ï¼‰</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">large_sad_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// è¯¥Regionå†…SADå¤§äºVBR nMovingThçš„å—æ•°é‡</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">is_motion</span><span class="p">;</span><span class="w"> </span><span class="c1">// è¯¥Regionè¢«åˆ¤å®šä¸ºå­˜åœ¨è¿åŠ¨çš„æ ‡å¿—</span>
<span class="p">}</span><span class="n">VencMotionSearchRegion</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">total_region_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ€»çš„åŒºåŸŸä¸ªæ•°ï¼Œç­‰äºhor_region_num * ver_region_num</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">motion_region_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ€»çš„è¿åŠ¨åŒºåŸŸä¸ªæ•°</span>
<span class="w">    </span><span class="n">VencMotionSearchRegion</span><span class="w"> </span><span class="o">*</span><span class="n">region</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ¯ä¸ªåŒºåŸŸçš„è¿åŠ¨ä¿¡æ¯</span>
<span class="p">}</span><span class="n">VencMotionSearchResult</span><span class="p">;</span>
</code></pre></div>
<h2 id="_2">åˆå§‹åŒ–å¯åŠ¨</h2>
<h3 id="mpp">å¯åŠ¨MPP</h3>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="n">MPP_SYS_CONF_S</span><span class="w"> </span><span class="n">stSysConf</span><span class="p">;</span>
<span class="w">   </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stSysConf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">MPP_SYS_CONF_S</span><span class="p">));</span>
<span class="w">   </span><span class="n">stSysConf</span><span class="p">.</span><span class="n">nAlignWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">   </span><span class="n">AW_MPI_SYS_SetConf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stSysConf</span><span class="p">);</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AW_MPI_SYS_Init</span><span class="p">();</span>
</code></pre></div>
<p>ç§»åŠ¨æ£€æµ‹å¯ä»¥æ”¯æŒåœ¨çº¿æ¨¡å¼å’Œç¦»çº¿æ¨¡å¼ï¼Œä½†æ˜¯åœ¨çº¿æ¨¡å¼åªèƒ½ä½¿ç”¨vipp0å’Œvechn0ã€‚</p>
<h3 id="vipp">åˆ›å»ºå’Œä½¿èƒ½VIPP</h3>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">è®¾ç½®VIPPé€šé“çš„å±æ€§</span>
<span class="w">    </span><span class="cm">/*Set VI Channel Attribute*/</span>
<span class="w">    </span><span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VI_ATTR_S</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mOnlineEnable</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">mOnlineEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">mOnlineShareBufNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mOnlineShareBufNum</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">memtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">pixelformat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map_PIXEL_FORMAT_E_to_V4L2_PIX_FMT</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcPicFormat</span><span class="p">);</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">colorspace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcWidth</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcHeight</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">fps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcFrameRate</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">use_current_win</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">nbufs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="c1">//5;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">nplanes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">    </span><span class="n">AW_MPI_VI_CreateVipp</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViDev</span><span class="p">);</span>
<span class="w">    </span><span class="n">AW_MPI_VI_SetVippAttr</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViDev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">);</span>
<span class="w">    </span><span class="n">AW_MPI_ISP_Run</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mIspDev</span><span class="p">);</span>
<span class="w">    </span><span class="n">AW_MPI_VI_EnableVipp</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViDev</span><span class="p">);</span>
</code></pre></div>
<h3 id="_3">åˆ›å»ºè™šæ‹Ÿé€šé“</h3>
<div class="codehilite"><pre><span></span><code><span class="n">AW_MPI_VI_CreateVirChn</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViDev</span><span class="p">,</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViChn</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</code></pre></div>
<h3 id="_4">åˆ›å»ºç¼–ç é€šé“</h3>
<p>æ ¹æ®ç¼–ç ç±»å‹è®¾ç½®ç¼–ç é€šé“çš„å±æ€§ï¼Œè¿™é‡Œç§»åŠ¨æ£€æµ‹æ˜¯h.264</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">PT_H264</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">Type</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH264e</span><span class="p">.</span><span class="n">Profile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH264e</span><span class="p">.</span><span class="n">bByFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH264e</span><span class="p">.</span><span class="n">PicWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstWidth</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH264e</span><span class="p">.</span><span class="n">PicHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstHeight</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH264e</span><span class="p">.</span><span class="n">mLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H264_LEVEL_51</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH264e</span><span class="p">.</span><span class="n">mbPIntraEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mRcMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VENC_RC_MODE_H264VBR</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrH264Vbr</span><span class="p">.</span><span class="n">mMaxBitRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstBitRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrH264Vbr</span><span class="p">.</span><span class="n">mSrcFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcFrameRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrH264Vbr</span><span class="p">.</span><span class="n">mDstFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstFrameRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mMaxQp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">51</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mMinQp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mMaxPqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">51</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mMinPqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mQpInit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mbEnMbQpLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mMovingTh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mQuality</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mIFrmBitsCoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mPFrmBitsCoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">PT_H265</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">Type</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH265e</span><span class="p">.</span><span class="n">mProfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH265e</span><span class="p">.</span><span class="n">mbByFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH265e</span><span class="p">.</span><span class="n">mPicWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstWidth</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH265e</span><span class="p">.</span><span class="n">mPicHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstHeight</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH265e</span><span class="p">.</span><span class="n">mLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H265_LEVEL_62</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH265e</span><span class="p">.</span><span class="n">mbPIntraEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mRcMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VENC_RC_MODE_H265VBR</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrH265Vbr</span><span class="p">.</span><span class="n">mMaxBitRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstBitRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrH265Vbr</span><span class="p">.</span><span class="n">mSrcFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcFrameRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrH265Vbr</span><span class="p">.</span><span class="n">mDstFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstFrameRate</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//ä»¥ä¸‹æ˜¯ç æµæ§åˆ¶</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mMaxQp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">51</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mMinQp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mMaxPqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">51</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mMinPqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mQpInit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mbEnMbQpLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mMovingTh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mQuality</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mIFrmBitsCoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mPFrmBitsCoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">PT_MJPEG</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">Type</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrMjpeg</span><span class="p">.</span><span class="n">mbByFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrMjpeg</span><span class="p">.</span><span class="n">mPicWidth</span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstWidth</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrMjpeg</span><span class="p">.</span><span class="n">mPicHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstHeight</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mRcMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VENC_RC_MODE_MJPEGCBR</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrMjpegeCbr</span><span class="p">.</span><span class="n">mBitRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstBitRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrMjpegeCbr</span><span class="p">.</span><span class="n">mSrcFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcFrameRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrMjpegeCbr</span><span class="p">.</span><span class="n">mDstFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstFrameRate</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVencFrameRateConfig</span><span class="p">.</span><span class="n">SrcFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcFrameRate</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVencFrameRateConfig</span><span class="p">.</span><span class="n">DstFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstFrameRate</span><span class="p">;</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">AW_MPI_VENC_CreateChn</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">);</span>
<span class="n">AW_MPI_VENC_SetRcParam</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">);</span><span class="c1">//ç æµæ§åˆ¶</span>
</code></pre></div>
<h3 id="_5">é€šé“é€šé“ç»‘å®šä¸å¯åŠ¨</h3>
<p>å…ˆå°†VIPPå’ŒVENCç¼–ç é€šé“ç»‘å®šï¼Œæ¥ç€ä½¿èƒ½è™šæ‹Ÿé€šé“å¹¶å¯åŠ¨ç¼–ç ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="n">MPP_CHN_S</span><span class="w"> </span><span class="n">ViChn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">MOD_ID_VIU</span><span class="p">,</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViDev</span><span class="p">,</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViChn</span><span class="p">};</span>
<span class="w">   </span><span class="n">MPP_CHN_S</span><span class="w"> </span><span class="n">VeChn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">MOD_ID_VENC</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">};</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AW_MPI_SYS_Bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ViChn</span><span class="p">,</span><span class="o">&amp;</span><span class="n">VeChn</span><span class="p">);</span>

<span class="w">   </span><span class="n">AW_MPI_VI_EnableVirChn</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViDev</span><span class="p">,</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViChn</span><span class="p">);</span>
<span class="w">   </span><span class="n">AW_MPI_VENC_StartRecvPic</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">);</span><span class="c1">//å¯åŠ¨ç¼–ç </span>
</code></pre></div>
<h2 id="_6">ç§»åŠ¨ä¾¦æµ‹</h2>
<h3 id="_7">ä¾¦æµ‹å‚æ•°è®¾ç½®</h3>
<p>è®¾ç½®ç§»åŠ¨ä¾¦æµ‹å‚æ•°ï¼Œå‚æ•°å«ä¹‰è§ä¸Šè¿°æ•°æ®ç»“æ„è§£æ</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="c1">// motion search must be enabled when VE is running.</span>
<span class="w">        </span><span class="n">VencMotionSearchParam</span><span class="w"> </span><span class="n">mMotionParam</span><span class="p">;</span>
<span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mMotionParam</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VencMotionSearchParam</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">motionAlarm_useDefaultCfgEnable</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">en_motion_search</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">dis_default_para</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">en_motion_search</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">dis_default_para</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">hor_region_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">motionAlarm_HorizontalRegionNum</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">ver_region_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">motionAlarm_VerticalRegionNum</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">en_check_mv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">en_check_mad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">en_morpholog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">large_mv_th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">large_mad_th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">background_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">large_mv_ratio_th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">12.0f</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">non_zero_mv_ratio_th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">20.0f</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">large_mad_ratio_th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10.0f</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">è°ƒç”¨å‡½æ•°è®¾ç½®</span><span class="err">ã€‚</span>
<span class="w">        </span><span class="n">AW_MPI_VENC_SetMotionSearchParam</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mMotionParam</span><span class="p">);</span>
</code></pre></div>
<h3 id="_8">è·å–ä¾¦æµ‹å‚æ•°åˆ†é…å†…å­˜</h3>
<p>åˆ†é…ä¾¦æµ‹åŒºåŸŸçš„å†…å­˜</p>
<div class="codehilite"><pre><span></span><code><span class="n">AW_MPI_VENC_GetMotionSearchParam</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mMotionParam</span><span class="p">);</span>
<span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">hor_region_num</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">ver_region_num</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VencMotionSearchRegion</span><span class="p">)</span>
<span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">VencMotionSearchRegion</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</code></pre></div>
<h3 id="_9">åˆ¤æ–­ä¾¦æµ‹ç»“æœ</h3>
<h4 id="_10">åˆ¤æ–­ç”»é¢æ˜¯å¦æœ‰å˜åŒ–</h4>
<div class="codehilite"><pre><span></span><code><span class="n">AW_MPI_VENC_GetStream</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stVencStream</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="err">ï¼›</span>

<span class="n">è·å–ç§»åŠ¨ä¾¦æµ‹ç»“æœ</span>
<span class="n">AW_MPI_VENC_GetMotionSearchResult</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">);</span>

<span class="n">å‚æ•°ä¸­pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_motionè¡¨ç¤ºåŒºåŸŸå·²ç»å˜åŒ–</span><span class="err">ï¼Œ</span><span class="n">ä½†æ˜¯æ˜¯å¦è¾¾åˆ°ä¾¦æµ‹çš„</span>
<span class="n">é˜ˆå€¼</span><span class="err">ï¼Œ</span><span class="n">ä¾¦æµ‹åŒºåŸŸå˜åŒ–çš„èŒƒå›´å¤§å°</span><span class="err">ã€‚</span>

<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">total_region_num</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_motion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">alogv</span><span class="p">(</span><span class="err">\\\</span><span class="s">"area_%d:[(%d,%d),(%d,%d)]</span><span class="se">\\\"</span><span class="s">, i,</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pix_x_bgn</span><span class="p">,</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pix_y_bgn</span><span class="p">,</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pix_x_end</span><span class="p">,</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pix_y_end</span><span class="p">);</span>
<span class="w">        </span><span class="n">num</span><span class="w"> </span><span class="o">++</span><span class="err">ï¼›</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">åˆ¤æ–­ä¾¦æµ‹ç»“æœ</span><span class="err">ï¼Œ</span><span class="n">å˜åŒ–çš„èŒƒå›´æ˜¯å¦è¾¾åˆ°é˜ˆå€¼</span><span class="err">ï¼Œ</span><span class="n">å¦‚æœè¾¾åˆ°ä¾¦æµ‹é˜ˆå€¼åˆ™ç»“æœä¸ºç§»åŠ¨</span><span class="err">ã€‚</span>
<span class="n">MotionSearchJudgeResult</span><span class="p">(</span><span class="n">pContext</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
</code></pre></div>
<p>è°ƒç”¨AW_MPI_VENC_GetMotionSearchResultè¿”å›çš„å‚æ•°ä¸­mMotionResult.region[i].is_motionå°±è¡¨ç¤ºç”»é¢æœ‰ç§»åŠ¨ï¼Œä½†æ˜¯éœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­ç”»é¢ç§»åŠ¨æ˜¯å¦è¾¾åˆ°ä¸€å®šé˜ˆå€¼ï¼Œé€šè¿‡MotionSearchJudgeResultå‡½æ•°æ¥åˆ¤æ–­ã€‚</p>
<h4 id="_11">åˆ¤æ–­ç”»é¢å˜åŒ–æ˜¯å¦è¾¾åˆ°é˜ˆå€¼</h4>
<div class="codehilite"><pre><span></span><code><span class="n">MotionSearchJudgeResult</span><span class="err">ï¼ˆï¼‰</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// è½¬æ¢ç”¨æˆ·é…ç½®çš„zoneåæ ‡åˆ°åŸå›¾åæ ‡</span>
<span class="w">    </span><span class="n">MotionDetectZoneInfo</span><span class="w"> </span><span class="n">zoneInfo</span><span class="p">;</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zoneInfo</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">MotionDetectZoneInfo</span><span class="p">));</span>
<span class="w">    </span><span class="n">ConvertMotionCoordinateZone2RawPic</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">zoneInfo</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ç§»åŠ¨ä¾¦æµ‹å‘Šè­¦åŒºåŸŸï¼Œç»Ÿä¸€å½“ä½œçŸ©å½¢å¤„ç†</span>
<span class="w">    </span><span class="n">ConvertMotionCoordinateZone2RegionNum</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">zoneInfo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">totalRegionNum</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// çµæ•åº¦ï¼šä¸ŠæŠ¥ç§»åŠ¨ä¾¦æµ‹äº‹ä»¶æ—¶ï¼Œæ ¹æ®çµæ•åº¦é«˜ä½è®¾ç½®ä¸åŒé˜ˆå€¼ï¼Œä¾¦æµ‹åŒºåŸŸå†…çš„æ ‡è®°</span>
<span class="w">    </span><span class="n">motionçš„regionä¸ªæ•°è¶…è¿‡é˜ˆå€¼å°±ä¸ŠæŠ¥</span><span class="err">ï¼Œ</span><span class="n">å¦åˆ™ä¸ä¸ŠæŠ¥</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">ConvertMotionSensitivity2Threshold</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">totalRegionNum</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threshold</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threshold</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">totalMotionRegionNum</span><span class="p">){</span>
<span class="w">        </span><span class="o">*</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="rtspè§†é¢‘ä¼ è¾“ç¤ºä¾‹ä»£ç åˆ†æ.html">â† RTSPè§†é¢‘ä¼ è¾“ç¤ºä¾‹ä»£ç åˆ†æ</a>
    <a class="next" href="æ‹ç…§ç¤ºä¾‹ä»£ç åˆ†æ.html">æ‹ç…§ç¤ºä¾‹ä»£ç åˆ†æ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

