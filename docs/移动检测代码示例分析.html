<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>移动检测代码示例分析 - Laumy的技术栈</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">首页</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="访问主站">主站点:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#_1">数据结构</a><ul><li><a href="#vencmotionsearchparam">VencMotionSearchParam</a></li><li><a href="#vencmotionsearchregion">VencMotionSearchRegion</a></li></ul></li><li><a href="#_2">初始化启动</a><ul><li><a href="#mpp">启动MPP</a></li><li><a href="#vipp">创建和使能VIPP</a></li><li><a href="#_3">创建虚拟通道</a></li><li><a href="#_4">创建编码通道</a></li><li><a href="#_5">通道通道绑定与启动</a></li></ul></li><li><a href="#_6">移动侦测</a><ul><li><a href="#_7">侦测参数设置</a></li><li><a href="#_8">获取侦测参数分配内存</a></li><li><a href="#_9">判断侦测结果</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>移动检测代码示例分析</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">🕒</i>
      2024-11-17
    </span>
    <span class="meta-item">
      <i class="icon">📂</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">👤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">数据结构</h2>
<h3 id="vencmotionsearchparam">VencMotionSearchParam</h3>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">en_motion_search</span><span class="p">;</span><span class="w"> </span><span class="c1">// 移动侦测功能使能开关，1：开，0：关。</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">dis_default_para</span><span class="p">;</span><span class="w"> </span><span class="c1">// 是否禁用默认参数，1：使用用户自定义参数，0：使用默认参数。</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">hor_region_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// 水平方向上划分区域的个数，默认值10。</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ver_region_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// 竖直方向上划分区域的个数，默认值5。</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">large_mv_th</span><span class="p">;</span><span class="w"> </span><span class="c1">// MB（16*16）的大MV阈值，取值范围：[0, 511]，默认值20。</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">large_mv_ratio_th</span><span class="p">;</span><span class="w"> </span><span class="c1">// Region内大MV块和Intra块所占的数量比例阈值, 取值范围：[0, 100]，默认值12.0f。</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">non_zero_mv_ratio_th</span><span class="p">;</span><span class="w"> </span><span class="c1">// Region内非零MV块所占的数量比例阈值，取值范围：[0, 100]，默认值20.0f。</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">large_sad_ratio_th</span><span class="p">;</span><span class="w"> </span><span class="c1">// Region内SAD大于sVbrParam.nMovingTh的块的数量比例，取值范围：[0, 100]，默认值30.0f</span>
<span class="err">。</span>
<span class="p">}</span><span class="n">VencMotionSearchParam</span><span class="p">;</span>
</code></pre></div>
<h3 id="vencmotionsearchregion">VencMotionSearchRegion</h3>
<p>移动侦测搜索区域</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pix_x_bgn</span><span class="p">;</span><span class="w"> </span><span class="c1">// 每个Region的矩形四个角点像素坐标，左上角x坐标</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pix_x_end</span><span class="p">;</span><span class="w"> </span><span class="c1">// 每个Region的矩形四个角点像素坐标，右下角x坐标</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pix_y_bgn</span><span class="p">;</span><span class="w"> </span><span class="c1">// 每个Region的矩形四个角点像素坐标，左上角y坐标</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pix_y_end</span><span class="p">;</span><span class="w"> </span><span class="c1">// 每个Region的矩形四个角点像素坐标，右下角y坐标</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">total_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// 该Region总MB数</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">intra_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// 该Region内Intra块数量</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">large_mv_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// 该Region内大MV的Inter块数量</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">small_mv_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// 该Region内小MV的Inter块数量（不包括零MV）</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">zero_mv_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// 该Region内零MV的Inter块数量（包括Skip块）</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">large_sad_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// 该Region内SAD大于VBR nMovingTh的块数量</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">is_motion</span><span class="p">;</span><span class="w"> </span><span class="c1">// 该Region被判定为存在运动的标志</span>
<span class="p">}</span><span class="n">VencMotionSearchRegion</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">total_region_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// 总的区域个数，等于hor_region_num * ver_region_num</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">motion_region_num</span><span class="p">;</span><span class="w"> </span><span class="c1">// 总的运动区域个数</span>
<span class="w">    </span><span class="n">VencMotionSearchRegion</span><span class="w"> </span><span class="o">*</span><span class="n">region</span><span class="p">;</span><span class="w"> </span><span class="c1">// 每个区域的运动信息</span>
<span class="p">}</span><span class="n">VencMotionSearchResult</span><span class="p">;</span>
</code></pre></div>
<h2 id="_2">初始化启动</h2>
<h3 id="mpp">启动MPP</h3>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="n">MPP_SYS_CONF_S</span><span class="w"> </span><span class="n">stSysConf</span><span class="p">;</span>
<span class="w">   </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stSysConf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">MPP_SYS_CONF_S</span><span class="p">));</span>
<span class="w">   </span><span class="n">stSysConf</span><span class="p">.</span><span class="n">nAlignWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">   </span><span class="n">AW_MPI_SYS_SetConf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stSysConf</span><span class="p">);</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AW_MPI_SYS_Init</span><span class="p">();</span>
</code></pre></div>
<p>移动检测可以支持在线模式和离线模式，但是在线模式只能使用vipp0和vechn0。</p>
<h3 id="vipp">创建和使能VIPP</h3>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">设置VIPP通道的属性</span>
<span class="w">    </span><span class="cm">/*Set VI Channel Attribute*/</span>
<span class="w">    </span><span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VI_ATTR_S</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mOnlineEnable</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">mOnlineEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">mOnlineShareBufNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mOnlineShareBufNum</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">memtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">pixelformat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map_PIXEL_FORMAT_E_to_V4L2_PIX_FMT</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcPicFormat</span><span class="p">);</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">colorspace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcWidth</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcHeight</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">fps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcFrameRate</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">use_current_win</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">nbufs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="c1">//5;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">.</span><span class="n">nplanes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">    </span><span class="n">AW_MPI_VI_CreateVipp</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViDev</span><span class="p">);</span>
<span class="w">    </span><span class="n">AW_MPI_VI_SetVippAttr</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViDev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViAttr</span><span class="p">);</span>
<span class="w">    </span><span class="n">AW_MPI_ISP_Run</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mIspDev</span><span class="p">);</span>
<span class="w">    </span><span class="n">AW_MPI_VI_EnableVipp</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViDev</span><span class="p">);</span>
</code></pre></div>
<h3 id="_3">创建虚拟通道</h3>
<div class="codehilite"><pre><span></span><code><span class="n">AW_MPI_VI_CreateVirChn</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViDev</span><span class="p">,</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViChn</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</code></pre></div>
<h3 id="_4">创建编码通道</h3>
<p>根据编码类型设置编码通道的属性，这里移动检测是h.264</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">PT_H264</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">Type</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH264e</span><span class="p">.</span><span class="n">Profile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH264e</span><span class="p">.</span><span class="n">bByFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH264e</span><span class="p">.</span><span class="n">PicWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstWidth</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH264e</span><span class="p">.</span><span class="n">PicHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstHeight</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH264e</span><span class="p">.</span><span class="n">mLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H264_LEVEL_51</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH264e</span><span class="p">.</span><span class="n">mbPIntraEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mRcMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VENC_RC_MODE_H264VBR</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrH264Vbr</span><span class="p">.</span><span class="n">mMaxBitRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstBitRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrH264Vbr</span><span class="p">.</span><span class="n">mSrcFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcFrameRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrH264Vbr</span><span class="p">.</span><span class="n">mDstFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstFrameRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mMaxQp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">51</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mMinQp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mMaxPqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">51</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mMinPqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mQpInit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mbEnMbQpLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mMovingTh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mQuality</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mIFrmBitsCoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH264Vbr</span><span class="p">.</span><span class="n">mPFrmBitsCoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">PT_H265</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">Type</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH265e</span><span class="p">.</span><span class="n">mProfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH265e</span><span class="p">.</span><span class="n">mbByFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH265e</span><span class="p">.</span><span class="n">mPicWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstWidth</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH265e</span><span class="p">.</span><span class="n">mPicHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstHeight</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH265e</span><span class="p">.</span><span class="n">mLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H265_LEVEL_62</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrH265e</span><span class="p">.</span><span class="n">mbPIntraEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mRcMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VENC_RC_MODE_H265VBR</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrH265Vbr</span><span class="p">.</span><span class="n">mMaxBitRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstBitRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrH265Vbr</span><span class="p">.</span><span class="n">mSrcFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcFrameRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrH265Vbr</span><span class="p">.</span><span class="n">mDstFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstFrameRate</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//以下是码流控制</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mMaxQp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">51</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mMinQp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mMaxPqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">51</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mMinPqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mQpInit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mbEnMbQpLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mMovingTh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mQuality</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mIFrmBitsCoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">.</span><span class="n">ParamH265Vbr</span><span class="p">.</span><span class="n">mPFrmBitsCoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">PT_MJPEG</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">Type</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrMjpeg</span><span class="p">.</span><span class="n">mbByFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrMjpeg</span><span class="p">.</span><span class="n">mPicWidth</span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstWidth</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrMjpeg</span><span class="p">.</span><span class="n">mPicHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstHeight</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mRcMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VENC_RC_MODE_MJPEGCBR</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrMjpegeCbr</span><span class="p">.</span><span class="n">mBitRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstBitRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrMjpegeCbr</span><span class="p">.</span><span class="n">mSrcFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcFrameRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">.</span><span class="n">RcAttr</span><span class="p">.</span><span class="n">mAttrMjpegeCbr</span><span class="p">.</span><span class="n">mDstFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstFrameRate</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVencFrameRateConfig</span><span class="p">.</span><span class="n">SrcFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mSrcFrameRate</span><span class="p">;</span>
<span class="w">    </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVencFrameRateConfig</span><span class="p">.</span><span class="n">DstFrmRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mDstFrameRate</span><span class="p">;</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">AW_MPI_VENC_CreateChn</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncChnAttr</span><span class="p">);</span>
<span class="n">AW_MPI_VENC_SetRcParam</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVEncRcParam</span><span class="p">);</span><span class="c1">//码流控制</span>
</code></pre></div>
<h3 id="_5">通道通道绑定与启动</h3>
<p>先将VIPP和VENC编码通道绑定，接着使能虚拟通道并启动编码。</p>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="n">MPP_CHN_S</span><span class="w"> </span><span class="n">ViChn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">MOD_ID_VIU</span><span class="p">,</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViDev</span><span class="p">,</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViChn</span><span class="p">};</span>
<span class="w">   </span><span class="n">MPP_CHN_S</span><span class="w"> </span><span class="n">VeChn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">MOD_ID_VENC</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">};</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AW_MPI_SYS_Bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ViChn</span><span class="p">,</span><span class="o">&amp;</span><span class="n">VeChn</span><span class="p">);</span>

<span class="w">   </span><span class="n">AW_MPI_VI_EnableVirChn</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViDev</span><span class="p">,</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mViChn</span><span class="p">);</span>
<span class="w">   </span><span class="n">AW_MPI_VENC_StartRecvPic</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">);</span><span class="c1">//启动编码</span>
</code></pre></div>
<h2 id="_6">移动侦测</h2>
<h3 id="_7">侦测参数设置</h3>
<p>设置移动侦测参数，参数含义见上述数据结构解析</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="c1">// motion search must be enabled when VE is running.</span>
<span class="w">        </span><span class="n">VencMotionSearchParam</span><span class="w"> </span><span class="n">mMotionParam</span><span class="p">;</span>
<span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mMotionParam</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VencMotionSearchParam</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">motionAlarm_useDefaultCfgEnable</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">en_motion_search</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">dis_default_para</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">en_motion_search</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">dis_default_para</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">hor_region_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">motionAlarm_HorizontalRegionNum</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">ver_region_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">motionAlarm_VerticalRegionNum</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">en_check_mv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">en_check_mad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">en_morpholog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">large_mv_th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">large_mad_th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">background_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">large_mv_ratio_th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">12.0f</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">non_zero_mv_ratio_th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">20.0f</span><span class="p">;</span>
<span class="w">            </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">large_mad_ratio_th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10.0f</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">调用函数设置</span><span class="err">。</span>
<span class="w">        </span><span class="n">AW_MPI_VENC_SetMotionSearchParam</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mMotionParam</span><span class="p">);</span>
</code></pre></div>
<h3 id="_8">获取侦测参数分配内存</h3>
<p>分配侦测区域的内存</p>
<div class="codehilite"><pre><span></span><code><span class="n">AW_MPI_VENC_GetMotionSearchParam</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mMotionParam</span><span class="p">);</span>
<span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">hor_region_num</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mMotionParam</span><span class="p">.</span><span class="n">ver_region_num</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VencMotionSearchRegion</span><span class="p">)</span>
<span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">VencMotionSearchRegion</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</code></pre></div>
<h3 id="_9">判断侦测结果</h3>
<h4 id="_10">判断画面是否有变化</h4>
<div class="codehilite"><pre><span></span><code><span class="n">AW_MPI_VENC_GetStream</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stVencStream</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="err">；</span>

<span class="n">获取移动侦测结果</span>
<span class="n">AW_MPI_VENC_GetMotionSearchResult</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">);</span>

<span class="n">参数中pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_motion表示区域已经变化</span><span class="err">，</span><span class="n">但是是否达到侦测的</span>
<span class="n">阈值</span><span class="err">，</span><span class="n">侦测区域变化的范围大小</span><span class="err">。</span>

<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">total_region_num</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_motion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">alogv</span><span class="p">(</span><span class="err">\\\</span><span class="s">"area_%d:[(%d,%d),(%d,%d)]</span><span class="se">\\\"</span><span class="s">, i,</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pix_x_bgn</span><span class="p">,</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pix_y_bgn</span><span class="p">,</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pix_x_end</span><span class="p">,</span>
<span class="w">        </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMotionResult</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pix_y_end</span><span class="p">);</span>
<span class="w">        </span><span class="n">num</span><span class="w"> </span><span class="o">++</span><span class="err">；</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">判断侦测结果</span><span class="err">，</span><span class="n">变化的范围是否达到阈值</span><span class="err">，</span><span class="n">如果达到侦测阈值则结果为移动</span><span class="err">。</span>
<span class="n">MotionSearchJudgeResult</span><span class="p">(</span><span class="n">pContext</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
</code></pre></div>
<p>调用AW_MPI_VENC_GetMotionSearchResult返回的参数中mMotionResult.region[i].is_motion就表示画面有移动，但是需要进一步判断画面移动是否达到一定阈值，通过MotionSearchJudgeResult函数来判断。</p>
<h4 id="_11">判断画面变化是否达到阈值</h4>
<div class="codehilite"><pre><span></span><code><span class="n">MotionSearchJudgeResult</span><span class="err">（）</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 转换用户配置的zone坐标到原图坐标</span>
<span class="w">    </span><span class="n">MotionDetectZoneInfo</span><span class="w"> </span><span class="n">zoneInfo</span><span class="p">;</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zoneInfo</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">MotionDetectZoneInfo</span><span class="p">));</span>
<span class="w">    </span><span class="n">ConvertMotionCoordinateZone2RawPic</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">zoneInfo</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 移动侦测告警区域，统一当作矩形处理</span>
<span class="w">    </span><span class="n">ConvertMotionCoordinateZone2RegionNum</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">zoneInfo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">totalRegionNum</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 灵敏度：上报移动侦测事件时，根据灵敏度高低设置不同阈值，侦测区域内的标记</span>
<span class="w">    </span><span class="n">motion的region个数超过阈值就上报</span><span class="err">，</span><span class="n">否则不上报</span><span class="err">。</span>
<span class="w">    </span><span class="n">ConvertMotionSensitivity2Threshold</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">totalRegionNum</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threshold</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threshold</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">totalMotionRegionNum</span><span class="p">){</span>
<span class="w">        </span><span class="o">*</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="rtsp视频传输示例代码分析.html">← RTSP视频传输示例代码分析</a>
    <a class="next" href="拍照示例代码分析.html">拍照示例代码分析 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

