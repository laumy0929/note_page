<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ONNX Runtime Pythonç«¯ä¾§æ¨¡å‹éƒ¨ç½²YOLOv5 - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#onnx-runtime">ONNX Runtimeä»‹ç»</a><ul><li><a href="#_1">åŠ è½½æ¨¡å‹</a></li><li><a href="#_2">æ¨¡å‹æ¨ç†</a></li></ul></li><li><a href="#yolov5">YOLOv5è¿è¡Œç¤ºä¾‹</a><ul><li><a href="#_3">åŠ è½½æ¨¡å‹</a></li><li><a href="#_4">å›¾åƒé¢„å¤„ç†</a></li><li><a href="#_5">æ¨¡å‹æ¨ç†</a></li><li><a href="#_6">æ¨¡å‹åå¤„ç†</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>ONNX Runtime Pythonç«¯ä¾§æ¨¡å‹éƒ¨ç½²YOLOv5</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2025-06-18
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      ai
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="onnx-runtime">ONNX Runtimeä»‹ç»</h2>
<p>ONNX Runtimeä¸ä¾èµ–äºPytorchã€tensorflowç­‰æœºå™¨å­¦ä¹ è®­ç»ƒæ¨¡å‹æ¡†æ¶ã€‚ä»–æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨CPUã€GPUã€NPUä¸Šè¿è¡Œæ¨¡å‹ã€‚é€šå¸¸ONNX Runtimeç”¨äºç«¯ä¾§è®¾å¤‡æ¨¡å‹çš„è¿è¡Œæ¨ç†ã€‚è¦ä½¿ç”¨ONNX Runtimeè¿è¡Œæ¨¡å‹ï¼Œä¸€èˆ¬çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç”¨ä½ æœ€å–œæ¬¢çš„æ¡†æ¶ï¼ˆå¦‚pytorchã€tensorflowã€paddleç­‰ï¼‰è®­ç»ƒä¸€ä¸ªæ¨¡å‹ã€‚</li>
<li>å°†æ¨¡å‹è½¬æ¢æˆ–å¯¼å‡ºä¸ºONNXæ ¼å¼ã€‚</li>
<li>åœ¨ç«¯ä¾§ä½¿ç”¨ONNX RuntimeåŠ è½½å¹¶è¿è¡Œæ¨¡å‹ã€‚</li>
</ul>
<p>æ¨¡å‹çš„è®­ç»ƒå’Œå¯¼å‡ºä¸ºONNXæ ¼å¼è¿™é‡Œå°±ä¸å†é˜è¿°äº†ã€‚ä¸‹é¢åŸºäºpythonåœ¨ç«¯ä¾§è¿è¡Œæ¨¡å‹çš„ç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span>
<span class="c1"># å¯¼å…¥numpyæ¨¡å—</span>
<span class="kn">import</span> <span class="nn">onnxruntime</span> <span class="k">as</span> <span class="nn">rt</span>
<span class="c1"># å¯¼å…¥onnxruntimeæ¨¡å—</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">rt</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span>
    <span class="s2">"logreg_iris.onnx"</span><span class="p">,</span> <span class="n">providers</span><span class="o">=</span><span class="n">rt</span><span class="o">.</span><span class="n">get_available_providers</span><span class="p">())</span>
<span class="c1"># åŠ è½½æ¨¡å‹logreg_iris.onnx</span>

<span class="n">input_name</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
<span class="c1"># è·å–æ¨¡å‹çš„è¾“å…¥åç§°ï¼Œå¯¹åº”çš„æ˜¯ä½¿ç”¨https://netron.app/ä¸­intput nameã€‚</span>

<span class="n">pred_onx</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="n">input_name</span><span class="p">:</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)})[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># è¿è¡Œæ¨¡å‹æ¨ç†ï¼Œè¿”å›ç»“æœåˆ°pred_onxä¸­</span>

<span class="nb">print</span><span class="p">(</span><span class="n">pred_onx</span><span class="p">)</span>
</code></pre></div>
<p>ä¸Šé¢ç»™å‡ºçš„pythonç¤ºä¾‹ä¸­ï¼Œç«¯ä¾§è¿è¡Œæ¨¡å‹å¯ä»¥æ€»ç»“ä¸º2ä¸ªæ­¥éª¤ã€‚åŠ è½½æ¨¡å‹ï¼Œæ¨¡å‹æ¨ç†ã€‚</p>
<h3 id="_1">åŠ è½½æ¨¡å‹</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">onnxruntime</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span>
    <span class="n">path_or_bytes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span>
    <span class="n">sess_options</span><span class="p">:</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">SessionOptions</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">providers</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">provider_options</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>path_or_bytesï¼š æ¨¡å‹æ–‡ä»¶åæˆ–è€…ONNXã€ORTæ ¼å¼äºŒè¿›åˆ¶ã€‚</li>
<li>sess_optionsï¼š ä¼šè¯é€‰é¡¹ï¼Œæ¯”å¦‚é…ç½®çº¿ç¨‹æ•°ã€ä¼˜å…ˆçº§ã€‚</li>
<li>providersï¼š æŒ‡å®šæ‰§è¡Œæä¾›è€…ä¼˜å…ˆçº§ï¼ˆ['CUDAExecutionProvider','CPUExecutionProvider']ï¼‰</li>
<li>provider_optionsï¼š å­—å…¸åºåˆ—ï¼Œä¸ºæ¯ä¸ªæä¾›è€…é…ç½®ä¸“å±å‚æ•°ï¼ˆå¦‚CUDAè®¾å¤‡IDï¼‰</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">options</span> <span class="o">=</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">SessionOptions</span><span class="p">()</span>
<span class="n">options</span><span class="o">.</span><span class="n">SetIntraOpNumThreads</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># å¤šè®¾å¤‡ä¼˜å…ˆçº§é…ç½®</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span>
    <span class="s2">"model.onnx"</span><span class="p">,</span>
    <span class="n">sess_options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
    <span class="n">providers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">'CUDAExecutionProvider'</span><span class="p">,</span> <span class="p">{</span><span class="s1">'device_id'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}),</span>
        <span class="s1">'CPUExecutionProvider'</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre></div>
<h3 id="_2">æ¨¡å‹æ¨ç†</h3>
<div class="codehilite"><pre><span></span><code><span class="n">outputs</span> <span class="o">=</span> <span class="n">senssion</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_names</span><span class="p">,</span> <span class="n">input_feed</span><span class="p">,</span> <span class="n">run_options</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>output_names:è¾“å‡ºèŠ‚ç‚¹åç§°ï¼Œå­—ç¬¦ä¸²åˆ—è¡¨,æŒ‡å®šéœ€è¦è·å–çš„è¾“å‡ºèŠ‚ç‚¹åç§°ï¼Œè‹¥ä¸ºNoneåˆ™è¿”å›æ‰€æœ‰è¾“å‡º</li>
<li>input_feed:è¾“å…¥æ•°æ®ï¼Œå­—å…¸ç±»å‹ï¼Œç»“æ„ä¸º{"è¾“å…¥èŠ‚ç‚¹å": numpyæ•°ç»„/ORTValue}ï¼Œå»ºè®®ä½¿ç”¨ORTValueå°è£…è¾“å…¥æ•°æ®ä»¥å‡å°‘CPU-GPUæ‹·è´å¼€é”€ã€‚</li>
<li>run_options:è¿è¡Œå‚æ•°ï¼Œå¦‚æ—¥å¿—çº§åˆ«ã€‚</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">onnxruntime</span> <span class="k">as</span> <span class="nn">ort</span>

<span class="c1"># åˆ›å»ºç¤ºä¾‹æ•°æ®</span>
<span class="n">cpu_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># è½¬æ¢ä¸ºGPUä¸Šçš„ORTValue</span>
<span class="n">gpu_ort_value</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">OrtValue</span><span class="o">.</span><span class="n">ortvalue_from_numpy</span><span class="p">(</span>
    <span class="n">cpu_data</span><span class="p">,</span>
    <span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">,</span>  <span class="c1"># å…³é”®å‚æ•°ï¼šæŒ‡å®šGPUè®¾å¤‡</span>
    <span class="n">device_id</span><span class="o">=</span><span class="mi">0</span>         <span class="c1"># GPUè®¾å¤‡IDï¼ˆå¤šå¡æ—¶æŒ‡å®šï¼‰</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">gpu_ort_value</span><span class="o">.</span><span class="n">device_name</span><span class="p">())</span>  <span class="c1"># è¾“å‡º: 'Cuda'</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">"output_name"</span><span class="p">],</span>
    <span class="p">{</span><span class="s2">"input_name"</span><span class="p">:</span> <span class="n">gpu_ort_value</span><span class="p">}</span>  <span class="c1"># é¿å…CPU-&gt;GPUæ‹·è´</span>
<span class="p">)</span>
</code></pre></div>
<p>åœ¨è¿è¡Œæ¨¡å‹æ˜¯ï¼Œéœ€è¦è·å–æ¨¡å‹çš„è¾“å…¥å’Œè¾“å‡ºåç§°ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨å¯¹åº”çš„å‡½æ•°session.get_inputs(),session.get_outputs()æ¥è·å–ã€‚inputså’Œoutputså‡½æ•°è¿”å›çš„æ˜¯onnxruntime.NodeArgç±»ï¼Œè¯¥ç±»æ˜¯ONNX Runtimeä¸­è¡¨ç¤ºè®¡ç®—å›¾èŠ‚ç‚¹è¾“å…¥/è¾“å‡ºå‚æ•°çš„æ ¸å¿ƒç±»ï¼Œè¯¥ç±»æœ‰3ä¸ªæˆå‘˜å˜é‡ï¼Œå¦‚ä¸‹ï¼š</p>
<ul>
<li>property nameï¼š å‚æ•°å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¯¹åº”è®¡ç®—å›¾ä¸­çš„èŠ‚ç‚¹åç§°ã€‚</li>
<li>property shapeï¼š å¼ é‡å½¢çŠ¶ã€‚</li>
<li>property typeï¼šæ•°æ®ç±»å‹ï¼ˆå¦‚tensor(float32)/tensor(int64)ï¼‰</li>
</ul>
<p>ä»¥ä¸‹æ˜¯è·å–è¾“å…¥åç§°å’Œè¾“å‡ºåç§°çš„ç¤ºä¾‹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">input_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
<span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()]</span>
</code></pre></div>
<p>è¯¦ç»†è¯·å‚è€ƒï¼š<a href="https://onnxruntime.ai/docs/api/python/api_summary.html">https://onnxruntime.ai/docs/api/python/api_summary.html</a></p>
<h2 id="yolov5">YOLOv5è¿è¡Œç¤ºä¾‹</h2>
<h3 id="_3">åŠ è½½æ¨¡å‹</h3>
<div class="codehilite"><pre><span></span><code><span class="n">session_options</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">SessionOptions</span><span class="p">()</span>
<span class="n">session_options</span><span class="o">.</span><span class="n">intra_op_num_threads</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># åŠ è½½ ONNX æ¨¡å‹</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span>
        <span class="s2">"yolov5_n.q.onnx"</span><span class="p">,</span>
        <span class="n">sess_options</span><span class="o">=</span><span class="n">session_options</span><span class="p">,</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s2">"XXXExecutionProvider"</span><span class="p">])</span>
</code></pre></div>
<p>åˆ›å»ºSessionOptionså¯¹è±¡ç”¨äºå®šåˆ¶åŒ–ä¼šè¯è¡Œä¸ºï¼Œé™åˆ¶ç®—å­å†…éƒ¨å¹¶è¡Œçº¿ç¨‹æ•°ä¸º1ï¼ŒåŠ è½½åä¸ºyolov5_n.q.onnxçš„é‡åŒ–ç‰ˆYOLOv5æ¨¡å‹ï¼ŒæŒ‡å®šè‡ªå®šä¹‰æ‰§è¡Œæä¾›è€…XXXExecutionProviderã€‚</p>
<h3 id="_4">å›¾åƒé¢„å¤„ç†</h3>
<div class="codehilite"><pre><span></span><code><span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<span class="c1">#image shape (375, 500, 3)</span>

<span class="n">image_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="c1">#image_shapeçš„å€¼(375, 500)ï¼Œå–å‰é¢2ä¸ªå€¼ä¸ºå›¾åƒçš„å®½é«˜</span>

<span class="c1"># è·å–å›¾åƒçš„å°ºå¯¸å¤§å°é«˜å’Œå®½ã€‚</span>
<span class="n">input_tensor</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

<span class="c1"># å›¾åƒé¢„å¤„ç†å‡½æ•°</span>
<span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="p">(</span><span class="mi">640</span><span class="p">,</span> <span class="mi">640</span><span class="p">)):</span>
    <span class="c1"># è°ƒæ•´å›¾åƒå¤§å°ä¸º640*640ï¼Œ</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">input_size</span><span class="p">)</span>
    <span class="c1"># è½¬æ¢é¢œè‰²ç©ºé—´RGB</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

    <span class="c1"># å½’ä¸€åŒ–å¤„ç†</span>
    <span class="c1">#astype(np.float32)å°†å›¾åƒåƒç´ å€¼ä»æ•´æ•°ç±»å‹ï¼ˆå¦‚uint8ï¼‰è½¬æ¢ä¸º32ä½æµ®ç‚¹æ•°ï¼Œ</span>
    <span class="c1">#é¿å…åç»­é™¤æ³•è¿ç®—çš„ç²¾åº¦æŸå¤±ï¼Œ/ 255.0å°†åƒç´ å€¼ä»[0,255]çš„åŸå§‹èŒƒå›´çº¿æ€§æ˜ å°„åˆ°[0,1]åŒºé—´ï¼Œ</span>
    <span class="c1">#ç¬¦åˆç¥ç»ç½‘ç»œè¾“å…¥çš„å…¸å‹æ•°å€¼èŒƒå›´è¦æ±‚</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>

    <span class="c1"># è½¬ç½®æ¨¡å‹ä¸ºCHWæ ¼å¼ï¼ŒåŸè¾“å…¥æ˜¯HWCæ ¼å¼ã€‚</span>
    <span class="c1"># è¾“å…¥çš„æ•°æ®æ˜¯ï¼ˆ640ï¼Œ640ï¼Œ3ï¼‰ï¼Œéœ€è¦è°ƒæ•´ä¸ºNCHWæ¨¡å‹æ ¼å¼ [batch, channel, height, width]</span>
    <span class="c1"># ä½¿ç”¨np.transposeè¿›è¡Œè½¬ç½®ï¼Œå˜æ¢æˆï¼ˆ3ï¼Œ640ï¼Œ640ï¼‰</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># æ¥ç€å†åŠ ä¸Šä¸€ä¸ªè½´å˜åŒ–æˆï¼ˆ1ï¼Œ3ï¼Œ640ï¼Œ640ï¼‰tensorã€‚</span>
    <span class="k">return</span> <span class="n">image</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/06/wp_editor_md_a085673644d5a2a3b34c1e9635b98c0e.jpg"><img alt="" src="assets/doc/04-ai/aiåº”ç”¨/ç«¯ä¾§onnx-runtime-pythonæ¨¡å‹æ¨ç†/images/wp_editor_md_a085673644d5a2a3b34c1e9635b98c0e.jpg"/></a></p>
<p>å¦‚ä½•ç†è§£æ·±åº¦å­¦ä¹ ä¸­çš„è½´äº†ï¼Ÿ åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œè½´å¯ä»¥ç†è§£ä¸ºç»´åº¦ã€‚å¦‚ä¸Šå›¾æ˜¯ä¸€ä¸ªNCHWæ’å¸ƒçš„æ ¼å¼ï¼ŒæŠŠNå½“æˆç¬¬ä¸€ä¸ªç»´åº¦å³ä½è½´0ï¼ŒCç¬¬äºŒç»´åº¦å³ä¸ºè½´1ï¼ŒHç¬¬ä¸‰ç»´åº¦å³ä¸ºè½´2ï¼ŒWä¸ºç¬¬å››ç»´åº¦å³ä¸ºè½´3ã€‚np.expand_dims(image, axis=0)å³æ‹“å±•äº†è½´0ï¼ŒåŸæ¥åªæœ‰3ä¸ªç»´åº¦ç°åœ¨å˜æˆ4ä¸ªç»´åº¦äº†ï¼ŒNä¸º1ã€‚è¿˜å¯ä»¥æŒ‰ç…§æŒ‡å®šçš„è½´è¿›è¡Œæ±‚å’Œï¼Œå³åšå‹ç¼©ã€‚æ‰§è¡Œnp.sum(data, axis=0)æ—¶ï¼Œä¹Ÿå°±æ˜¯æ²¿ç€Nçš„ç»´åº¦å°±è¡Œå‹ç¼©æ±‚å’Œï¼Œå°±å˜æˆå¦‚ä¸Šå›¾ã€‚ç”±åŸæ¥çš„ï¼ˆN,C,W,Hï¼‰å˜æˆäº†(C',W',H'),å³Nä¸ªCWHä¸­çš„å„è‡ªç›¸åŠ ã€‚å¦‚æœæ˜¯np.sum(data,axis=1)ï¼Œé‚£å°±æ˜¯æŒ‰ç…§Cç»´åº¦æ–¹å‘è¿›è¡Œç›¸åŠ ï¼Œç»“æœå°±æ˜¯ï¼ˆN,W,Hï¼‰,å³å¦‚RGBæ ¼å¼å°±æ˜¯æ¯ä¸ªå›¾åƒRGB 3é€šé“çš„åƒç´ ç›¸åŠ ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/06/wp_editor_md_7eb3980a9c98c242d3ac6e8e422fa18f.jpg"><img alt="" src="assets/doc/04-ai/aiåº”ç”¨/ç«¯ä¾§onnx-runtime-pythonæ¨¡å‹æ¨ç†/images/wp_editor_md_7eb3980a9c98c242d3ac6e8e422fa18f.jpg"/></a></p>
<h3 id="_5">æ¨¡å‹æ¨ç†</h3>
<p>æ¨¡å‹æ¨ç†å‰ï¼Œéœ€è¦è·å–è®¡ç®—å›¾è¾“å…¥å’Œè¾“å…¥çš„åç§°</p>
<div class="codehilite"><pre><span></span><code><span class="n">input_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
<span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'input name'</span><span class="p">,</span> <span class="n">input_name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'output name'</span><span class="p">,</span> <span class="n">output_names</span><span class="p">)</span>
</code></pre></div>
<p>è¾“å‡ºç»“æœä¸ä¸‹å›¾å¯¹åº”ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="nb">input</span> <span class="n">name</span> <span class="nb">input</span>
<span class="n">output</span> <span class="n">name</span> <span class="p">[</span><span class="s1">'dets'</span><span class="p">,</span> <span class="s1">'labels'</span><span class="p">]</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/06/wp_editor_md_0031f187b9e1a6957df1a42c8444329f.jpg"><img alt="" src="assets/doc/04-ai/aiåº”ç”¨/ç«¯ä¾§onnx-runtime-pythonæ¨¡å‹æ¨ç†/images/wp_editor_md_0031f187b9e1a6957df1a42c8444329f.jpg"/></a></p>
<p>è·å–åˆ°intput_nameå’Œouput_namesåï¼Œå³å¯è°ƒç”¨è¿è¡Œæ¨ç†ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">outputs</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_names</span><span class="p">,</span> <span class="p">{</span><span class="n">input_name</span><span class="p">:</span> <span class="n">input_tensor</span><span class="p">})</span>
</code></pre></div>
<h3 id="_6">æ¨¡å‹åå¤„ç†</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># æŠŠbatchè¿™ä¸ªç»´åº¦å»æ‰</span>
<span class="n">dets</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">labels_pred</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="c1">#å°†åæ ‡è¿›è¡Œç¼©æ”¾ä»¥é€‚åº”å®é™…å›¾ç‰‡çš„å¤§å°ã€‚</span>
<span class="n">input_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">640</span><span class="p">,</span> <span class="mi">640</span><span class="p">)</span>
<span class="n">scale_x</span> <span class="o">=</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">input_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">scale_y</span> <span class="o">=</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">input_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">dets</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale_x</span>
<span class="n">dets</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale_y</span>
<span class="n">dets</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale_x</span>
<span class="n">dets</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale_y</span>
</code></pre></div>
<p>æ¨¡å‹outputsæœ‰ä¸¤ä¸ªè¾“å‡ºï¼Œä¸€ä¸ªæ˜¯detsï¼Œè¿™æ˜¯ä¸€ä¸ªäºŒä½æ•°ç»„dets[n][5],å…¶ä¸­det[5]åŒ…å«äº†åæ ‡x1, y1, x2, y2ï¼Œscore,å‰é¢4ä¸ªé¢„é€‰æ¡†çš„åæ ‡ï¼Œåé¢ä¸€ä¸ªä¸ºé¢„é€‰æ¡†çš„åˆ†æ•°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">visualize_results</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dets</span><span class="p">,</span> <span class="n">labels_pred</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">conf_threshold</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dets</span><span class="p">)):</span>
        <span class="n">det</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">det</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="c1">#æ¯ä¸ªæ¡†çš„åˆ†æ•°</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">conf_threshold</span><span class="p">:</span> <span class="c1">#å°äºåˆ†æ•°çš„å‰”é™¤</span>
            <span class="n">class_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">labels_pred</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">det</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">class_id</span><span class="p">]</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="mi">10</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>
</code></pre></div>
<p>æ ¹æ®é˜ˆå€¼åˆ†æ•°è¿›è¡Œç”»æ¡†ï¼Œæœ€ç»ˆå®Œæˆç»“æœçš„åå¤„ç†ï¼Œæ³¨æ„ä¸Šé¢å¹¶æ²¡æœ‰è¿›è¡Œæå¤§å€¼æŠ‘åˆ¶ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="onnx-runtime-c-ç«¯ä¾§æ¨¡å‹éƒ¨ç½²yolov5.html">â† ONNX Runtime C++ç«¯ä¾§æ¨¡å‹éƒ¨ç½²YOLOv5</a>
    <a class="next" href="ç«¯ä¾§vscode-aiå¼€å‘ç¯å¢ƒæ­å»º.html">ç«¯ä¾§vscode AIå¼€å‘ç¯å¢ƒæ­å»º â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

