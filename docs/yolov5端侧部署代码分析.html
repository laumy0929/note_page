<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>YOLOv5ç«¯ä¾§éƒ¨ç½²ä»£ç åˆ†æ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">æ¨¡å‹æµç¨‹</a><ul></ul></li><li><a href="#_2">æ¨¡å‹è¾“å…¥é¢„å¤„ç†</a><ul></ul></li><li><a href="#_3">æ¨¡å‹åå¤„ç†</a><ul><li><a href="#_4">è®¡ç®—å…ˆéªŒæ¡†çŸ©å½¢åæ ‡</a></li><li><a href="#_5">éæå¤§å€¼æŠ‘åˆ¶</a></li><li><a href="#_6">ç»˜åˆ¶ç›®æ ‡æ¡†</a></li></ul></li><li><a href="#opencv">opencvå‚è€ƒå‡½æ•°</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>YOLOv5ç«¯ä¾§éƒ¨ç½²ä»£ç åˆ†æ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2025-06-12
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      ai
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">æ¨¡å‹æµç¨‹</h2>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">NPUåˆå§‹åŒ–</span>
<span class="n">NpuUint</span><span class="w"> </span><span class="n">npu_uint</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">npu_uint</span><span class="p">.</span><span class="n">npu_init</span><span class="p">();</span>

<span class="mf">2.</span><span class="n">æ ¹æ®ä¼ å…¥çš„æ¨¡å‹æ–‡ä»¶</span><span class="err">ï¼Œ</span><span class="n">åˆ›å»ºç½‘ç»œ</span>
<span class="n">NetworkItem</span><span class="w"> </span><span class="n">yolov5</span><span class="p">;</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yolov5</span><span class="p">.</span><span class="n">network_create</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span><span class="w"> </span><span class="n">network_id</span><span class="p">);</span>
<span class="w">    </span><span class="n">vip_create_network</span><span class="p">()</span>
<span class="w">    </span><span class="n">network_create_io_buffer</span><span class="p">()</span><span class="c1">//åˆ›å»ºè¾“å…¥buffer</span>

<span class="mf">3.</span><span class="w"> </span><span class="n">å‡†å¤‡å’ŒéªŒè¯ç½‘ç»œçš„é…ç½®</span><span class="err">ï¼Œ</span><span class="n">è¿›è¡Œè¿è¡Œå‰çš„å‡†å¤‡</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yolov5</span><span class="p">.</span><span class="n">network_prepare</span><span class="p">();</span>

<span class="mf">4.</span><span class="w"> </span><span class="n">è·å–è¾“å…¥çš„buffer</span><span class="err">ï¼Œ</span><span class="n">bufferåœ¨æ­¥éª¤2ä¸­åˆ›å»ºçš„çš„</span><span class="err">ã€‚</span>
<span class="n">yolov5</span><span class="p">.</span><span class="n">get_network_input_buff_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">input_buffer_ptr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">input_buffer_size</span><span class="p">);</span>
<span class="n">yolov5_preprocess_no_copy</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span><span class="w"> </span><span class="n">input_buffer_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">input_buffer_size</span><span class="p">);</span>
<span class="w">    </span><span class="n">get_input_data</span><span class="w"> </span><span class="c1">//å¯¹è¾“å…¥å›¾åƒè¿›è¡Œé¢„å¤„ç†ï¼Œè°ƒæ•´åˆé€‚çš„å°ºå¯¸ï¼Œè·å–ä¸€ä¸ªè¾“å…¥æŒ‡é’ˆã€‚</span>

<span class="mf">5.</span><span class="n">åˆ›å»ºä¸€ä¸ªè¾“å‡ºbuffer</span><span class="err">ï¼Œ</span><span class="n">å®é™…å·²ç»é¢„åˆ†é…å¥½äº†</span><span class="err">ï¼Œ</span><span class="n">output_dataæ•°ç»„ä¸­å­˜å‚¨çš„æ˜¯æŒ‡é’ˆ</span><span class="err">ã€‚</span>
<span class="kt">int</span><span class="w"> </span><span class="n">output_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yolov5</span><span class="p">.</span><span class="n">get_output_cnt</span><span class="p">();</span>
<span class="kt">float</span><span class="w"> </span><span class="o">**</span><span class="n">output_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="p">[</span><span class="n">output_cnt</span><span class="p">]();</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">output_cnt</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="n">output_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">yolov5</span><span class="p">.</span><span class="n">m_output_data_len</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>

<span class="c1">//æ¨¡å‹è·‘å¤šå°‘æ¬¡ï¼Ÿloop_count</span>
<span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;</span><span class="n">loop_count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">count</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="mf">5.</span><span class="w"> </span><span class="n">é…ç½®ç½‘ç»œçš„è¾“å…¥å’Œè¾“å‡ºç¼“å­˜åŒº</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yolov5</span><span class="p">.</span><span class="n">network_input_output_set</span><span class="p">()</span>
<span class="w">        </span><span class="n">vip_set_input</span>
<span class="w">        </span><span class="n">vip_set_output</span>
<span class="w">    </span><span class="mf">6.</span><span class="w"> </span><span class="n">æäº¤è¿è¡Œç½‘ç»œçš„ä»»åŠ¡</span><span class="err">ï¼Œ</span><span class="n">å¼€å§‹è¿è¡Œç½‘ç»œ</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yolov5</span><span class="p">.</span><span class="n">network_run</span><span class="p">();</span>
<span class="w">    </span><span class="mf">7.</span><span class="w"> </span><span class="n">è·å–è¾“å‡º</span><span class="err">ï¼Œ</span><span class="n">è¾“å‡ºæ˜¯ä»€ä¹ˆæ ·çš„æ ¼å¼</span><span class="err">ï¼Ÿ</span>
<span class="w">    </span><span class="n">yolov5</span><span class="p">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">output_data</span><span class="p">);</span>
<span class="w">    </span><span class="mf">8.</span><span class="n">åå¤„ç†</span>
<span class="w">    </span><span class="n">yolov5_postprocess</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span><span class="w"> </span><span class="n">output_data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_2">æ¨¡å‹è¾“å…¥é¢„å¤„ç†</h2>
<p>è¾“å…¥æ•°æ®é¢„å¤„ç†</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">get_input_data</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">image_file</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">input_data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">sample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">imread</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sample</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"cv::imread %s failed</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">image_file</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">img</span><span class="p">;</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="w"> </span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">COLOR_BGR2RGB</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* letterbox process to support different letterbox size */</span>

<span class="w">    </span><span class="c1">//æŒ‰æ¯”ä¾‹ç¼©æ”¾è¾“å…¥å›¾ç‰‡</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">scale_letterbox</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">img</span><span class="p">.</span><span class="n">rows</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">img</span><span class="p">.</span><span class="n">cols</span><span class="p">)){</span>
<span class="w">        </span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">img</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">img</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">resize_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">img</span><span class="p">.</span><span class="n">cols</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">resize_rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">img</span><span class="p">.</span><span class="n">rows</span><span class="p">);</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">(</span><span class="n">resize_cols</span><span class="p">,</span><span class="w"> </span><span class="n">resize_rows</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// åˆ›å»ºMatï¼Œä½†å¹¶ä¸ä¼šè¿›è¡Œå†…å­˜æ‹·è´è€Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ª å¤´éƒ¨æŒ‡é’ˆï¼ˆheaderï¼‰</span>
<span class="w">    </span><span class="c1">//æ¥å¼•ç”¨ input_data æŒ‡å‘çš„å†…å­˜ã€‚</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">img_new</span><span class="p">(</span><span class="n">letterbox_cols</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="p">,</span><span class="w"> </span><span class="n">CV_8UC3</span><span class="p">,</span><span class="w"> </span><span class="n">input_data</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//ä¿æŒåŸå§‹å›¾åƒé•¿å®½æ¯”çš„åŒæ—¶ç¼©æ”¾åˆ°ç›®æ ‡å°ºå¯¸ï¼Œä¸è¶³éƒ¨åˆ†ç”¨ç°è‰²(114)å¡«å……</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize_rows</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize_rows</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize_cols</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize_cols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Letterbox filling</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="n">img_new</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">bot</span><span class="p">,</span><span class="w"> </span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="n">right</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="mi">114</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_3">æ¨¡å‹åå¤„ç†</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">yolov5_postprocess</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">imagepath</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">**</span><span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">imread</span><span class="p">(</span><span class="n">imagepath</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">objects</span><span class="p">;</span>
<span class="w">    </span><span class="n">detect_yolov5_rt</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">);</span>
<span class="w">    </span><span class="n">draw_objects</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">objects</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">detect_yolov5_rt</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">bgr</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">**</span><span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">Tbegin</span><span class="p">,</span><span class="w"> </span><span class="n">Tend</span><span class="p">;</span>

<span class="w">    </span><span class="mf">1.</span><span class="n">ä½¿ç”¨</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="w"> </span><span class="n">è¿›è¡Œæ—¶é—´è®¡æ—¶</span><span class="err">ï¼Œ</span><span class="n">è®¡ç®—å‡½æ•°æ‰§è¡Œæ—¶é—´</span><span class="err">ã€‚</span>
<span class="w">        </span><span class="n">Tbegin</span><span class="w"> </span><span class="n">è®°å½•å¼€å§‹æ—¶é—´</span><span class="err">ï¼Œ</span><span class="n">Tend</span><span class="w"> </span><span class="n">ç”¨äºè®°å½•ç»“æŸæ—¶é—´</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">Tbegin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>

<span class="w">    </span><span class="mf">2.</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="n">æ˜¯ä¸€ä¸ªä¸‰ç»´æ•°ç»„</span><span class="err">ï¼Œ</span><span class="n">é€šå¸¸åŒ…å«3ä¸ªç‰¹å¾å›¾</span><span class="err">ï¼Œ</span><span class="n">æ¯ä¸ªç‰¹å¾å›¾å¯¹åº”ä¸åŒå°ºåº¦çš„è¾“å‡ºæ•°æ®</span><span class="err">ã€‚</span>
<span class="w">        </span><span class="n">æ¯ä¸ªç‰¹å¾å›¾ä¸­çš„æ•°æ®ä¼šè¢«é€æ­¥è§£æ</span><span class="err">ï¼Œ</span><span class="n">ä»¥å¾—åˆ°ç›®æ ‡ç‰©ä½“çš„ä½ç½®å’Œç±»åˆ«ä¿¡æ¯</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w">  </span><span class="o">*</span><span class="n">p8_data_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">p16_data_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">p32_data_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// set default letterbox size</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LETTERBOX_ROWS</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LETTERBOX_COLS</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* postprocess */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">prob_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCORE_THRESHOLD</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//ç‰©ä½“çš„ç½®ä¿¡åº¦é˜ˆå€¼ï¼Œä½äºè¯¥å€¼çš„ç›®æ ‡å°†è¢«ä¸¢å¼ƒã€‚</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">nms_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NMS_THRESHOLD</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//ç”¨äºéæœ€å¤§æŠ‘åˆ¶çš„é˜ˆå€¼ï¼Œç”¨äºå»é™¤é‡å¤çš„æ£€æµ‹æ¡†ï¼Œä¿ç•™å…·æœ‰æœ€é«˜ç½®ä¿¡åº¦çš„æ¡†ã€‚</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">proposals</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">objects8</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">objects16</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">objects32</span><span class="p">;</span>

<span class="w">    </span><span class="mf">3.</span><span class="n">generate_proposals_rtæ˜¯ä¸€ä¸ªç”¨äºä»æ¯ä¸ªå°ºåº¦çš„è¾“å‡ºç‰¹å¾å›¾ä¸­ç”Ÿæˆå€™é€‰æ¡†</span><span class="err">ï¼ˆ</span><span class="n">proposals</span><span class="err">ï¼‰</span>
<span class="w">    </span><span class="n">å‡½æ•°</span><span class="err">ã€‚</span><span class="n">æ¯ä¸ªå°ºåº¦</span><span class="err">ï¼ˆ</span><span class="mi">8</span><span class="n">x8</span><span class="err">ã€</span><span class="mi">16</span><span class="n">x16</span><span class="w"> </span><span class="n">å’Œ</span><span class="w"> </span><span class="mi">32</span><span class="n">x32</span><span class="err">ï¼‰</span><span class="n">éƒ½ä¼šè°ƒç”¨è¯¥å‡½æ•°</span><span class="err">ï¼Œ</span><span class="n">å¹¶å°†æ£€æµ‹åˆ°çš„ç‰©ä½“å­˜å‚¨åœ¨å¯¹åº”</span>
<span class="w">    </span><span class="n">çš„objectså‘é‡ä¸­</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">generate_proposals_rt</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">p32_data_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">prob_threshold</span><span class="p">,</span><span class="w"> </span><span class="n">objects32</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="p">);</span>
<span class="w">    </span><span class="n">proposals</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">proposals</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">objects32</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">objects32</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="w">    </span><span class="n">generate_proposals_rt</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">p16_data_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">prob_threshold</span><span class="p">,</span><span class="w"> </span><span class="n">objects16</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="p">);</span>
<span class="w">    </span><span class="n">proposals</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">proposals</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">objects16</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">objects16</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="w">    </span><span class="n">generate_proposals_rt</span><span class="p">(</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w">  </span><span class="n">p8_data_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">prob_threshold</span><span class="p">,</span><span class="w"> </span><span class="n">objects8</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="p">);</span>
<span class="w">    </span><span class="n">proposals</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">proposals</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">objects8</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">objects8</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>

<span class="w">    </span><span class="mf">4.</span><span class="n">å°†å€™é€‰æ¡†æŒ‰ç…§ç½®ä¿¡åº¦æ’åº</span><span class="err">ï¼Œ</span><span class="n">ä»é«˜åˆ°ä½</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">qsort_descent_inplace</span><span class="p">(</span><span class="n">proposals</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">picked</span><span class="p">;</span>
<span class="w">    </span><span class="mf">5.</span><span class="n">è¿›è¡Œéæœ€å¤§æŠ‘åˆ¶</span><span class="err">ï¼Œ</span><span class="n">å»é™¤å†—ä½™çš„å€™é€‰æ¡†</span><span class="err">ï¼Œ</span><span class="n">ä¿ç•™ç½®ä¿¡åº¦è¾ƒé«˜ä¸”æ²¡æœ‰é‡å è¿‡å¤šçš„æ¡†</span><span class="err">ã€‚</span>
<span class="w">      </span><span class="n">picked</span><span class="w"> </span><span class="n">å‘é‡å­˜å‚¨æœ€ç»ˆé€‰æ‹©çš„æ¡†çš„ç´¢å¼•</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">nms_sorted_bboxes</span><span class="p">(</span><span class="n">proposals</span><span class="p">,</span><span class="w"> </span><span class="n">picked</span><span class="p">,</span><span class="w"> </span><span class="n">nms_threshold</span><span class="p">);</span>

<span class="w">    </span><span class="mf">6.</span><span class="w"> </span><span class="n">è°ƒæ•´æ¡†çš„ä½ç½®</span><span class="err">ï¼ˆ</span><span class="n">ä»</span><span class="w"> </span><span class="n">letterbox</span><span class="w"> </span><span class="n">å¤§å°åˆ°åŸå§‹å›¾åƒå¤§å°</span><span class="err">ï¼‰</span>
<span class="w">    </span><span class="n">è®¡ç®—è¾“å…¥å›¾åƒä¸</span><span class="w"> </span><span class="n">letterbox</span><span class="w"> </span><span class="n">å¤§å°ä¹‹é—´çš„ç¼©æ”¾æ¯”ç‡</span><span class="err">ã€‚</span><span class="n">letterbox</span><span class="w"> </span><span class="n">æ˜¯æŒ‡å›¾åƒå¡«å……åˆ°</span>
<span class="w">    </span><span class="n">å›ºå®šå°ºå¯¸æ—¶</span><span class="err">ï¼Œ</span><span class="n">ä¿æŒåŸå›¾å®½é«˜æ¯”çš„çŸ©å½¢åŒºåŸŸ</span><span class="err">ã€‚</span><span class="n">è®¡ç®—ç¼©æ”¾åçš„å›¾åƒå°ºå¯¸</span><span class="err">ï¼Œ</span><span class="n">å¹¶æ ¹æ®ç¼©æ”¾æ¯”ä¾‹</span>
<span class="w">    </span><span class="n">è°ƒæ•´æ¡†çš„ä½ç½®</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="cm">/* yolov5 draw the result */</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">scale_letterbox</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">resize_rows</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">resize_cols</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">rows</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">cols</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">resize_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">cols</span><span class="p">);</span>
<span class="w">    </span><span class="n">resize_rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">rows</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tmp_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize_rows</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tmp_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize_cols</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">ratio_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">bgr</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">resize_rows</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">ratio_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">bgr</span><span class="p">.</span><span class="n">cols</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">resize_cols</span><span class="p">;</span>

<span class="w">    </span><span class="mf">7.</span><span class="w"> </span><span class="n">ä¿®æ­£ç›®æ ‡æ¡†çš„ä½ç½®</span><span class="p">.</span><span class="n">picked</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="n">è¡¨ç¤ºæœ€ç»ˆé€‰ä¸­çš„ç›®æ ‡æ¡†æ•°é‡</span><span class="err">ã€‚</span><span class="n">å¯¹äºæ¯ä¸ªé€‰</span>
<span class="w">    </span><span class="n">ä¸­çš„ç›®æ ‡æ¡†</span><span class="err">ï¼ˆ</span><span class="n">é€šè¿‡</span><span class="w"> </span><span class="n">picked</span><span class="w"> </span><span class="n">å‘é‡ç´¢å¼•</span><span class="err">ï¼‰ï¼Œ</span><span class="n">è°ƒæ•´å…¶åæ ‡</span><span class="err">ï¼Œ</span><span class="n">ä»</span><span class="w"> </span><span class="n">letterbox</span><span class="w"> </span><span class="n">åæ ‡ç³»è½¬æ¢å›</span>
<span class="w">    </span><span class="n">åŸå›¾åæ ‡ç³»</span><span class="err">ã€‚</span><span class="n">é€šè¿‡è®¡ç®—å¾—åˆ°çš„</span><span class="w"> </span><span class="n">ratio_x</span><span class="w"> </span><span class="n">å’Œ</span><span class="w"> </span><span class="n">ratio_y</span><span class="w"> </span><span class="n">æ¥è°ƒæ•´åæ ‡</span><span class="err">ï¼Œ</span><span class="n">ç¡®ä¿ç›®æ ‡æ¡†ä¸åŸå§‹</span>
<span class="w">    </span><span class="n">å›¾åƒå¤§å°ä¸€è‡´</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picked</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">    </span><span class="n">objects</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proposals</span><span class="p">[</span><span class="n">picked</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

<span class="w">        </span><span class="n">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp_w</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ratio_x</span><span class="p">;</span>
<span class="w">        </span><span class="n">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">y0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp_h</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ratio_y</span><span class="p">;</span>
<span class="w">        </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp_w</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ratio_x</span><span class="p">;</span>
<span class="w">        </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">y1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp_h</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ratio_y</span><span class="p">;</span>

<span class="w">        </span><span class="n">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">bgr</span><span class="p">.</span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="mf">0.f</span><span class="p">);</span>
<span class="w">        </span><span class="n">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">bgr</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="mf">0.f</span><span class="p">);</span>
<span class="w">        </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">bgr</span><span class="p">.</span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="mf">0.f</span><span class="p">);</span>
<span class="w">        </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">bgr</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="mf">0.f</span><span class="p">);</span>

<span class="w">        </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x0</span><span class="p">;</span>
<span class="w">        </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y0</span><span class="p">;</span>
<span class="w">        </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x0</span><span class="p">;</span>
<span class="w">        </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="mf">8.</span><span class="w"> </span><span class="n">è®¡ç®—å‡½æ•°æ‰§è¡Œæ—¶é—´</span><span class="err">ï¼Œ</span><span class="n">å¹¶è¾“å‡ºæ£€æµ‹åˆ°çš„ç›®æ ‡æ•°ç›®</span>
<span class="w">    </span><span class="n">Tend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="w"> </span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">Tend</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Tbegin</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"detection num: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>è¯¥å‡½æ•°ä¸»è¦ç”¨äºå¤„ç† YOLOv5 æ¨¡å‹çš„è¾“å‡ºç»“æœï¼Œé€šè¿‡ä¸‰ä¸ªä¸åŒå°ºåº¦çš„è¾“å‡ºç‰¹å¾å›¾æ¥ç”Ÿæˆå€™é€‰æ¡†ï¼Œç„¶åä½¿ç”¨éæœ€å¤§æŠ‘åˆ¶ï¼ˆNMSï¼‰å»é™¤å†—ä½™æ¡†ï¼Œæœ€åå°†ç›®æ ‡æ¡†çš„åæ ‡ä» letterbox åæ ‡ç³»è½¬æ¢å›åŸå§‹å›¾åƒçš„åæ ‡ç³»ã€‚è¯¥å‡½æ•°çš„æ ¸å¿ƒä»»åŠ¡æ˜¯ç›®æ ‡æ£€æµ‹çš„åå¤„ç†ï¼ŒåŒ…æ‹¬ç­›é€‰é«˜ç½®ä¿¡åº¦æ¡†ã€å»é™¤é‡å¤æ¡†ã€è°ƒæ•´æ¡†ä½ç½®ç­‰æ­¥éª¤ã€‚</p>
<h3 id="_4">è®¡ç®—å…ˆéªŒæ¡†çŸ©å½¢åæ ‡</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">generate_proposals_rt</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">stride</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">feat</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">prob_threshold</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">objects</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">int</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">anchors</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span><span class="p">,</span><span class="w"> </span><span class="mi">62</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">59</span><span class="p">,</span><span class="w"> </span><span class="mi">119</span><span class="p">,</span><span class="w"> </span><span class="mi">116</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="mi">156</span><span class="p">,</span><span class="w"> </span><span class="mi">198</span><span class="p">,</span><span class="w"> </span><span class="mi">373</span><span class="p">,</span><span class="w"> </span><span class="mi">326</span><span class="p">};</span>
<span class="w">    </span><span class="c1">//YOLOé¢„å®šä¹‰çš„anchorå°ºå¯¸ï¼Œå…±9ç»„(æ¯ç»„å®½é«˜)ï¼Œ18ä¸ªå€¼</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">anchor_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="c1">//3ä¸ªå…ˆéªŒæ¡†</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">feat_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">stride</span><span class="p">;</span><span class="w"> </span><span class="c1">//è®¡ç®—ç‰¹å¾å›¾å¤§å°ï¼Œå¦‚æœæ˜¯ä¸‹é‡‡æ ·8å€</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">feat_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">stride</span><span class="p">;</span><span class="w"> </span><span class="c1">//é‚£å°±æ˜¯80 * 80</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cls_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CLASS_NUM</span><span class="p">;</span><span class="w"> </span><span class="c1">//åˆ†ç±»æ•°é‡ï¼Œé»˜è®¤æ˜¯80</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">anchor_group</span><span class="p">;</span><span class="w"> </span><span class="c1">//å¯¹å…ˆéªŒæ¡†è¿›è¡Œåˆ†ç»„</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stride</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">        </span><span class="n">anchor_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stride</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span>
<span class="w">        </span><span class="n">anchor_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stride</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="w">        </span><span class="n">anchor_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//åSigmoidå‡½æ•°,å°†0~1çš„è¾“å…¥è½¬åŒ–ä¸ºåŸå§‹å€¼</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">deprob_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">desigmoid</span><span class="p">(</span><span class="n">prob_threshold</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//ç‰¹å¾å›¾çš„å°ºå¯¸å¤§å°ï¼Œå¦‚æœæ˜¯8å€ä¸‹é‡‡æ ·å°±æ˜¯80*80=6400ä»½</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">feat_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">feat_w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">feat_h</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//è®¡ç®—å•ä¸ªanchorçš„ç‰¹å¾æ•°æ®æ€»é‡ï¼Œç”¨äºå®šä½å†…å­˜ä¸­ä¸åŒanchorçš„åç§»ä½ç½®</span>
<span class="w">    </span><span class="c1">//é€šè¿‡feat_ptr + feat_size_cls_5 * nå¯ç²¾ç¡®è®¿é—®ç¬¬nä¸ªanchorçš„é¢„æµ‹æ•°æ®</span>
<span class="w">    </span><span class="c1">//feat_size_cls_5 = 80*80*85 = 544000</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">feat_size_cls_5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">feat_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">cls_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//YOLOv5çš„è¾“å‡ºç‰¹å¾å›¾æŒ‰(cls_num+5)*anchor_num*feat_sizeç»„ç»‡</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">feat_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">feat</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//å°†åŸå§‹ä¸€ç»´ç‰¹å¾æ•°ç»„feat_ptrè½¬æ¢ä¸º3ä¸ªäºŒç»´çŸ©é˜µanchor_0/1/2ï¼Œæ¯ä¸ªçŸ©é˜µç»´åº¦ä¸º(cls_num+5)Ã—feat_size</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">anchor_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">((</span><span class="n">cls_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="n">feat_size</span><span class="p">,</span><span class="w"> </span><span class="n">CV_32FC1</span><span class="p">,</span><span class="w"> </span><span class="n">feat_ptr</span><span class="p">);</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">anchor_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">((</span><span class="n">cls_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="n">feat_size</span><span class="p">,</span><span class="w"> </span><span class="n">CV_32FC1</span><span class="p">,</span><span class="w"> </span><span class="n">feat_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">feat_size_cls_5</span><span class="p">);</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">anchor_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">((</span><span class="n">cls_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="n">feat_size</span><span class="p">,</span><span class="w"> </span><span class="n">CV_32FC1</span><span class="p">,</span><span class="w"> </span><span class="n">feat_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">feat_size_cls_5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="w">     </span><span class="c1">//anchor_0ç›´æ¥å¼•ç”¨feat_ptrèµ·å§‹åœ°å€ï¼Œå¯¹åº”ç¬¬ä¸€ä¸ªanchorçš„é¢„æµ‹æ•°æ®ã€‚</span>
<span class="w">     </span><span class="c1">//anchor_1é€šè¿‡feat_ptr + feat_size_cls_5åç§»ï¼Œå®šä½åˆ°ç¬¬äºŒä¸ªanchorçš„æ•°æ®å—ã€‚</span>
<span class="w">     </span><span class="c1">//anchor_2ä½¿ç”¨feat_size_cls_5*2åç§»é‡è®¿é—®ç¬¬ä¸‰ä¸ªanchoræ•°æ®ã€‚</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">transpose</span><span class="p">(</span><span class="n">anchor_0</span><span class="p">,</span><span class="w"> </span><span class="n">anchor_0</span><span class="p">);</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">transpose</span><span class="p">(</span><span class="n">anchor_1</span><span class="p">,</span><span class="w"> </span><span class="n">anchor_1</span><span class="p">);</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">transpose</span><span class="p">(</span><span class="n">anchor_2</span><span class="p">,</span><span class="w"> </span><span class="n">anchor_2</span><span class="p">);</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">anchor_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">anchor_0</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">anchor_1</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">anchor_2</span><span class="p">.</span><span class="n">data</span><span class="p">};</span>
<span class="w">    </span><span class="c1">//åˆ›å»ºfloat*ç±»å‹çš„æ•°ç»„anchor_data[3]ï¼Œå­˜å‚¨3ä¸ªé”šç‚¹çŸ©é˜µçš„æ•°æ®æŒ‡é’ˆã€‚</span>

<span class="w">    </span><span class="c1">//ä¸‰é‡å¾ªç¯åˆ†åˆ«éå†ç‰¹å¾å›¾é«˜åº¦(feat_h)ã€å®½åº¦(feat_w)å’Œé”šç‚¹æ•°é‡(anchor_num)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">feat_h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">h</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">h_feat_w_cls_5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">feat_w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">cls_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//h_feat_w_cls_5è®¡ç®—å½“å‰è¡Œåœ¨ç‰¹å¾å›¾ä¸­çš„å†…å­˜åç§»é‡ï¼Œ</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">feat_w</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">w_cls_5</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">cls_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">            </span><span class="c1">//w_cls_5è®¡ç®—å½“å‰åˆ—åœ¨è¡Œå†…çš„åç§»é‡</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">anchor_num</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">a</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">//process cls score</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">class_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">class_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">FLT_MAX</span><span class="p">;</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">a_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_feat_w_cls_5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_cls_5</span><span class="p">;</span>
<span class="w">                </span><span class="c1">//å®šä½åˆ°å½“å‰é”šç‚¹çš„ç±»åˆ«åˆ†æ•°èµ·å§‹ä½ç½®ï¼ˆ+4è·³è¿‡å‰4ä¸ªåæ ‡å‚æ•°ï¼‰</span>
<span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">feat_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anchor_data</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">                </span><span class="c1">//éå†æ‰€æœ‰ç±»åˆ«(cls_num)ï¼Œé€šè¿‡æ¯”è¾ƒ*(feat_ptr + s + 1)è·</span>
<span class="w">                </span><span class="c1">//éå†ç±»åˆ«æ¦‚ç‡ç´¢å¼•ï¼Œè®¡ç®—ç±»åˆ«ä¸­æ¦‚ç‡æœ€é«˜å¾—åˆ†ï¼Œç”¨äºè®¡ç®—å…ˆéªŒæ¡†åˆ†æ•°</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">cls_num</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="o">++</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="cm">/*score*/</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">feat_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">class_score</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="n">class_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="w">                        </span><span class="n">class_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">feat_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">//score;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="c1">//process box score</span>
<span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">box_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">feat_ptr</span><span class="p">;</span>
<span class="w">                </span><span class="c1">//box_scoreç›´æ¥è¯»å–ç‰¹å¾å›¾æ•°æ®ï¼ˆ*feat_ptrï¼‰ï¼Œè¡¨ç¤ºå½“å‰é”šç‚¹åŒ…å«ç›®æ ‡çš„ç½®ä¿¡åº¦</span>

<span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">final_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">                </span><span class="c1">//é‡‡ç”¨åŒé˜ˆå€¼è¿‡æ»¤æœºåˆ¶ï¼ˆdeprob_thresholdï¼‰ï¼Œä»…å½“æ¡†åˆ†æ•°å’Œç±»åˆ«åˆ†æ•°å‡è¾¾æ ‡æ—¶æ‰è®¡ç®—æœ€ç»ˆåˆ†æ•°</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">box_score</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">deprob_threshold</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">class_score</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">deprob_threshold</span><span class="p">)</span>
<span class="w">                    </span><span class="n">final_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="n">box_score</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="n">class_score</span><span class="p">);</span>
<span class="w">                    </span><span class="c1">//å…ˆéªŒæ¡†å¾—åˆ† = ç½®ä¿¡åº¦å€¼ x ç±»åˆ«æ¦‚ç‡ä¸­æœ€å¤§çš„å€¼</span>
<span class="w">                </span><span class="c1">//ä¸‹é¢æ˜¯YOLOv5ç‰¹æœ‰çš„è§£ç æ ¼å¼è®¡ç®—çŸ©å½¢æ¡†(x0,y0,x1,y1)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">final_score</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">prob_threshold</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">loc_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a_idx</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">anchor_data</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">loc_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">anchor_data</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">loc_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">anchor_data</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">loc_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">anchor_data</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">loc_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">pred_cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.0f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">stride</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">pred_cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.0f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">stride</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">anchor_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anchors</span><span class="p">[(</span><span class="n">anchor_group</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">anchor_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anchors</span><span class="p">[(</span><span class="n">anchor_group</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">pred_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4.0f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">anchor_w</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">pred_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dh</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dh</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4.0f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">anchor_h</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_cx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pred_w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_cy</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pred_h</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_cx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pred_w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_cy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pred_h</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>

<span class="w">                    </span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<span class="w">                    </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">class_index</span><span class="p">;</span>
<span class="w">                    </span><span class="c1">//å…ˆéªŒæ¡†æœ€åå¾—åˆ† = ç½®ä¿¡åº¦å€¼ x ç±»åˆ«æ¦‚ç‡ä¸­æœ€å¤§çš„å€¼</span>
<span class="w">                    </span><span class="n">obj</span><span class="p">.</span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">final_score</span><span class="p">;</span>
<span class="w">                    </span><span class="c1">//é¢„æµ‹æ¡†è¢«å°è£…ä¸ºObjectç»“æ„ä½“ï¼Œå­˜å…¥objectså‘é‡ä¾›åç»­NMSå¤„ç†</span>
<span class="w">                    </span><span class="n">objects</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>generate_proposals_rtå‡½æ•°çš„ä½œç”¨æ˜¯æŠŠæ‰€æœ‰å…ˆéªŒæ¡†çš„ä¿¡æ¯ï¼ˆåæ ‡ä¿¡æ¯ã€ç½®ä¿¡åº¦ã€åˆ†ç±»æ¦‚ç‡ï¼‰è®¡ç®—å¤„ç†æ”¾åˆ°objectsä¸­ã€‚ä¸€å…±æ˜¯25200ä¸ªå…ˆéªŒæ¡†æ•°é‡ã€‚</p>
<ul>
<li>8å€ä¸‹é‡‡æ ·å…ˆéªŒæ¡†æ•°é‡ï¼š 3 x 80 x 80 = 19200</li>
<li>16å€ä¸‹é‡‡æ ·å…ˆéªŒæ¡†æ•°é‡ï¼š 3 x 40 x 40 = 4800</li>
<li>32å€ä¸‹é‡‡æ ·å…ˆéªŒæ¡†æ•°é‡ï¼š 3 x 20 x 20 = 1200</li>
</ul>
<h3 id="_5">éæå¤§å€¼æŠ‘åˆ¶</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">qsort_descent_inplace</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">right</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">left</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">right</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[(</span><span class="n">left</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">].</span><span class="n">prob</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">j</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prob</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="w">            </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">prob</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="w">            </span><span class="n">j</span><span class="o">--</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">j</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// swap</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>

<span class="w">            </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="n">j</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="cp">#pragma omp parallel sections</span>
<span class="w">    </span><span class="p">{</span>
<span class="cp">#pragma omp section</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="n">qsort_descent_inplace</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="cp">#pragma omp section</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="w"> </span><span class="n">qsort_descent_inplace</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">right</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">qsort_descent_inplace</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">objects</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="n">qsort_descent_inplace</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">objects</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>æŒ‰ç…§å…ˆéªŒæ¡†å¾—åˆ†ä½¿ç”¨å¿«æ’è¿›è¡Œæ’åºï¼Œå…ˆéªŒæ¡†å¾—åˆ†ä¸ºå…ˆéªŒæ¡†å¾—åˆ† = ç½®ä¿¡åº¦å€¼ x ç±»åˆ«æ¦‚ç‡ä¸­æœ€å¤§çš„å€¼ï¼Œåœ¨generate_proposalsä¸­è®¡ç®—è€Œæ¥ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">nms_sorted_bboxes</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">picked</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">nms_threshold</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">agnostic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//æ¸…ç©ºè¾“å‡ºå®¹å™¨picked, é¢„è®¡ç®—æ‰€æœ‰æ£€æµ‹æ¡†é¢ç§¯å­˜å…¥areasæ•°ç»„ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚</span>
<span class="w">    </span><span class="n">picked</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">areas</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//è°ƒç”¨OpenCVçš„area()æ–¹æ³•è®¡ç®—æ¯ä¸ªçŸ©å½¢æ¡†é¢ç§¯</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">area</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//éå†æ‰€æœ‰æ£€æµ‹æ¡†ï¼Œåˆå§‹åŒ–å½“å‰æ¡†çš„ä¿ç•™æ ‡å¿—keep</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">Object</span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//å¾ªç¯éå†å·²é€‰ä¸­çš„æ£€æµ‹æ¡†è¿›è¡ŒIoUè®¡ç®—</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">picked</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">Object</span><span class="o">&amp;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">picked</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
<span class="w">            </span><span class="c1">// intersection over union</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">inter_area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intersection_area</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">union_area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">areas</span><span class="p">[</span><span class="n">picked</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">inter_area</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//è®¡ç®—äº¤å¹¶æ¯”ï¼šinter_area / union_area,è¶…è¿‡é˜ˆå€¼åˆ™æ ‡è®°å½“å‰æ¡†ä¸ºæŠ‘åˆ¶çŠ¶æ€</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inter_area</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">union_area</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">nms_threshold</span><span class="p">)</span>
<span class="w">                </span><span class="n">keep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//æœªè¢«æŠ‘åˆ¶çš„æ¡†ç´¢å¼•åŠ å…¥ç»“æœé›†</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>
<span class="w">            </span><span class="n">picked</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_6">ç»˜åˆ¶ç›®æ ‡æ¡†</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw_objects</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">bgr</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">objects</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">Tbegin</span><span class="p">,</span><span class="w"> </span><span class="n">Tend</span><span class="p">;</span>
<span class="w">    </span><span class="mf">1.</span><span class="n">ä½¿ç”¨</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="w"> </span><span class="n">è¿›è¡Œæ—¶é—´è®¡æ—¶</span><span class="err">ã€‚</span><span class="n">Tbegin</span><span class="w"> </span><span class="n">è®°å½•å¼€å§‹æ—¶é—´</span><span class="err">ï¼Œ</span><span class="n">Tend</span>
<span class="w">        </span><span class="n">ç”¨äºè®°å½•ç»“æŸæ—¶é—´</span><span class="err">ã€‚</span><span class="n">ç›®çš„æ˜¯è®¡ç®—ç»˜åˆ¶ç‰©ä½“æ¡†å’Œæ ‡ç­¾çš„æ—¶é—´å¼€é”€</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">Tbegin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>

<span class="w">    </span><span class="mf">2.</span><span class="n">å°†ä¼ å…¥çš„åŸå§‹å›¾åƒ</span><span class="w"> </span><span class="n">bgr</span><span class="w"> </span><span class="n">å…‹éš†åˆ°</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="n">ä¸­</span><span class="err">ã€‚</span><span class="n">è¿™æ˜¯å› ä¸ºåŸå§‹å›¾åƒä¸åº”è¯¥è¢«ä¿®æ”¹</span><span class="err">ï¼Œ</span><span class="n">ç»˜åˆ¶æ“</span>
<span class="w">        </span><span class="n">ä½œä¼šåœ¨imageä¸Šè¿›è¡Œ</span><span class="err">ï¼Œ</span><span class="n">è€ŒåŸå›¾bgrä¿æŒä¸å˜</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>

<span class="w">    </span><span class="mf">3.</span><span class="n">éå†</span><span class="w"> </span><span class="n">objects</span><span class="w"> </span><span class="n">å‘é‡</span><span class="err">ï¼Œ</span><span class="n">è¿™ä¸ªå‘é‡åŒ…å«äº†æ‰€æœ‰æ£€æµ‹åˆ°çš„ç‰©ä½“</span><span class="err">ï¼ˆ</span><span class="n">æ¯ä¸ªç‰©ä½“é€šè¿‡</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">ç±»</span>
<span class="w">        </span><span class="n">å‹è¡¨ç¤º</span><span class="err">ï¼‰ã€‚</span><span class="n">obj</span><span class="w"> </span><span class="n">æ˜¯å½“å‰éå†åˆ°çš„ç‰©ä½“</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">objects</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">Object</span><span class="o">&amp;</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="w">        </span><span class="mf">4.</span><span class="n">æ‰“å°è¾“å‡ºç‰©ä½“çš„è¯¦ç»†ä¿¡æ¯</span><span class="err">ï¼š</span><span class="n">ç‰©ä½“çš„æ ‡ç­¾</span><span class="w"> </span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="p">)</span><span class="err">ã€</span><span class="n">ç½®ä¿¡åº¦</span>
<span class="w">            </span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">prob</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="err">ã€</span><span class="n">ç‰©ä½“æ¡†çš„åæ ‡</span><span class="err">ï¼ˆ</span><span class="n">å·¦ä¸Šè§’å’Œå³ä¸‹è§’</span><span class="err">ï¼‰ï¼Œ</span><span class="n">ä»¥åŠç‰©ä½“çš„ç±»åˆ«</span>
<span class="w">            </span><span class="n">åç§°</span><span class="err">ï¼ˆ</span><span class="n">g_classes_name</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="p">]</span><span class="err">ï¼‰ã€‚</span><span class="n">è¿™å¯¹äºè°ƒè¯•éå¸¸æœ‰ç”¨</span><span class="err">ã€‚</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"%2d: %3.0f%%, [%4.0f, %4.0f, %4.0f, %4.0f], %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">prob</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
<span class="w">                </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">g_classes_name</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>

<span class="w">        </span><span class="mf">5.</span><span class="n">ä½¿ç”¨</span><span class="w"> </span><span class="n">OpenCV</span><span class="w"> </span><span class="n">çš„</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">rectangle</span><span class="w"> </span><span class="n">å‡½æ•°åœ¨å›¾åƒä¸Šç»˜åˆ¶çŸ©å½¢æ¡†</span><span class="err">ï¼Œ</span><span class="n">è¡¨ç¤ºæ£€æµ‹åˆ°çš„ç‰©ä½“ä½ç½®</span><span class="err">ã€‚</span>
<span class="w">        </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="w"> </span><span class="n">æ˜¯ç‰©ä½“çš„è¾¹ç•Œæ¡†</span><span class="err">ï¼Œ</span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">è¡¨ç¤ºæ¡†çš„é¢œè‰²ä¸ºè“è‰²</span><span class="err">ï¼ˆ</span><span class="n">BGRæ ¼å¼</span><span class="err">ï¼‰ã€‚</span>
<span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">rectangle</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>

<span class="w">        </span><span class="mf">6.</span><span class="w"> </span><span class="n">ä½¿ç”¨</span><span class="w"> </span><span class="n">sprintf</span><span class="w"> </span><span class="n">å‡½æ•°æ„é€ æ–‡æœ¬</span><span class="err">ï¼Œ</span><span class="n">æ˜¾ç¤ºç‰©ä½“çš„ç±»åˆ«åç§°å’Œç½®ä¿¡åº¦</span><span class="err">ï¼ˆ</span><span class="n">æ ¼å¼ä¸º</span><span class="err">ï¼š</span><span class="n">ç±»åˆ«åç§°</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ç½®ä¿¡åº¦ç™¾åˆ†æ¯”</span><span class="err">ï¼‰ã€‚</span>
<span class="w">        </span><span class="n">g_classes_name</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="p">]</span><span class="w"> </span><span class="n">è·å–ç‰©ä½“çš„ç±»åˆ«åç§°</span><span class="err">ï¼Œ</span><span class="n">obj</span><span class="p">.</span><span class="n">prob</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">è¡¨ç¤ºç‰©ä½“çš„ç½®ä¿¡åº¦</span><span class="err">ã€‚</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">text</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">        </span><span class="n">sprintf</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="s">"%s %.1f%%"</span><span class="p">,</span><span class="w"> </span><span class="n">g_classes_name</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="p">].</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">prob</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">baseLine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="w"> </span><span class="n">label_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">getTextSize</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">baseLine</span><span class="p">);</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">label_size</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">baseLine</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">label_size</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">cols</span><span class="p">)</span>
<span class="w">            </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">label_size</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//ç»˜åˆ¶æ–‡æœ¬çš„ç™½è‰²èƒŒæ™¯çŸ©å½¢æ¡†</span>
<span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">rectangle</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Rect</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">(</span><span class="n">label_size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">label_size</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">baseLine</span><span class="p">)),</span>
<span class="w">                      </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">),</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//ç»˜åˆ¶æ–‡æœ¬ä¿¡æ¯</span>
<span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">putText</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">label_size</span><span class="p">.</span><span class="n">height</span><span class="p">),</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span>
<span class="w">                    </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">imwrite</span><span class="p">(</span><span class="s">"output_yolov5.png"</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p">);</span>

<span class="w">    </span><span class="n">Tend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="w"> </span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">Tend</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Tbegin</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"draw objects time : "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">" ms"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/05/wp_editor_md_e1d8da4bdb5dea095e1d2d5738dddf72.jpg"><img alt="" src="assets/doc/04-ai/aiåº”ç”¨/yolov5ç«¯ä¾§éƒ¨ç½²ä»£ç åˆ†æ/images/wp_editor_md_e1d8da4bdb5dea095e1d2d5738dddf72.jpg"/></a></p>
<h2 id="opencv">opencvå‚è€ƒå‡½æ•°</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">cv::rectangle</span><span class="p">(</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">img</span><span class="p">,</span><span class="w">           </span><span class="c1">// è¾“å…¥è¾“å‡ºå›¾åƒ</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Rect</span><span class="w"> </span><span class="n">rec</span><span class="p">,</span><span class="w">           </span><span class="c1">// çŸ©å½¢çš„ä½ç½®å’Œå¤§å°</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="o">&amp;</span><span class="w"> </span><span class="n">color</span><span class="p">,</span><span class="w"> </span><span class="c1">// çŸ©å½¢çš„é¢œè‰²ï¼ˆBGRæ ¼å¼ï¼‰</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">thickness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">      </span><span class="c1">// çŸ©å½¢è¾¹æ¡†çš„åšåº¦ï¼Œé»˜è®¤æ˜¯ 1</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lineType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w">       </span><span class="c1">// çº¿æ¡ç±»å‹ï¼Œé»˜è®¤ä¸º 8ï¼ˆæŠ—é”¯é½¿çº¿ï¼‰</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">shift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">           </span><span class="c1">// å¯¹åæ ‡è¿›è¡Œçš„ä½ç§»ï¼Œé»˜è®¤ä¸º 0</span>
<span class="p">);</span>

<span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">imread</span><span class="p">(</span><span class="s">"image.jpg"</span><span class="p">);</span><span class="w">  </span><span class="c1">// è¯»å–å›¾åƒ</span>
<span class="n">cv</span><span class="o">::</span><span class="n">Rect</span><span class="w"> </span><span class="nf">rect</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w">       </span><span class="c1">// åˆ›å»ºä¸€ä¸ªçŸ©å½¢ï¼Œå·¦ä¸Šè§’ä¸º(50, 50)ï¼Œå®½200ï¼Œé«˜100</span>
<span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="w"> </span><span class="nf">color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">           </span><span class="c1">// è®¾ç½®çŸ©å½¢çš„é¢œè‰²ä¸ºç»¿è‰²ï¼ˆBGRæ ¼å¼ï¼‰</span>
<span class="n">cv</span><span class="o">::</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="n">rect</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w">    </span><span class="c1">// åœ¨å›¾åƒä¸Šç»˜åˆ¶ç»¿è‰²çš„çŸ©å½¢ï¼Œè¾¹æ¡†åšåº¦ä¸º2</span>
<span class="n">cv</span><span class="o">::</span><span class="n">imwrite</span><span class="p">(</span><span class="s">"output.jpg"</span><span class="p">,</span><span class="w"> </span><span class="n">img</span><span class="p">);</span><span class="w">        </span><span class="c1">// ä¿å­˜å›¾åƒ</span>
</code></pre></div>
<ul>
<li>img: è¾“å…¥å’Œè¾“å‡ºå›¾åƒï¼ŒçŸ©å½¢å°†è¢«ç»˜åˆ¶åœ¨è¿™å¼ å›¾åƒä¸Šã€‚</li>
<li>rec: è¿™ä¸ªçŸ©å½¢çš„åæ ‡å’Œå°ºå¯¸ï¼Œç”¨ cv::Rect(x, y, width, height) æ¥æŒ‡å®šçŸ©å½¢çš„ä½ç½®ï¼ˆå·¦ä¸Šè§’ (x, y)ï¼‰å’Œå°ºå¯¸ï¼ˆå®½åº¦å’Œé«˜åº¦ï¼‰ã€‚</li>
<li>color: çŸ©å½¢è¾¹æ¡†çš„é¢œè‰²ï¼Œé‡‡ç”¨ cv::Scalar ç±»å‹è¡¨ç¤ºé¢œè‰²ï¼ˆBGR æ ¼å¼ï¼‰ï¼Œä¾‹å¦‚ cv::Scalar(255, 0, 0) è¡¨ç¤ºè“è‰²ã€‚</li>
<li>thickness: è¾¹æ¡†çš„åšåº¦ã€‚å¦‚æœè®¾ç½®ä¸ºè´Ÿå€¼ï¼ˆä¾‹å¦‚ -1ï¼‰ï¼Œåˆ™çŸ©å½¢å°†ä¼šå¡«å……é¢œè‰²ï¼Œè€Œä¸æ˜¯åªç»˜åˆ¶è¾¹æ¡†ã€‚</li>
<li>lineType: çº¿æ¡ç±»å‹ï¼Œå†³å®šäº†ç»˜åˆ¶çº¿æ¡çš„è´¨é‡ï¼Œå¸¸ç”¨çš„å€¼æœ‰ 8ï¼ˆ8-connected linesï¼‰ã€4ï¼ˆ4-connected linesï¼‰ï¼Œä»¥åŠ CV_AAï¼ˆæŠ—é”¯é½¿çº¿ï¼‰ã€‚</li>
<li>shift: è¡¨ç¤ºåæ ‡çš„ä½ç§»ï¼Œé€šå¸¸åœ¨è¿›è¡Œç²¾åº¦å¤„ç†æ—¶ä½¿ç”¨ã€‚</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">cv::putText</span><span class="p">(</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">img</span><span class="p">,</span><span class="w">                   </span><span class="c1">// è¾“å…¥è¾“å‡ºå›¾åƒ</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">text</span><span class="p">,</span><span class="w">         </span><span class="c1">// è¦ç»˜åˆ¶çš„æ–‡æœ¬</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="n">org</span><span class="p">,</span><span class="w">                  </span><span class="c1">// æ–‡æœ¬çš„èµ·å§‹ä½ç½®ï¼ˆå·¦ä¸‹è§’ï¼‰</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fontFace</span><span class="p">,</span><span class="w">                   </span><span class="c1">// å­—ä½“ç±»å‹</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">fontScale</span><span class="p">,</span><span class="w">               </span><span class="c1">// å­—ä½“å¤§å°çš„ç¼©æ”¾å› å­</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="o">&amp;</span><span class="w"> </span><span class="n">color</span><span class="p">,</span><span class="w">        </span><span class="c1">// æ–‡æœ¬é¢œè‰²ï¼ˆBGRæ ¼å¼ï¼‰</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">thickness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">              </span><span class="c1">// å­—ä½“çº¿æ¡çš„ç²—ç»†ï¼Œé»˜è®¤ä¸º 1</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lineType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w">               </span><span class="c1">// çº¿æ¡ç±»å‹ï¼Œé»˜è®¤ä¸º 8</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">bottomLeftOrigin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="w">   </span><span class="c1">// æ˜¯å¦ä»¥å·¦ä¸‹è§’ä¸ºåŸç‚¹ï¼Œé»˜è®¤ä¸º false</span>
<span class="p">);</span>

<span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">imread</span><span class="p">(</span><span class="s">"image.jpg"</span><span class="p">);</span><span class="w">  </span><span class="c1">// è¯»å–å›¾åƒ</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Hello, OpenCV!"</span><span class="p">;</span><span class="w">    </span><span class="c1">// è¦ç»˜åˆ¶çš„æ–‡æœ¬</span>
<span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="nf">org</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">);</span><span class="w">                  </span><span class="c1">// æ–‡æœ¬çš„èµ·å§‹ä½ç½®ï¼ˆå·¦ä¸Šè§’ï¼‰</span>
<span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="w"> </span><span class="nf">color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">);</span><span class="w">            </span><span class="c1">// æ–‡æœ¬é¢œè‰²ä¸ºçº¢è‰²ï¼ˆBGRæ ¼å¼ï¼‰</span>
<span class="kt">int</span><span class="w"> </span><span class="n">fontFace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">;</span><span class="w"> </span><span class="c1">// ä½¿ç”¨æ— è¡¬çº¿å­—ä½“</span>
<span class="kt">double</span><span class="w"> </span><span class="n">fontScale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w">                 </span><span class="c1">// å­—ä½“å¤§å°</span>
<span class="kt">int</span><span class="w"> </span><span class="n">thickness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">                      </span><span class="c1">// å­—ä½“ç²—ç»†</span>

<span class="n">cv</span><span class="o">::</span><span class="n">putText</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="n">org</span><span class="p">,</span><span class="w"> </span><span class="n">fontFace</span><span class="p">,</span><span class="w"> </span><span class="n">fontScale</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="p">,</span><span class="w"> </span><span class="n">thickness</span><span class="p">);</span><span class="w"> </span><span class="c1">// åœ¨å›¾åƒä¸Šç»˜åˆ¶æ–‡æœ¬</span>
<span class="n">cv</span><span class="o">::</span><span class="n">imwrite</span><span class="p">(</span><span class="s">"output_text.jpg"</span><span class="p">,</span><span class="w"> </span><span class="n">img</span><span class="p">);</span><span class="w">    </span><span class="c1">// ä¿å­˜å›¾åƒ</span>
</code></pre></div>
<ul>
<li>img: è¾“å…¥å’Œè¾“å‡ºå›¾åƒï¼Œæ–‡æœ¬å°†è¢«ç»˜åˆ¶åœ¨è¿™å¼ å›¾åƒä¸Šã€‚</li>
<li>text: éœ€è¦ç»˜åˆ¶çš„æ–‡æœ¬å†…å®¹ï¼Œä½¿ç”¨ std::string ç±»å‹ä¼ é€’ã€‚</li>
<li>org: æ–‡æœ¬çš„èµ·å§‹ä½ç½®ï¼ˆå·¦ä¸‹è§’çš„åæ ‡ï¼‰ï¼Œä½¿ç”¨ cv::Point(x, y) å½¢å¼æ¥æŒ‡å®šã€‚</li>
<li>fontFace: å­—ä½“ç±»å‹ï¼ŒOpenCV æä¾›äº†å‡ ç§å¸¸è§çš„å­—ä½“ç±»å‹ï¼š</li>
</ul>
<p>cv::FONT_HERSHEY_SIMPLEXï¼šç®€å•æ— è¡¬çº¿å­—ä½“ï¼› cv::FONT_HERSHEY_PLAINï¼šç®€å•çš„æ— è¡¬çº¿å­—ä½“ï¼Œå­—å½¢æ›´å°ï¼› cv::FONT_HERSHEY_COMPLEXï¼šå¤æ‚çš„æ— è¡¬çº¿å­—ä½“ï¼› cv::FONT_HERSHEY_SCRIPT_SIMPLEXï¼šæ‰‹å†™ä½“ï¼› cv::FONT_HERSHEY_SCRIPT_COMPLEXï¼šå¤æ‚çš„æ‰‹å†™ä½“ç­‰ã€‚</p>
<ul>
<li>fontScale: å­—ä½“çš„ç¼©æ”¾å› å­ï¼Œç”¨äºè°ƒæ•´å­—ä½“å¤§å°ã€‚1.0 è¡¨ç¤ºé»˜è®¤å¤§å°ï¼Œ2.0 è¡¨ç¤ºæ›´å¤§ã€‚ color: æ–‡æœ¬é¢œè‰²ï¼Œé‡‡ç”¨ cv::Scalar ç±»å‹è¡¨ç¤ºé¢œè‰²ï¼ˆBGR æ ¼å¼ï¼‰ï¼Œä¾‹å¦‚ cv::Scalar(255, 0, 0) è¡¨ç¤ºè“è‰²ã€‚</li>
<li>thickness: å­—ä½“çš„çº¿æ¡ç²—ç»†ï¼Œé»˜è®¤ä¸º 1ã€‚</li>
<li>lineType: çº¿æ¡ç±»å‹ï¼Œå†³å®šäº†ç»˜åˆ¶æ–‡æœ¬æ—¶çš„çº¿æ¡è´¨é‡ï¼Œå¸¸è§çš„æœ‰ 8ï¼ˆ8-connected linesï¼‰å’Œ CV_AAï¼ˆæŠ—é”¯é½¿çº¿ï¼‰ã€‚</li>
<li>bottomLeftOrigin: æ˜¯å¦ä»¥å·¦ä¸‹è§’ä¸ºåŸç‚¹ã€‚é»˜è®¤æ˜¯ falseï¼Œæ„å‘³ç€æ–‡æœ¬æ˜¯ä»å·¦ä¸Šè§’å¼€å§‹ç»˜åˆ¶çš„ã€‚å¦‚æœè®¾ç½®ä¸º trueï¼Œåˆ™æ–‡æœ¬ä»å·¦ä¸‹è§’å¼€å§‹ç»˜åˆ¶</li>
</ul></div>
  <div class="post-nav">
    <a class="prev" href="transformer.html">â† transformer</a>
    <a class="next" href="ç«¯ä¾§éƒ¨ç½²yolov5æ¨¡å‹.html">ç«¯ä¾§éƒ¨ç½²YOLOv5æ¨¡å‹ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

