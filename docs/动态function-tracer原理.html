<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>动态function tracer原理 - Laumy的技术栈</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="">首页</a></div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#fpatchable-function-entry">fpatchable-function-entry选项</a><ul></ul></li><li><a href="#risc-v">risc-v 内核编译与链接</a><ul></ul></li><li><a href="#_1">桩点更新过程概览</a><ul><li><a href="#_2">编译插桩点</a></li><li><a href="#nop">启动初始化调整nop指令长度</a></li><li><a href="#nop_1">替换入口函数的nop</a></li><li><a href="#ftrace_stub">替换跟踪函数ftrace_stub</a></li><li><a href="#ftrace_caller">ftrace_caller调用流程</a></li></ul></li><li><a href="#ftrace_init">ftrace_init</a><ul><li><a href="#_3">数据结构</a></li><li><a href="#_4">分配数据结构</a></li><li><a href="#_5">记录插桩地址</a></li><li><a href="#nop_2">更新插桩指令nop</a></li></ul></li><li><a href="#_6">入口函数与跟踪函数替换</a><ul><li><a href="#ftrace_ops_list">全局ftrace_ops_list</a></li><li><a href="#ftrace_function">注册ftrace_function</a></li><li><a href="#_7">函数过滤处理</a></li><li><a href="#ftrace-modify-all-code">ftrace modify all code</a></li></ul></li><li><a href="#_10">总结</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>动态function tracer原理</h1>
  <div class="meta">2024-08-28 · linux</div>
  <div class="post-content"><h2 id="fpatchable-function-entry">fpatchable-function-entry选项</h2>
<p>编译时指定-fpatchable-function-entry=N[,M]，①会在函数入口第一个指令之前插入N个nop，但是会保留M个放到函数入口之前，如果省略M则默认为0；②同时需要一个特殊的-fpatchable-function-entry段来记录所有函数的入口，如下蓝色部分。nop指令保留了额外的空间，可用于在运行时修改nop指令，添加自己想要的桩点，前提是代码段可写的。</p>
<div class="codehilite"><pre><span></span><code><span class="n">echo</span><span class="w"> </span><span class="err">\'</span><span class="kt">void</span><span class="w"> </span><span class="n">test</span><span class="p">(){;}</span><span class="err">\'</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">c</span>

<span class="n">$</span><span class="w"> </span><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span><span class="n">gcc</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">fpatchable</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">entry</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="o">-</span>
<span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span><span class="n">gcc</span><span class="o">:</span><span class="w"> </span><span class="n">warning</span><span class="o">:</span><span class="w"> </span><span class="err">\'</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="n">c</span><span class="err">\'</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">effect</span>
<span class="w">        </span><span class="p">.</span><span class="n">file</span><span class="w">   </span><span class="err">\</span><span class="s">"test.c</span><span class="se">\"</span>
<span class="w">        </span><span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">nopic</span>
<span class="w">        </span><span class="p">.</span><span class="n">text</span>
<span class="w">        </span><span class="p">.</span><span class="n">align</span><span class="w">  </span><span class="mi">1</span>
<span class="w">        </span><span class="p">.</span><span class="n">globl</span><span class="w">  </span><span class="n">test</span>
<span class="w">        </span><span class="p">.</span><span class="n">section</span><span class="w">        </span><span class="n">__patchable_function_entries</span><span class="p">,</span><span class="err">\</span><span class="s">"aw</span><span class="se">\"</span><span class="s">,@progbits</span>
<span class="w">        </span><span class="p">.</span><span class="n">align</span><span class="w">  </span><span class="mi">3</span>
<span class="w">        </span><span class="mf">.8</span><span class="n">byte</span><span class="w">  </span><span class="p">.</span><span class="n">LPFE1</span>
<span class="w">        </span><span class="p">.</span><span class="n">text</span>
<span class="p">.</span><span class="n">LPFE1</span><span class="o">:</span>
<span class="w">        </span><span class="n">nop</span>
<span class="w">        </span><span class="p">.</span><span class="n">type</span><span class="w">   </span><span class="n">test</span><span class="p">,</span><span class="w"> </span><span class="err">@</span><span class="n">function</span>
<span class="nl">test</span><span class="p">:</span>
<span class="w">        </span><span class="n">nop</span>
<span class="w">        </span><span class="n">nop</span>
<span class="w">        </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">-16</span>
<span class="w">        </span><span class="n">sd</span><span class="w">      </span><span class="n">s0</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">        </span><span class="n">addi</span><span class="w">    </span><span class="n">s0</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">16</span>
<span class="w">        </span><span class="n">nop</span>
<span class="w">        </span><span class="n">ld</span><span class="w">      </span><span class="n">s0</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">        </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">16</span>
<span class="w">        </span><span class="n">jr</span><span class="w">      </span><span class="n">ra</span>
<span class="w">        </span><span class="p">.</span><span class="n">size</span><span class="w">   </span><span class="n">test</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="o">-</span><span class="n">test</span>
<span class="w">        </span><span class="p">.</span><span class="n">ident</span><span class="w">  </span><span class="err">\</span><span class="s">"GCC: (Xuantie-900 linux-5.10.4 glibc gcc Toolchain V2.8.1 B-20240115) 10.4.0</span><span class="se">\"</span>
<span class="w">        </span><span class="p">.</span><span class="n">section</span><span class="w">        </span><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">GNU</span><span class="o">-</span><span class="n">stack</span><span class="p">,</span><span class="err">\</span><span class="s">"</span><span class="se">\"</span><span class="s">,@progbits</span>
</code></pre></div>
<h2 id="risc-v">risc-v 内核编译与链接</h2>
<p>在本文的实验平台的RISC-V架构中，使用编译选项-fpatchable-function-entry进行编译，在内核arch/riscv/Makefile中指定CC_FLAGS_FTRACE:=-fpatchable-function-entry=X来编译内核组件。</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_ecdbca386943ae87e8907eb2d9c8fcaa.jpg\"><img alt='\"动态function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_ecdbca386943ae87e8907eb2d9c8fcaa.jpg\"/></a></p>
<p>添加上面参数后，编译后的目标文件，就会有两个特征： - 每个函数入口，第一条指令前插入nop指令。 - 在__patchable_function_entries段重定位中，记录了当前目标文件所有函数入口地址。</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_0c27759308da4fa6535c74ebd02e8b22.jpg\"><img alt='\"动态function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_0c27759308da4fa6535c74ebd02e8b22.jpg\"/></a></p>
<p>Linux内核最终会链接合并成vmlinux.o，在链接重定位阶段会将所有.o中的__patchable_function_entries段重定位段信息合并起来。具体在链接脚本中include/asm-generic/vmlinux.lds.h中MCOUNT_REC的描述。如上图，nop指令的长度位2字节（16bit，用的是压缩指令c.nop），不管是多少位系统这是默认内核编译nop指令的长度，因此函数入口插入的nop总长度4*2字节=8字节，这8字节的nop会在开启函数跟踪的时候修改位对应长度的跳转指令，在启动过程中或函数跟踪关闭的时候修改位对应长度的nop。</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_a39c094d7d930bb377d08e9076306a9c.jpg\"><img alt='\"动态function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_a39c094d7d930bb377d08e9076306a9c.jpg\"/></a></p>
<p>从上可知，可以通过__{start,stop}_mcount_loc符号获取到所有函数入口，同时每个函数入口都会插入nop指令，相当于定位了所有函数的入口在哪，后续就可以对指令进行修改，如下图所示。 为什么要用一个section来记录所有函数入口地址？这是因为记录的函数入口地址，就记录的nop指令的位置，在程序运行过程中才能把nop指令进行修改为指定的跟踪函数。在动态ftrace中，系统启动初始化时会将所有的函数入口地址记录到struct dyn_ftrace结构体中，3.4章节会介绍到。</p>
<h2 id="_1">桩点更新过程概览</h2>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_4505811760e81d50eb91432c2cdaf425.jpg\"><img alt='\"动态function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_4505811760e81d50eb91432c2cdaf425.jpg\"/></a></p>
<p>接下来我们以函数vfs_read进行实例分析，从编译到系统启动，再到使能function trace这一过程来进行简单分析插装点变化。</p>
<h3 id="_2">编译插桩点</h3>
<p>本文的实验平台=-fpatchable-function-entry=4，即编译完成后，需要在函数入口处插入4个nop指令，我们通过riscv64-unknown-linux-gnu-objdump -D vmlinux &gt; log反汇编查看vfs_read如下：</p>
<div class="codehilite"><pre><span></span><code><span class="nl">ffffffff8039e398</span><span class="w"> </span><span class="p">:</span>
<span class="nl">ffffffff8039e398</span><span class="p">:</span><span class="w">   </span><span class="mo">0001</span><span class="w">                    </span><span class="n">nop</span>
<span class="nl">ffffffff8039e39a</span><span class="p">:</span><span class="w">   </span><span class="mo">0001</span><span class="w">                    </span><span class="n">nop</span>
<span class="nl">ffffffff8039e39c</span><span class="p">:</span><span class="w">   </span><span class="mo">0001</span><span class="w">                    </span><span class="n">nop</span>
<span class="nl">ffffffff8039e39e</span><span class="p">:</span><span class="w">   </span><span class="mo">0001</span><span class="w">                    </span><span class="n">nop</span>
<span class="nl">ffffffff8039e3a0</span><span class="p">:</span><span class="w">   </span><span class="mi">7171</span><span class="w">                    </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">-176</span>
<span class="nl">ffffffff8039e3a2</span><span class="p">:</span><span class="w">   </span><span class="n">f122</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s0</span><span class="p">,</span><span class="mi">160</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3a4</span><span class="p">:</span><span class="w">   </span><span class="n">f4de</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s7</span><span class="p">,</span><span class="mi">104</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3a6</span><span class="p">:</span><span class="w">   </span><span class="n">f506</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">ra</span><span class="p">,</span><span class="mi">168</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3a8</span><span class="p">:</span><span class="w">   </span><span class="n">ed26</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s1</span><span class="p">,</span><span class="mi">152</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3aa</span><span class="p">:</span><span class="w">   </span><span class="n">e94a</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s2</span><span class="p">,</span><span class="mi">144</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3ac</span><span class="p">:</span><span class="w">   </span><span class="n">e54e</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s3</span><span class="p">,</span><span class="mi">136</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3ae</span><span class="p">:</span><span class="w">   </span><span class="n">e152</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s4</span><span class="p">,</span><span class="mi">128</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3b0</span><span class="p">:</span><span class="w">   </span><span class="n">fcd6</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s5</span><span class="p">,</span><span class="mi">120</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3b2</span><span class="p">:</span><span class="w">   </span><span class="n">f8da</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s6</span><span class="p">,</span><span class="mi">112</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3b4</span><span class="p">:</span><span class="w">   </span><span class="n">f0e2</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s8</span><span class="p">,</span><span class="mi">96</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3b6</span><span class="p">:</span><span class="w">   </span><span class="mi">1900</span><span class="w">                    </span><span class="n">addi</span><span class="w">    </span><span class="n">s0</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">176</span>
<span class="nl">ffffffff8039e3b8</span><span class="p">:</span><span class="w">   </span><span class="mo">021</span><span class="n">c0b97</span><span class="w">            </span><span class="n">auipc</span><span class="w">   </span><span class="n">s7</span><span class="p">,</span><span class="mh">0x21c0</span>
<span class="nl">ffffffff8039e3bc</span><span class="p">:</span><span class="w">   </span><span class="n">d08b8b93</span><span class="w">            </span><span class="n">addi</span><span class="w">    </span><span class="n">s7</span><span class="p">,</span><span class="n">s7</span><span class="p">,</span><span class="mi">-760</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">ffffffff8255e0c0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">__stack_chk_guard</span><span class="o">&gt;</span>
<span class="nl">ffffffff8039e3c0</span><span class="p">:</span><span class="w">   </span><span class="mo">000</span><span class="n">bb703</span><span class="w">            </span><span class="n">ld</span><span class="w">  </span><span class="n">a4</span><span class="p">,</span><span class="mi">0</span><span class="p">(</span><span class="n">s7</span><span class="p">)</span>
<span class="nl">ffffffff8039e3c4</span><span class="p">:</span><span class="w">   </span><span class="mi">497</span><span class="n">c</span><span class="w">                    </span><span class="n">lw</span><span class="w">  </span><span class="n">a5</span><span class="p">,</span><span class="mi">84</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>
<span class="nl">ffffffff8039e3c6</span><span class="p">:</span><span class="w">   </span><span class="n">fae43423</span><span class="w">            </span><span class="n">sd</span><span class="w">  </span><span class="n">a4</span><span class="p">,</span><span class="mi">-88</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
<span class="nl">ffffffff8039e3ca</span><span class="p">:</span><span class="w">   </span><span class="mf">0017f</span><span class="mi">713</span><span class="w">            </span><span class="n">andi</span><span class="w">    </span><span class="n">a4</span><span class="p">,</span><span class="n">a5</span><span class="p">,</span><span class="mi">1</span>
<span class="p">......</span>
</code></pre></div>
<h3 id="nop">启动初始化调整nop指令长度</h3>
<p>在系统启动阶段，会调用ftrace_init函数，将所有的入口函数地址记录到struct dyn_frtace实例结构中，然后将4个RV32C压缩指令替换为RV32I模式的nop指令，即原来的4个2字节长度的nop指令，将会拓展为2个4字节的拓展指令。 我们在系统启动时先在ftrace_init地方打断点，先观察vfs_read处的指令情况。disassemble 0xffffffff8039e398,+50查看地址开始的指令。（不能使用disassemble vfs_read,+50查看，这样会把前面的插桩过滤掉，需要使用地址的方式）。</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_b1524fdcbc93237da35f1e1699c52899.jpg\"><img alt='\"动态function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_b1524fdcbc93237da35f1e1699c52899.jpg\"/></a></p>
<p>可以看到，跟上一节中我们反汇编看到的指令是一致了，4条nop指令还没有被替换。接着我们使用n继续进行调试运行，当运行完ftrace_process_locs后，我们再来查看一下变化。</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_3b34d8f37f21766013c1abf62e8dd72c.jpg\"><img alt='\"动态function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_3b34d8f37f21766013c1abf62e8dd72c.jpg\"/></a></p>
<p>我们发现之前4条2字节的nop指令被替换成了2条4字节的nop指令了。为什么要调整nop指令的长度了，个人理解应该是为了兼顾处理器流水线的优化、指令对齐等，比如跳转到指定标签运行是auipc+jalr两条4字节的指令。之所以不在编译时就确定时因为延迟运行调整nop指令的长度，可以更好的平衡系统的兼容性和灵活性。</p>
<h3 id="nop_1">替换入口函数的nop</h3>
<p>当我们使能function tracer后，nop指令就会被替换为ftrace_caller。接下来我们使能 echo function &gt; /sys/kernel/debug/tracing/current_tracer再来看看vfs_read的情况。</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_514a397dd661e5d1b6f8e23fa0436293.jpg\"><img alt='\"动态function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_514a397dd661e5d1b6f8e23fa0436293.jpg\"/></a></p>
<p>从上面可知，之前的2条nop指令就被替换为了auipc+jalr指令，即跳转到ftrace_caller函数。</p>
<h3 id="ftrace_stub">替换跟踪函数ftrace_stub</h3>
<p>执行echo function &gt;current_tracer时，除了函数入口的nop指令会被替换为ftrace_caller外，ftrace_caller的实现中，ftrace_stub也会替换为function_trace_call。更新代码会调用到ftrace_modify_all_code函数，我们对此函数进行断点观察前后变化。</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_dc317c86c1386ed4c7924f564f85b8a7.jpg\"><img alt='\"动态function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_dc317c86c1386ed4c7924f564f85b8a7.jpg\"/></a></p>
<p>如上图，在还没有执行命令echo function &gt; current_tracer时，ftrace_caller执行的是ftrace_stub，当执行命令后，就变成跳转如下i b。</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_6b3674469cd2d935c57c48eb3f62eb87.jpg\"><img alt='\"动态function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_6b3674469cd2d935c57c48eb3f62eb87.jpg\"/></a></p>
<p>具体的实例代码如下，切换前：</p>
<div class="codehilite"><pre><span></span><code><span class="n">ENTRY</span><span class="p">(</span><span class="n">ftrace_caller</span><span class="p">)</span>
<span class="w">    </span><span class="n">SAVE_ABI</span>

<span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">FENTRY_RA_OFFSET</span>
<span class="w">    </span><span class="n">la</span><span class="w">  </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">function_trace_op</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">ra</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>

<span class="nl">ftrace_call</span><span class="p">:</span>
<span class="w">    </span><span class="p">.</span><span class="n">global</span><span class="w"> </span><span class="n">ftrace_call</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">ftrace_stub</span><span class="w"> </span><span class="n">①未执行echo</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">current_tracer</span>

<span class="w">    </span><span class="n">RESTORE_ABI</span>
<span class="w">    </span><span class="n">jr</span><span class="w"> </span><span class="n">t0</span>
<span class="n">ENDPROC</span><span class="p">(</span><span class="n">ftrace_caller</span><span class="p">)</span>
</code></pre></div>
<p>执行命令echo function &gt; current_tracer后，ftrace_caller标签处就会变为如下：</p>
<div class="codehilite"><pre><span></span><code><span class="n">ENTRY</span><span class="p">(</span><span class="n">ftrace_caller</span><span class="p">)</span>
<span class="w">    </span><span class="n">SAVE_ABI</span>

<span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">FENTRY_RA_OFFSET</span>
<span class="w">    </span><span class="n">la</span><span class="w">  </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">function_trace_op</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">ra</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>

<span class="nl">ftrace_call</span><span class="p">:</span>
<span class="w">    </span><span class="p">.</span><span class="n">global</span><span class="w"> </span><span class="n">ftrace_call</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">function_trace_call</span><span class="w"> </span><span class="n">①执行echo</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">current_tracer</span>

<span class="w">    </span><span class="n">RESTORE_ABI</span>
<span class="w">    </span><span class="n">jr</span><span class="w"> </span><span class="n">t0</span>
<span class="n">ENDPROC</span><span class="p">(</span><span class="n">ftrace_caller</span><span class="p">)</span>
</code></pre></div>
<h3 id="ftrace_caller">ftrace_caller调用流程</h3>
<p>gdb 调试继续跟踪ftrace_caller实现。</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span>

<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8039e398</span><span class="w"> </span><span class="o">:</span><span class="w">     </span><span class="n">ffc6e297</span><span class="w">        </span><span class="n">auipc</span><span class="w">   </span><span class="n">t0</span><span class="p">,</span><span class="mh">0xffc6e</span>
<span class="w">   </span><span class="mh">0xffffffff8039e39c</span><span class="w"> </span><span class="o">:</span><span class="w">     </span><span class="mf">3f4282e7</span><span class="w">        </span><span class="n">jalr</span><span class="w">    </span><span class="n">t0</span><span class="p">,</span><span class="mi">1012</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mh">0xffffffff8000c78c</span><span class="w">  </span><span class="n">①进入vfs_read函数入口是</span><span class="err">，</span><span class="n">跳转到ftrace_caller</span><span class="err">，</span><span class="n">t0</span><span class="o">=</span><span class="n">PC</span><span class="o">+</span><span class="mi">4</span><span class="err">，</span><span class="n">即0xffffffff8039e3a0</span>
<span class="w">  </span><span class="mh">0xffffffff8039e3a0</span><span class="w"> </span><span class="o">:</span><span class="w">     </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">-176</span>
<span class="w">  </span><span class="mh">0xffffffff8039e3a2</span><span class="w"> </span><span class="o">:</span><span class="w">     </span><span class="n">sd</span><span class="w">      </span><span class="n">s0</span><span class="p">,</span><span class="mi">160</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">  </span><span class="p">.....</span>

<span class="n">ftrace_caller</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">arch</span><span class="o">/</span><span class="n">riscv</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">mcount</span><span class="o">-</span><span class="n">dyn</span><span class="p">.</span><span class="n">S</span><span class="o">:</span><span class="mi">135</span>
<span class="mi">135</span><span class="w">             </span><span class="n">SAVE_ABI</span><span class="w">    </span><span class="n">②开辟一段栈空间</span><span class="err">，</span><span class="n">将a0</span><span class="o">~</span><span class="n">a7</span><span class="p">,</span><span class="n">t0</span><span class="o">/</span><span class="n">ra入栈</span><span class="err">。</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c78c</span><span class="w"> </span><span class="o">:</span><span class="w">        </span><span class="mi">715</span><span class="n">d</span><span class="w">            </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">-80</span>
<span class="w">   </span><span class="mh">0xffffffff8000c78e</span><span class="w"> </span><span class="o">:</span><span class="w">        </span><span class="n">e02a</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a0</span><span class="p">,</span><span class="mi">0</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c790</span><span class="w"> </span><span class="o">:</span><span class="w">        </span><span class="n">e42e</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a1</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c792</span><span class="w"> </span><span class="o">:</span><span class="w">        </span><span class="n">e832</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a2</span><span class="p">,</span><span class="mi">16</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c794</span><span class="w"> </span><span class="o">:</span><span class="w">        </span><span class="n">ec36</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a3</span><span class="p">,</span><span class="mi">24</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c796</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">f03a</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a4</span><span class="p">,</span><span class="mi">32</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c798</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">f43e</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a5</span><span class="p">,</span><span class="mi">40</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c79a</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">f842</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a6</span><span class="p">,</span><span class="mi">48</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c79c</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">fc46</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a7</span><span class="p">,</span><span class="mi">56</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c79e</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">e096</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">t0</span><span class="p">,</span><span class="mi">64</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c7a0</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">e486</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">ra</span><span class="p">,</span><span class="mi">72</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="mi">137</span><span class="w">             </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">FENTRY_RA_OFFSET</span><span class="w"> </span><span class="n">②获取vfs_read的入口地址</span><span class="err">。</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c7a2</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">ff828513</span><span class="w">        </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="mi">-8</span>
<span class="mi">138</span><span class="w">             </span><span class="n">la</span><span class="w">      </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">function_trace_op</span><span class="w"> </span><span class="n">③获取全局变量function_trace_op</span><span class="err">，</span><span class="n">这是ftrace的操作集合</span><span class="err">，</span><span class="n">包含了ftrace的函数</span><span class="err">。</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c7a6</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="mf">0254e597</span><span class="w">        </span><span class="n">auipc</span><span class="w">   </span><span class="n">a1</span><span class="p">,</span><span class="mh">0x254e</span>
<span class="w">   </span><span class="mh">0xffffffff8000c7aa</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="mf">5f</span><span class="mi">258593</span><span class="w">        </span><span class="n">addi</span><span class="w">    </span><span class="n">a1</span><span class="p">,</span><span class="n">a1</span><span class="p">,</span><span class="mi">1522</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mh">0xffffffff8255ad98</span><span class="w"> </span>
<span class="mi">139</span><span class="w">             </span><span class="n">REG_L</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="n">④获取ftrace_trace_op地址存储到a2中</span><span class="err">。</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c7ae</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="mi">6190</span><span class="w">            </span><span class="n">ld</span><span class="w">      </span><span class="n">a2</span><span class="p">,</span><span class="mi">0</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="mi">140</span><span class="w">             </span><span class="n">mv</span><span class="w">      </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">ra</span>
<span class="mi">141</span><span class="w">             </span><span class="n">mv</span><span class="w">      </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<span class="mi">145</span><span class="w">             </span><span class="n">call</span><span class="w">    </span><span class="n">ftrace_stub</span><span class="w">   </span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c7b4</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="mo">001</span><span class="mi">98097</span><span class="w">        </span><span class="n">auipc</span><span class="w">   </span><span class="n">ra</span><span class="p">,</span><span class="mh">0x198</span>
<span class="w">   </span><span class="mh">0xffffffff8000c7b8</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">e5a080e7</span><span class="w">        </span><span class="n">jalr</span><span class="w">    </span><span class="mi">-422</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mh">0xffffffff801a460e</span><span class="w"> </span>

<span class="n">at</span><span class="w"> </span><span class="n">kernel</span><span class="o">/</span><span class="n">trace</span><span class="o">/</span><span class="n">trace_functions</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">175</span>
<span class="n">function_trace_call</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_regs</span><span class="w"> </span><span class="o">*</span><span class="n">fregs</span><span class="p">)</span>
<span class="w">  </span><span class="n">⑤</span><span class="w"> </span><span class="n">ip为入口函数vfs_read的地址即a0</span><span class="p">,</span><span class="w"> </span><span class="n">parent_ip为vfs_read的父函数</span><span class="err">，</span><span class="n">调用vfs_read地址处的下一条指令</span><span class="err">。</span><span class="n">op为ftrace_trace_op</span><span class="err">，</span><span class="n">fregs为栈地址</span><span class="err">。</span>
<span class="w">  </span><span class="n">trace_function</span>
<span class="n">entry</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">ring_buffer_event_data</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ip</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">ip</span><span class="p">;</span>
<span class="n">entry</span><span class="o">-&gt;</span><span class="n">parent_ip</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">;</span>
<span class="n">ftrace_exports</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">TRACE_EXPORT_FUNCTION</span><span class="p">);</span><span class="w"> </span><span class="n">⑥</span><span class="w"> </span><span class="n">将信息写入到ring</span><span class="w"> </span><span class="n">buffer中</span><span class="err">。</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="n">export</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">trace_process_export</span><span class="p">(</span><span class="n">export</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">);</span>
<span class="w">      </span><span class="n">export</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">export</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">ftrace_caller</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">arch</span><span class="o">/</span><span class="n">riscv</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">mcount</span><span class="o">-</span><span class="n">dyn</span><span class="p">.</span><span class="n">S</span><span class="o">:</span><span class="mi">148</span>
<span class="mi">148</span><span class="w">             </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">ABI_RA</span>
<span class="mi">149</span><span class="w">             </span><span class="n">REG_L</span><span class="w">   </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">ABI_T0</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="mi">150</span><span class="w">             </span><span class="n">addi</span><span class="w">    </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">FENTRY_RA_OFFSET</span>
<span class="mi">152</span><span class="w">             </span><span class="n">mv</span><span class="w">      </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span>
<span class="mi">156</span><span class="w">             </span><span class="n">call</span><span class="w">    </span><span class="n">ftrace_stub</span><span class="w">  </span><span class="n">⑦对function</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="n">tracer进行处理</span><span class="err">，</span><span class="n">当前使能的是function</span><span class="w"> </span><span class="n">tracer</span><span class="err">，</span><span class="n">所以ftrace_stub函数直接直接为ret</span><span class="err">，</span><span class="n">如下</span><span class="err">。</span>
<span class="n">ftrace_stub</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">arch</span><span class="o">/</span><span class="n">riscv</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">mcount</span><span class="p">.</span><span class="n">S</span><span class="o">:</span><span class="mi">55</span>
<span class="mi">55</span><span class="w">              </span><span class="n">ret</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c170</span><span class="w"> </span><span class="o">:</span><span class="w">  </span><span class="mi">8082</span><span class="w">            </span><span class="n">ret</span>
<span class="w">   </span><span class="mh">0xffffffff8000c172</span><span class="w"> </span><span class="o">:</span><span class="w">    </span><span class="mo">0001</span><span class="w">            </span><span class="n">nop</span>
<span class="n">ftrace_caller</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">arch</span><span class="o">/</span><span class="n">riscv</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">mcount</span><span class="o">-</span><span class="n">dyn</span><span class="p">.</span><span class="n">S</span><span class="o">:</span><span class="mi">158</span>
<span class="mi">158</span><span class="w">             </span><span class="n">RESTORE_ABI</span><span class="w">   </span><span class="n">⑧恢复寄存器</span><span class="err">，</span><span class="n">准备返回</span><span class="err">。</span>
<span class="n">ftrace_caller</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">arch</span><span class="o">/</span><span class="n">riscv</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">mcount</span><span class="o">-</span><span class="n">dyn</span><span class="p">.</span><span class="n">S</span><span class="o">:</span><span class="mi">159</span>
<span class="mi">159</span><span class="w">             </span><span class="n">jr</span><span class="w"> </span><span class="n">t0</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c7e2</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="mi">8282</span><span class="w">            </span><span class="n">jr</span><span class="w">      </span><span class="n">t0</span>
</code></pre></div>
<p>总结一下：</p>
<div class="codehilite"><pre><span></span><code><span class="n">ftrace_caller</span>
<span class="w">  </span><span class="n">call</span><span class="w">    </span><span class="n">ftrace_stub</span><span class="w">  </span><span class="o">=&gt;</span><span class="w">  </span><span class="n">call</span><span class="w">  </span><span class="n">function_trace_call</span>
<span class="n">trace_function</span>
<span class="w">  </span><span class="n">ftrace_exports</span>
<span class="w">    </span><span class="n">export</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">export</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
</code></pre></div>
<p>从上可知，ftrace_stub被赋值为function_trace_call，该函数是什么时候被替换的了？我们留着后续进行3.5章节进行分析。</p>
<h2 id="ftrace_init">ftrace_init</h2>
<p>ftrace_init通过读取__{start,stop}_mcount_loc字段中记录所有的函数入口地址，所有的入口地址被记录到最小的实例struct dyn_ftrace结构体中，这些结构体最终打包形成pg链表节点，首节点为start_pg，遍历start_pg链表执行ftrace_init_nop把4个nop指令。</p>
<h3 id="_3">数据结构</h3>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_4470aed58cda3c6837f16e30e4a2b05a.jpg\"><img alt='\"动态function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_4470aed58cda3c6837f16e30e4a2b05a.jpg\"/></a></p>
<p>在section中__{start,stop}_mcount_loc字段中记录所有的函数入口地址，每个函数入口地址都有一个struct dyn_ftrace数据结构实例来记录。每个页面（page）可以存放多个struct_ftrace实例，多个页面组成一个groups。每个组使用struct ftrace_pages节点来进行管理，多个struct ftrace_pages组成一个链表，具体的结构如上图所示。</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">ftrace_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">__start_mcount_loc</span><span class="p">[];</span>
<span class="k">extern</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">__stop_mcount_loc</span><span class="p">[];</span>
<span class="n">①</span><span class="w"> </span><span class="n">_start_mcount_loc和_stop_mcount_loc分别是所有入口函数段的开始和结束</span><span class="err">。</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_dyn_arch_init</span><span class="p">();</span>
<span class="w">    </span><span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>

<span class="w">    </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__stop_mcount_loc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__start_mcount_loc</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_info</span><span class="p">(</span><span class="err">\\\</span><span class="s">"ftrace: No functions to be traced?</span><span class="se">\\\\</span><span class="s">n</span><span class="se">\\\"</span><span class="s">);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="err">\\\</span><span class="s">"ftrace: allocating %ld entries in %ld pages</span><span class="se">\\\\</span><span class="s">n</span><span class="se">\\\"</span><span class="s">,</span>
<span class="w">        </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">ENTRIES_PER_PAGE</span><span class="p">));</span>
<span class="n">②</span><span class="w"> </span><span class="n">count所有的插桩点的总数</span><span class="err">，</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">ENTRIES_PER_PAGE</span><span class="p">))</span><span class="n">表示需要分配多少个pages</span><span class="err">，</span><span class="n">每个插桩点都使用struct</span><span class="w"> </span><span class="n">dyn_ftrace来记录</span><span class="err">。</span><span class="n">下面是qumu上的打印</span>
<span class="w"> </span><span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">ftrace</span><span class="o">:</span><span class="w"> </span><span class="n">allocating</span><span class="w"> </span><span class="mi">37736</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mi">148</span><span class="w"> </span><span class="n">pages</span>
<span class="n">一共有37736个插桩点</span><span class="err">，</span><span class="n">需要148</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="n">KB</span><span class="o">=</span><span class="mi">592</span><span class="n">KB的内存</span><span class="err">。</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_process_locs</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                  </span><span class="n">__start_mcount_loc</span><span class="p">,</span>
<span class="w">                  </span><span class="n">__stop_mcount_loc</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_warn</span><span class="p">(</span><span class="err">\\\</span><span class="s">"ftrace: failed to allocate entries for functions</span><span class="se">\\\\</span><span class="s">n</span><span class="se">\\\"</span><span class="s">);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">   </span><span class="n">③</span><span class="w"> </span><span class="n">将所有的插桩点地址记录到struct</span><span class="w"> </span><span class="n">dyn_ftrace实例中</span><span class="err">，</span><span class="n">如数据结构图中</span><span class="err">，</span><span class="n">每个插桩点都有要给struct</span><span class="w"> </span><span class="n">dyn_ftrace实例</span><span class="err">，</span><span class="n">实例空间分配page</span><span class="err">，</span><span class="n">每个page有多个struct</span><span class="w"> </span><span class="n">dyn_ftrace的实例</span><span class="err">。</span><span class="n">然后遍历地址将4条nop指令调整为2条nop指令</span><span class="err">（</span><span class="n">本章节的实验</span><span class="err">）。</span>
<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="err">\\\</span><span class="s">"ftrace: allocated %ld pages with %ld groups</span><span class="se">\\\\</span><span class="s">n</span><span class="se">\\\"</span><span class="s">,</span>
<span class="w">        </span><span class="n">ftrace_number_of_pages</span><span class="p">,</span><span class="w"> </span><span class="n">ftrace_number_of_groups</span><span class="p">);</span>

<span class="w">    </span><span class="n">last_ftrace_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">   </span><span class="n">④设置过滤</span><span class="err">？</span>
<span class="w">    </span><span class="n">set_ftrace_early_filters</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w"> </span><span class="nl">failed</span><span class="p">:</span>
<span class="w">    </span><span class="n">ftrace_disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_4">分配数据结构</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ftrace_process_locs</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">mod</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">start</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_page</span><span class="w"> </span><span class="o">*</span><span class="n">start_pg</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_page</span><span class="w"> </span><span class="o">*</span><span class="n">pg</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dyn_ftrace</span><span class="w"> </span><span class="o">*</span><span class="n">rec</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Shut up gcc */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="w">    </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">start_pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_allocate_pages</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">start_pg</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">    </span><span class="n">①</span><span class="w"> </span><span class="n">分配ftrace</span><span class="w"> </span><span class="n">page</span><span class="err">，</span><span class="n">里面存放的是struct</span><span class="w"> </span><span class="n">dyn_ftrace</span><span class="err">，</span><span class="n">具体结构如3</span><span class="mf">.3.1</span><span class="n">数据结构图</span><span class="err">，</span><span class="n">用于后续存放地址</span><span class="err">。</span>
<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_5">记录插桩地址</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ftrace_process_locs</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">mod</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">start</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">......</span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>
<span class="w">    </span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start_pg</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">end_offset</span><span class="p">;</span>
<span class="w">        </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_call_adjust</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">);</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Some architecture linkers will pad between</span>
<span class="cm">         * the different mcount_loc sections of different</span>
<span class="cm">         * object files to satisfy alignments.</span>
<span class="cm">         * Skip any NULL pointers.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="n">end_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">end_offset</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/* We should have allocated enough */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">))</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">rec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">records</span><span class="p">[</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">index</span><span class="o">++</span><span class="p">];</span>
<span class="w">        </span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">       </span><span class="n">②</span><span class="w"> </span><span class="n">遍历将所有的插桩点地址存储到struct</span><span class="w"> </span><span class="n">dyn_ftrace中</span><span class="err">。</span>
<span class="p">}</span>
<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="nop_2">更新插桩指令nop</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ftrace_process_locs</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">mod</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">start</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">......</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mod</span><span class="p">)</span>
<span class="w">        </span><span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="n">ftrace_update_code</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">start_pg</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mod</span><span class="p">)</span>
<span class="w">        </span><span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">ftrace_update_code</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">start_pg</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_pgs</span><span class="p">;</span><span class="w"> </span><span class="n">pg</span><span class="p">;</span><span class="w"> </span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ftrace_nop_initialize</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="w">            </span><span class="n">ftrace_init_nop</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">rec</span><span class="p">)</span>
<span class="w">            </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_make_nop</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="n">MCOUNT_ADDR</span><span class="p">);</span>
<span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nops</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">NOP4</span><span class="p">,</span><span class="w"> </span><span class="n">NOP4</span><span class="p">};</span>
<span class="w">                </span><span class="n">patch_text_nosync</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">nops</span><span class="p">,</span><span class="w"> </span><span class="n">MCOUNT_INSN_SIZE</span><span class="p">)</span>
<span class="w">                    </span><span class="n">patch_insn_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">insns</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="w">                        </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">patch_map</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">FIX_TEXT_POKE0</span><span class="p">);</span><span class="w"> </span><span class="c1">//fixmap FIX_TEXT_POKE0映射地址</span>
<span class="w">                        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_to_kernel_nofault</span><span class="p">(</span><span class="n">waddr</span><span class="p">,</span><span class="w"> </span><span class="n">insn</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">                            </span><span class="n">pagefault_disable</span><span class="p">()</span><span class="w"> </span><span class="c1">//关掉缺页异常</span>
<span class="w">                            </span><span class="n">copy_to_kernel_nofault_loop</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="p">,</span><span class="w"> </span><span class="n">Efault</span><span class="p">)</span>
<span class="w">                                </span><span class="n">__put_kernel_nofault</span>
<span class="w">                                </span><span class="n">__put_user_nocheck</span>
<span class="w">                                    </span><span class="n">__put_user_asm</span><span class="p">(</span><span class="err">\\\</span><span class="s">"sw</span><span class="se">\\\"</span><span class="s">, (x), __gu_ptr, __pu_err) //写内存指令</span>
<span class="w">                            </span><span class="n">pagefault_disable</span><span class="p">()</span>
<span class="w">                        </span><span class="n">patch_unmap</span><span class="p">(</span><span class="n">FIX_TEXT_POKE0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_6">入口函数与跟踪函数替换</h2>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_07408093cddfbfad032838cf73dea166.jpg\"><img alt='\"动态function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_07408093cddfbfad032838cf73dea166.jpg\"/></a></p>
<ul>
<li>入口函数：两条nop指令替换为ftrace_caller。</li>
<li>跟踪函数：call ftrace_stub替换为call function_trace_call。 前面描述了使能function tracer后会将nop指令替换为ftrace_caller和将ftrace_stub替换为function_trace_call。当echo function &gt; current_tracer就会通过文件系统调用到tracing_set_trace_write函数，本章节从该函数来具体分析下替换过程。</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">tracing_set_trace_write</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
<span class="w">            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">cnt</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracing_set_tracer</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trace_types</span><span class="p">;</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">①trace有很多个类型</span><span class="err">，</span><span class="n">匹配function类型获取到struct</span><span class="w"> </span><span class="n">tracer</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="err">。</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracer_init</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">tr</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">   </span><span class="n">②调用对应tracer的初始化函数</span><span class="err">，</span><span class="n">我们这里使能的是function</span><span class="err">，</span><span class="n">因此调用的是function_trace_init</span>
</code></pre></div>
<p>每个tracer都有一个对应的实例，对应function类型的tracer实例如下，会调用register_tracer(&amp;function_trace)函数进行注册tracer。</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">tracer</span><span class="w"> </span><span class="n">function_trace</span><span class="w"> </span><span class="n">__tracer_data</span><span class="w"> </span><span class="o">=</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="err">\\\</span><span class="s">"function</span><span class="se">\\\"</span><span class="s">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">init</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">function_trace_init</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">reset</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">function_trace_reset</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">start</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">function_trace_start</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">flags</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_flags</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">set_flag</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">func_set_flag</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">allow_instances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p>接下来，接着看看function_trace_init函数实现。</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">function_trace_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trace_array</span><span class="w"> </span><span class="o">*</span><span class="n">tr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ftrace_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">;</span>

<span class="w">    </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select_trace_function</span><span class="p">(</span><span class="n">func_flags</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="n">①根据func_flags</span><span class="p">.</span><span class="n">val来选择跟踪函数</span><span class="err">，</span><span class="n">这里默认选择function_trace_call</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">handle_func_repeats</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="w"> </span><span class="n">func_flags</span><span class="p">.</span><span class="n">val</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="w">    </span><span class="n">ftrace_init_array_ops</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">);</span>
<span class="n">②</span><span class="w"> </span><span class="n">设置struct</span><span class="w"> </span><span class="n">ftrace_ops</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function_trace_call</span>

<span class="w">    </span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">array_buffer</span><span class="p">.</span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">raw_smp_processor_id</span><span class="p">();</span>

<span class="w">    </span><span class="n">tracing_start_cmdline_record</span><span class="p">();</span>
<span class="n">tracing_start_function_trace</span><span class="p">(</span><span class="n">tr</span><span class="p">);</span>
<span class="n">③</span><span class="w"> </span><span class="n">注册ftrace_function</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="ftrace_ops_list">全局ftrace_ops_list</h3>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_636bf159943b2ca13c2aeeff534c70e4.jpg\"><img alt='\"动态function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_636bf159943b2ca13c2aeeff534c70e4.jpg\"/></a></p>
<p>如上图，ftrace_call的地方可以需要trace function，也要用于perf，那么就会再perf和function trace上面再封装一层，把ftrace_stub替换为ftrace_ops_list_func，在系统中ftrace_ops_list_func = arch_ftrace_ops_list_func。</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">arch_ftrace_ops_list_func</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">,</span>
<span class="w">                   </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_regs</span><span class="w"> </span><span class="o">*</span><span class="n">fregs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">__ftrace_ops_list_func</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">fregs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">nokprobe_inline</span><span class="w"> </span><span class="kt">void</span>
<span class="n">__ftrace_ops_list_func</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">,</span>
<span class="w">               </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ignored</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_regs</span><span class="w"> </span><span class="o">*</span><span class="n">fregs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_get_regs</span><span class="p">(</span><span class="n">fregs</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bit</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * The ftrace_test_and_set_recursion() will disable preemption,</span>
<span class="cm">     * which is required since some of the ops may be dynamically</span>
<span class="cm">     * allocated, they must be freed after a synchronize_rcu().</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trace_test_and_set_recursion</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">,</span><span class="w"> </span><span class="n">TRACE_LIST_START</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="n">ftrace_ops_list是一个struct</span><span class="w"> </span><span class="n">ftrace_ops类型的链表</span><span class="err">，</span><span class="n">每个ftrace_ops代表一个ftrace函数跟踪类型</span><span class="err">，</span><span class="n">默认是遍历ftrace_ops_list</span><span class="err">，</span><span class="n">调用ops函数</span>
<span class="w">    </span><span class="n">do_for_each_ftrace_op</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">ftrace_ops_list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Stub functions don\\\'t need to be called nor tested */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_OPS_FL_STUB</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Check the following for each ops before calling their func:</span>
<span class="cm">         *  if RCU flag is set, then rcu_is_watching() must be true</span>
<span class="cm">         *  Otherwise test if the ip matches the ops filter</span>
<span class="cm">         *</span>
<span class="cm">         * If any of the above fails then the op-&gt;func() is not executed.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_OPS_FL_RCU</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">rcu_is_watching</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="n">ftrace_ops_test</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FTRACE_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">pr_warn</span><span class="p">(</span><span class="err">\\\</span><span class="s">"op=%p %pS</span><span class="se">\\\\</span><span class="s">n</span><span class="se">\\\"</span><span class="s">, op, op);</span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">fregs</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">while_for_each_ftrace_op</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
<span class="nl">out</span><span class="p">:</span>
<span class="w">    </span><span class="n">trace_clear_recursion</span><span class="p">(</span><span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>ftrace_ops数据结构：</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ftrace_func_t</span><span class="w">           </span><span class="n">func</span><span class="p">;</span><span class="w">  </span><span class="c1">//替换ftrace_stub的函数</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="n">__rcu</span><span class="w">     </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w">                </span><span class="o">*</span><span class="n">private</span><span class="p">;</span>
<span class="w">    </span><span class="n">ftrace_func_t</span><span class="w">           </span><span class="n">saved_func</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_DYNAMIC_FTRACE</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops_hash</span><span class="w">      </span><span class="n">local_hash</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops_hash</span><span class="w">      </span><span class="o">*</span><span class="n">func_hash</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops_hash</span><span class="w">      </span><span class="n">old_hash</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">trampoline</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">trampoline_size</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">        </span><span class="n">list</span><span class="p">;</span>
<span class="w">    </span><span class="n">ftrace_ops_func_t</span><span class="w">       </span><span class="n">ops_func</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>
</code></pre></div>
<p>默认的ftrace_ops为：</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="n">global_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">func</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_stub</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">local_hash</span><span class="p">.</span><span class="n">notrace_hash</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">EMPTY_HASH</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">local_hash</span><span class="p">.</span><span class="n">filter_hash</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">EMPTY_HASH</span><span class="p">,</span>
<span class="w">    </span><span class="n">INIT_OPS_HASH</span><span class="p">(</span><span class="n">global_ops</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">flags</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">FTRACE_OPS_FL_INITIALIZED</span><span class="w"> </span><span class="o">|</span>
<span class="w">                      </span><span class="n">FTRACE_OPS_FL_PID</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p>如果头结点是 ftrace_list_end，表示没有ops注册，代表无需函数跟踪，将 func 设置为空的跟踪函数 ftrace_stub。 如果头结点的下一个结点是 ftrace_list_end，表示只有一个ops注册，且当此ops不是动态ops（比如：livepatch），且架构支持传递 ops 到跟踪函数，则将 func 设置为 ops-&gt;func，否则设置为 ftrace_ops_list_func() 如果链表中有不止一个的 ops 注册，则将 func 设置为 ftrace_ops_list_func() ftrace_ops_list_func() 为区别于全局跟踪函数，我们在此称之为列表跟踪函数。此函数在 vmlinux 链接时，指向 arch_ftrace_ops_list_func，执行时会遍历 ftrace_ops_list，结合 ops-&gt;func_hash 来判断是否需要对当前 ip 执行 ops-&gt;func，也就是说 ftrace_ops_list_func() 不仅会调用多个 ops 的跟踪函数，也会保证 ops 跟踪函数处理的函数是应该被跟踪的。 本实验是将func 设置到 ftrace_trace_function()。当前设置 function tracer 的流程中，ops 就是 global_ops 且 ftrace_ops_list 链表只有 global_ops 这一个注册。</p>
<h3 id="ftrace_function">注册ftrace_function</h3>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">register_ftrace_function</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">register_ftrace_function_nolock</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_startup</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">ftrace_startup</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ftrace_disabled</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__register_ftrace_function</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="n">①添加ops</span><span class="err">（</span><span class="n">global_ops</span><span class="err">）</span><span class="n">到全局ops链表ftrace_ops_list中</span><span class="err">，</span><span class="n">并设置全局跟踪函数ftrace_trace_function为ops</span><span class="o">-&gt;</span><span class="n">func</span><span class="err">。</span>

<span class="w">    </span><span class="n">ftrace_start_up</span><span class="o">++</span><span class="p">;</span>

<span class="w">    </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">FTRACE_OPS_FL_ENABLED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">FTRACE_OPS_FL_ADDING</span><span class="p">;</span>
<span class="w"> </span><span class="n">②根据ops</span><span class="o">-&gt;</span><span class="n">func_hash</span><span class="o">-&gt;</span><span class="n">filter_hash更新入口函数表中每个函数记录rec的ip</span><span class="w"> </span><span class="n">modfy位</span><span class="err">。</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_hash_ipmodify_enable</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Rollback registration process */</span>
<span class="w">        </span><span class="n">__unregister_ftrace_function</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">        </span><span class="n">ftrace_start_up</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">FTRACE_OPS_FL_ENABLED</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_OPS_FL_DYNAMIC</span><span class="p">)</span>
<span class="w">            </span><span class="n">ftrace_trampoline_free</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ftrace_hash_rec_enable</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">        </span><span class="n">command</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">FTRACE_UPDATE_CALLS</span><span class="p">;</span>
<span class="n">③判断是否有函数入口需要更新</span><span class="err">，</span><span class="n">如果需要更新则command设置为FTRACE_UPDATE_CALLS</span><span class="err">。</span>
<span class="n">这里的入口函数就是替换nop指令</span><span class="err">。</span><span class="n">入口函数的替换和跟踪函数替换是不一样的</span><span class="err">，</span><span class="n">注意区分</span><span class="err">。</span><span class="w">  </span>
<span class="w">    </span><span class="n">ftrace_startup_enable</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
<span class="w">    </span><span class="n">④判断报错的跟踪函数saved_ftrace_func与当前跟踪函数ftrace_trace_function是否相同</span><span class="err">，</span><span class="n">如果不同则表示需要更新跟踪函数</span><span class="err">，</span><span class="n">command设置为FTRADE_UPDATE_TRACE_FUNC</span><span class="err">，</span><span class="n">之后执行ftrace_run_update_code进行更新</span><span class="err">。</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * If ftrace is in an undefined state, we just remove ops from list</span>
<span class="cm">     * to prevent the NULL pointer, instead of totally rolling it back and</span>
<span class="cm">     * free trampoline, because those actions could cause further damage.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ftrace_disabled</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">__unregister_ftrace_function</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">FTRACE_OPS_FL_ADDING</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">__register_ftrace_function</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>

<span class="n">add_ftrace_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ftrace_ops_list</span><span class="p">,</span><span class="w"> </span><span class="n">ops</span><span class="p">);</span>
<span class="n">①</span><span class="w"> </span><span class="n">将目标trace添加到全局链表ftrace_ops_list中</span><span class="err">。</span>

<span class="w">    </span><span class="cm">/* Always save the function, and reset at unregistering */</span>
<span class="w">    </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">saved_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>
<span class="w">    </span><span class="n">②</span><span class="w"> </span><span class="n">保存当前要trace的函数</span><span class="err">。</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ftrace_pids_enabled</span><span class="p">(</span><span class="n">ops</span><span class="p">))</span>
<span class="w">        </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_pid_func</span><span class="p">;</span>
<span class="w">    </span><span class="n">③</span><span class="w"> </span><span class="n">如果设置的特定pid</span><span class="w"> </span><span class="n">进行trace</span><span class="err">，</span><span class="n">将trace函数更新为</span><span class="w"> </span><span class="n">ftrace_pid_func</span><span class="err">，</span><span class="n">即ftrace_stub更新为ftrace_pid_func</span>
<span class="w">    </span><span class="n">ftrace_update_trampoline</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ftrace_enabled</span><span class="p">)</span>
<span class="w">        </span><span class="n">update_ftrace_function</span><span class="p">();</span>
<span class="n">④</span><span class="w"> </span><span class="n">将当前的trace函数赋值到ftrace_trace_function中</span><span class="err">，</span><span class="n">表示当前要修改的目标函数</span><span class="err">。</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_7">函数过滤处理</h3>
<p>如果设置了过滤函数不需要进行跟踪，需对相应的桩点实例dyn_ftrace设置标记，FTRACE_FL_DISABLED标志表示不需要更新入口函数，FTRACE_FL_IPMODIFY表示需要更新。需要过滤的函数，统一记录在ops-&gt;func_hash-&gt;filter_hash表中。</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">__ftrace_hash_update_ipmodify</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">,</span>
<span class="w">                     </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_hash</span><span class="w"> </span><span class="o">*</span><span class="n">old_hash</span><span class="p">,</span>
<span class="w">                     </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_hash</span><span class="w"> </span><span class="o">*</span><span class="n">new_hash</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="cm">/* Update rec-&gt;flags */</span>
<span class="n">do_for_each_ftrace_rec</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span><span class="w"> </span><span class="n">rec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">遍历所有插桩点</span><span class="err">，</span><span class="n">是否需要过滤掉</span><span class="err">，</span><span class="n">打上对应的标记</span><span class="err">。</span>
<span class="p">}</span><span class="w"> </span><span class="n">while_for_each_ftrace_rec</span><span class="p">();</span>

<span class="p">}</span>
</code></pre></div>
<h3 id="ftrace-modify-all-code">ftrace modify all code</h3>
<p>如果要更新入口函数，标志设置为 FTRACE_UPDATE_CALLS；如果要更新跟踪函数，标志设置为FTRACE_UPDATE_TRACE_FUNC。如果使能了ftrace gragh，则标志设置为FTRACE_START_FUNC_RET。</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ftrace_modify_all_code</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_UPDATE_TRACE_FUNC</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mod_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">update</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update_ftrace_func</span><span class="p">(</span><span class="n">ftrace_ops_list_func</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FTRACE_WARN_ON</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">    </span><span class="n">①</span><span class="w"> </span><span class="n">先将跟踪函数替换为ftrace_ops_list_func</span><span class="err">。</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">command</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_UPDATE_CALLS</span><span class="p">)</span>
<span class="w">        </span><span class="n">ftrace_replace_code</span><span class="p">(</span><span class="n">mod_flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">FTRACE_MODIFY_ENABLE_FL</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">command</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_DISABLE_CALLS</span><span class="p">)</span>
<span class="w">        </span><span class="n">ftrace_replace_code</span><span class="p">(</span><span class="n">mod_flags</span><span class="p">);</span>
<span class="n">②更新入口函数</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">update</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ftrace_trace_function</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ftrace_ops_list_func</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">function_trace_op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">set_function_trace_op</span><span class="p">;</span>
<span class="w">        </span><span class="n">smp_wmb</span><span class="p">();</span>
<span class="w">        </span><span class="cm">/* If irqs are disabled, we are in stop machine */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">())</span>
<span class="w">            </span><span class="n">smp_call_function</span><span class="p">(</span><span class="n">ftrace_sync_ipi</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update_ftrace_func</span><span class="p">(</span><span class="n">ftrace_trace_function</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FTRACE_WARN_ON</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">③</span><span class="w"> </span><span class="n">判断ftrace_trace_function</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ftrace_ops_list_func</span><span class="err">，</span><span class="n">则重新将跟踪函数更新为ftrace_trace_function</span><span class="w"> </span><span class="err">。</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">command</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_START_FUNC_RET</span><span class="p">)</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_enable_ftrace_graph_caller</span><span class="p">();</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">command</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_STOP_FUNC_RET</span><span class="p">)</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_disable_ftrace_graph_caller</span><span class="p">();</span>
</code></pre></div>
<h4 id="_8">更新跟踪函数</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">update_ftrace_func</span><span class="p">(</span><span class="n">ftrace_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">)</span>
<span class="n">ftrace_update_ftrace_func</span><span class="p">(</span><span class="n">ftrace_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">)</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__ftrace_modify_call</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ftrace_call</span><span class="p">,</span>
<span class="w">                       </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__ftrace_modify_call</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ftrace_regs_call</span><span class="p">,</span>
<span class="w">                       </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">__ftrace_modify_call</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">hook_pos</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">target</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ra</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">call</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nops</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">NOP4</span><span class="p">,</span><span class="w"> </span><span class="n">NOP4</span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
<span class="w">        </span><span class="n">make_call_ra</span><span class="p">(</span><span class="n">hook_pos</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">make_call_t0</span><span class="p">(</span><span class="n">hook_pos</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">);</span>
<span class="w">    </span><span class="n">计算跟踪函数的指令</span><span class="err">，</span><span class="n">修改地址ftrace_call或ftrace_regs_call处的跳转地址</span><span class="err">，</span><span class="n">默认是ftrace_stub</span><span class="err">，</span><span class="n">即完成了ftrace_call标签处的跳转替换</span><span class="err">，</span><span class="n">跟踪函数替换完成</span><span class="err">。</span>
<span class="w">    </span><span class="cm">/* Replace the auipc-jalr pair at once. Return -EPERM on write error. */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">patch_text_nosync</span>
<span class="w">        </span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">hook_pos</span><span class="p">,</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">nops</span><span class="p">,</span><span class="w"> </span><span class="n">MCOUNT_INSN_SIZE</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="w">    </span><span class="n">patch_text_nosync函数在3</span><span class="mf">.4.4</span><span class="n">章节有简述</span><span class="err">，</span><span class="n">这里就不再重复</span><span class="err">。</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_9">更新入口函数</h4>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__weak</span><span class="w"> </span><span class="nf">ftrace_replace_code</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">mod_flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dyn_ftrace</span><span class="w"> </span><span class="o">*</span><span class="n">rec</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_page</span><span class="w"> </span><span class="o">*</span><span class="n">pg</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_MODIFY_ENABLE_FL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">schedulable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_MODIFY_MAY_SLEEP_FL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ftrace_disabled</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="n">①</span><span class="w"> </span><span class="n">遍历每个入口函数的</span><span class="err">，</span><span class="n">获取对应的dyn_ftrace实例</span><span class="err">。</span>
<span class="w">    </span><span class="n">do_for_each_ftrace_rec</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span><span class="w"> </span><span class="n">rec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="n">②</span><span class="w"> </span><span class="n">如果函数入口不需要更新</span><span class="err">，</span><span class="n">则循环继续</span><span class="err">（</span><span class="n">判断是否设置FTRACE_FL_DISABLED</span><span class="err">）</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">skip_record</span><span class="p">(</span><span class="n">rec</span><span class="p">))</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__ftrace_replace_code</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="n">enable</span><span class="p">);</span>
<span class="w">        </span><span class="n">③</span><span class="w"> </span><span class="n">将函数入口地址替换</span><span class="err">（</span><span class="n">默认为nop</span><span class="err">）</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">failed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ftrace_bug</span><span class="p">(</span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="n">rec</span><span class="p">);</span>
<span class="w">            </span><span class="cm">/* Stop processing */</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">schedulable</span><span class="p">)</span>
<span class="w">            </span><span class="n">cond_resched</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">while_for_each_ftrace_rec</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">__ftrace_replace_code</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dyn_ftrace</span><span class="w"> </span><span class="o">*</span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ftrace_old_addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ftrace_addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="n">ftrace_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_get_addr_new</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
<span class="w">    </span><span class="n">①</span><span class="w"> </span><span class="n">获取要在函数入口要插桩点的函数地址</span><span class="err">。</span><span class="n">返回结果有有以下几种情况</span><span class="err">：</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">FTRACE_FL_DIRECT</span><span class="err">：</span><span class="w"> </span><span class="n">在direct_functions中获取</span><span class="err">（</span><span class="n">用户自定义</span><span class="err">？）</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">FTRACE_FL_TRAMP</span><span class="err">：</span><span class="w"> </span><span class="n">跳板函数</span><span class="err">？</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">FTRACE_FL_REGS</span><span class="err">：</span><span class="n">FTRACE_REGS_ADDR</span><span class="err">，</span><span class="n">默认为ftrace_regs_caller</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">默认</span><span class="err">：</span><span class="w"> </span><span class="n">FTRACE_ADDR</span><span class="w"> </span><span class="err">，</span><span class="n">默认为ftrace_caller</span>
<span class="w">    </span><span class="cm">/* This needs to be done before we call ftrace_update_record */</span>
<span class="w">    </span><span class="n">ftrace_old_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_get_addr_curr</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_update_record</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="n">enable</span><span class="p">);</span>

<span class="w">    </span><span class="n">ftrace_bug_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FTRACE_BUG_UNKNOWN</span><span class="p">;</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">FTRACE_UPDATE_IGNORE</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">FTRACE_UPDATE_MAKE_CALL</span><span class="p">:</span>
<span class="w">        </span><span class="n">ftrace_bug_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FTRACE_BUG_CALL</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ftrace_make_call</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="n">ftrace_addr</span><span class="p">);</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">FTRACE_UPDATE_MAKE_NOP</span><span class="p">:</span>
<span class="w">        </span><span class="n">ftrace_bug_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FTRACE_BUG_NOP</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ftrace_make_nop</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="n">ftrace_old_addr</span><span class="p">);</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">FTRACE_UPDATE_MODIFY_CALL</span><span class="p">:</span>
<span class="w">        </span><span class="n">ftrace_bug_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FTRACE_BUG_UPDATE</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ftrace_modify_call</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="n">ftrace_old_addr</span><span class="p">,</span><span class="w"> </span><span class="n">ftrace_addr</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">②</span><span class="w"> </span><span class="n">将入口函数的桩点替换为指定标签函数</span><span class="err">。</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="cm">/* unknown ftrace bug */</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_10">总结</h2>
<p>本章节，我们重点分析了function tracer使能后的实现过程，分析了如何将函数入口替换为ftrace_caller，分析了ftrace_caller中ftrace_call标签处如何被替换成跳转到ftrace_trace_function。整个ftrace动态过程主要实现了以下功能 - 能够指定内核函数入口进行指令替换，使其跳转到ftrace_caller。 - 能够对跟踪函数进行更新，使指定的跟踪函数能够被调用。 在动态函数的跟踪分析过程中，register_ftrace_function和ftrace_set_filter这两个函数至关重要，这两个函数使能function tracer的时候会调用并触发指令替换和跟踪函数更新动作。同时这两个函数也是接口，用户可以通过调用这两个函数实现自己的tracer。</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * register_ftrace_function - register a function for profiling</span>
<span class="cm"> * @ops:    ops structure that holds the function for profiling.</span>
<span class="cm"> *</span>
<span class="cm"> * Register a function to be called by all functions in the</span>
<span class="cm"> * kernel.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: @ops-&gt;func and all the functions it calls must be labeled</span>
<span class="cm"> *       with \\\"notrace\\\", otherwise it will go into a</span>
<span class="cm"> *       recursive loop.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">register_ftrace_function</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="n">lock_direct_mutex</span><span class="p">();</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prepare_direct_functions_for_ipmodify</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out_unlock</span><span class="p">;</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">register_ftrace_function_nolock</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>

<span class="nl">out_unlock</span><span class="p">:</span>
<span class="w">    </span><span class="n">unlock_direct_mutex</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">register_ftrace_function</span><span class="p">);</span>
</code></pre></div>
<p>register_ftrace_function是一个通用的注册函数，传递的参数struct ftrace_ops *ops即想要在函数入口插入跟踪的函数，无论是function tracer、irqsoff、fprobes、trace_event等函数都是调用该函数进行注册插桩，也可以自定义自己想要插桩的函数。 从原理上来讲，使能了-fpatchable-function-entry编译参数后，入口函数处就占了坑位，默认是先用nop指令填充，那么可以在运行阶段想换成啥就换成啥。</p></div>
  <div class="post-nav">
    <a class="prev" href="静态ftrace.html">← 静态ftrace</a>
    <a class="next" href="ftrace-概述.html">ftrace-概述 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

