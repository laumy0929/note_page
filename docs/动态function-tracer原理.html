<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>åŠ¨æ€function traceråŸç† - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#fpatchable-function-entry">fpatchable-function-entryé€‰é¡¹</a><ul></ul></li><li><a href="#risc-v">risc-v å†…æ ¸ç¼–è¯‘ä¸é“¾æ¥</a><ul></ul></li><li><a href="#_1">æ¡©ç‚¹æ›´æ–°è¿‡ç¨‹æ¦‚è§ˆ</a><ul><li><a href="#_2">ç¼–è¯‘æ’æ¡©ç‚¹</a></li><li><a href="#nop">å¯åŠ¨åˆå§‹åŒ–è°ƒæ•´nopæŒ‡ä»¤é•¿åº¦</a></li><li><a href="#nop_1">æ›¿æ¢å…¥å£å‡½æ•°çš„nop</a></li><li><a href="#ftrace_stub">æ›¿æ¢è·Ÿè¸ªå‡½æ•°ftrace_stub</a></li><li><a href="#ftrace_caller">ftrace_callerè°ƒç”¨æµç¨‹</a></li></ul></li><li><a href="#ftrace_init">ftrace_init</a><ul><li><a href="#_3">æ•°æ®ç»“æ„</a></li><li><a href="#_4">åˆ†é…æ•°æ®ç»“æ„</a></li><li><a href="#_5">è®°å½•æ’æ¡©åœ°å€</a></li><li><a href="#nop_2">æ›´æ–°æ’æ¡©æŒ‡ä»¤nop</a></li></ul></li><li><a href="#_6">å…¥å£å‡½æ•°ä¸è·Ÿè¸ªå‡½æ•°æ›¿æ¢</a><ul><li><a href="#ftrace_ops_list">å…¨å±€ftrace_ops_list</a></li><li><a href="#ftrace_function">æ³¨å†Œftrace_function</a></li><li><a href="#_7">å‡½æ•°è¿‡æ»¤å¤„ç†</a></li><li><a href="#ftrace-modify-all-code">ftrace modify all code</a></li></ul></li><li><a href="#_10">æ€»ç»“</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>åŠ¨æ€function traceråŸç†</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-08-28
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="fpatchable-function-entry">fpatchable-function-entryé€‰é¡¹</h2>
<p>ç¼–è¯‘æ—¶æŒ‡å®š-fpatchable-function-entry=N[,M]ï¼Œâ‘ ä¼šåœ¨å‡½æ•°å…¥å£ç¬¬ä¸€ä¸ªæŒ‡ä»¤ä¹‹å‰æ’å…¥Nä¸ªnopï¼Œä½†æ˜¯ä¼šä¿ç•™Mä¸ªæ”¾åˆ°å‡½æ•°å…¥å£ä¹‹å‰ï¼Œå¦‚æœçœç•¥Måˆ™é»˜è®¤ä¸º0ï¼›â‘¡åŒæ—¶éœ€è¦ä¸€ä¸ªç‰¹æ®Šçš„-fpatchable-function-entryæ®µæ¥è®°å½•æ‰€æœ‰å‡½æ•°çš„å…¥å£ï¼Œå¦‚ä¸‹è“è‰²éƒ¨åˆ†ã€‚nopæŒ‡ä»¤ä¿ç•™äº†é¢å¤–çš„ç©ºé—´ï¼Œå¯ç”¨äºåœ¨è¿è¡Œæ—¶ä¿®æ”¹nopæŒ‡ä»¤ï¼Œæ·»åŠ è‡ªå·±æƒ³è¦çš„æ¡©ç‚¹ï¼Œå‰ææ˜¯ä»£ç æ®µå¯å†™çš„ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">echo</span><span class="w"> </span><span class="err">\'</span><span class="kt">void</span><span class="w"> </span><span class="n">test</span><span class="p">(){;}</span><span class="err">\'</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">c</span>

<span class="n">$</span><span class="w"> </span><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span><span class="n">gcc</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">fpatchable</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">entry</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="o">-</span>
<span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span><span class="n">gcc</span><span class="o">:</span><span class="w"> </span><span class="n">warning</span><span class="o">:</span><span class="w"> </span><span class="err">\'</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="n">c</span><span class="err">\'</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">effect</span>
<span class="w">        </span><span class="p">.</span><span class="n">file</span><span class="w">   </span><span class="err">\</span><span class="s">"test.c</span><span class="se">\"</span>
<span class="w">        </span><span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">nopic</span>
<span class="w">        </span><span class="p">.</span><span class="n">text</span>
<span class="w">        </span><span class="p">.</span><span class="n">align</span><span class="w">  </span><span class="mi">1</span>
<span class="w">        </span><span class="p">.</span><span class="n">globl</span><span class="w">  </span><span class="n">test</span>
<span class="w">        </span><span class="p">.</span><span class="n">section</span><span class="w">        </span><span class="n">__patchable_function_entries</span><span class="p">,</span><span class="err">\</span><span class="s">"aw</span><span class="se">\"</span><span class="s">,@progbits</span>
<span class="w">        </span><span class="p">.</span><span class="n">align</span><span class="w">  </span><span class="mi">3</span>
<span class="w">        </span><span class="mf">.8</span><span class="n">byte</span><span class="w">  </span><span class="p">.</span><span class="n">LPFE1</span>
<span class="w">        </span><span class="p">.</span><span class="n">text</span>
<span class="p">.</span><span class="n">LPFE1</span><span class="o">:</span>
<span class="w">        </span><span class="n">nop</span>
<span class="w">        </span><span class="p">.</span><span class="n">type</span><span class="w">   </span><span class="n">test</span><span class="p">,</span><span class="w"> </span><span class="err">@</span><span class="n">function</span>
<span class="nl">test</span><span class="p">:</span>
<span class="w">        </span><span class="n">nop</span>
<span class="w">        </span><span class="n">nop</span>
<span class="w">        </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">-16</span>
<span class="w">        </span><span class="n">sd</span><span class="w">      </span><span class="n">s0</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">        </span><span class="n">addi</span><span class="w">    </span><span class="n">s0</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">16</span>
<span class="w">        </span><span class="n">nop</span>
<span class="w">        </span><span class="n">ld</span><span class="w">      </span><span class="n">s0</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">        </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">16</span>
<span class="w">        </span><span class="n">jr</span><span class="w">      </span><span class="n">ra</span>
<span class="w">        </span><span class="p">.</span><span class="n">size</span><span class="w">   </span><span class="n">test</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="o">-</span><span class="n">test</span>
<span class="w">        </span><span class="p">.</span><span class="n">ident</span><span class="w">  </span><span class="err">\</span><span class="s">"GCC: (Xuantie-900 linux-5.10.4 glibc gcc Toolchain V2.8.1 B-20240115) 10.4.0</span><span class="se">\"</span>
<span class="w">        </span><span class="p">.</span><span class="n">section</span><span class="w">        </span><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">GNU</span><span class="o">-</span><span class="n">stack</span><span class="p">,</span><span class="err">\</span><span class="s">"</span><span class="se">\"</span><span class="s">,@progbits</span>
</code></pre></div>
<h2 id="risc-v">risc-v å†…æ ¸ç¼–è¯‘ä¸é“¾æ¥</h2>
<p>åœ¨æœ¬æ–‡çš„å®éªŒå¹³å°çš„RISC-Væ¶æ„ä¸­ï¼Œä½¿ç”¨ç¼–è¯‘é€‰é¡¹-fpatchable-function-entryè¿›è¡Œç¼–è¯‘ï¼Œåœ¨å†…æ ¸arch/riscv/Makefileä¸­æŒ‡å®šCC_FLAGS_FTRACE:=-fpatchable-function-entry=Xæ¥ç¼–è¯‘å†…æ ¸ç»„ä»¶ã€‚</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_ecdbca386943ae87e8907eb2d9c8fcaa.jpg\"><img alt='\"åŠ¨æ€function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_ecdbca386943ae87e8907eb2d9c8fcaa.jpg\"/></a></p>
<p>æ·»åŠ ä¸Šé¢å‚æ•°åï¼Œç¼–è¯‘åçš„ç›®æ ‡æ–‡ä»¶ï¼Œå°±ä¼šæœ‰ä¸¤ä¸ªç‰¹å¾ï¼š - æ¯ä¸ªå‡½æ•°å…¥å£ï¼Œç¬¬ä¸€æ¡æŒ‡ä»¤å‰æ’å…¥nopæŒ‡ä»¤ã€‚ - åœ¨__patchable_function_entriesæ®µé‡å®šä½ä¸­ï¼Œè®°å½•äº†å½“å‰ç›®æ ‡æ–‡ä»¶æ‰€æœ‰å‡½æ•°å…¥å£åœ°å€ã€‚</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_0c27759308da4fa6535c74ebd02e8b22.jpg\"><img alt='\"åŠ¨æ€function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_0c27759308da4fa6535c74ebd02e8b22.jpg\"/></a></p>
<p>Linuxå†…æ ¸æœ€ç»ˆä¼šé“¾æ¥åˆå¹¶æˆvmlinux.oï¼Œåœ¨é“¾æ¥é‡å®šä½é˜¶æ®µä¼šå°†æ‰€æœ‰.oä¸­çš„__patchable_function_entriesæ®µé‡å®šä½æ®µä¿¡æ¯åˆå¹¶èµ·æ¥ã€‚å…·ä½“åœ¨é“¾æ¥è„šæœ¬ä¸­include/asm-generic/vmlinux.lds.hä¸­MCOUNT_RECçš„æè¿°ã€‚å¦‚ä¸Šå›¾ï¼ŒnopæŒ‡ä»¤çš„é•¿åº¦ä½2å­—èŠ‚ï¼ˆ16bitï¼Œç”¨çš„æ˜¯å‹ç¼©æŒ‡ä»¤c.nopï¼‰ï¼Œä¸ç®¡æ˜¯å¤šå°‘ä½ç³»ç»Ÿè¿™æ˜¯é»˜è®¤å†…æ ¸ç¼–è¯‘nopæŒ‡ä»¤çš„é•¿åº¦ï¼Œå› æ­¤å‡½æ•°å…¥å£æ’å…¥çš„nopæ€»é•¿åº¦4*2å­—èŠ‚=8å­—èŠ‚ï¼Œè¿™8å­—èŠ‚çš„nopä¼šåœ¨å¼€å¯å‡½æ•°è·Ÿè¸ªçš„æ—¶å€™ä¿®æ”¹ä½å¯¹åº”é•¿åº¦çš„è·³è½¬æŒ‡ä»¤ï¼Œåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­æˆ–å‡½æ•°è·Ÿè¸ªå…³é—­çš„æ—¶å€™ä¿®æ”¹ä½å¯¹åº”é•¿åº¦çš„nopã€‚</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_a39c094d7d930bb377d08e9076306a9c.jpg\"><img alt='\"åŠ¨æ€function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_a39c094d7d930bb377d08e9076306a9c.jpg\"/></a></p>
<p>ä»ä¸Šå¯çŸ¥ï¼Œå¯ä»¥é€šè¿‡__{start,stop}_mcount_locç¬¦å·è·å–åˆ°æ‰€æœ‰å‡½æ•°å…¥å£ï¼ŒåŒæ—¶æ¯ä¸ªå‡½æ•°å…¥å£éƒ½ä¼šæ’å…¥nopæŒ‡ä»¤ï¼Œç›¸å½“äºå®šä½äº†æ‰€æœ‰å‡½æ•°çš„å…¥å£åœ¨å“ªï¼Œåç»­å°±å¯ä»¥å¯¹æŒ‡ä»¤è¿›è¡Œä¿®æ”¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ä¸ºä»€ä¹ˆè¦ç”¨ä¸€ä¸ªsectionæ¥è®°å½•æ‰€æœ‰å‡½æ•°å…¥å£åœ°å€ï¼Ÿè¿™æ˜¯å› ä¸ºè®°å½•çš„å‡½æ•°å…¥å£åœ°å€ï¼Œå°±è®°å½•çš„nopæŒ‡ä»¤çš„ä½ç½®ï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ‰èƒ½æŠŠnopæŒ‡ä»¤è¿›è¡Œä¿®æ”¹ä¸ºæŒ‡å®šçš„è·Ÿè¸ªå‡½æ•°ã€‚åœ¨åŠ¨æ€ftraceä¸­ï¼Œç³»ç»Ÿå¯åŠ¨åˆå§‹åŒ–æ—¶ä¼šå°†æ‰€æœ‰çš„å‡½æ•°å…¥å£åœ°å€è®°å½•åˆ°struct dyn_ftraceç»“æ„ä½“ä¸­ï¼Œ3.4ç« èŠ‚ä¼šä»‹ç»åˆ°ã€‚</p>
<h2 id="_1">æ¡©ç‚¹æ›´æ–°è¿‡ç¨‹æ¦‚è§ˆ</h2>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_4505811760e81d50eb91432c2cdaf425.jpg\"><img alt='\"åŠ¨æ€function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_4505811760e81d50eb91432c2cdaf425.jpg\"/></a></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥å‡½æ•°vfs_readè¿›è¡Œå®ä¾‹åˆ†æï¼Œä»ç¼–è¯‘åˆ°ç³»ç»Ÿå¯åŠ¨ï¼Œå†åˆ°ä½¿èƒ½function traceè¿™ä¸€è¿‡ç¨‹æ¥è¿›è¡Œç®€å•åˆ†ææ’è£…ç‚¹å˜åŒ–ã€‚</p>
<h3 id="_2">ç¼–è¯‘æ’æ¡©ç‚¹</h3>
<p>æœ¬æ–‡çš„å®éªŒå¹³å°=-fpatchable-function-entry=4ï¼Œå³ç¼–è¯‘å®Œæˆåï¼Œéœ€è¦åœ¨å‡½æ•°å…¥å£å¤„æ’å…¥4ä¸ªnopæŒ‡ä»¤ï¼Œæˆ‘ä»¬é€šè¿‡riscv64-unknown-linux-gnu-objdump -D vmlinux &gt; logåæ±‡ç¼–æŸ¥çœ‹vfs_readå¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nl">ffffffff8039e398</span><span class="w"> </span><span class="p">:</span>
<span class="nl">ffffffff8039e398</span><span class="p">:</span><span class="w">   </span><span class="mo">0001</span><span class="w">                    </span><span class="n">nop</span>
<span class="nl">ffffffff8039e39a</span><span class="p">:</span><span class="w">   </span><span class="mo">0001</span><span class="w">                    </span><span class="n">nop</span>
<span class="nl">ffffffff8039e39c</span><span class="p">:</span><span class="w">   </span><span class="mo">0001</span><span class="w">                    </span><span class="n">nop</span>
<span class="nl">ffffffff8039e39e</span><span class="p">:</span><span class="w">   </span><span class="mo">0001</span><span class="w">                    </span><span class="n">nop</span>
<span class="nl">ffffffff8039e3a0</span><span class="p">:</span><span class="w">   </span><span class="mi">7171</span><span class="w">                    </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">-176</span>
<span class="nl">ffffffff8039e3a2</span><span class="p">:</span><span class="w">   </span><span class="n">f122</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s0</span><span class="p">,</span><span class="mi">160</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3a4</span><span class="p">:</span><span class="w">   </span><span class="n">f4de</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s7</span><span class="p">,</span><span class="mi">104</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3a6</span><span class="p">:</span><span class="w">   </span><span class="n">f506</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">ra</span><span class="p">,</span><span class="mi">168</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3a8</span><span class="p">:</span><span class="w">   </span><span class="n">ed26</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s1</span><span class="p">,</span><span class="mi">152</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3aa</span><span class="p">:</span><span class="w">   </span><span class="n">e94a</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s2</span><span class="p">,</span><span class="mi">144</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3ac</span><span class="p">:</span><span class="w">   </span><span class="n">e54e</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s3</span><span class="p">,</span><span class="mi">136</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3ae</span><span class="p">:</span><span class="w">   </span><span class="n">e152</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s4</span><span class="p">,</span><span class="mi">128</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3b0</span><span class="p">:</span><span class="w">   </span><span class="n">fcd6</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s5</span><span class="p">,</span><span class="mi">120</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3b2</span><span class="p">:</span><span class="w">   </span><span class="n">f8da</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s6</span><span class="p">,</span><span class="mi">112</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3b4</span><span class="p">:</span><span class="w">   </span><span class="n">f0e2</span><span class="w">                    </span><span class="n">sd</span><span class="w">  </span><span class="n">s8</span><span class="p">,</span><span class="mi">96</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">ffffffff8039e3b6</span><span class="p">:</span><span class="w">   </span><span class="mi">1900</span><span class="w">                    </span><span class="n">addi</span><span class="w">    </span><span class="n">s0</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">176</span>
<span class="nl">ffffffff8039e3b8</span><span class="p">:</span><span class="w">   </span><span class="mo">021</span><span class="n">c0b97</span><span class="w">            </span><span class="n">auipc</span><span class="w">   </span><span class="n">s7</span><span class="p">,</span><span class="mh">0x21c0</span>
<span class="nl">ffffffff8039e3bc</span><span class="p">:</span><span class="w">   </span><span class="n">d08b8b93</span><span class="w">            </span><span class="n">addi</span><span class="w">    </span><span class="n">s7</span><span class="p">,</span><span class="n">s7</span><span class="p">,</span><span class="mi">-760</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">ffffffff8255e0c0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">__stack_chk_guard</span><span class="o">&gt;</span>
<span class="nl">ffffffff8039e3c0</span><span class="p">:</span><span class="w">   </span><span class="mo">000</span><span class="n">bb703</span><span class="w">            </span><span class="n">ld</span><span class="w">  </span><span class="n">a4</span><span class="p">,</span><span class="mi">0</span><span class="p">(</span><span class="n">s7</span><span class="p">)</span>
<span class="nl">ffffffff8039e3c4</span><span class="p">:</span><span class="w">   </span><span class="mi">497</span><span class="n">c</span><span class="w">                    </span><span class="n">lw</span><span class="w">  </span><span class="n">a5</span><span class="p">,</span><span class="mi">84</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>
<span class="nl">ffffffff8039e3c6</span><span class="p">:</span><span class="w">   </span><span class="n">fae43423</span><span class="w">            </span><span class="n">sd</span><span class="w">  </span><span class="n">a4</span><span class="p">,</span><span class="mi">-88</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
<span class="nl">ffffffff8039e3ca</span><span class="p">:</span><span class="w">   </span><span class="mf">0017f</span><span class="mi">713</span><span class="w">            </span><span class="n">andi</span><span class="w">    </span><span class="n">a4</span><span class="p">,</span><span class="n">a5</span><span class="p">,</span><span class="mi">1</span>
<span class="p">......</span>
</code></pre></div>
<h3 id="nop">å¯åŠ¨åˆå§‹åŒ–è°ƒæ•´nopæŒ‡ä»¤é•¿åº¦</h3>
<p>åœ¨ç³»ç»Ÿå¯åŠ¨é˜¶æ®µï¼Œä¼šè°ƒç”¨ftrace_initå‡½æ•°ï¼Œå°†æ‰€æœ‰çš„å…¥å£å‡½æ•°åœ°å€è®°å½•åˆ°struct dyn_frtaceå®ä¾‹ç»“æ„ä¸­ï¼Œç„¶åå°†4ä¸ªRV32Cå‹ç¼©æŒ‡ä»¤æ›¿æ¢ä¸ºRV32Iæ¨¡å¼çš„nopæŒ‡ä»¤ï¼Œå³åŸæ¥çš„4ä¸ª2å­—èŠ‚é•¿åº¦çš„nopæŒ‡ä»¤ï¼Œå°†ä¼šæ‹“å±•ä¸º2ä¸ª4å­—èŠ‚çš„æ‹“å±•æŒ‡ä»¤ã€‚ æˆ‘ä»¬åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å…ˆåœ¨ftrace_initåœ°æ–¹æ‰“æ–­ç‚¹ï¼Œå…ˆè§‚å¯Ÿvfs_readå¤„çš„æŒ‡ä»¤æƒ…å†µã€‚disassemble 0xffffffff8039e398,+50æŸ¥çœ‹åœ°å€å¼€å§‹çš„æŒ‡ä»¤ã€‚ï¼ˆä¸èƒ½ä½¿ç”¨disassemble vfs_read,+50æŸ¥çœ‹ï¼Œè¿™æ ·ä¼šæŠŠå‰é¢çš„æ’æ¡©è¿‡æ»¤æ‰ï¼Œéœ€è¦ä½¿ç”¨åœ°å€çš„æ–¹å¼ï¼‰ã€‚</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_b1524fdcbc93237da35f1e1699c52899.jpg\"><img alt='\"åŠ¨æ€function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_b1524fdcbc93237da35f1e1699c52899.jpg\"/></a></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè·Ÿä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬åæ±‡ç¼–çœ‹åˆ°çš„æŒ‡ä»¤æ˜¯ä¸€è‡´äº†ï¼Œ4æ¡nopæŒ‡ä»¤è¿˜æ²¡æœ‰è¢«æ›¿æ¢ã€‚æ¥ç€æˆ‘ä»¬ä½¿ç”¨nç»§ç»­è¿›è¡Œè°ƒè¯•è¿è¡Œï¼Œå½“è¿è¡Œå®Œftrace_process_locsåï¼Œæˆ‘ä»¬å†æ¥æŸ¥çœ‹ä¸€ä¸‹å˜åŒ–ã€‚</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_3b34d8f37f21766013c1abf62e8dd72c.jpg\"><img alt='\"åŠ¨æ€function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_3b34d8f37f21766013c1abf62e8dd72c.jpg\"/></a></p>
<p>æˆ‘ä»¬å‘ç°ä¹‹å‰4æ¡2å­—èŠ‚çš„nopæŒ‡ä»¤è¢«æ›¿æ¢æˆäº†2æ¡4å­—èŠ‚çš„nopæŒ‡ä»¤äº†ã€‚ä¸ºä»€ä¹ˆè¦è°ƒæ•´nopæŒ‡ä»¤çš„é•¿åº¦äº†ï¼Œä¸ªäººç†è§£åº”è¯¥æ˜¯ä¸ºäº†å…¼é¡¾å¤„ç†å™¨æµæ°´çº¿çš„ä¼˜åŒ–ã€æŒ‡ä»¤å¯¹é½ç­‰ï¼Œæ¯”å¦‚è·³è½¬åˆ°æŒ‡å®šæ ‡ç­¾è¿è¡Œæ˜¯auipc+jalrä¸¤æ¡4å­—èŠ‚çš„æŒ‡ä»¤ã€‚ä¹‹æ‰€ä»¥ä¸åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šæ—¶å› ä¸ºå»¶è¿Ÿè¿è¡Œè°ƒæ•´nopæŒ‡ä»¤çš„é•¿åº¦ï¼Œå¯ä»¥æ›´å¥½çš„å¹³è¡¡ç³»ç»Ÿçš„å…¼å®¹æ€§å’Œçµæ´»æ€§ã€‚</p>
<h3 id="nop_1">æ›¿æ¢å…¥å£å‡½æ•°çš„nop</h3>
<p>å½“æˆ‘ä»¬ä½¿èƒ½function traceråï¼ŒnopæŒ‡ä»¤å°±ä¼šè¢«æ›¿æ¢ä¸ºftrace_callerã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿èƒ½ echo function &gt; /sys/kernel/debug/tracing/current_tracerå†æ¥çœ‹çœ‹vfs_readçš„æƒ…å†µã€‚</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_514a397dd661e5d1b6f8e23fa0436293.jpg\"><img alt='\"åŠ¨æ€function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_514a397dd661e5d1b6f8e23fa0436293.jpg\"/></a></p>
<p>ä»ä¸Šé¢å¯çŸ¥ï¼Œä¹‹å‰çš„2æ¡nopæŒ‡ä»¤å°±è¢«æ›¿æ¢ä¸ºäº†auipc+jalræŒ‡ä»¤ï¼Œå³è·³è½¬åˆ°ftrace_callerå‡½æ•°ã€‚</p>
<h3 id="ftrace_stub">æ›¿æ¢è·Ÿè¸ªå‡½æ•°ftrace_stub</h3>
<p>æ‰§è¡Œecho function &gt;current_traceræ—¶ï¼Œé™¤äº†å‡½æ•°å…¥å£çš„nopæŒ‡ä»¤ä¼šè¢«æ›¿æ¢ä¸ºftrace_callerå¤–ï¼Œftrace_callerçš„å®ç°ä¸­ï¼Œftrace_stubä¹Ÿä¼šæ›¿æ¢ä¸ºfunction_trace_callã€‚æ›´æ–°ä»£ç ä¼šè°ƒç”¨åˆ°ftrace_modify_all_codeå‡½æ•°ï¼Œæˆ‘ä»¬å¯¹æ­¤å‡½æ•°è¿›è¡Œæ–­ç‚¹è§‚å¯Ÿå‰åå˜åŒ–ã€‚</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_dc317c86c1386ed4c7924f564f85b8a7.jpg\"><img alt='\"åŠ¨æ€function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_dc317c86c1386ed4c7924f564f85b8a7.jpg\"/></a></p>
<p>å¦‚ä¸Šå›¾ï¼Œåœ¨è¿˜æ²¡æœ‰æ‰§è¡Œå‘½ä»¤echo function &gt; current_traceræ—¶ï¼Œftrace_calleræ‰§è¡Œçš„æ˜¯ftrace_stubï¼Œå½“æ‰§è¡Œå‘½ä»¤åï¼Œå°±å˜æˆè·³è½¬å¦‚ä¸‹i bã€‚</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_6b3674469cd2d935c57c48eb3f62eb87.jpg\"><img alt='\"åŠ¨æ€function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_6b3674469cd2d935c57c48eb3f62eb87.jpg\"/></a></p>
<p>å…·ä½“çš„å®ä¾‹ä»£ç å¦‚ä¸‹ï¼Œåˆ‡æ¢å‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">ENTRY</span><span class="p">(</span><span class="n">ftrace_caller</span><span class="p">)</span>
<span class="w">    </span><span class="n">SAVE_ABI</span>

<span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">FENTRY_RA_OFFSET</span>
<span class="w">    </span><span class="n">la</span><span class="w">  </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">function_trace_op</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">ra</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>

<span class="nl">ftrace_call</span><span class="p">:</span>
<span class="w">    </span><span class="p">.</span><span class="n">global</span><span class="w"> </span><span class="n">ftrace_call</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">ftrace_stub</span><span class="w"> </span><span class="n">â‘ æœªæ‰§è¡Œecho</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">current_tracer</span>

<span class="w">    </span><span class="n">RESTORE_ABI</span>
<span class="w">    </span><span class="n">jr</span><span class="w"> </span><span class="n">t0</span>
<span class="n">ENDPROC</span><span class="p">(</span><span class="n">ftrace_caller</span><span class="p">)</span>
</code></pre></div>
<p>æ‰§è¡Œå‘½ä»¤echo function &gt; current_traceråï¼Œftrace_calleræ ‡ç­¾å¤„å°±ä¼šå˜ä¸ºå¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">ENTRY</span><span class="p">(</span><span class="n">ftrace_caller</span><span class="p">)</span>
<span class="w">    </span><span class="n">SAVE_ABI</span>

<span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">FENTRY_RA_OFFSET</span>
<span class="w">    </span><span class="n">la</span><span class="w">  </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">function_trace_op</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">ra</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>

<span class="nl">ftrace_call</span><span class="p">:</span>
<span class="w">    </span><span class="p">.</span><span class="n">global</span><span class="w"> </span><span class="n">ftrace_call</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">function_trace_call</span><span class="w"> </span><span class="n">â‘ æ‰§è¡Œecho</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">current_tracer</span>

<span class="w">    </span><span class="n">RESTORE_ABI</span>
<span class="w">    </span><span class="n">jr</span><span class="w"> </span><span class="n">t0</span>
<span class="n">ENDPROC</span><span class="p">(</span><span class="n">ftrace_caller</span><span class="p">)</span>
</code></pre></div>
<h3 id="ftrace_caller">ftrace_callerè°ƒç”¨æµç¨‹</h3>
<p>gdb è°ƒè¯•ç»§ç»­è·Ÿè¸ªftrace_callerå®ç°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span>

<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8039e398</span><span class="w"> </span><span class="o">:</span><span class="w">     </span><span class="n">ffc6e297</span><span class="w">        </span><span class="n">auipc</span><span class="w">   </span><span class="n">t0</span><span class="p">,</span><span class="mh">0xffc6e</span>
<span class="w">   </span><span class="mh">0xffffffff8039e39c</span><span class="w"> </span><span class="o">:</span><span class="w">     </span><span class="mf">3f4282e7</span><span class="w">        </span><span class="n">jalr</span><span class="w">    </span><span class="n">t0</span><span class="p">,</span><span class="mi">1012</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mh">0xffffffff8000c78c</span><span class="w">  </span><span class="n">â‘ è¿›å…¥vfs_readå‡½æ•°å…¥å£æ˜¯</span><span class="err">ï¼Œ</span><span class="n">è·³è½¬åˆ°ftrace_caller</span><span class="err">ï¼Œ</span><span class="n">t0</span><span class="o">=</span><span class="n">PC</span><span class="o">+</span><span class="mi">4</span><span class="err">ï¼Œ</span><span class="n">å³0xffffffff8039e3a0</span>
<span class="w">  </span><span class="mh">0xffffffff8039e3a0</span><span class="w"> </span><span class="o">:</span><span class="w">     </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">-176</span>
<span class="w">  </span><span class="mh">0xffffffff8039e3a2</span><span class="w"> </span><span class="o">:</span><span class="w">     </span><span class="n">sd</span><span class="w">      </span><span class="n">s0</span><span class="p">,</span><span class="mi">160</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">  </span><span class="p">.....</span>

<span class="n">ftrace_caller</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">arch</span><span class="o">/</span><span class="n">riscv</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">mcount</span><span class="o">-</span><span class="n">dyn</span><span class="p">.</span><span class="n">S</span><span class="o">:</span><span class="mi">135</span>
<span class="mi">135</span><span class="w">             </span><span class="n">SAVE_ABI</span><span class="w">    </span><span class="n">â‘¡å¼€è¾Ÿä¸€æ®µæ ˆç©ºé—´</span><span class="err">ï¼Œ</span><span class="n">å°†a0</span><span class="o">~</span><span class="n">a7</span><span class="p">,</span><span class="n">t0</span><span class="o">/</span><span class="n">raå…¥æ ˆ</span><span class="err">ã€‚</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c78c</span><span class="w"> </span><span class="o">:</span><span class="w">        </span><span class="mi">715</span><span class="n">d</span><span class="w">            </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">-80</span>
<span class="w">   </span><span class="mh">0xffffffff8000c78e</span><span class="w"> </span><span class="o">:</span><span class="w">        </span><span class="n">e02a</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a0</span><span class="p">,</span><span class="mi">0</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c790</span><span class="w"> </span><span class="o">:</span><span class="w">        </span><span class="n">e42e</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a1</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c792</span><span class="w"> </span><span class="o">:</span><span class="w">        </span><span class="n">e832</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a2</span><span class="p">,</span><span class="mi">16</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c794</span><span class="w"> </span><span class="o">:</span><span class="w">        </span><span class="n">ec36</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a3</span><span class="p">,</span><span class="mi">24</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c796</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">f03a</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a4</span><span class="p">,</span><span class="mi">32</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c798</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">f43e</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a5</span><span class="p">,</span><span class="mi">40</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c79a</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">f842</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a6</span><span class="p">,</span><span class="mi">48</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c79c</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">fc46</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">a7</span><span class="p">,</span><span class="mi">56</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c79e</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">e096</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">t0</span><span class="p">,</span><span class="mi">64</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c7a0</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">e486</span><span class="w">            </span><span class="n">sd</span><span class="w">      </span><span class="n">ra</span><span class="p">,</span><span class="mi">72</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="mi">137</span><span class="w">             </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">FENTRY_RA_OFFSET</span><span class="w"> </span><span class="n">â‘¡è·å–vfs_readçš„å…¥å£åœ°å€</span><span class="err">ã€‚</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c7a2</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">ff828513</span><span class="w">        </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="mi">-8</span>
<span class="mi">138</span><span class="w">             </span><span class="n">la</span><span class="w">      </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">function_trace_op</span><span class="w"> </span><span class="n">â‘¢è·å–å…¨å±€å˜é‡function_trace_op</span><span class="err">ï¼Œ</span><span class="n">è¿™æ˜¯ftraceçš„æ“ä½œé›†åˆ</span><span class="err">ï¼Œ</span><span class="n">åŒ…å«äº†ftraceçš„å‡½æ•°</span><span class="err">ã€‚</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c7a6</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="mf">0254e597</span><span class="w">        </span><span class="n">auipc</span><span class="w">   </span><span class="n">a1</span><span class="p">,</span><span class="mh">0x254e</span>
<span class="w">   </span><span class="mh">0xffffffff8000c7aa</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="mf">5f</span><span class="mi">258593</span><span class="w">        </span><span class="n">addi</span><span class="w">    </span><span class="n">a1</span><span class="p">,</span><span class="n">a1</span><span class="p">,</span><span class="mi">1522</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mh">0xffffffff8255ad98</span><span class="w"> </span>
<span class="mi">139</span><span class="w">             </span><span class="n">REG_L</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="n">â‘£è·å–ftrace_trace_opåœ°å€å­˜å‚¨åˆ°a2ä¸­</span><span class="err">ã€‚</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c7ae</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="mi">6190</span><span class="w">            </span><span class="n">ld</span><span class="w">      </span><span class="n">a2</span><span class="p">,</span><span class="mi">0</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="mi">140</span><span class="w">             </span><span class="n">mv</span><span class="w">      </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">ra</span>
<span class="mi">141</span><span class="w">             </span><span class="n">mv</span><span class="w">      </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<span class="mi">145</span><span class="w">             </span><span class="n">call</span><span class="w">    </span><span class="n">ftrace_stub</span><span class="w">   </span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c7b4</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="mo">001</span><span class="mi">98097</span><span class="w">        </span><span class="n">auipc</span><span class="w">   </span><span class="n">ra</span><span class="p">,</span><span class="mh">0x198</span>
<span class="w">   </span><span class="mh">0xffffffff8000c7b8</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="n">e5a080e7</span><span class="w">        </span><span class="n">jalr</span><span class="w">    </span><span class="mi">-422</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mh">0xffffffff801a460e</span><span class="w"> </span>

<span class="n">at</span><span class="w"> </span><span class="n">kernel</span><span class="o">/</span><span class="n">trace</span><span class="o">/</span><span class="n">trace_functions</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">175</span>
<span class="n">function_trace_call</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_regs</span><span class="w"> </span><span class="o">*</span><span class="n">fregs</span><span class="p">)</span>
<span class="w">  </span><span class="n">â‘¤</span><span class="w"> </span><span class="n">ipä¸ºå…¥å£å‡½æ•°vfs_readçš„åœ°å€å³a0</span><span class="p">,</span><span class="w"> </span><span class="n">parent_ipä¸ºvfs_readçš„çˆ¶å‡½æ•°</span><span class="err">ï¼Œ</span><span class="n">è°ƒç”¨vfs_readåœ°å€å¤„çš„ä¸‹ä¸€æ¡æŒ‡ä»¤</span><span class="err">ã€‚</span><span class="n">opä¸ºftrace_trace_op</span><span class="err">ï¼Œ</span><span class="n">fregsä¸ºæ ˆåœ°å€</span><span class="err">ã€‚</span>
<span class="w">  </span><span class="n">trace_function</span>
<span class="n">entry</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">ring_buffer_event_data</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ip</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">ip</span><span class="p">;</span>
<span class="n">entry</span><span class="o">-&gt;</span><span class="n">parent_ip</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">;</span>
<span class="n">ftrace_exports</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">TRACE_EXPORT_FUNCTION</span><span class="p">);</span><span class="w"> </span><span class="n">â‘¥</span><span class="w"> </span><span class="n">å°†ä¿¡æ¯å†™å…¥åˆ°ring</span><span class="w"> </span><span class="n">bufferä¸­</span><span class="err">ã€‚</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="n">export</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">trace_process_export</span><span class="p">(</span><span class="n">export</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">);</span>
<span class="w">      </span><span class="n">export</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">export</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">ftrace_caller</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">arch</span><span class="o">/</span><span class="n">riscv</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">mcount</span><span class="o">-</span><span class="n">dyn</span><span class="p">.</span><span class="n">S</span><span class="o">:</span><span class="mi">148</span>
<span class="mi">148</span><span class="w">             </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">ABI_RA</span>
<span class="mi">149</span><span class="w">             </span><span class="n">REG_L</span><span class="w">   </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">ABI_T0</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="mi">150</span><span class="w">             </span><span class="n">addi</span><span class="w">    </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">FENTRY_RA_OFFSET</span>
<span class="mi">152</span><span class="w">             </span><span class="n">mv</span><span class="w">      </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span>
<span class="mi">156</span><span class="w">             </span><span class="n">call</span><span class="w">    </span><span class="n">ftrace_stub</span><span class="w">  </span><span class="n">â‘¦å¯¹function</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="n">tracerè¿›è¡Œå¤„ç†</span><span class="err">ï¼Œ</span><span class="n">å½“å‰ä½¿èƒ½çš„æ˜¯function</span><span class="w"> </span><span class="n">tracer</span><span class="err">ï¼Œ</span><span class="n">æ‰€ä»¥ftrace_stubå‡½æ•°ç›´æ¥ç›´æ¥ä¸ºret</span><span class="err">ï¼Œ</span><span class="n">å¦‚ä¸‹</span><span class="err">ã€‚</span>
<span class="n">ftrace_stub</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">arch</span><span class="o">/</span><span class="n">riscv</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">mcount</span><span class="p">.</span><span class="n">S</span><span class="o">:</span><span class="mi">55</span>
<span class="mi">55</span><span class="w">              </span><span class="n">ret</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c170</span><span class="w"> </span><span class="o">:</span><span class="w">  </span><span class="mi">8082</span><span class="w">            </span><span class="n">ret</span>
<span class="w">   </span><span class="mh">0xffffffff8000c172</span><span class="w"> </span><span class="o">:</span><span class="w">    </span><span class="mo">0001</span><span class="w">            </span><span class="n">nop</span>
<span class="n">ftrace_caller</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">arch</span><span class="o">/</span><span class="n">riscv</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">mcount</span><span class="o">-</span><span class="n">dyn</span><span class="p">.</span><span class="n">S</span><span class="o">:</span><span class="mi">158</span>
<span class="mi">158</span><span class="w">             </span><span class="n">RESTORE_ABI</span><span class="w">   </span><span class="n">â‘§æ¢å¤å¯„å­˜å™¨</span><span class="err">ï¼Œ</span><span class="n">å‡†å¤‡è¿”å›</span><span class="err">ã€‚</span>
<span class="n">ftrace_caller</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">arch</span><span class="o">/</span><span class="n">riscv</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">mcount</span><span class="o">-</span><span class="n">dyn</span><span class="p">.</span><span class="n">S</span><span class="o">:</span><span class="mi">159</span>
<span class="mi">159</span><span class="w">             </span><span class="n">jr</span><span class="w"> </span><span class="n">t0</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c7e2</span><span class="w"> </span><span class="o">:</span><span class="w">       </span><span class="mi">8282</span><span class="w">            </span><span class="n">jr</span><span class="w">      </span><span class="n">t0</span>
</code></pre></div>
<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">ftrace_caller</span>
<span class="w">  </span><span class="n">call</span><span class="w">    </span><span class="n">ftrace_stub</span><span class="w">  </span><span class="o">=&gt;</span><span class="w">  </span><span class="n">call</span><span class="w">  </span><span class="n">function_trace_call</span>
<span class="n">trace_function</span>
<span class="w">  </span><span class="n">ftrace_exports</span>
<span class="w">    </span><span class="n">export</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">export</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
</code></pre></div>
<p>ä»ä¸Šå¯çŸ¥ï¼Œftrace_stubè¢«èµ‹å€¼ä¸ºfunction_trace_callï¼Œè¯¥å‡½æ•°æ˜¯ä»€ä¹ˆæ—¶å€™è¢«æ›¿æ¢çš„äº†ï¼Ÿæˆ‘ä»¬ç•™ç€åç»­è¿›è¡Œ3.5ç« èŠ‚è¿›è¡Œåˆ†æã€‚</p>
<h2 id="ftrace_init">ftrace_init</h2>
<p>ftrace_inité€šè¿‡è¯»å–__{start,stop}_mcount_locå­—æ®µä¸­è®°å½•æ‰€æœ‰çš„å‡½æ•°å…¥å£åœ°å€ï¼Œæ‰€æœ‰çš„å…¥å£åœ°å€è¢«è®°å½•åˆ°æœ€å°çš„å®ä¾‹struct dyn_ftraceç»“æ„ä½“ä¸­ï¼Œè¿™äº›ç»“æ„ä½“æœ€ç»ˆæ‰“åŒ…å½¢æˆpgé“¾è¡¨èŠ‚ç‚¹ï¼Œé¦–èŠ‚ç‚¹ä¸ºstart_pgï¼Œéå†start_pgé“¾è¡¨æ‰§è¡Œftrace_init_nopæŠŠ4ä¸ªnopæŒ‡ä»¤ã€‚</p>
<h3 id="_3">æ•°æ®ç»“æ„</h3>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_4470aed58cda3c6837f16e30e4a2b05a.jpg\"><img alt='\"åŠ¨æ€function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_4470aed58cda3c6837f16e30e4a2b05a.jpg\"/></a></p>
<p>åœ¨sectionä¸­__{start,stop}_mcount_locå­—æ®µä¸­è®°å½•æ‰€æœ‰çš„å‡½æ•°å…¥å£åœ°å€ï¼Œæ¯ä¸ªå‡½æ•°å…¥å£åœ°å€éƒ½æœ‰ä¸€ä¸ªstruct dyn_ftraceæ•°æ®ç»“æ„å®ä¾‹æ¥è®°å½•ã€‚æ¯ä¸ªé¡µé¢ï¼ˆpageï¼‰å¯ä»¥å­˜æ”¾å¤šä¸ªstruct_ftraceå®ä¾‹ï¼Œå¤šä¸ªé¡µé¢ç»„æˆä¸€ä¸ªgroupsã€‚æ¯ä¸ªç»„ä½¿ç”¨struct ftrace_pagesèŠ‚ç‚¹æ¥è¿›è¡Œç®¡ç†ï¼Œå¤šä¸ªstruct ftrace_pagesç»„æˆä¸€ä¸ªé“¾è¡¨ï¼Œå…·ä½“çš„ç»“æ„å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">ftrace_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">__start_mcount_loc</span><span class="p">[];</span>
<span class="k">extern</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">__stop_mcount_loc</span><span class="p">[];</span>
<span class="n">â‘ </span><span class="w"> </span><span class="n">_start_mcount_locå’Œ_stop_mcount_locåˆ†åˆ«æ˜¯æ‰€æœ‰å…¥å£å‡½æ•°æ®µçš„å¼€å§‹å’Œç»“æŸ</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_dyn_arch_init</span><span class="p">();</span>
<span class="w">    </span><span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>

<span class="w">    </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__stop_mcount_loc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__start_mcount_loc</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_info</span><span class="p">(</span><span class="err">\\\</span><span class="s">"ftrace: No functions to be traced?</span><span class="se">\\\\</span><span class="s">n</span><span class="se">\\\"</span><span class="s">);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="err">\\\</span><span class="s">"ftrace: allocating %ld entries in %ld pages</span><span class="se">\\\\</span><span class="s">n</span><span class="se">\\\"</span><span class="s">,</span>
<span class="w">        </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">ENTRIES_PER_PAGE</span><span class="p">));</span>
<span class="n">â‘¡</span><span class="w"> </span><span class="n">countæ‰€æœ‰çš„æ’æ¡©ç‚¹çš„æ€»æ•°</span><span class="err">ï¼Œ</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">ENTRIES_PER_PAGE</span><span class="p">))</span><span class="n">è¡¨ç¤ºéœ€è¦åˆ†é…å¤šå°‘ä¸ªpages</span><span class="err">ï¼Œ</span><span class="n">æ¯ä¸ªæ’æ¡©ç‚¹éƒ½ä½¿ç”¨struct</span><span class="w"> </span><span class="n">dyn_ftraceæ¥è®°å½•</span><span class="err">ã€‚</span><span class="n">ä¸‹é¢æ˜¯qumuä¸Šçš„æ‰“å°</span>
<span class="w"> </span><span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">ftrace</span><span class="o">:</span><span class="w"> </span><span class="n">allocating</span><span class="w"> </span><span class="mi">37736</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mi">148</span><span class="w"> </span><span class="n">pages</span>
<span class="n">ä¸€å…±æœ‰37736ä¸ªæ’æ¡©ç‚¹</span><span class="err">ï¼Œ</span><span class="n">éœ€è¦148</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="n">KB</span><span class="o">=</span><span class="mi">592</span><span class="n">KBçš„å†…å­˜</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_process_locs</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                  </span><span class="n">__start_mcount_loc</span><span class="p">,</span>
<span class="w">                  </span><span class="n">__stop_mcount_loc</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_warn</span><span class="p">(</span><span class="err">\\\</span><span class="s">"ftrace: failed to allocate entries for functions</span><span class="se">\\\\</span><span class="s">n</span><span class="se">\\\"</span><span class="s">);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">   </span><span class="n">â‘¢</span><span class="w"> </span><span class="n">å°†æ‰€æœ‰çš„æ’æ¡©ç‚¹åœ°å€è®°å½•åˆ°struct</span><span class="w"> </span><span class="n">dyn_ftraceå®ä¾‹ä¸­</span><span class="err">ï¼Œ</span><span class="n">å¦‚æ•°æ®ç»“æ„å›¾ä¸­</span><span class="err">ï¼Œ</span><span class="n">æ¯ä¸ªæ’æ¡©ç‚¹éƒ½æœ‰è¦ç»™struct</span><span class="w"> </span><span class="n">dyn_ftraceå®ä¾‹</span><span class="err">ï¼Œ</span><span class="n">å®ä¾‹ç©ºé—´åˆ†é…page</span><span class="err">ï¼Œ</span><span class="n">æ¯ä¸ªpageæœ‰å¤šä¸ªstruct</span><span class="w"> </span><span class="n">dyn_ftraceçš„å®ä¾‹</span><span class="err">ã€‚</span><span class="n">ç„¶åéå†åœ°å€å°†4æ¡nopæŒ‡ä»¤è°ƒæ•´ä¸º2æ¡nopæŒ‡ä»¤</span><span class="err">ï¼ˆ</span><span class="n">æœ¬ç« èŠ‚çš„å®éªŒ</span><span class="err">ï¼‰ã€‚</span>
<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="err">\\\</span><span class="s">"ftrace: allocated %ld pages with %ld groups</span><span class="se">\\\\</span><span class="s">n</span><span class="se">\\\"</span><span class="s">,</span>
<span class="w">        </span><span class="n">ftrace_number_of_pages</span><span class="p">,</span><span class="w"> </span><span class="n">ftrace_number_of_groups</span><span class="p">);</span>

<span class="w">    </span><span class="n">last_ftrace_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">   </span><span class="n">â‘£è®¾ç½®è¿‡æ»¤</span><span class="err">ï¼Ÿ</span>
<span class="w">    </span><span class="n">set_ftrace_early_filters</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w"> </span><span class="nl">failed</span><span class="p">:</span>
<span class="w">    </span><span class="n">ftrace_disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_4">åˆ†é…æ•°æ®ç»“æ„</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ftrace_process_locs</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">mod</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">start</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_page</span><span class="w"> </span><span class="o">*</span><span class="n">start_pg</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_page</span><span class="w"> </span><span class="o">*</span><span class="n">pg</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dyn_ftrace</span><span class="w"> </span><span class="o">*</span><span class="n">rec</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Shut up gcc */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="w">    </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">start_pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_allocate_pages</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">start_pg</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">    </span><span class="n">â‘ </span><span class="w"> </span><span class="n">åˆ†é…ftrace</span><span class="w"> </span><span class="n">page</span><span class="err">ï¼Œ</span><span class="n">é‡Œé¢å­˜æ”¾çš„æ˜¯struct</span><span class="w"> </span><span class="n">dyn_ftrace</span><span class="err">ï¼Œ</span><span class="n">å…·ä½“ç»“æ„å¦‚3</span><span class="mf">.3.1</span><span class="n">æ•°æ®ç»“æ„å›¾</span><span class="err">ï¼Œ</span><span class="n">ç”¨äºåç»­å­˜æ”¾åœ°å€</span><span class="err">ã€‚</span>
<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_5">è®°å½•æ’æ¡©åœ°å€</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ftrace_process_locs</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">mod</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">start</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">......</span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>
<span class="w">    </span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start_pg</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">end_offset</span><span class="p">;</span>
<span class="w">        </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_call_adjust</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">);</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Some architecture linkers will pad between</span>
<span class="cm">         * the different mcount_loc sections of different</span>
<span class="cm">         * object files to satisfy alignments.</span>
<span class="cm">         * Skip any NULL pointers.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="n">end_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">end_offset</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/* We should have allocated enough */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">))</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">rec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">records</span><span class="p">[</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">index</span><span class="o">++</span><span class="p">];</span>
<span class="w">        </span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">       </span><span class="n">â‘¡</span><span class="w"> </span><span class="n">éå†å°†æ‰€æœ‰çš„æ’æ¡©ç‚¹åœ°å€å­˜å‚¨åˆ°struct</span><span class="w"> </span><span class="n">dyn_ftraceä¸­</span><span class="err">ã€‚</span>
<span class="p">}</span>
<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="nop_2">æ›´æ–°æ’æ¡©æŒ‡ä»¤nop</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ftrace_process_locs</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">mod</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">start</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">......</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mod</span><span class="p">)</span>
<span class="w">        </span><span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="n">ftrace_update_code</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">start_pg</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mod</span><span class="p">)</span>
<span class="w">        </span><span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">ftrace_update_code</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">start_pg</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_pgs</span><span class="p">;</span><span class="w"> </span><span class="n">pg</span><span class="p">;</span><span class="w"> </span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ftrace_nop_initialize</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="w">            </span><span class="n">ftrace_init_nop</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">rec</span><span class="p">)</span>
<span class="w">            </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_make_nop</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="n">MCOUNT_ADDR</span><span class="p">);</span>
<span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nops</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">NOP4</span><span class="p">,</span><span class="w"> </span><span class="n">NOP4</span><span class="p">};</span>
<span class="w">                </span><span class="n">patch_text_nosync</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">nops</span><span class="p">,</span><span class="w"> </span><span class="n">MCOUNT_INSN_SIZE</span><span class="p">)</span>
<span class="w">                    </span><span class="n">patch_insn_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">insns</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="w">                        </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">patch_map</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">FIX_TEXT_POKE0</span><span class="p">);</span><span class="w"> </span><span class="c1">//fixmap FIX_TEXT_POKE0æ˜ å°„åœ°å€</span>
<span class="w">                        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_to_kernel_nofault</span><span class="p">(</span><span class="n">waddr</span><span class="p">,</span><span class="w"> </span><span class="n">insn</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">                            </span><span class="n">pagefault_disable</span><span class="p">()</span><span class="w"> </span><span class="c1">//å…³æ‰ç¼ºé¡µå¼‚å¸¸</span>
<span class="w">                            </span><span class="n">copy_to_kernel_nofault_loop</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="p">,</span><span class="w"> </span><span class="n">Efault</span><span class="p">)</span>
<span class="w">                                </span><span class="n">__put_kernel_nofault</span>
<span class="w">                                </span><span class="n">__put_user_nocheck</span>
<span class="w">                                    </span><span class="n">__put_user_asm</span><span class="p">(</span><span class="err">\\\</span><span class="s">"sw</span><span class="se">\\\"</span><span class="s">, (x), __gu_ptr, __pu_err) //å†™å†…å­˜æŒ‡ä»¤</span>
<span class="w">                            </span><span class="n">pagefault_disable</span><span class="p">()</span>
<span class="w">                        </span><span class="n">patch_unmap</span><span class="p">(</span><span class="n">FIX_TEXT_POKE0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_6">å…¥å£å‡½æ•°ä¸è·Ÿè¸ªå‡½æ•°æ›¿æ¢</h2>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_07408093cddfbfad032838cf73dea166.jpg\"><img alt='\"åŠ¨æ€function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_07408093cddfbfad032838cf73dea166.jpg\"/></a></p>
<ul>
<li>å…¥å£å‡½æ•°ï¼šä¸¤æ¡nopæŒ‡ä»¤æ›¿æ¢ä¸ºftrace_callerã€‚</li>
<li>è·Ÿè¸ªå‡½æ•°ï¼šcall ftrace_stubæ›¿æ¢ä¸ºcall function_trace_callã€‚ å‰é¢æè¿°äº†ä½¿èƒ½function traceråä¼šå°†nopæŒ‡ä»¤æ›¿æ¢ä¸ºftrace_callerå’Œå°†ftrace_stubæ›¿æ¢ä¸ºfunction_trace_callã€‚å½“echo function &gt; current_tracerå°±ä¼šé€šè¿‡æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨åˆ°tracing_set_trace_writeå‡½æ•°ï¼Œæœ¬ç« èŠ‚ä»è¯¥å‡½æ•°æ¥å…·ä½“åˆ†æä¸‹æ›¿æ¢è¿‡ç¨‹ã€‚</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">tracing_set_trace_write</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
<span class="w">            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">cnt</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracing_set_tracer</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trace_types</span><span class="p">;</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">â‘ traceæœ‰å¾ˆå¤šä¸ªç±»å‹</span><span class="err">ï¼Œ</span><span class="n">åŒ¹é…functionç±»å‹è·å–åˆ°struct</span><span class="w"> </span><span class="n">tracer</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="err">ã€‚</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracer_init</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">tr</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">   </span><span class="n">â‘¡è°ƒç”¨å¯¹åº”tracerçš„åˆå§‹åŒ–å‡½æ•°</span><span class="err">ï¼Œ</span><span class="n">æˆ‘ä»¬è¿™é‡Œä½¿èƒ½çš„æ˜¯function</span><span class="err">ï¼Œ</span><span class="n">å› æ­¤è°ƒç”¨çš„æ˜¯function_trace_init</span>
</code></pre></div>
<p>æ¯ä¸ªtraceréƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„å®ä¾‹ï¼Œå¯¹åº”functionç±»å‹çš„tracerå®ä¾‹å¦‚ä¸‹ï¼Œä¼šè°ƒç”¨register_tracer(&amp;function_trace)å‡½æ•°è¿›è¡Œæ³¨å†Œtracerã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">tracer</span><span class="w"> </span><span class="n">function_trace</span><span class="w"> </span><span class="n">__tracer_data</span><span class="w"> </span><span class="o">=</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="err">\\\</span><span class="s">"function</span><span class="se">\\\"</span><span class="s">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">init</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">function_trace_init</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">reset</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">function_trace_reset</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">start</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">function_trace_start</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">flags</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_flags</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">set_flag</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">func_set_flag</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">allow_instances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p>æ¥ä¸‹æ¥ï¼Œæ¥ç€çœ‹çœ‹function_trace_initå‡½æ•°å®ç°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">function_trace_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trace_array</span><span class="w"> </span><span class="o">*</span><span class="n">tr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ftrace_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">;</span>

<span class="w">    </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select_trace_function</span><span class="p">(</span><span class="n">func_flags</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="n">â‘ æ ¹æ®func_flags</span><span class="p">.</span><span class="n">valæ¥é€‰æ‹©è·Ÿè¸ªå‡½æ•°</span><span class="err">ï¼Œ</span><span class="n">è¿™é‡Œé»˜è®¤é€‰æ‹©function_trace_call</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">handle_func_repeats</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="w"> </span><span class="n">func_flags</span><span class="p">.</span><span class="n">val</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="w">    </span><span class="n">ftrace_init_array_ops</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">);</span>
<span class="n">â‘¡</span><span class="w"> </span><span class="n">è®¾ç½®struct</span><span class="w"> </span><span class="n">ftrace_ops</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function_trace_call</span>

<span class="w">    </span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">array_buffer</span><span class="p">.</span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">raw_smp_processor_id</span><span class="p">();</span>

<span class="w">    </span><span class="n">tracing_start_cmdline_record</span><span class="p">();</span>
<span class="n">tracing_start_function_trace</span><span class="p">(</span><span class="n">tr</span><span class="p">);</span>
<span class="n">â‘¢</span><span class="w"> </span><span class="n">æ³¨å†Œftrace_function</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="ftrace_ops_list">å…¨å±€ftrace_ops_list</h3>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_636bf159943b2ca13c2aeeff534c70e4.jpg\"><img alt='\"åŠ¨æ€function' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_636bf159943b2ca13c2aeeff534c70e4.jpg\"/></a></p>
<p>å¦‚ä¸Šå›¾ï¼Œftrace_callçš„åœ°æ–¹å¯ä»¥éœ€è¦trace functionï¼Œä¹Ÿè¦ç”¨äºperfï¼Œé‚£ä¹ˆå°±ä¼šå†perfå’Œfunction traceä¸Šé¢å†å°è£…ä¸€å±‚ï¼ŒæŠŠftrace_stubæ›¿æ¢ä¸ºftrace_ops_list_funcï¼Œåœ¨ç³»ç»Ÿä¸­ftrace_ops_list_func = arch_ftrace_ops_list_funcã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">arch_ftrace_ops_list_func</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">,</span>
<span class="w">                   </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_regs</span><span class="w"> </span><span class="o">*</span><span class="n">fregs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">__ftrace_ops_list_func</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">fregs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">nokprobe_inline</span><span class="w"> </span><span class="kt">void</span>
<span class="n">__ftrace_ops_list_func</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">,</span>
<span class="w">               </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ignored</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_regs</span><span class="w"> </span><span class="o">*</span><span class="n">fregs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_get_regs</span><span class="p">(</span><span class="n">fregs</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bit</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * The ftrace_test_and_set_recursion() will disable preemption,</span>
<span class="cm">     * which is required since some of the ops may be dynamically</span>
<span class="cm">     * allocated, they must be freed after a synchronize_rcu().</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trace_test_and_set_recursion</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">,</span><span class="w"> </span><span class="n">TRACE_LIST_START</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="n">ftrace_ops_listæ˜¯ä¸€ä¸ªstruct</span><span class="w"> </span><span class="n">ftrace_opsç±»å‹çš„é“¾è¡¨</span><span class="err">ï¼Œ</span><span class="n">æ¯ä¸ªftrace_opsä»£è¡¨ä¸€ä¸ªftraceå‡½æ•°è·Ÿè¸ªç±»å‹</span><span class="err">ï¼Œ</span><span class="n">é»˜è®¤æ˜¯éå†ftrace_ops_list</span><span class="err">ï¼Œ</span><span class="n">è°ƒç”¨opså‡½æ•°</span>
<span class="w">    </span><span class="n">do_for_each_ftrace_op</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">ftrace_ops_list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Stub functions don\\\'t need to be called nor tested */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_OPS_FL_STUB</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Check the following for each ops before calling their func:</span>
<span class="cm">         *  if RCU flag is set, then rcu_is_watching() must be true</span>
<span class="cm">         *  Otherwise test if the ip matches the ops filter</span>
<span class="cm">         *</span>
<span class="cm">         * If any of the above fails then the op-&gt;func() is not executed.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_OPS_FL_RCU</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">rcu_is_watching</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="n">ftrace_ops_test</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FTRACE_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">pr_warn</span><span class="p">(</span><span class="err">\\\</span><span class="s">"op=%p %pS</span><span class="se">\\\\</span><span class="s">n</span><span class="se">\\\"</span><span class="s">, op, op);</span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">parent_ip</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">fregs</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">while_for_each_ftrace_op</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
<span class="nl">out</span><span class="p">:</span>
<span class="w">    </span><span class="n">trace_clear_recursion</span><span class="p">(</span><span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>ftrace_opsæ•°æ®ç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ftrace_func_t</span><span class="w">           </span><span class="n">func</span><span class="p">;</span><span class="w">  </span><span class="c1">//æ›¿æ¢ftrace_stubçš„å‡½æ•°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="n">__rcu</span><span class="w">     </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w">                </span><span class="o">*</span><span class="n">private</span><span class="p">;</span>
<span class="w">    </span><span class="n">ftrace_func_t</span><span class="w">           </span><span class="n">saved_func</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_DYNAMIC_FTRACE</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops_hash</span><span class="w">      </span><span class="n">local_hash</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops_hash</span><span class="w">      </span><span class="o">*</span><span class="n">func_hash</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops_hash</span><span class="w">      </span><span class="n">old_hash</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">trampoline</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">trampoline_size</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">        </span><span class="n">list</span><span class="p">;</span>
<span class="w">    </span><span class="n">ftrace_ops_func_t</span><span class="w">       </span><span class="n">ops_func</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>
</code></pre></div>
<p>é»˜è®¤çš„ftrace_opsä¸ºï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="n">global_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">func</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_stub</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">local_hash</span><span class="p">.</span><span class="n">notrace_hash</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">EMPTY_HASH</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">local_hash</span><span class="p">.</span><span class="n">filter_hash</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">EMPTY_HASH</span><span class="p">,</span>
<span class="w">    </span><span class="n">INIT_OPS_HASH</span><span class="p">(</span><span class="n">global_ops</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">flags</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">FTRACE_OPS_FL_INITIALIZED</span><span class="w"> </span><span class="o">|</span>
<span class="w">                      </span><span class="n">FTRACE_OPS_FL_PID</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p>å¦‚æœå¤´ç»“ç‚¹æ˜¯ ftrace_list_endï¼Œè¡¨ç¤ºæ²¡æœ‰opsæ³¨å†Œï¼Œä»£è¡¨æ— éœ€å‡½æ•°è·Ÿè¸ªï¼Œå°† func è®¾ç½®ä¸ºç©ºçš„è·Ÿè¸ªå‡½æ•° ftrace_stubã€‚ å¦‚æœå¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹æ˜¯ ftrace_list_endï¼Œè¡¨ç¤ºåªæœ‰ä¸€ä¸ªopsæ³¨å†Œï¼Œä¸”å½“æ­¤opsä¸æ˜¯åŠ¨æ€opsï¼ˆæ¯”å¦‚ï¼šlivepatchï¼‰ï¼Œä¸”æ¶æ„æ”¯æŒä¼ é€’ ops åˆ°è·Ÿè¸ªå‡½æ•°ï¼Œåˆ™å°† func è®¾ç½®ä¸º ops-&gt;funcï¼Œå¦åˆ™è®¾ç½®ä¸º ftrace_ops_list_func() å¦‚æœé“¾è¡¨ä¸­æœ‰ä¸æ­¢ä¸€ä¸ªçš„ ops æ³¨å†Œï¼Œåˆ™å°† func è®¾ç½®ä¸º ftrace_ops_list_func() ftrace_ops_list_func() ä¸ºåŒºåˆ«äºå…¨å±€è·Ÿè¸ªå‡½æ•°ï¼Œæˆ‘ä»¬åœ¨æ­¤ç§°ä¹‹ä¸ºåˆ—è¡¨è·Ÿè¸ªå‡½æ•°ã€‚æ­¤å‡½æ•°åœ¨ vmlinux é“¾æ¥æ—¶ï¼ŒæŒ‡å‘ arch_ftrace_ops_list_funcï¼Œæ‰§è¡Œæ—¶ä¼šéå† ftrace_ops_listï¼Œç»“åˆ ops-&gt;func_hash æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦å¯¹å½“å‰ ip æ‰§è¡Œ ops-&gt;funcï¼Œä¹Ÿå°±æ˜¯è¯´ ftrace_ops_list_func() ä¸ä»…ä¼šè°ƒç”¨å¤šä¸ª ops çš„è·Ÿè¸ªå‡½æ•°ï¼Œä¹Ÿä¼šä¿è¯ ops è·Ÿè¸ªå‡½æ•°å¤„ç†çš„å‡½æ•°æ˜¯åº”è¯¥è¢«è·Ÿè¸ªçš„ã€‚ æœ¬å®éªŒæ˜¯å°†func è®¾ç½®åˆ° ftrace_trace_function()ã€‚å½“å‰è®¾ç½® function tracer çš„æµç¨‹ä¸­ï¼Œops å°±æ˜¯ global_ops ä¸” ftrace_ops_list é“¾è¡¨åªæœ‰ global_ops è¿™ä¸€ä¸ªæ³¨å†Œã€‚</p>
<h3 id="ftrace_function">æ³¨å†Œftrace_function</h3>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">register_ftrace_function</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">register_ftrace_function_nolock</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_startup</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">ftrace_startup</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ftrace_disabled</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__register_ftrace_function</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="n">â‘ æ·»åŠ ops</span><span class="err">ï¼ˆ</span><span class="n">global_ops</span><span class="err">ï¼‰</span><span class="n">åˆ°å…¨å±€opsé“¾è¡¨ftrace_ops_listä¸­</span><span class="err">ï¼Œ</span><span class="n">å¹¶è®¾ç½®å…¨å±€è·Ÿè¸ªå‡½æ•°ftrace_trace_functionä¸ºops</span><span class="o">-&gt;</span><span class="n">func</span><span class="err">ã€‚</span>

<span class="w">    </span><span class="n">ftrace_start_up</span><span class="o">++</span><span class="p">;</span>

<span class="w">    </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">FTRACE_OPS_FL_ENABLED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">FTRACE_OPS_FL_ADDING</span><span class="p">;</span>
<span class="w"> </span><span class="n">â‘¡æ ¹æ®ops</span><span class="o">-&gt;</span><span class="n">func_hash</span><span class="o">-&gt;</span><span class="n">filter_hashæ›´æ–°å…¥å£å‡½æ•°è¡¨ä¸­æ¯ä¸ªå‡½æ•°è®°å½•recçš„ip</span><span class="w"> </span><span class="n">modfyä½</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_hash_ipmodify_enable</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Rollback registration process */</span>
<span class="w">        </span><span class="n">__unregister_ftrace_function</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">        </span><span class="n">ftrace_start_up</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">FTRACE_OPS_FL_ENABLED</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_OPS_FL_DYNAMIC</span><span class="p">)</span>
<span class="w">            </span><span class="n">ftrace_trampoline_free</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ftrace_hash_rec_enable</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">        </span><span class="n">command</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">FTRACE_UPDATE_CALLS</span><span class="p">;</span>
<span class="n">â‘¢åˆ¤æ–­æ˜¯å¦æœ‰å‡½æ•°å…¥å£éœ€è¦æ›´æ–°</span><span class="err">ï¼Œ</span><span class="n">å¦‚æœéœ€è¦æ›´æ–°åˆ™commandè®¾ç½®ä¸ºFTRACE_UPDATE_CALLS</span><span class="err">ã€‚</span>
<span class="n">è¿™é‡Œçš„å…¥å£å‡½æ•°å°±æ˜¯æ›¿æ¢nopæŒ‡ä»¤</span><span class="err">ã€‚</span><span class="n">å…¥å£å‡½æ•°çš„æ›¿æ¢å’Œè·Ÿè¸ªå‡½æ•°æ›¿æ¢æ˜¯ä¸ä¸€æ ·çš„</span><span class="err">ï¼Œ</span><span class="n">æ³¨æ„åŒºåˆ†</span><span class="err">ã€‚</span><span class="w">  </span>
<span class="w">    </span><span class="n">ftrace_startup_enable</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
<span class="w">    </span><span class="n">â‘£åˆ¤æ–­æŠ¥é”™çš„è·Ÿè¸ªå‡½æ•°saved_ftrace_funcä¸å½“å‰è·Ÿè¸ªå‡½æ•°ftrace_trace_functionæ˜¯å¦ç›¸åŒ</span><span class="err">ï¼Œ</span><span class="n">å¦‚æœä¸åŒåˆ™è¡¨ç¤ºéœ€è¦æ›´æ–°è·Ÿè¸ªå‡½æ•°</span><span class="err">ï¼Œ</span><span class="n">commandè®¾ç½®ä¸ºFTRADE_UPDATE_TRACE_FUNC</span><span class="err">ï¼Œ</span><span class="n">ä¹‹åæ‰§è¡Œftrace_run_update_codeè¿›è¡Œæ›´æ–°</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * If ftrace is in an undefined state, we just remove ops from list</span>
<span class="cm">     * to prevent the NULL pointer, instead of totally rolling it back and</span>
<span class="cm">     * free trampoline, because those actions could cause further damage.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ftrace_disabled</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">__unregister_ftrace_function</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">FTRACE_OPS_FL_ADDING</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">__register_ftrace_function</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>

<span class="n">add_ftrace_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ftrace_ops_list</span><span class="p">,</span><span class="w"> </span><span class="n">ops</span><span class="p">);</span>
<span class="n">â‘ </span><span class="w"> </span><span class="n">å°†ç›®æ ‡traceæ·»åŠ åˆ°å…¨å±€é“¾è¡¨ftrace_ops_listä¸­</span><span class="err">ã€‚</span>

<span class="w">    </span><span class="cm">/* Always save the function, and reset at unregistering */</span>
<span class="w">    </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">saved_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>
<span class="w">    </span><span class="n">â‘¡</span><span class="w"> </span><span class="n">ä¿å­˜å½“å‰è¦traceçš„å‡½æ•°</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ftrace_pids_enabled</span><span class="p">(</span><span class="n">ops</span><span class="p">))</span>
<span class="w">        </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_pid_func</span><span class="p">;</span>
<span class="w">    </span><span class="n">â‘¢</span><span class="w"> </span><span class="n">å¦‚æœè®¾ç½®çš„ç‰¹å®špid</span><span class="w"> </span><span class="n">è¿›è¡Œtrace</span><span class="err">ï¼Œ</span><span class="n">å°†traceå‡½æ•°æ›´æ–°ä¸º</span><span class="w"> </span><span class="n">ftrace_pid_func</span><span class="err">ï¼Œ</span><span class="n">å³ftrace_stubæ›´æ–°ä¸ºftrace_pid_func</span>
<span class="w">    </span><span class="n">ftrace_update_trampoline</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ftrace_enabled</span><span class="p">)</span>
<span class="w">        </span><span class="n">update_ftrace_function</span><span class="p">();</span>
<span class="n">â‘£</span><span class="w"> </span><span class="n">å°†å½“å‰çš„traceå‡½æ•°èµ‹å€¼åˆ°ftrace_trace_functionä¸­</span><span class="err">ï¼Œ</span><span class="n">è¡¨ç¤ºå½“å‰è¦ä¿®æ”¹çš„ç›®æ ‡å‡½æ•°</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_7">å‡½æ•°è¿‡æ»¤å¤„ç†</h3>
<p>å¦‚æœè®¾ç½®äº†è¿‡æ»¤å‡½æ•°ä¸éœ€è¦è¿›è¡Œè·Ÿè¸ªï¼Œéœ€å¯¹ç›¸åº”çš„æ¡©ç‚¹å®ä¾‹dyn_ftraceè®¾ç½®æ ‡è®°ï¼ŒFTRACE_FL_DISABLEDæ ‡å¿—è¡¨ç¤ºä¸éœ€è¦æ›´æ–°å…¥å£å‡½æ•°ï¼ŒFTRACE_FL_IPMODIFYè¡¨ç¤ºéœ€è¦æ›´æ–°ã€‚éœ€è¦è¿‡æ»¤çš„å‡½æ•°ï¼Œç»Ÿä¸€è®°å½•åœ¨ops-&gt;func_hash-&gt;filter_hashè¡¨ä¸­ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">__ftrace_hash_update_ipmodify</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">,</span>
<span class="w">                     </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_hash</span><span class="w"> </span><span class="o">*</span><span class="n">old_hash</span><span class="p">,</span>
<span class="w">                     </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_hash</span><span class="w"> </span><span class="o">*</span><span class="n">new_hash</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="cm">/* Update rec-&gt;flags */</span>
<span class="n">do_for_each_ftrace_rec</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span><span class="w"> </span><span class="n">rec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">éå†æ‰€æœ‰æ’æ¡©ç‚¹</span><span class="err">ï¼Œ</span><span class="n">æ˜¯å¦éœ€è¦è¿‡æ»¤æ‰</span><span class="err">ï¼Œ</span><span class="n">æ‰“ä¸Šå¯¹åº”çš„æ ‡è®°</span><span class="err">ã€‚</span>
<span class="p">}</span><span class="w"> </span><span class="n">while_for_each_ftrace_rec</span><span class="p">();</span>

<span class="p">}</span>
</code></pre></div>
<h3 id="ftrace-modify-all-code">ftrace modify all code</h3>
<p>å¦‚æœè¦æ›´æ–°å…¥å£å‡½æ•°ï¼Œæ ‡å¿—è®¾ç½®ä¸º FTRACE_UPDATE_CALLSï¼›å¦‚æœè¦æ›´æ–°è·Ÿè¸ªå‡½æ•°ï¼Œæ ‡å¿—è®¾ç½®ä¸ºFTRACE_UPDATE_TRACE_FUNCã€‚å¦‚æœä½¿èƒ½äº†ftrace graghï¼Œåˆ™æ ‡å¿—è®¾ç½®ä¸ºFTRACE_START_FUNC_RETã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ftrace_modify_all_code</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_UPDATE_TRACE_FUNC</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mod_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">update</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update_ftrace_func</span><span class="p">(</span><span class="n">ftrace_ops_list_func</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FTRACE_WARN_ON</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">    </span><span class="n">â‘ </span><span class="w"> </span><span class="n">å…ˆå°†è·Ÿè¸ªå‡½æ•°æ›¿æ¢ä¸ºftrace_ops_list_func</span><span class="err">ã€‚</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">command</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_UPDATE_CALLS</span><span class="p">)</span>
<span class="w">        </span><span class="n">ftrace_replace_code</span><span class="p">(</span><span class="n">mod_flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">FTRACE_MODIFY_ENABLE_FL</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">command</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_DISABLE_CALLS</span><span class="p">)</span>
<span class="w">        </span><span class="n">ftrace_replace_code</span><span class="p">(</span><span class="n">mod_flags</span><span class="p">);</span>
<span class="n">â‘¡æ›´æ–°å…¥å£å‡½æ•°</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">update</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ftrace_trace_function</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ftrace_ops_list_func</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">function_trace_op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">set_function_trace_op</span><span class="p">;</span>
<span class="w">        </span><span class="n">smp_wmb</span><span class="p">();</span>
<span class="w">        </span><span class="cm">/* If irqs are disabled, we are in stop machine */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">())</span>
<span class="w">            </span><span class="n">smp_call_function</span><span class="p">(</span><span class="n">ftrace_sync_ipi</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update_ftrace_func</span><span class="p">(</span><span class="n">ftrace_trace_function</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FTRACE_WARN_ON</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">â‘¢</span><span class="w"> </span><span class="n">åˆ¤æ–­ftrace_trace_function</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ftrace_ops_list_func</span><span class="err">ï¼Œ</span><span class="n">åˆ™é‡æ–°å°†è·Ÿè¸ªå‡½æ•°æ›´æ–°ä¸ºftrace_trace_function</span><span class="w"> </span><span class="err">ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">command</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_START_FUNC_RET</span><span class="p">)</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_enable_ftrace_graph_caller</span><span class="p">();</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">command</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_STOP_FUNC_RET</span><span class="p">)</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_disable_ftrace_graph_caller</span><span class="p">();</span>
</code></pre></div>
<h4 id="_8">æ›´æ–°è·Ÿè¸ªå‡½æ•°</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">update_ftrace_func</span><span class="p">(</span><span class="n">ftrace_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">)</span>
<span class="n">ftrace_update_ftrace_func</span><span class="p">(</span><span class="n">ftrace_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">)</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__ftrace_modify_call</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ftrace_call</span><span class="p">,</span>
<span class="w">                       </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__ftrace_modify_call</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ftrace_regs_call</span><span class="p">,</span>
<span class="w">                       </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">__ftrace_modify_call</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">hook_pos</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">target</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ra</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">call</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nops</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">NOP4</span><span class="p">,</span><span class="w"> </span><span class="n">NOP4</span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
<span class="w">        </span><span class="n">make_call_ra</span><span class="p">(</span><span class="n">hook_pos</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">make_call_t0</span><span class="p">(</span><span class="n">hook_pos</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">);</span>
<span class="w">    </span><span class="n">è®¡ç®—è·Ÿè¸ªå‡½æ•°çš„æŒ‡ä»¤</span><span class="err">ï¼Œ</span><span class="n">ä¿®æ”¹åœ°å€ftrace_callæˆ–ftrace_regs_callå¤„çš„è·³è½¬åœ°å€</span><span class="err">ï¼Œ</span><span class="n">é»˜è®¤æ˜¯ftrace_stub</span><span class="err">ï¼Œ</span><span class="n">å³å®Œæˆäº†ftrace_callæ ‡ç­¾å¤„çš„è·³è½¬æ›¿æ¢</span><span class="err">ï¼Œ</span><span class="n">è·Ÿè¸ªå‡½æ•°æ›¿æ¢å®Œæˆ</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="cm">/* Replace the auipc-jalr pair at once. Return -EPERM on write error. */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">patch_text_nosync</span>
<span class="w">        </span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">hook_pos</span><span class="p">,</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">nops</span><span class="p">,</span><span class="w"> </span><span class="n">MCOUNT_INSN_SIZE</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="w">    </span><span class="n">patch_text_nosyncå‡½æ•°åœ¨3</span><span class="mf">.4.4</span><span class="n">ç« èŠ‚æœ‰ç®€è¿°</span><span class="err">ï¼Œ</span><span class="n">è¿™é‡Œå°±ä¸å†é‡å¤</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_9">æ›´æ–°å…¥å£å‡½æ•°</h4>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__weak</span><span class="w"> </span><span class="nf">ftrace_replace_code</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">mod_flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dyn_ftrace</span><span class="w"> </span><span class="o">*</span><span class="n">rec</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_page</span><span class="w"> </span><span class="o">*</span><span class="n">pg</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_MODIFY_ENABLE_FL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">schedulable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FTRACE_MODIFY_MAY_SLEEP_FL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ftrace_disabled</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="n">â‘ </span><span class="w"> </span><span class="n">éå†æ¯ä¸ªå…¥å£å‡½æ•°çš„</span><span class="err">ï¼Œ</span><span class="n">è·å–å¯¹åº”çš„dyn_ftraceå®ä¾‹</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">do_for_each_ftrace_rec</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span><span class="w"> </span><span class="n">rec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="n">â‘¡</span><span class="w"> </span><span class="n">å¦‚æœå‡½æ•°å…¥å£ä¸éœ€è¦æ›´æ–°</span><span class="err">ï¼Œ</span><span class="n">åˆ™å¾ªç¯ç»§ç»­</span><span class="err">ï¼ˆ</span><span class="n">åˆ¤æ–­æ˜¯å¦è®¾ç½®FTRACE_FL_DISABLED</span><span class="err">ï¼‰</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">skip_record</span><span class="p">(</span><span class="n">rec</span><span class="p">))</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__ftrace_replace_code</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="n">enable</span><span class="p">);</span>
<span class="w">        </span><span class="n">â‘¢</span><span class="w"> </span><span class="n">å°†å‡½æ•°å…¥å£åœ°å€æ›¿æ¢</span><span class="err">ï¼ˆ</span><span class="n">é»˜è®¤ä¸ºnop</span><span class="err">ï¼‰</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">failed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ftrace_bug</span><span class="p">(</span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="n">rec</span><span class="p">);</span>
<span class="w">            </span><span class="cm">/* Stop processing */</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">schedulable</span><span class="p">)</span>
<span class="w">            </span><span class="n">cond_resched</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">while_for_each_ftrace_rec</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">__ftrace_replace_code</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dyn_ftrace</span><span class="w"> </span><span class="o">*</span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ftrace_old_addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ftrace_addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="n">ftrace_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_get_addr_new</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
<span class="w">    </span><span class="n">â‘ </span><span class="w"> </span><span class="n">è·å–è¦åœ¨å‡½æ•°å…¥å£è¦æ’æ¡©ç‚¹çš„å‡½æ•°åœ°å€</span><span class="err">ã€‚</span><span class="n">è¿”å›ç»“æœæœ‰æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µ</span><span class="err">ï¼š</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">FTRACE_FL_DIRECT</span><span class="err">ï¼š</span><span class="w"> </span><span class="n">åœ¨direct_functionsä¸­è·å–</span><span class="err">ï¼ˆ</span><span class="n">ç”¨æˆ·è‡ªå®šä¹‰</span><span class="err">ï¼Ÿï¼‰</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">FTRACE_FL_TRAMP</span><span class="err">ï¼š</span><span class="w"> </span><span class="n">è·³æ¿å‡½æ•°</span><span class="err">ï¼Ÿ</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">FTRACE_FL_REGS</span><span class="err">ï¼š</span><span class="n">FTRACE_REGS_ADDR</span><span class="err">ï¼Œ</span><span class="n">é»˜è®¤ä¸ºftrace_regs_caller</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">é»˜è®¤</span><span class="err">ï¼š</span><span class="w"> </span><span class="n">FTRACE_ADDR</span><span class="w"> </span><span class="err">ï¼Œ</span><span class="n">é»˜è®¤ä¸ºftrace_caller</span>
<span class="w">    </span><span class="cm">/* This needs to be done before we call ftrace_update_record */</span>
<span class="w">    </span><span class="n">ftrace_old_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_get_addr_curr</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftrace_update_record</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="n">enable</span><span class="p">);</span>

<span class="w">    </span><span class="n">ftrace_bug_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FTRACE_BUG_UNKNOWN</span><span class="p">;</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">FTRACE_UPDATE_IGNORE</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">FTRACE_UPDATE_MAKE_CALL</span><span class="p">:</span>
<span class="w">        </span><span class="n">ftrace_bug_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FTRACE_BUG_CALL</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ftrace_make_call</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="n">ftrace_addr</span><span class="p">);</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">FTRACE_UPDATE_MAKE_NOP</span><span class="p">:</span>
<span class="w">        </span><span class="n">ftrace_bug_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FTRACE_BUG_NOP</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ftrace_make_nop</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="n">ftrace_old_addr</span><span class="p">);</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">FTRACE_UPDATE_MODIFY_CALL</span><span class="p">:</span>
<span class="w">        </span><span class="n">ftrace_bug_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FTRACE_BUG_UPDATE</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ftrace_modify_call</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="w"> </span><span class="n">ftrace_old_addr</span><span class="p">,</span><span class="w"> </span><span class="n">ftrace_addr</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">â‘¡</span><span class="w"> </span><span class="n">å°†å…¥å£å‡½æ•°çš„æ¡©ç‚¹æ›¿æ¢ä¸ºæŒ‡å®šæ ‡ç­¾å‡½æ•°</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="cm">/* unknown ftrace bug */</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_10">æ€»ç»“</h2>
<p>æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬é‡ç‚¹åˆ†æäº†function tracerä½¿èƒ½åçš„å®ç°è¿‡ç¨‹ï¼Œåˆ†æäº†å¦‚ä½•å°†å‡½æ•°å…¥å£æ›¿æ¢ä¸ºftrace_callerï¼Œåˆ†æäº†ftrace_callerä¸­ftrace_callæ ‡ç­¾å¤„å¦‚ä½•è¢«æ›¿æ¢æˆè·³è½¬åˆ°ftrace_trace_functionã€‚æ•´ä¸ªftraceåŠ¨æ€è¿‡ç¨‹ä¸»è¦å®ç°äº†ä»¥ä¸‹åŠŸèƒ½ - èƒ½å¤ŸæŒ‡å®šå†…æ ¸å‡½æ•°å…¥å£è¿›è¡ŒæŒ‡ä»¤æ›¿æ¢ï¼Œä½¿å…¶è·³è½¬åˆ°ftrace_callerã€‚ - èƒ½å¤Ÿå¯¹è·Ÿè¸ªå‡½æ•°è¿›è¡Œæ›´æ–°ï¼Œä½¿æŒ‡å®šçš„è·Ÿè¸ªå‡½æ•°èƒ½å¤Ÿè¢«è°ƒç”¨ã€‚ åœ¨åŠ¨æ€å‡½æ•°çš„è·Ÿè¸ªåˆ†æè¿‡ç¨‹ä¸­ï¼Œregister_ftrace_functionå’Œftrace_set_filterè¿™ä¸¤ä¸ªå‡½æ•°è‡³å…³é‡è¦ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°ä½¿èƒ½function tracerçš„æ—¶å€™ä¼šè°ƒç”¨å¹¶è§¦å‘æŒ‡ä»¤æ›¿æ¢å’Œè·Ÿè¸ªå‡½æ•°æ›´æ–°åŠ¨ä½œã€‚åŒæ—¶è¿™ä¸¤ä¸ªå‡½æ•°ä¹Ÿæ˜¯æ¥å£ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°å®ç°è‡ªå·±çš„tracerã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * register_ftrace_function - register a function for profiling</span>
<span class="cm"> * @ops:    ops structure that holds the function for profiling.</span>
<span class="cm"> *</span>
<span class="cm"> * Register a function to be called by all functions in the</span>
<span class="cm"> * kernel.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: @ops-&gt;func and all the functions it calls must be labeled</span>
<span class="cm"> *       with \\\"notrace\\\", otherwise it will go into a</span>
<span class="cm"> *       recursive loop.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">register_ftrace_function</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="n">lock_direct_mutex</span><span class="p">();</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prepare_direct_functions_for_ipmodify</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out_unlock</span><span class="p">;</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">register_ftrace_function_nolock</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>

<span class="nl">out_unlock</span><span class="p">:</span>
<span class="w">    </span><span class="n">unlock_direct_mutex</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">register_ftrace_function</span><span class="p">);</span>
</code></pre></div>
<p>register_ftrace_functionæ˜¯ä¸€ä¸ªé€šç”¨çš„æ³¨å†Œå‡½æ•°ï¼Œä¼ é€’çš„å‚æ•°struct ftrace_ops *opså³æƒ³è¦åœ¨å‡½æ•°å…¥å£æ’å…¥è·Ÿè¸ªçš„å‡½æ•°ï¼Œæ— è®ºæ˜¯function tracerã€irqsoffã€fprobesã€trace_eventç­‰å‡½æ•°éƒ½æ˜¯è°ƒç”¨è¯¥å‡½æ•°è¿›è¡Œæ³¨å†Œæ’æ¡©ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰è‡ªå·±æƒ³è¦æ’æ¡©çš„å‡½æ•°ã€‚ ä»åŸç†ä¸Šæ¥è®²ï¼Œä½¿èƒ½äº†-fpatchable-function-entryç¼–è¯‘å‚æ•°åï¼Œå…¥å£å‡½æ•°å¤„å°±å äº†å‘ä½ï¼Œé»˜è®¤æ˜¯å…ˆç”¨nopæŒ‡ä»¤å¡«å……ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨è¿è¡Œé˜¶æ®µæƒ³æ¢æˆå•¥å°±æ¢æˆå•¥ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="é™æ€ftrace.html">â† é™æ€ftrace</a>
    <a class="next" href="ftrace-æ¦‚è¿°.html">ftrace-æ¦‚è¿° â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

