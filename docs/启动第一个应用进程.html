<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å¯åŠ¨ç¬¬ä¸€ä¸ªåº”ç”¨è¿›ç¨‹ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#ramdisk">ramdiskæ–¹å¼</a><ul></ul></li><li><a href="#execute_command">execute_commandæ–¹å¼</a><ul></ul></li><li><a href="#_1">é»˜è®¤æ–¹å¼</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>å¯åŠ¨ç¬¬ä¸€ä¸ªåº”ç”¨è¿›ç¨‹</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-07-07
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      risc-v
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><div class="codehilite"><pre><span></span><code><span class="n">start_kernel</span>
<span class="w">  </span><span class="p">......</span>
<span class="w">  </span><span class="n">arch_call_rest_init</span><span class="p">()</span>
<span class="w">  </span><span class="n">rest_init</span><span class="p">();</span>
<span class="w">  </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="n">kernel_init</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">CLONE_FS</span><span class="p">);</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__ref</span><span class="w"> </span><span class="nf">kernel_init</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="n">kernel_init_freeable</span><span class="p">();</span>
<span class="w">    </span><span class="cm">/* need to finish all async __init code before freeing the memory */</span>
<span class="w">    </span><span class="n">async_synchronize_full</span><span class="p">();</span>
<span class="w">    </span><span class="n">ftrace_free_init_mem</span><span class="p">();</span>
<span class="w">    </span><span class="n">free_initmem</span><span class="p">();</span>
<span class="w">    </span><span class="n">mark_readonly</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Kernel mappings are now finalized - update the userspace page-table</span>
<span class="cm">     * to finalize PTI.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">pti_finalize</span><span class="p">();</span>

<span class="w">    </span><span class="n">system_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SYSTEM_RUNNING</span><span class="p">;</span>
<span class="w">    </span><span class="n">numa_default_policy</span><span class="p">();</span>

<span class="w">    </span><span class="n">rcu_end_inkernel_boot</span><span class="p">();</span>
<span class="n">åˆ›å»º1å·è¿›ç¨‹çš„3ç§æ–¹å¼</span><span class="err">ï¼Œ</span><span class="n">å¦‚ä¸‹</span><span class="err">ï¼š</span>
<span class="mf">1.</span><span class="n">æ–¹å¼â‘ </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ramdisk_execute_command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_init_process</span><span class="p">(</span><span class="n">ramdisk_execute_command</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">pr_err</span><span class="p">(</span><span class="s">"Failed to execute %s (error %d)</span><span class="se">\\</span><span class="s">n"</span><span class="p">,</span>
<span class="w">               </span><span class="n">ramdisk_execute_command</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * We try each of these until one succeeds.</span>
<span class="cm">     *</span>
<span class="cm">     * The Bourne shell can be used instead of init if we are</span>
<span class="cm">     * trying to recover a really broken machine.</span>
<span class="cm">     */</span>
<span class="mf">2.</span><span class="n">æ–¹å¼â‘¡</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">execute_command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_init_process</span><span class="p">(</span><span class="n">execute_command</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">"Requested init %s failed (error %d)."</span><span class="p">,</span>
<span class="w">              </span><span class="n">execute_command</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>
<span class="mf">3.</span><span class="n">æ–¹å¼â‘¢</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">try_to_run_init_process</span><span class="p">(</span><span class="s">"/sbin/init"</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="o">!</span><span class="n">try_to_run_init_process</span><span class="p">(</span><span class="s">"/etc/init"</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="o">!</span><span class="n">try_to_run_init_process</span><span class="p">(</span><span class="s">"/bin/init"</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="o">!</span><span class="n">try_to_run_init_process</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">"No working init found.  Try passing init= option to kernel. "</span>
<span class="w">          </span><span class="s">"See Linux Documentation/admin-guide/init.rst for guidance."</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>ä»ä¸Šè¿°ä»£ç ç§å¯çŸ¥ï¼Œå¯åŠ¨1å·è¿›ç¨‹initä¸€å…±æœ‰3ç§æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯ramdiskçš„æ–¹å¼ã€execute_commandçš„æ–¹å¼ã€é»˜è®¤æ–¹å¼ã€‚ç¬¬ä¸€ç§æ˜¯åŸºäºramdiskçš„æ–¹å¼ï¼Œå°†ramä½œä¸ºå¯åŠ¨ç›˜æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚ç¬¬äºŒç§é€šå¸¸ç”¨äºç”¨æˆ·æŒ‡å®šç¬¬ä¸€ä¸ªinitè¿›ç¨‹å¯åŠ¨åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ä½ç½®ã€‚å¦‚æœç¬¬ä¸€ä¸ªå’Œç¬¬äºŒéƒ½æ²¡æœ‰å°±ä¼šä½¿ç”¨é»˜è®¤ã€‚</p>
<h2 id="ramdisk">ramdiskæ–¹å¼</h2>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">rdinit_setup</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="n">ramdisk_execute_command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* See "auto" comment in init_setup */</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_INIT_ARGS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">argv_init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">"rdinit="</span><span class="p">,</span><span class="w"> </span><span class="n">rdinit_setup</span><span class="p">);</span>
</code></pre></div>
<p>__setup(str,fn)çš„ä½œç”¨æ˜¯ï¼Œåœ¨ç³»ç»Ÿå¼€æœºæ—¶è§£æcmdlineä¸­æ˜¯å¦æœ‰strå­—æ®µï¼Œå¦‚æœæœ‰å°±ä¼šè°ƒç”¨fnå‡½æ•°ï¼Œå› æ­¤ä¸Šé¢çš„å‡½æ•°æ„æ€å°±æ˜¯å½“cmdlineä¸­æœ‰rdinit=å­—æ®µæ—¶ï¼Œå°±ä¼šè°ƒç”¨rdinit_setupå‡½æ•°ï¼Œå°†rdinit=åé¢çš„å†…å®¹èµ‹å€¼ç»™ramdisk_execute_commandã€‚</p>
<h2 id="execute_command">execute_commandæ–¹å¼</h2>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">init_setup</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="n">execute_command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * In case LILO is going to boot us with default command line,</span>
<span class="cm">     * it prepends "auto" before the whole cmdline which makes</span>
<span class="cm">     * the shell think it should execute a script with such name.</span>
<span class="cm">     * So we ignore all arguments entered _before_ init=... [MJ]</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_INIT_ARGS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">argv_init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">"init="</span><span class="p">,</span><span class="w"> </span><span class="n">init_setup</span><span class="p">);</span>
</code></pre></div>
<p>ä¸Šè¿°ä»£ç åŒç†ï¼Œå½“cmdlineä¸­å­˜åœ¨\"init=\"æ—¶ï¼Œè°ƒç”¨init_setupï¼Œå°†å‚æ•°èµ‹å€¼ç»™execute_commandã€‚è¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯å¯ä»¥è®©ç”¨æˆ·æŒ‡å®šå¯åŠ¨çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ã€‚</p>
<h2 id="_1">é»˜è®¤æ–¹å¼</h2>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__ref</span><span class="w"> </span><span class="nf">kernel_init</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="p">......</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">try_to_run_init_process</span><span class="p">(</span><span class="s">"/sbin/init"</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="o">!</span><span class="n">try_to_run_init_process</span><span class="p">(</span><span class="s">"/etc/init"</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="o">!</span><span class="n">try_to_run_init_process</span><span class="p">(</span><span class="s">"/bin/init"</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="o">!</span><span class="n">try_to_run_init_process</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<p>å½“cmdlineä¸­æ—¢æ²¡æœ‰rdinitå’Œinitå­—æ®µæ—¶ï¼Œå°±æ˜¯ç›´æ¥ä½¿ç”¨é»˜è®¤çš„æ–¹å¼ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="linuxç³»ç»Ÿrisc-væ¶æ„å¯åŠ¨æµç¨‹åˆ†æä¹‹æ¦‚è¿°.html">â† Linuxç³»ç»ŸRISC-Væ¶æ„å¯åŠ¨æµç¨‹åˆ†æä¹‹æ¦‚è¿°</a>
    <a class="next" href="è™šæ‹Ÿåœ°å€ç©ºé—´ä¸ç‰©ç†åœ°å€ç©ºé—´å®Œæ•´æ˜ å°„.html">è™šæ‹Ÿåœ°å€ç©ºé—´ä¸ç‰©ç†åœ°å€ç©ºé—´å®Œæ•´æ˜ å°„ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

