<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å¹³å¤´å“¥E90Xçš„head.Såˆ†æ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">å…³é—­ä¸­æ–­</a><ul></ul></li><li><a href="#_2">è®¾ç½®å¼‚å¸¸å¤„ç†å…¥å£</a><ul></ul></li><li><a href="#_3">è®¾ç½®ä¸­æ–­å¤„ç†å…¥å£</a><ul></ul></li><li><a href="#_4">ä¸­æ–­å‘é‡è¡¨</a><ul></ul></li><li><a href="#bss">æ¸…é™¤BSSæ®µ</a><ul></ul></li><li><a href="#sp">è®¾ç½®æ ˆSP</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>å¹³å¤´å“¥E90Xçš„head.Såˆ†æ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-05-09
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      risc-v
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">å…³é—­ä¸­æ–­</h2>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="cm">/* disable interrupt */</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">MR_MIE</span><span class="w">      </span><span class="o">---</span><span class="w"> </span><span class="n">t0</span><span class="o">=</span><span class="mh">0x08</span>
<span class="w">    </span><span class="n">csrc</span><span class="w"> </span><span class="n">mstatus</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="w">   </span><span class="o">---</span><span class="w"> </span><span class="n">mstatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mstatus</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">~</span><span class="n">t0</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mie</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="w">     </span><span class="o">---</span><span class="w"> </span><span class="n">mie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zero</span>
</code></pre></div>
<p>mstatusç¬¬4bitæ¸…0ï¼Œmieæ¸…0ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_654ac9ad45d1a7b860525a5fce358d03.jpg"><img alt="" src="assets/doc/02-risc-v/å¹³å¤´å“¥e90xçš„head-såˆ†æ/images/wp_editor_md_654ac9ad45d1a7b860525a5fce358d03.jpg"/></a></p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_087b9e60788d7e4b8068b7d65606c5b5.jpg"><img alt="" src="assets/doc/02-risc-v/å¹³å¤´å“¥e90xçš„head-såˆ†æ/images/wp_editor_md_087b9e60788d7e4b8068b7d65606c5b5.jpg"/></a></p>
<h2 id="_2">è®¾ç½®å¼‚å¸¸å¤„ç†å…¥å£</h2>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="cm">/* setup the address of exception handler */</span>
<span class="w">    </span><span class="n">la</span><span class="w">      </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">risc_v_trap_handler</span>
<span class="w">    </span><span class="n">ori</span><span class="w">     </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span>
<span class="w">    </span><span class="n">csrw</span><span class="w">    </span><span class="n">mtvec</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span>
</code></pre></div>
<p>E90Xå¼‚å¸¸å’Œä¸­æ–­ä½¿ç”¨äº†CLINTå’ŒCLICä¸¤ä¸ªæ§åˆ¶å™¨ï¼Œå¯¹äºå¼‚å¸¸çš„æœåŠ¡ç¨‹åºå…¥å£å‡½æ•°æœ‰MTVECå¯„å­˜å™¨æŒ‡å®šï¼Œè¿™é‡Œçš„å¼‚å¸¸æŒ‡çš„æ˜¯åŒæ­¥å¼‚å¸¸ï¼Œè¿™ç±»å¼‚å¸¸æ²¡æ³•å±è”½ï¼Œé€šå¸¸æ˜¯æ‰§è¡ŒæŒ‡ä»¤ã€å–æŒ‡ä»¤ã€éæ³•å†…å­˜è®¿é—®ç­‰çš„å¼‚å¸¸ã€‚MTVECå¯„å­˜å™¨çš„ä½2ä½ï¼Œè®¾ç½®ä¸º3,è¡¨ç¤ºä½¿ç”¨æ¨¡å¼3ï¼Œè¯¥æ¨¡å¼ä¸‹CPUä½¿ç”¨MTVEC[31:6]&lt;&lt;6ä½œä¸ºå¼‚å¸¸ï¼ˆåŒæ­¥å¼‚å¸¸ï¼‰çš„æœåŠ¡ç¨‹åºå…¥å£åœ°å€å¹¶è·³è½¬æ‰§è¡Œã€‚</p>
<h2 id="_3">è®¾ç½®ä¸­æ–­å¤„ç†å…¥å£</h2>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="cm">/* setup the address of vector interrupt handler */</span>
<span class="w">    </span><span class="n">la</span><span class="w">      </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">interrupt_vectors</span>
<span class="w">    </span><span class="n">csrw</span><span class="w">    </span><span class="n">mtvt</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span>
</code></pre></div>
<p>å½“MTVECçš„ä½ä¸¤ä½è®¾ç½®MODE[1:0]=3æ—¶ï¼ŒCPUä½¿ç”¨MTVEC[31:6]&lt;&lt;6ä½œä¸ºå¼‚å¸¸ï¼ˆåŒæ­¥å¼‚å¸¸ï¼‰çš„æœåŠ¡ç¨‹åºå…¥å£åœ°å€å¹¶è·³è½¬æ‰§è¡Œï¼Œè€Œå¯¹äºä¸­æ–­æœåŠ¡ç¨‹åºå…¥å£åˆ†ä¸¤ç§æƒ…å†µï¼Œå½“ä½¿èƒ½äº†CLIC.CLICINTATTRä¸­çš„shvåŸŸè®¾ç½®æ˜¯å¦ä¸ºç¡¬ä»¶çŸ¢é‡ä¸­æ–­ï¼Œå¦‚æœæ˜¯ç¡¬ä»¶çŸ¢é‡ä¸­æ–­ï¼ŒCPUé¦–å…ˆä½¿ç”¨MTVT+4*ä¸­æ–­IDä¸ºåœ°å€ï¼Œå»å–ä¸­æ–­æœåŠ¡ç¨‹åºå…¥å£åœ°å€ï¼Œå¹¶è·³è½¬åˆ°è¯¥å…¥å£åœ°å€æ‰§è¡Œï¼Œå¦‚æœæ˜¯éçŸ¢é‡ä¸­æ–­ï¼ŒCPUä½¿ç”¨MTVEC[31:6]&lt;&lt;ä½œä¸ºä¸­æ–­æœåŠ¡ç¨‹åºå…¥å£åœ°å€å¹¶è·³è½¬æ‰§è¡Œã€‚MTVTä¸ºçŸ¢é‡ä¸­æ–­åŸºå€å¯„å­˜å™¨ï¼Œåœ¨CLICæ¨¡å¼å­˜åœ¨ã€‚åœ¨E907ä¸­MODE[1:0]ç¡¬ä»¶å›ºå®šè®¾ç½®ä¸º3ï¼Œè½¯ä»¶ä¸å¯è®¾ç½®ã€‚</p>
<h2 id="_4">ä¸­æ–­å‘é‡è¡¨</h2>
<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="n">section</span><span class="w"> </span><span class="p">.</span><span class="n">vectors</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="s">"xx</span><span class="se">\"</span><span class="s">, @progbits</span>
<span class="w">    </span><span class="p">.</span><span class="n">balign</span><span class="w"> </span><span class="mi">64</span>
<span class="w">    </span><span class="p">.</span><span class="n">globl</span><span class="w">  </span><span class="n">clic_interrupt_vectors</span>
<span class="w">    </span><span class="p">.</span><span class="n">type</span><span class="w">   </span><span class="n">clic_interrupt_vectors</span><span class="p">,</span><span class="w"> </span><span class="err">@</span><span class="n">object</span>
<span class="w">    </span><span class="nl">clic_interrupt_vectors</span><span class="p">:</span>
<span class="w">    </span><span class="p">.</span><span class="n">rept</span><span class="w">   </span><span class="p">(</span><span class="n">PLAT_CLIC_IRQ_CNT</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="kt">long</span><span class="w">   </span><span class="n">clic_interrupt_handler</span>
<span class="w">    </span><span class="p">.</span><span class="n">endr</span>
<span class="p">.</span><span class="n">text</span>
</code></pre></div>
<p>è¿™é‡Œé»˜è®¤è®¾ç½®ä¸ºä¸­æ–­ç¡¬ä»¶çŸ¢é‡æ¨¡å¼ï¼Œæ‰€ä»¥éœ€è¦æ³¨å†Œå‘é‡è¡¨ï¼Œä½†æ˜¯è¿™é‡Œå‘é‡è¡¨ç»Ÿä¸€å…¥å£ä¸ºclic_interrupt_handlerã€‚</p>
<h2 id="bss">æ¸…é™¤BSSæ®µ</h2>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="cp"># clear mscratch register.</span>
<span class="w">    </span><span class="n">csrw</span><span class="w">   </span><span class="n">mscratch</span><span class="p">,</span><span class="n">zero</span>

<span class="w">    </span><span class="cm">/* Clear bss section */</span>
<span class="w">    </span><span class="n">la</span><span class="w">      </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">__bss_start__</span>
<span class="w">    </span><span class="n">la</span><span class="w">      </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">__bss_end__</span>
<span class="w">    </span><span class="n">bgeu</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="mf">2f</span><span class="w">   </span><span class="o">---</span><span class="w"> </span><span class="mf">2f</span><span class="n">æ ‡ç­¾åé¢è·Ÿç€ä¸€ä¸ªå­—ç¬¦</span><span class="err">ï¼ˆ</span><span class="n">å¦‚f</span><span class="err">ï¼‰</span><span class="n">æ˜¯ä¸€ç§å¸¸è§çš„å‘½åçº¦å®š</span><span class="err">ï¼Œ</span><span class="n">å¸®åŠ©åŒºåˆ†ä¸åŒç±»å‹çš„æ ‡ç­¾</span><span class="err">ï¼Œ</span><span class="n">è¿™é‡Œæš—ç¤ºè¿™æ˜¯ä¸€ä¸ªå‘å‰è·³è½¬çš„ç›®æ ‡</span><span class="err">ï¼ˆ</span><span class="n">forward</span><span class="w"> </span><span class="n">jump</span><span class="w"> </span><span class="n">target</span><span class="err">ï¼‰</span><span class="p">,</span><span class="n">å¦‚æœa0</span><span class="o">&gt;=</span><span class="n">a1</span><span class="p">,</span><span class="n">å‘å‰è·³è½¬åˆ°æ ‡ç­¾2çš„åœ°æ–¹</span><span class="err">ã€‚</span>
<span class="mi">1</span><span class="o">:</span>
<span class="w">    </span><span class="n">sw</span><span class="w">      </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>
<span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="n">bltu</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="n">b</span><span class="w"> </span><span class="o">--</span><span class="mi">-1</span><span class="n">bbä¹Ÿæ˜¯ä¸€ä¸ªæ ‡ç­¾</span><span class="err">ï¼Œ</span><span class="n">ä½†ä¸ä¹‹å‰çš„2fä¸åŒ</span><span class="err">ï¼Œ</span><span class="n">å®ƒæŒ‡ç¤ºäº†ä¸€ä¸ªå‘åè·³è½¬</span><span class="err">ï¼ˆ</span><span class="n">backward</span><span class="w"> </span><span class="n">jump</span><span class="err">ï¼‰</span><span class="n">çš„ç›®æ ‡</span><span class="err">ã€‚</span><span class="n">è¿™é‡Œçš„båç¼€è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå‘åçš„è·³è½¬</span><span class="err">ï¼Œ</span><span class="n">æ„å‘³ç€å¦‚æœæ¡ä»¶æ»¡è¶³</span><span class="err">ï¼ˆ</span><span class="n">å³a0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">a1</span><span class="err">ï¼‰</span>

<span class="mi">2</span><span class="o">:</span>
<span class="w">   </span><span class="n">xxxx</span>
</code></pre></div>
<p>ä¸Šé¢çš„æ±‡ç¼–ä»£ç çš„ä½œç”¨å°±æ˜¯è·å–åˆ°bssæ®µçš„èµ·å§‹åœ°å€ï¼Œç„¶åå†™å…¥0ï¼›</p>
<h2 id="sp">è®¾ç½®æ ˆSP</h2>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="cm">/* setup stack pointer for C runtime environment */</span>
<span class="w">    </span><span class="n">la</span><span class="w">      </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">__init_process_stack_end__</span>
</code></pre></div>
<p><strong>init_process_stack_end</strong>æ˜¯åœ¨é“¾æ¥è„šæœ¬ä¸­æ ˆç©ºé—´ç»“æŸåœ°å€ï¼Œè¿™é‡Œç›´æ¥å¤åˆ¶ä¸ºspå³å¯ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="risc-væ¶æ„ä¸freertosä»»åŠ¡æ ˆå˜åŒ–.html">â† RISC-Væ¶æ„ä¸FreeRTOSä»»åŠ¡æ ˆå˜åŒ–</a>
    <a class="next" href="å¹³å¤´å“¥e90xå¼‚å¸¸å¤„ç†.html">å¹³å¤´å“¥E90Xå¼‚å¸¸å¤„ç† â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

