<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ftrace的使用 - Laumy的技术栈</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">首页</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="访问主站">主站点:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#tracer">tracer</a><ul><li><a href="#irqsoff">irqsoff</a></li><li><a href="#function">function</a></li><li><a href="#function-graph-tracer">function graph tracer</a></li><li><a href="#dynamic-ftrace">dynamic ftrace</a></li><li><a href="#dynamic-ftrace-with-function-graph-tracer">dynamic ftrace with function graph tracer</a></li><li><a href="#other">other</a></li></ul></li><li><a href="#events">events使用</a><ul><li><a href="#sched_switch">sched_switch</a></li><li><a href="#irq">irq</a></li><li><a href="#_1">小结</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>ftrace的使用</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">🕒</i>
      2024-08-27
    </span>
    <span class="meta-item">
      <i class="icon">📂</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">👤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="tracer">tracer</h2>
<h3 id="irqsoff">irqsoff</h3>
<p>当关闭中断时，CPU就无法响应中断了（NMI和SMI除外），无法响应外部事件做出反应。这会阻止定时器触发或鼠标中断触发，导致系统延迟。 irqsoff跟踪器跟踪中断被禁用的时间，当达到新的最大延迟时，跟踪器会保存导致该延迟点的跟踪，一边每次达到新的最大值，旧的保存的跟踪会被丢弃，新的跟踪会被保存。如果要重置最大值，用echo 0写到tracing_max_latency中。</p>
<div class="codehilite"><pre><span></span><code><span class="cp"># echo 0 &gt; options/function-trace</span>
<span class="cp"># echo irqsoff &gt; current_tracer</span>
<span class="cp"># echo 1 &gt; tracing_on</span>
<span class="cp"># echo 0 &gt; tracing_max_latency</span>
<span class="cp"># ls -ltr</span>
<span class="p">[...]</span>
<span class="cp"># echo 0 &gt; tracing_on</span>
<span class="cp"># cat trace</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_3b7340fb5fcf13be7e879fb3db8587bf.jpg"><img alt="" src="assets/doc/01-linux/性能工具/tracer的使用/images/wp_editor_md_3b7340fb5fcf13be7e879fb3db8587bf.jpg"/></a></p>
<p>上图示例可以最大延迟为3603us，在default_idle_call和__do_softirq中禁用了中断，主要看=&gt; started at:default_idle_call和=&gt; ended at: __do_softirq。表示关中断的开始函数和开中断的函数。</p>
<p>上面示例中，将funciton-trace关掉了，没有启用此tracer过程的函数跟踪。如果设置function-trace，就会有很多的打印，会将此过程中的函数执行trace打印出来。echo 1 &gt; options/function-trace。</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_a77a2861cca77d80dac12cbbb1713743.jpg"><img alt="" src="assets/doc/01-linux/性能工具/tracer的使用/images/wp_editor_md_a77a2861cca77d80dac12cbbb1713743.jpg"/></a></p>
<p>如果想要以函数图调用的方式打印，那么with echo 1 &gt; options/display-graph。</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_a185de881d78bbe6c37c61b9034edb78.jpg"><img alt="" src="assets/doc/01-linux/性能工具/tracer的使用/images/wp_editor_md_a185de881d78bbe6c37c61b9034edb78.jpg"/></a></p>
<p>有时候cat trace是空的，可能设置的追踪阈值太长，可以修改短一点。</p>
<div class="codehilite"><pre><span></span><code><span class="n">echo</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tracing_thresh</span><span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">设置阈值为</span><span class="w"> </span><span class="mi">5</span><span class="n">μs</span>
</code></pre></div>
<h3 id="function">function</h3>
<p>function为函数跟踪器，可以从调试文件系统启动函数跟踪器，echo function &gt; current_tracer。</p>
<div class="codehilite"><pre><span></span><code><span class="cp"># echo function &gt; current_tracer</span>
<span class="cp"># echo 1 &gt; tracing_on</span>
<span class="cp"># usleep 1</span>
<span class="cp"># echo 0 &gt; tracing_on</span>
<span class="cp"># cat trace</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_927e9c7fdecaad83273a99daece51b00.jpg"><img alt="" src="assets/doc/01-linux/性能工具/tracer的使用/images/wp_editor_md_927e9c7fdecaad83273a99daece51b00.jpg"/></a></p>
<p>需要注意的是，function tracer使用环形缓冲区来存储上述数据，最新数据可能会覆盖最旧的数据，有时使用echo 来停止跟踪器是不够的，因为跟踪可能会覆盖您想要记录的数据。因此最好直接从程序中禁用跟踪，允许您在到达你感兴趣的部分时停止跟踪，如果要从C程序禁用跟踪，可以使用类似下面代码；</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">trace_fd</span><span class="p">;</span>
<span class="p">[...]</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">[...]</span>
<span class="w">    </span><span class="n">trace_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">tracing_file</span><span class="p">(</span><span class="s">"tracing_on"</span><span class="p">),</span><span class="w"> </span><span class="n">O_WRONLY</span><span class="p">);</span>
<span class="w">    </span><span class="p">[...]</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condition_hit</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">write</span><span class="p">(</span><span class="n">trace_fd</span><span class="p">,</span><span class="w"> </span><span class="s">"0"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">[...]</span>
<span class="p">}</span>
</code></pre></div>
<p>单个线程的跟踪，</p>
<div class="codehilite"><pre><span></span><code><span class="cp"># cat set_ftrace_pid</span>
<span class="w">  </span><span class="n">no</span><span class="w"> </span><span class="n">pid</span>
<span class="cp"># echo 3111 &gt; set_ftrace_pid</span>
<span class="cp"># cat set_ftrace_pid</span>
<span class="w">  </span><span class="mi">3111</span>
<span class="cp"># echo function &gt; current_tracer</span>
<span class="cp"># cat trace | head</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_b5ee0bfadcf5e2ed872399ce46577143.jpg"><img alt="" src="assets/doc/01-linux/性能工具/tracer的使用/images/wp_editor_md_b5ee0bfadcf5e2ed872399ce46577143.jpg"/></a></p>
<p>如果想要trace一个函数在启动运行时，可以使用下面的示例程序。</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/types.h&gt;</span>
<span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/stat.h&gt;</span>
<span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>
<span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>

<span class="w">    </span><span class="cp">#define _STR(x) #x</span>
<span class="w">    </span><span class="cp">#define STR(x) _STR(x)</span>
<span class="w">    </span><span class="cp">#define MAX_PATH 256</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">find_tracefs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">           </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">tracefs</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="w">           </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tracefs_found</span><span class="p">;</span>
<span class="w">           </span><span class="kt">char</span><span class="w"> </span><span class="n">type</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
<span class="w">           </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">fp</span><span class="p">;</span>

<span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tracefs_found</span><span class="p">)</span>
<span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="n">tracefs</span><span class="p">;</span>

<span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="s">"/proc/mounts"</span><span class="p">,</span><span class="s">"r"</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="n">perror</span><span class="p">(</span><span class="s">"/proc/mounts"</span><span class="p">);</span>
<span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">           </span><span class="p">}</span>

<span class="w">           </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">fscanf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="s">"%*s %"</span>
<span class="w">                     </span><span class="n">STR</span><span class="p">(</span><span class="n">MAX_PATH</span><span class="p">)</span>
<span class="w">                     </span><span class="s">"s %99s %*s %*d %*d</span><span class="se">\\</span><span class="s">n"</span><span class="p">,</span>
<span class="w">                     </span><span class="n">tracefs</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="s">"tracefs"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                       </span><span class="k">break</span><span class="p">;</span>
<span class="w">           </span><span class="p">}</span>
<span class="w">           </span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

<span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="s">"tracefs"</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"tracefs not mounted"</span><span class="p">);</span>
<span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">           </span><span class="p">}</span>

<span class="w">           </span><span class="n">strcat</span><span class="p">(</span><span class="n">tracefs</span><span class="p">,</span><span class="w"> </span><span class="s">"/tracing/"</span><span class="p">);</span>
<span class="w">           </span><span class="n">tracefs_found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">           </span><span class="k">return</span><span class="w"> </span><span class="n">tracefs</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">tracing_file</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">file_name</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">           </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">trace_file</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="w">           </span><span class="n">snprintf</span><span class="p">(</span><span class="n">trace_file</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_PATH</span><span class="p">,</span><span class="w"> </span><span class="s">"%s/%s"</span><span class="p">,</span><span class="w"> </span><span class="n">find_tracefs</span><span class="p">(),</span><span class="w"> </span><span class="n">file_name</span><span class="p">);</span>
<span class="w">           </span><span class="k">return</span><span class="w"> </span><span class="n">trace_file</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fork</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">ffd</span><span class="p">;</span>
<span class="w">                </span><span class="kt">char</span><span class="w"> </span><span class="n">line</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>

<span class="w">                </span><span class="n">ffd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">tracing_file</span><span class="p">(</span><span class="s">"current_tracer"</span><span class="p">),</span><span class="w"> </span><span class="n">O_WRONLY</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ffd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                        </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">                </span><span class="n">write</span><span class="p">(</span><span class="n">ffd</span><span class="p">,</span><span class="w"> </span><span class="s">"nop"</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>

<span class="w">                </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">tracing_file</span><span class="p">(</span><span class="s">"set_ftrace_pid"</span><span class="p">),</span><span class="w"> </span><span class="n">O_WRONLY</span><span class="p">);</span>
<span class="w">                </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="s">"%d</span><span class="se">\\</span><span class="s">n"</span><span class="p">,</span><span class="w"> </span><span class="n">getpid</span><span class="p">());</span>
<span class="w">                </span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>

<span class="w">                </span><span class="n">write</span><span class="p">(</span><span class="n">ffd</span><span class="p">,</span><span class="w"> </span><span class="s">"function"</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>

<span class="w">                </span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">                </span><span class="n">close</span><span class="p">(</span><span class="n">ffd</span><span class="p">);</span>

<span class="w">                </span><span class="n">execvp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">argv</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>当然也可以使用简单的脚步来实现</p>
<div class="codehilite"><pre><span></span><code><span class="n">Or</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">simple</span><span class="w"> </span><span class="n">script</span><span class="o">!</span>
<span class="o">::</span>

<span class="w">  </span><span class="cp">#!/bin/bash</span>

<span class="w">  </span><span class="n">tracefs</span><span class="o">=</span><span class="err">`</span><span class="n">sed</span><span class="w"> </span><span class="o">-</span><span class="n">ne</span><span class="w"> </span><span class="err">\'</span><span class="n">s</span><span class="o">/^</span><span class="n">tracefs</span><span class="w"> </span><span class="err">\\</span><span class="p">(.</span><span class="o">*</span><span class="err">\\</span><span class="p">)</span><span class="w"> </span><span class="n">tracefs</span><span class="p">.</span><span class="o">*/</span><span class="err">\\</span><span class="mi">1</span><span class="o">/</span><span class="n">p</span><span class="err">\'</span><span class="w"> </span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">mounts</span><span class="err">`</span>
<span class="w">  </span><span class="n">echo</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">$tracefs</span><span class="o">/</span><span class="n">tracing_on</span>
<span class="w">  </span><span class="n">echo</span><span class="w"> </span><span class="n">$$</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">$tracefs</span><span class="o">/</span><span class="n">set_ftrace_pid</span>
<span class="w">  </span><span class="n">echo</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">$tracefs</span><span class="o">/</span><span class="n">current_tracer</span>
<span class="w">  </span><span class="n">echo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">$tracefs</span><span class="o">/</span><span class="n">tracing_on</span>
<span class="w">  </span><span class="n">exec</span><span class="w"> </span><span class="err">\</span><span class="s">"$@</span><span class="se">\"</span>
</code></pre></div>
<h3 id="function-graph-tracer">function graph tracer</h3>
<p>function graph tracer与function tracer类似，不同之处在于它会在函数进入和退出时对其进行探测，这是通过每个task_struct中使用动态分配的返回地址堆栈来实现的。在函数进入时，跟踪器会覆盖跟踪每个函数的返回地址以设置自定义探测器，因此原始返回地址存储在task_struct中的返回地址堆栈中。在函数两端进行探测可实现特殊功能，例如：测量函数的执行时间，拥有可靠调用堆栈来绘制函数的调用图。这种跟踪器在以下几种情况很有用：</p>
<ul>
<li>找到奇怪内核行为的原因，详细了解任何区域发生的情况。</li>
<li>遇到奇怪的延迟，但很难找到根源。</li>
<li>快速找到特定函数的调用路径。</li>
<li>窥视正在运行的内核并查看发生了什么。</li>
</ul>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_eded07629091b16a6b594469a0278ba3.jpg"><img alt="" src="assets/doc/01-linux/性能工具/tracer的使用/images/wp_editor_md_eded07629091b16a6b594469a0278ba3.jpg"/></a></p>
<p>有几列是可以动态启用和禁止的。 - cpu number是默认会启动函数执行的cpu编号，有时候最好只跟踪一个cpu（tracing_cpu_mask），否则在cpu跟踪是，会看到无须的函数调用。隐藏cpu: echo nofuncgraph-cpu &gt; trace_options。 - duration表示函数执行的时间，会显示在函数结束括号行上。如果是叶函数，则显示在当前函数的同一行。如果要关掉，则echo nofuncgraph-duration &gt; trace_options。 如果函数的开头不在跟踪缓冲区，则函数名称可以显示到函数的右括号后面，可以echo funcgraph-tail &gt; trace_options进行使能。</p>
<h3 id="dynamic-ftrace">dynamic ftrace</h3>
<p>如果使能了CONFIG_DYNAMIC_FTRACE，则在禁用函数跟踪时，系统将几乎不产生任何开销。其工作原理是使能了gcc的-pg参数会自动在内核的函数开头插桩mcount函数（与架构有关系，gcc 4.6版本开始，x86架构添加mfentry，它调用“<strong>fentry</strong>”而不是“mcount”）。 在编译时，每个C文件对象通过recordmcount程序（位于脚本目录）运行，该程序将解析C对象的ELF标头，查找.text部分中调用mcount的所有位置。 NOTE:注意的是并非所有的section都被跟踪，可以通过notrace或其他办法来不让其跟踪，并且不会跟踪所有的内联函数，可以cat available_filter_functions节点来查看可以跟踪那些函数。 创建一个“__mcount_loc”的段（section），该段中记录了所有包含在.text中对mcount调用点的引用位置。最后__mcount_loc在链接时统一链接到一个__mcount_loc中。</p>
<p>具体的过程如上图所示，在系统启动时，初始化SMP之前，动态ftrace代码会扫描此表并将所有位置更新为替换为nop指令，同时还会记录位置，这些位置被添加到available_filter_functions表中。在模块加载和执行之前进行处理，卸载模块时，它还会从ftrace函数列表中删除其函数。 在启动动态跟踪后，修改函数跟踪点的过程取决于具体的arch。修改函数跟踪点的方法时要修改位置放置一个断点，同步所有的CPU。接着修改其指令，同步给所有的CPU再把断点移除。通过这样动态的方式，可以做到有选择的跟踪指定函数，其他不想跟踪的函数就的位置执行的是nop指令，不至于影响性能。 内核中使用两个文件用于启动和禁用指定的函数跟踪分别是set_ftrace_filter和set_ftrace_notrace。可以通过available_filter_functions来查看跟踪的函数。</p>
<div class="codehilite"><pre><span></span><code><span class="cp"># echo sys_nanosleep hrtimer_interrupt &gt; set_ftrace_filter</span>
<span class="cp"># echo function &gt; current_tracer</span>
<span class="cp"># echo 1 &gt; tracing_on</span>
<span class="cp"># usleep 1</span>
<span class="cp"># echo 0 &gt; tracing_on</span>
<span class="cp"># cat trace</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_7c4c59a5986dc23ef9dc65b006826f86.jpg"><img alt="" src="assets/doc/01-linux/性能工具/tracer的使用/images/wp_editor_md_7c4c59a5986dc23ef9dc65b006826f86.jpg"/></a></p>
<p>设置set_ftrace_filter可以使用通配符匹配，示例如下：</p>
<div class="codehilite"><pre><span></span><code><span class="err">``</span><span class="o">&lt;</span><span class="n">match</span><span class="o">&gt;*</span><span class="err">``</span><span class="w"> </span><span class="err">：</span><span class="n">匹配</span><span class="o">&lt;</span><span class="n">match</span><span class="o">&gt;</span><span class="n">开头的函数</span>
<span class="err">``</span><span class="o">*&lt;</span><span class="n">match</span><span class="o">&gt;</span><span class="err">``：</span><span class="n">匹配</span><span class="o">&lt;</span><span class="n">match</span><span class="o">&gt;</span><span class="n">结尾的函数</span>
<span class="err">``</span><span class="o">*&lt;</span><span class="n">match</span><span class="o">&gt;*</span><span class="err">``：</span><span class="n">匹配其中包含</span><span class="o">&lt;</span><span class="n">match</span><span class="o">&gt;</span><span class="n">的函数</span>
<span class="err">``</span><span class="o">&lt;</span><span class="n">match1</span><span class="o">&gt;*&lt;</span><span class="n">match2</span><span class="o">&gt;</span><span class="err">``：</span><span class="n">匹配</span><span class="o">&lt;</span><span class="n">match1</span><span class="o">&gt;</span><span class="n">开头并以</span><span class="o">&lt;</span><span class="n">match2</span><span class="o">&gt;</span><span class="n">结尾的函数</span>
</code></pre></div>
<p>设置set_ftrace_filter接口支持过滤命令，格式为\:\:\</p>
<div class="codehilite"><pre><span></span><code><span class="o">-</span><span class="n">mod</span><span class="o">:</span><span class="w"> </span><span class="n">启用每个模块的功能过滤</span><span class="p">,</span><span class="n">如只需要ext3模块中的write</span><span class="o">*</span><span class="n">功能</span>
<span class="w">      </span><span class="n">echo</span><span class="w"> </span><span class="err">\'</span><span class="n">write</span><span class="o">*:</span><span class="n">mod</span><span class="o">:</span><span class="n">ext3</span><span class="err">\'</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">set_ftrace_filter</span>
<span class="o">-</span><span class="n">traceon</span><span class="o">/</span><span class="n">traceoff</span><span class="o">:</span><span class="w"> </span><span class="n">指定函数打开和关闭时跟踪</span><span class="err">，</span><span class="n">参数确定跟踪系统打开和关闭的次数</span><span class="err">，</span><span class="n">如果为指定</span><span class="err">，</span><span class="n">则没有限制</span><span class="err">，</span><span class="n">例如在前5此遇到错误时禁止跟踪</span>
<span class="w">      </span><span class="n">echo</span><span class="w"> </span><span class="err">\'</span><span class="n">__schedule_bug</span><span class="o">:</span><span class="n">traceoff</span><span class="o">:</span><span class="mi">5</span><span class="err">\'</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">set_ftrace_filter</span>
</code></pre></div>
<h3 id="dynamic-ftrace-with-function-graph-tracer">dynamic ftrace with function graph tracer</h3>
<p>上面解释了function tracer和function graph tracer，但有些特殊功能只在function graph tracer中可用。如果跟踪一个函数及其子函数，只需要函数将其名称写到set_graph_function中。</p>
<div class="codehilite"><pre><span></span><code><span class="n">echo</span><span class="w"> </span><span class="n">function_graph</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">current_tracer</span>
<span class="n">echo</span><span class="w"> </span><span class="n">__do_fault</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">set_graph_function</span>
<span class="n">echo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tracing_on</span>
<span class="p">...</span>
<span class="n">echo</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tracing_on</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_958013c75a14a224243a149ba98973ef.jpg"><img alt="" src="assets/doc/01-linux/性能工具/tracer的使用/images/wp_editor_md_958013c75a14a224243a149ba98973ef.jpg"/></a></p>
<h3 id="other">other</h3>
<p>ftrace有一个总开关，/proc/sys/kernel/ftrace_enabled，向其写0或1表示关闭和使能，默认是开启的状态。更多细节参考：Documentation/trace/ftrace.rst。</p>
<h2 id="events">events使用</h2>
<h3 id="sched_switch">sched_switch</h3>
<p>sched_switch是静态Tracepoint事件追踪，下面是示例</p>
<div class="codehilite"><pre><span></span><code><span class="n">echo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="c1">//kernel/debug/tracing/events/sched/sched_switch/enable</span>
<span class="cp"># 使能sched_switch</span>

<span class="n">echo</span><span class="w"> </span><span class="err">'</span><span class="n">prev_pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1162</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">next_pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1244</span><span class="err">'</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">events</span><span class="o">/</span><span class="n">sched</span><span class="o">/</span><span class="n">sched_switch</span><span class="o">/</span><span class="n">filter</span>
<span class="cp">#设置sched_switch 事件的过滤条件，使得只有当进程ID为1162的进程</span>
<span class="cp">#切换为进程ID为1244的进程时，才会记录这个事件，否则打印太多了</span>

<span class="n">echo</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">trace</span>
<span class="cp"># 清除trace buffer</span>

<span class="n">echo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">tracing_on</span>
<span class="cp"># 开始tracing</span>

<span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">trace</span>
<span class="cp"># 查看结果</span>

<span class="n">运行结果如下</span><span class="err">：</span>

<span class="cp"># tracer: nop</span>
<span class="cp">#</span>
<span class="cp"># nop latency trace v1.1.5 on 5.15.147</span>
<span class="cp"># --------------------------------------------------------------------</span>
<span class="cp"># latency: 0 us, #15/15, CPU#1 | (M:preempt VP:0, KP:0, SP:0 HP:0 #P:4)</span>
<span class="cp">#    -----------------</span>
<span class="cp">#    | task: -0 (uid:0 nice:0 policy:0 rt_prio:0)</span>
<span class="cp">#    -----------------</span>
<span class="cp">#</span>
<span class="cp">#                    _------=&gt; CPU#            </span>
<span class="cp">#                   / _-----=&gt; irqs-off        </span>
<span class="cp">#                  | / _----=&gt; need-resched    </span>
<span class="cp">#                  || / _---=&gt; hardirq/softirq </span>
<span class="cp">#                  ||| / _--=&gt; preempt-depth   </span>
<span class="cp">#                  |||| / _-=&gt; migrate-disable </span>
<span class="cp">#                  ||||| /     delay           </span>
<span class="cp">#  cmd     pid     |||||| time  |   caller     </span>
<span class="cp">#     \   /        ||||||  \    |    /       </span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">         </span><span class="mi">0</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">95713u</span><span class="n">s$</span><span class="o">:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">swapper</span><span class="o">/</span><span class="mi">0</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">R</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">wpa_supplicant</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">1244</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">120</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">         </span><span class="mi">0</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">10104901u</span><span class="n">s$</span><span class="o">:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">swapper</span><span class="o">/</span><span class="mi">0</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">R</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">wpa_supplicant</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">1244</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">120</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">         </span><span class="mi">0</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">20114087u</span><span class="n">s$</span><span class="o">:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">swapper</span><span class="o">/</span><span class="mi">0</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">R</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">wpa_supplicant</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">1244</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">120</span>
<span class="n">wifi_dae</span><span class="mi">-1162</span><span class="w">      </span><span class="mi">2</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">25998599u</span><span class="n">s</span><span class="o">!:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">wifi_daemon</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">1162</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">R</span><span class="o">+</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">sugov</span><span class="o">:</span><span class="mi">0</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">88</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">-1</span>
<span class="n">wifi_dae</span><span class="mi">-1162</span><span class="w">      </span><span class="mi">2</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">25999269u</span><span class="n">s</span><span class="o">!:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">wifi_daemon</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">1162</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">R</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">sugov</span><span class="o">:</span><span class="mi">0</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">88</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">-1</span>
<span class="n">wifi_dae</span><span class="mi">-1162</span><span class="w">      </span><span class="mi">2</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">25999412u</span><span class="n">s</span><span class="o">!:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">wifi_daemon</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">1162</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">R</span><span class="o">+</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">sugov</span><span class="o">:</span><span class="mi">0</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">88</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">-1</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">         </span><span class="mi">0</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">25999584u</span><span class="n">s</span><span class="o">!:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">swapper</span><span class="o">/</span><span class="mi">0</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">R</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">wpa_supplicant</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">1244</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">120</span>
<span class="n">wifi_dae</span><span class="mi">-1162</span><span class="w">      </span><span class="mi">3</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">26000075u</span><span class="n">s</span><span class="o">*:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">wifi_daemon</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">1162</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">S</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">swapper</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">120</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">         </span><span class="mi">0</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">26012127u</span><span class="n">s</span><span class="o">!:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">swapper</span><span class="o">/</span><span class="mi">0</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">R</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">wpa_supplicant</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">1244</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">120</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">         </span><span class="mi">0</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">26012552u</span><span class="n">s</span><span class="o">!:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">swapper</span><span class="o">/</span><span class="mi">0</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">R</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">wpa_supplicant</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">1244</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">120</span>
<span class="w"> </span><span class="n">logread</span><span class="mi">-495</span><span class="w">       </span><span class="mi">0</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">26013054u</span><span class="n">s$</span><span class="o">:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">logread</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">495</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">S</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">wpa_supplicant</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">1244</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">120</span>
<span class="n">rcu_pree</span><span class="mi">-14</span><span class="w">        </span><span class="mi">3</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">27564266u</span><span class="n">s</span><span class="err">#</span><span class="o">:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">rcu_preempt</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">14</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">I</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">wpa_supplicant</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">1244</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">120</span>
<span class="w">   </span><span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span><span class="mi">-1163</span><span class="w">      </span><span class="mi">3</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">27567664u</span><span class="n">s</span><span class="o">!:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">wifi_daemon</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">1163</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">S</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">wpa_supplicant</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">1244</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">120</span>
<span class="w">   </span><span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span><span class="mi">-1163</span><span class="w">      </span><span class="mi">3</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">27568473u</span><span class="n">s$</span><span class="o">:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">wifi_daemon</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">1163</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">S</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">wpa_supplicant</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">1244</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">120</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">         </span><span class="mi">3</span><span class="n">d</span><span class="p">.</span><span class="mf">.2</span><span class="p">.</span><span class="w"> </span><span class="mi">30116102u</span><span class="n">s</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">sched_switch</span><span class="o">:</span><span class="w"> </span><span class="n">prev_comm</span><span class="o">=</span><span class="n">swapper</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="n">prev_pid</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">prev_prio</span><span class="o">=</span><span class="mi">120</span><span class="w"> </span><span class="n">prev_state</span><span class="o">=</span><span class="n">R</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">next_comm</span><span class="o">=</span><span class="n">wpa_supplicant</span><span class="w"> </span><span class="n">next_pid</span><span class="o">=</span><span class="mi">1244</span><span class="w"> </span><span class="n">next_prio</span><span class="o">=</span><span class="mi">120</span>

<span class="n">从上面的打印结果可以看到</span><span class="err">，</span><span class="n">只会打印下一个调度进程为next_pid</span><span class="o">=</span><span class="mi">1244</span><span class="n">或者上一个调度进程为prev_pid</span><span class="o">=</span><span class="mi">1162</span><span class="n">的两个进程</span><span class="err">。</span>
</code></pre></div>
<h3 id="irq">irq</h3>
<div class="codehilite"><pre><span></span><code><span class="n">echo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">events</span><span class="o">/</span><span class="n">irq</span><span class="o">/</span><span class="n">irq_handler_entry</span><span class="o">/</span><span class="n">enable</span>
<span class="n">echo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">events</span><span class="o">/</span><span class="n">irq</span><span class="o">/</span><span class="n">irq_handler_exit</span><span class="o">/</span><span class="n">enable</span>
<span class="cp"># 使能最终中断的进入和退出追踪。</span>

<span class="n">echo</span><span class="w"> </span><span class="s">"irq == 62"</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">events</span><span class="o">/</span><span class="n">irq</span><span class="o">/</span><span class="n">irq_handler_exit</span><span class="o">/</span><span class="n">filter</span>
<span class="n">echo</span><span class="w"> </span><span class="s">"irq == 62"</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">events</span><span class="o">/</span><span class="n">irq</span><span class="o">/</span><span class="n">irq_handler_entry</span><span class="o">/</span><span class="n">filter</span>
<span class="cp">#设置irq的过滤，要过滤的中断号可以通过cat /proc/interrupts获取。</span>

<span class="n">echo</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">trace</span>
<span class="cp"># 清除trace buffer</span>

<span class="n">echo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">tracing_on</span>
<span class="cp"># 开始tracing</span>

<span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">trace</span>
<span class="cp"># 查看结果</span>

<span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">trace</span>
<span class="cp"># tracer: nop</span>
<span class="cp">#</span>
<span class="cp"># entries-in-buffer/entries-written: 354/354   #P:4</span>
<span class="cp">#</span>
<span class="cp">#                                _-----=&gt; irqs-off</span>
<span class="cp">#                               / _----=&gt; need-resched</span>
<span class="cp">#                              | / _---=&gt; hardirq/softirq</span>
<span class="cp">#                              || / _--=&gt; preempt-depth</span>
<span class="cp">#                              ||| / _-=&gt; migrate-disable</span>
<span class="cp">#                              |||| /     delay</span>
<span class="cp">#           TASK-PID     CPU#  |||||  TIMESTAMP  FUNCTION</span>
<span class="cp">#              | |         |   |||||     |         |</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h</span><span class="p">..</span><span class="w">  </span><span class="mf">1306.666839</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h</span><span class="p">..</span><span class="w">  </span><span class="mf">1306.666847</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h</span><span class="p">..</span><span class="w">  </span><span class="mf">1306.667226</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h</span><span class="p">..</span><span class="w">  </span><span class="mf">1306.667229</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.673856</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.673864</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.722395</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.722414</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">dNh1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.722680</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">dNh1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.722688</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.722773</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.722778</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.730310</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.730313</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.734280</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.734292</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.734520</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.734526</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.734717</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.734722</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">dNh1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.757440</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">dNh1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.757453</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.757530</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.757536</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.792327</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.792340</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">dNh1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.792629</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">dNh1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.792636</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h</span><span class="p">..</span><span class="w">  </span><span class="mf">1306.792811</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h</span><span class="p">..</span><span class="w">  </span><span class="mf">1306.792817</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.821387</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;</span><span class="mi">-0</span><span class="w">       </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h1</span><span class="p">.</span><span class="w"> </span><span class="mf">1306.821407</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h</span><span class="p">..</span><span class="w">  </span><span class="mf">1306.821615</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_entry</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">rwnx_hostwake_irq</span>
<span class="w">         </span><span class="nl">sugov</span><span class="p">:</span><span class="mi">0-86</span><span class="w">      </span><span class="p">[</span><span class="mo">000</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">h</span><span class="p">..</span><span class="w">  </span><span class="mf">1306.821620</span><span class="o">:</span><span class="w"> </span><span class="n">irq_handler_exit</span><span class="o">:</span><span class="w"> </span><span class="n">irq</span><span class="o">=</span><span class="mi">62</span><span class="w"> </span><span class="n">ret</span><span class="o">=</span><span class="n">handled</span>
</code></pre></div>
<p>irqsoff和events/irq有什么区别？ irqsoff是统计中断关闭时间，而events/irq是主要用于记录中断处理的活动，包括进入中断、退出中断等等。</p>
<h3 id="_1">小结</h3>
<div class="codehilite"><pre><span></span><code><span class="cp"># 启动sched_switch追踪可以有一下3种方式。</span>
<span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="n">sched</span><span class="o">:</span><span class="n">sched_switch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">set_event</span>
<span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="n">sched_switch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">set_event</span>
<span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">events</span><span class="o">/</span><span class="n">sched</span><span class="o">/</span><span class="n">sched_switch</span><span class="o">/</span><span class="n">enable</span>

<span class="cp"># 可以通过cat set_event来查看追踪的event</span>

<span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">set_event</span>

<span class="cp"># 也可以通过设置set_event_pid来过滤进程</span>
<span class="n">echo</span><span class="w"> </span><span class="mi">1244</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">set_event_pid</span>

<span class="cp"># 可以cat trace_pipe来实时观察追踪信息</span>
<span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">trace_pipe</span>

<span class="cp">#如果要清空设置的过滤,写0,</span>
<span class="n">echo</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">events</span><span class="o">/</span><span class="n">irq</span><span class="o">/</span><span class="n">irq_handler_exit</span><span class="o">/</span><span class="n">filter</span>
</code></pre></div>
<p>总结：</p>
<ul>
<li>tracer有function/graph等追踪器，没有设置过滤的话就是全局的。而event是在特定函数出入口统计跟踪，一般系统有内置的模块比如irq，sched_switch等。</li>
<li>tracing_on是总开关，通过使能1或0来开关。</li>
<li>trace是ftrace跟踪系统的主输出文件，用于记录所有的跟踪事件，但是会保留历史记录信息，不需要的话需要echo "" &gt; trace 清空。trace_pipe是一个实时跟踪输出文件，而不会保存历史数据，它提供了实时的数据流。</li>
<li>event和tracer可以同时使用。</li>
</ul></div>
  <div class="post-nav">
    <a class="prev" href="ftrace-概述.html">← ftrace-概述</a>
    <a class="next" href="使能mmu.html">使能MMU →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

