<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>archåˆå§‹åŒ– - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>archåˆå§‹åŒ–</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-07-07
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      risc-v
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><div class="codehilite"><pre><span></span><code><span class="nl">_start_kernel</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/* Mask all interrupts */</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">CSR_SIE</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">CSR_SIP</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="n">â‘ </span><span class="w"> </span><span class="n">å°†sie</span><span class="err">ï¼Œ</span><span class="n">sipå¯„å­˜å™¨è®¾ç½®ä¸º0</span><span class="err">ï¼Œ</span><span class="n">å…³é—­æ‰€æœ‰ä¸­æ–­å’Œæ¸…é™¤ä¸­æ–­çš„pending</span><span class="err">ï¼ˆ</span><span class="n">ä¸æ˜¯å¼‚å¸¸</span><span class="err">ï¼‰ã€‚</span>
<span class="w">    </span><span class="cm">/* Load the global pointer */</span>
<span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">push</span>
<span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">norelax</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">gp</span><span class="p">,</span><span class="w"> </span><span class="n">__global_pointer$</span>
<span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">pop</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Disable FPU to detect illegal usage of</span>
<span class="cm">     * floating point in kernel space</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">SR_FS</span>
<span class="w">    </span><span class="n">csrc</span><span class="w"> </span><span class="n">CSR_SSTATUS</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>
<span class="n">â‘¡å…³é—­æ‰æµ®ç‚¹</span><span class="err">ï¼Œ</span><span class="n">æµ®ç‚¹è‡³å°‘åœ¨å†…æ ¸ç©ºé—´æ‰ä¼šä½¿ç”¨</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">CONFIG_NR_CPUS</span>
<span class="n">bgeu</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">Lsecondary_park</span>
<span class="w">    </span><span class="n">â‘¢å¦‚æœä½¿èƒ½äº†SMP</span><span class="err">ï¼Œ</span><span class="n">ç¡¬ä»¶çš„å®é™…hartæ•°é‡è¶…è¿‡é…ç½®çš„æ•°é‡éƒ¨åˆ†ç›´æ¥è¿›å…¥</span>
<span class="w">    </span><span class="n">ç¬¬äºŒé˜¶æ®µ</span><span class="err">ï¼Œ</span><span class="n">ç›´æ¥è¿›å…¥WFIæ¨¡å¼</span><span class="err">ã€‚</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="cm">/* Pick one hart to run the main boot sequence */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">hart_lottery</span><span class="w"> </span><span class="c1">//hart_lotteryæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œåˆšå¼€å§‹ä¸º0</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">amoadd</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a3</span><span class="p">)</span><span class="c1">//å°†a3åœ°å€çš„å€¼èµ‹å€¼ä¸ºa3,å°†a2çš„å€¼åŠ åˆ°a3åœ°å€å¤„</span>
<span class="w">    </span><span class="n">bnez</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">Lsecondary_start</span><span class="w"> </span><span class="c1">//åˆ¤æ–­a3çš„å€¼æ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸ä¸º0ï¼Œè·³è½¬</span>
<span class="w">    </span><span class="n">â‘£å½©ç¥¨æœºåˆ¶</span><span class="err">ï¼Œ</span><span class="n">æŒ‘é€‰ä¸€ä¸ªhartä½œä¸ºä¸»hartè¿è¡Œ</span><span class="err">ï¼Œ</span><span class="n">å…¶ä»–hartè·³è½¬åˆ°</span><span class="p">.</span><span class="n">Lsecondary_start</span>
<span class="w">  </span><span class="n">å½©ç¥¨æœºåˆ¶æ˜¯æœ€å…ˆè¿è¡Œåˆ°è¯¥ä»£ç çš„hartå¯¹å…¨å±€å˜é‡hart_lottery</span><span class="o">+</span><span class="mi">1</span><span class="err">ï¼Œ</span><span class="n">åç»­hartè¿è¡Œæ—¶</span>
<span class="w">  </span><span class="n">æ£€æµ‹åˆ°å…¨å±€å˜é‡hart_lotteryä¸ä¸º0æ—¶éƒ½éœ€è¦è·³è½¬</span><span class="err">ã€‚</span>

<span class="w">    </span><span class="cm">/* Clear BSS for flat non-ELF images */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">__bss_start</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">__bss_stop</span>
<span class="w">    </span><span class="n">ble</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">clear_bss_done</span>
<span class="nl">clear_bss</span><span class="p">:</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a3</span><span class="p">)</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">RISCV_SZPTR</span>
<span class="w">    </span><span class="n">blt</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">clear_bss</span>
<span class="nl">clear_bss_done</span><span class="p">:</span>
<span class="n">â‘¤</span><span class="w"> </span><span class="n">å‘BSSæ®µå†™0</span>

<span class="w">    </span><span class="cm">/* Save hart ID and DTB physical address */</span>
<span class="w">    </span><span class="n">mv</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="c1">//hart ID</span>
<span class="w">    </span><span class="n">mv</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="c1">//DTB phy address</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">boot_cpu_hartid</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
<span class="w">    </span><span class="n">â‘¥</span><span class="w"> </span><span class="n">å°†hart</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="n">ä¿å­˜åˆ°å˜é‡boot_cpu_hartid</span>

<span class="w">    </span><span class="cm">/* Initialize page tables and relocate to virtual addresses */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">init_thread_union</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">THREAD_SIZE</span><span class="w"> </span><span class="c1">//åˆå§‹åŒ–ä¸€ä¸ªä¸´æ—¶æ ˆç©ºé—´ï¼Œæ¥ä¸‹æ¥ä¼šè°ƒç”¨cå‡½æ•°</span>
<span class="w">    </span><span class="n">mv</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">setup_vm</span><span class="w">  </span><span class="c1">//è°ƒç”¨setup_vmï¼Œä¼ é€’å‚æ•°ä¸ºDTBçš„ç‰©ç†åœ°å€</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">early_pg_dir</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">relocate</span><span class="w">   </span><span class="c1">//è°ƒç”¨relocateï¼Œä¼ é€’å‚æ•°ä¸ºearly_pg_dir</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="ftraceçš„ä½¿ç”¨.html">â† ftraceçš„ä½¿ç”¨</a>
    <a class="next" href="ä¸´æ—¶è™šæ‹Ÿåœ°å€ç©ºé—´æ˜ å°„.html">ä¸´æ—¶è™šæ‹Ÿåœ°å€ç©ºé—´æ˜ å°„ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

