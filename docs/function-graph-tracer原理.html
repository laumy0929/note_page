<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>function graph traceråŸç† - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">æ¦‚è¿°</a><ul></ul></li><li><a href="#_2">æ³¨å†Œ</a><ul></ul></li><li><a href="#_3">è·Ÿè¸ªå…¥å£å‡½æ•°</a><ul></ul></li><li><a href="#_4">è·Ÿè¸ªå‡ºå£å‡½æ•°</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>function graph traceråŸç†</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-08-31
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">æ¦‚è¿°</h2>
<p>Function graphç›¸å¯¹function traceçš„ä¸åŒç‚¹æ˜¯ï¼Œåœ¨å‡½æ•°å…¥å£ä¼štraceï¼Œåœ¨å‡½æ•°å‡ºå£ä¹Ÿä¼štraceã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">ksys_read</span>
<span class="o">-&gt;</span><span class="n">vfs_read</span>
<span class="o">-&gt;</span><span class="n">ftrace_caller</span>
<span class="o">-&gt;</span><span class="n">prepare_ftrace_return</span>
<span class="o">-&gt;</span><span class="n">function_graph_enter</span>
<span class="o">-&gt;</span><span class="n">ftrace_push_return_trace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="n">frame_pointer</span><span class="p">)</span>
<span class="o">-&gt;</span><span class="n">trace_graph_entry</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">funcgraph_ops</span><span class="p">.</span><span class="n">entryfunc</span>
<span class="o">-&gt;</span><span class="n">__trace_graph_entry</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">trace_buffer_unlock_commit_nostack</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">)</span>

<span class="w">   </span><span class="n">Xxxxxxx</span><span class="w"> </span><span class="n">å‡½æ•°ä½“å†…å®¹</span>

<span class="w">   </span><span class="o">-&gt;</span><span class="n">return_to_handler</span><span class="w"> </span><span class="o">----</span><span class="n">ä¿®æ”¹çš„vfs_readçš„raå¯„å­˜å™¨</span><span class="err">ï¼Œ</span><span class="n">è®©å…¶æ‰§è¡Œretè¿”å›æ˜¯è·³è½¬åˆ°è¿™ä¸ªå‡½æ•°</span><span class="err">ã€‚</span>
<span class="w">   </span><span class="o">-&gt;</span><span class="n">ftrace_return_to_handler</span>
<span class="w">     </span><span class="o">-&gt;</span><span class="n">ftrace_pop_return_trace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="n">frame_pointer</span><span class="p">)</span>
<span class="w">     </span><span class="o">-&gt;</span><span class="n">ftrace_graph_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trace</span><span class="p">)</span>
<span class="w">     </span><span class="o">-&gt;</span><span class="n">trace_graph_return</span><span class="w">   </span><span class="o">=</span><span class="n">funcgraph_ops</span><span class="p">.</span><span class="n">retfunc</span>
<span class="w">   </span><span class="o">-&gt;</span><span class="n">__trace_graph_return</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="w"> </span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="n">trace_ctx</span><span class="p">)</span>
<span class="w">     </span><span class="o">-&gt;</span><span class="n">trace_buffer_unlock_commit_nostack</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">);</span>
<span class="w">    </span><span class="n">ret</span>
</code></pre></div>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_d0687c3196452c2594f464e24b0c7aac.jpg\"><img alt='\"\"' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_d0687c3196452c2594f464e24b0c7aac.jpg\"/></a></p>
<h2 id="_2">æ³¨å†Œ</h2>
<p>ä¸å‰é¢ç« èŠ‚çš„function tracerä¸€æ ·ï¼Œå½“å‰æ‰§è¡Œecho function_graph &gt; current_traceræ—¶å°±ä¼šå¾…ç”¨åˆ°graph_trace_initå‡½æ•°ã€‚ ä¸function tracerä¸€æ ·ï¼Œå½“echo function_graph &gt; current_traceråï¼Œå‡½æ•°çš„å…¥å£nopæŒ‡ä»¤ä¼šè¢«æ›¿æ¢ä¸ºftracer_callerã€‚</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_334a09d7c5cc393a8d1c0fa1ffccc379.jpg\"><img alt='\"\"' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_334a09d7c5cc393a8d1c0fa1ffccc379.jpg\"/></a></p>
<p>å½“è¿˜æ²¡æœ‰å†™å…¥function_graphæ—¶ï¼Œftrace_callerçš„å®ç°å¦‚ä¸‹ï¼Œå…¶ä¸­ç¬¬ä¸€å¤„ftrace_stubæ˜¯ç”¨äºfunction traceræ›¿æ¢çš„ï¼Œè€Œç¬¬äºŒå¤„åˆ™æ˜¯ç»™function_graphæ›¿æ¢çš„ã€‚</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_2efaa3bb8b12387ae793ec97d0f852df.jpg\"><img alt='\"\"' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_2efaa3bb8b12387ae793ec97d0f852df.jpg\"/></a></p>
<p>å½“å†™å…¥function_graphåˆ°current_traceråï¼Œç¬¬äºŒå¤„çš„ftrace_stubè¢«æ›¿æ¢ä¸ºprepare_ftrace_returnï¼Œå¦‚ä¸‹ï¼š</p>
<p><a href="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_ed4a7dd1919870208bda77100528d263.jpg\"><img alt='\"\"' src="\" title="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_ed4a7dd1919870208bda77100528d263.jpg\"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fgraph_ops</span><span class="w"> </span><span class="n">funcgraph_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">entryfunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">trace_graph_entry</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">retfunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">trace_graph_return</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">graph_trace_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trace_array</span><span class="w"> </span><span class="o">*</span><span class="n">tr</span><span class="p">)</span>
<span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">register_ftrace_graph</span><span class="p">(</span><span class="o">&amp;</span><span class="n">funcgraph_ops</span><span class="p">);</span>
<span class="n">tracing_start_cmdline_record</span><span class="p">();</span>
<span class="n">tracing_start_sched_switch</span><span class="p">(</span><span class="n">RECORD_CMDLINE</span><span class="p">);</span><span class="w"> </span>
</code></pre></div>
<h2 id="_3">è·Ÿè¸ªå…¥å£å‡½æ•°</h2>
<p>ä¸‹é¢æˆ‘ä»¬æ¥å®é™…è·Ÿè¸ªä¸€ä¸‹ftrace_callerä¹‹åçš„å®ç°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">ENTRY</span><span class="p">(</span><span class="n">ftrace_caller</span><span class="p">)</span>
<span class="w">    </span><span class="n">SAVE_ABI</span>

<span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">FENTRY_RA_OFFSET</span>
<span class="w">    </span><span class="n">la</span><span class="w">  </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">function_trace_op</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">ra</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>

<span class="nl">ftrace_call</span><span class="p">:</span>
<span class="w">    </span><span class="p">.</span><span class="n">global</span><span class="w"> </span><span class="n">ftrace_call</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">ftrace_stub</span>
<span class="cp">#ifdef CONFIG_FUNCTION_GRAPH_TRACER</span>
<span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">ABI_RA</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">ABI_T0</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">FENTRY_RA_OFFSET</span>
<span class="cp">#ifdef HAVE_FUNCTION_GRAPH_FP_TEST</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span>
<span class="cp">#endif</span>
<span class="nl">ftrace_graph_call</span><span class="p">:</span>
<span class="w">    </span><span class="p">.</span><span class="n">global</span><span class="w"> </span><span class="n">ftrace_graph_call</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">ftrace_stub</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">RESTORE_ABI</span>
<span class="w">    </span><span class="n">jr</span><span class="w"> </span><span class="n">t0</span>
<span class="n">ENDPROC</span><span class="p">(</span><span class="n">ftrace_caller</span><span class="p">)</span>
</code></pre></div>
<p>ä¸Šé¢ä»£ç ç»è¿‡å®å±•å¼€åï¼Œå˜æˆä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬ä»è°ƒç”¨vfs_readçš„å‡½æ•°ksys_readå¼€å§‹åˆ†æã€‚ ksys_read-&gt;vfs_read</p>
<div class="codehilite"><pre><span></span><code><span class="p">...</span>
<span class="mh">0xffffffff80384e6e</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ksys_read</span><span class="o">+</span><span class="mi">122</span><span class="o">&gt;:</span><span class="w">  </span><span class="n">auipc</span><span class="w">   </span><span class="n">ra</span><span class="p">,</span><span class="mh">0xfffff</span>
<span class="mh">0xffffffff80384e72</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ksys_read</span><span class="o">+</span><span class="mi">126</span><span class="o">&gt;:</span><span class="w">  </span><span class="n">jalr</span><span class="w">    </span><span class="mi">594</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mh">0xffffffff803840c0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">vfs_read</span><span class="o">&gt;</span>
<span class="n">â‘ </span><span class="w"> </span><span class="n">ra</span><span class="o">=</span><span class="n">PC</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="n">å³0xffffffff80384e76</span><span class="w"> </span><span class="p">,</span><span class="n">PC</span><span class="o">=</span><span class="mh">0xffffffff803840c0</span><span class="err">ï¼Œ</span><span class="n">è¿™é‡Œä¿å­˜äº†è°ƒç”¨vfs_readçš„è¿”å›åœ°å€</span><span class="err">ã€‚</span>
<span class="mh">0xffffffff80384e76</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ksys_read</span><span class="o">+</span><span class="mi">130</span><span class="o">&gt;:</span><span class="w">  </span><span class="n">mv</span><span class="w">      </span><span class="n">s2</span><span class="p">,</span><span class="n">a0</span>
<span class="mh">0xffffffff80384e78</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ksys_read</span><span class="o">+</span><span class="mi">132</span><span class="o">&gt;:</span><span class="w">  </span><span class="n">bltz</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="mh">0xffffffff80384ef4</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ksys_read</span><span class="o">+</span><span class="mi">256</span><span class="o">&gt;</span>
</code></pre></div>
<p>vfs_read-&gt;ftrace_caller</p>
<div class="codehilite"><pre><span></span><code><span class="mh">0xffffffff803840c0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">vfs_read</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span><span class="w">     </span><span class="n">auipc</span><span class="w">   </span><span class="n">t0</span><span class="p">,</span><span class="mh">0xffc88</span>
<span class="mh">0xffffffff803840c4</span><span class="w"> </span><span class="o">&lt;</span><span class="n">vfs_read</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;:</span><span class="w">     </span><span class="n">jalr</span><span class="w">    </span><span class="n">t0</span><span class="p">,</span><span class="mi">1404</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mh">0xffffffff8000c63c</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ftrace_caller</span><span class="o">&gt;</span>
<span class="n">â‘¡</span><span class="w"> </span><span class="n">t0</span><span class="o">=</span><span class="n">PC</span><span class="o">+</span><span class="mi">4</span><span class="n">å³0xffffffff803840c8</span><span class="err">ï¼Œ</span><span class="n">PC</span><span class="o">=</span><span class="mh">0xffffffff8000c63c</span><span class="err">ï¼Œ</span><span class="n">è¿™é‡Œæ²¡æœ‰ä½¿ç”¨ra</span><span class="err">ï¼Œ</span><span class="n">è€Œæ˜¯ä½¿ç”¨äº†t0</span><span class="err">ï¼Œ</span><span class="n">å› æ­¤raå¾—ä»¥ä¼ é€’åˆ°ftrace_caller</span><span class="err">ã€‚</span>
<span class="mh">0xffffffff803840c8</span><span class="w"> </span><span class="o">&lt;</span><span class="n">vfs_read</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span><span class="w">     </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">-176</span>
<span class="mh">0xffffffff803840ca</span><span class="w"> </span><span class="o">&lt;</span><span class="n">vfs_read</span><span class="o">+</span><span class="mi">2</span><span class="o">&gt;:</span><span class="w">     </span><span class="n">sd</span><span class="w">      </span><span class="n">s0</span><span class="p">,</span><span class="mi">160</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
</code></pre></div>
<p>ftrace_caller-&gt;prepare_ftrace_return</p>
<div class="codehilite"><pre><span></span><code><span class="n">Dump</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">assembler</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">ftrace_caller</span><span class="o">:</span>
<span class="w">   </span><span class="mh">0xffffffff8000c63c</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;:</span><span class="w">     </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">-80</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xffffffff8000c63e</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">2</span><span class="o">&gt;:</span><span class="w">     </span><span class="n">sd</span><span class="w">      </span><span class="n">a0</span><span class="p">,</span><span class="mi">0</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c640</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;:</span><span class="w">     </span><span class="n">sd</span><span class="w">      </span><span class="n">a1</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c642</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">6</span><span class="o">&gt;:</span><span class="w">     </span><span class="n">sd</span><span class="w">      </span><span class="n">a2</span><span class="p">,</span><span class="mi">16</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c644</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">8</span><span class="o">&gt;:</span><span class="w">     </span><span class="n">sd</span><span class="w">      </span><span class="n">a3</span><span class="p">,</span><span class="mi">24</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c646</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">10</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">sd</span><span class="w">      </span><span class="n">a4</span><span class="p">,</span><span class="mi">32</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c648</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">12</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">sd</span><span class="w">      </span><span class="n">a5</span><span class="p">,</span><span class="mi">40</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c64a</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">14</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">sd</span><span class="w">      </span><span class="n">a6</span><span class="p">,</span><span class="mi">48</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c64c</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">16</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">sd</span><span class="w">      </span><span class="n">a7</span><span class="p">,</span><span class="mi">56</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c64e</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">18</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">sd</span><span class="w">      </span><span class="n">t0</span><span class="p">,</span><span class="mi">64</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="w">  </span><span class="n">å­˜å‚¨äº†ftrace_callerçš„è¿”å›åœ°å€</span><span class="err">ã€‚</span>
<span class="w">   </span><span class="mh">0xffffffff8000c650</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">20</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">sd</span><span class="w">      </span><span class="n">ra</span><span class="p">,</span><span class="mi">72</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="w">  </span><span class="n">å­˜å‚¨äº†vfs_readçš„è¿”å›åœ°å€</span><span class="err">ã€‚</span>
<span class="n">â‘¢å¼€è¾Ÿä¸€ä¸ªæ ˆç©ºé—´</span><span class="err">ï¼Œ</span><span class="n">å°†å¯„å­˜å™¨å…¥æ ˆ</span>
<span class="w">   </span><span class="mh">0xffffffff8000c652</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">22</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="mi">-8</span>
<span class="w">   </span><span class="mh">0xffffffff8000c656</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">26</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">auipc</span><span class="w">   </span><span class="n">a1</span><span class="p">,</span><span class="mh">0x251c</span>
<span class="w">   </span><span class="mh">0xffffffff8000c65a</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">30</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">a1</span><span class="p">,</span><span class="n">a1</span><span class="p">,</span><span class="mi">578</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mh">0xffffffff82528898</span><span class="w"> </span><span class="o">&lt;</span><span class="n">function_trace_op</span><span class="o">&gt;</span>
<span class="w">   </span><span class="mh">0xffffffff8000c65e</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">34</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">ld</span><span class="w">      </span><span class="n">a2</span><span class="p">,</span><span class="mi">0</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="n">â‘£è·å–å…¨å±€å˜é‡function_trace_op</span><span class="err">ï¼Œ</span><span class="n">è¿™æ˜¯struct</span><span class="w"> </span><span class="n">ftrace_opså®ä¾‹</span><span class="err">ï¼Œ</span><span class="n">function_trace_op</span><span class="p">.</span><span class="n">funcå­˜å‚¨äº†è·Ÿè¸ªå‡½æ•°</span><span class="err">ã€‚</span>
<span class="w">   </span><span class="mh">0xffffffff8000c660</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">36</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">mv</span><span class="w">      </span><span class="n">a1</span><span class="p">,</span><span class="n">ra</span>
<span class="w">   </span><span class="mh">0xffffffff8000c662</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">38</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">mv</span><span class="w">      </span><span class="n">a3</span><span class="p">,</span><span class="n">sp</span>
<span class="n">â‘¤a1å‚æ•°è®°å½•äº†vfs_readçš„è¿”å›åœ°å€</span><span class="err">ï¼Œ</span><span class="n">a3è®°å½•äº†æ ˆ</span>
<span class="w">   </span><span class="mh">0xffffffff8000c664</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">40</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">auipc</span><span class="w">   </span><span class="n">ra</span><span class="p">,</span><span class="mh">0x0</span>
<span class="w">   </span><span class="mh">0xffffffff8000c668</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">44</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">jalr</span><span class="w">    </span><span class="mi">-1604</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mh">0xffffffff8000c020</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ftrace_stub</span><span class="o">&gt;</span>
<span class="n">â‘¥å› ä¸ºä½¿èƒ½çš„æ˜¯function_graph</span><span class="err">ï¼Œ</span><span class="n">æ‰€ä»¥ftrace_stubæ²¡æœ‰è¢«æ›¿æ¢</span>
<span class="w">   </span><span class="mh">0xffffffff8000c66c</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">48</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">72</span>
<span class="n">â‘¦sp</span><span class="o">+</span><span class="mi">72</span><span class="n">å­˜å‚¨çš„æ˜¯vfs_readçš„ra</span><span class="err">ï¼Œ</span><span class="n">å› æ­¤a0çš„å€¼å³ä¸ºvfs_readå‡½æ•°raçš„åœ°å€</span><span class="err">ï¼Œ</span><span class="o">*</span><span class="n">a0å³è¿”å›åœ°å€</span><span class="err">ï¼Œ</span><span class="n">a0ä»£è¡¨çš„æ˜¯ç¬¬ä¸€ä¸ªå‡½æ•°å‚æ•°</span><span class="err">ï¼Œ</span><span class="n">å› æ­¤ç¬¬ä¸€ä¸ªå‡½æ•°å‚æ•°ä¸ºvfs_readçš„</span><span class="o">*</span><span class="n">parent</span><span class="err">ã€‚</span>
<span class="w">   </span><span class="mh">0xffffffff8000c66e</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">50</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">ld</span><span class="w">      </span><span class="n">a1</span><span class="p">,</span><span class="mi">64</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c670</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">52</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">a1</span><span class="p">,</span><span class="n">a1</span><span class="p">,</span><span class="mi">-8</span>
<span class="n">â‘§</span><span class="w"> </span><span class="n">sp</span><span class="o">+</span><span class="mi">64</span><span class="n">å­˜å‚¨çš„æ˜¯ftrace_callerçš„è¿”å›åœ°å€</span><span class="err">ï¼Œ</span><span class="n">ç”¨ftrace_callçš„è¿”å›åœ°å€</span><span class="mi">-8</span><span class="n">å°±ä¸ºvfs_readçš„å…¥å£åœ°å€</span><span class="err">ï¼Œ</span><span class="n">æ‰€ä»¥a1ä»£è¡¨çš„æ˜¯vfs_readçš„å…¥å£åœ°å€</span><span class="err">ã€‚</span>
<span class="w">   </span><span class="mh">0xffffffff8000c672</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">54</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">mv</span><span class="w">      </span><span class="n">a2</span><span class="p">,</span><span class="n">s0</span>
<span class="n">â‘¨</span><span class="w"> </span><span class="n">a2ä¸ºå½“å‰æ ˆå¸§</span>
<span class="w">   </span><span class="mh">0xffffffff8000c674</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">56</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">auipc</span><span class="w">   </span><span class="n">ra</span><span class="p">,</span><span class="mh">0x0</span>
<span class="w">   </span><span class="mh">0xffffffff8000c678</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">60</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">jalr</span><span class="w">    </span><span class="mi">-1338</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mh">0xffffffff8000c13a</span><span class="w"> </span><span class="o">&lt;</span><span class="n">prepare_ftrace_return</span><span class="o">&gt;</span>
<span class="n">â‘©</span><span class="w"> </span><span class="n">æ›´æ–°ra</span><span class="o">=</span><span class="mh">0xffffffff8000c67c</span><span class="err">ï¼Œ</span><span class="n">è·³è½¬åˆ°prepare_ftrace_return</span>
<span class="w">   </span><span class="mh">0xffffffff8000c67c</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">64</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">ld</span><span class="w">      </span><span class="n">a0</span><span class="p">,</span><span class="mi">0</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c67e</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">66</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">ld</span><span class="w">      </span><span class="n">a1</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c680</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">68</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">ld</span><span class="w">      </span><span class="n">a2</span><span class="p">,</span><span class="mi">16</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c682</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">70</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">ld</span><span class="w">      </span><span class="n">a3</span><span class="p">,</span><span class="mi">24</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c684</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">72</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">ld</span><span class="w">      </span><span class="n">a4</span><span class="p">,</span><span class="mi">32</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c686</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">74</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">ld</span><span class="w">      </span><span class="n">a5</span><span class="p">,</span><span class="mi">40</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c688</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">76</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">ld</span><span class="w">      </span><span class="n">a6</span><span class="p">,</span><span class="mi">48</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c68a</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">78</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">ld</span><span class="w">      </span><span class="n">a7</span><span class="p">,</span><span class="mi">56</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c68c</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">80</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">ld</span><span class="w">      </span><span class="n">t0</span><span class="p">,</span><span class="mi">64</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c68e</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">82</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">ld</span><span class="w">      </span><span class="n">ra</span><span class="p">,</span><span class="mi">72</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">   </span><span class="mh">0xffffffff8000c690</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">84</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">80</span>
<span class="w">   </span><span class="mh">0xffffffff8000c692</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">86</span><span class="o">&gt;:</span><span class="w">    </span><span class="n">jr</span><span class="w">      </span><span class="n">t0</span>
<span class="n">End</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">assembler</span><span class="w"> </span><span class="n">dump</span><span class="p">.</span>
</code></pre></div>
<p>ä»ä¸Šé¢å¯çŸ¥ï¼Œftrace_callerå‡½æ•°åï¼Œå°±è·³è½¬åˆ°prepare_ftrace_returnã€‚ æ¥ä¸‹æ¥çœ‹çœ‹prepare_ftrace_return</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">prepare_ftrace_return</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">self_addr</span><span class="p">,</span>
<span class="w">               </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">frame_pointer</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">return_hooker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">return_to_handler</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">old</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="err">Â¤</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tracing_graph_pause</span><span class="p">)))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * We don\'t suffer access faults, so no extra fault-recovery assembly</span>
<span class="cm">     * is needed here.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">function_graph_enter</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">self_addr</span><span class="p">,</span><span class="w"> </span><span class="n">frame_pointer</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">))</span>
<span class="w">        </span><span class="o">*</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">return_hooker</span><span class="p">;</span>
<span class="w">    </span><span class="n">è°ƒç”¨function_graph_enter</span><span class="err">ï¼Œ</span><span class="n">åŒæ—¶å°†vfs_readçš„è¿”å›åœ°å€ä¿®æ”¹ä¸ºreturn_to_handler</span><span class="err">ï¼Œ</span><span class="n">ä¹Ÿå°±æ˜¯è¯´å½“vfs_readå‡½æ•°æ‰§è¡Œè¿”å›æ—¶</span><span class="err">ï¼Œ</span><span class="n">ä¼šè·³è½¬åˆ°return_to_handlerè¿è¡Œ</span><span class="err">ï¼Œ</span><span class="n">è¿™æ ·å°±ç›¸å½“äºåœ¨vfs_readçš„å‡ºå£å‡½æ•°ä¹Ÿæ’æ¡©äº†</span><span class="err">ã€‚</span>
<span class="p">}</span>
</code></pre></div>
<p>function_graph_enter</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">function_graph_enter</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">func</span><span class="p">,</span>
<span class="w">             </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">frame_pointer</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">retp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_graph_ent</span><span class="w"> </span><span class="n">trace</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_HAVE_DYNAMIC_FTRACE_WITH_ARGS</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Skip graph tracing if the return location is served by direct trampoline,</span>
<span class="cm">     * since call sequence and return addresses are unpredictable anyway.</span>
<span class="cm">     * Ex: BPF trampoline may call original function and may skip frame</span>
<span class="cm">     * depending on type of BPF programs attached.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ftrace_direct_func_count</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">ftrace_find_rec_direct</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">MCOUNT_INSN_SIZE</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">trace</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func</span><span class="p">;</span>
<span class="w">    </span><span class="n">trace</span><span class="p">.</span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">++</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">curr_ret_depth</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ftrace_push_return_trace</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">frame_pointer</span><span class="p">,</span><span class="w"> </span><span class="n">retp</span><span class="p">))</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="n">â‘ </span><span class="w"> </span><span class="n">å°†è¦è·Ÿè¸ªå‡½æ•°vfs_readçš„è¿”å›åœ°å€</span><span class="err">ã€</span><span class="n">å‡½æ•°åç§°</span><span class="err">ã€</span><span class="n">è¿›å…¥æ—¶é—´å­˜å‚¨åˆ°å½“å‰ä»»åŠ¡çš„task_structä¸­</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="cm">/* Only trace if the calling function expects to */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ftrace_graph_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trace</span><span class="p">))</span><span class="w"> </span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out_ret</span><span class="p">;</span>
<span class="n">â‘¡struct</span><span class="w"> </span><span class="n">fgraph_ops</span><span class="w"> </span><span class="n">funcgraph_ops</span><span class="p">.</span><span class="n">entryfunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">trace_graph_entry</span><span class="err">ï¼Œ</span><span class="n">è°ƒç”¨trace_graph_entryå‡½æ•°</span><span class="err">ï¼Œ</span><span class="n">å°†traceä¿¡æ¯å†™å…¥ring</span><span class="w"> </span><span class="n">buffer</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w"> </span><span class="nl">out_ret</span><span class="p">:</span>
<span class="w">    </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">curr_ret_stack</span><span class="o">--</span><span class="p">;</span>
<span class="w"> </span><span class="nl">out</span><span class="p">:</span>
<span class="w">    </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">curr_ret_depth</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>ftrace_push_return_traceï¼Œå°†è¦è·Ÿè¸ªå‡½æ•°vfs_readçš„è¿”å›åœ°å€ã€å‡½æ•°åç§°ã€è¿›å…¥æ—¶é—´å­˜å‚¨åˆ°å½“å‰ä»»åŠ¡çš„task_structä¸­ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">ftrace_push_return_trace</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">func</span><span class="p">,</span>
<span class="w">             </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">frame_pointer</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">retp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">calltime</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ftrace_graph_is_dead</span><span class="p">()))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * We must make sure the ret_stack is tested before we read</span>
<span class="cm">     * anything else.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">smp_rmb</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* The return trace stack is full */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">curr_ret_stack</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FTRACE_RETFUNC_DEPTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">atomic_inc</span><span class="p">(</span><span class="err">Â¤</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">trace_overrun</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">calltime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trace_clock_local</span><span class="p">();</span>

<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">++</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">curr_ret_stack</span><span class="p">;</span>
<span class="w">    </span><span class="n">barrier</span><span class="p">();</span>
<span class="w">    </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func</span><span class="p">;</span>
<span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">calltime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calltime</span><span class="p">;</span>
<span class="c1">//å°†vfs_readçš„è¿”å›åœ°å€ã€vfs_readå‡½æ•°ã€è¿›å…¥vfs_readæ—¶é—´è®°å½•åˆ°å½“å‰ä»»åŠ¡çš„ret_stackï¼Œåç»­vfs_readé€€å‡ºæ—¶ä¼šä½¿ç”¨åˆ°ã€‚</span>
<span class="c1">//currentæ˜¯å½“å‰è¿è¡Œä»»åŠ¡çš„struct task_sturctï¼Œåœ¨è¯¥ç»“æ„ä¸­ï¼Œä¸ºfunction graphä¸“é—¨å®šä¹‰äº†ä¸€å—ç©ºé—´ç”¨äºå­˜å‚¨è®°å½•ä¸Šé¢çš„ä¿¡æ¯ã€‚</span>
<span class="cp">#ifdef HAVE_FUNCTION_GRAPH_FP_TEST</span>
<span class="w">    </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame_pointer</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef HAVE_FUNCTION_GRAPH_RET_ADDR_PTR</span>
<span class="w">    </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">retp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">retp</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_4">è·Ÿè¸ªå‡ºå£å‡½æ•°</h2>
<p>å½“è¢«è·Ÿè¸ªçš„å‡½æ•°è¦é€€å‡ºæ—¶ï¼Œç”±äºä¿®æ”¹äº†å…¶raå¯„å­˜å™¨ï¼Œå› æ­¤ä¼šè·³è½¬åˆ°return_to_handlerï¼Œæœ¬æ–‡çš„å®ä¾‹æ˜¯vfs_readï¼Œå› æ­¤å½“vfs_readå‡½æ•°æ‰§è¡Œå®Œæ—¶ï¼Œæœ¬åº”è¯¥æ‰§è¡Œretå°±é€€å‡ºï¼Œä½†æ˜¯åœ¨å‰é¢å°†raçš„å†…å®¹æ”¹äº†ï¼Œç»§è€Œè·³è½¬æ‰§è¡Œreturn_to_handlerã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#ifdef CONFIG_FUNCTION_GRAPH_TRACER</span>
<span class="n">ENTRY</span><span class="p">(</span><span class="n">return_to_handler</span><span class="p">)</span>
<span class="cm">/*</span>
<span class="cm"> * On implementing the frame point test, the ideal way is to compare the</span>
<span class="cm"> * s0 (frame pointer, if enabled) on entry and the sp (stack pointer) on return.</span>
<span class="cm"> * However, the psABI of variable-length-argument functions does not allow this.</span>
<span class="cm"> *</span>
<span class="cm"> * So alternatively we check the *old* frame pointer position, that is, the</span>
<span class="cm"> * value stored in -16(s0) on entry, and the s0 on return.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef HAVE_FUNCTION_GRAPH_FP_TEST</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">SAVE_RET_ABI_STATE</span>
<span class="cp">#ifdef HAVE_FUNCTION_GRAPH_FP_TEST</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">ftrace_return_to_handler</span>
<span class="w">    </span><span class="n">mv</span><span class="w">  </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span>
<span class="w">    </span><span class="n">RESTORE_RET_ABI_STATE</span>
<span class="w">    </span><span class="n">jalr</span><span class="w">    </span><span class="n">a2</span>
<span class="n">ENDPROC</span><span class="p">(</span><span class="n">return_to_handler</span><span class="p">)</span>
<span class="cp">#endif</span>
</code></pre></div>
<p>ftrace_return_to_handler</p>
<div class="codehilite"><pre><span></span><code><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">ftrace_return_to_handler</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">frame_pointer</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ftrace_graph_ret</span><span class="w"> </span><span class="n">trace</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="n">ftrace_pop_return_trace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="n">frame_pointer</span><span class="p">);</span>
<span class="n">â‘ ä¸å‰é¢çš„ftrace_push_return_traceå¯¹åº”</span><span class="err">ï¼Œ</span><span class="n">å°†traceç›¸å…³ä¿¡æ¯è·å–å‡ºæ¥</span><span class="err">ï¼Œ</span><span class="n">å¦‚vfs_readçš„è¿”å›åœ°å€ä¿¡æ¯</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">trace</span><span class="p">.</span><span class="n">rettime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trace_clock_local</span><span class="p">();</span>
<span class="n">ftrace_graph_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trace</span><span class="p">);</span>
<span class="n">â‘¡</span><span class="w"> </span><span class="n">è°ƒç”¨graph</span><span class="w"> </span><span class="n">é€€å‡ºå‡½æ•°</span><span class="err">ï¼Œ</span><span class="n">è°ƒç”¨trace_graph_return</span><span class="o">-&gt;</span><span class="n">__trace_graph_return</span><span class="err">ï¼Œ</span><span class="n">å°†ä¿¡æ¯æ›´æ–°å†™å…¥ring</span><span class="w"> </span><span class="n">buffer</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * The ftrace_graph_return() may still access the current</span>
<span class="cm">     * ret_stack structure, we need to make sure the update of</span>
<span class="cm">     * curr_ret_stack is after that.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">barrier</span><span class="p">();</span>
<span class="w">    </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">curr_ret_stack</span><span class="o">--</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ftrace_graph_stop</span><span class="p">();</span>
<span class="w">        </span><span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="cm">/* Might as well panic. What else to do? */</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">panic</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="å†…å­˜åœ°å€å¯¹é½.html">â† å†…å­˜åœ°å€å¯¹é½</a>
    <a class="next" href="cameraåŸºç¡€çŸ¥è¯†.html">CameraåŸºç¡€çŸ¥è¯† â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

