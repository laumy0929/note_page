<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>è¯­éŸ³è¯†åˆ«æ¨¡å‹ï¼šSenseVoiceå…¥é—¨å®è·µ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">æ˜¯ä»€ä¹ˆ</a><ul></ul></li><li><a href="#_2">æ€ä¹ˆç”¨</a><ul><li><a href="#_3">é…ç½®ç¯å¢ƒ</a></li><li><a href="#_4">ç¤ºä¾‹æµ‹è¯•</a></li><li><a href="#_5">æ¥å£è°ƒç”¨</a></li><li><a href="#_6">å®æ—¶è¯†åˆ«</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>è¯­éŸ³è¯†åˆ«æ¨¡å‹ï¼šSenseVoiceå…¥é—¨å®è·µ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2025-09-26
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      ai
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">æ˜¯ä»€ä¹ˆ</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_bc4b13c97d97e0966eaa5bb44f035f50_1759023608.png"><img alt="" src="assets/doc/04-ai/aiåº”ç”¨/è¯­éŸ³è¯†åˆ«æ¨¡å‹ï¼šsensevoiceå…¥é—¨å®è·µ/images/wp_editor_md_bc4b13c97d97e0966eaa5bb44f035f50_1759023608.png"/></a></p>
<p>SenseVoiceæ˜¯å¤šè¯­è¨€è¯†åˆ«çš„æ¨¡å‹ï¼Œæ”¯æŒè¯­éŸ³è½¬æ–‡å­—ï¼ˆASR, Automatic Speech Recognitionï¼Œè‡ªåŠ¨è¯­éŸ³è¯†åˆ«ï¼‰ï¼Œè¯­ç§è¯†åˆ«ï¼ˆLID, Language Identificationï¼‰ï¼Œè¯­éŸ³æƒ…æ„Ÿè¯†åˆ«ï¼ˆSER, Speech Emotion Recognitionï¼‰ï¼ŒéŸ³é¢‘äº‹ä»¶æ£€æµ‹ / å£°å­¦äº‹ä»¶åˆ†ç±»ï¼ˆAEDï¼AEC, Audio Event Detection / Classificationï¼‰ï¼Œé€†æ–‡æœ¬æ­£åˆ™åŒ– / æ ‡ç‚¹ / å¯Œæ–‡æœ¬è½¬å†™ç­‰ã€‚</p>
<h2 id="_2">æ€ä¹ˆç”¨</h2>
<h3 id="_3">é…ç½®ç¯å¢ƒ</h3>
<p>é…ç½®ä¸€ä¸ªconda sensevoiceç¯å¢ƒå¹¶ä¸”æ¿€æ´»ã€‚</p>
<div class="codehilite"><pre><span></span><code>conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>sensevoice<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.10
conda<span class="w"> </span>activate<span class="w"> </span>sensevoice
</code></pre></div>
<p>æ‹‰å–ä»£ç ï¼Œå®‰è£…ä¾èµ–</p>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/FunAudioLLM/SenseVoice.git
<span class="nb">cd</span><span class="w"> </span>SenseVoice/

pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
</code></pre></div>
<h3 id="_4">ç¤ºä¾‹æµ‹è¯•</h3>
<p>ä»£ç ä¸­æœ‰ä¸¤ä¸ªç¤ºä¾‹åˆ†åˆ«æ˜¯demo1.pyå’Œdemo2.pyï¼Œæ‰§è¡Œåå¯ä»¥çœ‹çœ‹æ•ˆæœã€‚</p>
<div class="codehilite"><pre><span></span><code>python<span class="w"> </span>demo1.py
</code></pre></div>
<p>æ‰§è¡Œåä¼šè‡ªåŠ¨ä»modelscopeä¸Šä¸‹è½½æ¨¡å‹å’Œç›¸å…³é…ç½®åˆ°æœ¬åœ°ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_9e2563393a5548519f9922906d06d6ac_1758848807.png"><img alt="" src="assets/doc/04-ai/aiåº”ç”¨/è¯­éŸ³è¯†åˆ«æ¨¡å‹ï¼šsensevoiceå…¥é—¨å®è·µ/images/wp_editor_md_9e2563393a5548519f9922906d06d6ac_1758848807.png"/></a></p>
<p>ä¸‹è½½åˆ°æœ¬åœ°åæœ‰æ¨¡å‹å’Œç›¸å…³çš„é…ç½®æ–‡ä»¶ä»¥åŠç¤ºä¾‹éŸ³é¢‘ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="o">(</span>sensevoice<span class="o">)</span><span class="w"> </span>laumy@ThinkBook-14-G7-IAH:~/.cache/modelscope/hub/models/iic$<span class="w"> </span>tree
.
â”œâ”€â”€<span class="w"> </span>SenseVoiceSmall
â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>am.mvn
â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>chn_jpn_yue_eng_ko_spectok.bpe.model
â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>configuration.json
â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>config.yaml
â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>example
â”‚<span class="w">Â Â  </span>â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>en.mp3
â”‚<span class="w">Â Â  </span>â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>ja.mp3
â”‚<span class="w">Â Â  </span>â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>ko.mp3
â”‚<span class="w">Â Â  </span>â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>yue.mp3
â”‚<span class="w">Â Â  </span>â”‚<span class="w">Â Â  </span>â””â”€â”€<span class="w"> </span>zh.mp3
â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>fig
â”‚<span class="w">Â Â  </span>â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>aed_figure.png
â”‚<span class="w">Â Â  </span>â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>asr_results.png
â”‚<span class="w">Â Â  </span>â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>inference.png
â”‚<span class="w">Â Â  </span>â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>sensevoice.png
â”‚<span class="w">Â Â  </span>â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>ser_figure.png
â”‚<span class="w">Â Â  </span>â”‚<span class="w">Â Â  </span>â””â”€â”€<span class="w"> </span>ser_table.png
â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>model.pt
â”‚<span class="w">Â Â  </span>â”œâ”€â”€<span class="w"> </span>README.md
â”‚<span class="w">Â Â  </span>â””â”€â”€<span class="w"> </span>tokens.json
â””â”€â”€<span class="w"> </span>speech_fsmn_vad_zh-cn-16k-common-pytorch
<span class="w">    </span>â”œâ”€â”€<span class="w"> </span>am.mvn
<span class="w">    </span>â”œâ”€â”€<span class="w"> </span>configuration.json
<span class="w">    </span>â”œâ”€â”€<span class="w"> </span>config.yaml
<span class="w">    </span>â”œâ”€â”€<span class="w"> </span>example
<span class="w">    </span>â”‚<span class="w">Â Â  </span>â””â”€â”€<span class="w"> </span>vad_example.wav
<span class="w">    </span>â”œâ”€â”€<span class="w"> </span>fig
<span class="w">    </span>â”‚<span class="w">Â Â  </span>â””â”€â”€<span class="w"> </span>struct.png
<span class="w">    </span>â”œâ”€â”€<span class="w"> </span>model.pt
<span class="w">    </span>â””â”€â”€<span class="w"> </span>README.md

<span class="m">7</span><span class="w"> </span>directories,<span class="w"> </span><span class="m">25</span><span class="w"> </span>files
</code></pre></div>
<p>æœ€åçš„è¯†åˆ«æ•ˆæœä¸º</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_6b096d7897e254c4d6173189950b4a8d_1758848997.png"><img alt="" src="assets/doc/04-ai/aiåº”ç”¨/è¯­éŸ³è¯†åˆ«æ¨¡å‹ï¼šsensevoiceå…¥é—¨å®è·µ/images/wp_editor_md_6b096d7897e254c4d6173189950b4a8d_1758848997.png"/></a></p>
<p>è¿˜å¯ä»¥æµ‹è¯•webuiç‰ˆæœ¬</p>
<div class="codehilite"><pre><span></span><code>python<span class="w"> </span>webui.py
</code></pre></div>
<p>ç„¶åç½‘å€è¾“å…¥ï¼šhttp://127.0.0.1:7860ï¼Œ æ³¨æ„ä¸èƒ½å¼€ä»£ç†å¦åˆ™ä¼šå¯åŠ¨å¤±è´¥ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_8bc5306b4eb941a9a8b3f6952195aa86_1758860710.png"><img alt="" src="assets/doc/04-ai/aiåº”ç”¨/è¯­éŸ³è¯†åˆ«æ¨¡å‹ï¼šsensevoiceå…¥é—¨å®è·µ/images/wp_editor_md_8bc5306b4eb941a9a8b3f6952195aa86_1758860710.png"/></a></p>
<h3 id="_5">æ¥å£è°ƒç”¨</h3>
<p>ä¸»è¦ç®€è¦åˆ†æä¸€ä¸‹ä½¿ç”¨funASRè°ƒç”¨ç¤ºä¾‹ã€‚</p>
<p><strong>ï¼ˆ1ï¼‰æ¨¡å‹åŠ è½½</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>AutoModel<span class="o">(</span><span class="nv">model</span><span class="o">=[</span>str<span class="o">]</span>,<span class="w"> </span><span class="nv">device</span><span class="o">=[</span>str<span class="o">]</span>,<span class="w"> </span><span class="nv">ncpu</span><span class="o">=[</span>int<span class="o">]</span>,<span class="w"> </span><span class="nv">output_dir</span><span class="o">=[</span>str<span class="o">]</span>,<span class="w"> </span><span class="nv">batch_size</span><span class="o">=[</span>int<span class="o">]</span>,<span class="w"> </span><span class="nv">hub</span><span class="o">=[</span>str<span class="o">]</span>,<span class="w"> </span>**kwargs<span class="o">)</span>
</code></pre></div>
<ul>
<li>modelï¼šæ¨¡å‹ä»“åº“ä¸­çš„åç§°</li>
<li>deviceï¼šæ¨ç†çš„è®¾å¤‡ï¼Œå¦‚gpu</li>
<li>ncpuï¼šcpuå¹¶è¡Œçº¿ç¨‹ã€‚</li>
<li>output_dirï¼šè¾“å‡ºç»“æœçš„è¾“å‡ºè·¯å¾„</li>
<li>batch_sizeï¼šè§£ç æ—¶çš„æ‰¹å¤„ç†ï¼Œæ ·æœ¬ä¸ªæ•°</li>
<li>hubï¼šä»modelscopeä¸‹è½½æ¨¡å‹ã€‚å¦‚æœä¸ºhfï¼Œä»huggingfaceä¸‹è½½æ¨¡å‹ã€‚</li>
</ul>
<p><strong>ï¼ˆ2ï¼‰æ¨ç†</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nv">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>model.generate<span class="o">(</span><span class="nv">input</span><span class="o">=[</span>str<span class="o">]</span>,<span class="w"> </span><span class="nv">output_dir</span><span class="o">=[</span>str<span class="o">])</span>
</code></pre></div>
<ul>
<li>inputï¼šè¦è§£ç çš„è¾“å…¥å¯ä»¥æ˜¯wavæ–‡ä»¶è·¯å¾„, ä¾‹å¦‚: asr_example.wavã€‚</li>
<li>output_dir: è¾“å‡ºç»“æœçš„è¾“å‡ºè·¯å¾„ã€‚</li>
</ul>
<h3 id="_6">å®æ—¶è¯†åˆ«</h3>
<p>ç¼–å†™ä¸€ä¸ªç¤ºä¾‹å®æ—¶è¯†åˆ«</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- encoding: utf-8 -*-</span>
<span class="c1"># Real-time microphone transcription (pure memory) using ALSA (pyalsaaudio) + numpy</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">_safe_imports</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">alsaaudio</span>  <span class="c1"># noqa: F401</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">"ç¼ºå°‘ pyalsaaudioï¼Œè¯·å…ˆå®‰è£…ï¼š</span><span class="se">\n</span><span class="s2">  pip install pyalsaaudio</span><span class="se">\n</span><span class="s2">Ubuntu å¯èƒ½éœ€è¦ï¼šsudo apt-get install -y python3-alsaaudio æˆ– alsa-utils"</span><span class="p">,</span>
            <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">raise</span>

<span class="k">def</span> <span class="nf">_safe_import_model</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">funasr</span> <span class="kn">import</span> <span class="n">AutoModel</span>
        <span class="kn">from</span> <span class="nn">funasr.utils.postprocess_utils</span> <span class="kn">import</span> <span class="n">rich_transcription_postprocess</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">"å¯¼å…¥ funasr å¤±è´¥ã€‚å¦‚æœä»“åº“æ ¹ç›®å½•å­˜åœ¨æœ¬åœ° 'funasr.py'ï¼Œè¯·é‡å‘½åï¼ˆå¦‚ 'funasr_demo.py'ï¼‰ä»¥é¿å…é®è”½å¤–éƒ¨åº“ã€‚"</span><span class="p">,</span>
            <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">return</span> <span class="n">AutoModel</span><span class="p">,</span> <span class="n">rich_transcription_postprocess</span>

<span class="k">def</span> <span class="nf">int16_to_float32</span><span class="p">(</span><span class="n">audio_int16</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">audio_int16</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">:</span>
        <span class="n">audio_int16</span> <span class="o">=</span> <span class="n">audio_int16</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">audio_int16</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">32768.0</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">resample_to_16k</span><span class="p">(</span><span class="n">audio_f32</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">orig_sr</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">orig_sr</span> <span class="o">==</span> <span class="mi">16000</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">audio_f32</span><span class="p">,</span> <span class="mi">16000</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SV_RESAMPLE"</span><span class="p">,</span> <span class="s2">"poly"</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="c1"># poly|librosa|linear</span>
    <span class="c1"># ä¼˜å…ˆä½¿ç”¨æ›´å¿«çš„ polyï¼ˆscipyï¼‰ï¼Œå…¶æ¬¡ librosaï¼Œæœ€åçº¿æ€§æ’å€¼å…œåº•</span>
    <span class="k">if</span> <span class="n">backend</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"poly"</span><span class="p">,</span> <span class="s2">"auto"</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">resample_poly</span>  <span class="c1"># type: ignore</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">resample_poly</span><span class="p">(</span><span class="n">audio_f32</span><span class="p">,</span> <span class="mi">16000</span><span class="p">,</span> <span class="n">orig_sr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">16000</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">backend</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"librosa"</span><span class="p">,</span> <span class="s2">"auto"</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">librosa</span>  <span class="c1"># type: ignore</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">audio_f32</span><span class="p">,</span> <span class="n">orig_sr</span><span class="o">=</span><span class="n">orig_sr</span><span class="p">,</span> <span class="n">target_sr</span><span class="o">=</span><span class="mi">16000</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">16000</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="c1"># çº¿æ€§æ’å€¼å…œåº•ï¼ˆæœ€æ…¢ä½†é›¶ä¾èµ–ï¼‰</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">audio_f32</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">new_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">audio_f32</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="mf">16000.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">orig_sr</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">new_n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">audio_f32</span><span class="p">,</span> <span class="n">orig_sr</span>
    <span class="n">new_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">new_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">audio_f32</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="mi">16000</span>

<span class="k">def</span> <span class="nf">_build_cfg_from_env</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># runtime knobs</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">"min_rms"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SV_MIN_RMS"</span><span class="p">,</span> <span class="s2">"0.003"</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">"min_rms"</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.003</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">"overlap_sec"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SV_OVERLAP_SEC"</span><span class="p">,</span> <span class="s2">"0.3"</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">"overlap_sec"</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">cfg</span><span class="p">[</span><span class="s2">"merge_vad"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SV_MERGE_VAD"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"1"</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">"merge_len"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SV_MERGE_LEN"</span><span class="p">,</span> <span class="s2">"2.0"</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">"merge_len"</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">cfg</span><span class="p">[</span><span class="s2">"debug"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SV_DEBUG"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"1"</span>
    <span class="n">cfg</span><span class="p">[</span><span class="s2">"resample_backend"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SV_RESAMPLE"</span><span class="p">,</span> <span class="s2">"poly"</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">cfg</span><span class="p">[</span><span class="s2">"dump_wav_path"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SV_DUMP_WAV"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cfg</span>

<span class="k">def</span> <span class="nf">_select_strong_channel</span><span class="p">(</span><span class="n">frame_any</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">frame_any</span>
    <span class="n">frame_mat</span> <span class="o">=</span> <span class="n">frame_any</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
    <span class="n">ch_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">frame_mat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ch_rms</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[debug] multi-channel rms=</span><span class="si">{</span><span class="n">ch_rms</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">, select ch=</span><span class="si">{</span><span class="n">sel</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frame_mat</span><span class="p">[:,</span> <span class="n">sel</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_ensure_pcm_open</span><span class="p">(</span><span class="n">alsa_audio</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">samplerate</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">period_frames</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="n">tried</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="p">[</span><span class="n">device</span> <span class="ow">or</span> <span class="s2">"default"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"plughw:</span><span class="si">{</span><span class="p">(</span><span class="n">device</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">'default'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">device</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'plughw'</span><span class="p">))</span> <span class="k">else</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dev</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">(</span><span class="n">alsa_audio</span><span class="o">.</span><span class="n">PCM_FORMAT_S16_LE</span><span class="p">,</span> <span class="n">alsa_audio</span><span class="o">.</span><span class="n">PCM_FORMAT_S32_LE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">alsa_audio</span><span class="o">.</span><span class="n">PCM</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">alsa_audio</span><span class="o">.</span><span class="n">PCM_CAPTURE</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">alsa_audio</span><span class="o">.</span><span class="n">PCM_NORMAL</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">dev</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">setchannels</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">setrate</span><span class="p">(</span><span class="n">samplerate</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">setformat</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">setperiodsize</span><span class="p">(</span><span class="n">period_frames</span><span class="p">)</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span> <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">alsa_audio</span><span class="o">.</span><span class="n">PCM_FORMAT_S16_LE</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>
                <span class="n">sample_bytes</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span> <span class="k">else</span> <span class="mi">4</span>
                <span class="n">fmt_name</span> <span class="o">=</span> <span class="s2">"S16_LE"</span> <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span> <span class="k">else</span> <span class="s2">"S32_LE"</span>
                <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">sample_bytes</span><span class="p">,</span> <span class="n">fmt_name</span><span class="p">,</span> <span class="n">dev</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># noqa: BLE001</span>
                <span class="n">tried</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dev</span><span class="p">,</span> <span class="s2">"S16_LE"</span> <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">alsa_audio</span><span class="o">.</span><span class="n">PCM_FORMAT_S16_LE</span> <span class="k">else</span> <span class="s2">"S32_LE"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="k">continue</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"æ‰“å¼€ ALSA è®¾å¤‡å¤±è´¥ï¼Œå°è¯•: </span><span class="si">{</span><span class="n">tried</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_int16_mono</span><span class="p">(</span><span class="n">raw_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">sample_bytes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sample_bytes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">frame_any</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw_bytes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frame_any</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw_bytes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">frame_any</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_any</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">frame_any</span> <span class="o">=</span> <span class="n">_select_strong_channel</span><span class="p">(</span><span class="n">frame_any</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frame_any</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_should_infer</span><span class="p">(</span><span class="n">audio_f32</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">min_rms</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">frames_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">audio_f32</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">rms</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">audio_f32</span><span class="p">))))</span>
    <span class="k">if</span> <span class="n">rms</span> <span class="o">&lt;</span> <span class="n">min_rms</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[debug] frames=</span><span class="si">{</span><span class="n">frames_count</span><span class="si">}</span><span class="s2">, rms=</span><span class="si">{</span><span class="n">rms</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> &lt; min_rms=</span><span class="si">{</span><span class="n">min_rms</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, skip"</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">_infer_block</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">running_cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">prefer</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SV_INPUT_FORMAT"</span><span class="p">,</span> <span class="s2">"f32"</span><span class="p">)</span>
    <span class="c1"># candidate arrays</span>
    <span class="n">f32</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">i16</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">f32</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">32767.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="n">candidates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">prefer</span> <span class="o">==</span> <span class="s2">"i16"</span><span class="p">:</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i16</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="n">f32</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="n">i16</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="n">f32</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="kc">True</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">prefer</span> <span class="o">==</span> <span class="s2">"f32_2d"</span><span class="p">:</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">f32</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="n">f32</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="n">i16</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="n">i16</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">prefer</span> <span class="o">==</span> <span class="s2">"i16_2d"</span><span class="p">:</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i16</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="n">i16</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="n">f32</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="n">f32</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">f32</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="n">i16</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="n">f32</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="n">i16</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="kc">True</span><span class="p">)]</span>

    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">cand</span><span class="p">,</span> <span class="n">_is2d</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                    <span class="nb">input</span><span class="o">=</span><span class="n">cand</span><span class="p">,</span>
                    <span class="n">input_fs</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
                    <span class="n">cache</span><span class="o">=</span><span class="n">running_cache</span><span class="p">,</span>
                    <span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span>
                    <span class="n">use_itn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">batch_size_s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">merge_vad</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s2">"merge_vad"</span><span class="p">],</span>
                    <span class="n">merge_length_s</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s2">"merge_len"</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                    <span class="nb">input</span><span class="o">=</span><span class="n">cand</span><span class="p">,</span>
                    <span class="n">fs</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
                    <span class="n">cache</span><span class="o">=</span><span class="n">running_cache</span><span class="p">,</span>
                    <span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span>
                    <span class="n">use_itn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">batch_size_s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">merge_vad</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s2">"merge_vad"</span><span class="p">],</span>
                    <span class="n">merge_length_s</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s2">"merge_len"</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">""</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"text"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">run_in_memory</span><span class="p">(</span>
    <span class="n">model_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">samplerate</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">block_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">alsa_device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">_safe_imports</span><span class="p">()</span>
    <span class="n">AutoModel</span><span class="p">,</span> <span class="n">rich_post</span> <span class="o">=</span> <span class="n">_safe_import_model</span><span class="p">()</span>

    <span class="c1"># å…³é—­åº•å±‚ tqdm è¿›åº¦æ¡ç­‰å¤šä½™è¾“å‡º</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">"TQDM_DISABLE"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"åŠ è½½æ¨¡å‹..."</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model_dir</span><span class="p">,</span>
        <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">remote_code</span><span class="o">=</span><span class="s2">"./model.py"</span><span class="p">,</span>
        <span class="n">vad_model</span><span class="o">=</span><span class="s2">"fsmn-vad"</span><span class="p">,</span>
        <span class="n">vad_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">"max_single_segment_time"</span><span class="p">:</span> <span class="mi">30000</span><span class="p">},</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">disable_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="kn">import</span> <span class="nn">alsaaudio</span>

    <span class="c1"># æ›´å°çš„ periodsizeï¼Œé™ä½ I/O é”™è¯¯æ¦‚ç‡ï¼›æ¨ç†èšåˆç”± block_seconds æ§åˆ¶</span>
    <span class="n">period_frames</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">samplerate</span><span class="p">))</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">_build_cfg_from_env</span><span class="p">()</span>

    <span class="c1"># æ‰“å¼€è®¾å¤‡ï¼Œå°è¯• S16 -&gt; S32ï¼›å¿…è¦æ—¶åˆ‡æ¢ plughw ä»¥å¯ç”¨è‡ªåŠ¨é‡é‡‡æ ·/é‡æ ¼å¼åŒ–</span>
    <span class="n">pcm</span><span class="p">,</span> <span class="n">sample_bytes</span><span class="p">,</span> <span class="n">fmt_name</span><span class="p">,</span> <span class="n">open_dev</span> <span class="o">=</span> <span class="n">_ensure_pcm_open</span><span class="p">(</span><span class="n">alsaaudio</span><span class="p">,</span> <span class="n">alsa_device</span><span class="p">,</span> <span class="n">samplerate</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">period_frames</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">"debug"</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[debug] opened ALSA device </span><span class="si">{</span><span class="n">open_dev</span><span class="si">}</span><span class="s2"> fmt=</span><span class="si">{</span><span class="n">fmt_name</span><span class="si">}</span><span class="s2"> period=</span><span class="si">{</span><span class="n">period_frames</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">"å¼€å§‹å½•éŸ³ï¼ˆçº¯å†…å­˜é‡‡é›†ï¼‰ï¼Œè®¾å¤‡=</span><span class="si">{</span><span class="n">alsa_device</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">'default'</span><span class="si">}</span><span class="s2">, sr=</span><span class="si">{</span><span class="n">samplerate</span><span class="si">}</span><span class="s2">, ch=</span><span class="si">{</span><span class="n">channels</span><span class="si">}</span><span class="s2">, period=</span><span class="si">{</span><span class="n">period_frames</span><span class="si">}</span><span class="s2">ï¼ŒæŒ‰ Ctrl+C åœæ­¢ã€‚</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span>
        <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">running_cache</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">printed_text</span> <span class="o">=</span> <span class="s2">""</span>

    <span class="c1"># èšåˆåˆ°è¿™ä¸€å¸§é˜ˆå€¼åæ‰è°ƒç”¨ä¸€æ¬¡æ¨¡å‹ï¼Œé™ä½è°ƒç”¨é¢‘ç‡ä¸è¾“å‡º</span>
    <span class="n">min_frames</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">block_seconds</span> <span class="o">*</span> <span class="n">samplerate</span><span class="p">))</span>
    <span class="c1"># é‡å å¸§æ•°ï¼Œå‡å°‘å¥é¦–/å¥å°¾ä¸¢å¤±</span>
    <span class="n">overlap_frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">"overlap_sec"</span><span class="p">])</span> <span class="o">*</span> <span class="n">samplerate</span><span class="p">)</span>
    <span class="n">block_buf</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">buf_frames</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">stop_flag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">handle_sigint</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>  <span class="c1"># noqa: ANN001</span>
        <span class="k">nonlocal</span> <span class="n">stop_flag</span>
        <span class="n">stop_flag</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">handle_sigint</span><span class="p">)</span>

    <span class="c1"># è¿ç»­è¯»å– PCMï¼Œå¹¶èšåˆè¾¾åˆ°é˜ˆå€¼åæ‰§è¡Œä¸€æ¬¡å¢é‡æ¨ç†</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">stop_flag</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">length</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># noqa: BLE001</span>
            <span class="c1"># è¯»å¤±è´¥æ—¶å°è¯•é‡å»ºï¼ˆå¸¸è§äºæŸäº› DMIC Rawï¼‰</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">"debug"</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[debug] pcm.read error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, reopen stream"</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># å°è¯•ä½¿ç”¨ plughw ä»¥è·å¾—è‡ªåŠ¨æ ¼å¼/é‡‡æ ·ç‡é€‚é…</span>
            <span class="n">dev</span> <span class="o">=</span> <span class="n">alsa_device</span> <span class="ow">or</span> <span class="s2">"default"</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dev</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"plughw"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dev</span> <span class="o">!=</span> <span class="s2">"default"</span><span class="p">:</span>
                <span class="n">dev</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"plughw:</span><span class="si">{</span><span class="n">dev</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">pcm</span><span class="p">,</span> <span class="n">sample_bytes</span><span class="p">,</span> <span class="n">fmt_name</span><span class="p">,</span> <span class="n">open_dev</span> <span class="o">=</span> <span class="n">_ensure_pcm_open</span><span class="p">(</span><span class="n">alsaaudio</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">samplerate</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">period_frames</span><span class="p">)</span>
            <span class="n">length</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.005</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># æ ¹æ®å®é™…æ ¼å¼è§£æ bytes</span>
        <span class="n">pcm_int16</span> <span class="o">=</span> <span class="n">_to_int16_mono</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sample_bytes</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">"debug"</span><span class="p">])</span>
        <span class="n">block_buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pcm_int16</span><span class="p">)</span>
        <span class="n">buf_frames</span> <span class="o">+=</span> <span class="n">pcm_int16</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">buf_frames</span> <span class="o">&lt;</span> <span class="n">min_frames</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># è¾¾åˆ°é˜ˆå€¼ï¼Œæ‹¼æ¥å¹¶è½¬æ¢ä¸º float32 [-1, 1]</span>
        <span class="n">joined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">block_buf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># ä¸ºä¸‹ä¸€ä¸ªå—ä¿ç•™å°¾éƒ¨é‡å </span>
        <span class="k">if</span> <span class="n">overlap_frames</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">joined</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">overlap_frames</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="n">joined</span><span class="p">[</span><span class="o">-</span><span class="n">overlap_frames</span><span class="p">:]</span>
            <span class="n">block_buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">tail</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
            <span class="n">buf_frames</span> <span class="o">=</span> <span class="n">tail</span><span class="o">.</span><span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">block_buf</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">buf_frames</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">audio_block_f32</span> <span class="o">=</span> <span class="n">int16_to_float32</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>
        <span class="c1"># è‹¥é‡‡æ ·ç‡ä¸æ˜¯ 16kï¼Œé‡é‡‡æ ·åˆ° 16k</span>
        <span class="n">audio_block_f32</span><span class="p">,</span> <span class="n">eff_sr</span> <span class="o">=</span> <span class="n">resample_to_16k</span><span class="p">(</span><span class="n">audio_block_f32</span><span class="p">,</span> <span class="n">samplerate</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_should_infer</span><span class="p">(</span><span class="n">audio_block_f32</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">"min_rms"</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">"debug"</span><span class="p">],</span> <span class="n">joined</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">"debug"</span><span class="p">]:</span>
            <span class="n">rms</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">audio_block_f32</span><span class="p">))))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[debug] frames=</span><span class="si">{</span><span class="n">joined</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">, eff_sr=</span><span class="si">{</span><span class="n">eff_sr</span><span class="si">}</span><span class="s2">, rms=</span><span class="si">{</span><span class="n">rms</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, infer"</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># å¯é€‰ï¼šè°ƒè¯•æ—¶å°†å½“å‰å—å†™åˆ°ä¸€ä¸ªè¦†ç›–çš„ä¸´æ—¶ WAVï¼ˆé‡é‡‡æ ·åï¼Œå•å£°é“16kï¼‰ï¼Œæ–¹ä¾¿ç”¨ aplay æ£€æŸ¥é‡‡éŸ³</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">"dump_wav_path"</span><span class="p">]:</span>
            <span class="kn">import</span> <span class="nn">wave</span><span class="o">,</span> <span class="nn">tempfile</span>
            <span class="n">dump_path</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">"dump_wav_path"</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">())</span> <span class="o">/</span> <span class="s2">"sv_debug_block.wav"</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">wave</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dump_path</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wf</span><span class="p">:</span>
                <span class="n">wf</span><span class="o">.</span><span class="n">setnchannels</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">wf</span><span class="o">.</span><span class="n">setsampwidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">wf</span><span class="o">.</span><span class="n">setframerate</span><span class="p">(</span><span class="n">eff_sr</span><span class="p">)</span>
                <span class="n">dump_i16</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">audio_block_f32</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">32767.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
                <span class="n">wf</span><span class="o">.</span><span class="n">writeframes</span><span class="p">(</span><span class="n">dump_i16</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>

        <span class="c1"># æ‰§è¡Œæ¨ç†</span>
        <span class="n">res_text</span> <span class="o">=</span> <span class="n">_infer_block</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">audio_block_f32</span><span class="p">,</span> <span class="n">eff_sr</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">running_cache</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res_text</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">rich_post</span><span class="p">(</span><span class="n">res_text</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">printed_text</span><span class="p">):</span>
            <span class="n">new_part</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">printed_text</span><span class="p">)</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_part</span> <span class="o">=</span> <span class="n">text</span>
        <span class="k">if</span> <span class="n">new_part</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">new_part</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">printed_text</span> <span class="o">+=</span> <span class="n">new_part</span>

    <span class="c1"># åœæ­¢å‰åšä¸€æ¬¡ flushï¼šå¦‚æœè¿˜æœ‰æ®‹ç•™ç¼“å†²ï¼Œå¼ºåˆ¶æ¨ç†ï¼Œé¿å…å¥å°¾ä¸¢å¤±</span>
    <span class="k">if</span> <span class="n">block_buf</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">joined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">block_buf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">audio_block_f32</span> <span class="o">=</span> <span class="n">int16_to_float32</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>
            <span class="n">audio_block_f32</span><span class="p">,</span> <span class="n">eff_sr</span> <span class="o">=</span> <span class="n">resample_to_16k</span><span class="p">(</span><span class="n">audio_block_f32</span><span class="p">,</span> <span class="n">samplerate</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">_infer_block</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">audio_block_f32</span><span class="p">,</span> <span class="n">eff_sr</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">running_cache</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">rich_post</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">printed_text</span><span class="p">):],</span> <span class="n">end</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">å·²åœæ­¢ã€‚"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">"Real-time mic transcription (in-memory ALSA)"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--model"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">"iic/SenseVoiceSmall"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"æ¨¡å‹ä»“åº“æˆ–æœ¬åœ°è·¯å¾„"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--device"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">"cuda:0"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"è®¾å¤‡ï¼Œå¦‚ cuda:0 æˆ– cpu"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--language"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">"auto"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"è¯­è¨€ä»£ç æˆ– 'auto'"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--samplerate"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">16000</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"é‡‡æ ·ç‡"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--channels"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"é€šé“æ•°"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--block-seconds"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"æ¯æ¬¡æ¨ç†å—æ—¶é•¿ï¼ˆç§’ï¼‰"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--min-rms"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.003</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"è§¦å‘æ¨ç†çš„æœ€å°èƒ½é‡é˜ˆå€¼ï¼ˆ0-1ï¼‰"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--overlap-seconds"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"å—é—´é‡å æ—¶é•¿ï¼ˆç§’ï¼‰ï¼Œå‡å°‘å¥é¦–/å¥å°¾ä¸¢å¤±"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--merge-vad"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">"store_true"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"å¯ç”¨ VAD åˆå¹¶ï¼ˆé»˜è®¤å…³é—­ä»¥è·å¾—æ›´å¿«è¾“å‡ºï¼‰"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--merge-length"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"VAD åˆå¹¶çš„æœ€å¤§åˆ†æ®µæ—¶é•¿ï¼ˆç§’ï¼‰"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--debug"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">"store_true"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼ˆRMSã€å¸§æ•°ç­‰ï¼‰"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--alsa-device"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"ALSA è®¾å¤‡åï¼ˆå¦‚ hw:0,0 æˆ– defaultï¼‰"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># å°† CLI è®¾ç½®ä¼ å…¥ç¯å¢ƒå˜é‡ï¼Œä¾›è¿è¡Œä½“å†…è¯»å–</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"SV_DEBUG"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"1"</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"SV_MIN_RMS"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">min_rms</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"SV_MERGE_VAD"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">merge_vad</span> <span class="k">else</span> <span class="s2">"0"</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"SV_MERGE_LEN"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">merge_length</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"SV_OVERLAP_SEC"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">overlap_seconds</span><span class="p">)</span>

    <span class="n">run_in_memory</span><span class="p">(</span>
        <span class="n">model_dir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="n">language</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">samplerate</span><span class="p">,</span>
        <span class="n">channels</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
        <span class="n">block_seconds</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">block_seconds</span><span class="p">,</span>
        <span class="n">alsa_device</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">alsa_device</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>æ‰§è¡Œå‰å…ˆå®‰è£…ä¸€ä¸‹æ¨¡å—ç»„ä»¶</p>
<div class="codehilite"><pre><span></span><code><span class="n">pip</span> <span class="n">install</span> <span class="n">pyalsaaudio</span>
</code></pre></div>
<p>æ¥ç€è¿è¡Œï¼Œå°±å¯ä»¥å®æ—¶è¯´è¯è½¬æ¢ä¸ºæ–‡å­—äº†ã€‚</p>
<div class="codehilite"><pre><span></span><code>python<span class="w"> </span>demo_realtime_memory.py<span class="w"> </span>--alsa-device<span class="w"> </span>plughw:0,6<span class="w"> </span>--samplerate<span class="w"> </span><span class="m">48000</span><span class="w"> </span>--channels<span class="w"> </span><span class="m">2</span><span class="w"> </span>--block-seconds<span class="w"> </span><span class="m">1</span>.0<span class="w"> </span>--language<span class="w"> </span>zh<span class="w"> </span>--device<span class="w"> </span>cuda:0
</code></pre></div>
<p>å‚è€ƒï¼š<a href="https://github.com/FunAudioLLM/SenseVoice">https://github.com/FunAudioLLM/SenseVoice</a></p></div>
  <div class="post-nav">
    <a class="prev" href="è¯­éŸ³ç”Ÿæˆæ¨¡å‹-cosyvoiceå…¥é—¨å®è·µ.html">â† è¯­éŸ³ç”Ÿæˆæ¨¡å‹ï¼šCosyVoiceå…¥é—¨å®è·µ</a>
    <a class="next" href="windowsè®¿é—®linuxæ­å»ºçš„sambaæœåŠ¡.html">windowsè®¿é—®Linuxæ­å»ºçš„sambaæœåŠ¡ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

