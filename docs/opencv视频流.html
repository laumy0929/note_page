<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>opencvè§†é¢‘æµ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">ç¯å¢ƒå‡†å¤‡</a><ul></ul></li><li><a href="#_2">æ‘„åƒå¤´é‡‡é›†</a><ul><li><a href="#_3">æ‰“å¼€æ‘„åƒå¤´</a></li><li><a href="#_4">è®¾ç½®å‚æ•°</a></li><li><a href="#_5">é‡‡é›†æ•°æ®</a></li></ul></li><li><a href="#_6">æ¨æµæ˜¾ç¤º</a><ul><li><a href="#_7">è·å–æ˜¾ç¤ºå‚æ•°</a></li><li><a href="#_8">å°ºå¯¸è°ƒæ•´</a></li><li><a href="#_9">æ ¼å¼è½¬æ¢</a></li><li><a href="#_10">å†™å…¥æ˜¾ç¤º</a></li></ul></li><li><a href="#_11">ç¤ºä¾‹ç¨‹åº</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>opencvè§†é¢‘æµ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2025-05-27
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      ai
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">ç¯å¢ƒå‡†å¤‡</h2>
<p>æœ¬æ–‡é€šè¿‡é‡‡é›†USBæ‘„åƒå¤´æ¥ç¤ºä¾‹è¯´æ˜</p>
<div class="codehilite"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">mnt</span><span class="o">/</span><span class="n">extsd</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">:</span><span class="n">$LD_LIBRARY_PATH</span>
<span class="cp">#æŒ‡å®šåº“çš„è·¯å¾„</span>

<span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="n">soc</span><span class="o">/</span><span class="n">usbc0</span><span class="o">/</span><span class="n">usb_host</span>
<span class="cp">#æ¿€æ´»USB host</span>
</code></pre></div>
<h2 id="_2">æ‘„åƒå¤´é‡‡é›†</h2>
<p>æ‘„åƒå¤´ç›¸å…³çš„ä¸»è¦ä½¿ç”¨çš„æ˜¯VideoCaptureç±»ã€‚</p>
<h3 id="_3">æ‰“å¼€æ‘„åƒå¤´</h3>
<div class="codehilite"><pre><span></span><code><span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="w"> </span><span class="n">cap</span><span class="p">;</span><span class="w">  </span><span class="c1">// åˆ›å»ºè§†é¢‘æ•è·å¯¹è±¡</span>
<span class="n">cap</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// æ‰“å¼€é»˜è®¤æ‘„åƒå¤´(é€šå¸¸ä¸º/dev/video0)</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cap</span><span class="p">.</span><span class="n">isOpened</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"æ— æ³•æ‰“å¼€è§†é¢‘è®¾å¤‡"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_4">è®¾ç½®å‚æ•°</h3>
<div class="codehilite"><pre><span></span><code><span class="n">cap</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span><span class="w"> </span><span class="mi">640</span><span class="p">);</span><span class="w">  </span><span class="c1">// è®¾ç½®å®½åº¦</span>
<span class="n">cap</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span><span class="w"> </span><span class="mi">480</span><span class="p">);</span><span class="w"> </span><span class="c1">// è®¾ç½®é«˜åº¦</span>
<span class="n">cap</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">CAP_PROP_FPS</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">);</span><span class="w">  </span><span class="c1">// è®¾ç½®å¸§ç‡</span>
</code></pre></div>
<h3 id="_5">é‡‡é›†æ•°æ®</h3>
<div class="codehilite"><pre><span></span><code><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">frame</span><span class="p">;</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cap</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">frame</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ•è·ä¸€å¸§</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"æ•è·å¸§å¤±è´¥"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åœ¨æ­¤å¤„ç†å¸§æ•°æ®...</span>

<span class="w">    </span><span class="n">usleep</span><span class="p">(</span><span class="mi">1000000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">frame_rate</span><span class="p">);</span><span class="w">  </span><span class="c1">// 30mså»¶è¿Ÿï¼Œæ§åˆ¶å¸§ç‡</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_6">æ¨æµæ˜¾ç¤º</h2>
<p>ä¸»è¦æ˜¯æ‰“å¼€/dev/fb0ï¼Œç„¶åå†™å…¥æ•°æ®ã€‚</p>
<h3 id="_7">è·å–æ˜¾ç¤ºå‚æ•°</h3>
<p>é€šè¿‡ioctlçš„æ–¹å¼ï¼Œè·å–æ˜¾ç¤ºåˆ†è¾¨ç‡ï¼Œåƒç´ ä½æ·±ï¼ˆæ¯ä¸ªåƒç´ çš„å ç”¨å†…å­˜å¤§å°ï¼‰ï¼Œä»¥ä¾¿å°†é‡‡é›†åˆ°çš„æ‘„åƒå¤´æ•°æ®è°ƒæ•´ä¸ºåˆé€‚çš„å°ºå¯¸è¿›è¡Œæ˜¾ç¤ºã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">framebuffer_info</span><span class="w"> </span><span class="n">get_framebuffer_info</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">framebuffer_device_path</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">framebuffer_info</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fb_var_screeninfo</span><span class="w"> </span><span class="n">screen_info</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">framebuffer_device_path</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">FBIOGET_VSCREENINFO</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">screen_info</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">xres_virtual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//è™šæ‹Ÿæ°´å¹³çš„åˆ†è¾¨ç‡ï¼ŒåŒ…å«ä¸å¯è§åŒºåŸŸï¼Œå³è™šæ‹Ÿå®½åº¦</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//æ¯ä¸ªåƒç´ çš„ä½æ·±ï¼Œå³åƒç´ å¤§å°ï¼Œå¦‚16/24/32ç­‰</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">xres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//å®é™…æ°´å¹³åˆ†è¾¨ç‡ï¼Œå³å®é™…å®½åº¦</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">yres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//å‚ç›´åˆ†è¾¨ç‡ï¼Œå³å®é™…é«˜åº¦</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h3 id="_8">å°ºå¯¸è°ƒæ•´</h3>
<div class="codehilite"><pre><span></span><code><span class="n">cv</span><span class="o">::</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">(</span><span class="n">fb_info</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">yres</span><span class="p">));</span>
</code></pre></div>
<p>ä»/dev/fb0è·å–çš„å®é™…åˆ†è¾¨ç‡è¿›è¡Œè°ƒæ•´å°ºå¯¸ã€‚</p>
<h3 id="_9">æ ¼å¼è½¬æ¢</h3>
<p>å†™å…¥å‰ï¼Œå…ˆå°†é‡‡é›†çš„è§†é¢‘å¸§è½¬æ¢ä¸ºå±å¹•æ˜¾ç¤ºæ”¯æŒçš„æ ¼å¼ï¼Œå¦‚RGB565ï¼ŒRGBAç­‰ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">framebuffer_depth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="k">case</span><span class="w"> </span><span class="mi">16</span><span class="p">:</span>
<span class="w">    </span><span class="c1">//è½¬æ¢ä¸ºRGB565æ ¼å¼è¾“å‡º</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">COLOR_BGR2BGR565</span><span class="p">);</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="k">case</span><span class="w"> </span><span class="mi">32</span><span class="p">:</span>
<span class="w">    </span><span class="c1">//è½¬æ¢ä¸ºRGBAæ ¼å¼è¾“å‡ºï¼Œæ·»åŠ ä¸€ä¸ªalphaé€šé“</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&gt;</span><span class="w"> </span><span class="n">split_bgr</span><span class="p">;</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">split</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">split_bgr</span><span class="p">);</span><span class="c1">//å°†BGRåˆ†ç¦»ä¸º3ä¸ªé€šé“,å­˜å‚¨åˆ°split_bgrä¸­ã€‚</span>
<span class="w">    </span><span class="n">split_bgr</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">(</span><span class="n">frame_size</span><span class="p">,</span><span class="w"> </span><span class="n">CV_8UC1</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">)));</span>
<span class="w">    </span><span class="c1">//åˆ›å»ºä¸€ä¸ªå…¨ç™½çš„alphaé€šé“çŸ©é˜µå¹¶è¿›è¡Œæ·»åŠ åˆ°ä¸€ä¸ªæ–°çš„é€šé“</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">merge</span><span class="p">(</span><span class="n">split_bgr</span><span class="p">,</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//ä½¿ç”¨mergeå°†3ä¸ªé¢œè‰²é€šé“å’Œalphaé€šé“è¿›è¡Œåˆå¹¶ä¸ºRGBAå››é€šé“ã€‚</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_10">å†™å…¥æ˜¾ç¤º</h3>
<div class="codehilite"><pre><span></span><code><span class="n">ofs</span><span class="p">.</span><span class="n">seekp</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">//å…ˆè¿›è¡Œå®šä½</span>
<span class="n">ofs</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">ptr</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span>
<span class="w">    </span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">total</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">elemSize</span><span class="p">());</span>
</code></pre></div>
<p>ä¹Ÿå¯ä»¥ä¸€è¡Œä¸€è¡Œçš„å†™</p>
<div class="codehilite"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">frame_size</span><span class="p">.</span><span class="n">height</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ofs</span><span class="p">.</span><span class="n">seekp</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">framebuffer_width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">ofs</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">ptr</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span><span class="w"> </span><span class="n">frame_size</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_11">ç¤ºä¾‹ç¨‹åº</h2>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fstream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/fb.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;signal.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/ioctl.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;opencv2/opencv.hpp&gt;</span>

<span class="k">static</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="w"> </span><span class="n">cap</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">framebuffer_info</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">bits_per_pixel</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">xres_virtual</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">xres</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">yres</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">framebuffer_info</span><span class="w"> </span><span class="n">get_framebuffer_info</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">framebuffer_device_path</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">framebuffer_info</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fb_var_screeninfo</span><span class="w"> </span><span class="n">screen_info</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">framebuffer_device_path</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">FBIOGET_VSCREENINFO</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">screen_info</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">xres_virtual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">xres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">yres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Signal handler */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sig_no</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Got signal %d, exiting ...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">sig_no</span><span class="p">);</span>
<span class="w">    </span><span class="n">cap</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">frame_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">720</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">frame_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1280</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">frame_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>

<span class="w">    </span><span class="n">framebuffer_info</span><span class="w"> </span><span class="n">fb_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_framebuffer_info</span><span class="p">(</span><span class="s">"/dev/fb0"</span><span class="p">);</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"xres virtua"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">xres_virtual</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"bits per pixel"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">    </span><span class="n">cap</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cap</span><span class="p">.</span><span class="n">isOpened</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Could not open video device."</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Successfully opened video device."</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w">  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Display resolution:"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">xres</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"x"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">yres</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">cap</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span><span class="w"> </span><span class="n">frame_width</span><span class="p">);</span>
<span class="w">    </span><span class="n">cap</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span><span class="w"> </span><span class="n">frame_height</span><span class="p">);</span>
<span class="w">    </span><span class="n">cap</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">CAP_PROP_FPS</span><span class="p">,</span><span class="w"> </span><span class="n">frame_rate</span><span class="p">);</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="w"> </span><span class="n">ofs</span><span class="p">(</span><span class="s">"/dev/fb0"</span><span class="p">);</span>

<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">frame</span><span class="p">;</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">trams_temp_fream</span><span class="p">;</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">yuv_frame</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cap</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">frame</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">depth</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CV_8U</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Not 8 bits per pixel and channel."</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">channels</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Not 3 channels."</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//cv::transpose(frame, frame);</span>
<span class="w">            </span><span class="c1">//cv::flip(frame, frame, 0);</span>
<span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">(</span><span class="n">fb_info</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">yres</span><span class="p">));</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">framebuffer_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">framebuffer_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
<span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">Size2f</span><span class="w"> </span><span class="n">frame_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">;</span>
<span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">framebuffer_depth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">16</span><span class="p">:</span>
<span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">COLOR_BGR2BGR565</span><span class="p">);</span>

<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">32</span><span class="p">:</span><span class="w"> </span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&gt;</span><span class="w"> </span><span class="n">split_bgr</span><span class="p">;</span>
<span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">split</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">split_bgr</span><span class="p">);</span>
<span class="w">                </span><span class="n">split_bgr</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">(</span><span class="n">frame_size</span><span class="p">,</span><span class="w"> </span><span class="n">CV_8UC1</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">)));</span>
<span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">merge</span><span class="p">(</span><span class="n">split_bgr</span><span class="p">,</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">ofs</span><span class="p">.</span><span class="n">seekp</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="n">ofs</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">ptr</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span>
<span class="w">            </span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">total</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">elemSize</span><span class="p">());</span>
<span class="w">            </span><span class="n">usleep</span><span class="p">(</span><span class="mi">1000000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">frame_rate</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="opencvåŸºç¡€æ“ä½œ.html">â† opencvåŸºç¡€æ“ä½œ</a>
    <a class="next" href="perfå·¥å…·ä½¿ç”¨.html">perfå·¥å…·ä½¿ç”¨ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

