<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>opencv视频流 - Laumy的技术栈</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">首页</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="访问主站">主站点:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#_1">环境准备</a><ul></ul></li><li><a href="#_2">摄像头采集</a><ul><li><a href="#_3">打开摄像头</a></li><li><a href="#_4">设置参数</a></li><li><a href="#_5">采集数据</a></li></ul></li><li><a href="#_6">推流显示</a><ul><li><a href="#_7">获取显示参数</a></li><li><a href="#_8">尺寸调整</a></li><li><a href="#_9">格式转换</a></li><li><a href="#_10">写入显示</a></li></ul></li><li><a href="#_11">示例程序</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>opencv视频流</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">🕒</i>
      2025-05-27
    </span>
    <span class="meta-item">
      <i class="icon">📂</i>
      ai
    </span>
    <span class="meta-item">
      <i class="icon">👤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">环境准备</h2>
<p>本文通过采集USB摄像头来示例说明</p>
<div class="codehilite"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">mnt</span><span class="o">/</span><span class="n">extsd</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">:</span><span class="n">$LD_LIBRARY_PATH</span>
<span class="cp">#指定库的路径</span>

<span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="n">soc</span><span class="o">/</span><span class="n">usbc0</span><span class="o">/</span><span class="n">usb_host</span>
<span class="cp">#激活USB host</span>
</code></pre></div>
<h2 id="_2">摄像头采集</h2>
<p>摄像头相关的主要使用的是VideoCapture类。</p>
<h3 id="_3">打开摄像头</h3>
<div class="codehilite"><pre><span></span><code><span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="w"> </span><span class="n">cap</span><span class="p">;</span><span class="w">  </span><span class="c1">// 创建视频捕获对象</span>
<span class="n">cap</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// 打开默认摄像头(通常为/dev/video0)</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cap</span><span class="p">.</span><span class="n">isOpened</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"无法打开视频设备"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_4">设置参数</h3>
<div class="codehilite"><pre><span></span><code><span class="n">cap</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span><span class="w"> </span><span class="mi">640</span><span class="p">);</span><span class="w">  </span><span class="c1">// 设置宽度</span>
<span class="n">cap</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span><span class="w"> </span><span class="mi">480</span><span class="p">);</span><span class="w"> </span><span class="c1">// 设置高度</span>
<span class="n">cap</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">CAP_PROP_FPS</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">);</span><span class="w">  </span><span class="c1">// 设置帧率</span>
</code></pre></div>
<h3 id="_5">采集数据</h3>
<div class="codehilite"><pre><span></span><code><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">frame</span><span class="p">;</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cap</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">frame</span><span class="p">;</span><span class="w">  </span><span class="c1">// 捕获一帧</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"捕获帧失败"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 在此处理帧数据...</span>

<span class="w">    </span><span class="n">usleep</span><span class="p">(</span><span class="mi">1000000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">frame_rate</span><span class="p">);</span><span class="w">  </span><span class="c1">// 30ms延迟，控制帧率</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_6">推流显示</h2>
<p>主要是打开/dev/fb0，然后写入数据。</p>
<h3 id="_7">获取显示参数</h3>
<p>通过ioctl的方式，获取显示分辨率，像素位深（每个像素的占用内存大小），以便将采集到的摄像头数据调整为合适的尺寸进行显示。</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">framebuffer_info</span><span class="w"> </span><span class="n">get_framebuffer_info</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">framebuffer_device_path</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">framebuffer_info</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fb_var_screeninfo</span><span class="w"> </span><span class="n">screen_info</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">framebuffer_device_path</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">FBIOGET_VSCREENINFO</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">screen_info</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">xres_virtual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//虚拟水平的分辨率，包含不可见区域，即虚拟宽度</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//每个像素的位深，即像素大小，如16/24/32等</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">xres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//实际水平分辨率，即实际宽度</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">yres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//垂直分辨率，即实际高度</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h3 id="_8">尺寸调整</h3>
<div class="codehilite"><pre><span></span><code><span class="n">cv</span><span class="o">::</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">(</span><span class="n">fb_info</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">yres</span><span class="p">));</span>
</code></pre></div>
<p>从/dev/fb0获取的实际分辨率进行调整尺寸。</p>
<h3 id="_9">格式转换</h3>
<p>写入前，先将采集的视频帧转换为屏幕显示支持的格式，如RGB565，RGBA等。</p>
<div class="codehilite"><pre><span></span><code><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">framebuffer_depth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="k">case</span><span class="w"> </span><span class="mi">16</span><span class="p">:</span>
<span class="w">    </span><span class="c1">//转换为RGB565格式输出</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">COLOR_BGR2BGR565</span><span class="p">);</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="k">case</span><span class="w"> </span><span class="mi">32</span><span class="p">:</span>
<span class="w">    </span><span class="c1">//转换为RGBA格式输出，添加一个alpha通道</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&gt;</span><span class="w"> </span><span class="n">split_bgr</span><span class="p">;</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">split</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">split_bgr</span><span class="p">);</span><span class="c1">//将BGR分离为3个通道,存储到split_bgr中。</span>
<span class="w">    </span><span class="n">split_bgr</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">(</span><span class="n">frame_size</span><span class="p">,</span><span class="w"> </span><span class="n">CV_8UC1</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">)));</span>
<span class="w">    </span><span class="c1">//创建一个全白的alpha通道矩阵并进行添加到一个新的通道</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">merge</span><span class="p">(</span><span class="n">split_bgr</span><span class="p">,</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//使用merge将3个颜色通道和alpha通道进行合并为RGBA四通道。</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_10">写入显示</h3>
<div class="codehilite"><pre><span></span><code><span class="n">ofs</span><span class="p">.</span><span class="n">seekp</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">//先进行定位</span>
<span class="n">ofs</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">ptr</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span>
<span class="w">    </span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">total</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">elemSize</span><span class="p">());</span>
</code></pre></div>
<p>也可以一行一行的写</p>
<div class="codehilite"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">frame_size</span><span class="p">.</span><span class="n">height</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ofs</span><span class="p">.</span><span class="n">seekp</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">framebuffer_width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">ofs</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">ptr</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span><span class="w"> </span><span class="n">frame_size</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_11">示例程序</h2>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fstream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/fb.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;signal.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/ioctl.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;opencv2/opencv.hpp&gt;</span>

<span class="k">static</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="w"> </span><span class="n">cap</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">framebuffer_info</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">bits_per_pixel</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">xres_virtual</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">xres</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">yres</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">framebuffer_info</span><span class="w"> </span><span class="n">get_framebuffer_info</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">framebuffer_device_path</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">framebuffer_info</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fb_var_screeninfo</span><span class="w"> </span><span class="n">screen_info</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">framebuffer_device_path</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">FBIOGET_VSCREENINFO</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">screen_info</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">xres_virtual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">xres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">yres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">screen_info</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Signal handler */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sig_no</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Got signal %d, exiting ...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">sig_no</span><span class="p">);</span>
<span class="w">    </span><span class="n">cap</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">frame_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">720</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">frame_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1280</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">frame_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>

<span class="w">    </span><span class="n">framebuffer_info</span><span class="w"> </span><span class="n">fb_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_framebuffer_info</span><span class="p">(</span><span class="s">"/dev/fb0"</span><span class="p">);</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"xres virtua"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">xres_virtual</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"bits per pixel"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">    </span><span class="n">cap</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cap</span><span class="p">.</span><span class="n">isOpened</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Could not open video device."</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Successfully opened video device."</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w">  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Display resolution:"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">xres</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"x"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">yres</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">cap</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span><span class="w"> </span><span class="n">frame_width</span><span class="p">);</span>
<span class="w">    </span><span class="n">cap</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span><span class="w"> </span><span class="n">frame_height</span><span class="p">);</span>
<span class="w">    </span><span class="n">cap</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">CAP_PROP_FPS</span><span class="p">,</span><span class="w"> </span><span class="n">frame_rate</span><span class="p">);</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="w"> </span><span class="n">ofs</span><span class="p">(</span><span class="s">"/dev/fb0"</span><span class="p">);</span>

<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">frame</span><span class="p">;</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">trams_temp_fream</span><span class="p">;</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">yuv_frame</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cap</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">frame</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">depth</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CV_8U</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Not 8 bits per pixel and channel."</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">channels</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Not 3 channels."</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//cv::transpose(frame, frame);</span>
<span class="w">            </span><span class="c1">//cv::flip(frame, frame, 0);</span>
<span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">(</span><span class="n">fb_info</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">yres</span><span class="p">));</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">framebuffer_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">framebuffer_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fb_info</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
<span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">Size2f</span><span class="w"> </span><span class="n">frame_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">;</span>
<span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">framebuffer_depth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">16</span><span class="p">:</span>
<span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">COLOR_BGR2BGR565</span><span class="p">);</span>

<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">32</span><span class="p">:</span><span class="w"> </span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&gt;</span><span class="w"> </span><span class="n">split_bgr</span><span class="p">;</span>
<span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">split</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">split_bgr</span><span class="p">);</span>
<span class="w">                </span><span class="n">split_bgr</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">(</span><span class="n">frame_size</span><span class="p">,</span><span class="w"> </span><span class="n">CV_8UC1</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">)));</span>
<span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">merge</span><span class="p">(</span><span class="n">split_bgr</span><span class="p">,</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">ofs</span><span class="p">.</span><span class="n">seekp</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="n">ofs</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">ptr</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span>
<span class="w">            </span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">total</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">framebuffer_compat</span><span class="p">.</span><span class="n">elemSize</span><span class="p">());</span>
<span class="w">            </span><span class="n">usleep</span><span class="p">(</span><span class="mi">1000000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">frame_rate</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="opencv基础操作.html">← opencv基础操作</a>
    <a class="next" href="perf工具使用.html">perf工具使用 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

