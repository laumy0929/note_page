<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>libpeeråˆ†æ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">å…³é”®æ•°æ®ç»“æ„</a><ul><li><a href="#peerconfiguration">PeerConfiguration</a></li><li><a href="#agent">Agent</a></li><li><a href="#serviceconfiguration">ServiceConfiguration</a></li><li><a href="#peerconnection">PeerConnection</a></li></ul></li><li><a href="#webrtc">WebRTCç®€ä»‹</a><ul><li><a href="#_2">æ¦‚è§ˆ</a></li><li><a href="#_3">é€šä¿¡æµç¨‹</a></li><li><a href="#_4">ä¿¡ä»¤</a></li><li><a href="#sdp">SDP</a></li><li><a href="#ice-candidates">ICE candidates</a></li></ul></li><li><a href="#main">mainå‡½æ•°åˆ†æ</a><ul></ul></li><li><a href="#_5">ä¿¡ä»¤äº¤äº’</a><ul><li><a href="#_6">ä¸ä¿¡ä»¤æœåŠ¡å™¨å»ºç«‹è¿æ¥</a></li><li><a href="#_7">é€šçŸ¥ä¿¡ä»¤æœåŠ¡å™¨å·²å‡†å¤‡</a></li><li><a href="#_8">æ¥æ”¶ä¿¡ä»¤æœåŠ¡å™¨äº‹ä»¶å¤„ç†</a></li><li><a href="#offer-sdp">Offer SDP</a></li><li><a href="#anser-sdp">anser SDP</a></li><li><a href="#p2p">æµ‹è¯•P2Pé€šè·¯</a></li></ul></li><li><a href="#p2p_1">P2Pé€šä¿¡</a><ul><li><a href="#_9">åˆå§‹åŒ–</a></li><li><a href="#_10">åˆ›å»º</a></li><li><a href="#_11">ä¼ è¾“</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>libpeeråˆ†æ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-11-24
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      ç½‘ç»œ
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">å…³é”®æ•°æ®ç»“æ„</h2>
<h3 id="peerconfiguration">PeerConfiguration</h3>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PeerConfiguration</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">IceServer</span><span class="w"> </span><span class="n">ice_servers</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

<span class="w">  </span><span class="n">MediaCodec</span><span class="w"> </span><span class="n">audio_codec</span><span class="p">;</span>
<span class="w">  </span><span class="n">MediaCodec</span><span class="w"> </span><span class="n">video_codec</span><span class="p">;</span>
<span class="w">  </span><span class="n">DataChannelType</span><span class="w"> </span><span class="n">datachannel</span><span class="p">;</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">onaudiotrack</span><span class="p">)(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">userdata</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">onvideotrack</span><span class="p">)(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">userdata</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">on_request_keyframe</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">userdata</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">user_data</span><span class="p">;</span>

<span class="p">}</span><span class="w"> </span><span class="n">PeerConfiguration</span><span class="p">;</span>

<span class="n">å®ä¾‹</span><span class="err">ï¼š</span>
<span class="w"> </span><span class="n">PeerConfiguration</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">.</span><span class="n">ice_servers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">{.</span><span class="n">urls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"stun:stun.l.google.com:19302"</span><span class="p">},</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">.</span><span class="n">datachannel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DATA_CHANNEL_STRING</span><span class="p">,</span>
<span class="w">      </span><span class="p">.</span><span class="n">video_codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CODEC_H264</span><span class="p">,</span>
<span class="w">      </span><span class="p">.</span><span class="n">audio_codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CODEC_PCMA</span><span class="p">};</span>
</code></pre></div>
<h3 id="agent">Agent</h3>
<p>Agent ç»“æ„ä½“ï¼Œä¸»è¦ç”¨äºå®ç° WebRTC æˆ–ç±»ä¼¼åè®®ä¸­çš„ ICE (Interactive Connectivity Establishment) æœºåˆ¶ã€‚ICE æ˜¯ä¸€ç§ NAT ç©¿è¶Šåè®®ï¼Œç”¨äºåœ¨ç‚¹å¯¹ç‚¹é€šä¿¡ä¸­å»ºç«‹è¿æ¥å¹¶é€‰æ‹©æœ€ä½³çš„ç½‘ç»œè·¯å¾„ã€‚Agent ç»“æ„ä½“å­˜å‚¨äº†ä¸ ICE åè®®æ“ä½œç›¸å…³çš„å„ç§æ•°æ®ï¼Œç”¨äºç®¡ç†è¿æ¥çš„å€™é€‰åœ°å€ã€åå•†è¿‡ç¨‹ä»¥åŠçŠ¶æ€ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">Agent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">remote_ufrag</span><span class="p">[</span><span class="n">ICE_UFRAG_LENGTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">remote_upwd</span><span class="p">[</span><span class="n">ICE_UPWD_LENGTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>

<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">local_ufrag</span><span class="p">[</span><span class="n">ICE_UFRAG_LENGTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">local_upwd</span><span class="p">[</span><span class="n">ICE_UPWD_LENGTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>

<span class="w">  </span><span class="n">IceCandidate</span><span class="w"> </span><span class="n">local_candidates</span><span class="p">[</span><span class="n">AGENT_MAX_CANDIDATES</span><span class="p">];</span>
<span class="w">  </span><span class="n">IceCandidate</span><span class="w"> </span><span class="n">remote_candidates</span><span class="p">[</span><span class="n">AGENT_MAX_CANDIDATES</span><span class="p">];</span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">local_candidates_count</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">remote_candidates_count</span><span class="p">;</span>

<span class="w">  </span><span class="n">UdpSocket</span><span class="w"> </span><span class="n">udp_sockets</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="w">  </span><span class="n">Address</span><span class="w"> </span><span class="n">host_addr</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">b_host_addr</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">binding_request_time</span><span class="p">;</span>
<span class="w">  </span><span class="n">AgentState</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>

<span class="w">  </span><span class="n">AgentMode</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>

<span class="w">  </span><span class="n">IceCandidatePair</span><span class="w"> </span><span class="n">candidate_pairs</span><span class="p">[</span><span class="n">AGENT_MAX_CANDIDATE_PAIRS</span><span class="p">];</span>
<span class="w">  </span><span class="n">IceCandidatePair</span><span class="o">*</span><span class="w"> </span><span class="n">selected_pair</span><span class="p">;</span>
<span class="w">  </span><span class="n">IceCandidatePair</span><span class="o">*</span><span class="w"> </span><span class="n">nominated_pair</span><span class="p">;</span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">candidate_pairs_num</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">use_candidate</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">transaction_id</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div>
<h3 id="serviceconfiguration">ServiceConfiguration</h3>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ServiceConfiguration</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">mqtt_url</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">mqtt_port</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">client_id</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">http_url</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">http_port</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<span class="w">  </span><span class="n">PeerConnection</span><span class="o">*</span><span class="w"> </span><span class="n">pc</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">ServiceConfiguration</span><span class="p">;</span>

<span class="n">å®ä¾‹</span>
<span class="cp">#define SERVICE_CONFIG_DEFAULT()  \</span>
<span class="cp">  {                               \</span>
<span class="cp">    .mqtt_url = "broker.emqx.io", \  </span><span class="c1">//è®¿é—®çš„MQTTæœåŠ¡å™¨</span>
<span class="w">    </span><span class="p">.</span><span class="n">mqtt_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8883</span><span class="p">,</span><span class="w">            </span><span class="err">\</span><span class="w">  </span><span class="c1">//è®¿é—®çš„MQTTç«¯å£</span>
<span class="w">    </span><span class="p">.</span><span class="n">client_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"peer"</span><span class="p">,</span><span class="w">          </span><span class="err">\</span><span class="w">   </span><span class="c1">//ç”¨äºè®¢é˜…çš„ä¸»é¢˜ webrtc/peer/jsonrpc</span>
<span class="w">                                         </span><span class="c1">//å‘å¸ƒçš„ä¸»é¢˜ webrtc/peer/jsonrpc-reply</span>
<span class="w">    </span><span class="p">.</span><span class="n">http_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w">               </span><span class="err">\</span><span class="w">   </span><span class="c1">//ä¿¡ä»¤ä½¿ç”¨çš„æ˜¯MQTTï¼Œæ²¡æœ‰ä½¿ç”¨httpï¼Œ</span>
<span class="w">    </span><span class="p">.</span><span class="n">http_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">443</span><span class="p">,</span><span class="w">             </span><span class="err">\</span><span class="w">   </span><span class="c1">//å› æ­¤HTTPçš„æ²¡æœ‰ç”¨ã€‚</span>
<span class="w">    </span><span class="p">.</span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w">               </span>\
<span class="w">    </span><span class="p">.</span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w">               </span>\
<span class="w">    </span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="w">                    </span>\
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<h3 id="peerconnection">PeerConnection</h3>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">PeerConnection</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">PeerConfiguration</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>
<span class="w">  </span><span class="n">PeerConnectionState</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">  </span><span class="n">Agent</span><span class="w"> </span><span class="n">agent</span><span class="p">;</span>
<span class="w">  </span><span class="n">DtlsSrtp</span><span class="w"> </span><span class="n">dtls_srtp</span><span class="p">;</span>
<span class="w">  </span><span class="n">Sctp</span><span class="w"> </span><span class="n">sctp</span><span class="p">;</span>

<span class="w">  </span><span class="n">Sdp</span><span class="w"> </span><span class="n">local_sdp</span><span class="p">;</span>
<span class="w">  </span><span class="n">Sdp</span><span class="w"> </span><span class="n">remote_sdp</span><span class="p">;</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">onicecandidate</span><span class="p">)(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">sdp</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">user_data</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">oniceconnectionstatechange</span><span class="p">)(</span><span class="n">PeerConnectionState</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">user_data</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">on_connected</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">userdata</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">on_receiver_packet_loss</span><span class="p">)(</span><span class="kt">float</span><span class="w"> </span><span class="n">fraction_loss</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">total_loss</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">user_data</span><span class="p">);</span>

<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">temp_buf</span><span class="p">[</span><span class="n">CONFIG_MTU</span><span class="p">];</span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">agent_buf</span><span class="p">[</span><span class="n">CONFIG_MTU</span><span class="p">];</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">agent_ret</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">b_local_description_created</span><span class="p">;</span>

<span class="w">  </span><span class="n">Buffer</span><span class="o">*</span><span class="w"> </span><span class="n">audio_rb</span><span class="p">;</span>
<span class="w">  </span><span class="n">Buffer</span><span class="o">*</span><span class="w"> </span><span class="n">video_rb</span><span class="p">;</span>
<span class="w">  </span><span class="n">Buffer</span><span class="o">*</span><span class="w"> </span><span class="n">data_rb</span><span class="p">;</span>

<span class="w">  </span><span class="n">RtpEncoder</span><span class="w"> </span><span class="n">artp_encoder</span><span class="p">;</span>
<span class="w">  </span><span class="n">RtpEncoder</span><span class="w"> </span><span class="n">vrtp_encoder</span><span class="p">;</span>
<span class="w">  </span><span class="n">RtpDecoder</span><span class="w"> </span><span class="n">vrtp_decoder</span><span class="p">;</span>
<span class="w">  </span><span class="n">RtpDecoder</span><span class="w"> </span><span class="n">artp_decoder</span><span class="p">;</span>

<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">remote_assrc</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">remote_vssrc</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h2 id="webrtc">WebRTCç®€ä»‹</h2>
<h3 id="_2">æ¦‚è§ˆ</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/11/wp_editor_md_56afa863b5c90a096509fe1610c735b7.jpg"><img alt="" src="assets/doc/08-ç½‘ç»œ/libpeeråˆ†æ/images/wp_editor_md_56afa863b5c90a096509fe1610c735b7.jpg"/></a></p>
<p>ä¸Šå›¾ä¸­ä¸€å…±æœ‰4ä¸­è§’è‰²ï¼Œåˆ†åˆ«æ˜¯signaling serverã€STUN/RURN serverã€Client Aï¼ŒClient Bï¼›</p>
<ul>
<li>signaling serverï¼šä¿¡ä»¤æŒ‡çš„æ˜¯ç®¡ç†ä¸¤ä¸ªé€šä¿¡è®¾å¤‡Aå’ŒBå»ºç«‹å’Œç®¡ç†ç‚¹å¯¹ç‚¹è¿æ¥è¿‡ç¨‹ä¸­çš„æ§åˆ¶æ¶ˆæ¯äº¤æ¢æœºåˆ¶ã€‚è®©é€šä¿¡åŒæ–¹èƒ½å¤Ÿäº¤æ¢å„ç§ä¿¡æ¯ï¼Œä»è€Œå»ºç«‹ã€ç»´æŠ¤å’Œç»ˆæ­¢ä¸€ä¸ªç‚¹å¯¹ç‚¹çš„å®æ—¶é€šä¿¡è¿æ¥ã€‚</li>
<li>STUN/RURN serverï¼šç”¨äºè®¾å¤‡Aå’Œè®¾å¤‡Bä¼ è¿‡NATã€‚</li>
<li>Client Aï¼šé€šä¿¡è®¾å¤‡A</li>
<li>Client Bï¼šé€šä¿¡è®¾å¤‡B</li>
</ul>
<h3 id="_3">é€šä¿¡æµç¨‹</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/11/wp_editor_md_9c4699106324b4557bad72cc464f6dff.jpg"><img alt="" src="assets/doc/08-ç½‘ç»œ/libpeeråˆ†æ/images/wp_editor_md_9c4699106324b4557bad72cc464f6dff.jpg"/></a></p>
<p>WebRTCä¸­å®¢æˆ·ç«¯ä¸ä¿¡ä»¤æœåŠ¡å™¨ã€STUN/TURNæœåŠ¡å™¨çš„äº¤äº’æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p>ClientAé¦–å…ˆåˆ›å»ºPeerConnectionå¯¹è±¡ï¼Œç„¶åæ‰“å¼€æœ¬åœ°éŸ³è§†é¢‘è®¾å¤‡ï¼Œå°†éŸ³è§†é¢‘æ•°æ®å°è£…æˆMediaStreamæ·»åŠ åˆ°PeerConnectionä¸­ã€‚</p>
</li>
<li>
<p>ClientAè°ƒç”¨PeerConnectionçš„CreateOfferæ–¹æ³•åˆ›å»ºä¸€ä¸ªç”¨äºofferçš„SDPå¯¹è±¡ï¼ŒSDPå¯¹è±¡ä¸­ä¿å­˜å½“å‰éŸ³è§†é¢‘çš„ç›¸å…³å‚æ•°ã€‚ClientAé€šè¿‡PeerConnectionçš„SetLocalDescriptionæ–¹æ³•å°†è¯¥SDPå¯¹è±¡ä¿å­˜èµ·æ¥ï¼Œå¹¶é€šè¿‡SignalæœåŠ¡å™¨å‘é€ç»™ClientBã€‚</p>
</li>
<li>
<p>ClientBæ¥æ”¶åˆ°ClientAå‘é€è¿‡çš„offer SDPå¯¹è±¡ï¼Œé€šè¿‡PeerConnectionçš„SetRemoteDescriptionæ–¹æ³•å°†å…¶ä¿å­˜èµ·æ¥ï¼Œå¹¶è°ƒç”¨PeerConnectionçš„CreateAnsweræ–¹æ³•åˆ›å»ºä¸€ä¸ªåº”ç­”çš„SDPå¯¹è±¡ï¼Œé€šè¿‡PeerConnectionçš„SetLocalDescriptionçš„æ–¹æ³•ä¿å­˜è¯¥åº”ç­”SDPå¯¹è±¡å¹¶å°†å®ƒé€šè¿‡SignalæœåŠ¡å™¨å‘é€ç»™ClientAã€‚</p>
</li>
<li>
<p>ClientAæ¥æ”¶åˆ°ClientBå‘é€è¿‡æ¥çš„åº”ç­”SDPå¯¹è±¡ï¼Œå°†å…¶é€šè¿‡PeerConnectionçš„SetRemoteDescriptionæ–¹æ³•ä¿å­˜èµ·æ¥ã€‚</p>
</li>
<li>
<p>åœ¨SDPä¿¡æ¯çš„offer/answeræµç¨‹ä¸­ï¼ŒClientAå’ŒClientBå·²ç»æ ¹æ®SDPä¿¡æ¯åˆ›å»ºå¥½ç›¸åº”çš„éŸ³é¢‘Channelå’Œè§†é¢‘Channelå¹¶å¼€å¯Candidateæ•°æ®çš„æ”¶é›†ï¼ŒCandidateæ•°æ®å¯ä»¥ç®€å•åœ°ç†è§£æˆClientç«¯çš„IPåœ°å€ä¿¡æ¯ï¼ˆæœ¬åœ°IPåœ°å€ã€å…¬ç½‘IPåœ°å€ã€RelayæœåŠ¡ç«¯åˆ†é…çš„åœ°å€ï¼‰ã€‚</p>
</li>
<li>
<p>å½“ClientAæ”¶é›†åˆ°Candidateä¿¡æ¯åï¼ŒPeerConnectionä¼šé€šè¿‡OnIceCandidateæ¥å£ç»™ClientAå‘é€é€šçŸ¥ï¼ŒClientAå°†æ”¶åˆ°çš„Candidateä¿¡æ¯é€šè¿‡SignalæœåŠ¡å™¨å‘é€ç»™ClientBï¼ŒClientBé€šè¿‡PeerConnectionçš„AddIceCandidateæ–¹æ³•ä¿å­˜èµ·æ¥ã€‚åŒæ ·çš„æ“ä½œClientBå¯¹ClientAå†æ¥ä¸€æ¬¡ã€‚</p>
</li>
<li>
<p>è¿™æ ·ClientAå’ŒClientBå°±å·²ç»å»ºç«‹äº†éŸ³è§†é¢‘ä¼ è¾“çš„P2Pé€šé“ï¼ŒClientBæ¥æ”¶åˆ°ClientAä¼ é€è¿‡æ¥çš„éŸ³è§†é¢‘æµï¼Œä¼šé€šè¿‡PeerConnectionçš„OnAddStreamå›è°ƒæ¥å£è¿”å›ä¸€ä¸ªæ ‡è¯†ClientAç«¯éŸ³è§†é¢‘æµçš„MediaStreamå¯¹è±¡ï¼Œåœ¨ClientBç«¯æ¸²æŸ“å‡ºæ¥å³å¯ã€‚åŒæ ·æ“ä½œä¹Ÿé€‚åº”ClientBåˆ°ClientAçš„éŸ³è§†é¢‘æµçš„ä¼ è¾“ã€‚</p>
</li>
</ul>
<p>ä¸Šè¿°åºåˆ—ä¸­ï¼ŒWebRTCå¹¶ä¸æä¾›StunæœåŠ¡å™¨å’ŒSignalæœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ç«¯éœ€è¦è‡ªå·±å®ç°ã€‚StunæœåŠ¡å™¨å¯ä»¥ç”¨googleæä¾›çš„å®ç°stunåè®®çš„æµ‹è¯•æœåŠ¡å™¨ï¼ˆstun:stun.l.google.com:19302ï¼‰ï¼ŒSignalæœåŠ¡å™¨åˆ™å®Œå…¨éœ€è¦è‡ªå·±å®ç°äº†ï¼Œå¯ä»¥ä½¿ç”¨MQTTçš„broker.emqx.ioæ¥ä½œä¸ºä¿¡ä»¤æœåŠ¡å™¨ã€‚å®ƒéœ€è¦åœ¨ClientAå’ŒClientBä¹‹é—´ä¼ é€å½¼æ­¤çš„SDPä¿¡æ¯å’Œcandidateä¿¡æ¯ï¼ŒClientAå’ŒClientBé€šè¿‡è¿™äº›ä¿¡æ¯å»ºç«‹P2Pè¿æ¥æ¥ä¼ é€éŸ³è§†é¢‘æ•°æ®ã€‚</p>
<h3 id="_4">ä¿¡ä»¤</h3>
<p>å¾…è¡¥å……</p>
<h3 id="sdp">SDP</h3>
<p>SDPæ˜¯ä¸€ä¸ªæ¯”è¾ƒè€çš„åè®®ï¼Œå‘å¸ƒäº2006å¹´ï¼Œä»¥type=valueçš„æ ¼å¼æè¿°å›è¯å†…å®¹ã€‚WebRTCå¼•å…¥SDPæ¥æè¿°åª’ä½“ä¿¡æ¯ï¼Œç”¨äºåª’ä½“åå•†æ—¶å†³å®šåŒæ–¹æ˜¯å¦å¯ä»¥è¿›è¡Œé€šä¿¡ã€‚å½“å¯¹ç«¯è®¾å¤‡anserçš„æ—¶å€™ä¼šæºå¸¦ä¸€ä¸ªSDPæ ¼å¼çš„å†…å®¹ï¼Œå¦‚ä¸‹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">v</span><span class="o">=</span><span class="mi">0</span>
<span class="n">o</span><span class="o">=-</span><span class="w"> </span><span class="mi">8646007345366799659</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">127.0.0.1</span>
<span class="n">s</span><span class="o">=-</span>
<span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span>
<span class="n">a</span><span class="o">=</span><span class="n">group</span><span class="o">:</span><span class="n">BUNDLE</span><span class="w"> </span><span class="n">video</span><span class="w"> </span><span class="n">audio</span><span class="w"> </span><span class="n">datachannel</span>
<span class="n">a</span><span class="o">=</span><span class="n">msid</span><span class="o">-</span><span class="n">semantic</span><span class="o">:</span><span class="w"> </span><span class="n">WMS</span><span class="w"> </span><span class="mi">5</span><span class="n">a162afd</span><span class="o">-</span><span class="n">e195</span><span class="mi">-4207</span><span class="o">-</span><span class="n">a699</span><span class="o">-</span><span class="n">e977bb510327</span>
<span class="n">m</span><span class="o">=</span><span class="n">video</span><span class="w"> </span><span class="mi">10773</span><span class="w"> </span><span class="n">UDP</span><span class="o">/</span><span class="n">TLS</span><span class="o">/</span><span class="n">RTP</span><span class="o">/</span><span class="n">SAVPF</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="mi">102</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">14.29.67.186</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">:</span><span class="mi">9</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">0.0.0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">candidate</span><span class="o">:</span><span class="mi">1969734079</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">udp</span><span class="w"> </span><span class="mi">2122260223</span><span class="w"> </span><span class="mf">192.168.31.123</span><span class="w"> </span><span class="mi">65492</span><span class="w"> </span><span class="n">typ</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="n">generation</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">network</span><span class="o">-</span><span class="n">id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">network</span><span class="o">-</span><span class="n">cost</span><span class="w"> </span><span class="mi">10</span>
<span class="n">a</span><span class="o">=</span><span class="n">candidate</span><span class="o">:</span><span class="mi">2345473323</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">tcp</span><span class="w"> </span><span class="mi">1518280447</span><span class="w"> </span><span class="mf">192.168.31.123</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">typ</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="n">tcptype</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="n">generation</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">network</span><span class="o">-</span><span class="n">id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">network</span><span class="o">-</span><span class="n">cost</span><span class="w"> </span><span class="mi">10</span>
<span class="n">a</span><span class="o">=</span><span class="n">candidate</span><span class="o">:</span><span class="mi">3819939686</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">udp</span><span class="w"> </span><span class="mi">1686052607</span><span class="w"> </span><span class="mf">14.29.67.186</span><span class="w"> </span><span class="mi">10773</span><span class="w"> </span><span class="n">typ</span><span class="w"> </span><span class="n">srflx</span><span class="w"> </span><span class="n">raddr</span><span class="w"> </span><span class="mf">192.168.31.123</span><span class="w"> </span><span class="n">rport</span><span class="w"> </span><span class="mi">65492</span><span class="w"> </span><span class="n">generation</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">network</span><span class="o">-</span><span class="n">id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">network</span><span class="o">-</span><span class="n">cost</span><span class="w"> </span><span class="mi">10</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="o">:</span><span class="n">JgBs</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="o">:</span><span class="mi">1U</span><span class="n">SyOciE2u1Uzq97tWIhcx7v</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">options</span><span class="o">:</span><span class="n">trickle</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="o">:</span><span class="n">sha</span><span class="mi">-256</span><span class="w"> </span><span class="n">C1</span><span class="o">:</span><span class="mf">6F</span><span class="o">:</span><span class="mi">4</span><span class="n">D</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">6</span><span class="n">E</span><span class="o">:</span><span class="mi">99</span><span class="o">:</span><span class="n">AC</span><span class="o">:</span><span class="mi">9</span><span class="n">C</span><span class="o">:</span><span class="mf">5F</span><span class="o">:</span><span class="n">CD</span><span class="o">:</span><span class="mi">24</span><span class="o">:</span><span class="n">C8</span><span class="o">:</span><span class="n">A5</span><span class="o">:</span><span class="mi">83</span><span class="o">:</span><span class="mi">75</span><span class="o">:</span><span class="n">AE</span><span class="o">:</span><span class="mi">45</span><span class="o">:</span><span class="mi">1</span><span class="n">A</span><span class="o">:</span><span class="n">D4</span><span class="o">:</span><span class="mi">7</span><span class="n">D</span><span class="o">:</span><span class="n">E0</span><span class="o">:</span><span class="mi">73</span><span class="o">:</span><span class="n">B6</span><span class="o">:</span><span class="mi">0</span><span class="n">A</span><span class="o">:</span><span class="mi">67</span><span class="o">:</span><span class="mi">4</span><span class="n">E</span><span class="o">:</span><span class="n">ED</span><span class="o">:</span><span class="n">C3</span><span class="o">:</span><span class="mi">88</span><span class="o">:</span><span class="n">C2</span><span class="o">:</span><span class="mi">6</span><span class="n">C</span><span class="o">:</span><span class="mi">42</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="o">:</span><span class="n">active</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="o">:</span><span class="n">video</span>
<span class="n">a</span><span class="o">=</span><span class="n">recvonly</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">mux</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtpmap</span><span class="o">:</span><span class="mi">96</span><span class="w"> </span><span class="n">H264</span><span class="o">/</span><span class="mi">90000</span>
<span class="n">a</span><span class="o">=</span><span class="n">fmtp</span><span class="o">:</span><span class="mi">96</span><span class="w"> </span><span class="n">level</span><span class="o">-</span><span class="n">asymmetry</span><span class="o">-</span><span class="n">allowed</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">packetization</span><span class="o">-</span><span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">profile</span><span class="o">-</span><span class="n">level</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mf">42e01f</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtpmap</span><span class="o">:</span><span class="mi">102</span><span class="w"> </span><span class="n">H264</span><span class="o">/</span><span class="mi">90000</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">fb</span><span class="o">:</span><span class="mi">102</span><span class="w"> </span><span class="n">nack</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">fb</span><span class="o">:</span><span class="mi">102</span><span class="w"> </span><span class="n">nack</span><span class="w"> </span><span class="n">pli</span>
<span class="n">a</span><span class="o">=</span><span class="n">fmtp</span><span class="o">:</span><span class="mi">102</span><span class="w"> </span><span class="n">level</span><span class="o">-</span><span class="n">asymmetry</span><span class="o">-</span><span class="n">allowed</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">packetization</span><span class="o">-</span><span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">profile</span><span class="o">-</span><span class="n">level</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mf">42e01f</span>
<span class="n">m</span><span class="o">=</span><span class="n">audio</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">UDP</span><span class="o">/</span><span class="n">TLS</span><span class="o">/</span><span class="n">RTP</span><span class="o">/</span><span class="n">SAVP</span><span class="w"> </span><span class="mi">8</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">0.0.0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">:</span><span class="mi">9</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">0.0.0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="o">:</span><span class="n">JgBs</span><span class="w"> </span><span class="c1">//å¯¹ç«¯ç”¨æˆ·å</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="o">:</span><span class="mi">1U</span><span class="n">SyOciE2u1Uzq97tWIhcx7v</span><span class="w"> </span><span class="c1">//å¯¹ç«¯çš„å¯†ç </span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">options</span><span class="o">:</span><span class="n">trickle</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="o">:</span><span class="n">sha</span><span class="mi">-256</span><span class="w"> </span><span class="n">C1</span><span class="o">:</span><span class="mf">6F</span><span class="o">:</span><span class="mi">4</span><span class="n">D</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">6</span><span class="n">E</span><span class="o">:</span><span class="mi">99</span><span class="o">:</span><span class="n">AC</span><span class="o">:</span><span class="mi">9</span><span class="n">C</span><span class="o">:</span><span class="mf">5F</span><span class="o">:</span><span class="n">CD</span><span class="o">:</span><span class="mi">24</span><span class="o">:</span><span class="n">C8</span><span class="o">:</span><span class="n">A5</span><span class="o">:</span><span class="mi">83</span><span class="o">:</span><span class="mi">75</span><span class="o">:</span><span class="n">AE</span><span class="o">:</span><span class="mi">45</span><span class="o">:</span><span class="mi">1</span><span class="n">A</span><span class="o">:</span><span class="n">D4</span><span class="o">:</span><span class="mi">7</span><span class="n">D</span><span class="o">:</span><span class="n">E0</span><span class="o">:</span><span class="mi">73</span><span class="o">:</span><span class="n">B6</span><span class="o">:</span><span class="mi">0</span><span class="n">A</span><span class="o">:</span><span class="mi">67</span><span class="o">:</span><span class="mi">4</span><span class="n">E</span><span class="o">:</span><span class="n">ED</span><span class="o">:</span><span class="n">C3</span><span class="o">:</span><span class="mi">88</span><span class="o">:</span><span class="n">C2</span><span class="o">:</span><span class="mi">6</span><span class="n">C</span><span class="o">:</span><span class="mi">42</span><span class="w"> </span><span class="c1">//æŒ‡çº¹ä¿¡æ¯</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="o">:</span><span class="n">active</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="o">:</span><span class="n">audio</span>
<span class="n">a</span><span class="o">=</span><span class="n">sendrecv</span>
<span class="n">a</span><span class="o">=</span><span class="n">msid</span><span class="o">:</span><span class="mi">5</span><span class="n">a162afd</span><span class="o">-</span><span class="n">e195</span><span class="mi">-4207</span><span class="o">-</span><span class="n">a699</span><span class="o">-</span><span class="n">e977bb510327</span><span class="w"> </span><span class="mi">693</span><span class="n">effe8</span><span class="o">-</span><span class="n">ba8d</span><span class="mi">-469</span><span class="n">d</span><span class="o">-</span><span class="n">ba6a</span><span class="o">-</span><span class="n">f58e2b5f73df</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">mux</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtpmap</span><span class="o">:</span><span class="mi">8</span><span class="w"> </span><span class="n">PCMA</span><span class="o">/</span><span class="mi">8000</span>
<span class="n">a</span><span class="o">=</span><span class="n">ssrc</span><span class="o">:</span><span class="mi">1668486723</span><span class="w"> </span><span class="n">cname</span><span class="o">:</span><span class="n">o</span><span class="o">+</span><span class="n">PtcUckwEIRvBPp</span>
<span class="n">m</span><span class="o">=</span><span class="n">application</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">UDP</span><span class="o">/</span><span class="n">DTLS</span><span class="o">/</span><span class="n">SCTP</span><span class="w"> </span><span class="n">webrtc</span><span class="o">-</span><span class="n">datachannel</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">0.0.0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="o">:</span><span class="n">JgBs</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="o">:</span><span class="mi">1U</span><span class="n">SyOciE2u1Uzq97tWIhcx7v</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">options</span><span class="o">:</span><span class="n">trickle</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="o">:</span><span class="n">sha</span><span class="mi">-256</span><span class="w"> </span><span class="n">C1</span><span class="o">:</span><span class="mf">6F</span><span class="o">:</span><span class="mi">4</span><span class="n">D</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">6</span><span class="n">E</span><span class="o">:</span><span class="mi">99</span><span class="o">:</span><span class="n">AC</span><span class="o">:</span><span class="mi">9</span><span class="n">C</span><span class="o">:</span><span class="mf">5F</span><span class="o">:</span><span class="n">CD</span><span class="o">:</span><span class="mi">24</span><span class="o">:</span><span class="n">C8</span><span class="o">:</span><span class="n">A5</span><span class="o">:</span><span class="mi">83</span><span class="o">:</span><span class="mi">75</span><span class="o">:</span><span class="n">AE</span><span class="o">:</span><span class="mi">45</span><span class="o">:</span><span class="mi">1</span><span class="n">A</span><span class="o">:</span><span class="n">D4</span><span class="o">:</span><span class="mi">7</span><span class="n">D</span><span class="o">:</span><span class="n">E0</span><span class="o">:</span><span class="mi">73</span><span class="o">:</span><span class="n">B6</span><span class="o">:</span><span class="mi">0</span><span class="n">A</span><span class="o">:</span><span class="mi">67</span><span class="o">:</span><span class="mi">4</span><span class="n">E</span><span class="o">:</span><span class="n">ED</span><span class="o">:</span><span class="n">C3</span><span class="o">:</span><span class="mi">88</span><span class="o">:</span><span class="n">C2</span><span class="o">:</span><span class="mi">6</span><span class="n">C</span><span class="o">:</span><span class="mi">42</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="o">:</span><span class="n">active</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="o">:</span><span class="n">datachannel</span>
<span class="n">a</span><span class="o">=</span><span class="n">sctp</span><span class="o">-</span><span class="n">port</span><span class="o">:</span><span class="mi">5000</span>
<span class="n">a</span><span class="o">=</span><span class="n">max</span><span class="o">-</span><span class="n">message</span><span class="o">-</span><span class="n">size</span><span class="o">:</span><span class="mi">262144</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/11/wp_editor_md_4e536c4a676939b88584506dc737e399.jpg"><img alt="" src="assets/doc/08-ç½‘ç»œ/libpeeråˆ†æ/images/wp_editor_md_4e536c4a676939b88584506dc737e399.jpg"/></a></p>
<h3 id="ice-candidates">ICE candidates</h3>
<p>ICE (Interactive Connectivity Establishment äº’åŠ¨è¿æ¥å»ºç«‹ï¼‰ candidatesï¼ˆå€™é€‰äººï¼‰ç®€ç§°ICE candidatesï¼ŒWebRTCä¸­çš„ICE Candidateæ˜¯ç”¨æ¥æè¿°å¯ä»¥è¿æ¥çš„è¿œç«¯çš„åŸºæœ¬ä¿¡æ¯ï¼Œä»€ä¹ˆæ˜¯candidateï¼Œä¸¤å°è®¾å¤‡çš„è¿æ¥ï¼Œéœ€è¦çŸ¥é“è®¾å¤‡çš„ç½‘ç»œä¿¡æ¯ï¼Œå¦‚IPåœ°å€ï¼Œç«¯å£å·ä»¥åŠä½¿ç”¨çš„åè®®ï¼Œå› æ­¤candidateè‡³å°‘åŒ…å«{addressï¼Œportï¼Œprotocol}ä¸‰å…ƒç»„ä¿¡æ¯é›†ã€‚é€šè¿‡SDPä¼šè¯æ¥äº¤äº’candidateä¿¡æ¯ã€‚</p>
<p>WebRTCå°†Candidateåˆ†æˆå››ç§ç±»å‹ï¼Œä¸”ç±»å‹é—´å­˜åœ¨ä¼˜å…ˆçº§æ¬¡åºï¼Œä»é«˜åˆ°ä½åˆ†åˆ«ä¸ºhostã€srflxã€prflxå’Œrelayï¼Œæœ¬ç« èŠ‚ä½¿ç”¨çš„æ˜¯srflxç±»å‹ï¼Œä»STUNæœåŠ¡å™¨è·å–çš„åœ°å€ã€‚</p>
<ul>
<li>hostï¼šä»æœ¬æœºç½‘å¡ä¸Šè·å–åˆ°çš„åœ°å€ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªç½‘å¡å¯¹åº”ä¸€ä¸ªåœ°å€ã€‚</li>
<li>srflxï¼ˆserver reflexiveï¼‰ï¼šä»STUNæœåŠ¡å™¨è·å–åˆ°çš„åœ°å€ã€‚</li>
<li>relayï¼šä»TRUNæœåŠ¡å™¨è·å–åˆ°çš„åœ°å€ã€‚</li>
<li>prflxï¼ˆpeer reflexiveï¼‰ï¼šåœ¨äº¤äº’è¿‡ç¨‹ä¸­ä»å¯¹ç«¯æ•°æ®æŠ¥æ–‡ä¸­è·å–åˆ°çš„åœ°å€ã€‚</li>
</ul>
<p>å…¶ä¸­ï¼Œsrflxå’Œprflxåœ°å€å¯èƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†è·å–çš„é€”å¾„ä¸ä¸€æ ·ï¼Œä¸‹é¢æ˜¯æè¿°ICE candidatesçš„æ•°æ®ç»“æ„ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">IceCandidateType</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="n">ICE_CANDIDATE_TYPE_HOST</span><span class="p">,</span>
<span class="w">  </span><span class="n">ICE_CANDIDATE_TYPE_SRFLX</span><span class="p">,</span>
<span class="w">  </span><span class="n">ICE_CANDIDATE_TYPE_PRFLX</span><span class="p">,</span>
<span class="w">  </span><span class="n">ICE_CANDIDATE_TYPE_RELAY</span><span class="p">,</span>

<span class="p">}</span><span class="w"> </span><span class="n">IceCandidateType</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">IceCandidate</span><span class="w"> </span><span class="n">IceCandidate</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">IceCandidate</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">foundation</span><span class="p">;</span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">component</span><span class="p">;</span><span class="w"> </span><span class="c1">//1ï¼šRTP,2ï¼šRTCP</span>

<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">priority</span><span class="p">;</span><span class="c1">//ä¼˜å…ˆçº§</span>

<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">transport</span><span class="p">[</span><span class="mi">32</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w">  </span><span class="c1">//ä¼ è¾“åè®®ï¼ŒåŸºäºUDP</span>

<span class="w">  </span><span class="n">IceCandidateType</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"> </span><span class="c1">//ç±»å‹ï¼Œå¦‚ä¸Šã€‚</span>

<span class="w">  </span><span class="n">IceCandidateState</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>

<span class="w">  </span><span class="n">Address</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>

<span class="w">  </span><span class="n">Address</span><span class="w"> </span><span class="n">raddr</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h2 id="main">mainå‡½æ•°åˆ†æ</h2>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="cm">/*1. è°ƒç”¨srtp_initï¼Œåˆå§‹åŒ–srtpå†…æ ¸æ¨¡å—åŠ å¯†å¥—ä»¶ã€debugç­‰*/</span>
<span class="w">  </span><span class="n">peer_init</span><span class="p">();</span>

<span class="w">  </span><span class="cm">/*2. åˆ›å»ºä¸€ä¸ªpeerè¿æ¥ï¼Œå…¶ä¸­åˆ›å»ºäº†agentï¼Œæ‰“å¼€äº†ä¸€ä¸ªudp socketï¼Œåˆå§‹åŒ–</span>
<span class="cm">   äº†rtp éŸ³é¢‘ã€è§†é¢‘ç¼–è§£ç ï¼Œä¸»è¦æ˜¯ç¡®å®šç”¨ä»€ä¹ˆç¼–ç æ ¼å¼ã€‚*/</span>
<span class="w">  </span><span class="n">g_pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">peer_connection_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/*3. æ³¨å†Œä¸€ä¸ªpeerè¿æ¥çš„çŠ¶æ€åˆ‡æ¢å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•° onconnectionstatechangeï¼Œ</span>
<span class="cm">  ç”¨äºå¤„ç†å¯¹ç­‰è¿æ¥çš„ ICE è¿æ¥çŠ¶æ€å˜æ›´ã€‚å½“è¿æ¥çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ˆä¾‹å¦‚ä»newåˆ°connectedï¼Œ</span>
<span class="cm">  æˆ–è€… failedï¼‰ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°å°†è¢«è°ƒç”¨ã€‚*/</span>
<span class="w">  </span><span class="n">peer_connection_oniceconnectionstatechange</span><span class="p">(</span><span class="n">g_pc</span><span class="p">,</span><span class="w"> </span><span class="n">onconnectionstatechange</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/*4. è®¾ç½®æ•°æ®é€šé“ï¼ˆDataChannelï¼‰ç›¸å…³çš„å›è°ƒå‡½æ•°ã€‚å½“æ•°æ®é€šé“æ‰“å¼€æ—¶ï¼Œä¼šè§¦å‘</span>
<span class="cm">   onopenï¼›æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œä¼šè§¦å‘ onmessageï¼›å½“æ•°æ®é€šé“å…³é—­æ—¶ä¼šè§¦å‘onclose*/</span>
<span class="w">  </span><span class="n">peer_connection_ondatachannel</span><span class="p">(</span><span class="n">g_pc</span><span class="p">,</span><span class="w"> </span><span class="n">onmessage</span><span class="p">,</span><span class="w"> </span><span class="n">onopen</span><span class="p">,</span><span class="w"> </span><span class="n">onclose</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/*5. è®¾ç½®ä¿¡ä»¤æœåŠ¡å™¨çš„é…ç½®ï¼Œé€šå¸¸ç”¨äº WebRTC ä¼šè¯ä¸­çš„ä¿¡ä»¤éƒ¨åˆ†ã€‚é€šè¿‡ä¼ å…¥</span>
<span class="cm">   service_config é…ç½®ï¼ŒWebRTC å®¢æˆ·ç«¯å¯ä»¥å‘ä¿¡ä»¤æœåŠ¡å™¨æ³¨å†Œæˆ–ä¼ é€’é…ç½®ä¿¡æ¯</span>
<span class="cm">  ï¼ˆå¦‚ client_id å’Œå¯¹ç­‰è¿æ¥å¥æŸ„ pcï¼‰</span>
<span class="cm">   è¿™é‡Œçš„ä¿¡ä»¤æœåŠ¡å™¨ç”¨çš„æ˜¯å…¬ç”¨çš„mqttæœåŠ¡å™¨ï¼Ÿ broker.emqx.io</span>
<span class="cm">   ä½¿ç”¨mqttæ¥ä½œä¸ºä¿¡ä»¤é€šä¿¡ï¼Œæ²¡æœ‰ä½¿ç”¨httpï¼Œåœ¨é‡Œé¢ä¼šæ³¨å†Œä¸€ä¸ªpeer_connectçš„å€™é€‰å›è°ƒ</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="cm">/*ä»€ä¹ˆæ˜¯ä¿¡ä»¤</span>
<span class="cm">   åœ¨webrtcä¸­ï¼Œä¿¡ä»¤æŒ‡çš„æ˜¯å»ºç«‹å’Œç®¡ç†ç‚¹å¯¹ç‚¹è¿æ¥è¿‡ç¨‹ä¸­çš„æ§åˆ¶æ¶ˆæ¯äº¤æ¢æœºåˆ¶ã€‚è®©é€šä¿¡åŒæ–¹</span>
<span class="cm">   èƒ½å¤Ÿäº¤æ¢å„ç§ä¿¡æ¯ï¼Œä»è€Œå»ºç«‹ã€ç»´æŠ¤å’Œç»ˆæ­¢ä¸€ä¸ªç‚¹å¯¹ç‚¹çš„å®æ—¶é€šä¿¡è¿æ¥ã€‚</span>
<span class="cm">   WebRTC çš„æ ¸å¿ƒç›®æ ‡æ˜¯å®ç°æµè§ˆå™¨ä¹‹é—´çš„ç›´æ¥é€šä¿¡ï¼Œæ”¯æŒéŸ³é¢‘ã€è§†é¢‘å’Œæ•°æ®ä¼ è¾“ï¼Œ</span>
<span class="cm">   ä½†åœ¨å»ºç«‹è¿™ç§è¿æ¥ä¹‹å‰ï¼ŒåŒæ–¹éœ€è¦äº¤æ¢ä¸€äº›æ§åˆ¶ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š</span>
<span class="cm">     - ä¼šè¯æè¿°ï¼ˆå¦‚ SDPï¼ŒSession Description Protocolï¼‰ï¼šæè¿°è¿æ¥çš„åª’ä½“è®¾ç½®ï¼ˆå¦‚è§†é¢‘ç¼–ç æ ¼å¼ã€éŸ³é¢‘å‚æ•°ç­‰ï¼‰ã€‚</span>
<span class="cm">     - ç½‘ç»œå€™é€‰ï¼ˆICEå€™é€‰ï¼ŒICE candidatesï¼‰ï¼šç”¨äºå¯»æ‰¾æœ€ä½³çš„ç‚¹å¯¹ç‚¹ç½‘ç»œè·¯å¾„ï¼Œä»¥ç¡®ä¿å³ä½¿åœ¨å¤æ‚çš„ç½‘ç»œç¯å¢ƒä¸‹ä¹Ÿèƒ½å»ºç«‹è¿æ¥ã€‚Interactive Connectivity Establishmentï¼ˆäº’åŠ¨è¿æ¥å»ºç«‹ï¼‰</span>
<span class="cm">     - è¿æ¥çŠ¶æ€ï¼šä¾‹å¦‚è¿æ¥æ˜¯å¦å·²å»ºç«‹ã€æ˜¯å¦å…³é—­ç­‰ã€‚</span>
<span class="cm">   */</span>
<span class="w">   </span><span class="cm">/*ä¿¡ä»¤çš„å®ç°</span>
<span class="cm">   è™½ç„¶ WebRTC åè®®æœ¬èº«å¹¶æ²¡æœ‰æŒ‡å®šä¿¡ä»¤çš„å®ç°æ–¹å¼ï¼Œä½†æ˜¯å®ƒæä¾›äº†ç”¨äºäº¤æ¢æ•°æ®çš„ APIã€‚</span>
<span class="cm">   å¼€å‘è€…å¯ä»¥é€‰æ‹©é€‚åˆè‡ªå·±çš„ä¿¡ä»¤åè®®å’Œä¼ è¾“æ–¹å¼ï¼Œé€šå¸¸çš„å®ç°æ–¹å¼åŒ…æ‹¬ï¼š</span>
<span class="cm">    - WebSocketï¼šä¸€ä¸ªå¸¸è§çš„åŒå‘é€šä¿¡åè®®ï¼Œå¯ä»¥å®æ—¶åœ°äº¤æ¢ä¿¡ä»¤æ•°æ®ã€‚</span>
<span class="cm">    - HTTP è¯·æ±‚ï¼šé€šè¿‡è½®è¯¢ã€é•¿è½®è¯¢ç­‰æ–¹å¼è¿›è¡Œä¿¡ä»¤äº¤æ¢ã€‚</span>
<span class="cm">    - SIP (Session Initiation Protocol)ï¼šä¸€äº›åº”ç”¨å¯èƒ½é‡‡ç”¨ SIP ä½œä¸ºä¿¡ä»¤åè®®ã€‚</span>
<span class="cm">    - XMPP (Extensible Messaging and Presence Protocol)ï¼šä¹Ÿæ˜¯ä¸€ç§å¯ä»¥ç”¨æ¥å®ç°ä¿¡ä»¤çš„åè®®ï¼Œå°¤å…¶é€‚ç”¨äºå³æ—¶æ¶ˆæ¯å’Œé€šä¿¡åº”ç”¨ã€‚</span>
<span class="cm">    - MQTTï¼šé€šè¿‡è®¢é˜…å’Œå‘å¸ƒçš„æ–¹å¼æ¥è¿›è¡Œä¼ è¾“ï¼Œæœ¬æ–‡å°±æ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚</span>
<span class="cm">   */</span>

<span class="w">   </span><span class="cm">/*ä¿¡ä»¤çš„å·¥ä½œæµç¨‹</span>
<span class="cm">    å‡è®¾æœ‰ä¸¤ä¸ªç”¨æˆ· A å’Œ B é€šè¿‡ WebRTC å»ºç«‹è§†é¢‘é€šè¯ï¼Œä¿¡ä»¤çš„è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</span>
<span class="cm">    (1) ç”¨æˆ·Aç”Ÿæˆofferï¼šç”¨ Aåˆ›å»ºä¸€ä¸ª RTCPeerConnection å¯¹è±¡ï¼Œå¹¶</span>
<span class="cm">        ç”Ÿæˆä¸€ä¸ªofferã€‚è¿™ä¸ª offer åŒ…å«äº† A çš„åª’ä½“è®¾ç½®å’Œç½‘ç»œå€™é€‰ä¿¡æ¯ï¼ˆICE å€™é€‰ï¼‰ã€‚</span>
<span class="cm">        A å°†è¿™ä¸ª offer é€šè¿‡ä¿¡ä»¤ç³»ç»Ÿï¼ˆä¾‹å¦‚ MQTTï¼‰å‘é€ç»™ç”¨æˆ· Bã€‚</span>
<span class="cm">    (2)ç”¨æˆ·Bæ¥æ”¶åˆ° offerï¼Œå¹¶ç”Ÿæˆ answerï¼šç”¨æˆ· B æ”¶åˆ° offer åï¼Œä½¿ç”¨å®ƒæ¥åˆ›</span>
<span class="cm">        å»ºä¸€ä¸ª RTCPeerConnectionï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª answerï¼ˆåº”ç­”ï¼‰ã€‚è¿™ä¸ª answer åŒ…å« B</span>
<span class="cm">        çš„åª’ä½“é…ç½®å’Œ ICE å€™é€‰ä¿¡æ¯ã€‚B å°† answer é€šè¿‡ä¿¡ä»¤ç³»ç»Ÿå‘é€ç»™ç”¨æˆ· Aã€‚</span>
<span class="cm">    (3)äº¤æ¢ ICE å€™é€‰ï¼šåœ¨è¿æ¥è¿‡ç¨‹ä¸­ï¼ŒåŒæ–¹éƒ½ä¼šæ”¶é›†åˆ° ICE å€™é€‰å¹¶é€šè¿‡ä¿¡ä»¤è¿›è¡Œäº¤æ¢ï¼Œ</span>
<span class="cm">        ç›´åˆ°åŒæ–¹éƒ½ç¡®å®šäº†æœ€ä½³çš„ç½‘ç»œè·¯å¾„ã€‚</span>
<span class="cm">    (4)å»ºç«‹è¿æ¥ï¼šå½“åŒæ–¹å®Œæˆäº† ICE å€™é€‰äº¤æ¢å¹¶ä¸”å»ºç«‹äº†è¿æ¥æ—¶ï¼Œé€šä¿¡å°±å¯ä»¥å¼€å§‹äº†ã€‚</span>
<span class="cm">    (5)è¿æ¥ç»ˆæ­¢ï¼šå½“ä¼šè¯ç»“æŸæ—¶ï¼ŒåŒæ–¹é€šè¿‡ä¿¡ä»¤é€šçŸ¥å¯¹æ–¹å…³é—­è¿æ¥ã€‚*/</span>

<span class="w">  </span><span class="n">service_config</span><span class="p">.</span><span class="n">client_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">  </span><span class="n">service_config</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_pc</span><span class="p">;</span>
<span class="w">  </span><span class="n">peer_signaling_set_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">service_config</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/*6.åˆå§‹åŒ–MQTTï¼Œè¿æ¥broker.emqx.ioï¼Œ */</span>
<span class="w">  </span><span class="n">peer_signaling_join_channel</span><span class="p">();</span>

<span class="w">  </span><span class="cm">/*7. åˆ›å»ºpeerè¿æ¥çš„task*/</span>
<span class="w">  </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peer_connection_thread</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">peer_connection_task</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/*8. åˆ›å»ºsignalçš„task*/</span>
<span class="w">  </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peer_singaling_thread</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">peer_singaling_task</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/*9. è¯»å–æœ¬åœ°éŸ³è§†é¢‘åˆå§‹åŒ–*/</span>
<span class="w">  </span><span class="n">reader_init</span><span class="p">();</span>

<span class="w">  </span><span class="cm">/*10. å¾ªç¯åˆ¤æ–­PEERçš„çŠ¶æ€æ˜¯å¦æ˜¯è¿æ¥æ€ï¼Œå¦‚æœæ˜¯å·²ç»è¿æ¥ï¼Œåˆ™å‘é€éŸ³è§†é¢‘æ•°æ®*/</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">g_interrupted</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">g_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PEER_CONNECTION_COMPLETED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">curr_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_timestamp</span><span class="p">();</span>

<span class="w">      </span><span class="c1">// FPS 25</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">video_time</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">video_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr_time</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reader_get_video_frame</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">peer_connection_send_video</span><span class="p">(</span><span class="n">g_pc</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">audio_time</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reader_get_audio_frame</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">peer_connection_send_audio</span><span class="p">(</span><span class="n">g_pc</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">audio_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr_time</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="n">usleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<h2 id="_5">ä¿¡ä»¤äº¤äº’</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">peer_signaling_join_channel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/*1. ä¸ä¿¡ä»¤æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œå®é™…ä¸Šå°±æ˜¯è¿æ¥MQTTçš„broker*/</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">peer_signaling_mqtt_connect</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_host</span><span class="p">,</span><span class="w"> </span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_port</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LOGW</span><span class="p">(</span><span class="s">"Connect MQTT server failed"</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/*1. å‘å¸ƒä¿¡ä»¤çš„æ¶ˆæ¯*/</span>
<span class="w">  </span><span class="n">peer_signaling_mqtt_subscribe</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_6">ä¸ä¿¡ä»¤æœåŠ¡å™¨å»ºç«‹è¿æ¥</h3>
<p>å› ä¸ºä¸MQTT broker.emqx.ioçš„äº¤äº’æ˜¯TLSåŠ è§£å¯†çš„ï¼Œå› æ­¤å…ˆä½¿ç”¨ssl_transport_connectå»ºç«‹åŠ è§£å¯†é€šé“ï¼Œæ¥ç€å¯¹MQTTè¿›è¡Œåˆå§‹åŒ–ï¼Œå°†sslçš„æ”¶å‘å‡½æ•°æ³¨å†Œåˆ°MQTTä¸­ï¼Œè¿™æ ·MQTTåç»­çš„å°±å¯ä»¥ç”¨SSLçš„åŠ è§£å¯†é€šé“è¿›è¡Œé€šä¿¡ï¼Œæœ€åæ˜¯å‘èµ·MQTTè¿æ¥ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">peer_signaling_mqtt_connect</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">hostname</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">MQTTStatus_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">  </span><span class="n">MQTTConnectInfo_t</span><span class="w"> </span><span class="n">conn_info</span><span class="p">;</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">session_present</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/*1. ä¸mqttçš„brokerï¼Œå…¶host="broker.emqx.io"ï¼Œport=8883å»ºç«‹TLSè¿æ¥ï¼ŒMQTTçš„æ”¶å‘æ¶ˆæ¯</span>
<span class="cm">   æ˜¯å¦é€šè¿‡åŠ å¯†çš„æ–¹å¼ï¼Œå› æ­¤éœ€è¦å…ˆä½¿ç”¨TLSè¿›è¡Œè¿æ¥*/</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ssl_transport_connect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_ps</span><span class="p">.</span><span class="n">net_ctx</span><span class="p">,</span><span class="w"> </span><span class="n">hostname</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LOGE</span><span class="p">(</span><span class="s">"ssl transport connect failed"</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="cm">/*2. sslå»ºç«‹è¿æ¥ä¹‹åï¼Œå°†å‘é€å’Œæ¥æ”¶çš„å‡½æ•°é€šè¿‡MQTT_Initè¿›è¡Œæ³¨å†Œï¼Œåç»­å…¶æ”¶å‘å°±ä¼šè°ƒ</span>
<span class="cm">    è°ƒç”¨ssl_transport_recvå’Œssl_transport_sendè¿›è¡Œè§£åŠ å¯†æ”¶å‘ã€‚</span>
<span class="cm">    MQTT_Initåˆå§‹åŒ–æ—¶è¿˜æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œ å¯¹CONNACK/PUBLISH/SUBACKäº‹ä»¶è¿›å¤„ç†</span>
<span class="cm">    éœ€è¦æ³¨æ„çš„æ—¶ï¼Œå½“è®¾å¤‡æ”¶åˆ°brokerå‘è¿‡æ¥çš„PUBLISHäº‹ä»¶æ—¶ï¼Œä¼šå›è°ƒè¿™ä¸ªå‡½æ•°è¿›è¡Œ</span>
<span class="cm">    å¤„ç†ï¼Œè¿™æ ·çš„åœºæ™¯æ˜¯å½“å¯¹ç«¯è®¾å¤‡è®¿é—®è¿æ¥æ˜¯ï¼Œå°±ä¼šè°ƒç”¨peer_signaling_mqtt_event_cbã€‚*/</span>
<span class="w">  </span><span class="n">g_ps</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="n">recv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ssl_transport_recv</span><span class="p">;</span>
<span class="w">  </span><span class="n">g_ps</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="n">send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ssl_transport_send</span><span class="p">;</span>
<span class="w">  </span><span class="n">g_ps</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="n">pNetworkContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">g_ps</span><span class="p">.</span><span class="n">net_ctx</span><span class="p">;</span>
<span class="w">  </span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_fixed_buf</span><span class="p">.</span><span class="n">pBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_buf</span><span class="p">;</span>
<span class="w">  </span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_fixed_buf</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_buf</span><span class="p">);</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MQTT_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">g_ps</span><span class="p">.</span><span class="n">transport</span><span class="p">,</span>
<span class="w">                     </span><span class="n">ports_get_epoch_time</span><span class="p">,</span><span class="w"> </span><span class="n">peer_signaling_mqtt_event_cb</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_fixed_buf</span><span class="p">);</span>

<span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn_info</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">conn_info</span><span class="p">));</span>

<span class="w">  </span><span class="n">conn_info</span><span class="p">.</span><span class="n">cleanSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">conn_info</span><span class="p">.</span><span class="n">pUserName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_ps</span><span class="p">.</span><span class="n">username</span><span class="p">;</span>
<span class="w">    </span><span class="n">conn_info</span><span class="p">.</span><span class="n">userNameLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">username</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">conn_info</span><span class="p">.</span><span class="n">pPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_ps</span><span class="p">.</span><span class="n">password</span><span class="p">;</span>
<span class="w">    </span><span class="n">conn_info</span><span class="p">.</span><span class="n">passwordLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">password</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">client_id</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">conn_info</span><span class="p">.</span><span class="n">pClientIdentifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_ps</span><span class="p">.</span><span class="n">client_id</span><span class="p">;</span>
<span class="w">    </span><span class="n">conn_info</span><span class="p">.</span><span class="n">clientIdentifierLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">client_id</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">conn_info</span><span class="p">.</span><span class="n">keepAliveSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KEEP_ALIVE_TIMEOUT_SECONDS</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/*3.å»ºç«‹MQTTçš„ï¼ŒMQTTåè®®ä¸brokerè¿æ¥ã€‚å‰é¢æ­¥éª¤1æ˜¯å»ºç«‹SSLè¿æ¥ï¼Œç›¸å½“äºæ˜¯å»ºç«‹äº†åŠ è§£å¯†é€šé“ï¼Œ</span>
<span class="cm">      è€Œè¿™é‡Œæ˜¯å»ºç«‹MQTTçš„åè®®é€šé“ã€‚*/</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MQTT_Connect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_ctx</span><span class="p">,</span>
<span class="w">                        </span><span class="o">&amp;</span><span class="n">conn_info</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">CONNACK_RECV_TIMEOUT_MS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">session_present</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MQTTSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LOGE</span><span class="p">(</span><span class="s">"MQTT_Connect failed: Status=%s."</span><span class="p">,</span><span class="w"> </span><span class="n">MQTT_Status_strerror</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">LOGI</span><span class="p">(</span><span class="s">"MQTT_Connect succeeded."</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_7">é€šçŸ¥ä¿¡ä»¤æœåŠ¡å™¨å·²å‡†å¤‡</h3>
<p>é€šçŸ¥æœåŠ¡å™¨å·²ç»å‡†å¤‡ï¼Œä¸»è¦æ˜¯é€šè¿‡MQTTçš„è®¢é˜…ä¸»é¢˜ä¸º\"webrtc/peer/jsonrpc\"ï¼Œç­‰å¾…æ¥å…¥è®¾å¤‡æ¥å…¥ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">peer_signaling_mqtt_subscribe</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">subscribed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">MQTTStatus_t</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MQTTSuccess</span><span class="p">;</span>
<span class="w">  </span><span class="n">MQTTSubscribeInfo_t</span><span class="w"> </span><span class="n">sub_info</span><span class="p">;</span>
<span class="w">  </span><span class="cm">/*1. è·å–MQTTçš„packet id*/</span>
<span class="w">  </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">packet_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MQTT_GetPacketId</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_ctx</span><span class="p">);</span><span class="err">ã€</span>

<span class="w">  </span><span class="cm">/*2. MQTT QOSä¸º0å³åªå‘ä¸€æ¬¡ï¼Œè®¢é˜…çš„ä¸»é¢˜æ˜¯"webrtc/peer/jsonrpc" */</span>
<span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sub_info</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sub_info</span><span class="p">));</span>
<span class="w">  </span><span class="n">sub_info</span><span class="p">.</span><span class="n">qos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MQTTQoS0</span><span class="p">;</span>
<span class="w">  </span><span class="n">sub_info</span><span class="p">.</span><span class="n">pTopicFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_ps</span><span class="p">.</span><span class="n">subtopic</span><span class="p">;</span>
<span class="w">  </span><span class="n">sub_info</span><span class="p">.</span><span class="n">topicFilterLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">subtopic</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/*3. å‘é€è®¢é˜…æ¶ˆæ¯*/</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subscribed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MQTT_Subscribe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sub_info</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">packet_id</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MQTT_Unsubscribe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sub_info</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">packet_id</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MQTTSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LOGE</span><span class="p">(</span><span class="s">"MQTT_Subscribe failed: Status=%s."</span><span class="p">,</span><span class="w"> </span><span class="n">MQTT_Status_strerror</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="cm">/*4. ç­‰å¾…MQTT è®¢é˜…æ¶ˆæ¯å‘é€æˆåŠŸ*/</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MQTT_ProcessLoop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_ctx</span><span class="p">);</span>
<span class="w">  </span><span class="cm">/* è°ƒç”¨è¯¥å‡½æ•°å®æ—¶å¤„ç†å¾ªç¯æ¥æ”¶æ•°æ®ï¼Œå¹¶è‡ªå®šå‘é€å¿ƒè·³åŒ…ä¿æŒé“¾æ¥ï¼Œå½“æœ‰æ•°æ®åˆ°æ¥æ—¶ï¼Œä¼šè§¦å‘myEventCallbackå›è°ƒå‡½æ•°*/</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MQTTSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LOGE</span><span class="p">(</span><span class="s">"MQTT_ProcessLoop failed: Status=%s."</span><span class="p">,</span><span class="w"> </span><span class="n">MQTT_Status_strerror</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">LOGD</span><span class="p">(</span><span class="s">"MQTT Subscribe/Unsubscribe succeeded."</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_8">æ¥æ”¶ä¿¡ä»¤æœåŠ¡å™¨äº‹ä»¶å¤„ç†</h3>
<p>åœ¨peer_signaling_mqtt_connectå‡½æ•°ä¸­,è°ƒç”¨MQTT_Initåˆå§‹åŒ–æ—¶ï¼Œæ³¨å†Œäº†ä¸€ä¸ªpeer_signaling_mqtt_event_cbå›è°ƒå‡½æ•°ï¼Œå…¶å¯¹æ¥æ”¶çš„MQTTæ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼ŒåŒ…æ‹¬æ”¶åˆ°äº†Brokerå‘è¿‡æ¥çš„PUBLISHæ¶ˆæ¯ï¼Œå› æ­¤å½“è®¾å¤‡æ¥å…¥æ—¶ï¼Œè°ƒç”¨çš„æ˜¯peer_signaling_mqtt_event_cbå‡½æ•°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">peer_signaling_mqtt_event_cb</span><span class="p">(</span><span class="n">MQTTContext_t</span><span class="o">*</span><span class="w"> </span><span class="n">mqtt_ctx</span><span class="p">,</span>
<span class="w">                                         </span><span class="n">MQTTPacketInfo_t</span><span class="o">*</span><span class="w"> </span><span class="n">packet_info</span><span class="p">,</span>
<span class="w">                                         </span><span class="n">MQTTDeserializedInfo_t</span><span class="o">*</span><span class="w"> </span><span class="n">deserialized_info</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">packet_info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">MQTT_PACKET_TYPE_CONNACK</span><span class="p">:</span>
<span class="w">      </span><span class="n">LOGI</span><span class="p">(</span><span class="s">"MQTT_PACKET_TYPE_CONNACK"</span><span class="p">);</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">MQTT_PACKET_TYPE_PUBLISH</span><span class="p">:</span>
<span class="w">      </span><span class="n">LOGI</span><span class="p">(</span><span class="s">"MQTT_PACKET_TYPE_PUBLISH"</span><span class="p">);</span>

<span class="w">      </span><span class="cm">/*æ”¶åˆ°äº†brokerå‘é€è¿‡æ¥çš„PUBLISHæ¶ˆæ¯*/</span>
<span class="w">      </span><span class="n">peer_signaling_on_pub_event</span><span class="p">(</span><span class="n">deserialized_info</span><span class="o">-&gt;</span><span class="n">pPublishInfo</span><span class="o">-&gt;</span><span class="n">pPayload</span><span class="p">,</span>
<span class="w">                                  </span><span class="n">deserialized_info</span><span class="o">-&gt;</span><span class="n">pPublishInfo</span><span class="o">-&gt;</span><span class="n">payloadLength</span><span class="p">);</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">MQTT_PACKET_TYPE_SUBACK</span><span class="p">:</span>
<span class="w">      </span><span class="n">LOGD</span><span class="p">(</span><span class="s">"MQTT_PACKET_TYPE_SUBACK"</span><span class="p">);</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">peer_signaling_on_pub_event</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">cJSON</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">PeerConnectionState</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>

<span class="w">  </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="cm">/*1. å…ˆè·å–peer connectçš„çŠ¶æ€*/</span>
<span class="w">  </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">peer_connection_get_state</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"%s,%d, msg:%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">msg</span><span class="p">);</span>
<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/*2. è§£æjsonæ–‡ä»¶*/</span>
<span class="w">    </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_Parse</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_CreateRaw</span><span class="p">(</span><span class="n">RPC_ERROR_PARSE_ERROR</span><span class="p">);</span>
<span class="w">      </span><span class="n">LOGW</span><span class="p">(</span><span class="s">"Parse json failed"</span><span class="p">);</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="cm">/*3. è§£æjsionä¸­å­—æ®µçš„idå€¼*/</span>
<span class="w">    </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="s">"id"</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">cJSON_IsNumber</span><span class="p">(</span><span class="n">item</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_CreateRaw</span><span class="p">(</span><span class="n">RPC_ERROR_INVALID_REQUEST</span><span class="p">);</span>
<span class="w">      </span><span class="n">LOGW</span><span class="p">(</span><span class="s">"Cannot find id"</span><span class="p">);</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="o">-&gt;</span><span class="n">valueint</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/*4. è§£æjisonä¸­çš„methodå­—æ®µæ˜¯æ˜¯ä»€ä¹ˆï¼Ÿ*/</span>
<span class="w">    </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="s">"method"</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cJSON_IsString</span><span class="p">(</span><span class="n">item</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_CreateRaw</span><span class="p">(</span><span class="n">RPC_ERROR_INVALID_REQUEST</span><span class="p">);</span>
<span class="w">      </span><span class="n">LOGW</span><span class="p">(</span><span class="s">"Cannot find method"</span><span class="p">);</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">     </span><span class="cm">/* 5. è§£æjsonæ–‡ä»¶ï¼Œå‘ç°methoä¸ºofferï¼Œbrokerå‘è¿‡æ¥è¦æ±‚offerï¼Œè¡¨ç¤ºæœ‰è®¾å¤‡åŠ å…¥äº†ã€‚*/</span>
<span class="w">     </span><span class="cm">/* {"jsonrpc":"2.0","method":"offer","id":89} */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="n">RPC_METHOD_OFFER</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">PEER_CONNECTION_NEW</span><span class="p">:</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">PEER_CONNECTION_DISCONNECTED</span><span class="p">:</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">PEER_CONNECTION_FAILED</span><span class="p">:</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">PEER_CONNECTION_CLOSED</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">g_ps</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">          </span><span class="cm">/*6. å°†peer connectçŠ¶æ€åˆ‡æ¢ä¸ºPEER_CONNECTION_NEW</span>
<span class="cm">           åœ¨peer_connection_loopä¸­å°±ä¼šè°ƒç”¨åˆ°peer_connection_state_newï¼Œ</span>
<span class="cm">           offerä¸€ä¸ªSDP*/</span>
<span class="w">          </span><span class="n">peer_connection_create_offer</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_CreateRaw</span><span class="p">(</span><span class="n">RPC_ERROR_INTERNAL_ERROR</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="cm">/*7. brokerå‘é€è¿‡æ¥çš„æ˜¯anwerï¼Œè¡¨ç¤ºå¯¹ç«¯è®¾å¤‡çš„åº”ç­”*/</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="n">RPC_METHOD_ANSWER</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="s">"params"</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">cJSON_IsString</span><span class="p">(</span><span class="n">item</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_CreateRaw</span><span class="p">(</span><span class="n">RPC_ERROR_INVALID_PARAMS</span><span class="p">);</span>
<span class="w">        </span><span class="n">LOGW</span><span class="p">(</span><span class="s">"Cannot find params"</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="cm">/*8. æ”¶åˆ°å¯¹ç«¯åº”ç­”åï¼Œè§£æå¯¹ç«¯anserçš„SDPå†…å®¹ï¼Œè®¾ç½®è¿œç«¯çš„æè¿°ä¿¡æ¯*/</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PEER_CONNECTION_NEW</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">peer_connection_set_remote_description</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">);</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_CreateString</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="n">RPC_METHOD_STATE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_CreateString</span><span class="p">(</span><span class="n">peer_connection_state_to_string</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="n">RPC_METHOD_CLOSE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">peer_connection_close</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
<span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_CreateString</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_CreateRaw</span><span class="p">(</span><span class="n">RPC_ERROR_METHOD_NOT_FOUND</span><span class="p">);</span>
<span class="w">      </span><span class="n">LOGW</span><span class="p">(</span><span class="s">"Unsupport method"</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="cm">/*9. å‘å¸ƒæ¶ˆæ¯ï¼Œå‘å¸ƒä»€ä¹ˆå†…å®¹ï¼Ÿï¼Ÿ*/</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_CreateObject</span><span class="p">();</span>
<span class="w">    </span><span class="n">cJSON_AddStringToObject</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s">"jsonrpc"</span><span class="p">,</span><span class="w"> </span><span class="n">RPC_VERSION</span><span class="p">);</span>
<span class="w">    </span><span class="n">cJSON_AddNumberToObject</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s">"id"</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">cJSON_AddItemToObject</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s">"result"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">cJSON_AddItemToObject</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s">"error"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cJSON_PrintUnformatted</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">peer_signaling_mqtt_publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_ps</span><span class="p">.</span><span class="n">mqtt_ctx</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">);</span>
<span class="w">      </span><span class="n">free</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">cJSON_Delete</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cJSON_Delete</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="offer-sdp">Offer SDP</h3>
<p>å½“å¯¹ç«¯Client Bè®¾å¤‡é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å‘èµ·è¿æ¥æ—¶ï¼Œä¿¡ä»¤æœåŠ¡å™¨çš„MQTT brokerå‘é€publishç»™å½“å‰Client Aè®¾å¤‡ï¼Œæ¥æ”¶åˆ°MQTT çš„publishåï¼Œè§£æåˆ°methodä¸ºofferï¼Œå³å°†peerçš„çŠ¶æ€åˆ‡æ¢ä¸ºPEER_CONNECTION_NEWï¼Œç»§è€Œpeer_connection_loopä¸­çŠ¶æ€åˆ‡æ¢ä¸ºpeer_connection_state_newã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">peer_connection_state_new</span><span class="p">(</span><span class="n">PeerConnection</span><span class="o">*</span><span class="w"> </span><span class="n">pc</span><span class="p">,</span><span class="w"> </span><span class="n">DtlsSrtpRole</span><span class="w"> </span><span class="n">role</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">isOfferer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">temp_buf</span><span class="p">;</span>

<span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">temp_buf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">temp_buf</span><span class="p">));</span>

<span class="w">  </span><span class="n">dtls_srtp_reset_session</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">dtls_srtp</span><span class="p">);</span>
<span class="w">  </span><span class="cm">/*dtls srtp åˆå§‹åŒ–ï¼Œåœ¨åç»­çš„ç« èŠ‚å†è¿›è¡Œæè¿°ã€‚*/</span>
<span class="w">  </span><span class="n">dtls_srtp_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">dtls_srtp</span><span class="p">,</span><span class="w"> </span><span class="n">role</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="p">);</span>
<span class="w">  </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">dtls_srtp</span><span class="p">.</span><span class="n">udp_recv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">peer_connection_dtls_srtp_recv</span><span class="p">;</span>
<span class="w">  </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">dtls_srtp</span><span class="p">.</span><span class="n">udp_send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">peer_connection_dtls_srtp_send</span><span class="p">;</span>

<span class="w">  </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">sctp</span><span class="p">.</span><span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isOfferer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">agent_clear_candidates</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">agent</span><span class="p">);</span>
<span class="w">    </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">agent</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AGENT_MODE_CONTROLLING</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">agent</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AGENT_MODE_CONTROLLED</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">   </span><span class="cm">/*1. é€šè¿‡stunä¼ è¾“è·å–candidateä¿¡æ¯*/</span>
<span class="w">  </span><span class="n">agent_gather_candidate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w">  </span><span class="c1">// host address</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ice_servers</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ice_servers</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ice_servers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urls</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">LOGI</span><span class="p">(</span><span class="s">"ice server: %s"</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ice_servers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urls</span><span class="p">);</span>
<span class="w">      </span><span class="n">agent_gather_candidate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ice_servers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urls</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ice_servers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ice_servers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">credential</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="cm">/*å°†candidateä¿¡æ¯è½¬åŒ–ä¸ºSDPæ ¼å¼ï¼Ÿ*/</span>
<span class="w">  </span><span class="n">agent_get_local_description</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">temp_buf</span><span class="p">));</span>

<span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">));</span>
<span class="w">  </span><span class="c1">// TODO: check if we have video or audio codecs</span>
<span class="w">  </span><span class="cm">/*åˆ›å»ºä¸€ä¸ªSDPä¼šè¯*/</span>
<span class="w">  </span><span class="n">sdp_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">,</span>
<span class="w">             </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">video_codec</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CODEC_NONE</span><span class="p">,</span>
<span class="w">             </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">audio_codec</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CODEC_NONE</span><span class="p">,</span>
<span class="w">             </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">datachannel</span><span class="p">);</span>
<span class="w">  </span><span class="cm">/*å¡«å……å…¶ä»–çš„sdpä¿¡æ¯*/</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">video_codec</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CODEC_H264</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sdp_append_h264</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">);</span>
<span class="w">    </span><span class="n">sdp_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">,</span><span class="w"> </span><span class="s">"a=fingerprint:sha-256 %s"</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">dtls_srtp</span><span class="p">.</span><span class="n">local_fingerprint</span><span class="p">);</span>
<span class="w">    </span><span class="n">sdp_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">,</span><span class="w"> </span><span class="n">peer_connection_dtls_role_setup_value</span><span class="p">(</span><span class="n">role</span><span class="p">));</span>
<span class="w">    </span><span class="n">strcat</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">.</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">audio_codec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">CODEC_PCMA</span><span class="p">:</span>

<span class="w">      </span><span class="n">sdp_append_pcma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">);</span>
<span class="w">      </span><span class="n">sdp_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">,</span><span class="w"> </span><span class="s">"a=fingerprint:sha-256 %s"</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">dtls_srtp</span><span class="p">.</span><span class="n">local_fingerprint</span><span class="p">);</span>
<span class="w">      </span><span class="n">sdp_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">,</span><span class="w"> </span><span class="n">peer_connection_dtls_role_setup_value</span><span class="p">(</span><span class="n">role</span><span class="p">));</span>
<span class="w">      </span><span class="n">strcat</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">.</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">);</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">CODEC_PCMU</span><span class="p">:</span>

<span class="w">      </span><span class="n">sdp_append_pcmu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">);</span>
<span class="w">      </span><span class="n">sdp_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">,</span><span class="w"> </span><span class="s">"a=fingerprint:sha-256 %s"</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">dtls_srtp</span><span class="p">.</span><span class="n">local_fingerprint</span><span class="p">);</span>
<span class="w">      </span><span class="n">sdp_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">,</span><span class="w"> </span><span class="n">peer_connection_dtls_role_setup_value</span><span class="p">(</span><span class="n">role</span><span class="p">));</span>
<span class="w">      </span><span class="n">strcat</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">.</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">);</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">CODEC_OPUS</span><span class="p">:</span>
<span class="w">      </span><span class="n">sdp_append_opus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">);</span>
<span class="w">      </span><span class="n">sdp_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">,</span><span class="w"> </span><span class="s">"a=fingerprint:sha-256 %s"</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">dtls_srtp</span><span class="p">.</span><span class="n">local_fingerprint</span><span class="p">);</span>
<span class="w">      </span><span class="n">sdp_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">,</span><span class="w"> </span><span class="n">peer_connection_dtls_role_setup_value</span><span class="p">(</span><span class="n">role</span><span class="p">));</span>
<span class="w">      </span><span class="n">strcat</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">.</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">);</span>

<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">datachannel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sdp_append_datachannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">);</span>
<span class="w">    </span><span class="n">sdp_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">,</span><span class="w"> </span><span class="s">"a=fingerprint:sha-256 %s"</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">dtls_srtp</span><span class="p">.</span><span class="n">local_fingerprint</span><span class="p">);</span>
<span class="w">    </span><span class="n">sdp_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">,</span><span class="w"> </span><span class="n">peer_connection_dtls_role_setup_value</span><span class="p">(</span><span class="n">role</span><span class="p">));</span>
<span class="w">    </span><span class="n">strcat</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">.</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">b_local_description_created</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/*å°†SDPä¿¡æ¯å‘é€å‡ºå»ã€‚*/</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">onicecandidate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">onicecandidate</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">local_sdp</span><span class="p">.</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">user_data</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="anser-sdp">anser SDP</h3>
<div class="codehilite"><pre><span></span><code><span class="n">peer_signaling_on_pub_event</span>
<span class="w">    </span><span class="nf">strcmp</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">,</span><span class="w"> </span><span class="n">RPC_METHOD_ANSWER</span>
<span class="w">        </span><span class="n">peer_connection_set_remote_description</span><span class="p">(</span><span class="n">g_ps</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">);</span>
</code></pre></div>
<p>è®¾å¤‡æ”¶åˆ°publishæ¶ˆæ¯åï¼Œè§£æjsionåˆ¤æ–­å‡ºmethodæ˜¯anserï¼Œè°ƒç”¨peer_connection_set_remote_descriptionè¿›è¡Œå¤„ç†ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">peer_connection_set_remote_description</span><span class="p">(</span><span class="n">PeerConnection</span><span class="o">*</span><span class="w"> </span><span class="n">pc</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">sdp_text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">sdp_text</span><span class="p">;</span>
<span class="w">  </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">  </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">val_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="o">*</span><span class="w"> </span><span class="n">ssrc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">DtlsSrtpRole</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DTLS_SRTP_ROLE_SERVER</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">is_update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">Agent</span><span class="o">*</span><span class="w"> </span><span class="n">agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">agent</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/*1. è§£æSDPä¼šè¯å†…å®¹*/</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strstr</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strstr</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">    </span><span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>
<span class="w">    </span><span class="n">buf</span><span class="p">[</span><span class="n">line</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'\0'</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">"a=setup:passive"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DTLS_SRTP_ROLE_CLIENT</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">"a=fingerprint"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">strncpy</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">dtls_srtp</span><span class="p">.</span><span class="n">remote_fingerprint</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="n">DTLS_SRTP_FINGERPRINT_LENGTH</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">"a=ice-ufrag"</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">strlen</span><span class="p">(</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">remote_ufrag</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="s">"a=ice-ufrag:"</span><span class="p">),</span><span class="w"> </span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">remote_ufrag</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">remote_ufrag</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">is_update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">"m=video"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">ssrc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">remote_vssrc</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">"m=audio"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">ssrc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">remote_assrc</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">val_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">"a=ssrc:"</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ssrc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="o">*</span><span class="n">ssrc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtoul</span><span class="p">(</span><span class="n">val_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="w">      </span><span class="n">LOGD</span><span class="p">(</span><span class="s">"SSRC: %"</span><span class="w"> </span><span class="n">PRIu32</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ssrc</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_update</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">b_local_description_created</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">peer_connection_state_new</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="w"> </span><span class="n">role</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="cm">/*2. è®¾ç½®è¿œç¨‹çš„æè¿°ä¿¡æ¯ï¼Œä¸»è¦æ˜¯å¡«å……PeerConnectionä¸­agentçš„ä¿¡æ¯ï¼Œ</span>
<span class="cm">  è¿™ä¸ªagentä¿¡æ¯å­˜å‚¨äº†æœ¬åœ°å’Œè¿œç«¯çš„icecandicate*/</span>
<span class="w">  </span><span class="n">agent_set_remote_description</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">sdp_text</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/*3. å°†peer connectçŠ¶æ€åˆ‡æ¢ä¸ºchecking*/</span>
<span class="w">  </span><span class="n">STATE_CHANGED</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="w"> </span><span class="n">PEER_CONNECTION_CHECKING</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="p2p">æµ‹è¯•P2Pé€šè·¯</h3>
<p>æ”¶åˆ°å¯¹ç«¯çš„anser SDPåï¼Œè§£æå¾—åˆ°äº†ICE candidateï¼Œé‚£ä¹ˆå°†peer connectåˆ‡æ¢ä¸ºcheckingçŠ¶æ€ï¼Œå…ˆæµ‹è¯•ä¸€ä¸‹P2Pçš„é€šè·¯ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">agent_connectivity_check</span><span class="p">(</span><span class="n">Agent</span><span class="o">*</span><span class="w"> </span><span class="n">agent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">addr_string</span><span class="p">[</span><span class="n">ADDRSTRLEN</span><span class="p">];</span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">1400</span><span class="p">];</span>
<span class="w">  </span><span class="n">StunMessage</span><span class="w"> </span><span class="n">msg</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">nominated_pair</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ICE_CANDIDATE_STATE_INPROGRESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LOGI</span><span class="p">(</span><span class="s">"nominated pair is not in progress"</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
<span class="w">  </span><span class="cm">/*1. ä½¿ç”¨å¯¹ç«¯çš„ipåœ°å€å‘é€æ•°æ®*/</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">nominated_pair</span><span class="o">-&gt;</span><span class="n">conncheck</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">AGENT_CONNCHECK_PERIOD</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">nominated_pair</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">addr_string</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">addr_string</span><span class="p">));</span>
<span class="w">    </span><span class="n">LOGD</span><span class="p">(</span><span class="s">"send binding request to remote ip: %s, port: %d"</span><span class="p">,</span><span class="w"> </span><span class="n">addr_string</span><span class="p">,</span><span class="w"> </span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">nominated_pair</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
<span class="w">    </span><span class="n">agent_create_binding_request</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
<span class="w">    </span><span class="n">agent_socket_send</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">nominated_pair</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="cm">/*2. æ¥æ”¶å¯¹ç«¯çš„åé¦ˆæ•°æ®ï¼Œå¦‚æœè¿”å›æ­£ç¡®ï¼Œè¡¨ç¤ºé“¾è·¯è¿é€šæ­£å¸¸*/</span>
<span class="w">  </span><span class="n">agent_recv</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">nominated_pair</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ICE_CANDIDATE_STATE_SUCCEEDED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">selected_pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">nominated_pair</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>æµ‹è¯•P2Pé“¾è·¯æ­£å¸¸åï¼Œå°±å°†Peer ConnectionçŠ¶æ€åˆ‡æ¢ä¸ºPEER_CONNECTION_CONNECTEDï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ­£å¼çš„P2Pé“¾è·¯åˆ›å»ºè¿æ¥äº†ã€‚</p>
<h2 id="p2p_1">P2Pé€šä¿¡</h2>
<p>é€šè¿‡ä¸Šé¢ä¿¡ä»¤çš„å»ºç«‹ï¼ŒP2Pé“¾è·¯å·²ç»å»ºç«‹äº†è¿æ¥ï¼Œæ¥ä¸‹æ¥å°±æ˜¯åˆ›å»ºP2Pçš„é€šä¿¡é“¾è·¯äº†ï¼ŒP2Pçš„ä¼ è¾“ä½¿ç”¨çš„æ˜¯SRTPé“¾è·¯ã€‚</p>
<h3 id="_9">åˆå§‹åŒ–</h3>
<p>åœ¨offer SDPçš„æ—¶å€™ï¼Œå‡½æ•°peer_connection_state_newä¸­ä¼šè°ƒç”¨dtls_srtp_initè¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">dtls_srtp_init</span><span class="p">(</span><span class="n">DtlsSrtp</span><span class="o">*</span><span class="w"> </span><span class="n">dtls_srtp</span><span class="p">,</span><span class="w"> </span><span class="n">DtlsSrtpRole</span><span class="w"> </span><span class="n">role</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">user_data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">mbedtls_ssl_srtp_profile</span><span class="w"> </span><span class="n">default_profiles</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">MBEDTLS_TLS_SRTP_AES128_CM_HMAC_SHA1_80</span><span class="p">,</span>
<span class="w">      </span><span class="n">MBEDTLS_TLS_SRTP_AES128_CM_HMAC_SHA1_32</span><span class="p">,</span>
<span class="w">      </span><span class="n">MBEDTLS_TLS_SRTP_NULL_HMAC_SHA1_80</span><span class="p">,</span>
<span class="w">      </span><span class="n">MBEDTLS_TLS_SRTP_NULL_HMAC_SHA1_32</span><span class="p">,</span>
<span class="w">      </span><span class="n">MBEDTLS_TLS_SRTP_UNSET</span><span class="p">};</span>

<span class="w">  </span><span class="cm">/*1. è®¾ç½®srtpçš„è§’è‰²ï¼Œç›®å‰æ˜¯åšserverï¼Œå¹¶æ›´æ–°ä¸ºINITçŠ¶æ€ï¼Œå¹¶è®¾ç½®UDPæ”¶å‘çš„å›è°ƒå‡½æ•°ã€‚*/</span>
<span class="w">  </span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">role</span><span class="p">;</span>
<span class="w">  </span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DTLS_SRTP_STATE_INIT</span><span class="p">;</span>
<span class="w">  </span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_data</span><span class="p">;</span>
<span class="w">  </span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">udp_send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dtls_srtp_udp_send</span><span class="p">;</span>
<span class="w">  </span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">udp_recv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dtls_srtp_udp_recv</span><span class="p">;</span>
<span class="w">  </span><span class="cm">/*2.åˆå§‹åŒ– MBEDTLS ç›¸å…³ç»“æ„ä½“*/</span>
<span class="w">  </span><span class="n">mbedtls_ssl_config_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span><span class="w"> </span>
<span class="w">   </span><span class="c1">//åˆå§‹åŒ– ssl_config ç»“æ„ä½“ï¼Œè¿™æ˜¯ SSL é…ç½®çš„æ ¸å¿ƒï¼ŒåŒ…å«åŠ å¯†åè®®ã€è¯ä¹¦ã€å¯†é’¥ç­‰ä¿¡æ¯</span>
<span class="w">  </span><span class="n">mbedtls_ssl_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">   </span><span class="c1">//åˆå§‹åŒ– ssl ç»“æ„ä½“ï¼Œè¡¨ç¤ºä¸€ä¸ª SSL ä¼šè¯ä¸Šä¸‹æ–‡ã€‚</span>
<span class="w">  </span><span class="n">mbedtls_x509_crt_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">cert</span><span class="p">);</span>
<span class="w">   </span><span class="c1">//åˆå§‹åŒ– X.509 è¯ä¹¦ç»“æ„ï¼Œç”¨äºå­˜å‚¨å…¬é’¥è¯ä¹¦ã€‚</span>
<span class="w">  </span><span class="n">mbedtls_pk_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">pkey</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//åˆå§‹åŒ–å…¬é’¥å¯¹è±¡ç»“æ„ï¼Œç”¨äºå­˜å‚¨ç§é’¥ã€‚</span>
<span class="w">  </span><span class="n">mbedtls_entropy_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">entropy</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//åˆå§‹åŒ–ç†µæºï¼Œç†µæºæ˜¯ç”Ÿæˆéšæœºæ•°æ‰€éœ€çš„åŸºç¡€ã€‚</span>
<span class="w">  </span><span class="n">mbedtls_ctr_drbg_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">ctr_drbg</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//åˆå§‹åŒ– CTR_DRBGï¼ˆCounter-based Deterministic Random Byte Generatorï¼‰ï¼Œ</span>
<span class="w">    </span><span class="c1">//å®ƒæ˜¯ç”¨äºç”Ÿæˆéšæœºæ•°çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ã€‚</span>

<span class="w"> </span><span class="cm">/*3. è®¾ç½®æ‰“å°ç­‰çº§*/</span>
<span class="cp">#if CONFIG_MBEDTLS_DEBUG</span>
<span class="w">  </span><span class="n">mbedtls_debug_set_threshold</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">  </span><span class="n">mbedtls_ssl_conf_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">dtls_srtp_debug</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="w">  </span><span class="cm">/*4.ç”Ÿæˆä¸€ä¸ªè‡ªç­¾åè¯ä¹¦ã€‚è¿™ä¸ªè¯ä¹¦å°†åœ¨ DTLS æ¡æ‰‹æœŸé—´ç”¨äºèº«ä»½éªŒè¯*/</span>
<span class="w">  </span><span class="n">dtls_srtp_selfsign_cert</span><span class="p">(</span><span class="n">dtls_srtp</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/*5. é…ç½®è¯ä¹¦éªŒè¯å’Œè®¤è¯æ¨¡å¼*/</span>
<span class="w">  </span><span class="n">mbedtls_ssl_conf_verify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">dtls_srtp_cert_verify</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="c1">//é…ç½®è¯ä¹¦éªŒè¯å›è°ƒå‡½æ•° dtls_srtp_cert_verifyï¼Œç”¨æ¥éªŒè¯è¿œç«¯è¯ä¹¦çš„æœ‰æ•ˆæ€§ã€‚</span>
<span class="w">  </span><span class="n">mbedtls_ssl_conf_authmode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">MBEDTLS_SSL_VERIFY_REQUIRED</span><span class="p">);</span>
<span class="w">  </span><span class="c1">//è®¾ç½®èº«ä»½éªŒè¯æ¨¡å¼ä¸ºMBEDTLS_SSL_VERIFY_REQUIREDï¼Œå³å®¢æˆ·ç«¯å¿…é¡»æä¾›æœ‰æ•ˆè¯ä¹¦è¿›è¡ŒéªŒè¯ï¼ˆæœåŠ¡å™¨éªŒè¯å®¢æˆ·ç«¯çš„è¯ä¹¦ï¼‰ã€‚</span>

<span class="w">  </span><span class="cm">/*6. é…ç½®è¯ä¹¦é“¾å’Œç§é’¥*/</span>
<span class="w">  </span><span class="n">mbedtls_ssl_conf_ca_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">cert</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="c1">//é…ç½®æœåŠ¡å™¨çš„æ ¹è¯ä¹¦é“¾ï¼Œè¿™é‡Œä½¿ç”¨dtls_srtp-&gt;cert ä½œä¸ºè¯ä¹¦é“¾çš„èµ·å§‹è¯ä¹¦ã€‚</span>
<span class="w">  </span><span class="n">mbedtls_ssl_conf_own_cert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">cert</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">pkey</span><span class="p">);</span>
<span class="w">  </span><span class="c1">//é…ç½®æœ¬åœ°è¯ä¹¦å’Œç§é’¥ã€‚æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½éœ€è¦è‡ªå·±çš„è¯ä¹¦å’Œç§é’¥æ¥è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚</span>

<span class="w">  </span><span class="cm">/*7. é…ç½®éšæœºæ•°ç”Ÿæˆå™¨å’Œè¶…æ—¶*/</span>
<span class="w">  </span><span class="n">mbedtls_ssl_conf_rng</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">mbedtls_ctr_drbg_random</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">ctr_drbg</span><span class="p">);</span>
<span class="w">  </span><span class="c1">//é…ç½®éšæœºæ•°ç”Ÿæˆå™¨ï¼Œä½¿ç”¨ mbedtls_ctr_drbg_random å’Œ dtls_srtp-&gt;ctr_drbg ä½œä¸ºéšæœºæ•°æºã€‚</span>
<span class="w">  </span><span class="n">mbedtls_ssl_conf_read_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
<span class="w">  </span><span class="c1">//è®¾ç½®è¯»å–è¶…æ—¶æ—¶é—´ä¸º 1000 æ¯«ç§’ï¼Œæ„å‘³ç€åœ¨ç­‰å¾…æ•°æ®æ—¶ï¼Œå¦‚æœè¶…è¿‡ 1000 æ¯«ç§’æ²¡æœ‰æ¥æ”¶åˆ°æ•°æ®ï¼Œåˆ™è¶…æ—¶ã€‚</span>
<span class="w">  </span><span class="cm">/*8. å¦‚æœæ˜¯æœåŠ¡å™¨ (DTLS_SRTP_ROLE_SERVER)ï¼Œåˆ™é…ç½®ä¸º DTLS æœåŠ¡å™¨æ¨¡å¼ï¼Œå¹¶è®¾ç½®ç”¨</span>
<span class="cm">  äºé˜²æ­¢ DoS æ”»å‡»çš„ DTLS cookiesï¼ˆcookie æ˜¯ç”¨äºé˜²æ­¢é‡æ”¾æ”»å‡»çš„ï¼‰ã€‚</span>
<span class="cm">  å¦‚æœè§’è‰²æ˜¯å®¢æˆ·ç«¯ï¼Œåˆ™ç›´æ¥é…ç½®ä¸º DTLS å®¢æˆ·ç«¯æ¨¡å¼ã€‚è¿™é‡Œæ˜¯åšæœåŠ¡ç«¯*/</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DTLS_SRTP_ROLE_SERVER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mbedtls_ssl_config_defaults</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span>
<span class="w">                                </span><span class="n">MBEDTLS_SSL_IS_SERVER</span><span class="p">,</span>
<span class="w">                                </span><span class="n">MBEDTLS_SSL_TRANSPORT_DATAGRAM</span><span class="p">,</span>
<span class="w">                                </span><span class="n">MBEDTLS_SSL_PRESET_DEFAULT</span><span class="p">);</span>
<span class="w">    </span><span class="n">mbedtls_ssl_cookie_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">cookie_ctx</span><span class="p">);</span>

<span class="w">    </span><span class="n">mbedtls_ssl_cookie_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">cookie_ctx</span><span class="p">,</span><span class="w"> </span><span class="n">mbedtls_ctr_drbg_random</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">ctr_drbg</span><span class="p">);</span>

<span class="w">    </span><span class="n">mbedtls_ssl_conf_dtls_cookies</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">mbedtls_ssl_cookie_write</span><span class="p">,</span><span class="w"> </span><span class="n">mbedtls_ssl_cookie_check</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">cookie_ctx</span><span class="p">);</span>

<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mbedtls_ssl_config_defaults</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span>
<span class="w">                                </span><span class="n">MBEDTLS_SSL_IS_CLIENT</span><span class="p">,</span>
<span class="w">                                </span><span class="n">MBEDTLS_SSL_TRANSPORT_DATAGRAM</span><span class="p">,</span>
<span class="w">                                </span><span class="n">MBEDTLS_SSL_PRESET_DEFAULT</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w"> </span><span class="cm">/*10. ç”Ÿæˆå¹¶æ‰“å°æœ¬åœ°æŒ‡çº¹ï¼Œ ç”¨äºç”Ÿæˆæœ¬åœ°è¯ä¹¦çš„æŒ‡çº¹ï¼ˆä¸€ä¸ªå“ˆå¸Œå€¼ï¼‰ï¼Œç”¨äºæ ‡è¯†è¯ä¹¦ã€‚*/</span>
<span class="w">  </span><span class="n">dtls_srtp_x509_digest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">cert</span><span class="p">,</span><span class="w"> </span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">local_fingerprint</span><span class="p">);</span>
<span class="w">  </span><span class="n">LOGD</span><span class="p">(</span><span class="s">"local fingerprint: %s"</span><span class="p">,</span><span class="w"> </span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">local_fingerprint</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/*11. é…ç½® DTLS-SRTP çš„ä¿æŠ¤é…ç½®æ–‡ä»¶ï¼Œdefault_profiles æ˜¯é¢„å®šä¹‰çš„å®‰å…¨é…ç½®ï¼Œ</span>
<span class="cm">  åŒ…å« SRTP åè®®æ‰€æ”¯æŒçš„åŠ å¯†ç®—æ³•ã€å¯†é’¥é•¿åº¦ç­‰ä¿¡æ¯ã€‚*/</span>
<span class="w">  </span><span class="n">mbedtls_ssl_conf_dtls_srtp_protection_profiles</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">default_profiles</span><span class="p">);</span>

<span class="w"> </span><span class="cm">/*12. é…ç½® SRTP MKIï¼ˆä¸»å¯†é’¥æ ‡è¯†ç¬¦ï¼‰çš„æ”¯æŒæƒ…å†µã€‚åœ¨è¿™é‡Œï¼Œè®¾ç½®ä¸ºä¸æ”¯æŒ MKIã€‚*/</span>
<span class="w">  </span><span class="n">mbedtls_ssl_conf_srtp_mki_value_supported</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">MBEDTLS_SSL_DTLS_SRTP_MKI_UNSUPPORTED</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/*13. ç¦ç”¨å®¢æˆ·ç«¯è¯ä¹¦è¯·æ±‚ä¸­çš„ CA åˆ—è¡¨ã€‚*/</span>
<span class="w">  </span><span class="n">mbedtls_ssl_conf_cert_req_ca_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">MBEDTLS_SSL_CERT_REQ_CA_LIST_DISABLED</span><span class="p">);</span>

<span class="w"> </span><span class="cm">/*14. å®Œæˆæ‰€æœ‰é…ç½®åï¼Œè°ƒç”¨ mbedtls_ssl_setup åˆå§‹åŒ– ssl ä¸Šä¸‹æ–‡å¹¶å°†é…ç½®åº”ç”¨äº</span>
<span class="cm"> å½“å‰çš„ DTLS ä¼šè¯ã€‚*/</span>
<span class="w">  </span><span class="n">mbedtls_ssl_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_10">åˆ›å»º</h3>
<div class="codehilite"><pre><span></span><code><span class="k">case</span><span class="w"> </span><span class="no">PEER_CONNECTION_CONNECTED</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/*1. å»ºç«‹DTLS SRTPé“¾æ¥*/</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dtls_srtp_handshake</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">dtls_srtp</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">LOGD</span><span class="p">(</span><span class="s">"DTLS-SRTP handshake done"</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*2. å»ºç«‹sctp é“¾æ¥*/</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">datachannel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">LOGI</span><span class="p">(</span><span class="s">"SCTP create socket"</span><span class="p">);</span>
<span class="w">        </span><span class="n">sctp_create_socket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">sctp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">dtls_srtp</span><span class="p">);</span>
<span class="w">        </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">sctp</span><span class="p">.</span><span class="n">userdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">user_data</span><span class="p">;</span>
<span class="w">     </span><span class="p">}</span>

<span class="w">     </span><span class="n">STATE_CHANGED</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="w"> </span><span class="n">PEER_CONNECTION_COMPLETED</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>ä¸»è¦æ˜¯åˆ›å»ºDTLS_SRTPå’ŒSCTPä¸¤æ¡é“¾è·¯ã€‚</p>
<h4 id="dtsl_srtp">DTSL_SRTP</h4>
<div class="codehilite"><pre><span></span><code><span class="n">dtls_srtp_handshake_server</span><span class="err">ï¼ˆï¼‰</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* å¾ªç¯å‘èµ·*/</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mbedtls_ssl_session_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">        </span><span class="n">mbedtls_ssl_set_client_transport_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">client_ip</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">client_ip</span><span class="p">));</span>
<span class="w">        </span><span class="cm">/* å‘èµ·æ¡æ‰‹*/</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dtls_srtp_do_handshake</span><span class="p">(</span><span class="n">dtls_srtp</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MBEDTLS_ERR_SSL_HELLO_VERIFY_REQUIRED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">LOGD</span><span class="p">(</span><span class="s">"DTLS hello verification requested"</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">LOGE</span><span class="p">(</span><span class="s">"failed! mbedtls_ssl_handshake returned -0x%.4x"</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="n">ret</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">           </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>åˆ¤æ–­è¿”å›çš„é”™è¯¯æ˜¯MBEDTLS_ERR_SSL_HELLO_VERIFY_REQUIREDï¼Œä¼šè¿›è¡Œå†æ¬¡å¾ªç¯å‘èµ·ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">dtls_srtp_do_handshake</span><span class="p">(</span><span class="n">DtlsSrtp</span><span class="o">*</span><span class="w"> </span><span class="n">dtls_srtp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">   </span><span class="cm">/* timer æ˜¯ mbedtls_timing_delay_context ç±»å‹çš„ä¸€ä¸ªé™æ€å˜é‡ï¼Œç”¨äºç®¡ç†</span>
<span class="cm">   å®šæ—¶å™¨ï¼ˆé€šå¸¸æ˜¯æ§åˆ¶è¶…æ—¶çš„æœºåˆ¶ï¼‰ã€‚è¿™ä¸ªå®šæ—¶å™¨åœ¨ DTLS åè®®ä¸­ç”¨äºå¤„ç†è¶…æ—¶ç­‰æ“ä½œã€‚*/</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">mbedtls_timing_delay_context</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>

<span class="w">   </span><span class="cm">/*å®šæ—¶å™¨æ˜¯ DTLS æ¡æ‰‹ä¸­ç”¨æ¥å¤„ç†è¶…æ—¶çš„ä¸€ä¸ªé‡è¦æœºåˆ¶ï¼Œå› ä¸º DTLS æ˜¯åŸºäºUDPåè®®çš„ï¼Œ</span>
<span class="cm">   è€Œ UDP æœ¬èº«ä¸ä¿è¯æ•°æ®çš„å¯é ä¼ è¾“ï¼Œå› æ­¤éœ€è¦åœ¨æ¡æ‰‹è¿‡ç¨‹ä¸­æ‰‹åŠ¨ç®¡ç†è¶…æ—¶ã€‚*/</span>
<span class="w">  </span><span class="n">mbedtls_ssl_set_timer_cb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">mbedtls_timing_set_delay</span><span class="p">,</span><span class="w"> </span><span class="n">mbedtls_timing_get_delay</span><span class="p">);</span>

<span class="cp">#if CONFIG_MBEDTLS_2_X</span>
<span class="w">  </span><span class="cm">/*å›è°ƒå‡½æ•°ä¼šåœ¨ DTLS æ¡æ‰‹å®Œæˆåç”¨äºæ´¾å‘åŠ å¯†å¯†é’¥ã€‚*/</span>
<span class="w">  </span><span class="n">mbedtls_ssl_conf_export_keys_ext_cb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">dtls_srtp_key_derivation_cb</span><span class="p">,</span><span class="w"> </span><span class="n">dtls_srtp</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="w">  </span><span class="n">mbedtls_ssl_set_export_keys_cb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">dtls_srtp_key_derivation_cb</span><span class="p">,</span><span class="w"> </span><span class="n">dtls_srtp</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="w">  </span><span class="cm">/*ç”¨äºè®¾ç½® DTLS ä¸Šä¸‹æ–‡çš„ BIOï¼ˆBasic Input/Outputï¼‰å›è°ƒå‡½æ•°ï¼Œè¿™äº›å›è°ƒå‡½æ•°</span>
<span class="cm">  å®šä¹‰äº†æ•°æ®çš„å‘é€å’Œæ¥æ”¶æ–¹å¼ã€‚å›è°ƒå‡½æ•°åœ¨dtls_srtp_initè¿›è¡Œåˆå§‹åŒ–çš„ã€‚*/</span>
<span class="w">  </span><span class="n">mbedtls_ssl_set_bio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">dtls_srtp</span><span class="p">,</span><span class="w"> </span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">udp_send</span><span class="p">,</span><span class="w"> </span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">udp_recv</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="cm">/*æ‰§è¡Œ DTLS æ¡æ‰‹ï¼Œç›´åˆ°æ¡æ‰‹æˆåŠŸæˆ–å‘ç”Ÿé”™è¯¯ã€‚*/</span><span class="w"> </span>
<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbedtls_ssl_handshake</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtls_srtp</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">);</span>

<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MBEDTLS_ERR_SSL_WANT_READ</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MBEDTLS_ERR_SSL_WANT_WRITE</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>SSLçš„æ¡æ‰‹</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* Main handshake loop */</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ssl</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MBEDTLS_SSL_HANDSHAKE_OVER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbedtls_ssl_handshake_step</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">ä¸»è¦å°±æ˜¯è°ƒç”¨mbedtls_ssl_handshake_step</span><span class="err">ï¼Œ</span><span class="n">ä¸‹é¢åªåˆ—å‡ºäº†æœåŠ¡ç«¯çš„ä»£ç ç¤ºä¾‹</span><span class="err">ã€‚</span>

<span class="kt">int</span><span class="w"> </span><span class="n">mbedtls_ssl_handshake_step</span><span class="p">(</span><span class="n">mbedtls_ssl_context</span><span class="w"> </span><span class="o">*</span><span class="n">ssl</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MBEDTLS_ERR_ERROR_CORRUPTION_DETECTED</span><span class="p">;</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ssl_prepare_handshake_step</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbedtls_ssl_handle_pending_alert</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">cleanup</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="cp">#if defined(MBEDTLS_SSL_SRV_C)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ssl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MBEDTLS_SSL_IS_SERVER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/*è°ƒç”¨mbedtls_ssl_handshake_server_stepè¿›è¡Œæ¡æ‰‹ç®¡ç†*/</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mbedtls_ssl_conf_is_tls12_only</span><span class="p">(</span><span class="n">ssl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbedtls_ssl_handshake_server_step</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* handshake_step return error. And it is same</span>
<span class="cm">         * with alert_reason.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ssl</span><span class="o">-&gt;</span><span class="n">send_alert</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbedtls_ssl_handle_pending_alert</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">cleanup</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="nl">cleanup</span><span class="p">:</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>ä¸»è¦æ˜¯æ¥ç€è°ƒç”¨mbedtls_ssl_handshake_server_stepè¿›è¡Œå¤„ç†ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">mbedtls_ssl_handshake_server_step</span><span class="p">(</span><span class="n">mbedtls_ssl_context</span><span class="w"> </span><span class="o">*</span><span class="n">ssl</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">MBEDTLS_SSL_DEBUG_MSG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s">"server state: %d"</span><span class="p">,</span><span class="w"> </span><span class="n">ssl</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ssl</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_HELLO_REQUEST</span><span class="p">:</span>
<span class="w">            </span><span class="n">ssl</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MBEDTLS_SSL_CLIENT_HELLO</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         *  &lt;==   ClientHello</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_CLIENT_HELLO</span><span class="p">:</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ssl_parse_client_hello</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="cp">#if defined(MBEDTLS_SSL_PROTO_DTLS)</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_SERVER_HELLO_VERIFY_REQUEST_SENT</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">MBEDTLS_ERR_SSL_HELLO_VERIFY_REQUIRED</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         *  ==&gt;   ServerHello</span>
<span class="cm">         *        Certificate</span>
<span class="cm">         *      ( ServerKeyExchange  )</span>
<span class="cm">         *      ( CertificateRequest )</span>
<span class="cm">         *        ServerHelloDone</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_SERVER_HELLO</span><span class="p">:</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ssl_write_server_hello</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_SERVER_CERTIFICATE</span><span class="p">:</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbedtls_ssl_write_certificate</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_SERVER_KEY_EXCHANGE</span><span class="p">:</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ssl_write_server_key_exchange</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_CERTIFICATE_REQUEST</span><span class="p">:</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ssl_write_certificate_request</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_SERVER_HELLO_DONE</span><span class="p">:</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ssl_write_server_hello_done</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         *  &lt;== ( Certificate/Alert  )</span>
<span class="cm">         *        ClientKeyExchange</span>
<span class="cm">         *      ( CertificateVerify  )</span>
<span class="cm">         *        ChangeCipherSpec</span>
<span class="cm">         *        Finished</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_CLIENT_CERTIFICATE</span><span class="p">:</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbedtls_ssl_parse_certificate</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_CLIENT_KEY_EXCHANGE</span><span class="p">:</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ssl_parse_client_key_exchange</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_CERTIFICATE_VERIFY</span><span class="p">:</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ssl_parse_certificate_verify</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_CLIENT_CHANGE_CIPHER_SPEC</span><span class="p">:</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbedtls_ssl_parse_change_cipher_spec</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_CLIENT_FINISHED</span><span class="p">:</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbedtls_ssl_parse_finished</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         *  ==&gt; ( NewSessionTicket )</span>
<span class="cm">         *        ChangeCipherSpec</span>
<span class="cm">         *        Finished</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_SERVER_CHANGE_CIPHER_SPEC</span><span class="p">:</span>
<span class="cp">#if defined(MBEDTLS_SSL_SESSION_TICKETS)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ssl</span><span class="o">-&gt;</span><span class="n">handshake</span><span class="o">-&gt;</span><span class="n">new_session_ticket</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ssl_write_new_session_ticket</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbedtls_ssl_write_change_cipher_spec</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_SERVER_FINISHED</span><span class="p">:</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbedtls_ssl_write_finished</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_FLUSH_BUFFERS</span><span class="p">:</span>
<span class="w">            </span><span class="n">MBEDTLS_SSL_DEBUG_MSG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s">"handshake: done"</span><span class="p">));</span>
<span class="w">            </span><span class="n">ssl</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MBEDTLS_SSL_HANDSHAKE_WRAPUP</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MBEDTLS_SSL_HANDSHAKE_WRAPUP</span><span class="p">:</span>
<span class="w">            </span><span class="n">mbedtls_ssl_handshake_wrapup</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="n">MBEDTLS_SSL_DEBUG_MSG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s">"invalid state %d"</span><span class="p">,</span><span class="w"> </span><span class="n">ssl</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">MBEDTLS_ERR_SSL_BAD_INPUT_DATA</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>ä¸»è¦å°±æ˜¯é’ˆå¯¹æ¡æ‰‹çš„çŠ¶æ€è¿›è¡Œæ¡æ‰‹äº¤äº’ï¼Œå…·ä½“è¿™é‡Œå°±ä¸é˜è¿°äº†ï¼Œå¯ä»¥å‚è€ƒã€ŠSSL/TLSåè®®åˆ†æã€‹æ–‡ç« ã€‚</p>
<h4 id="sctp">SCTP</h4>
<p>SCTPä¸»è¦ä½¿ç”¨çš„usrctpå¼€æºç»„ä»¶ï¼Œ</p>
<h3 id="_11">ä¼ è¾“</h3>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">g_interrupted</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">g_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PEER_CONNECTION_COMPLETED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">curr_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_timestamp</span><span class="p">();</span>

<span class="w">      </span><span class="c1">// FPS 25</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">video_time</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">video_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr_time</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reader_get_video_frame</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">peer_connection_send_video</span><span class="p">(</span><span class="n">g_pc</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">audio_time</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reader_get_audio_frame</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">peer_connection_send_audio</span><span class="p">(</span><span class="n">g_pc</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">audio_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr_time</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="n">usleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="stunåè®®.html">â† STUNåè®®</a>
    <a class="next" href="ä¹Œé¾Ÿå›¾åˆ†ææ³•.html">ä¹Œé¾Ÿå›¾åˆ†ææ³• â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

