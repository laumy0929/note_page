<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CFSåˆ†ç»„è°ƒåº¦ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">åŸºæœ¬åŸç†</a><ul></ul></li><li><a href="#_2">åˆ›å»ºç»„è°ƒåº¦</a><ul></ul></li><li><a href="#_3">æƒé‡</a><ul></ul></li><li><a href="#_4">å¸¦å®½ç®¡ç†</a><ul><li><a href="#_5">ä»»åŠ¡ç»„å‰©ä½™æ—¶é—´</a></li><li><a href="#_6">é™åˆ¶ä»»åŠ¡ç»„è¿è¡Œ</a></li><li><a href="#period_timeslack_timer">period_timeå’Œslack_timerå®šæ—¶å™¨</a></li><li><a href="#_7">å°ç»“</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>CFSåˆ†ç»„è°ƒåº¦</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-04-01
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_f1872becbdd34723c385b1b47f19f12e.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/5-cfsåˆ†ç»„è°ƒåº¦/images/wp_editor_md_f1872becbdd34723c385b1b47f19f12e.jpg"/></a></p>
<p>Linuxç³»ç»Ÿéƒ½æ˜¯æ”¯æŒå¤šç”¨æˆ·ç™»å½•ï¼Œå¦‚æœä¸€ä¸ªLinuxç³»ç»Ÿä¸¤ä¸ªç”¨æˆ·å­˜åœ¨ä¸åŒçš„æ•°é‡çš„è¿›ç¨‹ï¼Œå‡è®¾Aç”¨æˆ·æœ‰10ä¸ªè¿›ç¨‹ï¼ŒBç”¨æˆ·æœ‰20ä¸ªè¿›ç¨‹ï¼Œå¦‚æœç³»ç»Ÿå¯¹è¿™30ä¸ªè¿›ç¨‹è¿›è¡Œå¹³åˆ†CPUï¼Œå®é™…ä¸Šæ˜¯ä¸å…¬å¹³çš„ï¼Œå› æ­¤å¼•å…¥äº†ç»„è°ƒåº¦çš„æ¦‚å¿µï¼Œå³Aç”¨æˆ·å¯¹CPUçš„å ç”¨åº”è¯¥è·ŸBç”¨å¯¹CPUçš„å ç”¨å„è‡ªä¸º50%ï¼ŒA/Bç”¨æˆ·ä¸‹çš„è¿›ç¨‹å†æ ¹æ®å¾—åˆ°å ç”¨è¿›è¡Œåˆ’åˆ†ã€‚ç³»ç»Ÿä¸­æœ‰cfsç»„è°ƒåº¦å’Œrtç»„è°ƒåº¦ï¼Œæœ¬å°èŠ‚ä¸»è¦ä»¥cfsè°ƒåº¦ä¸ºä¸»ã€‚ å¦‚ä¸Šå›¾ï¼Œç»„Açš„è¿›ç¨‹åˆ†åˆ«åˆ†é…åˆ°äº†CPU0å’ŒCPU1ä¸Šè¿è¡Œï¼Œåœ¨CPU0å’ŒCPU1ä¸Šçš„è¿›ç¨‹å„è‡ªç»„åˆæˆä¸€ä¸ªè°ƒåº¦å®ä½“G1ï¼Œä¸¤ä¸ªç»„åœ¨å„è‡ªçš„CPUä¸Šäº’ä¸å½±å“ã€‚ä»¥CPU0ä¸ºä¾‹ï¼ŒG1å’ŒP1åœ¨ä¸€é¢—çº¢é»‘æ ‘ä¸­è¿›è¡Œè°ƒåº¦ï¼ŒG1è·å¾—çš„â€œè°ƒåº¦èµ„æºâ€ï¼Œå°†éœ€è¦â€œå¹³åˆ†â€ç»™å…¶ç»„å‘˜ï¼ˆç»„è¿›ç¨‹ï¼‰ã€‚</p>
<h2 id="_1">åŸºæœ¬åŸç†</h2>
<p>ä½¿ç”¨struct task_groupæ¥æè¿°ä»»åŠ¡ç»„ï¼Œä¸‹é¢æ˜¯struct task_groupçš„æ•°æ®ç»“æ„ï¼Œåç»­çš„ç»„ç”¨tgç®€ç§°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">kernel</span><span class="o">/</span><span class="n">sched</span><span class="o">/</span><span class="n">sched</span><span class="p">.</span><span class="n">h</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">task_group</span><span class="w"> </span><span class="p">{</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">cgroup_subsys_state</span><span class="w"> </span><span class="n">css</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">**</span><span class="n">se</span><span class="p">;</span><span class="w"> </span><span class="c1">//åŠ¨æ€æ•°ç»„ï¼Œå¯¹åº”æ¯ä¸ªcpuä¸Šè°ƒåº¦å®ä½“</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w">   </span><span class="o">**</span><span class="n">cfs_rq</span><span class="p">;</span><span class="c1">//åŠ¨æ€æ•°ç»„ï¼Œå¯¹åº”æ¯ä¸ªcpuä¸Šè°ƒåº¦å®ä½“ä¸‹çš„è¿›ç¨‹é›†åˆ</span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">  </span><span class="n">shares</span><span class="p">;</span><span class="w"> </span><span class="c1">//å½“å‰è¿›ç¨‹ç»„æƒé‡</span>
<span class="n">atomic_long_t</span><span class="w">  </span><span class="n">load_avg</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">sched_rt_entity</span><span class="w">  </span><span class="o">**</span><span class="n">rt_se</span><span class="p">;</span><span class="w"> </span>
<span class="k">struct</span><span class="w"> </span><span class="nc">rt_rq</span><span class="w">  </span><span class="o">**</span><span class="n">rt_rq</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">rt_bandwidth</span><span class="w"> </span><span class="n">rt_bandwidth</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w">  </span><span class="n">å…¨å±€æ‰€æœ‰ä»»åŠ¡ç»„åŠ å…¥åˆ°å…¨å±€é“¾è¡¨task_groupsä¸Š</span><span class="err">ã€‚</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">task_group</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span><span class="w">  </span><span class="n">æŒ‡å‘å½“å‰è°ƒåº¦ç»„çš„çˆ¶ä»»åŠ¡ç»„</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">  </span><span class="n">siblings</span><span class="p">;</span><span class="w">   </span><span class="n">å°†å½“å‰tgæŒ‚è½½åˆ°çˆ¶tgçš„childrené“¾è¡¨ä¸Š</span><span class="err">ã€‚</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">  </span><span class="n">children</span><span class="p">;</span><span class="w">  </span><span class="n">æŒ‚ç€å½“å‰tgç»„æ‰€æœ‰å­©å­çš„tg</span><span class="err">ã€‚</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">cfs_bandwidth</span><span class="w">  </span><span class="n">cfs_bandwidth</span><span class="p">;</span><span class="w"> </span><span class="n">ç”¨äºå¸¦å®½æ§åˆ¶</span>
<span class="p">}</span>
</code></pre></div>
<p>æ‰€æœ‰çš„ä»»åŠ¡ç»„ä¼šä»¥æ ‘ç»“æ„æ¥ç»„ç»‡ï¼Œåœ¨Linuxç³»ç»Ÿä¸­å®šä¹‰äº†ä¸€ä¸ªå…¨å±€çš„æ ¹èŠ‚ç‚¹struct task_group root_task_group;åŒæ—¶å®šä¹‰ä¸€ä¸ªå…¨å±€é“¾è¡¨LIST_HEAD(task_groups)å°†æ‰€æœ‰ä»»åŠ¡ç»„ä¸²åœ¨ä¸€ä¸ªé“¾è¡¨ä¸Šã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_b496009e3a560090c5d6e04e4aaeb35d.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/5-cfsåˆ†ç»„è°ƒåº¦/images/wp_editor_md_b496009e3a560090c5d6e04e4aaeb35d.jpg"/></a></p>
<p>å¦‚ä¸Šå›¾ï¼ŒG1~G4å½¢æˆä¸€é¢—æ ‘ï¼Œæ ¹ä¸ºroot_task_groupï¼Œå¹¶ä¸”G1~G4ä¸²è”åœ¨é“¾è¡¨ä¸Štask_groupsä¸Šã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_1b6edc49fa6d706aade6d2e82c4f1344.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/5-cfsåˆ†ç»„è°ƒåº¦/images/wp_editor_md_1b6edc49fa6d706aade6d2e82c4f1344.jpg"/></a></p>
<p>ä¸Šå›¾æ˜¯task_groupä¸è°ƒåº¦ç›¸å…³æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»ã€‚task_groupæœ‰è‡ªå·±çš„è°ƒåº¦å®ä½“struct sched_entityï¼Œä¸task_structä¸­çš„è°ƒåº¦å®ä½“åŒºåˆ«æ˜¯ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼ŒæŒ‡é’ˆæ•°ç»„çš„å¤§å°ä¸ºå½“å‰cpuæ ¸çš„ä¸ªæ•°ï¼Œå› ä¸ºä¸€ç»„ä¸­æœ‰å¤šä¸ªè¿›ç¨‹ï¼Œä½†æ˜¯è¿™äº›è¿›ç¨‹å¯ä»¥åˆ†é…åˆ°ä¸åŒçš„cpuæ ¸ä¸Šï¼Œå› æ­¤æ¯ä¸ªæ•°ç»„seè¡¨ç¤ºä¸€ä¸ªcpuæ ¸ä¸Šçš„è°ƒåº¦å®ä½“ï¼Œä¹Ÿå°±æ˜¯è¯´å½“åˆ†é…ä¸€ä¸ªç»„æ—¶ï¼Œå°±ä¼šä¸ºæ¯ä¸ªCPUéƒ½ä¼šç»´æŠ¤ä¸€ä¸ªseã€‚åŒç†task_groupä¸­cfs_rqçº¢é»‘æ ‘ç”¨äºè®°å½•ç»„ä»»åŠ¡ä¸­åœ¨æ¯ä¸ªcpuä¸‹çš„è¿›ç¨‹ã€‚ <a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_f211e60f6594dda7734cbc030a62a4e7.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/5-cfsåˆ†ç»„è°ƒåº¦/images/wp_editor_md_f211e60f6594dda7734cbc030a62a4e7.jpg"/></a> â€ƒâ€ƒä¸Šå›¾æ˜¯ä¸€ä¸ªä»»åŠ¡ç»„çš„ç¤ºä¾‹ï¼Œä»»åŠ¡ç»„tgä¸‹è¿›ç¨‹åˆ†é…åˆ°CPU0å’ŒCPU1ä¸Šè¿è¡Œã€‚å…¨å±€root_task_groupï¼Œå…¶seå’Œparentéƒ½ä¼šNULLï¼Œcfsåˆ†åˆ«æŒ‡å‘CPU0å’ŒCPU1çš„cfsé˜Ÿåˆ—ã€‚å› ä¸ºä»»åŠ¡ç»„tgä¸‹çš„è¿›ç¨‹åˆ†å¸ƒåœ¨ä¸¤ä¸ªcpuä¸Šï¼Œå› æ­¤CPU0å’ŒCPU1å„è‡ªå¯¹åº”ä¸€ä¸ªä»»åŠ¡ç»„è°ƒåº¦å®ä½“group seï¼Œtgä¸­çš„se[0]å’Œse[1]åˆ†åˆ«æŒ‡å‘cpu0å’Œcpu1ä¸Šç»„è°ƒåº¦å®ä½“ï¼Œç»„è°ƒåº¦å®ä½“groupå’Œè¿›ç¨‹è°ƒåº¦å®ä½“task seå¤„äºç¬¬ä¸€çº§çš„å¹³è¡Œå…³ç³»ï¼Œä¹Ÿå°±æ˜¯è°ƒåº¦å…¬å¹³ã€‚Group seä¸­my_qå’Œtgä¸­cfsæŒ‡å‘äº†ä»»åŠ¡ç»„è¿›ç¨‹çš„é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—å¤„äºè°ƒåº¦çš„ç¬¬äºŒçº§ã€‚æ‰€ä»¥å½“ç»„è°ƒåº¦å®ä½“å†ä¸å¹³è¡Œå…³ç³»çš„è¿›ç¨‹è·å¾—è°ƒåº¦æœºä¼šåï¼Œå°†å¹³å‡ï¼ˆå†æŒ‰ç…§CFSç®—æ³•ï¼‰åˆ†ç»™å…¶ç»„å†…è¿›ç¨‹è¿›è¡Œè°ƒåº¦ã€‚</p>
<h2 id="_2">åˆ›å»ºç»„è°ƒåº¦</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_83f17783a3f6eb2fd197656bd3c0c744.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/5-cfsåˆ†ç»„è°ƒåº¦/images/wp_editor_md_83f17783a3f6eb2fd197656bd3c0c744.jpg"/></a></p>
<h2 id="_3">æƒé‡</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_85da865b68ca007a09b5c82d9bcb1277.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/5-cfsåˆ†ç»„è°ƒåº¦/images/wp_editor_md_85da865b68ca007a09b5c82d9bcb1277.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="n">gse</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weigh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tg</span><span class="o">-&gt;</span><span class="n">weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">grq</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Sum</span><span class="w"> </span><span class="n">grq</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span>
</code></pre></div>
<ul>
<li>tg-&gt;weightï¼šä»»åŠ¡ç»„é»˜è®¤æƒé‡å€¼ï¼Œç­‰äºtg-&gt;sharesï¼Œé»˜è®¤æ˜¯1024ã€‚</li>
<li>grq-&gt;load.weightï¼šå•cpuä¸‹ä»»åŠ¡ç»„ä¸­æ‰€æœ‰è¿›ç¨‹çš„æƒé‡ä¹‹å’Œã€‚</li>
<li>Sum grq-&gt;load.weightï¼šä»»åŠ¡ç»„ä¸­æ‰€æœ‰è¿›ç¨‹ä»»åŠ¡ä¹‹åï¼ŒåŒ…å«åˆ†é…åœ¨å„cpuä¸Šçš„ã€‚ ç¤ºä¾‹ï¼šcpu0</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">gse</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2048</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3072</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3145728</span><span class="o">/</span><span class="mi">6144</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span>
</code></pre></div>
<p>ä¸Šé¢æ˜¯ç†æƒ³åŒ–çš„å…¬å¼æ¨¡å‹ï¼Œä½†æ˜¯å®é™…æƒ…å†µSum grq-&gt;load.weightå› ä¸ºéœ€è¦æ¶‰åŠè®¿é—®å„ä¸ªCPUä¸Šçš„grqï¼Œä¼šå¯¼è‡´é”ç«äº‰çš„ä»£ä»·ï¼Œå› æ­¤æ ¹æ®ä¸Šé¢å…¬å¼åšäº†è¿‘ä¼¼è®¡ç®—æœ€ç»ˆå¾—åˆ°å¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">gse</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tg</span><span class="o">-</span><span class="n">weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">grq</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="w">  </span><span class="o">/</span>
<span class="w"> </span><span class="p">(</span><span class="n">tg</span><span class="o">-&gt;</span><span class="n">load_avg</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">grq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_avg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="p">(</span><span class="n">grq</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="p">,</span><span class="n">grq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_avg</span><span class="p">))</span>
</code></pre></div>
<p>å…·ä½“æ¼”åŒ–ç»“æœå¯ä»¥å‚è€ƒkernel/sched/fair.cä¸­calc_group_shareså‡½æ•°çš„æ³¨é‡Šï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†é˜è¿°äº†ï¼Œcalc_group_sharesé€šè¿‡ä¸Šé¢çš„å…¬å¼è¿‘ä¼¼è®¡ç®—å„ä¸ªgseåˆ†å¾—çš„æƒé‡ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">calc_group_shares</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">tg_weight</span><span class="p">,</span><span class="w"> </span><span class="n">tg_shares</span><span class="p">,</span><span class="w"> </span><span class="n">load</span><span class="p">,</span><span class="w"> </span><span class="n">shares</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">task_group</span><span class="w"> </span><span class="o">*</span><span class="n">tg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">tg</span><span class="p">;</span>

<span class="w">    </span><span class="n">tg_shares</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">tg</span><span class="o">-&gt;</span><span class="n">shares</span><span class="p">);</span>
<span class="w">    </span><span class="n">load</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">scale_load_down</span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="p">),</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">.</span><span class="n">load_avg</span><span class="p">);</span>
<span class="n">tg_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_long_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tg</span><span class="o">-&gt;</span><span class="n">load_avg</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Ensure tg_weight &gt;= load */</span>
<span class="w">    </span><span class="n">tg_weight</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">tg_load_avg_contrib</span><span class="p">;</span>
<span class="n">tg_weight</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">load</span><span class="p">;</span>

<span class="w">    </span><span class="n">shares</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tg_shares</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">load</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tg_weight</span><span class="p">)</span>
<span class="w">        </span><span class="n">shares</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">tg_weight</span><span class="p">;</span>
<span class="k">return</span><span class="w"> </span><span class="n">clamp_t</span><span class="p">(</span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">shares</span><span class="p">,</span><span class="w"> </span><span class="n">MIN_SHARES</span><span class="p">,</span><span class="w"> </span><span class="n">tg_shares</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>ä»å…¬å¼å¯ä»¥çœ‹å‡ºï¼Œgseçš„æƒé‡ä¸ä»»åŠ¡ç»„è¿›ç¨‹ä¸ªæ•°ä»¥åŠcpu.sharesæœ‰å…³ç³»ã€‚cpu.sharesåˆ™æ˜¯ç”¨æˆ·èŠ‚ç‚¹/sys/fs/cgroup/cpu.shareså¯æ§åˆ¶ã€‚</p>
<p><a href="http://8.134.108.235/wp-content/uploads/2023/11/wp_editor_md_b324dfa242721d363041ac6592844cd7.jpg"><img alt="" src="images/wp_editor_md_b324dfa242721d363041ac6592844cd7.jpg"/></a></p>
<h2 id="_4">å¸¦å®½ç®¡ç†</h2>
<p>è€ƒè™‘è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯ï¼Œå‡è®¾ä¸€ä¸ªç”¨æˆ·åªæ”¯ä»˜äº†0.5ä¸ªCPUçš„è´¹ç”¨ï¼Œé‚£ä¹ˆæ­£å¸¸æƒ…å†µä¸‹å°±åªèƒ½ç»™å…¶0.5ä¸ªCPUçš„æ—¶é—´ã€‚å› æ­¤ä¸ºäº†é™åˆ¶ç”¨æˆ·è¿›ç¨‹å¯¹CPUèµ„æºå ç”¨æƒ…å†µï¼Œå¼•å…¥å¸¦å®½æ§åˆ¶ï¼Œå¸¦å®½æ§åˆ¶æ˜¯åŸºäºåˆ†ç»„è°ƒåº¦æ¥å®ç°ï¼Œå¯¹ä¸€ä¸ªä»»åŠ¡ç»„çš„è¿è¡Œå¸¦å®½åšé™åˆ¶ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ªå‘¨æœŸå†…ï¼Œå…è®¸ä¸€ä¸ªä»»åŠ¡ç»„æœ€å¤šæ‰§è¡Œå¤šé•¿æ—¶é—´ï¼Œå½“ä»»åŠ¡ç»„è¿è¡Œå®Œäº†è‡ªå·±çš„æ—¶é—´ï¼Œå°†ä¼šè¢«é™åˆ¶ä¸å…è®¸è¿è¡Œï¼Œå³ä½¿æ²¡æœ‰ä»»ä½•ä»»åŠ¡è¿è¡Œï¼Œä¹Ÿéœ€è¦ç­‰åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_bd494f7998e02be44ea568046034efc4.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/5-cfsåˆ†ç»„è°ƒåº¦/images/wp_editor_md_bd494f7998e02be44ea568046034efc4.jpg"/></a></p>
<p>å¸¦å®½é™åˆ¶ä»¥ä»»åŠ¡ç»„ä¸ºå•ä½è¿›è¡Œé™åˆ¶ï¼Œä¸ºæ–¹ä¾¿æè¿°åŸç†ï¼Œä¸Šå›¾æ˜¯åªæœ‰ä¸€ä¸ªä»»åŠ¡ç»„ï¼Œä»»åŠ¡ç»„ä¸­çš„è¿›ç¨‹è¢«åˆ†é…åˆ°CPU0å’ŒCPU1ä¸Šè¿è¡Œã€‚åœ¨task_groupæ•°æ®ç»“æ„ä¸­ï¼Œcfs_bandwidthæˆå‘˜ç”¨äºå…¨å±€æè¿°å½“å‰ä»»åŠ¡ç»„å¸¦å®½é™åˆ¶ï¼Œè¡¨ç¤ºåœ¨ä¸€ä¸ªperiodå‘¨æœŸå†…ï¼Œä»»åŠ¡ç»„å¯ä½¿ç”¨çš„æ—¶é—´ä¸ºquotaï¼Œè¿™é‡Œçš„æ—¶é—´æ˜¯ä»»åŠ¡ç»„ä¸­è¿›ç¨‹çš„å’Œï¼Œå½“quotaä½¿ç”¨å®Œåï¼Œåœ¨æ•´ä¸ªå‘¨æœŸå†…å°†ä¼šè¢«é™åˆ¶è¿è¡Œï¼Œç§°ä¸ºthrottleæ“ä½œã€‚ â€ƒâ€ƒåœ¨ä»»åŠ¡ç»„tgï¼ˆä¾¿äºç®€åŒ–å‡è®¾ç”¨æˆ·ç»„ä¸­åªæœ‰ä¸€ä¸ªä»»åŠ¡ç»„ï¼Œæš‚ä¸”ä¹Ÿç§°ç”¨æˆ·ç»„ï¼‰ä¸­æœ‰cpuæ•°é‡çš„å°±ç»ªé˜Ÿåˆ—ï¼Œå¯¹åº”ä¸Šå›¾çš„cfs_rq0å’Œcfs_rq1ï¼Œè¿™ä¸¤ä¸ªå°±ç»ªé˜Ÿåˆ—æ‰€å±äºä»»åŠ¡ç»„ã€‚å°±ç»ªé˜Ÿåˆ—ä¸­runtime_remainingä¸ºå½“å‰é˜Ÿåˆ—ä¸­æ‰€æœ‰è¿›ç¨‹å¯è¿è¡Œçš„æ—¶é—´ï¼Œè¿›ç¨‹è¿è¡Œæ—¶å°±ä¼šæ¶ˆè€—runtime_remainingï¼Œå½“runtime_remainingè¢«æ¶ˆè€—å°äº0æ—¶ï¼Œå¯ä»¥å‘å…¨å±€æ—¶é—´æ± tg-&gt;cfs_b-&gt;runtimeï¼ˆè¡¨ç¤ºä»»åŠ¡ç»„å‰©ä½™å¯ä½¿ç”¨çš„æ—¶é—´ï¼‰ä¸­ç”³è¯·ï¼Œæ¯æ¬¡ç”³è¯·çš„å€¼ä¸ºsysctl_sched_cfs_bandwidth_sliceï¼ˆå¯èŠ‚ç‚¹é…ç½®ï¼Œé»˜è®¤æ˜¯5msï¼‰ï¼Œå½“tg-&gt;cfs_b-&gt;runtimeå°†è¢«è€—å°½æ—¶ï¼Œä¸èƒ½æ»¡è¶³cfs_rqx-&gt;runtime_remainingæ—¶ï¼Œcfs_rqxå°±ç»ªé˜Ÿåˆ—å°†ä¼šè¢«ç§»é™¤ï¼ˆå¯¹åº”çš„gseåœ¨ä¸Šä¸€çº§ä¸­è¢«ç§»é™¤ï¼‰ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_f7d6f1f643860b179cda2f07ac6d2d40.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/5-cfsåˆ†ç»„è°ƒåº¦/images/wp_editor_md_f7d6f1f643860b179cda2f07ac6d2d40.jpg"/></a></p>
<p>ï¼ˆ1ï¼‰cfs_bandwidth - period: å®šæ—¶å™¨å‘¨æœŸæ—¶é—´ - quota:åœ¨å‘¨æœŸå†…ä»»åŠ¡ç»„å¯ä½¿ç”¨çš„æ—¶é—´ - runtime:å‰©ä½™æ—¶é—´ï¼Œquota+runtime = period - period_timer:å‘¨æœŸæ€§å®šæ—¶å™¨ï¼Œå®šæ—¶åˆ°è¾¾åé‡ç½®å‰©ä½™é™é¢runtimeä¸ºquotaã€‚ - slack_timer: - throttled_cfs_rq:æ‰€æœ‰è¢«throttleçš„cfs_rqæŒ‚å…¥åˆ°æ¬¡é“¾è¡¨ï¼Œç”¨äºåæœŸunthrottle cfs_rqæ“ä½œã€‚ ï¼ˆ2ï¼‰cfs_rqä¸­å…³äºå¸¦å®½ç®¡ç†æè¿° - runtime_enabledï¼šè¯¥å°±ç»ªé˜Ÿåˆ—æ˜¯å¦å¼€å¯å¸¦å®½é™åˆ¶ã€‚ - runtime_remaining: cfs_rqä¼šä»å…¨å±€æ—¶é—´æ± ç”³è¯·æ—¶é—´ç‰‡ï¼Œå½“å‰©ä½™æ—¶é—´ç‰‡å°äº0ï¼Œéœ€è¦é‡æ–°ç”³è¯·ã€‚ - throttled:åˆ¤å®šcfs_rqæ˜¯å¦è¢«throttledã€‚ - throttled_list: è¢«throttled_listçš„cfs_rqä¼šè¢«æŒ‚å…¥åˆ°cfs_bandwidth-&gt;throttled_cfs_rqé“¾è¡¨ã€‚</p>
<h3 id="_5">ä»»åŠ¡ç»„å‰©ä½™æ—¶é—´</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_3aea9612ab0d9b0231d2fe8a3252b0b7.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/5-cfsåˆ†ç»„è°ƒåº¦/images/wp_editor_md_3aea9612ab0d9b0231d2fe8a3252b0b7.jpg"/></a></p>
<p>åœ¨task_groupä¸­ï¼Œåœ¨æ¯ä¸ªCPUä¸Šéƒ½æœ‰ä¸€ä¸ªcfs_rqçº¢é»‘æ ‘ï¼Œcfs_rqç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªruntime_reminingç”¨äºæè¿°å½“å‰ç»„èƒ½å¤Ÿè¿è¡Œçš„æ—¶é—´åˆè®¡ï¼Œä»»åŠ¡ç»„ä¸­çš„æ¯ä¸ªä»»åŠ¡è¿è¡Œéƒ½ä¼šæ¶ˆè€—æ‰runtime_reminingï¼Œå½“runtime_remainingè¢«æ¶ˆè€—å®Œæ—¶ä¼šä»å…¨å±€æ—¶é—´æ± ç”³è¯·ï¼Œå¦‚æœå…¨å±€æ± ä¸­çš„æ—¶é—´ä¹Ÿç”¨å®Œäº†ï¼Œé‚£ä¹ˆå°±éœ€è¦è®©å‡ºè°ƒåº¦ï¼Œcfs_rqå°±ä¼šè¢«throttleã€‚ runtime_remainingçš„æ›´æ–°åœ¨update_currå‡½æ•°ä¸­è¿›è¡Œã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºcfs_rq-&gt;runtime_remaining-=delta_execï¼Œæ¯ä¸ªè¿›ç¨‹å°†ä¼šå¯¹runtime_remainningè¿›è¡Œæ¶ˆè€—ï¼Œå½“runtime_remainingä¸è¶³æ—¶ï¼Œè°ƒç”¨assign_cfs_rq_runtimeè¿›è¡Œç”³è¯·ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">__assign_cfs_rq_runtime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_bandwidth</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_b</span><span class="p">,</span>
<span class="w">                   </span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">target_runtime</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">min_amount</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* note: this is a positive sum as runtime_remaining &lt;= 0 */</span>
<span class="w">    </span><span class="n">min_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target_runtime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">runtime_remaining</span><span class="p">;</span><span class="w"> </span>
<span class="c1">//è®¡ç®—æ¯æ¬¡å‘å…¨å±€æ—¶é—´æ± è¦ç”³è¯·çš„æ—¶é—´ç‰‡å¤§å°ï¼Œtarget_runtimç”±sched_cfs_bandwidth_slice()è®¡ç®—å¾—æ¥ï¼Œé»˜è®¤æ˜¯5msï¼Œå¯ä»¥é€šè¿‡sched_cfs_bandwidth_slice_usèŠ‚ç‚¹è¿›è¡Œä¿®æ”¹ã€‚</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">quota</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RUNTIME_INF</span><span class="p">)</span><span class="w">  </span><span class="c1">//ä¸é™åˆ¶å¸¦å®½ï¼Œremainigå¯ä»¥ä¸€ç›´ç”³è¯·åˆ°æ—¶é—´ç‰‡ã€‚</span>
<span class="w">        </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min_amount</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">start_cfs_bandwidth</span><span class="p">(</span><span class="n">cfs_b</span><span class="p">);</span><span class="w">  </span><span class="c1">//å¦‚æœæ²¡æœ‰å¯åŠ¨cfs_b-&gt;period_timerå°±å¯åŠ¨</span>
<span class="w">        </span><span class="c1">//å¦‚æœå…¨å±€æ—¶é—´æ± æ—¶é—´è¿˜æœ‰å‰©ä½™ï¼Œåˆ™åˆ†é…ç»™å½“å‰å°±ç»ªé˜Ÿåˆ—ã€‚</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span><span class="w"> </span><span class="n">min_amount</span><span class="p">);</span><span class="w"> </span>
<span class="w">            </span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span><span class="w"> </span><span class="c1">//æ—¶é—´è¢«ç“œåˆ†å‡ºå»</span>
<span class="w">            </span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">idle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//æ›´æ–°å½“å‰é˜Ÿåˆ—çš„å‰©ä½™æ—¶é—´</span>
<span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">runtime_remaining</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//å¦‚æœæ²¡æœ‰ä»å…¨å±€æ± ç”³è¯·åˆ°æ—¶é—´ç‰‡ï¼Œåˆ™è¿”å›0ï¼Œé‚£ä¹ˆå½“å‰è¿›ç¨‹å°†ä¼šè¢«throttleï¼Œè®©å‡ºè°ƒåº¦ã€‚</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">runtime_remaining</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>ä»»åŠ¡ç»„ä¸€ä¸ªå…¨å±€æ—¶é—´æ± ï¼Œå‰©ä½™å…¨å±€æ± çš„æ—¶é—´å­˜å‚¨åœ¨cfs_b-&gt;runtimeä¸­ï¼Œå…¶æ‰€å±çš„å°±ç»ªé˜Ÿåˆ—cfs_rqä¼šä»å…¨å±€æ± ä¸­ç”³è¯·å¯ä½¿ç”¨çš„æ—¶é—´ï¼Œæ¯æ¬¡ç”³è¯·æ—¶é—´å¤§å°ä¸ºsched_cfs_bandwidth_slice_usï¼ˆå¯é€šè¿‡èŠ‚ç‚¹æ¥è¿›è¡Œä¿®æ”¹é»˜è®¤æ˜¯5msï¼‰ã€‚ â€ƒâ€ƒcfs_rq-&gt;runtime_remainingå’Œcfs_b-&gt;runtimeçš„åŒºåˆ«æ˜¯ï¼Ÿruntimeä¸ºä»»åŠ¡ç»„çš„å…¨å±€å‰©ä½™æ—¶é—´ï¼Œä¸€ä¸ªä»»åŠ¡ç»„å¯èƒ½åŒ…å«å¤šä¸ªcfs_rqï¼ˆåŒ…å«å„CPUï¼Œä»¥åŠå­ä»»åŠ¡ç»„ç­‰ï¼‰ï¼Œæ‰€ä»¥runtimeå¤§äºruntime_remainingã€‚cfs_rq-&gt;runtime_remainingå°äºç­‰äº0æ—¶å°±ç»ªé˜Ÿåˆ—cfs_rqçš„è°ƒåº¦å®ä½“å°†ä¼šè¢«ç§»é™¤ï¼Œä¸‹æ¬¡è°ƒåº¦å°†ä¸å†è¢«é€‰æ‹©åˆ°ã€‚</p>
<h3 id="_6">é™åˆ¶ä»»åŠ¡ç»„è¿è¡Œ</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">__account_cfs_rq_runtime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">delta_exec</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* dock delta_exec before expiring quota (as it could span periods) */</span>
<span class="w">    </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">runtime_remaining</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">delta_exec</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">runtime_remaining</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">throttled</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * if we're unable to extend our runtime we resched so that the active</span>
<span class="cm">     * hierarchy can be throttled</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">assign_cfs_rq_runtime</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">likely</span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">))</span>
<span class="w">        </span><span class="n">resched_curr</span><span class="p">(</span><span class="n">rq_of</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>å½“assign_cfs_rq_runtimeä»å…¨å±€æ—¶é—´æ± ä¸­ç”³è¯·ä¸åˆ°æ—¶é—´ï¼Œå°±ä¼šè°ƒç”¨resched_currè§¦å‘è°ƒåº¦ã€‚åœ¨ä»¥ä¸‹åœºæ™¯ä¸‹ï¼Œä¼šæ£€æµ‹æ˜¯å¦è¿›è¡Œé™æµï¼Œå¦‚æœé™åˆ¶åˆ™è°ƒç”¨throttle_cfs_rqå°†å½“å‰è°ƒåº¦å®ä½“ï¼ˆç»„è°ƒåº¦å®ä½“ï¼‰ç§»é™¤å°±ç»ªé˜Ÿåˆ—ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_b8f03e239e249959afd5caf4d2e7a408.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/5-cfsåˆ†ç»„è°ƒåº¦/images/wp_editor_md_b8f03e239e249959afd5caf4d2e7a408.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">throttle_cfs_rq</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rq</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rq_of</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_bandwidth</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tg_cfs_bandwidth</span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">tg</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">se</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">task_delta</span><span class="p">,</span><span class="w"> </span><span class="n">idle_task_delta</span><span class="p">,</span><span class="w"> </span><span class="n">dequeue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="n">raw_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//è®¡ç®—å½“å‰cfs_rqå‰©ä½™å¯ç”¨çš„æ—¶é—´ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__assign_cfs_rq_runtime</span><span class="p">(</span><span class="n">cfs_b</span><span class="p">,</span><span class="w"> </span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">dequeue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//å¦‚æœå‰©ä½™å¯ç”¨æ—¶é—´ä¸º0ï¼Œåˆ™å°†å½“å‰cfs_rqæ·»åŠ åˆ°throttled_cfs_rqã€‚</span>
<span class="w">        </span><span class="n">list_add_tail_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">throttled_list</span><span class="p">,</span>
<span class="w">                  </span><span class="o">&amp;</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">throttled_cfs_rq</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">   </span><span class="c1">//è¿˜æœ‰å‰©ä½™å¯ä½¿ç”¨æ—¶é—´ï¼Œç›´æ¥è¿”å›</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dequeue</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Throttle no longer required. */</span>
<span class="w">    </span><span class="c1">//è·å–å½“å‰cfs_rqå¯¹åº”çš„è°ƒåº¦å®ä½“</span>
<span class="w">    </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">tg</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">[</span><span class="n">cpu_of</span><span class="p">(</span><span class="n">rq_of</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">))];</span>

<span class="w">    </span><span class="cm">/* freeze hierarchy runnable averages while throttled */</span>
<span class="n">rcu_read_lock</span><span class="p">();</span>
<span class="c1">//éå†cfs_rqå­ä»»åŠ¡ç»„ï¼Œå¹¶ç´¯åŠ cfs_rq-&gt;throttle_count++</span>
<span class="w">    </span><span class="n">walk_tg_tree_from</span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">tg</span><span class="p">,</span><span class="w"> </span><span class="n">tg_throttle_down</span><span class="p">,</span><span class="w"> </span><span class="n">tg_nop</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">rq</span><span class="p">);</span>
<span class="w">    </span><span class="n">rcu_read_unlock</span><span class="p">();</span>

<span class="w">    </span><span class="n">task_delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">h_nr_running</span><span class="p">;</span>
<span class="w">    </span><span class="n">idle_task_delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">idle_h_nr_running</span><span class="p">;</span>
<span class="w">    </span><span class="n">for_each_sched_entity</span><span class="p">(</span><span class="n">se</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">qcfs_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq_of</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<span class="w">        </span><span class="cm">/* throttled entity or throttle-on-deactivate */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">on_rq</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">done</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//å°†å½“å‰è°ƒåº¦å®ä½“å‡ºé˜Ÿï¼Œç§»é™¤å°±ç»ªé˜Ÿåˆ—</span>
<span class="w">        </span><span class="n">dequeue_entity</span><span class="p">(</span><span class="n">qcfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">DEQUEUE_SLEEP</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cfs_rq_is_idle</span><span class="p">(</span><span class="n">group_cfs_rq</span><span class="p">(</span><span class="n">se</span><span class="p">)))</span>
<span class="w">            </span><span class="n">idle_task_delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">h_nr_running</span><span class="p">;</span>

<span class="w">        </span><span class="n">qcfs_rq</span><span class="o">-&gt;</span><span class="n">h_nr_running</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">task_delta</span><span class="p">;</span>
<span class="w">        </span><span class="n">qcfs_rq</span><span class="o">-&gt;</span><span class="n">idle_h_nr_running</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">idle_task_delta</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//å¦‚æœå½“å‰è°ƒåº¦å®ä½“çš„å°±ç»ªé˜Ÿåˆ—åªæœ‰ä¸€ä¸ªï¼Œé‚£ä¹ˆçˆ¶è°ƒåº¦å®ä½“ä¹Ÿè¦è¢«å‡ºé˜Ÿã€‚</span>
<span class="w">        </span><span class="c1">//å¦‚æœè°ƒåº¦å®ä½“å°±ç»ªé˜Ÿåˆ—ä¸åªæ˜¯ä¸€ä¸ªï¼Œé‚£ä¹ˆç›´æ¥é€€å‡ºï¼Œä¹Ÿå°±åªå¾ªç¯ä¸€æ¬¡ã€‚</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">qcfs_rq</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/* Avoid re-evaluating load for this entity: */</span>
<span class="w">            </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent_entity</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="p">}</span>
<span class="c1">//è®¾ç½®è¢«é™æµçš„æ ‡å¿—</span>
<span class="w">    </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">throttled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>åˆ¤æ–­ä¸€ä¸ªcfs_rqæ˜¯å¦è¢«é™æµçš„æ ‡å¿—ï¼Œå°±æ˜¯çœ‹cfs_rq-reamainingæ˜¯å¦è¿˜èƒ½ç”³è¯·åˆ°æ—¶é—´ã€‚</p>
<h3 id="period_timeslack_timer">period_timeå’Œslack_timerå®šæ—¶å™¨</h3>
<p>struct cfs_bandwithç»“æ„ä½“ä¸­ï¼Œæœ‰ä¸¤ä¸ªå®šæ—¶å™¨ï¼šperiod_timerå’Œslack_timerã€‚period_timerè®¡æ—¶åˆ°è¾¾æ—¶è¡¨ç¤ºä¸€ä¸ªperiodåˆ°æœŸï¼ˆå¯¹åº”cfs_bandwithä¸­çš„periodå‘¨æœŸï¼‰ï¼Œå°±ä¼šé‡æ–°æ›´æ–°quotaä»¥åŠè§£é™¤ä¹‹å‰é™åˆ¶çš„ä»»åŠ¡ã€‚slack_timeråˆ™è¦è§£å†³çš„æ˜¯å…¨å±€æ—¶é—´æ± æ—¶é—´çš„æµªè´¹é—®é¢˜ï¼Œå‡è®¾ä¸€ä¸ªcfs_rqä»å…¨å±€æ± ç”³è¯·äº†5msæ—¶é—´ç‰‡ï¼Œè€Œcfs_rqä¸­åªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹è¿è¡Œ1mså°±ç¡çœ ä¸€ç›´ç¡çœ äº†ï¼Œè€Œæ•´ä¸ªcfs_rqå¯¹åº”çš„gseä¼šè¢«dequeueï¼Œé‚£ä¹ˆå‰©ä½™çš„4mséœ€è¦å½’éƒ¨åˆ†è¿˜ç»™å…¨å±€æ—¶é—´æ± ï¼Œå½“å…¨å±€æ± æ—¶é—´ç´¯è®¡å¤§äº5msï¼Œé‚£ä¹ˆå°±å¯åŠ¨slack_timerå°†æ­¤å‰ttrottle cfs_rqå–æ¶ˆé™æµã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">init_cfs_bandwidth</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_bandwidth</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_b</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">raw_spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">quota</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RUNTIME_INF</span><span class="p">;</span><span class="w"> </span><span class="c1">//é»˜è®¤=-1ï¼Œæ— é™åˆ¶</span>
<span class="w">    </span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ns_to_ktime</span><span class="p">(</span><span class="n">default_cfs_period</span><span class="p">());</span><span class="w"> </span><span class="c1">//åˆå§‹åŒ–periodï¼Œé»˜è®¤100ms</span>
<span class="w">    </span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">burst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">throttled_cfs_rq</span><span class="p">);</span><span class="w"> </span><span class="c1">//åˆå§‹åŒ–é“¾è¡¨ï¼Œè¢«é™åˆ¶çš„cfså°†æŒ‚åˆ°è¯¥é“¾è¡¨ä¸Š</span>
<span class="w">    </span><span class="n">hrtimer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">period_timer</span><span class="p">,</span><span class="w"> </span><span class="n">CLOCK_MONOTONIC</span><span class="p">,</span><span class="w"> </span><span class="n">HRTIMER_MODE_ABS_PINNED</span><span class="p">);</span>
<span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">period_timer</span><span class="p">.</span><span class="n">function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_cfs_period_timer</span><span class="p">;</span>
<span class="c1">//åˆå§‹åŒ–period_timerå®šæ—¶å™¨</span>

<span class="w">    </span><span class="n">hrtimer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">slack_timer</span><span class="p">,</span><span class="w"> </span><span class="n">CLOCK_MONOTONIC</span><span class="p">,</span><span class="w"> </span><span class="n">HRTIMER_MODE_REL</span><span class="p">);</span>
<span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">slack_timer</span><span class="p">.</span><span class="n">function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_cfs_slack_timer</span><span class="p">;</span>
<span class="c1">//åˆå§‹åŒ–slack_timerå®šæ—¶å™¨</span>

<span class="w">    </span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">slack_started</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_3ae5d03ffcffee865d959eb75ba13ab6.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/5-cfsåˆ†ç»„è°ƒåº¦/images/wp_editor_md_3ae5d03ffcffee865d959eb75ba13ab6.jpg"/></a></p>
<p>init_cfs_bandwidthå‡½æ•°å°†åˆå§‹åŒ–ä¸¤ä¸ªå®šæ—¶å™¨ï¼Œperiod_timeråœ¨è¿›ç¨‹å…¥é˜Ÿ/æ›´æ–°runtimeæ—¶é—´çš„æ—¶å€™è¿›è¡Œå¯åŠ¨ï¼Œå¯åŠ¨period_timeråå°±æ¯ä¸ªperiodæ—¶é—´åé‡æ–°å°†quotaæ›´æ–°ç»™ä»»åŠ¡ç»„çš„runtimeå¹¶å°†å·²ç»èŠ‚æµçš„cfs_rqé‡æ–°åŠ å…¥é˜Ÿåˆ—ã€‚slack_timeræ˜¯åœ¨è°ƒåº¦å®ä½“å‡ºé˜Ÿçš„æ—¶å€™è§¦å‘ï¼Œå½“è°ƒåº¦å®ä½“è¢«ç§»é™¤å°±ç»ªé˜Ÿåˆ—æ—¶ï¼Œå°±æ£€æµ‹cfs_rqä¸Šå‰©ä½™å¯è¿è¡Œæ—¶é—´ï¼Œå¦‚æœå‰©ä½™æ—¶é—´ä¸è¶³1mså°±ä¸ç”¨å½’è¿˜ç»™å…¨å±€æ—¶é—´æ± ï¼Œå¦åˆ™å½’è¿˜cfs_rq-&gt;runtime_remaining - min_cfs_rq_runtimeï¼ˆé»˜è®¤1msï¼‰çš„æ—¶é—´ç»™å…¨å±€æ—¶é—´æ± ï¼Œå½’è¿˜ç»™å…¨å±€æ—¶é—´æ± åéœ€è¦åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯åŠ¨å®šæ—¶å™¨å°†æ­¤å‰è¢«èŠ‚æµçš„cfs_rqè°ƒåº¦å®ä½“é‡æ–°åŠ å…¥åˆ°å°±ç»ªé˜Ÿåˆ—ä¸­ï¼Œåˆ¤æ–­çš„æ¡ä»¶æ˜¯å…¨å±€æ± ä¸­å‰©ä½™çš„æ—¶é—´è¦å¤§äºcfs_b-&gt;runtime &gt; sched_cfs_bandwidth_slice()ï¼ˆé»˜è®¤è¦å¤§äº5msï¼‰ï¼Œå› ä¸ºcfs_rqæ¯æ¬¡ç”³è¯·çš„æ—¶é—´ç‰‡æ˜¯sched_cfs_bandwidth_slice()ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">__return_cfs_rq_runtime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_rq</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_rq</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cfs_bandwidth</span><span class="w"> </span><span class="o">*</span><span class="n">cfs_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tg_cfs_bandwidth</span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">tg</span><span class="p">);</span>
<span class="w">    </span><span class="n">s64</span><span class="w"> </span><span class="n">slack_runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">runtime_remaining</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min_cfs_rq_runtime</span><span class="p">;</span>
<span class="c1">//è®¡ç®—å½’è¿˜ç»™ç³»ç»Ÿçš„æ—¶é—´ï¼Œé¢„ç•™ä¸€ç‚¹æ—¶é—´ç»™å°±ç»ªé˜Ÿåˆ—</span>
<span class="c1">//å¦‚æœæ²¡æœ‰å‰©ä½™æ—¶é—´ï¼Œç›´æ¥è¿”å›ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">slack_runtime</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="n">raw_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">quota</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RUNTIME_INF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">slack_runtime</span><span class="p">;</span>

<span class="w">        </span><span class="c1">//å…¨å±€æ± çš„æ—¶é—´è¦å¤§äºcfs_rqæ¯æ¬¡ç”³è¯·çš„æ—¶é—´ç‰‡å¹¶ä¸”æœ‰å°±ç»ªé˜Ÿåˆ—è¢«èŠ‚æµ</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sched_cfs_bandwidth_slice</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">throttled_cfs_rq</span><span class="p">))</span>
<span class="w">            </span><span class="n">start_cfs_slack_bandwidth</span><span class="p">(</span><span class="n">cfs_b</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//é‡æ–°æ›´æ–°å½“å‰å°±ç»ªé˜Ÿåˆ—çš„æ—¶é—´ç‰‡</span>
<span class="w">    </span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">runtime_remaining</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">slack_runtime</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_7">å°ç»“</h3>
<p>ï¼ˆ1ï¼‰cfs_b-&gt;runtime: ä»»åŠ¡ç»„çš„è¿›ç¨‹åœ¨ä¸€ä¸ªperiodå‘¨æœŸèƒ½å¯è¿è¡Œçš„æ—¶é—´ä¸ºruntimeï¼Œè¯¥å€¼åœ¨æ¯ä¸ªå‘¨æœŸåˆ°æ¥æ—¶ä¼šè¢«æ›´æ–°ä¸ºquotaå€¼ã€‚ ï¼ˆ2ï¼‰cfs_rq-&gt;runtime_remaining:ä»»åŠ¡ç»„æ‰€å±çš„å°±ç»ªé˜Ÿåˆ—cfs_rqï¼Œå°±ç»ªé˜Ÿåˆ—ä¸­çš„è¿›ç¨‹è¿è¡Œåå°†ä¼šæ¶ˆè€—runtime_remainingï¼Œè°ƒåº¦å‘¨æœŸä¼šè°ƒç”¨update_currå‡½æ•°æ›´æ–°å½“å‰è¿›ç¨‹æ‰§è¡Œæ—¶é—´äº†å¤šå°‘æ—¶é—´å³å¯¹åº”runtime_remainingå°±ä¼šè¢«å‡å°‘ï¼Œå½“runtime_remainingä¸è¶³æ—¶å°±ä¼šå‘å…¨å±€cfs_b-&gt;runtimeç”³è¯·ï¼Œå¦‚æœç”³è¯·ä¸åˆ°å½“å‰çš„cfs_rqå°±ç»ªé˜Ÿåˆ—ä¸Šæ‰€ä»¥è¿›ç¨‹å°±ä¼šè¢«èŠ‚æµæ— æ³•å†è¿è¡Œã€‚ ï¼ˆ3ï¼‰èŠ‚æµï¼šå°±ç»ªé˜Ÿåˆ—æ— æ³•ç”³è¯·åˆ°è¿è¡Œæ—¶é—´å°±ä¼šè¢«èŠ‚æµå¹¶è®¾ç½®å¯è¢«æŠ¢å ï¼ˆresched_currï¼‰ï¼Œåœ¨è¿›ç¨‹åˆ‡æ¢çš„æ—¶å€™ä¼šæ£€æŸ¥è¢«èŠ‚æµçš„è°ƒåº¦å®ä½“ï¼Œå¹¶å°†å½“å‰è°ƒåº¦å®ä½“ä»å°±ç»ªé˜Ÿåˆ—ä¸­ç§»é™¤ã€‚ ï¼ˆ4ï¼‰è§£é™¤èŠ‚æµï¼šä¸‹ä¸€ä¸ªå‘¨æœŸåˆ°æ¥æˆ–è€…å¦å¤–ä¸€ä¸ªå°±ç»ªé˜Ÿåˆ—è®©å‡ºäº†æ—¶é—´ï¼ˆslack_timerï¼‰ï¼ŒèŠ‚æµçš„é˜Ÿåˆ—å°†ä¼šè¢«é‡æ–°åŠ å…¥åˆ°å°±ç»ªé˜Ÿåˆ—å¾—ä»¥è¿è¡Œã€‚</p>
<p>å°†ä¸¤ä¸ªè¿›ç¨‹æ”¾åˆ°ä»»åŠ¡ç»„ï¼Œè°ƒæ•´quota_usè§‚å¯Ÿcpuå ç”¨ç‡æƒ…å†µã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cgroup</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span>
<span class="n">mount</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">cgroup</span><span class="w"> </span><span class="o">-</span><span class="n">ocpu</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span>
<span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span>
<span class="n">mkdir</span><span class="w"> </span><span class="n">A</span>
<span class="n">cd</span><span class="w"> </span><span class="n">A</span>
<span class="n">echo</span><span class="w"> </span><span class="mi">1293</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cgroup</span><span class="p">.</span><span class="n">procs</span>
<span class="n">echo</span><span class="w"> </span><span class="mi">1294</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cgroup</span><span class="p">.</span><span class="n">procs</span>
<span class="n">cat</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">cfs_period_us</span>
<span class="n">echo</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">cfs_quota_us</span>
</code></pre></div>
<p>å°†ä¸¤ä¸ªè¿›ç¨‹ç»‘å®šåˆ°ä¸€ä¸ªæ ¸ä¸Šè¿è¡Œï¼Œè°ƒæ•´niceè§‚å¯Ÿcpuå ç”¨ç‡ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="cp"># å°†1309å’Œ1221éƒ½ç»‘å®šåˆ°0æ ¸ä¸Š</span>
<span class="n">taskset</span><span class="w"> </span><span class="o">-</span><span class="n">cp</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1309</span>
<span class="n">taskset</span><span class="w"> </span><span class="o">-</span><span class="n">cp</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1221</span>
<span class="n">renice</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="mi">1221</span><span class="w"> </span><span class="err">#</span><span class="n">åŠ¨æ€è°ƒæ•´1221è¿›ç¨‹çš„ä¼˜å…ˆçº§</span>
</code></pre></div>
<p>å°†ä¸¤ä¸ªè¿›ç¨‹æ”¾åˆ°ä»»åŠ¡ç»„ï¼Œå¹¶è¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼Œè°ƒæ•´cpu.sharesï¼Œè§‚å¯Ÿæ•´ä½“ä»»åŠ¡ç»„åˆ†é…åˆ°çš„cpuå ç”¨ç‡ï¼ŒæŠŠç›¸åŒä¸šåŠ¡çš„è¿›ç¨‹æ”¾åˆ°ä¸€ä¸ªç»„ï¼Œç„¶åè°ƒæ•´ä¼˜å…ˆçº§ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cgroup</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span>
<span class="n">mount</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">cgroup</span><span class="w"> </span><span class="o">-</span><span class="n">ocpu</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span>
<span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span>
<span class="n">mkdir</span><span class="w"> </span><span class="n">A</span>
<span class="n">cd</span><span class="w"> </span><span class="n">A</span>
<span class="n">echo</span><span class="w"> </span><span class="mi">1293</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cgroup</span><span class="p">.</span><span class="n">procs</span>
<span class="n">echo</span><span class="w"> </span><span class="mi">1294</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cgroup</span><span class="p">.</span><span class="n">procs</span>
<span class="n">echo</span><span class="w"> </span><span class="mi">1277</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">shares</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="cfsè°ƒåº¦å®ç°.html">â† CFSè°ƒåº¦å®ç°</a>
    <a class="next" href="cfsè°ƒåº¦åŸç†.html">CFSè°ƒåº¦åŸç† â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

