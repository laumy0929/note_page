<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>è½¯ä¸­æ–­å’Œtasklet - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">æŠ¢å è®¡æ•°</a><ul></ul></li><li><a href="#_2">æ³¨å†Œè½¯ä¸­æ–­</a><ul></ul></li><li><a href="#softirq">è§¦å‘softirq</a><ul></ul></li><li><a href="#softirq_1">æ‰§è¡Œsoftirq</a><ul></ul></li><li><a href="#tasklet">Tasklet</a><ul><li><a href="#tasklet_1">taskletçš„åˆ›å»º</a></li><li><a href="#tasklet_2">è§¦å‘æ‰§è¡Œtasklet</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>è½¯ä¸­æ–­å’Œtasklet</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-03-05
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><p>Linuxçš„ä¸­æ–­åˆ†ä¸ºä¸Šä¸‹éƒ¨æœºåˆ¶ï¼Œä¸ŠåŠéƒ¨åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­å…³é—­äº†æœ¬åœ°CPUä¸­æ–­å“åº”ï¼Œä¸‹åŠéƒ¨æ˜¯åœ¨ä¸­æ–­çº¿ç¨‹ä¸­å¤„ç†ã€‚åœ¨Linuxç³»ç»Ÿæ²¡æœ‰å¼•å…¥ä¸­æ–­çº¿ç¨‹åŒ–æœºåˆ¶ä¹‹å‰ï¼Œå°±å·²ç»å‡ºç°äº†ä¸€äº›ä¸‹åŠéƒ¨çš„æœºåˆ¶ï¼Œå¦‚è½¯ä¸­æ–­SoftIRQï¼ŒTaskletå’Œworkqueueã€‚ SoftIRQæ˜¯é¢„ç•™ç»™ç³»ç»Ÿå¯¹æ—¶é—´è¦æ±‚æ¯”è¾ƒä¸¥æ ¼è¿›è¡Œä½¿ç”¨çš„ï¼ŒLinuxç³»ç»Ÿå·²ç»å®šä¹‰äº†è½¯ä¸­æ–­çš„ç±»å‹ï¼Œé€šå¸¸æƒ…å†µä¸‹ç”¨æˆ·éƒ¨éœ€è¦ä¿®æ”¹è½¯ä¸­æ–­çš„ç±»å‹ï¼Œå¯¹äºç”¨æˆ·æ¥è¯´å¯ä»¥ä½¿ç”¨taskletæœºåˆ¶ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">enum</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">HI_SOFTIRQ</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w">    </span><span class="n">æœ€é«˜ä¼˜å…ˆçº§çš„è½¯ä¸­æ–­</span>
<span class="w">    </span><span class="n">TIMER_SOFTIRQ</span><span class="p">,</span><span class="w">   </span><span class="n">Timerå®šæ—¶å™¨è½¯ä¸­æ–­</span>
<span class="w">    </span><span class="n">NET_TX_SOFTIRQ</span><span class="p">,</span><span class="w">  </span><span class="n">ç½‘ç»œå‘åŒ…è½¯ä¸­æ–­</span>
<span class="w">    </span><span class="n">NET_RX_SOFTIRQ</span><span class="p">,</span><span class="w">  </span><span class="n">ç½‘ç»œæ”¶åŒ…è½¯ä¸­æ–­</span>
<span class="w">    </span><span class="n">BLOCK_SOFTIRQ</span><span class="p">,</span><span class="w">   </span><span class="n">å—è®¾å¤‡è½¯ä¸­æ–­</span>
<span class="w">    </span><span class="n">IRQ_POLL_SOFTIRQ</span><span class="p">,</span><span class="w"> </span><span class="n">IOè½®è¯¢çš„å—è®¾å¤‡è½¯ä¸­æ–­</span><span class="w"> </span>
<span class="w">    </span><span class="n">TASKLET_SOFTIRQ</span><span class="p">,</span><span class="w">  </span><span class="n">taskletè½¯ä¸­æ–­</span>
<span class="w">    </span><span class="n">SCHED_SOFTIRQ</span><span class="p">,</span><span class="w">   </span><span class="n">è¿›ç¨‹è°ƒåº¦ä»¥åŠè´Ÿè½½å‡è¡¡è½¯ä¸­æ–­</span>
<span class="w">    </span><span class="n">HRTIMER_SOFTIRQ</span><span class="p">,</span><span class="w"> </span><span class="n">é«˜ç²¾åº¦å®šæ—¶å™¨è½¯ä¸­æ–­</span>
<span class="w">    </span><span class="n">RCU_SOFTIRQ</span><span class="p">,</span><span class="w">     </span><span class="n">RCUæœåŠ¡è½¯ä¸­æ–­</span>

<span class="w">    </span><span class="n">NR_SOFTIRQS</span>
<span class="p">};</span>
</code></pre></div>
<h2 id="_1">æŠ¢å è®¡æ•°</h2>
<p>åœ¨è®¨è®ºsoftirqå‰ï¼Œæˆ‘ä»¬å…ˆæ¥è®¨è®ºä¸‹æŠ¢å è®¡æ•°ï¼Œè¿™ä¸softirqæœ‰å¯†åˆ‡çš„å…³ç³»ã€‚Linuxé…ç½®æ‰“å¼€äº†CONFIG_PREEMPTè¡¨ç¤ºå…è®¸é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æŠ¢å ä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œä½†æ˜¯åœ¨spin lockï¼Œä¸­æ–­/è½¯ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­ä¾æ—§ä¸å…è®¸æŠ¢å çš„ã€‚åœ¨linuxç³»ç»Ÿä¸­ä½¿ç”¨äº†ä¸€ä¸ªPer-CPUçš„32ä½å˜é‡æ¥æ ‡è¯†ä¸€äº›ç‰¹æ®Šåœºæ™¯ï¼Œå¦‚ä¸‹ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_3b15bb3b2af9aa854ff5a2d097d230e5.jpg"><img alt="" src="assets/doc/01-linux/ä¸­æ–­ç®¡ç†/è½¯ä¸­æ–­å’Œtaskletç®€ä»‹/images/wp_editor_md_3b15bb3b2af9aa854ff5a2d097d230e5.jpg"/></a></p>
<ul>
<li>PREEMPT_BITS:ç”¨äºè®°å½•ç¦æ­¢æŠ¢å è®¡æ•°ï¼Œå½“è°ƒç”¨preempt_enable/preempt_disableä¼šè¿›è¡Œå‡åŠ æ“ä½œï¼Œç›´åˆ°countä½0æ‰èƒ½å…è®¸å¼€å¯æŠ¢å ã€‚ä¸Šè¿°è¿˜åŒ…æ‹¬spin lockï¼Œread lockç­‰éƒ½ä¼šç¦æ­¢æŠ¢å ã€‚</li>
<li>SOFTIRQ_BITS:è½¯ä¸­æ–­è®¡æ•°åŒºåŸŸï¼Œè¿›å…¥è½¯ä¸­æ–­ä¼šè°ƒç”¨local_bh_disbleè®¡æ•°+1ï¼Œé€€å‡ºè½¯ä¸­æ–­è°ƒç”¨local_bh_enableè®¡æ•°-1ï¼Œå½“SOFTIRQ_BITSä¸ºæ­£æ•°å°±è¡¨æ˜å¤„äºsoftirqä¸Šä¸‹æ–‡ä¸­ï¼Œin_softirqä¸ºçœŸã€‚å…¶ä¸­ç¬¬8ä½è¡¨ç¤ºæ­£åœ¨å¤„ç†è½¯ä¸­æ–­ã€‚</li>
<li>HARDIRQ_BITS:ç¡¬ä»¶ä¸­æ–­è®¡æ•°åŒºï¼Œè¿›å…¥+1ï¼Œé€€å‡ºæ—¶-1ï¼Œå½“HARDIRQ_BITSä¸ºæ­£æ•°æ—¶è¡¨æ˜å¤„äºhardirqä¸Šä¸‹æ–‡ä¸­ï¼Œin_hardirqä¸ºçœŸã€‚</li>
<li>MNI_BITS:ç½®ä½è¡¨ç¤ºè¿›å…¥MNIä¸­æ–­ä¸Šä¸‹æ–‡ã€‚</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="cp">#define nmi_count() (preempt_count() &amp; NMI_MASK)</span>
<span class="cp">#define hardirq_count() (preempt_count() &amp; HARDIRQ_MASK)</span>
<span class="cp">#ifdef CONFIG_PREEMPT_RT</span>
<span class="cp"># define softirq_count()    (current-&gt;softirq_disable_cnt &amp; SOFTIRQ_MASK)</span>
<span class="cp">#else</span>
<span class="cp"># define softirq_count()    (preempt_count() &amp; SOFTIRQ_MASK)</span>
<span class="cp">#endif</span>
<span class="cp">#define irq_count() (nmi_count() | hardirq_count() | softirq_count())</span>

<span class="cm">/*</span>
<span class="cm"> * Macros to retrieve the current execution context:</span>
<span class="cm"> *</span>
<span class="cm"> * in_nmi()     - We're in NMI context</span>
<span class="cm"> * in_hardirq()     - We're in hard IRQ context</span>
<span class="cm"> * in_serving_softirq() - We're in softirq context</span>
<span class="cm"> * in_task()        - We're in task context</span>
<span class="cm"> */</span>
<span class="cp">#define in_nmi()        (nmi_count())</span>
<span class="cp">#define in_hardirq()        (hardirq_count())</span>
<span class="cp">#define in_serving_softirq()    (softirq_count() &amp; SOFTIRQ_OFFSET)</span>
<span class="cp">#define in_task()       (!(in_nmi() | in_hardirq() | in_serving_softirq()))</span>

<span class="cm">/*</span>
<span class="cm"> * The following macros are deprecated and should not be used in new code:</span>
<span class="cm"> * in_irq()       - Obsolete version of in_hardirq()</span>
<span class="cm"> * in_softirq()   - We have BH disabled, or are processing softirqs</span>
<span class="cm"> * in_interrupt() - We're in NMI,IRQ,SoftIRQ context or have BH disabled</span>
<span class="cm"> */</span>
<span class="cp">#define in_irq()        (hardirq_count())</span>
<span class="cp">#define in_softirq()        (softirq_count())</span>
<span class="cp">#define in_interrupt()      (irq_count())</span>
</code></pre></div>
<ul>
<li>in_irq: è¯´æ˜HARDIRQ_BITSä½æœ‰ç½®èµ·ï¼Œè¯´æ˜å½“å‰æœ‰æ­£åœ¨å¤„ç†çš„ä¸­æ–­handler(top half)ï¼Œåªè¦hardirq_countå¤§äº0ï¼Œå°±è¯´æ˜æ˜¯IRQ Contextã€‚</li>
<li>in_softirqï¼šè¯´æ˜SOFTIRQ_BITSä½æœ‰ç½®èµ·ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½å®Œå…¨è¯´æ˜¯å½“å‰æ­£åœ¨æ‰§è¡Œsoftirqï¼Œå…¶ç¨å¾®æœ‰ç‚¹ç‰¹æ®Šã€‚å½“softirqæ­£åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œsoftirq countä¼šå¢åŠ ï¼Œé‚£æ˜¯å¤„äºsoftirq contextæ²¡æœ‰é”™ï¼Œä½†æ˜¯å†å…¶ä»–åœºæ™¯ä¸‹ä¹Ÿä¼šå°†softirq countå¢åŠ ï¼Œæ¯”å¦‚åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­å‡ºäºå¯¹ä¸´ç•ŒåŒºçš„åŒ…å«ï¼Œä¼šè°ƒç”¨local_bh_disable/enableä¿æŠ¤ä¸´ç•ŒåŒºï¼Œé‚£ä¹ˆè¿™ä¹Ÿä¼šç½®èµ·SOFTIRQ_BITSï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨æ‰§è¡Œsoftirq,å› æ­¤å¯¹äºsoftirqè¿˜æ˜¯ä½¿ç”¨in_serving_softirqæ¥åˆ¤æ–­æ˜¯å¦softirqæ­£åœ¨å¤„ç†ã€‚</li>
</ul>
<p>å½“MNI_BITS|HARDIRQ_BITS|SOFTIRQ_BITSç½®ä½è¡¨ç¤ºå¤„äºä¸­æ–­ä¸Šä¸‹æ–‡ä¸­ï¼Œin_interruptä¸ºçœŸï¼Œå½“ä½¿èƒ½CONFIG_PREEMPTåï¼Œä¸­æ–­è¿”å›ä¼šæ£€æµ‹è¿™ä¸ªpreempt_countå˜é‡ï¼Œå½“è¯¥å€¼å¦‚æœä¸º0æ—¶æ‰èƒ½å…è®¸è¢«æŠ¢å ã€‚</p>
<h2 id="_2">æ³¨å†Œè½¯ä¸­æ–­</h2>
<p>ç³»ç»Ÿä¸­ä¸ºæ¯ä¸ªCPUéƒ½åˆ›å»ºäº†ä¸€ä¸ªä¸­æ–­çº¿ç¨‹ç”¨äºå¤„ç†è½¯ä¸­æ–­ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">ksoftirqd</span><span class="p">);</span>
<span class="n">EXPORT_PER_CPU_SYMBOL_GPL</span><span class="p">(</span><span class="n">ksoftirqd</span><span class="p">);</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">smp_hotplug_thread</span><span class="w"> </span><span class="n">softirq_threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">store</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ksoftirqd</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">thread_should_run</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">ksoftirqd_should_run</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">thread_fn</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">run_ksoftirqd</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">thread_comm</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s">"ksoftirqd/%u"</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">spawn_ksoftirqd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">cpuhp_setup_state_nocalls</span><span class="p">(</span><span class="n">CPUHP_SOFTIRQ_DEAD</span><span class="p">,</span><span class="w"> </span><span class="s">"softirq:dead"</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                  </span><span class="n">takeover_tasklets</span><span class="p">);</span>

<span class="w">    </span><span class="n">BUG_ON</span><span class="p">(</span><span class="n">smpboot_register_percpu_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">softirq_threads</span><span class="p">));</span>
<span class="w">    </span><span class="c1">//ä¸ºæ¯ä¸ªCPUåˆ›å»ºä¸€ä¸ªsoftirqå¤„ç†çº¿ç¨‹</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_initcall</span><span class="p">(</span><span class="n">spawn_ksoftirqd</span><span class="p">);</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">softirq_action</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">action</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">softirq_action</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">softirq_action</span><span class="w"> </span><span class="n">softirq_vec</span><span class="p">[</span><span class="n">NR_SOFTIRQS</span><span class="p">]</span>
</code></pre></div>
<p>ç³»ç»Ÿä¸­å®šä¹‰äº†ä¸€ä¸ªå…¨å±€struct softirq_actionå˜é‡ç”¨äºå­˜å‚¨å„ç±»å‹ä¸­æ–­çš„å›è°ƒå‡½æ•°ï¼Œç³»ç»Ÿé€šè¿‡open_softirqå‡½æ•°æ¥æ³¨å†Œå›è°ƒå‡½æ•°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">open_softirq</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">nr</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">action</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">softirq_action</span><span class="w"> </span><span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">softirq_vec</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">action</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>åœ¨linuxç³»ç»Ÿä¸­ä¸ºæ¯ä¸ªCPUéƒ½ç»´æŠ¤äº†ä¸€ä¸ªsoftirqçš„çŠ¶æ€ä¿¡æ¯ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__softirq_pending</span><span class="p">;</span>
<span class="cp">#ifdef ARCH_WANTS_NMI_IRQSTAT</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__nmi_count</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span><span class="w"> </span><span class="n">____cacheline_aligned</span><span class="w"> </span><span class="n">irq_cpustat_t</span><span class="p">;</span>

<span class="n">DECLARE_PER_CPU_ALIGNED</span><span class="p">(</span><span class="n">irq_cpustat_t</span><span class="p">,</span><span class="w"> </span><span class="n">irq_stat</span><span class="p">);</span>
</code></pre></div>
<h2 id="softirq">è§¦å‘softirq</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_afc1199009c36d7bd6ce4e8354c3af53.jpg"><img alt="" src="assets/doc/01-linux/ä¸­æ–­ç®¡ç†/è½¯ä¸­æ–­å’Œtaskletç®€ä»‹/images/wp_editor_md_afc1199009c36d7bd6ce4e8354c3af53.jpg"/></a></p>
<p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºè§¦å‘softirqä¸»è¦æœ‰ä¸¤ä¸ªå‡½æ•°raise_softirqå’Œraise_softirq_irqoffã€‚raise_softirqä¼šå…³é—­æœ¬åœ°ä¸­æ–­å“åº”ï¼Œè€Œraise_softirq_irqoffä¸ä¼šã€‚ raise_softirqæ˜¯ç”¨äºè¿›ç¨‹ä¸Šä¸‹æ–‡è§¦å‘è½¯ä¸­æ–­çš„ï¼Œè€Œåœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡å…³é—­æœ¬åœ°cpuçš„ä¸­æ–­å“åº”æ˜¯ä¸ºäº†ä¿æŠ¤ä¸´ç•Œè®¿é—®ï¼Œè½¯ä¸­æ–­çš„è§¦å‘å®é™…æ˜¯è®¾ç½®è½¯ä¸­æ–­çš„pendingä½ï¼Œè€Œåªéœ€è¦å…³é—­æœ¬åœ°ä¸­æ–­å“åº”æ˜¯å› ä¸ºæ¯ä¸ªcpuéƒ½ç»´æŠ¤äº†ä¸€ä¸ªè½¯ä¸­æ–­çš„pendingä½ã€‚ raise_softirq_irqoffæ˜¯ç”¨äºä¸­æ–­ä¸Šä¸‹æ–‡è§¦å‘ä¸­æ–­çš„ï¼Œå®é™…ä¸Šå¤§éƒ¨åˆ†çš„è½¯ä¸­æ–­éƒ½æ˜¯åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡è§¦å‘çš„ï¼Œå› ä¸ºæœ¬èº«å°±å¤„äºä¸­æ–­ä¸Šä¸‹æ–‡äº†ï¼Œæœ¬åœ°ä¸­æ–­å“åº”å·²ç»å…³é—­äº†ï¼Œå› æ­¤ä¸éœ€è¦å†æ”¯æŒlocal_irq_saveã€‚ è½¯ä¸­æ–­å¤„ç†è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨__raise_softirq_irqoffè®¾ç½®è½¯ä¸­æ–­çš„pengdingä½ï¼Œè¿™æ ·å†æ‰§è¡Œè½¯ä¸­æ–­æ˜¯ä¼šè¿›è¡Œæ£€æµ‹è¯¥ä½ï¼Œå¦‚æœä½¿èƒ½æ‰ä¼šæ‰§è¡Œè½¯ä¸­æ–­ã€‚ åœ¨raise_softirq_irqoffä¸­è¿˜ä¼šè¿›è¡Œåˆ¤æ–­æ˜¯å¦å¤„äºä¸­æ–­ä¸Šä¸‹æ–‡ä¸­ä¸”æ˜¯å¦æœ‰è½¯ä¸­æ–­ç½®ä½ï¼Œå¯¹äºå¤„äºè¿›ç¨‹ä¸Šä¸‹æ–‡è§¦å‘çš„è½¯ä¸­æ–­ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥æ¿€æ´»è½¯ä¸­æ–­çº¿ç¨‹è¿›ç¨‹å¤„ç†è½¯ä¸­æ–­ã€‚è€Œå¤„äºä¸­æ–­ä¸Šä¸‹æ–‡ä¸­ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸ç”¨åšï¼Œå› ä¸ºåœ¨ä¸­æ–­é€€å‡ºæ—¶æ‰ä¼šæ£€æµ‹è½¯ä¸­æ–­è¿›è¡Œæ‰§è¡Œè½¯ä¸­æ–­ï¼Œå› æ­¤å¯¹äºå¤„äºä¸­æ–­ä¸Šä¸‹æ–‡è§¦å‘çš„è½¯ä¸­æ–­ï¼Œä»…ä»…æ˜¯è®¾ç½®è½¯ä¸­æ–­çš„pendingä½ã€‚</p>
<h2 id="softirq_1">æ‰§è¡Œsoftirq</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_328c756d7cddf15aa8a2363859b93da6.jpg"><img alt="" src="assets/doc/01-linux/ä¸­æ–­ç®¡ç†/è½¯ä¸­æ–­å’Œtaskletç®€ä»‹/images/wp_editor_md_328c756d7cddf15aa8a2363859b93da6.jpg"/></a></p>
<p>è½¯ä¸­æ–­æ‰§è¡Œæ—¶æœºå¯ä»¥åˆ†ä¸º3ç§æƒ…å†µï¼Œåˆ†åˆ«æ˜¯åœ¨ä¸­æ–­é€€å‡ºæ—¶æ£€æµ‹æ˜¯å¦æœ‰è½¯ä¸­æ–­æ‰§è¡Œã€è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­ä¸»åŠ¨æ‰§è¡Œã€åœ¨spin_unlock_bhï¼ˆå®é™…è°ƒç”¨__local_bh_enable_ipï¼‰ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_ba9a74ba8d4913ce34c4b7d4e1bb13ec.jpg"><img alt="" src="assets/doc/01-linux/ä¸­æ–­ç®¡ç†/è½¯ä¸­æ–­å’Œtaskletç®€ä»‹/images/wp_editor_md_ba9a74ba8d4913ce34c4b7d4e1bb13ec.jpg"/></a></p>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹æ‰§è¡Œä¸­æ–­é€€å‡ºæ‰§è¡Œè½¯ä¸­æ–­çš„åœºæ™¯ï¼Œå¦‚ä¸Šå›¾è¿›ç¨‹è¢«ä¸­æ–­æ‰“æ–­åè¿›å…¥åˆ°ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿›å…¥ä¸­æ–­åcpuç¡¬ä»¶ä¼šè‡ªåŠ¨å…³é—­cpuæœ¬åœ°ä¸­æ–­å“åº”ï¼Œå¤„ç†ä¸­æ–­å®Œæˆååœ¨æ‰§è¡Œirq_exitä¸­æ–­é€€å‡ºæ—¶ï¼Œå½“æ£€æµ‹åˆ°æœ‰è½¯ä¸­æ–­pendingæ—¶æ‰§è¡Œè½¯ä¸­æ–­ï¼›å¦‚æœè½¯ä¸­æ–­æ˜¯åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡æ‰§è¡Œæ—¶ï¼Œåœ¨è½¯ä¸­æ–­å¤„ç†ä¸­ä¼šè°ƒç”¨local_irq_enableæ‰“å¼€CPUæœ¬åœ°ä¸­æ–­å“åº”å†å¤„ç†è½¯ä¸­æ–­ç¨‹åºï¼Œå¦‚æœæ˜¯è§¦å‘çš„è½¯ä¸­æ–­çº¿ç¨‹ï¼Œç¡¬ä¸­æ–­å·²ç»å®Œæˆé€€å‡ºä¹Ÿä¼šä½¿èƒ½æœ¬åœ°ä¸­æ–­ã€‚å› æ­¤åœ¨è½¯ä¸­æ–­æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰“å¼€äº†ä¸­æ–­å“åº”ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå†æ¬¡è¿›å…¥ç¡¬ä¸­æ–­ä¸Šä¸‹æ–‡ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_77197aa931d67a104cb86e1f1c473779.jpg"><img alt="" src="assets/doc/01-linux/ä¸­æ–­ç®¡ç†/è½¯ä¸­æ–­å’Œtaskletç®€ä»‹/images/wp_editor_md_77197aa931d67a104cb86e1f1c473779.jpg"/></a></p>
<p>å†æ¥çœ‹ä¸Šé¢è¿™å¼ å›¾ï¼Œåœ¨ä¸€ä¸ªtaskä¸­å¤„ç†ä¸€ä¸ªå˜é‡æ­¤æ—¶è¢«ç¡¬ä»¶ä¸­æ–­æ‰“æ–­è¿›è¡Œä¸­æ–­å¤„ç†å‡½æ•°ï¼Œåœ¨ä¸­æ–­å¤„ç†å¿«ç»“æŸæ—¶å¦‚æœæœ‰è½¯ä¸­æ–­pendingå°†ä¼šå…ˆå¤„ç†è½¯ä¸­æ–­ï¼Œå¦‚æœè½¯ä¸­æ–­ä¸­ä¹Ÿè®¿é—®äº†è¯¥å˜é‡ï¼Œé‚£ä¹ˆå°±å‡ºç°ç«æ€å¼‚å¸¸ï¼Œå› æ­¤ä¸ºäº†å¤„ç†è¿›ç¨‹å’Œè½¯ä¸­æ–­çš„ç«æ€ï¼Œè°ƒç”¨spin_lock_bhå’Œspin_unlock_bhè¿›è¡Œä¿æŠ¤ï¼Œåœ¨ç¡¬ä»¶ä¸­æ–­å¤„ç†å®Œè¦è¿›å…¥è½¯ä¸­æ–­å°†ä¼šè¢«ç¦æ­¢ï¼Œç¡¬ä»¶ä¸­æ–­ä¼šè¢«ç›´æ¥é€€å‡ºï¼Œç»§è€Œtaskå¯ä»¥ç»§ç»­è¿è¡Œï¼Œå½“taskå†æ‰§è¡Œspin_unlock_bhæ—¶ä¼šè§¦å‘æ‰§è¡Œè½¯ä¸­æ–­ã€‚å¦å¤–å¦‚æœè½¯ä¸­æ–­å¤„ç†å‡½æ•°ä¸­çš„ç«æ€å¯èƒ½åœ¨å¤šæ ¸ç›´æ¥å‘ç”Ÿï¼Œä¸ºäº†ä¿æŠ¤å¤šæ ¸çš„ä¸´ç•Œå¤„ç†åœ¨è½¯ä¸­æ–­ä¸­åªéœ€è¦è°ƒç”¨spin_lockå’Œspin_unlockå³å¯ï¼Œä¸éœ€è¦è°ƒç”¨spin_lock_bhå’Œspin_unlock_bhï¼Œå› ä¸ºæ¯ä¸ªcpuä¸Šåªæœ‰ä¸€ä¸ªè½¯ä¸­æ–­å¯ä»¥è¿è¡Œä¸éœ€è¦åšè½¯ä¸­æ–­ä¹‹é—´çš„ä¸´ç•Œä¿æŠ¤ã€‚æ€»ç»“å°±æ˜¯åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­è¦é¿å…è½¯ä¸­æ–­å’Œå¤šæ ¸çš„ç«æ€ä¿æŠ¤å°±è°ƒç”¨spin_lock_bhå’Œspin_unlock_bhï¼Œè½¯ä¸­æ–­ä¸­é¿å…å¤šæ ¸çš„ç«æ€ä¿æŠ¤å°±è°ƒç”¨spin_lockå’Œspin_unlockå³å¯ã€‚</p>
<h2 id="tasklet">Tasklet</h2>
<p>Taskletæ˜¯è½¯ä¸­æ–­ç±»å‹çš„ä¸€ç§ï¼Œä¾¿äºç”¨æˆ·å®ç°è½¯ä¸­æ–­ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">tasklet_struct</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tasklet_struct</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="n">å¤šä¸ªtaskletä¸²æˆä¸€ä¸ªé“¾è¡¨</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w">       </span><span class="n">æ ‡è®°taskletçš„çŠ¶æ€</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w">           </span><span class="n">æ­£æ•°è¡¨ç¤ºæœ¬åœ°å·²ç»æœ‰è¿è¡Œçš„tasklet</span><span class="err">ï¼Œ</span><span class="n">åªæœ‰ä¸º0æ‰èƒ½è¿è¡Œ</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">use_callback</span><span class="p">;</span><span class="w">         </span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">tasklet_struct</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span><span class="w">                      </span><span class="n">taskletçš„å¤„ç†å›è°ƒå‡½æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w">       </span><span class="n">ä¼ å‚</span>
<span class="p">};</span>
</code></pre></div>
<p>Taskletæ˜¯softirqçš„ä¸€ç§ï¼Œç³»ç»Ÿä¸­åˆ†é…äº†ä¸¤ä¸ªæ ‡å¿—å¯ç”¨äºtaskletè½¯ä¸­æ–­ï¼Œåˆ†åˆ«æ˜¯é«˜ä¼˜å…ˆçº§çš„HI_SOFTIRQå’Œæ™®é€šä¼˜å…ˆçº§çš„TASKLET_SOFTIRQï¼Œç³»ç»Ÿä¸­æ¯ä¸ªCPUå¯¹åº”ç»´æŠ¤ä¸¤ä¸ªtaskleté“¾è¡¨ï¼Œä¸€ä¸ªHI_SOFTIRQç±»å‹çš„é“¾è¡¨å’Œä¸€ä¸ªTASKLET_SOFTIRQç±»å‹çš„é“¾è¡¨ï¼Œç”¨äºç®¡ç†ç»´æŠ¤ç”¨æˆ·æ³¨å†Œçš„taskletã€‚åœ¨è¿›è¡Œå¤„ç†è½¯ä¸­æ–­æ˜¯ï¼Œä¼šä¼˜å…ˆçº§å¤„ç†HI_SOFTIRQç±»å‹çš„taskletã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * Tasklets</span>
<span class="cm"> */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">tasklet_head</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tasklet_struct</span><span class="w"> </span><span class="o">*</span><span class="n">head</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tasklet_struct</span><span class="w"> </span><span class="o">**</span><span class="n">tail</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">tasklet_head</span><span class="p">,</span><span class="w"> </span><span class="n">tasklet_vec</span><span class="p">);</span>
<span class="k">static</span><span class="w"> </span><span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">tasklet_head</span><span class="p">,</span><span class="w"> </span><span class="n">tasklet_hi_vec</span><span class="p">);</span>
</code></pre></div>
<p>Softirqåœ¨åˆå§‹åŒ–æ—¶ä¼šä¸ºtaskletæ³¨å†Œå…¨å±€çš„è½¯ä¸­æ–­å›è°ƒå‡½æ•°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">softirq_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="p">;</span>

<span class="w">    </span><span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">per_cpu</span><span class="p">(</span><span class="n">tasklet_vec</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">).</span><span class="n">tail</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">tasklet_vec</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">).</span><span class="n">head</span><span class="p">;</span>
<span class="w">        </span><span class="n">per_cpu</span><span class="p">(</span><span class="n">tasklet_hi_vec</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">).</span><span class="n">tail</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">tasklet_hi_vec</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">).</span><span class="n">head</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">open_softirq</span><span class="p">(</span><span class="n">TASKLET_SOFTIRQ</span><span class="p">,</span><span class="w"> </span><span class="n">tasklet_action</span><span class="p">);</span>
<span class="w">    </span><span class="n">open_softirq</span><span class="p">(</span><span class="n">HI_SOFTIRQ</span><span class="p">,</span><span class="w"> </span><span class="n">tasklet_hi_action</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="tasklet_1">taskletçš„åˆ›å»º</h3>
<p>ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸‹é¢ä¸¤ä¸ªå®æ¥å®šä¹‰ä¸€ä¸ªtaskletï¼ŒåŒºåˆ«ä¸€ä¸ªå·²ç»å¤„äºenableå¦å¤–ä¸€ä¸ªå¤„äºdisableã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#define DECLARE_TASKLET(name, _callback)        \\</span>
<span class="cp">struct tasklet_struct name = {              \\</span>
<span class="cp">    .count = ATOMIC_INIT(0),            \\</span>
<span class="cp">    .callback = _callback,              \\</span>
<span class="cp">    .use_callback = true,               \\</span>
<span class="cp">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="cp">#define DECLARE_TASKLET_DISABLED(name, _callback)   \\</span>
<span class="cp">struct tasklet_struct name = {              \\</span>
<span class="cp">    .count = ATOMIC_INIT(1),            \\</span>
<span class="cp">    .callback = _callback,              \\</span>
<span class="cp">    .use_callback = true,               \\</span>
<span class="cp">}</span>

<span class="n">å¦‚</span><span class="err">ï¼š</span><span class="k">static</span><span class="w"> </span><span class="n">DECLARE_TASKLET</span><span class="p">(</span><span class="n">fst_tx_task</span><span class="p">,</span><span class="w"> </span><span class="n">fst_process_tx_work_q</span><span class="p">);</span>
</code></pre></div>
<p>é™¤äº†ä½¿ç”¨å®æ¥å®šä¹‰å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨tasklet_initæ¥åŠ¨æ€åˆå§‹åŒ–åˆ†é…ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">tasklet_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">tasklet_struct</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="p">,</span>
<span class="w">          </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">),</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">t</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">t</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">t</span><span class="o">-&gt;</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func</span><span class="p">;</span>
<span class="w">    </span><span class="n">t</span><span class="o">-&gt;</span><span class="n">use_callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">t</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tasklet_init</span><span class="p">);</span>
</code></pre></div>
<h3 id="tasklet_2">è§¦å‘æ‰§è¡Œtasklet</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_16bebf463ff7bbbfcb53e56d9a87392f.jpg"><img alt="" src="assets/doc/01-linux/ä¸­æ–­ç®¡ç†/è½¯ä¸­æ–­å’Œtaskletç®€ä»‹/images/wp_editor_md_16bebf463ff7bbbfcb53e56d9a87392f.jpg"/></a></p>
<p>è§¦å‘taskletå¾—åˆ°æ‰§è¡Œï¼Œä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸Šé¢ä»¥æ™®é€šçš„taskletä¸ºä¾‹ã€‚ç”¨æˆ·å¯è°ƒç”¨tasklet_scheduleï¼Œè¯¥å‡½æ•°å°†taskletæ’å…¥åˆ°é“¾è¡¨ä¸­ç„¶åè°ƒç”¨raise_softirq_irqoffè§¦å‘è½¯ä¸­æ–­ï¼Œæœ€ç»ˆè§¦å‘äº†softirqï¼Œå…³äºsoftirqçš„è¿è¡Œåœ¨ä¸Šä¸€ç« èŠ‚ä¸­å·²ç»æè¿°ï¼Œæœ€åsoftirqè¿è¡Œtasklet_actionï¼Œåœ¨è¯¥å‡½æ•°ä¸­è¿›è¡Œwhileéå†é“¾è¡¨æ‰§è¡Œå¯¹åº”çš„taskletå›è°ƒå‡½æ•°ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="workqueue.html">â† workqueue</a>
    <a class="next" href="wordpressä½¿ç”¨ç¬”è®°.html">wordpressä½¿ç”¨ç¬”è®° â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

