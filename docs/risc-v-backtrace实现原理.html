<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RISC-V backtraceå®ç°åŸç† - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>RISC-V backtraceå®ç°åŸç†</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-05-21
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      risc-v
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_28488988b05ce9451cdfe90bd5aecc29.jpg"><img alt="" src="assets/doc/02-risc-v/risc-v-backtraceå®ç°åŸç†/images/wp_editor_md_28488988b05ce9451cdfe90bd5aecc29.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="n">start_kernel</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">-16</span><span class="w">                      </span><span class="o">---</span><span class="n">â‘ </span><span class="w"> </span><span class="n">åˆ†é…æ ˆå¸§sp</span><span class="o">=</span><span class="n">sp</span><span class="mi">-16</span><span class="p">,</span><span class="n">spæŒ‡å‘æ ˆé¡¶</span>
<span class="w">    </span><span class="n">sw</span><span class="w"> </span><span class="n">ra</span><span class="p">,</span><span class="mi">12</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="w">                        </span><span class="o">---</span><span class="n">â‘¡</span><span class="w"> </span><span class="n">å°†raå­˜å‚¨åˆ°sp</span><span class="o">+</span><span class="mi">12</span><span class="n">çš„ä½ç½®</span>
<span class="w">    </span><span class="n">sw</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

<span class="w">    </span><span class="n">xxxxxx</span>
<span class="w">    </span><span class="n">jal</span><span class="w"> </span><span class="n">ra</span><span class="p">,</span><span class="w"> </span><span class="mi">6000</span><span class="n">dba2</span><span class="w"> </span><span class="o">&lt;</span><span class="n">backtrace</span><span class="o">&gt;</span>
<span class="w">    </span><span class="n">xxxxxx</span>

<span class="w">    </span><span class="n">lw</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">lw</span><span class="w"> </span><span class="n">ra</span><span class="p">,</span><span class="mi">12</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="mi">16</span>

<span class="n">_backtrace</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BT_LEVEL_LIMIT</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">backtrace_from_stack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SP</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">PC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">LR</span><span class="p">,</span><span class="w"> </span><span class="n">print_func</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BT_SCAN_MAX_LIMIT</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">                </span><span class="n">riscv_ins16_get_push_lr_framesize</span><span class="p">(</span><span class="n">ins16</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
<span class="w">            </span><span class="c1">//è·å–åˆ°åˆ†é…æ ˆå¸§çš„ä½ç½®ï¼Œåœ°å€ä¸ºparse_addrï¼Œè¯¥ä½ç½®ä¹Ÿæ˜¯å‡½æ•°çš„èµ·å§‹ä½ç½®ï¼Œå¦‚ä¸Šçš„â‘ </span>
<span class="w">            </span><span class="c1">//åŒæ—¶ä¹Ÿè·å–åˆ°raçš„åœ¨æ ˆä¸­çš„åç§»ä½ç½®offsetï¼Œé€šè¿‡ç±»ä¼¼sw ra,12(sp)è®¡ç®—å¾—å‡ºã€‚</span>

<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">parse_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PC</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">                </span><span class="n">riscv_ins16_backtrace_stask_push</span><span class="p">(</span><span class="n">ins16</span><span class="p">);</span>
<span class="w">            </span><span class="c1">//è®¡ç®—å‡½æ•°çš„èµ·å§‹ä½ç½®åˆ°å½“å‰è¿è¡Œçš„PCä½ç½®ï¼Œä½¿ç”¨äº†å¤šå°‘æ ˆç©ºé—´ã€‚å­˜å‚¨åˆ°framesizeä¸­ã€‚</span>

<span class="w">            </span><span class="n">LR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">SP</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<span class="w">            </span><span class="c1">//è®¡ç®—LRçš„å€¼ï¼Œå¦‚ä¸Šâ‘¡ï¼ŒRAæ˜¯å­˜å‚¨åˆ°SP+offsetçš„ä½ç½®ã€‚</span>

<span class="w">            </span><span class="o">*</span><span class="n">pSP</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">SP</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">framesize</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//*pSPå³ä¸ºæ ˆåº•ä½ç½®ï¼Œå³ä¸ºä¸Šä¸€ä¸ªå‡½æ•°çš„æ ˆé¡¶ï¼Œä¸ºä¸‹ä¸€æ¬¡éå†åšå‡†å¤‡</span>

<span class="w">            </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_lr_offset</span><span class="p">(</span><span class="n">LR</span><span class="p">,</span><span class="w"> </span><span class="n">print_func</span><span class="p">);</span>
<span class="w">                </span><span class="n">print_backtrace</span><span class="p">(</span><span class="n">print_func</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">LR_fixed</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="c1">//æ‰“å°ä½ç½®</span>
<span class="w">            </span><span class="o">*</span><span class="n">pPC</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">LR</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//å› ä¸ºRAå­˜å‚¨çš„æ˜¯è·³è½¬æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ‰€ä»¥éœ€è¦å‡å»ä¸€æ¡æŒ‡ä»¤å°±å¾—åˆ°è·³è½¬çš„ä½ç½®ã€‚</span>
<span class="w">            </span><span class="c1">//åˆ°è¿™é‡Œ*pSPã€*pPCå°±æ›´æ–°åˆ°ä¸Šä¸€ä¸ªå‡½æ•°çš„å€¼ï¼Œå†æ¥ç€ç»§ç»­éå†å³å¯ã€‚</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="freertosæ ˆæº¢å‡ºæ£€æµ‹åŸç†.html">â† freertosæ ˆæº¢å‡ºæ£€æµ‹åŸç†</a>
    <a class="next" href="risc-våŠ¨æ€é“¾æ¥å®éªŒ.html">RISC-VåŠ¨æ€é“¾æ¥å®éªŒ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

