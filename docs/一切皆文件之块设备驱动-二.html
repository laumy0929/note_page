<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆäºŒï¼‰ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">æ‰“å¼€å—è®¾å¤‡</a><ul><li><a href="#mknod">mknod</a></li><li><a href="#blk_dev_open">blk_dev_open</a></li><li><a href="#bdev">bdevæ–‡ä»¶ç³»ç»Ÿ</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆäºŒï¼‰</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-06-04
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">æ‰“å¼€å—è®¾å¤‡</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_8cb0c52c358ef8ad24b7aef183457582.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆäºŒï¼‰/images/wp_editor_md_8cb0c52c358ef8ad24b7aef183457582.jpg"/></a></p>
<h3 id="mknod">mknod</h3>
<p>å—è®¾å¤‡åŒæ ·è¦ä½¿ç”¨mknodåˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ï¼Œè¿™ä¸å­—ç¬¦è®¾å¤‡ä¸€æ ·ã€‚ä¼šè°ƒç”¨åˆ°init_special_inodeå¡«å……inodeçš„file_operationsï¼Œåªä¸è¿‡å—è®¾å¤‡æ³¨å†Œçš„æ˜¯def_blk_fopsã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">init_special_inode</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">umode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">S_ISCHR</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">def_chr_fops</span><span class="p">;</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdev</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">def_blk_fops</span><span class="p">;</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdev</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">S_ISFIFO</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pipefifo_fops</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">S_ISSOCK</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
<span class="w">        </span><span class="p">;</span><span class="w">   </span><span class="cm">/* leave it no_open_fops */</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="w"> </span><span class="s">"init_special_inode: bogus i_mode (%o) for"</span>
<span class="w">                  </span><span class="s">" inode %s:%lu</span><span class="se">\\</span><span class="s">n"</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span>
<span class="w">                  </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>def_blk_fopså¦‚ä¸‹ï¼Œä¸å­—ç¬¦è®¾å¤‡ä¸€æ ·ï¼Œå½“æ‰“å¼€å—è®¾å¤‡æ—¶ï¼Œå°±ä¼šè°ƒç”¨åˆ°blk_dev_openã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="n">def_blk_fops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">open</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">blkdev_open</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">release</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">blkdev_close</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">llseek</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">blkdev_llseek</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_iter</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">blkdev_read_iter</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blkdev_write_iter</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">iopoll</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">blkdev_iopoll</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">mmap</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">generic_file_mmap</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">fsync</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">blkdev_fsync</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">unlocked_ioctl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="w">    </span><span class="p">.</span><span class="n">compat_ioctl</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">compat_blkdev_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">.</span><span class="n">splice_read</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">generic_file_splice_read</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">splice_write</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">iter_file_splice_write</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">fallocate</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">blkdev_fallocate</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="blk_dev_open">blk_dev_open</h3>
<p>blk_dev_opené‡Œé¢å…³é”®çš„æ“ä½œæ—¶è°ƒç”¨blkdev_getè·å–åˆ°å—è®¾å¤‡ï¼Œå¹¶èµ‹å€¼fileä¸­f_mappingã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">blkdev_open</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
<span class="w">    </span><span class="p">......</span>
<span class="w">    </span><span class="n">bdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blkdev_get_by_dev</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span><span class="p">,</span><span class="w"> </span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="p">,</span><span class="w"> </span><span class="n">filp</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
<span class="w">    </span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">;</span>
<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_wb_err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filemap_sample_wb_err</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="bdev">bdevæ–‡ä»¶ç³»ç»Ÿ</h3>
<p>blk_dev_openè°ƒç”¨blkdev_get_by_devè·å–åˆ°å—è®¾å¤‡å¾—bdevï¼Œè·å–å—è®¾å¤‡æ˜¯é€šè¿‡bdevæ–‡ä»¶ç³»ç»Ÿæ¥æŸ¥è¯¢è·å–ï¼Œä¸‹é¢å…ˆæ¥äº†è§£ä¸‹bdevæ–‡ä»¶ç³»ç»Ÿçš„æ³¨å†Œè¿‡ç¨‹ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_c0b3a00985afb828dd0272f25604fb43.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆäºŒï¼‰/images/wp_editor_md_c0b3a00985afb828dd0272f25604fb43.jpg"/></a></p>
<p>bdevæ˜¯ç³»ç»Ÿæ³¨å†Œæ˜¯åœ¨ç³»ç»Ÿå¯åŠ¨åˆå§‹åŒ–é˜¶æ®µè°ƒç”¨bdev_cache_initæ³¨å†Œçš„ï¼Œæ¯ä¸ªå—è®¾å¤‡åœ¨bdevæ–‡ä»¶ç³»ç»Ÿä¸­éƒ½æœ‰ä¸€ä¸ªinodeï¼Œlinuxåˆ©ç”¨block_inodeæ•°æ®ç»“æ„å°†inodeå’Œblock_deviceè¿›è¡Œå…³è”èµ·æ¥ï¼Œå¯¹è®¾å¤‡block_deviceçš„æŸ¥æ‰¾è½¬åŒ–ä¸ºåœ¨bdevæ–‡ä»¶ç³»ç»Ÿä¸­å¯¹inodeçš„æŸ¥æ‰¾ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_865a6282bf3aa00e5ad1f7a0941e7d54.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆäºŒï¼‰/images/wp_editor_md_865a6282bf3aa00e5ad1f7a0941e7d54.jpg"/></a></p></div>
  <div class="post-nav">
    <a class="prev" href="ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨-ä¸‰.html">â† ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆä¸‰ï¼‰</a>
    <a class="next" href="ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨-äº”.html">ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆäº”ï¼‰ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

