<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>拍照示例代码分析 - Laumy的技术栈</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="">首页</a></div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#_1">数据结构</a><ul></ul></li><li><a href="#_2">初始化启动</a><ul><li><a href="#mpp">启动MPP系统</a></li><li><a href="#vipp">使能VIPP</a></li><li><a href="#_3">使能虚拟通道</a></li><li><a href="#_4">启动拍照线程</a></li></ul></li><li><a href="#_5">拍照线程</a><ul><li><a href="#jpeg">创建JPEG编码通道</a></li><li><a href="#_6">获取拍照数据</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>拍照示例代码分析</h1>
  <div class="meta">2024-11-17 · linux</div>
  <div class="post-content"><h2 id="_1">数据结构</h2>
<p>待补充</p>
<h2 id="_2">初始化启动</h2>
<h3 id="mpp">启动MPP系统</h3>
<div class="codehilite"><pre><span></span><code><span class="n">MPP_SYS_CONF_S</span><span class="w"> </span><span class="n">mSysConf</span><span class="p">;</span>
<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mSysConf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">MPP_SYS_CONF_S</span><span class="p">));</span>
<span class="n">mSysConf</span><span class="p">.</span><span class="n">nAlignWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="n">AW_MPI_SYS_SetConf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mSysConf</span><span class="p">);</span>
<span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AW_MPI_SYS_Init</span><span class="p">();</span>
</code></pre></div>
<h3 id="vipp">使能VIPP</h3>
<div class="codehilite"><pre><span></span><code><span class="n">设置VI通道属性</span>
<span class="w">    </span><span class="n">VI_ATTR_S</span><span class="w"> </span><span class="n">stAttr</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/*Set VI Channel Attribute*/</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stAttr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VI_ATTR_S</span><span class="p">));</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">;</span><span class="w"> </span><span class="c1">//采集数据方式</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">memtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span><span class="w"> </span><span class="c1">//采集的内存方式</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">pixelformat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map_PIXEL_FORMAT_E_to_V4L2_PIX_FMT</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">SrcFormat</span><span class="p">);</span><span class="w"> </span><span class="c1">//输出的裸数据格式？</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">colorspace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mColorSpace</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">SrcWidth</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">SrcHeight</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">nbufs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">nplanes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">fps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">FrameRate</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* update configuration anyway, do not use current configuration */</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">use_current_win</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">wdr_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">capturemode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_MODE_VIDEO</span><span class="p">;</span><span class="w"> </span><span class="cm">/* V4L2_MODE_VIDEO; V4L2_MODE_IMAGE; V4L2_MODE_PREVIEW */</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">drop_frame_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mViDropFrmCnt</span><span class="p">;</span><span class="w"> </span><span class="c1">// drop 2 second video data, default=0</span>
<span class="w">    </span><span class="n">AW_MPI_VI_CreateVipp</span><span class="p">(</span><span class="n">vipp_dev</span><span class="p">);</span><span class="w"> </span><span class="c1">//创建VIPP</span>
<span class="w">    </span><span class="n">AW_MPI_VI_SetVippAttr</span><span class="p">(</span><span class="n">vipp_dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stAttr</span><span class="p">);</span><span class="c1">//设置VIPP属性</span>
<span class="w">    </span><span class="n">AW_MPI_ISP_Run</span><span class="p">(</span><span class="n">iIspDev</span><span class="p">);</span>
<span class="w">    </span><span class="n">AW_MPI_VI_EnableVipp</span><span class="p">(</span><span class="n">vipp_dev</span><span class="p">);</span><span class="w"> </span><span class="c1">//使能VIPP</span>
</code></pre></div>
<h3 id="_3">使能虚拟通道</h3>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AW_MPI_VI_CreateVirChn</span><span class="p">(</span><span class="n">ViDev</span><span class="p">,</span><span class="w"> </span><span class="n">ViCh</span><span class="p">,</span><span class="w"> </span><span class="n">pAttr</span><span class="p">);</span><span class="w"> </span><span class="c1">//创建虚拟通道</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AW_MPI_VI_SetVirChnAttr</span><span class="p">(</span><span class="n">ViDev</span><span class="p">,</span><span class="w"> </span><span class="n">ViCh</span><span class="p">,</span><span class="w"> </span><span class="n">pAttr</span><span class="p">);</span><span class="c1">//设置虚拟通道属性</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AW_MPI_VI_EnableVirChn</span><span class="p">(</span><span class="n">ViDev</span><span class="p">,</span><span class="w"> </span><span class="n">ViCh</span><span class="p">);</span><span class="c1">//使能虚拟通道</span>
</code></pre></div>
<p>创建虚拟通道并设置虚拟通道的属性，最后使能。</p>
<h3 id="_4">启动拍照线程</h3>
<div class="codehilite"><pre><span></span><code><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">privCap</span><span class="p">[</span><span class="n">vipp_dev</span><span class="p">][</span><span class="n">virvi_chn</span><span class="p">].</span><span class="n">thid</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">GetCSIFrameThread</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">privCap</span><span class="p">[</span><span class="n">vipp_dev</span><span class="p">][</span><span class="n">virvi_chn</span><span class="p">]);</span>
</code></pre></div>
<h2 id="_5">拍照线程</h2>
<h3 id="jpeg">创建JPEG编码通道</h3>
<p>创建编码通道，初始化编码为jpeg格式，设置拍照的JPEG参数，设置JPEG图片的描述信息，包括快门速度，曝光时间，GPS信息，缩略图信息等。</p>
<div class="codehilite"><pre><span></span><code><span class="n">初始化编码通道的属性</span><span class="err">，</span><span class="n">如设置编码类型为jpeg</span>
<span class="w">   </span><span class="c1">// calc vbv buf size and vbv threshold size</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">minVbvBufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">picHeight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">vbvThreshSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">picHeight</span><span class="p">;</span>
<span class="w">    </span><span class="n">nVbvBufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">picWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">picHeight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="o">/</span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mPictureNum</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vbvThreshSize</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nVbvBufSize</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minVbvBufSize</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">nVbvBufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minVbvBufSize</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nVbvBufSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">nVbvBufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vbvThreshSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">nVbvBufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AWALIGN</span><span class="p">(</span><span class="n">nVbvBufSize</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>

<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VENC_CHN_ATTR_S</span><span class="p">));</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PT_JPEG</span><span class="p">;</span><span class="w"> </span><span class="c1">//编码类型为JPEG，不适用h264</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">mVippID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">DevNum</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">MaxPicWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">MaxPicHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">BufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nVbvBufSize</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">mThreshSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vbvThreshSize</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">bByFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">PicWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picWidth</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">PicHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picHeight</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">bSupportDCF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">MaxKeyInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">SrcPicWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">SrcWidth</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">SrcPicHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">SrcHeight</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">Field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VIDEO_FIELD_FRAME</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">PixelFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">SrcFormat</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">OutputFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">OutputFormat</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">mColorSpace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mColorSpace</span><span class="p">;</span>

<span class="n">创建编码通道</span>
<span class="w">    </span><span class="nf">AW_MPI_VENC_CreateChn</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">);</span>
<span class="w">    </span><span class="n">MPPCallbackInfo</span><span class="w"> </span><span class="n">cbInfo</span><span class="p">;</span>
<span class="w">    </span><span class="n">cbInfo</span><span class="p">.</span><span class="n">cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">pCap</span><span class="p">;</span>
<span class="w">    </span><span class="n">cbInfo</span><span class="p">.</span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">MPPCallbackFuncType</span><span class="p">)</span><span class="o">&amp;</span><span class="n">MPPCallbackWrapper</span><span class="p">;</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_RegisterCallback</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cbInfo</span><span class="p">);</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegParam</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VENC_PARAM_JPEG_S</span><span class="p">));</span>
<span class="n">设置JPEG的参数</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegParam</span><span class="p">.</span><span class="n">Qfactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="p">;</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_SetJpegParam</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegParam</span><span class="p">);</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_ForbidDiscardingFrame</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">);</span><span class="w"> </span><span class="c1">//设置组件编码失败禁止丢帧模式</span>
<span class="n">配置ISPVE联动参数</span><span class="err">？？</span>
<span class="w">    </span><span class="n">VENC_IspVeLinkAttr</span><span class="w"> </span><span class="n">stIspVeLinkAttr</span><span class="p">;</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stIspVeLinkAttr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VENC_IspVeLinkAttr</span><span class="p">));</span>
<span class="w">    </span><span class="n">stIspVeLinkAttr</span><span class="p">.</span><span class="n">bEnableIsp2Ve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">    </span><span class="n">stIspVeLinkAttr</span><span class="p">.</span><span class="n">bEnableVe2Isp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
<span class="w">    </span><span class="n">stIspVeLinkAttr</span><span class="p">.</span><span class="n">nVipp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">Dev</span><span class="p">;</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_EnableIspVeLink</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stIspVeLinkAttr</span><span class="p">);</span>

<span class="n">设置JPEG图片的描述信息</span><span class="err">，</span><span class="n">包括快门速度</span><span class="err">，</span><span class="n">曝光时间</span><span class="err">，</span><span class="n">GPS信息</span><span class="err">，</span><span class="n">缩略图信息等</span><span class="err">。</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">Orientation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//pCap-&gt;mExifInfo.fr32FNumber = FRACTION32(10, 26);</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">FNumber</span><span class="p">.</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">26</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">FNumber</span><span class="p">.</span><span class="n">den</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">MeteringMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">METERING_MODE_AVERAGE</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//pCap-&gt;mExifInfo.fr32FocalLength = FRACTION32(100, 228);</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">FocalLength</span><span class="p">.</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">228</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">FocalLength</span><span class="p">.</span><span class="n">den</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">WhiteBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">FocalLengthIn35mmFilm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">resolution_x</span><span class="p">.</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">resolution_x</span><span class="p">.</span><span class="n">den</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">resolution_y</span><span class="p">.</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">resolution_y</span><span class="p">.</span><span class="n">den</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">ImageName</span><span class="p">,</span><span class="w"> </span><span class="err">\\\</span><span class="s">"aw-photo</span><span class="se">\\\"</span><span class="s">);</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_SetJpegExifInfo</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">);</span>
</code></pre></div>
<h3 id="_6">获取拍照数据</h3>
<div class="codehilite"><pre><span></span><code><span class="k">while</span><span class="p">(</span><span class="n">isRunFlag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">获取VI设备一帧图像</span><span class="err">，</span><span class="n">属性包括width</span><span class="err">，</span><span class="n">height</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="n">pixelformat</span><span class="p">,</span><span class="n">timestamp</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">VirAddr</span><span class="p">,</span><span class="n">mem_phy</span><span class="p">,</span><span class="n">size等</span><span class="err">。</span>
<span class="n">其中pstFrameInfo为存储视频图像帧信息</span><span class="err">。</span><span class="n">这里获取的还是未编码的图像</span><span class="err">。</span>
<span class="w">     </span><span class="n">AW_MPI_VI_GetFrame</span><span class="p">(</span><span class="n">ViDev</span><span class="p">,</span><span class="w"> </span><span class="n">ViCh</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">pstFrameInfo</span><span class="p">,</span><span class="w"> </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">s32MilliSec</span><span class="p">)</span>
<span class="w">    </span><span class="n">拍照模式单拍</span>
<span class="w">    </span><span class="n">isRunFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">saveJpegPicture</span><span class="p">(</span><span class="n">pCap</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">pstFrameInfo</span><span class="p">,</span><span class="w"> </span><span class="n">mJpegTestCnt</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">拍照模式连拍</span>
<span class="w">    </span><span class="nf">saveJpegPicture</span><span class="p">(</span><span class="n">pCap</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">pstFrameInfo</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">mContinuousPictureCnt</span><span class="p">);</span>
<span class="w">    </span><span class="n">mContinuousPictureCnt</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mContinuousPictureCnt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mTakePictureNum</span><span class="p">)</span>
<span class="w">        </span><span class="n">isRunFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">saveJpegPicture</span><span class="err">（）</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">将获取未编码的图像发送给编码器</span>
<span class="w">    </span><span class="nf">AW_MPI_VENC_SendFrame</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="n">pFrameInfo</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="n">等待编码器编码</span>
<span class="w">    </span><span class="nf">cdx_sem_down_timedwait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mSemFrameBack</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>

<span class="w">    </span><span class="n">获取编码的JPEG</span>
<span class="w">    </span><span class="nf">AW_MPI_VENC_GetStream</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>

<span class="w">    </span><span class="n">获取编码器jpeg缩略图buffer</span><span class="err">，</span><span class="n">写入缩略图</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_GetJpegThumbBuffer</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegThumbBuf</span><span class="p">);</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegThumbBuf</span><span class="p">.</span><span class="n">ThumbAddrVir</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegThumbBuf</span><span class="p">.</span><span class="n">ThumbLen</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">thumb_fdpic</span><span class="p">);</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegThumbBuf</span><span class="p">.</span><span class="n">ThumbAddrVir</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegThumbBuf</span><span class="p">.</span><span class="n">ThumbLen</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">thumb_fdpic</span><span class="p">);</span>

<span class="w">    </span><span class="n">写jpeg到文件</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mpAddr0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mLen0</span><span class="p">,</span><span class="w"> </span><span class="n">fpPic</span><span class="p">)</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mpAddr1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mLen1</span><span class="p">,</span><span class="w"> </span><span class="n">fpPic</span><span class="p">)</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mpAddr2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mLen2</span><span class="p">,</span><span class="w"> </span><span class="n">fpPic</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>先使用AW_MPI_VI_GetFrame获取裸数据，然后用AW_MPI_VENC_SendFrame送编码器，再用AW_MPI_VENC_GetStream获得jpeg图片，最后写入到文件中保存。这种拍照的方式用的是离线模式，中间转了一道，还增加了内存，如果用在线直接出jpeg，应该是可以省掉一些内存，但是目前这框架加水印等会比较麻烦？在线模式需要一直占个一个VIPP。用离线的话可以复用。</p></div>
  <div class="post-nav">
    <a class="prev" href="ssl-tls协议分析.html">← SSL/TLS协议分析</a>
    <a class="next" href="rtsp视频传输示例代码分析.html">RTSP视频传输示例代码分析 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

