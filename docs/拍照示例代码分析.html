<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>æ‹ç…§ç¤ºä¾‹ä»£ç åˆ†æ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">æ•°æ®ç»“æ„</a><ul></ul></li><li><a href="#_2">åˆå§‹åŒ–å¯åŠ¨</a><ul><li><a href="#mpp">å¯åŠ¨MPPç³»ç»Ÿ</a></li><li><a href="#vipp">ä½¿èƒ½VIPP</a></li><li><a href="#_3">ä½¿èƒ½è™šæ‹Ÿé€šé“</a></li><li><a href="#_4">å¯åŠ¨æ‹ç…§çº¿ç¨‹</a></li></ul></li><li><a href="#_5">æ‹ç…§çº¿ç¨‹</a><ul><li><a href="#jpeg">åˆ›å»ºJPEGç¼–ç é€šé“</a></li><li><a href="#_6">è·å–æ‹ç…§æ•°æ®</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>æ‹ç…§ç¤ºä¾‹ä»£ç åˆ†æ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-11-17
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">æ•°æ®ç»“æ„</h2>
<p>å¾…è¡¥å……</p>
<h2 id="_2">åˆå§‹åŒ–å¯åŠ¨</h2>
<h3 id="mpp">å¯åŠ¨MPPç³»ç»Ÿ</h3>
<div class="codehilite"><pre><span></span><code><span class="n">MPP_SYS_CONF_S</span><span class="w"> </span><span class="n">mSysConf</span><span class="p">;</span>
<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mSysConf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">MPP_SYS_CONF_S</span><span class="p">));</span>
<span class="n">mSysConf</span><span class="p">.</span><span class="n">nAlignWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="n">AW_MPI_SYS_SetConf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mSysConf</span><span class="p">);</span>
<span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AW_MPI_SYS_Init</span><span class="p">();</span>
</code></pre></div>
<h3 id="vipp">ä½¿èƒ½VIPP</h3>
<div class="codehilite"><pre><span></span><code><span class="n">è®¾ç½®VIé€šé“å±æ€§</span>
<span class="w">    </span><span class="n">VI_ATTR_S</span><span class="w"> </span><span class="n">stAttr</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/*Set VI Channel Attribute*/</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stAttr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VI_ATTR_S</span><span class="p">));</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE</span><span class="p">;</span><span class="w"> </span><span class="c1">//é‡‡é›†æ•°æ®æ–¹å¼</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">memtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span><span class="w"> </span><span class="c1">//é‡‡é›†çš„å†…å­˜æ–¹å¼</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">pixelformat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map_PIXEL_FORMAT_E_to_V4L2_PIX_FMT</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">SrcFormat</span><span class="p">);</span><span class="w"> </span><span class="c1">//è¾“å‡ºçš„è£¸æ•°æ®æ ¼å¼ï¼Ÿ</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">colorspace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mColorSpace</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">SrcWidth</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">SrcHeight</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">nbufs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">nplanes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">fps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">FrameRate</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* update configuration anyway, do not use current configuration */</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">use_current_win</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">wdr_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">capturemode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_MODE_VIDEO</span><span class="p">;</span><span class="w"> </span><span class="cm">/* V4L2_MODE_VIDEO; V4L2_MODE_IMAGE; V4L2_MODE_PREVIEW */</span>
<span class="w">    </span><span class="n">stAttr</span><span class="p">.</span><span class="n">drop_frame_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mViDropFrmCnt</span><span class="p">;</span><span class="w"> </span><span class="c1">// drop 2 second video data, default=0</span>
<span class="w">    </span><span class="n">AW_MPI_VI_CreateVipp</span><span class="p">(</span><span class="n">vipp_dev</span><span class="p">);</span><span class="w"> </span><span class="c1">//åˆ›å»ºVIPP</span>
<span class="w">    </span><span class="n">AW_MPI_VI_SetVippAttr</span><span class="p">(</span><span class="n">vipp_dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stAttr</span><span class="p">);</span><span class="c1">//è®¾ç½®VIPPå±æ€§</span>
<span class="w">    </span><span class="n">AW_MPI_ISP_Run</span><span class="p">(</span><span class="n">iIspDev</span><span class="p">);</span>
<span class="w">    </span><span class="n">AW_MPI_VI_EnableVipp</span><span class="p">(</span><span class="n">vipp_dev</span><span class="p">);</span><span class="w"> </span><span class="c1">//ä½¿èƒ½VIPP</span>
</code></pre></div>
<h3 id="_3">ä½¿èƒ½è™šæ‹Ÿé€šé“</h3>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AW_MPI_VI_CreateVirChn</span><span class="p">(</span><span class="n">ViDev</span><span class="p">,</span><span class="w"> </span><span class="n">ViCh</span><span class="p">,</span><span class="w"> </span><span class="n">pAttr</span><span class="p">);</span><span class="w"> </span><span class="c1">//åˆ›å»ºè™šæ‹Ÿé€šé“</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AW_MPI_VI_SetVirChnAttr</span><span class="p">(</span><span class="n">ViDev</span><span class="p">,</span><span class="w"> </span><span class="n">ViCh</span><span class="p">,</span><span class="w"> </span><span class="n">pAttr</span><span class="p">);</span><span class="c1">//è®¾ç½®è™šæ‹Ÿé€šé“å±æ€§</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AW_MPI_VI_EnableVirChn</span><span class="p">(</span><span class="n">ViDev</span><span class="p">,</span><span class="w"> </span><span class="n">ViCh</span><span class="p">);</span><span class="c1">//ä½¿èƒ½è™šæ‹Ÿé€šé“</span>
</code></pre></div>
<p>åˆ›å»ºè™šæ‹Ÿé€šé“å¹¶è®¾ç½®è™šæ‹Ÿé€šé“çš„å±æ€§ï¼Œæœ€åä½¿èƒ½ã€‚</p>
<h3 id="_4">å¯åŠ¨æ‹ç…§çº¿ç¨‹</h3>
<div class="codehilite"><pre><span></span><code><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">privCap</span><span class="p">[</span><span class="n">vipp_dev</span><span class="p">][</span><span class="n">virvi_chn</span><span class="p">].</span><span class="n">thid</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">GetCSIFrameThread</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">privCap</span><span class="p">[</span><span class="n">vipp_dev</span><span class="p">][</span><span class="n">virvi_chn</span><span class="p">]);</span>
</code></pre></div>
<h2 id="_5">æ‹ç…§çº¿ç¨‹</h2>
<h3 id="jpeg">åˆ›å»ºJPEGç¼–ç é€šé“</h3>
<p>åˆ›å»ºç¼–ç é€šé“ï¼Œåˆå§‹åŒ–ç¼–ç ä¸ºjpegæ ¼å¼ï¼Œè®¾ç½®æ‹ç…§çš„JPEGå‚æ•°ï¼Œè®¾ç½®JPEGå›¾ç‰‡çš„æè¿°ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¿«é—¨é€Ÿåº¦ï¼Œæ›å…‰æ—¶é—´ï¼ŒGPSä¿¡æ¯ï¼Œç¼©ç•¥å›¾ä¿¡æ¯ç­‰ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">åˆå§‹åŒ–ç¼–ç é€šé“çš„å±æ€§</span><span class="err">ï¼Œ</span><span class="n">å¦‚è®¾ç½®ç¼–ç ç±»å‹ä¸ºjpeg</span>
<span class="w">   </span><span class="c1">// calc vbv buf size and vbv threshold size</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">minVbvBufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">picHeight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">vbvThreshSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">picHeight</span><span class="p">;</span>
<span class="w">    </span><span class="n">nVbvBufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">picWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">picHeight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="o">/</span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mPictureNum</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vbvThreshSize</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nVbvBufSize</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minVbvBufSize</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">nVbvBufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minVbvBufSize</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nVbvBufSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">nVbvBufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vbvThreshSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">nVbvBufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AWALIGN</span><span class="p">(</span><span class="n">nVbvBufSize</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>

<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VENC_CHN_ATTR_S</span><span class="p">));</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PT_JPEG</span><span class="p">;</span><span class="w"> </span><span class="c1">//ç¼–ç ç±»å‹ä¸ºJPEGï¼Œä¸é€‚ç”¨h264</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">mVippID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">DevNum</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">MaxPicWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">MaxPicHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">BufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nVbvBufSize</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">mThreshSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vbvThreshSize</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">bByFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">PicWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picWidth</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">PicHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picHeight</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">AttrJpeg</span><span class="p">.</span><span class="n">bSupportDCF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">MaxKeyInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">SrcPicWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">SrcWidth</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">SrcPicHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">SrcHeight</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">Field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VIDEO_FIELD_FRAME</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">PixelFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">SrcFormat</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">OutputFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">OutputFormat</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">.</span><span class="n">VeAttr</span><span class="p">.</span><span class="n">mColorSpace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mColorSpace</span><span class="p">;</span>

<span class="n">åˆ›å»ºç¼–ç é€šé“</span>
<span class="w">    </span><span class="nf">AW_MPI_VENC_CreateChn</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChnAttr</span><span class="p">);</span>
<span class="w">    </span><span class="n">MPPCallbackInfo</span><span class="w"> </span><span class="n">cbInfo</span><span class="p">;</span>
<span class="w">    </span><span class="n">cbInfo</span><span class="p">.</span><span class="n">cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">pCap</span><span class="p">;</span>
<span class="w">    </span><span class="n">cbInfo</span><span class="p">.</span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">MPPCallbackFuncType</span><span class="p">)</span><span class="o">&amp;</span><span class="n">MPPCallbackWrapper</span><span class="p">;</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_RegisterCallback</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cbInfo</span><span class="p">);</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegParam</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VENC_PARAM_JPEG_S</span><span class="p">));</span>
<span class="n">è®¾ç½®JPEGçš„å‚æ•°</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegParam</span><span class="p">.</span><span class="n">Qfactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="p">;</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_SetJpegParam</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegParam</span><span class="p">);</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_ForbidDiscardingFrame</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">);</span><span class="w"> </span><span class="c1">//è®¾ç½®ç»„ä»¶ç¼–ç å¤±è´¥ç¦æ­¢ä¸¢å¸§æ¨¡å¼</span>
<span class="n">é…ç½®ISPVEè”åŠ¨å‚æ•°</span><span class="err">ï¼Ÿï¼Ÿ</span>
<span class="w">    </span><span class="n">VENC_IspVeLinkAttr</span><span class="w"> </span><span class="n">stIspVeLinkAttr</span><span class="p">;</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stIspVeLinkAttr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">VENC_IspVeLinkAttr</span><span class="p">));</span>
<span class="w">    </span><span class="n">stIspVeLinkAttr</span><span class="p">.</span><span class="n">bEnableIsp2Ve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">    </span><span class="n">stIspVeLinkAttr</span><span class="p">.</span><span class="n">bEnableVe2Isp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
<span class="w">    </span><span class="n">stIspVeLinkAttr</span><span class="p">.</span><span class="n">nVipp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">Dev</span><span class="p">;</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_EnableIspVeLink</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stIspVeLinkAttr</span><span class="p">);</span>

<span class="n">è®¾ç½®JPEGå›¾ç‰‡çš„æè¿°ä¿¡æ¯</span><span class="err">ï¼Œ</span><span class="n">åŒ…æ‹¬å¿«é—¨é€Ÿåº¦</span><span class="err">ï¼Œ</span><span class="n">æ›å…‰æ—¶é—´</span><span class="err">ï¼Œ</span><span class="n">GPSä¿¡æ¯</span><span class="err">ï¼Œ</span><span class="n">ç¼©ç•¥å›¾ä¿¡æ¯ç­‰</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">Orientation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//pCap-&gt;mExifInfo.fr32FNumber = FRACTION32(10, 26);</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">FNumber</span><span class="p">.</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">26</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">FNumber</span><span class="p">.</span><span class="n">den</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">MeteringMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">METERING_MODE_AVERAGE</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//pCap-&gt;mExifInfo.fr32FocalLength = FRACTION32(100, 228);</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">FocalLength</span><span class="p">.</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">228</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">FocalLength</span><span class="p">.</span><span class="n">den</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">WhiteBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">FocalLengthIn35mmFilm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">resolution_x</span><span class="p">.</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">resolution_x</span><span class="p">.</span><span class="n">den</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">resolution_y</span><span class="p">.</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="w">    </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">resolution_y</span><span class="p">.</span><span class="n">den</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">.</span><span class="n">ImageName</span><span class="p">,</span><span class="w"> </span><span class="err">\\\</span><span class="s">"aw-photo</span><span class="se">\\\"</span><span class="s">);</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_SetJpegExifInfo</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mExifInfo</span><span class="p">);</span>
</code></pre></div>
<h3 id="_6">è·å–æ‹ç…§æ•°æ®</h3>
<div class="codehilite"><pre><span></span><code><span class="k">while</span><span class="p">(</span><span class="n">isRunFlag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">è·å–VIè®¾å¤‡ä¸€å¸§å›¾åƒ</span><span class="err">ï¼Œ</span><span class="n">å±æ€§åŒ…æ‹¬width</span><span class="err">ï¼Œ</span><span class="n">height</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="n">pixelformat</span><span class="p">,</span><span class="n">timestamp</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">VirAddr</span><span class="p">,</span><span class="n">mem_phy</span><span class="p">,</span><span class="n">sizeç­‰</span><span class="err">ã€‚</span>
<span class="n">å…¶ä¸­pstFrameInfoä¸ºå­˜å‚¨è§†é¢‘å›¾åƒå¸§ä¿¡æ¯</span><span class="err">ã€‚</span><span class="n">è¿™é‡Œè·å–çš„è¿˜æ˜¯æœªç¼–ç çš„å›¾åƒ</span><span class="err">ã€‚</span>
<span class="w">     </span><span class="n">AW_MPI_VI_GetFrame</span><span class="p">(</span><span class="n">ViDev</span><span class="p">,</span><span class="w"> </span><span class="n">ViCh</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">pstFrameInfo</span><span class="p">,</span><span class="w"> </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">s32MilliSec</span><span class="p">)</span>
<span class="w">    </span><span class="n">æ‹ç…§æ¨¡å¼å•æ‹</span>
<span class="w">    </span><span class="n">isRunFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">saveJpegPicture</span><span class="p">(</span><span class="n">pCap</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">pstFrameInfo</span><span class="p">,</span><span class="w"> </span><span class="n">mJpegTestCnt</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">æ‹ç…§æ¨¡å¼è¿æ‹</span>
<span class="w">    </span><span class="nf">saveJpegPicture</span><span class="p">(</span><span class="n">pCap</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">pstFrameInfo</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">mContinuousPictureCnt</span><span class="p">);</span>
<span class="w">    </span><span class="n">mContinuousPictureCnt</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mContinuousPictureCnt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">mConfigPara</span><span class="p">.</span><span class="n">mTakePictureNum</span><span class="p">)</span>
<span class="w">        </span><span class="n">isRunFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">saveJpegPicture</span><span class="err">ï¼ˆï¼‰</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">å°†è·å–æœªç¼–ç çš„å›¾åƒå‘é€ç»™ç¼–ç å™¨</span>
<span class="w">    </span><span class="nf">AW_MPI_VENC_SendFrame</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="n">pFrameInfo</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="n">ç­‰å¾…ç¼–ç å™¨ç¼–ç </span>
<span class="w">    </span><span class="nf">cdx_sem_down_timedwait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mSemFrameBack</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>

<span class="w">    </span><span class="n">è·å–ç¼–ç çš„JPEG</span>
<span class="w">    </span><span class="nf">AW_MPI_VENC_GetStream</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>

<span class="w">    </span><span class="n">è·å–ç¼–ç å™¨jpegç¼©ç•¥å›¾buffer</span><span class="err">ï¼Œ</span><span class="n">å†™å…¥ç¼©ç•¥å›¾</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_GetJpegThumbBuffer</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegThumbBuf</span><span class="p">);</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegThumbBuf</span><span class="p">.</span><span class="n">ThumbAddrVir</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegThumbBuf</span><span class="p">.</span><span class="n">ThumbLen</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">thumb_fdpic</span><span class="p">);</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegThumbBuf</span><span class="p">.</span><span class="n">ThumbAddrVir</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mJpegThumbBuf</span><span class="p">.</span><span class="n">ThumbLen</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">thumb_fdpic</span><span class="p">);</span>

<span class="w">    </span><span class="n">å†™jpegåˆ°æ–‡ä»¶</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mpAddr0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mLen0</span><span class="p">,</span><span class="w"> </span><span class="n">fpPic</span><span class="p">)</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mpAddr1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mLen1</span><span class="p">,</span><span class="w"> </span><span class="n">fpPic</span><span class="p">)</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mpAddr2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">mOutStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mLen2</span><span class="p">,</span><span class="w"> </span><span class="n">fpPic</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>å…ˆä½¿ç”¨AW_MPI_VI_GetFrameè·å–è£¸æ•°æ®ï¼Œç„¶åç”¨AW_MPI_VENC_SendFrameé€ç¼–ç å™¨ï¼Œå†ç”¨AW_MPI_VENC_GetStreamè·å¾—jpegå›¾ç‰‡ï¼Œæœ€åå†™å…¥åˆ°æ–‡ä»¶ä¸­ä¿å­˜ã€‚è¿™ç§æ‹ç…§çš„æ–¹å¼ç”¨çš„æ˜¯ç¦»çº¿æ¨¡å¼ï¼Œä¸­é—´è½¬äº†ä¸€é“ï¼Œè¿˜å¢åŠ äº†å†…å­˜ï¼Œå¦‚æœç”¨åœ¨çº¿ç›´æ¥å‡ºjpegï¼Œåº”è¯¥æ˜¯å¯ä»¥çœæ‰ä¸€äº›å†…å­˜ï¼Œä½†æ˜¯ç›®å‰è¿™æ¡†æ¶åŠ æ°´å°ç­‰ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Ÿåœ¨çº¿æ¨¡å¼éœ€è¦ä¸€ç›´å ä¸ªä¸€ä¸ªVIPPã€‚ç”¨ç¦»çº¿çš„è¯å¯ä»¥å¤ç”¨ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="ssl-tlsåè®®åˆ†æ.html">â† SSL/TLSåè®®åˆ†æ</a>
    <a class="next" href="rtspè§†é¢‘ä¼ è¾“ç¤ºä¾‹ä»£ç åˆ†æ.html">RTSPè§†é¢‘ä¼ è¾“ç¤ºä¾‹ä»£ç åˆ†æ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

