<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å®ç°ç®€å•æ–‡ä»¶ç³»ç»Ÿ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">æ–‡ä»¶ç³»ç»Ÿæ³¨å†Œä¸æŒ‚è½½</a><ul></ul></li><li><a href="#_2">æ–‡ä»¶åˆ›å»ºä¸åˆ é™¤</a><ul></ul></li><li><a href="#_3">ç›®å½•éå†</a><ul></ul></li><li><a href="#_4">æ–‡ä»¶è¯»å†™</a><ul></ul></li><li><a href="#_5">å°ç»“</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>å®ç°ç®€å•æ–‡ä»¶ç³»ç»Ÿ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-05-21
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">æ–‡ä»¶ç³»ç»Ÿæ³¨å†Œä¸æŒ‚è½½</h2>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="n">simplefs_fs_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"simplefs"</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">mount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_mount</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">kill_sb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_kill_sb</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">init_simplefs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simplefs_fs_type</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>è°ƒç”¨register_filesystemæ³¨å†Œä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä¼ å…¥å‚æ•°ä¸ºfile_system_typeç»“æ„ä½“ï¼Œç”¨äºæè¿°æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œå…¶ä¸­nameä¸ºæ–‡ä»¶ç³»ç»Ÿçš„åç§°ï¼Œåœ¨ä½¿ç”¨mount -t xxxæŒ‡å®šæ–‡ä»¶ç³»ç»Ÿç±»å‹æ˜¯å³ä¸ºè¯¥åç§°ï¼Œä½¿ç”¨cat /proc/filesystemså¯ä»¥æŸ¥è¯¢linuxç³»ç»Ÿä¸­æ‰€æœ‰æ³¨å†Œçš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚file_system_typeä¸­mountå’Œkill_sbåˆ†åˆ«å¯¹åº”mountå’Œumountçš„æ“ä½œã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">simplefs_mount</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">dev_name</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mount_nodev</span><span class="p">(</span><span class="n">fs_type</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">simplefs_fill_super</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>åœ¨æ‰§è¡Œmountæ˜¯ä¼šè§¦å‘simplefs_mountè°ƒç”¨ï¼Œè¯¥å‡½æ•°ä¸­è°ƒç”¨mount_nodevæ¥mountä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œmount_nodevè¡¨ç¤ºè¯¥æ–‡ä»¶ç³»ç»Ÿæ²¡æœ‰å¯¹åº”çš„ç£ç›˜ï¼Œå¯¹åº”mount -t xxx none /xxxçš„å‘½ä»¤ï¼Œé€šå¸¸æƒ…å†µä¸‹å¯¹åº”ç›´æ¥ä½¿ç”¨å†…å­˜ä½œä¸ºå­˜å‚¨ç©ºé—´çš„ä½¿ç”¨è¯¥å‡½æ•°æ¥è¿›è¡Œï¼Œç±»ä¼¼çš„è¿˜æœ‰å¦‚tmpfsï¼Œdevfsç­‰ã€‚è€Œå¦‚æœæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ä»‹è´¨å¯¹åº”ç£ç›˜éœ€è°ƒç”¨mount_bdevï¼Œå¯¹åº”å…·ä½“çš„ç£ç›˜è®¾å¤‡ï¼Œå¯¹åº”çš„å‘½ä»¤mount -t ext4 /dev/xxx /xxxå‘½ä»¤ã€‚ â€ƒâ€ƒä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œmount_nodevä¸­å…¶ä¸­é‡è¦çš„å‚æ•°simplefs_fill_superï¼Œåœ¨æ‰§è¡Œmount_nodevä¼šå›è°ƒè¯¥å‡½æ•°ï¼ŒåŸä¹‰ä¸ºç”¨äºå¡«å……è¶…çº§å—å¯¹è±¡ï¼ŒåŒæ—¶åˆ›å»ºæ ¹ç›®å½•çš„inodeä¿¡æ¯ï¼Œå®Œæˆinodeå’Œdentryçš„åˆå§‹åŒ–å…³è”ã€‚åœ¨æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œåœ¨fill_superä¸­å®Œæˆäº†æ ¹ç›®å½•inodeçš„åˆå§‹åŒ–ï¼Œå¡«å……inodeçš„å‡½æ•°æ“ä½œé›†åˆï¼Œåç»­è®¿é—®æ•°æ®æ—¶å°±å¯ä»¥é€šè¿‡è¯¥inodeå‡½æ•°æ“ä½œé›†åˆæ¥å¯¹æ–‡ä»¶è®¿é—®ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">simplefs_fill_super</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="n">sb</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">root_dentry</span><span class="p">;</span>

<span class="w">    </span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_magic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SIMPLEFS_MAGIC_NUMBER</span><span class="p">;</span>

<span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_get_inode</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">S_IFDIR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0755</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">root</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">"get inode failed</span><span class="se">\\</span><span class="s">n"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">root_dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_make_root</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">root_dentry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iput</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">"make root failed</span><span class="se">\\</span><span class="s">n"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root_dentry</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>è°ƒç”¨simplefs_get_inodeè·å–ä¸€ä¸ªæ–°çš„inodeèŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨ç”¨d_make_rootç”Ÿæˆinodeå¯¹åº”çš„dentryï¼Œå†å°†dentryèµ‹å€¼ç»™sb-&gt;s_rootå³å¯å®Œæˆæ ¹ç›®å½•çš„æŒ‚è½½ï¼Œåç»­åˆ‡åˆ°å½“å‰çš„ç›®å½•ï¼Œç›¸åº”çš„æ“ä½œå°±è½¬ä¸ºå½“å‰æ–‡ä»¶ç³»ç»Ÿç±»å‹çš„æ“ä½œã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">simplefs_get_inode</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="n">sb</span><span class="p">,</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">umode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">;</span>

<span class="w">    </span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_inode</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_next_ino</span><span class="p">();</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sb</span><span class="p">;</span>
<span class="w">        </span><span class="n">inode_init_owner</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simplefs_dir_inode_ops</span><span class="p">;</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_time</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">S_IFMT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">S_IFDIR</span><span class="p">:</span>
<span class="w">                </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simplefs_dir_ops</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">S_IFREG</span><span class="p">:</span>
<span class="w">                </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simplefs_file_ops</span><span class="p">;</span>
<span class="w">            </span><span class="k">default</span><span class="o">:</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>ä¸Šé¢æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„inodeç¤ºä¾‹ï¼Œinodeç”¨äºæè¿°ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•ã€‚è°ƒç”¨new_nodeæ¥åˆ†é…ä¸€ä¸ªæ–°çš„inodeï¼Œæ¥ç€å¯¹inodeè¿›è¡ŒåŸºæœ¬çš„åˆå§‹åŒ–ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯å¡«å……inode-&gt;i_opå’Œinode-&gt;i_fopã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode_operations</span><span class="w"> </span><span class="n">simplefs_dir_inode_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">lookup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_lookup</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_create</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">unlink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_unlink</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p>inode-&gt;i_opæ˜¯inodeçš„å‡½æ•°æ“ä½œæ–¹æ³•ï¼Œä¸Šé¢ç¤ºä¾‹lookupç”¨äºæŸ¥æ‰¾dentryæ˜¯å¦å­˜åœ¨ï¼Œdentryæ˜¯å…³äºæ–‡ä»¶è·¯å¾„çš„æè¿°ï¼ŒåŒ…æ‹¬æ–‡ä»¶å’Œç›®å½•ï¼Œé€šè¿‡æŒ‡å®šçš„æ–‡ä»¶è·¯å¾„åè¿›è¡Œæœç´¢æ˜¯å¦å­˜åœ¨æ‰¾åˆ°å¯¹åº”dentryï¼Œdentryä¸­çš„æ•°æ®ç»“æ„å…³è”äº†inodeï¼Œè¿›è€Œå®ç°é€šè¿‡dentryæ‰¾åˆ°å¯¹åº”çš„inodeã€‚createå¯¹åº”çš„æ˜¯æ–‡ä»¶æˆ–ç›®å½•çš„åˆ›å»ºï¼Œunlinkæ˜¯æ–‡ä»¶çš„åˆ é™¤ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="n">simplefs_dir_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">iterate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_iterate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="n">simplefs_file_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_read_file</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_write_file</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p>inode-&gt;i_fopå°±æ˜¯å®é™…å¯¹æ–‡ä»¶çš„æ“ä½œï¼Œä¸struc file-&gt;f_opç›¸å…³è”ã€‚è¿™é‡ŒåŒºåˆ†ç›®å½•å’Œæ–‡ä»¶ï¼Œå¦‚æœinodeæ˜¯ç›®å½•çš„è¯ï¼Œé‚£ä¹ˆç›®å½•å­˜å‚¨çš„æ˜¯ç›®å½•ä¸‹å„ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„ä¿¡æ¯ï¼Œæ‰€ä»¥é‡ç‚¹çš„æ“ä½œå‡½æ•°æ˜¯éå†ç›®å½•å¯¹åº”ä¸Šé¢çš„simplefs_iterateã€‚è€Œinodeæ˜¯æ–‡ä»¶çš„è¯ï¼Œä¸»è¦çš„æ“ä½œå°±æ˜¯å¯¹æ–‡ä»¶å…·ä½“çš„è¯»æˆ–è€…å†™ã€‚</p>
<h2 id="_2">æ–‡ä»¶åˆ›å»ºä¸åˆ é™¤</h2>
<p>åœ¨æ–‡ä»¶ç³»ç»Ÿæ³¨å†Œç« èŠ‚ï¼Œæ‰§è¡Œmountæ–‡ä»¶ç³»ç»Ÿæ“ä½œåï¼Œå›è°ƒäº†å¡«å……superå‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ ¹ç›®å½•ï¼Œåç»­å¯¹åº”æ–‡ä»¶æˆ–ç›®å½•çš„åˆ›å»ºå°±å¯ä»¥åŸºäºè¿™ä¸ªæ ¹ç›®å½•è¿›è¡Œæ‹“å±•ã€‚æ ¹ç›®å½•å¯¹åº”ä¸€ä¸ªinodeï¼Œinodeå¡«å……äº†i_fopæ“ä½œå‡½æ•°ï¼Œå› æ­¤å½“æˆ‘ä»¬åˆ›å»ºæ–‡ä»¶æ—¶ï¼Œå°±ä¼šè°ƒç”¨å¯¹åº”çš„æ“ä½œå‡½æ•°createã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">simplefs_create</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">ns</span><span class="p">,</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">dir</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
<span class="w">               </span><span class="n">umode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">excl</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">simplefs_file</span><span class="w"> </span><span class="o">*</span><span class="n">s_file</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">SIMPLEFS_FILENAME_LEN</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//åˆ†é…ä¸€ä¸ªæ–°çš„inode</span>
<span class="w">    </span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_get_inode</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">"get new inode faild</span><span class="se">\\</span><span class="s">n"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_get_block</span><span class="p">(</span><span class="n">i_block</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">block</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

<span class="w">    </span><span class="n">s_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">simplefs_file</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>

<span class="w">    </span><span class="n">s_file</span><span class="o">-&gt;</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>

<span class="w">    </span><span class="n">s_file</span><span class="o">-&gt;</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>

<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">s_file</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

<span class="w">    </span><span class="n">i_block</span><span class="p">[</span><span class="n">block</span><span class="p">].</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s_file</span><span class="p">;</span>

<span class="w">    </span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_mtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_ctime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_time</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//å°†æ–°åˆ†é…çš„inodeå¡«å……åˆ°å½“å‰ç›®å½•é¡¹</span>
<span class="w">    </span><span class="n">d_instantiate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>crateå…¥å‚å‡½æ•°ä¸­ï¼Œdirä¸ºçˆ¶ç›®å½•çš„inodeï¼Œdentryä¸ºæ–°åˆ›å»ºçš„dentryï¼Œæ²¡æœ‰å…³è”inodeï¼Œéœ€è¦åœ¨è¯¥å‡½æ•°ä¸­æ–°åˆ›å»ºä¸€ä¸ªinodeï¼Œæœ€åè°ƒç”¨d_instantiateä¸æ–°åˆ›å»ºçš„inodeè¿›è¡Œå…³è”ã€‚å› æ­¤åœ¨createæ“ä½œä¸­ï¼Œä¸»è¦çš„å·¥ä½œå°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„inodeï¼Œç„¶åè°ƒç”¨d_instantiateå°†è¿™ä¸ªinodeä¸dentryè¿›è¡Œå…³è”ã€‚dentryåº”è¯¥æ˜¯åœ¨ä¸Šçº§è°ƒç”¨çš„æ—¶å€™å°±åˆ›å»ºäº†ã€‚</p>
<h2 id="_3">ç›®å½•éå†</h2>
<p>å½“æˆ‘ä»¬åœ¨æ‰§è¡Œllæˆ–lså‘½ä»¤çš„æ—¶å€™ï¼Œä¼šåˆ—å‡ºå½“å‰ç›®å½•ä¸‹æœ‰é‚£äº›æ–‡ä»¶æˆ–ç›®å½•ï¼Œè¿™ä¸ªæ“ä½œå°±ä¼šè°ƒç”¨file_operationsä¸­iterateæˆå‘˜å‡½æ•°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">simplefs_iterate</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dir_context</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">simplefs_file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pos</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">SIMPLEFS_BLOCK_SIZE</span><span class="w"> </span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dir_emit_dots</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">))</span><span class="w"> </span><span class="c1">// . ..</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">SIMPLEFS_BLOCK_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pos</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">i_block</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">use</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">simplefs_file</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">i_block</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">dir_emit</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span>
<span class="w">                </span><span class="n">SIMPLEFS_FILENAME_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">DT_UNKNOWN</span><span class="p">))</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œå…³äºiterateçš„å®ç°æœ€å…³é”®çš„æ˜¯è°ƒç”¨dir_emitå°†æ–‡ä»¶åæˆ–æ–‡ä»¶åˆ—åˆ°å±å¹•ä¸Šæ˜¾ç¤ºã€‚</p>
<h2 id="_4">æ–‡ä»¶è¯»å†™</h2>
<p>æ–‡ä»¶çš„è¯»å†™è°ƒç”¨çš„æ˜¯file_operationsä¸­readå’Œwriteå‡½æ•°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">simplefs_write_file</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">,</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_inode</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="o">*</span><span class="n">blk_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">newdatalen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">newdata</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">blk_desc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_get_block</span><span class="p">(</span><span class="n">d_block</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">blk_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">d_block</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">            </span><span class="n">d_block</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">krealloc</span><span class="p">(</span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">newdatalen</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">newdata</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">newdata</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="w">    </span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newdata</span><span class="p">;</span>

<span class="w">    </span><span class="o">*</span><span class="n">ppos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>

<span class="w">    </span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">simplefs_read_file</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">,</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_inode</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="o">*</span><span class="n">blk_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">blk_desc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="s">"%s,%d</span><span class="se">\\</span><span class="s">n"</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">*</span><span class="n">ppos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>

<span class="nl">out</span><span class="p">:</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>è¯»å†™å‡½æ•°å°±æ¯”è¾ƒç®€å•äº†ï¼Œå› ä¸ºæ²¡æœ‰æ“ä½œå…·ä½“çš„ç£ç›˜æ–‡ä»¶ï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨copy_to/from_userä»ç”¨æˆ·ç©ºé—´åˆ°å†…æ ¸ç©ºé—´çš„æ•°æ®æ¬è¿ï¼Œå®é™…çš„æ–‡ä»¶æ“ä½œç³»ç»Ÿä¸­å°¤å…¶æ¶‰åŠç£ç›˜çš„æ“ä½œä¼šå¤æ‚ä¸å°‘ï¼Œä¼šæ¶‰åŠåˆ°page cacheç›¸å…³çš„æ“ä½œï¼Œæœ¬ç« èŠ‚åªæ˜¯ç®€å•ä»‹ç»ä¸‹æ¦‚å¿µæœ‰ä¸ªæ•´ä½“çš„è®¤è¯†ï¼Œåç»­ç« èŠ‚æˆ‘ä»¬ä¼šå…·ä½“å†ä»‹ç»ã€‚</p>
<h2 id="_5">å°ç»“</h2>
<p>æœ€åç¼–è¯‘ç”Ÿæˆkoæ–‡ä»¶åŠ è½½åˆ°å†…æ ¸ä¸­ï¼Œå°±å¯ä»¥æµ‹è¯•äº†ï¼Œä¸‹é¢æ˜¯æµ‹è¯•å‘½ä»¤ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">insmod</span><span class="w"> </span><span class="n">simplefs</span><span class="p">.</span><span class="n">ko</span>
<span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">simplefs</span>
<span class="n">mount</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">simplefs</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">simplefs</span>
<span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">simplefs</span>
<span class="n">touch</span><span class="w"> </span><span class="n">a</span>
<span class="n">echo</span><span class="w"> </span><span class="mi">11111</span><span class="w"> </span><span class="o">&gt;</span><span class="w">  </span><span class="n">a</span>
<span class="n">cat</span><span class="w"> </span><span class="n">a</span>
<span class="n">ll</span>
</code></pre></div>
<p>ä»¥ä¸‹æ˜¯åŸºäºlinux5.15å®Œæ•´çš„æµ‹è¯•ä»£ç :</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/module.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/fs.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/pagemap.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/slab.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/init.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/namei.h&gt;</span>

<span class="cp">#define SIMPLEFS_FILENAME_LEN 255</span>
<span class="cp">#define SIMPLEFS_BLOCK_SIZE 255</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">simplefs_file</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">inode</span><span class="p">;</span>
<span class="w">    </span><span class="n">umode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">filename</span><span class="p">[</span><span class="n">SIMPLEFS_FILENAME_LEN</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">use</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="n">i_block</span><span class="p">[</span><span class="n">SIMPLEFS_BLOCK_SIZE</span><span class="p">];</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="n">d_block</span><span class="p">[</span><span class="n">SIMPLEFS_BLOCK_SIZE</span><span class="p">];</span>

<span class="cp">#define SIMPLEFS_MAGIC_NUMBER 0x13131313</span>

<span class="n">MODULE_IMPORT_NS</span><span class="p">(</span><span class="n">VFS_internal_I_am_really_a_filesystem_and_am_NOT_a_driver</span><span class="p">);</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="n">simplefs_dir_ops</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="n">simplefs_file_ops</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode_operations</span><span class="w"> </span><span class="n">simplefs_dir_inode_ops</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">simplefs_get_block</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="o">*</span><span class="n">blks</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">SIMPLEFS_BLOCK_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">blks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">use</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">blks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">simplefs_get_inode</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="n">sb</span><span class="p">,</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">umode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">;</span>

<span class="w">    </span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_inode</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_next_ino</span><span class="p">();</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sb</span><span class="p">;</span>
<span class="w">        </span><span class="n">inode_init_owner</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simplefs_dir_inode_ops</span><span class="p">;</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_time</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">S_IFMT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">S_IFDIR</span><span class="p">:</span>
<span class="w">                </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simplefs_dir_ops</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">S_IFREG</span><span class="p">:</span>
<span class="w">                </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simplefs_file_ops</span><span class="p">;</span>
<span class="w">            </span><span class="k">default</span><span class="o">:</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">simplefs_create</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">ns</span><span class="p">,</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">dir</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
<span class="w">               </span><span class="n">umode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">excl</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">simplefs_file</span><span class="w"> </span><span class="o">*</span><span class="n">s_file</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">SIMPLEFS_FILENAME_LEN</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">;</span>

<span class="w">    </span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_get_inode</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">"get new inode faild</span><span class="se">\\</span><span class="s">n"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_get_block</span><span class="p">(</span><span class="n">i_block</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">block</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

<span class="w">    </span><span class="n">s_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">simplefs_file</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>

<span class="w">    </span><span class="n">s_file</span><span class="o">-&gt;</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>

<span class="w">    </span><span class="n">s_file</span><span class="o">-&gt;</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>

<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">s_file</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

<span class="w">    </span><span class="n">i_block</span><span class="p">[</span><span class="n">block</span><span class="p">].</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s_file</span><span class="p">;</span>

<span class="w">    </span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_mtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_ctime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_time</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

<span class="w">    </span><span class="n">d_instantiate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">simplefs_unlink</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">dir</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">simplefs_file</span><span class="w"> </span><span class="o">*</span><span class="n">s_file</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="o">*</span><span class="n">blk_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blk_desc</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">kfree</span><span class="p">(</span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">SIMPLEFS_BLOCK_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_block</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">use</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">s_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">simplefs_file</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">i_block</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s_file</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">kfree</span><span class="p">(</span><span class="n">s_file</span><span class="p">);</span>
<span class="w">                </span><span class="n">i_block</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">                </span><span class="n">i_block</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="n">drop_nlink</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">simplefs_lookup</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">parent_inode</span><span class="p">,</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">child_dentry</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">SIMPLEFS_BLOCK_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">simplefs_file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">simplefs_file</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">i_block</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">child_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_get_inode</span><span class="p">(</span><span class="n">parent_inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span>
<span class="w">                    </span><span class="n">parent_inode</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

<span class="w">            </span><span class="n">d_add</span><span class="p">(</span><span class="n">child_dentry</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">);</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">simplefs_read_file</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">,</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_inode</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="o">*</span><span class="n">blk_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">blk_desc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">*</span><span class="n">ppos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>

<span class="nl">out</span><span class="p">:</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">simplefs_write_file</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">,</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_inode</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="o">*</span><span class="n">blk_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blks_desc</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">newdatalen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">newdata</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">blk_desc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_get_block</span><span class="p">(</span><span class="n">d_block</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">blk_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">d_block</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">            </span><span class="n">d_block</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">krealloc</span><span class="p">(</span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">newdatalen</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">newdata</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">newdata</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="w">    </span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newdata</span><span class="p">;</span>

<span class="w">    </span><span class="o">*</span><span class="n">ppos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>

<span class="w">    </span><span class="n">blk_desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">simplefs_iterate</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dir_context</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">simplefs_file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pos</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">SIMPLEFS_BLOCK_SIZE</span><span class="w"> </span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dir_emit_dots</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">))</span><span class="w"> </span><span class="c1">// . ..</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">SIMPLEFS_BLOCK_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pos</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">i_block</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">use</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">simplefs_file</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">i_block</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">dir_emit</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span>
<span class="w">                </span><span class="n">SIMPLEFS_FILENAME_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">DT_UNKNOWN</span><span class="p">))</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">simplefs_fill_super</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="n">sb</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">root_dentry</span><span class="p">;</span>

<span class="w">    </span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_magic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SIMPLEFS_MAGIC_NUMBER</span><span class="p">;</span>

<span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_get_inode</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">S_IFDIR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0755</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">root</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">"get inode failed</span><span class="se">\\</span><span class="s">n"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">root_dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_make_root</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">root_dentry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iput</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">"make root failed</span><span class="se">\\</span><span class="s">n"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root_dentry</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">simplefs_mount</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">dev_name</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mount_nodev</span><span class="p">(</span><span class="n">fs_type</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">simplefs_fill_super</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">simplefs_kill_sb</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">kill_anon_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="n">simplefs_dir_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">iterate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_iterate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="n">simplefs_file_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_read_file</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_write_file</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="n">simplefs_fs_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"simplefs"</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">mount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_mount</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">kill_sb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simplefs_kill_sb</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">init_simplefs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simplefs_fs_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__exit</span><span class="w"> </span><span class="nf">exit_simplefs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">unregister_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simplefs_fs_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_simplefs</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_simplefs</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"Dual BSD/GPL"</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">"Laumy"</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">"a simple file system"</span><span class="p">);</span>
</code></pre></div>
<p>æ›´å®Œå–„çš„æ–‡ä»¶ç³»ç»Ÿç¤ºä¾‹ï¼š<a href="https://github.com/sysprog21/simplefs/tree/master">https://github.com/sysprog21/simplefs/tree/master</a>ï¼Œä¸€ä¸ªç®€å•çš„æ–‡ä»¶ç³»ç»Ÿä¸»è¦å°±æ˜¯å›´ç»•å››å¤§å¯¹è±¡è¿›è¡Œå¡«å……æè¿°ï¼Œè€Œè¶…çº§å—å’Œinodeæ˜¯åŸºç¡€ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_cf158055b8de4a26b4af450e53c5adfa.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/å®ç°ç®€å•æ–‡ä»¶ç³»ç»Ÿ/images/wp_editor_md_cf158055b8de4a26b4af450e53c5adfa.jpg"/></a></p>
<ul>
<li>åˆ†é…è¶…çº§å—ç»“æ„ï¼Œå¡«å……è¶…çº§å—ä¿¡æ¯ã€‚</li>
<li>å®šä¹‰å…·ä½“æ–‡ä»¶ç³»ç»Ÿinodeï¼Œå¦‚struct ext4_inodeã€‚å…¶ä¸­æ¯ä¸ªå…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿinodeä¼šå†…åµŒä¸€ä¸ªVFS inodeï¼Œå…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„inodeåœ¨.alloc_inodeä¸­åˆ†é…ã€‚</li>
<li>å®ç°ç±»å‹æ–‡ä»¶ç³»ç»Ÿinodeçš„æ“ä½œå‡½æ•°é›†åˆï¼ŒåŒ…æ‹¬åˆ›å»ºç›®å½•/æ–‡ä»¶ã€‚</li>
<li>å®ç°fileæ“ä½œå‡½æ•°é›†åˆï¼ŒåŒ…æ‹¬ç›®å½•éå†ï¼Œæ–‡ä»¶çš„è¯»å†™æ“ä½œç­‰ã€‚</li>
<li>å®ç°æ–‡ä»¶ä¸ç£ç›˜çš„æ˜ å°„address spaceæ“ä½œé›†åˆã€‚</li>
</ul></div>
  <div class="post-nav">
    <a class="prev" href="æ–‡ä»¶ç³»ç»Ÿå¸¸è§ç³»ç»Ÿè°ƒç”¨.html">â† æ–‡ä»¶ç³»ç»Ÿå¸¸è§ç³»ç»Ÿè°ƒç”¨</a>
    <a class="next" href="è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ.html">è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

