<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>lerobotå­¦ä¹ ç‡è°ƒåº¦å™¨ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">å­¦ä¹ ç‡è°ƒåº¦å™¨ç®€ä»‹</a><ul><li><a href="#_2">æ˜¯ä»€ä¹ˆ</a></li><li><a href="#_3">æ€ä¹ˆç”¨</a></li></ul></li><li><a href="#lerobot">lerobotè°ƒåº¦å™¨</a><ul><li><a href="#_4">æŠ½è±¡åŸºç±»</a></li><li><a href="#_5">å®ä¾‹åŒ–å­ç±»</a></li><li><a href="#_6">çŠ¶æ€ç®¡ç†</a></li></ul></li><li><a href="#_7">å·¥ç¨‹è°ƒç”¨</a><ul><li><a href="#_8">å‘½ä»¤å‚æ•°</a></li><li><a href="#_9">åˆ›å»º</a></li><li><a href="#_10">æ›´æ–°</a></li><li><a href="#_11">ç»­è®­æ¢å¤</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>lerobotå­¦ä¹ ç‡è°ƒåº¦å™¨</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2025-08-02
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      ai
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">å­¦ä¹ ç‡è°ƒåº¦å™¨ç®€ä»‹</h2>
<h3 id="_2">æ˜¯ä»€ä¹ˆ</h3>
<p>å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼ˆLearning Rate Schedulerï¼‰æ˜¯æ·±åº¦å­¦ä¹ è®­ç»ƒä¸­åŠ¨æ€è°ƒæ•´<strong>ä¼˜åŒ–å™¨å­¦ä¹ ç‡çš„å·¥å…·</strong>ï¼ˆæ³¨æ„æ˜¯åœ¨ä¼˜åŒ–å™¨çš„åŸºç¡€ä¸ŠåŠ¨æ€è°ƒæ•´å­¦ä¹ ç‡ï¼‰ï¼Œé€šè¿‡ä¼˜åŒ–æ”¶æ•›è¿‡ç¨‹æå‡æ¨¡å‹æ€§èƒ½ã€‚</p>
<p>å­¦ä¹ ç‡ï¼ˆÎ·ï¼‰æ§åˆ¶æ¢¯åº¦æ›´æ–°æ­¥é•¿ï¼Œå‚æ•°æ›´æ–°é‡ = -Î· Ã— æ¢¯åº¦ã€‚è¿‡å¤§æ­¥é•¿å¯¼è‡´éœ‡è¡ï¼Œè¿‡å°åˆ™é™·å…¥å±€éƒ¨æœ€ä¼˜æˆ–è®­ç»ƒç¼“æ…¢ï¼Œå›ºå®šå­¦ä¹ ç‡æ˜“å¯¼è‡´è®­ç»ƒåˆæœŸéœ‡è¡æˆ–åæœŸæ”¶æ•›ç¼“æ…¢ï¼Œè°ƒåº¦å™¨åœ¨è®­ç»ƒæœŸé—´è‡ªé€‚åº”è°ƒæ•´åˆæœŸè¾ƒé«˜å­¦ä¹ ç‡åŠ é€Ÿæ”¶æ•›ï¼Œä¸­æœŸç¨³å®šæ¢ç´¢æœ€ä¼˜è§£ï¼ŒåæœŸç²¾ç»†è°ƒä¼˜é¿å…éœ‡è¡ã€‚</p>
<p>ä»¥ä¸‹æ˜¯å¸¸è§çš„å­¦ä¹ ç‡è°ƒåº¦å™¨</p>
<ul>
<li>StepLRï¼šæ¯éš”å›ºå®šepochå°†å­¦ä¹ ç‡ä¹˜ä»¥è¡°å‡å› å­ï¼ˆå¦‚step_size=10, gamma=0.5ï¼‰ã€‚</li>
<li>ExponentialLRï¼šæ¯epochæŒ‰æŒ‡æ•°è¡°å‡ï¼ˆlr = lr Ã— gammaï¼‰ã€‚</li>
<li>CosineAnnealingLRï¼šæŒ‰ä½™å¼¦æ›²çº¿å‘¨æœŸä¸‹é™ï¼šÎ· = Î·_min + 0.5Ã—(Î·_max - Î·_min)Ã—(1 + cos(Ï€Ã—t/T_max))ã€‚</li>
<li>OneCycleLRï¼šåˆ†ä¸¤é˜¶æ®µï¼šçº¿æ€§å‡æ¸©è‡³å³°å€¼ï¼Œå†é€€ç«è‡³æå°å€¼ã€‚</li>
<li>PowerLRï¼šåŸºäºå¹‚å¾‹å…³ç³»è°ƒæ•´ï¼Œä¸æ‰¹æ¬¡å¤§å°å’Œtokenæ•°é‡æ— å…³ã€‚</li>
</ul>
<h3 id="_3">æ€ä¹ˆç”¨</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">from</span> <span class="nn">torch.optim.lr_scheduler</span> <span class="kn">import</span> <span class="n">StepLR</span>

<span class="c1"># 1. å®šä¹‰æ¨¡å‹å’Œä¼˜åŒ–å™¨</span>
<span class="n">model</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># ç¥ç»ç½‘ç»œæ¨¡å‹</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># åˆå§‹å­¦ä¹ ç‡0.1</span>

<span class="c1"># 2. åˆ›å»ºè°ƒåº¦å™¨ï¼ˆç»‘å®šä¼˜åŒ–å™¨ï¼‰</span>
<span class="n">scheduler</span> <span class="o">=</span> <span class="n">StepLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># æ¯30epochè¡°å‡50%</span>

<span class="c1"># 3. è®­ç»ƒå¾ªç¯</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>

    <span class="c1"># å‰å‘ä¼ æ’­ + åå‘ä¼ æ’­</span>
    <span class="n">train</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="c1"># 4. æ›´æ–°å­¦ä¹ ç‡ï¼ˆé€šå¸¸åœ¨epochç»“æŸæ—¶ï¼‰</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="c1"># æŸ¥çœ‹å½“å‰å­¦ä¹ ç‡</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">: LR=</span><span class="si">{</span><span class="n">scheduler</span><span class="o">.</span><span class="n">get_last_lr</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
<p>ä¸Šé¢ä»£ç æ¼”ç¤ºäº†åŸºç¡€çš„å­¦ä¹ ç‡è°ƒåº¦ä½¿ç”¨ç¤ºä¾‹ï¼Œåˆ›å»ºä¸€ä¸ªå­¦ä¹ ç‡è°ƒåº¦å™¨ï¼Œä¼ å…¥çš„å‚æ•°æœ‰ä¼˜åŒ–å™¨ï¼Œä¸»è¦çš„ç›®çš„æ˜¯è®©å­¦ä¹ ç‡è°ƒåº¦å™¨å’Œä¼˜åŒ–å™¨ç»‘å®šï¼Œå› ä¸ºç›¸å½“äºæ˜¯åœ¨ä¼˜åŒ–å™¨çš„åŸºç¡€ä¸Šæ”¹è¿›å­¦ä¹ ç‡è°ƒåº¦ã€‚æ¥ä¸‹æ¥å°±æ˜¯åœ¨å‰å‘ã€åå‘ä¼ æ’­æ›´æ–°å®Œå‚æ•°åè°ƒç”¨scheduler.step()æ›´æ–°å­¦ä¹ ç‡ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡è®¡ç®—ä½¿ç”¨ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">torch.optim.lr_scheduler</span> <span class="kn">import</span> <span class="n">CosineAnnealingLR</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># åŸºç¡€å­¦ä¹ ç‡</span>
<span class="n">total_epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">warmup_epochs</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># é¢„çƒ­epochæ•°</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_epochs</span><span class="p">):</span>
    <span class="c1"># 1. é¢„çƒ­é˜¶æ®µï¼šå‰10epochçº¿æ€§å¢é•¿</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">warmup_epochs</span><span class="p">:</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">/</span> <span class="n">warmup_epochs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">:</span>
            <span class="n">param_group</span><span class="p">[</span><span class="s1">'lr'</span><span class="p">]</span> <span class="o">=</span> <span class="n">lr</span>
    <span class="c1"># 2. ä½™å¼¦é€€ç«é˜¶æ®µ</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scheduler</span> <span class="o">=</span> <span class="n">CosineAnnealingLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">T_max</span><span class="o">=</span><span class="n">total_epochs</span><span class="o">-</span><span class="n">warmup_epochs</span><span class="p">,</span> <span class="n">eta_min</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="c1"># è®­ç»ƒä»£ç åŒä¸Š...</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">: LR=</span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'lr'</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
<p>ä¸Šé¢ä½¿ç”¨çš„æ˜¯ä½™å¼¦é€€ç«+é¢„çƒ­çš„æ–¹å¼ã€‚</p>
<h2 id="lerobot">lerobotè°ƒåº¦å™¨</h2>
<h3 id="_4">æŠ½è±¡åŸºç±»</h3>
<div class="codehilite"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">LRSchedulerConfig</span><span class="p">(</span><span class="n">draccus</span><span class="o">.</span><span class="n">ChoiceRegistry</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="n">num_warmup_steps</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># é¢„çƒ­æ­¥æ•°ï¼ˆæ‰€æœ‰è°ƒåº¦å™¨çš„å…¬å…±å‚æ•°ï¼‰</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_choice_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>  <span class="c1"># è·å–å­ç±»æ³¨å†Œåç§°ï¼ˆå¦‚ "diffuser"ï¼‰</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">:</span> <span class="n">Optimizer</span><span class="p">,</span> <span class="n">num_training_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LRScheduler</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""åˆ›å»ºå­¦ä¹ ç‡è°ƒåº¦å™¨å®ä¾‹"""</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div>
<p>LRSchedulerConfigæ˜¯å­¦ä¹ ç‡è°ƒåº¦å™¨é…ç½®çš„æ ¸å¿ƒæŠ½è±¡ï¼Œé€šè¿‡æŠ½è±¡æ¥å£å®šä¹‰+é…ç½®æ³¨å†Œæœºåˆ¶ï¼Œå®ç°äº†å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥çš„ç»Ÿä¸€ç®¡ç†ä¸çµæ´»æ‰©å±•ã€‚</p>
<p>å…¶åŒæ ·ç»§æ‰¿äº†abc.ABCæ ‡è®°ä¸ºæŠ½è±¡åŸºç±»ï¼Œå¼ºåˆ¶å­ç±»äº‹é¡¹buildæŠ½è±¡æ–¹æ³•ï¼ŒåŒæ—¶ç»§æ‰¿draccus.ChoiceRegistryæä¾›å­ç±»æ³¨å†Œæœºåˆ¶ï¼Œé€šè¿‡ @LRSchedulerConfig.register_subclass("åç§°") å°†å­ç±»ä¸è°ƒåº¦å™¨ç±»å‹ç»‘å®šï¼ˆå¦‚ "diffuser" â†’ DiffuserSchedulerConfigï¼‰ï¼Œæ”¯æŒé…ç½®é©±åŠ¨çš„åŠ¨æ€å®ä¾‹åŒ–ã€‚åŒæ—¶ä½¿ç”¨äº†@dataclass è£…é¥°å™¨è‡ªåŠ¨ç”Ÿæˆæ„é€ å‡½æ•°ã€<strong>repr</strong> ç­‰æ–¹æ³•ï¼Œç®€åŒ–è°ƒåº¦å™¨è¶…å‚æ•°çš„å®šä¹‰ä¸ç®¡ç†ã€‚</p>
<p>å…¶æ ¸å¿ƒå±æ€§åªæœ‰ä¸€ä¸ªnum_warmup_stepsè¡¨ç¤ºå­¦ä¹ ç‡é¢„çƒ­æ­¥æ•°ã€‚é¢„çƒ­æ˜¯æ·±åº¦å­¦ä¹ è®­ç»ƒçš„å¸¸è§æŠ€å·§ï¼ˆå°¤å…¶åœ¨ Transformer ç­‰æ¨¡å‹ä¸­ï¼‰ï¼Œå°†å…¶ä½œä¸ºåŸºç±»å­—æ®µå¯é¿å…å­ç±»é‡å¤å®šä¹‰ã€‚ä¹Ÿæ˜¯å‡ ä¹æ‰€æœ‰å­¦ä¹ ç‡è°ƒåº¦å™¨çš„åŸºç¡€å‚æ•°ï¼Œç”¨äºæ§åˆ¶â€œé¢„çƒ­é˜¶æ®µâ€ï¼ˆå­¦ä¹ ç‡ä»ä½åˆ°é«˜çº¿æ€§å¢é•¿çš„æ­¥æ•°ï¼‰ï¼Œé¿å…è®­ç»ƒåˆæœŸå› é«˜å­¦ä¹ ç‡å¯¼è‡´çš„ä¸ç¨³å®šã€‚</p>
<p>å…¶åªæœ‰ä¸¤ä¸ªæ–¹æ³•typeå’Œbuildï¼Œtypeæ˜¯ç”¨äºè·å–å­ç±»æ³¨å†Œè°ƒåº¦å™¨ç±»å‹åç§°è¿›è€ŒåŒ¹é…åˆ°å¯¹åº”å­ç±»ï¼Œè€Œbuildçš„æ–¹æ³•æ˜¯å¼ºåˆ¶å­ç±»å®ç°ã€‚</p>
<h3 id="_5">å®ä¾‹åŒ–å­ç±»</h3>
<p>lerobotçš„å­¦ä¹ ç‡è°ƒåº¦å®ç°äº†3ä¸ªDiffuserSchedulerConfigã€VQBeTSchedulerConfigã€CosineDecayWithWarmupSchedulerConfigå­ç±»ï¼Œè¿™é‡Œä»¥DiffuserSchedulerConfigç®€å•è¯´æ˜ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@LRSchedulerConfig</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">"diffuser"</span><span class="p">)</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">DiffuserSchedulerConfig</span><span class="p">(</span><span class="n">LRSchedulerConfig</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"cosine"</span>  <span class="c1"># è°ƒåº¦å™¨ç±»å‹ï¼ˆå¦‚ "cosine"ã€"linear"ï¼Œæ¥è‡ª diffusersï¼‰</span>
    <span class="n">num_warmup_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># é¢„çƒ­æ­¥æ•°ï¼ˆå¯é€‰ï¼ŒæœªæŒ‡å®šåˆ™ä¸é¢„çƒ­ï¼‰</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">:</span> <span class="n">Optimizer</span><span class="p">,</span> <span class="n">num_training_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LambdaLR</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">diffusers.optimization</span> <span class="kn">import</span> <span class="n">get_scheduler</span>  <span class="c1"># å¤ç”¨ Diffusers çš„è°ƒåº¦å™¨å®ç°</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s2">"num_training_steps"</span><span class="p">:</span> <span class="n">num_training_steps</span><span class="p">,</span> <span class="s2">"optimizer"</span><span class="p">:</span> <span class="n">optimizer</span><span class="p">}</span> <span class="c1"># æ„é€ è°ƒåº¦å™¨å‚æ•°ï¼šç±»å­—æ®µ + è®­ç»ƒç›¸å…³å‚æ•°</span>
        <span class="k">return</span> <span class="n">get_scheduler</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># è°ƒç”¨ diffusers API åˆ›å»ºè°ƒåº¦å™¨</span>
</code></pre></div>
<p>diffusers.optimization.get_scheduler æ˜¯ Diffusers åº“æä¾›çš„è°ƒåº¦å™¨å·¥å‚å‡½æ•°ï¼Œæ”¯æŒå¤šç§é¢„å®šä¹‰ç­–ç•¥ï¼ˆå¦‚ "cosine"ã€"linear"ã€"constant" ç­‰ï¼‰ã€‚</p>
<p>asdict(self)å°† DiffuserSchedulerConfig å®ä¾‹çš„å­—æ®µï¼ˆå¦‚ name="cosine"ã€num_warmup_steps=1000ï¼‰è½¬æ¢ä¸ºå­—å…¸ï¼›è€Œnum_training_stepsï¼šæ€»è®­ç»ƒæ­¥æ•°ï¼ˆè°ƒåº¦å™¨éœ€åŸºäºæ­¤è®¡ç®—è¡°å‡å‘¨æœŸï¼‰ï¼›æœ€åçš„optimizerå°±æ˜¯å¾…ç»‘å®šçš„ä¼˜åŒ–å™¨å®ä¾‹ï¼ˆè°ƒåº¦å™¨éœ€è°ƒæ•´å…¶å‚æ•°ç»„çš„å­¦ä¹ ç‡ï¼‰ã€‚</p>
<h3 id="_6">çŠ¶æ€ç®¡ç†</h3>
<p><strong>ï¼ˆ1ï¼‰å­˜å‚¨</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">save_scheduler_state</span><span class="p">(</span><span class="n">scheduler</span><span class="p">:</span> <span class="n">LRScheduler</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">state_dict</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>  <span class="c1"># è·å–è°ƒåº¦å™¨çŠ¶æ€ï¼ˆå¦‚å½“å‰ stepã€é¢„çƒ­æ­¥æ•°ç­‰ï¼‰</span>
    <span class="n">write_json</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="n">save_dir</span> <span class="o">/</span> <span class="n">SCHEDULER_STATE</span><span class="p">)</span>  <span class="c1"># ä¿å­˜ä¸º JSON æ–‡ä»¶ï¼ˆå¦‚ "scheduler_state.json"ï¼‰</span>
</code></pre></div>
<p>è¯¥å‡½æ•°ä¸»è¦æ˜¯å°†å­¦ä¹ ç‡è°ƒåº¦å™¨çš„çŠ¶æ€å†™å…¥åˆ°ç£ç›˜ï¼Œä¸ºåç»­æ–­ç‚¹ç»­è®­æä¾›æ”¯æŒã€‚state_dict = scheduler.state_dict()è·å–è°ƒåº¦å™¨çš„å½“å‰çŠ¶æ€å­—å…¸ï¼ŒåŒ…å«è°ƒåº¦å™¨è¿è¡Œæ‰€éœ€çš„æ‰€æœ‰åŠ¨æ€ä¿¡æ¯ã€‚æ¥ç€è°ƒç”¨write_jsonå†™å…¥åˆ°åˆ°æ–‡ä»¶ä¸­ï¼Œæ–‡ä»¶åé»˜è®¤scheduler_state.jsonã€‚</p>
<p><strong>ï¼ˆ2ï¼‰åŠ è½½</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">load_scheduler_state</span><span class="p">(</span><span class="n">scheduler</span><span class="p">:</span> <span class="n">LRScheduler</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LRScheduler</span><span class="p">:</span>
    <span class="c1"># ä» JSON åŠ è½½çŠ¶æ€ï¼Œå¹¶æŒ‰å½“å‰è°ƒåº¦å™¨ç»“æ„é€‚é…ï¼ˆç¡®ä¿å…¼å®¹æ€§ï¼‰</span>
    <span class="n">state_dict</span> <span class="o">=</span> <span class="n">deserialize_json_into_object</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">/</span> <span class="n">SCHEDULER_STATE</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>  <span class="c1"># æ¢å¤çŠ¶æ€</span>
    <span class="k">return</span> <span class="n">scheduler</span>
</code></pre></div>
<p>è¯¥å‡½æ•°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸»è¦è´Ÿè´£ä»ç£ç›˜åŠ è½½ä¹‹å‰ä¿å­˜çš„è°ƒåº¦å™¨çŠ¶æ€ï¼ˆå¦‚å½“å‰è®­ç»ƒæ­¥æ•°ã€å­¦ä¹ ç‡è°ƒæ•´è¿›åº¦ç­‰ï¼‰ï¼Œä½¿è®­ç»ƒèƒ½å¤Ÿä»æ–­ç‚¹å¤„ç»§ç»­ï¼Œç¡®ä¿å­¦ä¹ ç‡è°ƒæ•´ç­–ç•¥çš„è¿ç»­æ€§ã€‚</p>
<h2 id="_7">å·¥ç¨‹è°ƒç”¨</h2>
<h3 id="_8">å‘½ä»¤å‚æ•°</h3>
<p>åœ¨lerobotä¸­ï¼Œå¯åŠ¨è®­ç»ƒæ˜¯å¯ä»¥é€šè¿‡å‚æ•°æ¥å®ä¾‹åŒ–ä½¿ç”¨å“ªäº›è°ƒåº¦å™¨ï¼Œå¦‚ä¸‹ã€‚</p>
<ul>
<li>--scheduler.type=diffuseræŒ‡å®šä½¿ç”¨diffuserè°ƒåº¦ç±»ã€‚</li>
<li>--scheduler.num_warmup_steps=1000æŒ‡å®šé¢„çƒ­æ­¥æ•°ã€‚</li>
<li>--scheduler.num_warmup_steps=0.5æŒ‡å®šä½™å¼¦è¡°å‡å‘¨æœŸã€‚</li>
</ul>
<h3 id="_9">åˆ›å»º</h3>
<p>å·¥ç¨‹ä¸­é€šè¿‡ optim/factory.py ä¸­çš„ make_optimizer_and_scheduler å‡½æ•°ç»Ÿä¸€åˆ›å»ºä¼˜åŒ–å™¨å’Œè°ƒåº¦å™¨ï¼Œå¹¶å®Œæˆä¸¤è€…çš„ç»‘å®šã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">make_optimizer_and_scheduler</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">TrainPipelineConfig</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">PreTrainedPolicy</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Optimizer</span><span class="p">,</span> <span class="n">LRScheduler</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="c1"># 1. åˆ›å»ºä¼˜åŒ–å™¨ï¼ˆåŸºäºä¼˜åŒ–å™¨é…ç½®ï¼Œå¦‚ AdamConfigã€MultiAdamConfigï¼‰</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>  <span class="c1"># policy.parameters() ä¸ºæ¨¡å‹å‚æ•°</span>

    <span class="c1"># 2. åˆ›å»ºè°ƒåº¦å™¨ï¼ˆåŸºäºè°ƒåº¦å™¨é…ç½®ï¼Œå¦‚ DiffuserSchedulerConfigã€VQBeTSchedulerConfigï¼‰</span>
    <span class="c1"># å…³é”®ï¼šé€šè¿‡è°ƒåº¦å™¨é…ç½®çš„ `build` æ–¹æ³•ï¼Œå°†ä¼˜åŒ–å™¨ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå®Œæˆç»‘å®šã€‚</span>
    <span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_scheduler</span>
</code></pre></div>
<ul>
<li>ä¼˜åŒ–å™¨åˆ›å»ºï¼šcfg.optimizer.build(...) æ ¹æ®é…ç½®ç”Ÿæˆä¼˜åŒ–å™¨å®ä¾‹ï¼ˆå¦‚ Adamã€AdamWï¼‰ï¼Œå¹¶å…³è”æ¨¡å‹å‚æ•°ï¼ˆpolicy.parameters()ï¼‰ã€‚</li>
<li>è°ƒåº¦å™¨ç»‘å®šï¼šcfg.scheduler.build(optimizer, cfg.steps) è°ƒç”¨è°ƒåº¦å™¨é…ç½®ç±»ï¼ˆå¦‚ DiffuserSchedulerConfigï¼‰çš„ build æ–¹æ³•ï¼Œå°†ä¼˜åŒ–å™¨å®ä¾‹ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œç”Ÿæˆä¸è¯¥ä¼˜åŒ–å™¨ç»‘å®šçš„è°ƒåº¦å™¨å®ä¾‹ï¼ˆå¦‚ LambdaLRï¼‰</li>
</ul>
<h3 id="_10">æ›´æ–°</h3>
<p>åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¦‚å·¥ç¨‹ scripts/train.py ä¸­ï¼Œè°ƒåº¦å™¨è¢«é›†æˆåˆ°è®­ç»ƒå¾ªç¯ï¼Œé€šè¿‡ scheduler.step() æ›´æ–°å­¦ä¹ ç‡é€šè¿‡è°ƒç”¨scheduler.step() æ›´æ–°å­¦ä¹ ç‡ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">train</span><span class="p">():</span>
    <span class="c1"># ... åˆå§‹åŒ–ä¼˜åŒ–å™¨ã€è°ƒåº¦å™¨ ...</span>
    <span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">make_optimizer_and_scheduler</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_step</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">steps</span><span class="p">):</span>
        <span class="c1"># ... å‰å‘ä¼ æ’­ã€æŸå¤±è®¡ç®—ã€åå‘ä¼ æ’­ ...</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lr_scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>  <span class="c1"># è°ƒç”¨è°ƒåº¦å™¨æ›´æ–°å­¦ä¹ ç‡</span>
</code></pre></div>
<h3 id="_11">ç»­è®­æ¢å¤</h3>
<p>åœ¨æ–­ç‚¹ç»­è®­æ˜¯ï¼Œé€šè¿‡ utils/train_utils.py ä¸­çš„ save_training_state å’Œ load_training_state å‡½æ•°å¤„ç†æ–­ç‚¹ç»­è®­ï¼Œå…¶ä¸­è°ƒç”¨äº† schedulers.py çš„çŠ¶æ€ç®¡ç†å‡½æ•°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">save_training_state</span><span class="p">(</span><span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">:</span> <span class="n">Optimizer</span><span class="p">,</span> <span class="n">lr_scheduler</span><span class="p">:</span> <span class="n">LRScheduler</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
    <span class="c1"># ... ä¿å­˜ä¼˜åŒ–å™¨çŠ¶æ€ ...</span>
    <span class="k">if</span> <span class="n">lr_scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_scheduler_state</span><span class="p">(</span><span class="n">lr_scheduler</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">)</span>  <span class="c1"># è°ƒç”¨ schedulers.py ä¸­çš„ä¿å­˜å‡½æ•°</span>

<span class="k">def</span> <span class="nf">load_training_state</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">:</span> <span class="n">Optimizer</span><span class="p">,</span> <span class="n">lr_scheduler</span><span class="p">:</span> <span class="n">LRScheduler</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1"># ... åŠ è½½ä¼˜åŒ–å™¨çŠ¶æ€ ...</span>
    <span class="k">if</span> <span class="n">lr_scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">load_scheduler_state</span><span class="p">(</span><span class="n">lr_scheduler</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">)</span>  <span class="c1"># è°ƒç”¨ schedulers.py ä¸­çš„åŠ è½½å‡½æ•°</span>
    <span class="k">return</span> <span class="n">step</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_scheduler</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="lerobotç­–ç•¥ä¼˜åŒ–å™¨.html">â† lerobotç­–ç•¥ä¼˜åŒ–å™¨</a>
    <a class="next" href="lerobotè®­ç»ƒ.html">lerobotè®­ç»ƒ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

