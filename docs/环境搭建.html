<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>环境搭建 - Laumy的技术栈</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">首页</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="访问主站">主站点:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#risc-v32">risc-v32入门</a><ul><li><a href="#_1">编译</a></li><li><a href="#objcopy">objcopy</a></li><li><a href="#qemu">qemu运行</a></li><li><a href="#gdb">gdb调试</a></li></ul></li><li><a href="#risc-v64-xuantie">risc-v64 Xuantie</a><ul><li><a href="#_2">下载工具链</a></li><li><a href="#qemu_1">下载qemu</a></li><li><a href="#linux">Linux运行</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>环境搭建</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">🕒</i>
      2024-03-09
    </span>
    <span class="meta-item">
      <i class="icon">📂</i>
      risc-v
    </span>
    <span class="meta-item">
      <i class="icon">👤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="risc-v32">risc-v32入门</h2>
<p>https://github.com/plctlab/riscv-operating-system-mooc/blob/main/README_zh.md</p>
<p>按照上面的进行搭建，工具链和qemu都不用编译，直接解压设置环境变量后可使用，需要注意的是ubuntu使用20.04以上版本。</p>
<p>对于asm下面的code编译方式，需要修改一下Makefile</p>
<div class="codehilite"><pre><span></span><code><span class="o">---</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="k">asm</span><span class="o">/</span><span class="n">add</span><span class="o">/</span><span class="n">Makefile</span>
<span class="o">+++</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="k">asm</span><span class="o">/</span><span class="n">add</span><span class="o">/</span><span class="n">Makefile</span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="err">@@</span>
<span class="o">-</span><span class="p">..</span><span class="o">/</span><span class="n">build</span><span class="p">.</span><span class="n">mk</span>
<span class="o">+</span><span class="n">include</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">build</span><span class="p">.</span><span class="n">mk</span>
</code></pre></div>
<h3 id="_1">编译</h3>
<div class="codehilite"><pre><span></span><code><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">elf</span><span class="o">-</span><span class="n">gcc</span><span class="w"> </span><span class="o">-</span><span class="n">nostdlib</span><span class="w"> </span><span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">builtin</span><span class="w"> </span><span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">rv32g</span><span class="w"> </span><span class="o">-</span><span class="n">mabi</span><span class="o">=</span><span class="n">ilp32</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">Wall</span><span class="w"> </span><span class="n">xxx</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">Ttext</span><span class="o">=</span><span class="mh">0x80000000</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">xxx</span><span class="p">.</span><span class="n">elf</span>

<span class="o">-</span><span class="n">nostdlib</span><span class="err">：</span><span class="n">不链接标准C库</span>
<span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">builtin</span><span class="err">：</span><span class="n">关闭编译器对内置函数的使用</span><span class="err">。</span>
<span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">rv32g</span><span class="err">：</span><span class="n">指定目标架构为</span><span class="w"> </span><span class="n">RISC</span><span class="o">-</span><span class="n">V</span><span class="w"> </span><span class="n">RV32G</span><span class="err">，</span><span class="n">其中</span><span class="w"> </span><span class="err">'</span><span class="n">rv32</span><span class="err">'</span><span class="w"> </span><span class="n">表示</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="n">位指令集宽度</span><span class="err">，</span><span class="sc">'g'</span><span class="w"> </span><span class="n">表示该架构扩展包括通用整数指令集</span><span class="err">（</span><span class="n">I</span><span class="err">）、</span><span class="n">浮点数指令集</span><span class="err">（</span><span class="n">F</span><span class="err">）</span><span class="n">以及乘法累加指令集</span><span class="err">（</span><span class="n">D</span><span class="err">）。</span>
<span class="o">-</span><span class="n">mabi</span><span class="o">=</span><span class="n">ilp32</span><span class="err">：</span><span class="n">设置应用程序二进制接口</span><span class="w"> </span><span class="p">(</span><span class="n">ABI</span><span class="p">)</span><span class="w"> </span><span class="n">为</span><span class="w"> </span><span class="n">ilp32</span><span class="err">，</span><span class="n">即在</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="n">位架构上使用</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="n">位长度的</span><span class="w"> </span><span class="kt">int</span><span class="err">、</span><span class="kt">long</span><span class="w"> </span><span class="n">和指针类型</span><span class="err">。</span>
<span class="o">-</span><span class="n">g</span><span class="err">：</span><span class="n">生成调试信息</span><span class="err">，</span><span class="n">使得编译后的程序可以用</span><span class="w"> </span><span class="n">gdb</span><span class="w"> </span><span class="n">等调试器进行源代码级别的调试</span><span class="err">。</span>
<span class="o">-</span><span class="n">Wall</span><span class="err">：</span><span class="n">开启编译器的所有警告信息</span><span class="err">，</span><span class="n">提高代码质量</span><span class="err">。</span>
<span class="o">-</span><span class="n">Ttext</span><span class="err">：</span><span class="n">指定程序的起始地址或者入口点地址为</span><span class="w"> </span><span class="mh">0x80000000</span><span class="err">。</span><span class="n">这对于裸机程序或嵌入式系统特别重要</span><span class="err">，</span><span class="n">因为它们通常需要在特定地址处加载并开始执行</span><span class="err">。</span>
</code></pre></div>
<h3 id="objcopy">objcopy</h3>
<div class="codehilite"><pre><span></span><code><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">elf</span><span class="o">-</span><span class="n">objcopy</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="n">xx</span><span class="p">.</span><span class="n">elf</span><span class="w"> </span><span class="n">xxx</span><span class="p">.</span><span class="n">bin</span>

<span class="n">objcopy</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="n">这个命令的作用是用来将目标文件</span><span class="err">（</span><span class="n">如ELF格式的可执行文件或对象文件</span><span class="err">）</span><span class="n">转换成纯粹的二进制格式文件</span><span class="err">。</span><span class="n">具体来说</span><span class="err">：</span>

<span class="mf">1.</span><span class="n">去除符号信息</span><span class="err">：</span><span class="n">当执行</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="n">时</span><span class="err">，</span><span class="n">objcopy</span><span class="w"> </span><span class="n">工具会丢弃原始目标文件中的所有符号表信息</span><span class="err">、</span><span class="n">重定位信息以及其他非执行相关的数据</span><span class="err">。</span>

<span class="mf">2.</span><span class="n">生成纯二进制映像</span><span class="err">：</span><span class="n">输出的二进制文件仅包含原始文件中的可执行代码和初始化的数据</span><span class="err">，</span><span class="n">这些数据按照它们在内存中运行时的布局排列</span><span class="err">。</span><span class="n">这样的二进制文件可以直接用于固件烧录</span><span class="err">、</span><span class="n">设备内存加载等场景</span><span class="err">，</span><span class="n">因为它不再需要操作系统提供的加载器来解析额外的元数据</span><span class="err">。</span>

<span class="mf">3.</span><span class="n">简化部署</span><span class="err">：</span><span class="n">对于嵌入式系统或其他资源受限的环境</span><span class="err">，</span><span class="n">这种转换有助于创建一个单一的</span><span class="err">、</span><span class="n">最小化的二进制镜像</span><span class="err">，</span><span class="n">可以直接写入闪存或其他存储介质</span><span class="err">，</span><span class="n">并从特定地址启动执行</span><span class="err">。</span>

<span class="n">举例来说</span><span class="err">，</span><span class="n">命令</span><span class="w"> </span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">objcopy</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="n">source</span><span class="p">.</span><span class="n">elf</span><span class="w"> </span><span class="n">destination</span><span class="p">.</span><span class="n">bin</span><span class="w"> </span><span class="n">将会把</span><span class="w"> </span><span class="n">source</span><span class="p">.</span><span class="n">elf</span><span class="w"> </span><span class="n">文件转换成名为</span><span class="w"> </span><span class="n">destination</span><span class="p">.</span><span class="n">bin</span><span class="w"> </span><span class="n">的纯二进制文件</span><span class="err">，</span><span class="n">适合于在没有操作系统的微处理器上直接运行或用于硬件编程</span><span class="err">。</span>
</code></pre></div>
<h3 id="qemu">qemu运行</h3>
<ul>
<li>qume:是一个支持跨平台虚拟化的虚拟机，有 user mode 和 system mode 两种配置方式。其中qemu 在system mode配置下模拟出整个计算机，可以在qemu之上运行一个操作系统,如linux系统。qemu 的system mode与常见的VMware和Virtualbox等虚拟机比较相似，但是qemu 的优势是可以跨指令集。例如，VMware和Virtualbox之类的工具通常只能在x86计算机上虚拟出一个x86计算机，而qemu 支持在x86上虚拟出一个ARM计算机。qemu在user mode配置下，可以运行跟当前平台指令集不同的平台可执行程序。例如可以用qemu在x86上运行ARM的可执行程序，但是两个平台必须是同一种操作系统，比如Linux。</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">riscv32</span><span class="w"> </span><span class="o">-</span><span class="n">nographic</span><span class="w"> </span><span class="o">-</span><span class="n">smp</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">machine</span><span class="w"> </span><span class="n">virt</span><span class="w"> </span><span class="o">-</span><span class="n">bios</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="o">-</span><span class="n">kernel</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">xxx</span><span class="p">.</span><span class="n">elf</span>

<span class="o">-</span><span class="n">nographic</span><span class="err">：</span><span class="n">这个选项指示</span><span class="w"> </span><span class="n">QEMU</span><span class="w"> </span><span class="n">在没有图形界面的情况下运行</span><span class="err">，</span><span class="n">也就是说</span><span class="err">，</span><span class="n">不打开</span><span class="w"> </span><span class="n">VGA</span><span class="w"> </span><span class="n">显示设备</span><span class="err">，</span><span class="n">所有的输出将会直接在控制台显示</span><span class="err">。</span><span class="n">对于嵌入式开发或者远程服务器部署非常有用</span><span class="err">。</span>
<span class="o">-</span><span class="n">smp</span><span class="w"> </span><span class="mi">1</span><span class="err">：</span><span class="n">定义虚拟机中的</span><span class="w"> </span><span class="n">CPU</span><span class="w"> </span><span class="n">核心数量为</span><span class="w"> </span><span class="mi">1</span><span class="err">。</span><span class="n">这意味着模拟的</span><span class="w"> </span><span class="n">RISC</span><span class="o">-</span><span class="n">V</span><span class="w"> </span><span class="n">系统将只有一个核心</span><span class="err">。</span>
<span class="o">-</span><span class="n">machine</span><span class="w"> </span><span class="n">virt</span><span class="err">：</span><span class="n">指定使用的虚拟机模型为</span><span class="w"> </span><span class="n">virt</span><span class="err">。</span><span class="n">这是</span><span class="w"> </span><span class="n">QEMU</span><span class="w"> </span><span class="n">提供的一个通用的</span><span class="err">、</span><span class="n">基于硬件的</span><span class="w"> </span><span class="n">RISC</span><span class="o">-</span><span class="n">V</span><span class="w"> </span><span class="n">虚拟机模型</span><span class="err">，</span><span class="n">适合于开发和测试目的</span><span class="err">。</span>
<span class="o">-</span><span class="n">bios</span><span class="w"> </span><span class="n">none</span><span class="err">：</span><span class="n">表示不使用任何固件</span><span class="err">（</span><span class="n">如</span><span class="w"> </span><span class="n">UEFI</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">OpenSBI</span><span class="err">）。</span><span class="n">在某些情况下</span><span class="err">，</span><span class="n">尤其是对于裸机环境或者自定义引导过程</span><span class="err">，</span><span class="n">不需要</span><span class="w"> </span><span class="n">BIOS</span><span class="w"> </span><span class="n">或者其他固件来启动系统</span><span class="err">。</span>
<span class="o">-</span><span class="n">kernel</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">xxx</span><span class="p">.</span><span class="n">elf</span><span class="err">：</span><span class="n">参数后面跟的是要加载作为虚拟机启动镜像的</span><span class="w"> </span><span class="n">ELF</span><span class="w"> </span><span class="n">文件的路径</span><span class="err">，</span><span class="n">这里是指向名为</span><span class="w"> </span><span class="n">xxx</span><span class="p">.</span><span class="n">elf</span><span class="w"> </span><span class="n">的文件</span><span class="err">。</span><span class="n">此</span><span class="w"> </span><span class="n">ELF</span><span class="w"> </span><span class="n">文件通常包含了已经编译好的操作系统内核或者是可以直接执行的裸机程序</span><span class="err">。</span><span class="n">会解析elf的入口地址</span><span class="err">，</span><span class="n">将其加载到对应的dram地址上</span><span class="err">。</span><span class="n">后续由bios执行结束后进行跳转</span><span class="err">，</span><span class="n">所以kernel的elf入口地址要与bios跳转地址一致</span><span class="err">，</span><span class="n">否则启动不了</span><span class="err">。</span>
</code></pre></div>
<h3 id="gdb">gdb调试</h3>
<ul>
<li>gdb-multiarch：是一个经过交叉编译后的、支持多架构版本的 gdb。</li>
</ul>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/04/wp_editor_md_60883b69c14032bcd5645c6f597d216b.jpg"><img alt="" src="assets/doc/02-risc-v/环境搭建/images/wp_editor_md_60883b69c14032bcd5645c6f597d216b.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">riscv32</span><span class="w"> </span><span class="o">-</span><span class="n">kernel</span><span class="w"> </span><span class="n">xxx</span><span class="p">.</span><span class="n">elf</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="o">&amp;</span>

<span class="o">-</span><span class="n">s</span><span class="o">:</span><span class="w"> </span><span class="err">“</span><span class="o">-</span><span class="n">gdb</span><span class="w"> </span><span class="n">tcp</span><span class="o">::</span><span class="mi">1234</span><span class="err">”</span><span class="w"> </span><span class="n">的缩写</span><span class="err">，</span><span class="n">启动</span><span class="w"> </span><span class="n">gdbserver</span><span class="w"> </span><span class="n">并在</span><span class="w"> </span><span class="mi">1234</span><span class="w"> </span><span class="n">端口号上监听客户端</span>
<span class="o">-</span><span class="n">S</span><span class="o">:</span><span class="w"> </span><span class="n">在启动时停止CPU</span><span class="w"> </span><span class="p">(</span><span class="n">只有到在客户端键入</span><span class="sc">'c'</span><span class="w"> </span><span class="n">才会开</span><span class="w"> </span><span class="n">始执行</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">gdb</span><span class="o">-</span><span class="n">multiarch</span><span class="w"> </span><span class="n">xxx</span><span class="p">.</span><span class="n">elf</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="n">gdbinit</span>

<span class="o">-</span><span class="n">q</span><span class="err">：</span><span class="w"> </span><span class="n">这是一个静默模式选项</span><span class="err">，</span><span class="n">表示在启动</span><span class="w"> </span><span class="n">GDB</span><span class="w"> </span><span class="n">时不打印欢迎信息和其他一些非关键信息</span><span class="err">，</span><span class="n">使得启动过程更简洁</span><span class="err">。</span>

<span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="n">gdbinit</span><span class="err">：</span><span class="w"> </span><span class="n">使用</span><span class="w"> </span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="n">选项可以让</span><span class="w"> </span><span class="n">GDB</span><span class="w"> </span><span class="n">加载并执行指定文件中的命令序列</span><span class="err">。</span><span class="n">这里是指定了</span><span class="w"> </span><span class="n">gdbinit</span><span class="w"> </span><span class="n">文件</span><span class="err">。</span><span class="n">在</span><span class="w"> </span><span class="n">gdbinit</span><span class="w"> </span><span class="n">文件中</span><span class="err">，</span><span class="n">你可以预先编写一系列的</span><span class="w"> </span><span class="n">GDB</span><span class="w"> </span><span class="n">自动化命令</span><span class="err">，</span><span class="n">比如设置断点</span><span class="err">、</span><span class="n">加载符号表</span><span class="err">、</span><span class="n">配置工作目录等</span><span class="err">，</span><span class="n">在</span><span class="w"> </span><span class="n">GDB</span><span class="w"> </span><span class="n">启动时自动执行</span><span class="err">，</span><span class="n">从而提升调试效率和一致性</span><span class="err">。</span>

<span class="n">gdbinit</span><span class="w"> </span><span class="n">内容如下</span><span class="err">：</span>

<span class="n">display</span><span class="o">/</span><span class="n">z</span><span class="w"> </span><span class="n">$x5</span>
<span class="n">display</span><span class="o">/</span><span class="n">z</span><span class="w"> </span><span class="n">$x6</span>
<span class="n">display</span><span class="o">/</span><span class="n">z</span><span class="w"> </span><span class="n">$x7</span>

<span class="n">set</span><span class="w"> </span><span class="n">disassemble</span><span class="o">-</span><span class="n">next</span><span class="o">-</span><span class="n">line</span><span class="w"> </span><span class="n">on</span>
<span class="n">b</span><span class="w"> </span><span class="n">_start</span>
<span class="n">target</span><span class="w"> </span><span class="n">remote</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1234</span>
<span class="n">c</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="n">启动与退出</span>

<span class="n">gdb</span><span class="w"> </span><span class="p">[</span><span class="n">program</span><span class="p">]</span><span class="err">：</span><span class="n">启动GDB并调试指定的程序</span><span class="err">。</span>
<span class="n">quit</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">q</span><span class="err">：</span><span class="n">退出GDB调试器</span><span class="err">。</span>

<span class="mf">2.</span><span class="n">运行与控制</span>

<span class="n">run</span><span class="w"> </span><span class="p">[</span><span class="n">args</span><span class="p">]</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">[</span><span class="n">args</span><span class="p">]</span><span class="err">：</span><span class="n">运行程序</span><span class="err">，</span><span class="n">可以传递命令行参数</span><span class="err">。</span>
<span class="n">start</span><span class="err">：</span><span class="n">从程序的第一行开始单步执行</span><span class="err">。</span>
<span class="k">continue</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">c</span><span class="err">：</span><span class="n">继续执行至下一个断点或程序结束</span><span class="err">。</span>
<span class="n">next</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">n</span><span class="err">：</span><span class="n">单步执行</span><span class="err">，</span><span class="n">不进入函数内部</span><span class="err">。</span>
<span class="n">nexti或ni</span><span class="err">：</span><span class="n">以机器指令为单位进行单步执行</span><span class="err">，</span><span class="n">不进入函数内部</span>

<span class="n">step</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">s</span><span class="err">：</span><span class="n">单步执行</span><span class="err">，</span><span class="n">进入函数内部</span><span class="err">。</span>
<span class="n">stepi或si</span><span class="err">：</span><span class="n">以机器指令为单位进行单步执行</span><span class="err">，</span><span class="n">遇到函数调用会进入函数内部</span>

<span class="n">finish</span><span class="err">：</span><span class="n">执行到当前函数返回为止</span><span class="err">。</span>

<span class="mf">3.</span><span class="n">查看源代码</span>

<span class="n">list</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="p">[</span><span class="n">line</span><span class="w"> </span><span class="n">number</span><span class="o">/</span><span class="n">function</span><span class="w"> </span><span class="n">name</span><span class="p">]</span><span class="err">：</span><span class="n">显示源代码列表</span><span class="err">，</span><span class="n">默认显示当前行及其周围的代码</span><span class="err">。</span>

<span class="mf">4.</span><span class="n">断点管理</span>

<span class="k">break</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">[</span><span class="n">location</span><span class="p">]</span><span class="err">：</span><span class="n">在指定位置设置断点</span><span class="err">。</span><span class="n">如b</span><span class="w"> </span><span class="n">a</span><span class="o">==</span><span class="mi">2</span><span class="n">或b</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">22</span><span class="n">或b</span><span class="w"> </span><span class="n">func</span>
<span class="n">delete</span><span class="w"> </span><span class="p">[</span><span class="n">breakpoint</span><span class="w"> </span><span class="n">number</span><span class="p">]</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="p">[</span><span class="n">number</span><span class="p">]</span><span class="err">：</span><span class="n">删除指定编号的断点</span><span class="err">。</span>
<span class="n">clear</span><span class="w"> </span><span class="p">[</span><span class="n">location</span><span class="p">]</span><span class="err">：</span><span class="n">清除在特定位置的断点</span><span class="err">。</span>
<span class="n">info</span><span class="w"> </span><span class="n">breakpoints</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">b</span><span class="err">：</span><span class="n">列出所有已设置的断点信息</span><span class="err">。</span>

<span class="mf">5.</span><span class="n">查看</span>
<span class="n">layout</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="n">可以查看所有的汇编代码</span>
<span class="n">layout</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="n">查看源代码</span><span class="err">，</span><span class="n">使用ctrl</span><span class="o">+</span><span class="n">x</span><span class="err">，</span><span class="n">再a</span><span class="err">，</span><span class="n">会到传统模式</span>
<span class="n">display</span><span class="w"> </span><span class="p">[</span><span class="n">expression</span><span class="p">]</span><span class="err">：</span><span class="n">动态监视表达式</span><span class="err">，</span><span class="n">在每次停止时自动显示其值</span><span class="err">。</span>
<span class="n">info</span><span class="w"> </span><span class="n">reg</span><span class="err">：</span><span class="n">查看所有寄存器</span>
<span class="n">print</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">[</span><span class="n">expression</span><span class="p">]</span><span class="err">：</span><span class="n">打印变量或表达式的值</span><span class="err">。</span><span class="n">可以查看具体代码变量的值</span><span class="err">，</span><span class="n">如p</span><span class="w"> </span><span class="n">pxCurrentTCB</span><span class="o">-&gt;</span><span class="n">name</span><span class="err">。</span><span class="n">另外p还支持打印的格式</span><span class="o">/</span><span class="n">x来表示格式</span><span class="err">，</span><span class="n">p</span><span class="o">/</span><span class="n">x</span><span class="w"> </span><span class="n">$reg</span><span class="err">：</span><span class="n">查看某个寄存器</span><span class="err">，</span><span class="n">如p</span><span class="o">/</span><span class="n">x</span><span class="w"> </span><span class="n">$a5</span>

<span class="mf">6.</span><span class="n">栈回溯</span>

<span class="n">backtrace</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">bt</span><span class="err">：</span><span class="n">显示当前调用栈的所有帧</span><span class="err">。</span>
<span class="mf">7.</span><span class="n">线程调试</span>

<span class="kr">thread</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">t</span><span class="err">：</span><span class="n">切换到指定线程</span><span class="err">。</span>
<span class="n">info</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">t</span><span class="err">：</span><span class="n">查看当前进程中所有线程的信息</span><span class="err">。</span>
<span class="mf">8.</span><span class="n">附加进程</span>

<span class="n">attach</span><span class="w"> </span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="err">：</span><span class="n">附加到一个正在运行的进程进行调试</span><span class="err">。</span>
<span class="mf">9.</span><span class="n">信号处理</span>

<span class="n">handle</span><span class="w"> </span><span class="n">signal</span><span class="err">：</span><span class="n">设置当GDB接收到特定信号时的行为</span><span class="err">。</span>
<span class="mf">10.</span><span class="n">读取内存</span>

<span class="n">x</span><span class="o">/&lt;</span><span class="n">count</span><span class="o">&gt;/&lt;</span><span class="n">format</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="err">：</span><span class="n">查看内存内容</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">count</span><span class="o">&gt;</span><span class="err">：</span><span class="n">你要查看的内存单元的数量</span><span class="err">。</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">format</span><span class="o">&gt;</span><span class="err">：</span><span class="n">内存单元的显示格式</span><span class="err">，</span><span class="n">可以是</span><span class="err">：</span>
<span class="w">    </span><span class="n">b</span><span class="err">（</span><span class="n">byte</span><span class="err">，</span><span class="n">字节</span><span class="err">），</span>
<span class="w">    </span><span class="n">h</span><span class="err">（</span><span class="n">halfword</span><span class="err">，</span><span class="n">半字</span><span class="err">，</span><span class="n">对于RISC</span><span class="o">-</span><span class="n">V通常是16位</span><span class="err">），</span>
<span class="w">    </span><span class="n">w</span><span class="err">（</span><span class="n">word</span><span class="err">，</span><span class="n">字</span><span class="err">，</span><span class="n">对于RISC</span><span class="o">-</span><span class="n">V通常是32位</span><span class="err">），</span>
<span class="w">    </span><span class="n">g</span><span class="err">（</span><span class="n">giant</span><span class="err">，</span><span class="n">巨字</span><span class="err">，</span><span class="n">对于RISC</span><span class="o">-</span><span class="n">V通常是64位</span><span class="err">）</span><span class="n">等</span><span class="err">。</span>
<span class="w"> </span><span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="err">：</span><span class="n">你要查看的内存地址</span><span class="err">，</span><span class="n">可以是具体的内存地址数值</span><span class="err">，</span><span class="n">也可以是变量的地址</span><span class="err">，</span><span class="n">如</span><span class="o">&amp;</span><span class="n">myVar</span><span class="err">。</span>
<span class="w"> </span><span class="n">示例</span><span class="err">：</span><span class="n">x</span><span class="o">/</span><span class="mi">6</span><span class="n">xw</span><span class="w"> </span><span class="mi">0</span><span class="n">x地址</span><span class="err">；</span><span class="n">表示查看</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">个单元</span><span class="err">，</span><span class="n">每个单元是w</span><span class="err">（</span><span class="mi">4</span><span class="n">字节</span><span class="err">），</span>

<span class="mf">11.</span><span class="n">其他</span>

<span class="n">set</span><span class="w"> </span><span class="n">args</span><span class="err">：</span><span class="n">设置下次运行时传递给程序的命令行参数</span><span class="err">。</span>
<span class="n">show</span><span class="w"> </span><span class="n">args</span><span class="err">：</span><span class="n">查看当前设置的程序运行参数</span><span class="err">。</span>
<span class="n">file</span><span class="w"> </span><span class="p">[</span><span class="n">executable</span><span class="p">]</span><span class="err">：</span><span class="n">加载新的可执行文件进行调试</span><span class="err">。</span>
<span class="n">help</span><span class="w"> </span><span class="p">[</span><span class="n">command</span><span class="p">]</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="p">[</span><span class="n">command</span><span class="p">]</span><span class="err">：</span><span class="n">查看GDB中某个命令的帮助信息</span><span class="err">。</span>

<span class="n">示例</span>

<span class="n">display</span><span class="o">/</span><span class="n">z</span><span class="w"> </span><span class="n">$x5</span><span class="err">：</span><span class="w"> </span><span class="n">此命令设置了一个动态观察点</span><span class="err">，</span><span class="n">每当程序停止时</span><span class="err">，</span><span class="n">GDB都会显示寄存器</span><span class="w"> </span><span class="n">$x5</span><span class="w"> </span><span class="n">的内容</span><span class="err">，</span><span class="n">且以十六进制</span><span class="err">（</span><span class="n">z</span><span class="err">）</span><span class="n">格式显示</span><span class="err">。</span><span class="n">在RISC</span><span class="o">-</span><span class="n">V架构中</span><span class="err">，</span><span class="n">$x5</span><span class="w"> </span><span class="n">是其中一个通用寄存器</span><span class="err">。</span>

<span class="n">display</span><span class="o">/</span><span class="n">z</span><span class="w"> </span><span class="n">$x6</span><span class="err">：</span><span class="w"> </span><span class="n">类似于上面的命令</span><span class="err">，</span><span class="n">但它关注的是</span><span class="w"> </span><span class="n">$x6</span><span class="w"> </span><span class="n">寄存器的值</span><span class="err">。</span>

<span class="n">display</span><span class="o">/</span><span class="n">z</span><span class="w"> </span><span class="n">$x7</span><span class="err">：</span><span class="w"> </span><span class="n">同样</span><span class="err">，</span><span class="n">设置了一个动态观察点来显示</span><span class="w"> </span><span class="n">$x7</span><span class="w"> </span><span class="n">寄存器的内容</span><span class="err">。</span>

<span class="n">set</span><span class="w"> </span><span class="n">disassemble</span><span class="o">-</span><span class="n">next</span><span class="o">-</span><span class="n">line</span><span class="w"> </span><span class="n">on</span><span class="err">：</span><span class="w"> </span><span class="n">当执行</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="n">命令时</span><span class="err">，</span><span class="n">开启反汇编下一行代码的功能</span><span class="err">。</span><span class="n">这样在单步执行时</span><span class="err">，</span><span class="n">除了看到源代码</span><span class="err">，</span><span class="n">还会显示对应的汇编指令</span><span class="err">。</span>

<span class="n">b</span><span class="w"> </span><span class="n">_start</span><span class="err">：</span><span class="w"> </span><span class="n">在</span><span class="w"> </span><span class="n">_start</span><span class="w"> </span><span class="n">函数处设置一个断点</span><span class="err">，</span><span class="n">这是许多嵌入式或操作系统内核启动时的第一个入口点</span><span class="err">。</span>

<span class="n">target</span><span class="w"> </span><span class="n">remote</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1234</span><span class="err">：</span><span class="w"> </span><span class="n">这个命令告诉</span><span class="w"> </span><span class="n">GDB</span><span class="w"> </span><span class="n">与远程目标通信</span><span class="err">，</span><span class="n">并连接到本地主机的1234端口</span><span class="err">。</span><span class="n">在这种情况下</span><span class="err">，</span><span class="n">通常是通过QEMU模拟器运行的RISC</span><span class="o">-</span><span class="n">V系统</span><span class="err">，</span><span class="n">QEMU开启GDB服务器监听这个端口</span><span class="err">。</span>

<span class="n">c</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="k">continue</span><span class="err">：</span><span class="w"> </span><span class="n">继续执行程序直至遇到断点</span><span class="err">（</span><span class="n">在这里是</span><span class="w"> </span><span class="n">_start</span><span class="w"> </span><span class="n">函数</span><span class="err">），</span><span class="n">或者如果没有断点</span><span class="err">，</span><span class="n">则一直执行到程序结束</span><span class="err">。</span><span class="n">如果之前已经建立了与远程目标的连接</span><span class="err">，</span><span class="n">那么GDB将控制远程系统的执行</span><span class="err">。</span>

<span class="n">总结起来</span><span class="err">，</span><span class="n">这一系列命令首先设置了对几个寄存器的监控</span><span class="err">，</span><span class="n">然后开启了单步执行时显示下一行汇编代码的功能</span><span class="err">，</span><span class="n">接着在</span><span class="w"> </span><span class="n">_start</span><span class="w"> </span><span class="n">函数处设断点</span><span class="err">，</span><span class="n">最后连接到远程目标并继续执行程序</span><span class="err">。</span><span class="n">在整个过程中</span><span class="err">，</span><span class="n">GDB将根据设置实时展示相关寄存器的值和程序执行状态</span><span class="err">。</span>

<span class="n">总结常用命令</span><span class="err">：</span>
<span class="n">layout</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="k">asm</span><span class="p">,</span><span class="w"> </span><span class="n">ctrl</span><span class="o">+</span><span class="n">x</span><span class="w"> </span><span class="n">a退出</span>
<span class="n">i</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="n">查看断点</span><span class="err">，</span><span class="n">可以b</span><span class="w"> </span><span class="n">函数名补全打断点</span>
<span class="n">n</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="err">：</span><span class="n">不进入函数内部单步执行</span>
<span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="err">：</span><span class="n">进入函数内部单步执行</span>
<span class="nl">p</span><span class="p">:</span><span class="n">查看变量信息</span><span class="err">，</span><span class="n">可以配合</span><span class="o">/</span><span class="p">....</span><span class="n">使用</span>
<span class="n">display</span><span class="o">/</span><span class="n">z</span><span class="w"> </span><span class="n">$X1</span><span class="o">:</span><span class="n">动态监控寄存器</span>
<span class="n">set</span><span class="w"> </span><span class="n">disassemble</span><span class="o">-</span><span class="n">next</span><span class="o">-</span><span class="n">line</span><span class="w"> </span><span class="n">on</span>
</code></pre></div>
<h2 id="risc-v64-xuantie">risc-v64 Xuantie</h2>
<p>这里使用的是玄铁编译好的工具链，也是下载直接解压，设置环境变量即可。</p>
<h3 id="_2">下载工具链</h3>
<p><a href="https://www.xrvm.cn/community/download?id=4267734522939904000">https://www.xrvm.cn/community/download?id=4267734522939904000</a></p>
<p>下载的版本：Xuantie-900-gcc-linux-5.10.4-glibc-x86_64-V2.8.1-20240115.tar.gz</p>
<h3 id="qemu_1">下载qemu</h3>
<p><a href="https://www.xrvm.cn/community/download?id=4238019891233361920">https://www.xrvm.cn/community/download?id=4238019891233361920</a></p>
<p>下载的版本：XuanTie-DebugServer-linux-x86_64-V5.18.0-20230926.sh.tar.gz</p>
<p>执行qemu可能会少一些库，缺少就网上搜索一下，使用apt-get install xxx安装。</p>
<p>不带系统的测试例子：<a href="https://github.com/rvboards/test_c920">https://github.com/rvboards/test_c920</a></p>
<h3 id="linux">Linux运行</h3>
<p>下载镜像（这里下载的版本920v2_images.tar.gz）：<a href="https://github.com/c-sky/buildroot/releases">https://github.com/c-sky/buildroot/releases</a></p>
<p>执行下面命令启动</p>
<div class="codehilite"><pre><span></span><code><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">riscv64</span><span class="w"> </span><span class="err">\</span>\
<span class="o">-</span><span class="n">M</span><span class="w"> </span><span class="n">virt</span><span class="w"> </span><span class="err">\</span>\
<span class="o">-</span><span class="n">cpu</span><span class="w"> </span><span class="n">c910v</span><span class="w"> </span><span class="err">\</span>\
<span class="o">-</span><span class="n">bios</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">fw_jump</span><span class="p">.</span><span class="n">bin</span><span class="w"> </span><span class="err">\</span>\
<span class="o">-</span><span class="n">kernel</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">Image</span><span class="w"> </span><span class="err">\</span>\
<span class="o">-</span><span class="n">append</span><span class="w"> </span><span class="s">"rootwait root=/dev/vda ro"</span><span class="w"> </span><span class="err">\</span>\
<span class="o">-</span><span class="n">drive</span><span class="w"> </span><span class="n">file</span><span class="o">=</span><span class="p">.</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">rootfs</span><span class="p">.</span><span class="n">ext2</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">hd0</span><span class="w"> </span><span class="err">\</span>\
<span class="o">-</span><span class="n">device</span><span class="w"> </span><span class="n">virtio</span><span class="o">-</span><span class="n">blk</span><span class="o">-</span><span class="n">device</span><span class="p">,</span><span class="n">drive</span><span class="o">=</span><span class="n">hd0</span><span class="w"> </span><span class="err">\</span>\
<span class="o">-</span><span class="n">nographic</span><span class="w"> </span><span class="o">-</span><span class="n">smp</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<ul>
<li>-M virt: 指定虚拟机使用 virt 平台。</li>
<li>-cpu c910v: 指定虚拟机使用 c910v CPU 模型。</li>
<li>-bios ./images/fw_jump.bin: 系统引导程序，opensbi。</li>
<li>-kernel ./images/Image: 指定使用指定路径下的 Image 文件作为内核镜像。</li>
<li>-append \"rootwait root=/dev/vda ro\": 设置内核启动参数，包括等待根文件系统、根文件系统路径为 /dev/vda、以只读模式挂载根文件系统。</li>
<li>-drive file=./images/rootfs.ext2,format=raw,id=hd0: 挂载名为 hd0 的硬盘设备，使用指定路径下的 rootfs.ext2 文件作为硬盘镜像，格式为 raw。</li>
<li>-device virtio-blk-device,drive=hd0: 添加一个 virtio 块设备，并将其连接到 hd0 硬盘。</li>
<li>-nographic: 在无图形界面的模式下运行虚拟机。</li>
<li>-smp 1: 设置虚拟机的 CPU 为单核。</li>
</ul></div>
  <div class="post-nav">
    <a class="prev" href="html-css学习随记.html">← HTML+CSS学习随记</a>
    <a class="next" href="麦肯锡意识.html">麦肯锡意识 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

