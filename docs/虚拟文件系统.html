<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">å››å¤§å¯¹è±¡æ•°æ®ç»“æ„</a><ul><li><a href="#_2">è¶…çº§å—å¯¹è±¡</a></li><li><a href="#_3">ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡</a></li><li><a href="#_4">ç›®å½•é¡¹å¯¹è±¡</a></li><li><a href="#_5">æ–‡ä»¶å¯¹è±¡</a></li></ul></li><li><a href="#_6">å…¶ä»–æ•°æ®ç»“æ„</a><ul><li><a href="#_7">æ–‡ä»¶ç³»ç»Ÿç±»å‹</a></li><li><a href="#_8">æ–‡ä»¶ç³»ç»ŸæŒ‚è½½</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-05-20
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_8268464056e615fff2c2c6028c3bf923.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ/images/wp_editor_md_8268464056e615fff2c2c6028c3bf923.jpg"/></a></p>
<p>Linuxç³»ç»Ÿä¸­æ”¯æŒå¤šç§ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ºäº†æ˜¯ç”¨æˆ·å¯ä»¥é€šè¿‡ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ“ä½œç•Œé¢ï¼Œå¯¹å„ç§ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ“ä½œï¼Œåœ¨å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆext2/ext4ç­‰ï¼‰ä¹‹ä¸Šå¢åŠ äº†ä¸€å±‚æŠ½è±¡ä¸€ä¸ªç»Ÿä¸€çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿç•Œé¢ï¼Œå‘ä¸Šæä¾›å½’ä¸€åŒ–çš„æ–‡ä»¶æ“ä½œï¼Œè¿™ä¸ªæŠ½è±¡å±‚å°±ç§°ä¸ºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿã€‚ ä¸ºäº†å®ç°æŠ½è±¡å±‚ï¼ŒLinuxå†…æ ¸å®šä¹‰äº†4ä¸ªé‡è¦çš„æ•°æ®ç»“æ„å¯¹è±¡ã€‚</p>
<ul>
<li>supper block: ç®¡ç†æ–‡ä»¶ç³»ç»Ÿçš„ç›¸å…³æè¿°ä¿¡æ¯ã€‚</li>
<li>Inode:ä¸€ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªinodeï¼ŒåŒ…å«æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡ä»¶å¤§å°ã€åˆ›å»ºæ—¶é—´ã€å—å¤§å°ç­‰ã€‚</li>
<li>Dentry:è¡¨ç¤ºä¸€ä¸ªç›®å½•é¡¹ã€‚</li>
<li>File:è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ã€‚</li>
</ul>
<p>ä¸Šé¢4ä¸ªå¯¹è±¡éƒ½æœ‰å¯¹åº”çš„å‡½æ•°æ“ä½œæ–¹æ³•</p>
<ul>
<li>supper_operations:æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œæ–¹æ³•ï¼Œå¦‚read_inode</li>
<li>inode_operations:æ–‡ä»¶çš„æ“ä½œæ–¹æ³•ï¼Œå¦‚createã€linkã€‚</li>
<li>dentry_operations:ç›®å½•é¡¹çš„æ“ä½œæ–¹æ³•ï¼Œå¦‚d_compareã€d_deleteã€‚</li>
<li>file:è¿›ç¨‹æ‰“å¼€æ–‡ä»¶åçš„æ“ä½œæ–¹æ³•ï¼Œå¦‚readã€writeã€‚</li>
</ul>
<h2 id="_1">å››å¤§å¯¹è±¡æ•°æ®ç»“æ„</h2>
<h3 id="_2">è¶…çº§å—å¯¹è±¡</h3>
<p>è¶…çº§å—ï¼Œç”¨äºæè¿°è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿçš„æ€»ä½“ä¿¡æ¯å¦‚å—å¤§å°ã€æ–‡ä»¶å¤§å°ä¸Šé™ã€æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€æŒ‚è½½ç‚¹ä¿¡æ¯ç­‰ã€‚åœ¨æ„å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œå†…æ ¸ä¼šä»å­˜å‚¨è®¾å¤‡ç‰¹å®šä½ç½®è·å–ç›¸å…³çš„æ§åˆ¶ä¿¡æ¯æ¥å¡«å……å†…å­˜ä¸­çš„è¶…çº§å—å¯¹è±¡ï¼Œå½“æ„å»ºå®Œæˆä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ—¶å°±ä¼šå¯¹åº”ä¸€ä¸ªè¶…çº§å—å¯¹è±¡ã€‚</p>
<p>struct super_block</p>
<div class="codehilite"><pre><span></span><code><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">s_list</span><span class="p">;</span><span class="w">     </span><span class="cm">/* Keep this first */</span>
<span class="w">    </span><span class="kt">dev_t</span><span class="w">           </span><span class="n">s_dev</span><span class="p">;</span><span class="w">      </span><span class="cm">/* search index; _not_ kdev_t */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">       </span><span class="n">s_blocksize_bits</span><span class="p">;</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">s_blocksize</span><span class="p">;</span>
<span class="n">loff_t</span><span class="w">          </span><span class="n">s_maxbytes</span><span class="p">;</span><span class="w"> </span><span class="c1">//æ–‡ä»¶å¤§å°ä¸Šé™</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">*</span><span class="n">s_type</span><span class="p">;</span><span class="w"> </span><span class="c1">//æ–‡ä»¶ç³»ç»Ÿç±»å‹</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">super_operations</span><span class="w">   </span><span class="o">*</span><span class="n">s_op</span><span class="p">;</span><span class="w"> </span><span class="c1">//è¶…çº§å—çš„æ–¹æ³•</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dquot_operations</span><span class="w">   </span><span class="o">*</span><span class="n">dq_op</span><span class="p">;</span><span class="c1">//ç£ç›˜é™é¢çš„æ–¹æ³•</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">quotactl_ops</span><span class="w">   </span><span class="o">*</span><span class="n">s_qcop</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">export_operations</span><span class="w"> </span><span class="o">*</span><span class="n">s_export_op</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">s_flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">s_iflags</span><span class="p">;</span><span class="w">   </span><span class="cm">/* internal SB_I_* flags */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">s_magic</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w">       </span><span class="o">*</span><span class="n">s_root</span><span class="p">;</span><span class="w"> </span><span class="c1">//æ–‡ä»¶ç³»ç»Ÿç›®å½•æŒ‚è½½ç‚¹</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">rw_semaphore</span><span class="w"> </span><span class="n">s_umount</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry_operations</span><span class="w"> </span><span class="o">*</span><span class="n">s_d_op</span><span class="p">;</span><span class="w"> </span><span class="cm">/* default d_op for dentries */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="n">s_bdev</span><span class="p">;</span><span class="w"> </span><span class="c1">//å¯¹åº”çš„å—è®¾å¤‡ï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿmountè°ƒç”¨mount_bdevæ—¶ä¼šæ ¹æ®è®¾å¤‡çš„</span>
<span class="n">åç§°æ‰¾åˆ°å¯¹åº”çš„bdevå¡«å……</span><span class="err">ï¼Œ</span><span class="n">å¾—åˆ°å—è®¾å¤‡æè¿°ååç»­å°±å¯ä»¥è°ƒç”¨s_read</span><span class="o">/</span><span class="n">s_writeç­‰æ“ä½œå—è®¾å¤‡</span><span class="err">ã€‚</span>
<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<p>struct super_operations</p>
<div class="codehilite"><pre><span></span><code><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">super_operations</span><span class="w"> </span><span class="p">{</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">alloc_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="n">sb</span><span class="p">);</span><span class="w"> </span>
<span class="c1">//åœ¨ç»™å®šè¶…çº§å—ä¸‹åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ªinodeï¼Œinodeå³å¯¹åº”ä¸€ä¸ªç›®å½•æˆ–æ–‡ä»¶çš„å®ä¾‹ã€‚</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">destroy_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">free_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">dirty_inode</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write_inode</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">writeback_control</span><span class="w"> </span><span class="o">*</span><span class="n">wbc</span><span class="p">);</span><span class="w"> </span><span class="c1">//æŒ‡å®šç´¢å¼•ç‚¹å†™ç£ç›˜</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">drop_inode</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">evict_inode</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">put_super</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sync_fs</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="n">sb</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">wait</span><span class="p">);</span><span class="w"> </span><span class="c1">//æ–‡ä»¶ç³»ç»Ÿä¸ç£ç›˜ä¸Šçš„æ•°æ®åŒæ­¥</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">freeze_super</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">freeze_fs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">thaw_super</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">unfreeze_fs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">statfs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">kstatfs</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">remount_fs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">umount_begin</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">show_options</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seq_file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">show_devname</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seq_file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">show_path</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seq_file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">show_stats</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seq_file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">quota_read</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">quota_write</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dquot</span><span class="w"> </span><span class="o">**</span><span class="p">(</span><span class="o">*</span><span class="n">get_dquots</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">nr_cached_objects</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">                  </span><span class="k">struct</span><span class="w"> </span><span class="nc">shrink_control</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">free_cached_objects</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">                    </span><span class="k">struct</span><span class="w"> </span><span class="nc">shrink_control</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<h3 id="_3">ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡</h3>
<p>Inodeå¯¹è±¡ä»£è¡¨äº†ä¸€ä¸ªå®é™…çš„æ–‡ä»¶ï¼Œå½“æ–‡ä»¶è¢«è®¿é—®å‰éœ€è¦å…ˆè·å–åˆ°è¯¥æ–‡ä»¶çš„inodeï¼Œstruct inodeç»“æ„ä½“åŒ…å«äº†é€šç”¨çš„å±æ€§å’Œæ–¹æ³•ï¼Œå¦‚æ–‡ä»¶ç±»å‹ï¼Œæ–‡ä»¶å¤§å°ï¼Œæƒé™ï¼Œåˆ›å»ºæ—¶é—´ç­‰ä¿¡æ¯ã€‚</p>
<p>struct inode</p>
<div class="codehilite"><pre><span></span><code><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">umode_t</span><span class="w">         </span><span class="n">i_mode</span><span class="p">;</span><span class="c1">//è®¿é—®æƒé™</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">      </span><span class="n">i_opflags</span><span class="p">;</span>
<span class="w">    </span><span class="n">kuid_t</span><span class="w">          </span><span class="n">i_uid</span><span class="p">;</span>
<span class="w">    </span><span class="n">kgid_t</span><span class="w">          </span><span class="n">i_gid</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">i_flags</span><span class="p">;</span><span class="w"> </span><span class="c1">//æ–‡ä»¶ç³»ç»Ÿæ ‡å¿—</span>

<span class="cp">#ifdef CONFIG_FS_POSIX_ACL</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">posix_acl</span><span class="w">    </span><span class="o">*</span><span class="n">i_acl</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">posix_acl</span><span class="w">    </span><span class="o">*</span><span class="n">i_default_acl</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode_operations</span><span class="w">   </span><span class="o">*</span><span class="n">i_op</span><span class="p">;</span><span class="w"> </span><span class="c1">//ç´¢å¼•èŠ‚ç‚¹çš„æ“ä½œæ–¹æ³•</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w">  </span><span class="o">*</span><span class="n">i_sb</span><span class="p">;</span><span class="w"> </span><span class="c1">//æ‰€å±è¶…çº§å—</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w">    </span><span class="o">*</span><span class="n">i_mapping</span><span class="p">;</span><span class="w"> </span><span class="c1">//æ–‡ä»¶ç¼“å­˜</span>
<span class="p">......</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w">    </span><span class="o">*</span><span class="n">i_fop</span><span class="p">;</span><span class="w"> </span><span class="cm">/* former -&gt;i_op-&gt;default_file_ops */</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">free_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_lock_context</span><span class="w">    </span><span class="o">*</span><span class="n">i_flctx</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w">    </span><span class="n">i_data</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">i_devices</span><span class="p">;</span>
<span class="w">    </span><span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<p>struct inode_operations</p>
<div class="codehilite"><pre><span></span><code><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">inode_operations</span><span class="w"> </span><span class="p">{</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">lookup</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="c1">//åœ¨æŒ‡å®šç›®å½•ä¸‹æœç´¢ç›®å½•é¡¹ï¼Œè¦è·å–inodeï¼Œéœ€è¦å…ˆè·å–dentry</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">get_link</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">delayed_call</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">permission</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">posix_acl</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">get_acl</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">readlink</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">create</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">               </span><span class="n">umode_t</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//createæˆ–openç³»ç»Ÿè°ƒç”¨åˆ›å»ºæˆ–æ‰“å¼€æ–‡ä»¶</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">link</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">unlink</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">symlink</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">mkdir</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">              </span><span class="n">umode_t</span><span class="p">);</span><span class="c1">//åˆ›å»ºç›®å½•</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">rmdir</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="c1">//åˆ é™¤ç›®å½•</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">mknod</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">              </span><span class="n">umode_t</span><span class="p">,</span><span class="kt">dev_t</span><span class="p">);</span><span class="c1">//åˆ›å»ºç®¡é“ã€è®¾å¤‡ç­‰ç‰¹æ®Šæ–‡ä»¶</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">rename</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">setattr</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">iattr</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">getattr</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">kstat</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">listxattr</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fiemap</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fiemap_extent_info</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">start</span><span class="p">,</span>
<span class="w">              </span><span class="n">u64</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">update_time</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec64</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">atomic_open</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">               </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">open_flag</span><span class="p">,</span>
<span class="w">               </span><span class="n">umode_t</span><span class="w"> </span><span class="n">create_mode</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">tmpfile</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">umode_t</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">set_acl</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">               </span><span class="k">struct</span><span class="w"> </span><span class="nc">posix_acl</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fileattr_set</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_userns</span><span class="p">,</span>
<span class="w">                </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fileattr</span><span class="w"> </span><span class="o">*</span><span class="n">fa</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fileattr_get</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fileattr</span><span class="w"> </span><span class="o">*</span><span class="n">fa</span><span class="p">);</span>

<span class="p">}</span><span class="w"> </span><span class="n">____cacheline_aligned</span><span class="p">;</span>
</code></pre></div>
<p>åœ¨VFSå±‚å®šä¹‰äº†é€šç”¨çš„struct inodeï¼Œåœ¨å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿä¸­å¯èƒ½è¿˜ä¼šå®šä¹‰å±äºå…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„inodeï¼Œå¦‚struct ext2_inodeã€struct ext4_inodeï¼Œè¿™äº›xxx_inodeæ˜¯å¯¹å…·ä½“æ–‡ä»¶çš„æè¿°å¦‚å…ƒæ•°æ®ç›¸å…³ä¿¡æ¯å³å…·ä½“æ–‡ä»¶ç³»ç»Ÿç£ç›˜ä¿¡æ¯çš„æè¿°ï¼Œåœ¨åˆ†é…struct inodeæ—¶ï¼Œä¼šå°†xxx_inodeçš„å€¼èµ‹å€¼åˆ°struct inodeä¸­ã€‚å…¶ä»–åƒè¶…çº§å—ï¼Œç›®å½•ç­‰å¯¹è±¡ä¹Ÿç±»ä¼¼ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_2f3638dedfafce8236f188ca95fc1076.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ/images/wp_editor_md_2f3638dedfafce8236f188ca95fc1076.jpg"/></a></p>
<h3 id="_4">ç›®å½•é¡¹å¯¹è±¡</h3>
<p>dentryè™½ç¿»è¯‘ä¸ºç›®å½•é¡¹ï¼Œä½†å’Œæ–‡ä»¶ç³»ç»Ÿä¸­çš„ç›®å½•å¹¶ä¸æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼Œdentryå±äºæ–‡ä»¶ç³»ç»Ÿçš„å¯¹è±¡ï¼ŒåŒ…æ‹¬ç›®å½•ã€æ–‡ä»¶ç­‰ï¼Œåæ˜ çš„æ˜¯æ–‡ä»¶ç³»ç»Ÿå¯¹è±¡åœ¨å†…æ ¸ä¸­æ‰€åœ¨æ–‡ä»¶ç³»ç»Ÿæ ‘çš„ä½ç½®ã€‚æ¯ä¸ªæ–‡ä»¶é™¤äº†æœ‰inodeï¼ŒåŒæ—¶ä¹Ÿä¼šæœ‰ä¸€ä¸ªdentryç»“æ„ï¼Œè®°å½•äº†æ–‡ä»¶çš„åç§°ï¼Œçˆ¶ç›®å½•ï¼Œå­ç›®å½•ç­‰ä¿¡æ¯ï¼Œå½¢æˆæˆ‘ä»¬çœ‹åˆ°çš„å±‚çº§æ ‘çŠ¶ç»“æ„ã€‚ä¸inodeä¸åŒæ—¶ï¼Œdentryåªå­˜åœ¨äºå†…å­˜ï¼Œç£ç›˜ä¸Šå¹¶æ²¡æœ‰å¯¹åº”çš„å®ä½“æ–‡ä»¶ï¼Œå› æ­¤ç›®å½•é¡¹ç›®ä¸ä¼šæ¶‰åŠå›å†™ç£ç›˜çš„æ“ä½œã€‚ â€ƒâ€ƒdentryå…¶ä¸­é‡è¦çš„æ˜¯å¯¹æ–‡ä»¶æœç´¢æ‰¾å‡ºå¯¹åº”çš„æ–‡ä»¶çš„inodeã€‚éå†ç›®å½•æ—¶æ¯”è¾ƒè€—æ—¶çš„ï¼Œä¸ºäº†åŠ å¿«éå†å’ŒæŸ¥æ‰¾ï¼Œå†…æ ¸ä¸­ä½¿ç”¨hashè¡¨æ¥ç¼“å­˜dentryã€‚ â€ƒâ€ƒä¸€ä¸ªè·¯å¾„çš„å„ä¸ªç»„æˆéƒ¨åˆ†ï¼Œä¸ç®¡ç›®å½•è¿˜æ˜¯æ™®é€šçš„æ–‡ä»¶ï¼Œéƒ½æ˜¯ä¸€ä¸ªdentryå¯¹è±¡ï¼Œå¦‚/home/test.cï¼Œ/ï¼Œhome,test.céƒ½æ˜¯ä¸€ä¸ªç›®å½•é¡¹ã€‚ä¸ºäº†å¢åŠ æœç´¢æ•ˆç‡ï¼Œè¿™äº›ç›®å½•é¡¹ç›®ç¼“å­˜åˆ°hashè¡¨ä¸­ã€‚</p>
<p>struct dentry</p>
<div class="codehilite"><pre><span></span><code><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">dcache</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* RCU lookup touched fields */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">d_flags</span><span class="p">;</span><span class="w">       </span><span class="cm">/* protected by d_lock */</span>
<span class="w">    </span><span class="n">seqcount_spinlock_t</span><span class="w"> </span><span class="n">d_seq</span><span class="p">;</span><span class="w">  </span><span class="cm">/* per dentry seqlock */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_node</span><span class="w"> </span><span class="n">d_hash</span><span class="p">;</span><span class="w">  </span><span class="c1">//ç”¨äºç›®å½•é¡¹ç›®æŸ¥æ‰¾çš„hashè¡¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">d_parent</span><span class="p">;</span><span class="w">    </span><span class="c1">//çˆ¶ç›®å½•é¡¹</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">qstr</span><span class="w"> </span><span class="n">d_name</span><span class="p">;</span><span class="w"> </span><span class="c1">//ç›®å½•é¡¹ç›®åç§°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">d_inode</span><span class="p">;</span><span class="w">  </span><span class="c1">//ç›®å½•é¡¹å…³è”çš„ç´¢å¼•èŠ‚ç‚¹</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">d_iname</span><span class="p">[</span><span class="n">DNAME_INLINE_LEN</span><span class="p">];</span><span class="w">    </span><span class="cm">/* small names */</span>

<span class="w">    </span><span class="cm">/* Ref lookup also touches following */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lockref</span><span class="w"> </span><span class="n">d_lockref</span><span class="p">;</span><span class="w">   </span><span class="cm">/* per-dentry lock and refcount */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry_operations</span><span class="w"> </span><span class="o">*</span><span class="n">d_op</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="n">d_sb</span><span class="p">;</span><span class="w">   </span><span class="cm">/* The root of the dentry tree */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">d_time</span><span class="p">;</span><span class="w">       </span><span class="cm">/* used by d_revalidate */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">d_fsdata</span><span class="p">;</span><span class="w">         </span><span class="cm">/* fs-specific data */</span><span class="w"> </span><span class="n">å…·ä½“æ–‡ä»¶ç³»ç»Ÿä¸­å†…å­˜ç›®å½•é¡¹ç›®</span><span class="err">ã€‚</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">d_lru</span><span class="p">;</span><span class="w">     </span><span class="cm">/* LRU list */</span>
<span class="w">        </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="o">*</span><span class="n">d_wait</span><span class="p">;</span><span class="w">  </span><span class="cm">/* in-lookup ones only */</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">d_child</span><span class="p">;</span><span class="w">   </span><span class="cm">/* child of parent list */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">d_subdirs</span><span class="p">;</span><span class="w"> </span><span class="cm">/* our children */</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * d_alias and d_rcu can share memory</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w"> </span><span class="n">d_alias</span><span class="p">;</span><span class="w">  </span><span class="cm">/* inode alias list */</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_node</span><span class="w"> </span><span class="n">d_in_lookup_hash</span><span class="p">;</span><span class="w">  </span><span class="cm">/* only for in-lookup ones */</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w"> </span><span class="n">d_rcu</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">d_u</span><span class="p">;</span>

<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></div>
<p>struct dentry</p>
<div class="codehilite"><pre><span></span><code><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">dcache</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">dentry_operations</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">d_revalidate</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">d_weak_revalidate</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">d_hash</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">qstr</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w"> </span><span class="c1">//ä¸ºç›®å½•é¡¹ç›®ç”Ÿæˆhashè¡¨</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">d_compare</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">qstr</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w"> </span><span class="c1">//æ¯”è¾ƒä¸¤ä¸ªæ–‡ä»¶</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">d_delete</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">d_init</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">d_release</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">d_prune</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">d_iput</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">d_dname</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vfsmount</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">d_automount</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">d_manage</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">d_real</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">d_canonical_path</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">____cacheline_aligned</span><span class="p">;</span>
</code></pre></div>
<h3 id="_5">æ–‡ä»¶å¯¹è±¡</h3>
<p>æ–‡ä»¶å¯¹è±¡æè¿°çš„æ˜¯è¿›ç¨‹å’Œæ–‡ä»¶ç›´æ¥çš„å…³ç³»ï¼Œå¯¹æ–‡ä»¶çš„æ“ä½œéƒ½æ˜¯ç”±è¿›ç¨‹å‘èµ·çš„ï¼Œè¿›ç¨‹æ¯æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œå†…æ ¸å°±åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ï¼ŒåŒä¸€ä¸ªæ–‡ä»¶å¯ä»¥è¢«ä¸åŒçš„è¿›ç¨‹æ‰“å¼€ï¼Œåˆ›å»ºä¸åŒçš„æ–‡ä»¶å¯¹è±¡ã€‚</p>
<p>struct file</p>
<div class="codehilite"><pre><span></span><code><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">llist_node</span><span class="w">   </span><span class="n">fu_llist</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w">     </span><span class="n">fu_rcuhead</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">f_u</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w">     </span><span class="n">f_path</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w">        </span><span class="o">*</span><span class="n">f_inode</span><span class="p">;</span><span class="w">   </span><span class="cm">/* cached value */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w">    </span><span class="o">*</span><span class="n">f_op</span><span class="p">;</span><span class="w"> </span><span class="c1">//æ–‡ä»¶çš„æ“ä½œæ–¹æ³•</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Protects f_ep, f_flags.</span>
<span class="cm">     * Must not be taken from IRQ context.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w">      </span><span class="n">f_lock</span><span class="p">;</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">rw_hint</span><span class="w">        </span><span class="n">f_write_hint</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_long_t</span><span class="w">       </span><span class="n">f_count</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">f_flags</span><span class="p">;</span>
<span class="w">    </span><span class="n">fmode_t</span><span class="w">         </span><span class="n">f_mode</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w">        </span><span class="n">f_pos_lock</span><span class="p">;</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w">          </span><span class="n">f_pos</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fown_struct</span><span class="w">  </span><span class="n">f_owner</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cred</span><span class="w">   </span><span class="o">*</span><span class="n">f_cred</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_ra_state</span><span class="w">    </span><span class="n">f_ra</span><span class="p">;</span>

<span class="w">    </span><span class="n">u64</span><span class="w">         </span><span class="n">f_version</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SECURITY</span>
<span class="w">    </span><span class="kt">void</span><span class="w">            </span><span class="o">*</span><span class="n">f_security</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="cm">/* needed for tty driver, and maybe others */</span>
<span class="w">    </span><span class="kt">void</span><span class="w">            </span><span class="o">*</span><span class="n">private_data</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_EPOLL</span>
<span class="w">    </span><span class="cm">/* Used by fs/eventpoll.c to link all the hooks to this file */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_head</span><span class="w">   </span><span class="o">*</span><span class="n">f_ep</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_EPOLL */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w">    </span><span class="o">*</span><span class="n">f_mapping</span><span class="p">;</span>
<span class="w">    </span><span class="n">errseq_t</span><span class="w">        </span><span class="n">f_wb_err</span><span class="p">;</span>
<span class="w">    </span><span class="n">errseq_t</span><span class="w">        </span><span class="n">f_sb_err</span><span class="p">;</span><span class="w"> </span><span class="cm">/* for syncfs */</span>

<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">__randomize_layout</span>
</code></pre></div>
<p>struct file_operations</p>
<div class="codehilite"><pre><span></span><code><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">llseek</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read_iter</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kiocb</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">iov_iter</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write_iter</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kiocb</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">iov_iter</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">iopoll</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kiocb</span><span class="w"> </span><span class="o">*</span><span class="n">kiocb</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">spin</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">iterate</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dir_context</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w"> </span><span class="c1">//ç›®å½•è¯»å–</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">iterate_shared</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dir_context</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="n">__poll_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">poll</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">poll_table_struct</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">unlocked_ioctl</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">compat_ioctl</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">mmap</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">mmap_supported_flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">flush</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fl_owner_t</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fsync</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">datasync</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fasync</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_lock</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sendpage</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="nf">long</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">get_unmapped_area</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">check_flags</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">flock</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_lock</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">splice_write</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pipe_inode_info</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">splice_read</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pipe_inode_info</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">setlease</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_lock</span><span class="w"> </span><span class="o">**</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">);</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fallocate</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span>
<span class="w">              </span><span class="n">loff_t</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">show_fdinfo</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seq_file</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">);</span>
<span class="cp">#ifndef CONFIG_MMU</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">mmap_capabilities</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">copy_file_range</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">            </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">remap_file_range</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file_in</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="n">pos_in</span><span class="p">,</span>
<span class="w">                   </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file_out</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="n">pos_out</span><span class="p">,</span>
<span class="w">                   </span><span class="n">loff_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">remap_flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fadvise</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>

<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></div>
<p>ä¸‹é¢æè¿°è¿›ç¨‹ä¸æ–‡ä»¶æ“ä½œè”ç³»</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_6a9e7e989e90e2de4e489a3195122885.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ/images/wp_editor_md_6a9e7e989e90e2de4e489a3195122885.jpg"/></a></p>
<p>æ¯ä¸ªè¿›ç¨‹æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶åï¼Œéƒ½æœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦fdã€‚struct file *fd_arrayå­˜å‚¨çš„å°±æ˜¯è¿™ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶ï¼Œç§°ä¸ºæ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œæ–‡ä»¶æè¿°è¡¨çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªç”¨äºæè¿°æ‰“å¼€çš„struct fileå¯¹è±¡ï¼Œstruct fileå¯¹è±¡æè¿°äº†æ–‡ä»¶çš„æ‰“å¼€æ¨¡å¼ï¼Œå½“è¿›ç¨‹æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ˜¯ï¼Œå†…æ ¸å°±ä¼šåˆ›å»ºä¸€ä¸ªfileå¯¹è±¡ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯fileå¯¹è±¡ä¸æ˜¯ä¸“å±æŸä¸ªè¿›ç¨‹ï¼Œfdæ‰æ˜¯ä¸“å±äºæŸä¸ªè¿›ç¨‹ï¼Œä¸åŒçš„æ–‡ä»¶æè¿°ç¬¦æŒ‡é’ˆå¯ä»¥æŒ‡å‘ç›¸åŒçš„fileå¯¹è±¡ï¼Œè¡¨ç¤ºå…±äº«æ‰“å¼€çš„æ–‡ä»¶ï¼Œstruct fileä¸­æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œæè¿°äº†è¢«å¤šä¸ªè¿›ç¨‹å¼•ç”¨çš„æ¬¡æ•°ï¼Œåªæœ‰å¼•å…¥è®¡æ•°ä¸º0æ—¶ï¼Œå†…æ ¸æ‰ä¼šé”€æ¯fileå¯¹è±¡ã€‚</p>
<h2 id="_6">å…¶ä»–æ•°æ®ç»“æ„</h2>
<h3 id="_7">æ–‡ä»¶ç³»ç»Ÿç±»å‹</h3>
<p>Linuxæ”¯æŒå¤šç§æ–‡ä»¶ç³»ç»Ÿï¼Œå†…éƒ¨ç”¨ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®ç»“æ„æ¥æè¿°æ¯ç§æ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½å’Œè¡Œä¸ºã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="c1">//æ–‡ä»¶ç³»ç»Ÿåç§°</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fs_flags</span><span class="p">;</span>
<span class="cp">#define FS_REQUIRES_DEV     1</span>
<span class="cp">#define FS_BINARY_MOUNTDATA 2</span>
<span class="cp">#define FS_HAS_SUBTYPE      4</span>
<span class="cp">#define FS_USERNS_MOUNT     8   </span><span class="cm">/* Can be mounted by userns root */</span>
<span class="cp">#define FS_DISALLOW_NOTIFY_PERM 16  </span><span class="cm">/* Disable fanotify permission events */</span>
<span class="cp">#define FS_ALLOW_IDMAP         32      </span><span class="cm">/* FS has been updated to handle vfs idmappings. */</span>
<span class="cp">#define FS_THP_SUPPORT      8192    </span><span class="cm">/* Remove once all fs converted */</span>
<span class="cp">#define FS_RENAME_DOES_D_MOVE   32768   </span><span class="cm">/* FS will handle d_move() during rename() internally. */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">init_fs_context</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">fs_context</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fs_parameter_spec</span><span class="w"> </span><span class="o">*</span><span class="n">parameters</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">mount</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span>
<span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="c1">//æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">kill_sb</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_head</span><span class="w"> </span><span class="n">fs_supers</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">s_lock_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">s_umount_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">s_vfs_rename_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">s_writers_key</span><span class="p">[</span><span class="n">SB_FREEZE_LEVELS</span><span class="p">];</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">i_lock_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">i_mutex_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">invalidate_lock_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">i_mutex_dir_key</span><span class="p">;</span>

<span class="p">};</span>
</code></pre></div>
<h3 id="_8">æ–‡ä»¶ç³»ç»ŸæŒ‚è½½</h3>
<p>Linuxæ–‡ä»¶ç³»ç»Ÿåªæœ‰è¢«æŒ‚è½½ä¸Šï¼Œæ‰èƒ½è¿›è¡Œè®¿é—®ï¼Œä½¿ç”¨ä¸€ä¸ªvfsmountæ¥æè¿°ä¸€ä¸ªæŒ‚è½½ç‚¹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">vfsmount</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_root</span><span class="p">;</span><span class="w">    </span><span class="cm">/* root of the mounted tree */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_sb</span><span class="p">;</span><span class="w"> </span><span class="cm">/* pointer to superblock */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mnt_flags</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_userns</span><span class="p">;</span>

<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="n">ANDROID_KABI_RESERVE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="å®ç°ç®€å•æ–‡ä»¶ç³»ç»Ÿ.html">â† å®ç°ç®€å•æ–‡ä»¶ç³»ç»Ÿ</a>
    <a class="next" href="æ–‡ä»¶ç³»ç»Ÿç£ç›˜ç®¡ç†.html">æ–‡ä»¶ç³»ç»Ÿç£ç›˜ç®¡ç† â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

