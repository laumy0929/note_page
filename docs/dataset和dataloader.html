<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>datasetå’ŒDataLoader - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">ç®€ä»‹</a><ul></ul></li><li><a href="#dataset">Dataset</a><ul></ul></li><li><a href="#dataloader">DataLoader</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>datasetå’ŒDataLoader</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2025-08-08
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      ai
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">ç®€ä»‹</h2>
<p>Datasetå’ŒDataLoaderåœ¨pytorchä¸­ä¸»è¦ç”¨äºæ•°æ®çš„ç»„ç»‡ã€‚è¿™ä¸¤ä¸ªç±»é€šå¸¸ä¸€èµ·æ­é…å¤„ç†æ·±åº¦å­¦ä¹ ä¸­çš„æ•°æ®æµã€‚</p>
<ul>
<li>Dataset ç”¨äºäº§å‡ºâ€œå•ä¸ªæ ·æœ¬â€ï¼šå®šä¹‰æ€ä¹ˆæŒ‰ç´¢å¼•å–åˆ°ä¸€ä¸ªæ ·æœ¬ï¼Œä»¥åŠæ€»å…±æœ‰å¤šå°‘ä¸ªæ ·æœ¬ã€‚</li>
<li>DataLoader è´Ÿè´£â€œæˆæ‰¹å–æ ·â€ï¼šå†³å®šæ‰¹å¤§å°ã€æ˜¯å¦æ‰“ä¹±ã€å¤šè¿›ç¨‹åŠ è½½ã€å¹¶ç”¨ collate_fn æŠŠä¸€ä¸ªæ‰¹é‡Œçš„æ ·æœ¬â€œæ‹¼èµ·æ¥â€ï¼ˆå¯¹é½ã€paddingã€maskã€teacher forcing ç­‰ï¼‰ã€‚</li>
</ul>
<p>ä¸€å¥è¯è®°å¿†ï¼šDataset åªç®¡â€œå•æ¡æ ·æœ¬â€ï¼›DataLoader è´Ÿè´£â€œå¤šæ¡æ€ä¹ˆä¸€èµ·ã€æ€ä¹ˆå¹¶è¡Œã€æ€ä¹ˆå¯¹é½â€ã€‚å˜é•¿å°±å†™ collate_fnï¼Œæ€§èƒ½å°±è°ƒ workers/pin_memory/åˆ†æ¡¶ã€‚</p>
<h2 id="dataset">Dataset</h2>
<p>Datasetç±»ä½œç”¨ï¼šå®šä¹‰æ•°æ®é›†çš„ç»Ÿä¸€æ¥å£ï¼Œæ”¯æŒè‡ªå®šä¹‰æ•°æ®åŠ è½½é€»è¾‘ã€‚</p>
<p>å…³é”®æ–¹æ³•ï¼š</p>
<ul>
<li><strong>init</strong>ï¼šåˆå§‹åŒ–æ•°æ®è·¯å¾„ã€é¢„å¤„ç†å‡½æ•°ç­‰ã€‚</li>
<li><strong>len</strong>ï¼šè¿”å›æ•°æ®é›†æ ·æœ¬æ€»æ•°ã€‚</li>
<li><strong>getitem</strong>ï¼šæ ¹æ®ç´¢å¼•è¿”å›å•ä¸ªæ ·æœ¬ï¼ˆæ•°æ®+æ ‡ç­¾ï¼‰ã€‚</li>
</ul>
<p>é€šå¸¸æƒ…å†µä¸‹ç”¨æˆ·éƒ½ä¼šæœ‰è‡ªå·±çš„æ•°æ®é›†ï¼Œæ‰€ä»¥å®šä¹‰çš„æ•°æ®é›†ç±»ç»§æ‰¿datasetã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#å‡†å¤‡ä¸€ä¸ªæ•°æ®é›†</span>
<span class="n">pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">"æˆ‘ æœ‰ ä¸€ä¸ª è‹¹æœ"</span><span class="p">,</span> <span class="s2">"i have an apple"</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">"æˆ‘ æœ‰ ä¸€æœ¬ ä¹¦"</span><span class="p">,</span> <span class="s2">"i have a book"</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">"ä½  å–œæ¬¢ ä¹¦"</span><span class="p">,</span> <span class="s2">"you like books"</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">"æˆ‘ åƒ è‹¹æœ"</span><span class="p">,</span> <span class="s2">"i eat apples"</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">build_vocab</span><span class="p">(</span><span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
    <span class="n">itos</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"&lt;pad&gt;"</span><span class="p">,</span> <span class="s2">"&lt;bos&gt;"</span><span class="p">,</span> <span class="s2">"&lt;eos&gt;"</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    <span class="n">stoi</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itos</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">stoi</span><span class="p">,</span> <span class="n">itos</span>

<span class="n">src_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>
<span class="n">tgt_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>
<span class="n">SRC_STOI</span><span class="p">,</span> <span class="n">SRC_ITOS</span> <span class="o">=</span> <span class="n">build_vocab</span><span class="p">(</span><span class="n">src_texts</span><span class="p">)</span>
<span class="n">TGT_STOI</span><span class="p">,</span> <span class="n">TGT_ITOS</span> <span class="o">=</span> <span class="n">build_vocab</span><span class="p">(</span><span class="n">tgt_texts</span><span class="p">)</span>

<span class="n">PAD_IDX</span><span class="p">,</span> <span class="n">BOS_IDX</span><span class="p">,</span> <span class="n">EOS_IDX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">encode_src</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">SRC_STOI</span><span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>

<span class="k">def</span> <span class="nf">encode_tgt</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">BOS_IDX</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">TGT_STOI</span><span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="o">+</span> <span class="p">[</span><span class="n">EOS_IDX</span><span class="p">]</span>

<span class="c1"># Datasetï¼šå®šä¹‰â€œå•æ ·æœ¬æ€ä¹ˆå–â€</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Example</span><span class="p">:</span>
    <span class="n">src</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">tgt</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToyDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]):</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"encode_src(s)"</span><span class="p">,</span><span class="n">encode_src</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"encode_tgt(t)"</span><span class="p">,</span><span class="n">encode_tgt</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">Example</span><span class="p">(</span><span class="n">encode_src</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">encode_tgt</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Example</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</code></pre></div>
<ul>
<li>æ ·æœ¬ç»“æ„ï¼šç”¨ Example(src: List[int], tgt: List[int]) è¡¨ç¤ºä¸€æ¡æ ·æœ¬çš„æºåºåˆ—ä¸ç›®æ ‡åºåˆ—ï¼ˆéƒ½æ˜¯ token id åˆ—è¡¨ï¼‰ã€‚</li>
<li>è¯è¡¨ä¸ç¼–ç ï¼šæºåºåˆ—ä»…åˆ†è¯å¹¶æ˜ å°„åˆ° idã€‚ç›®æ ‡åºåˆ—å‰åŠ  bosã€ååŠ  eosï¼Œä¾¿äºè‡ªå›å½’è®­ç»ƒã€‚</li>
<li>åè®®ï¼šå®ç° <strong>len</strong> å’Œ <strong>getitem</strong> ä¸¤ä¸ªæ–¹æ³•å³å¯è¢« DataLoader ä½¿ç”¨ã€‚</li>
</ul>
<h2 id="dataloader">DataLoader</h2>
<div class="codehilite"><pre><span></span><code>  <span class="k">class</span> <span class="nc">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="n">T_co</span><span class="p">]):</span>
      <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
          <span class="bp">self</span><span class="p">,</span>
          <span class="n">dataset</span><span class="p">,</span>
          <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
          <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">sampler</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">batch_sampler</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
          <span class="n">collate_fn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">pin_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
          <span class="n">drop_last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
          <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
          <span class="n">worker_init_fn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">multiprocessing_context</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">prefetch_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
          <span class="n">persistent_workers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
          <span class="n">pin_memory_device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
      <span class="p">):</span> <span class="o">...</span>
</code></pre></div>
<ul>
<li>dataset: Dataset æˆ– IterableDataset å®ä¾‹ã€‚</li>
<li>batch_size: æ¯æ‰¹æ ·æœ¬æ•°ã€‚</li>
<li>shuffle: æ˜¯å¦åœ¨æ¯ä¸ª epoch æ‰“ä¹±ç´¢å¼•ï¼ˆMap-style ä¸”æœªæ˜¾å¼ä¼  sampler æ—¶æœ‰æ•ˆï¼‰ã€‚</li>
<li>sampler: è‡ªå®šä¹‰æ ·æœ¬é‡‡æ ·å™¨ï¼ˆä¸ shuffle äº’æ–¥ï¼›æŒ‡å®šå®ƒå°±ä¸è¦å†ç”¨ shuffleï¼‰ã€‚</li>
<li>batch_sampler: ä¸€æ¬¡ç›´æ¥äº§å‡ºâ€œä¸€ä¸ª batch çš„ç´¢å¼•åˆ—è¡¨â€ï¼ˆä¸ batch_sizeã€shuffleã€sampler äº’æ–¥ï¼‰ã€‚</li>
<li>num_workers: è¿›ç¨‹æ•°ï¼ˆ0 ä¸ºä¸»è¿›ç¨‹ï¼›&gt;0 å¼€å¤šè¿›ç¨‹å¹¶è¡ŒåŠ è½½ï¼‰ã€‚</li>
<li>collate_fn(samples_list) -&gt; batch: æ‰¹å†…æ‹¼æ¥å‡½æ•°ï¼›å˜é•¿åºåˆ—éœ€è¦è‡ªå®šä¹‰ï¼ˆé»˜è®¤ä¼šå°è¯•å †å ç­‰é•¿ tensorï¼‰ã€‚</li>
<li>pin_memory: å°† batch å›ºå®šåˆ°é¡µé”å†…å­˜ï¼Œé…åˆ CUDA åŠ é€Ÿ H2D æ‹·è´ã€‚</li>
<li>drop_last: æ•°æ®é‡ä¸æ˜¯ batch_size æ•´æ•°å€æ—¶ï¼Œæ˜¯å¦ä¸¢å¼ƒæœ€åä¸æ»¡çš„ä¸€æ‰¹ã€‚</li>
<li>timeout: ä» worker ç­‰å¾…æ•°æ®çš„ç§’æ•°ï¼ˆ&gt;0 æ—¶ç”Ÿæ•ˆï¼‰ã€‚</li>
<li>worker_init_fn(worker_id): æ¯ä¸ª worker çš„åˆå§‹åŒ–å›è°ƒï¼ˆè®¾éšæœºç§å­ã€æ‰“å¼€æ–‡ä»¶ç­‰ï¼‰ã€‚</li>
<li>multiprocessing_context: æŒ‡å®šå¤šè¿›ç¨‹ä¸Šä¸‹æ–‡ï¼ˆspawn/forkserver ç­‰ï¼‰ã€‚</li>
<li>generator: æ§åˆ¶éšæœºæ€§ï¼ˆæ‰“ä¹±ã€é‡‡æ ·ï¼‰ç”¨çš„éšæœºæ•°ç”Ÿæˆå™¨ã€‚</li>
<li>prefetch_factor: æ¯ä¸ª worker é¢„å–å¤šå°‘ä¸ª batchï¼ˆnum_workers &gt; 0 æ—¶æœ‰æ•ˆï¼‰ã€‚</li>
<li>persistent_workers: True æ—¶ DataLoader ç¬¬ä¸€æ¬¡è¿­ä»£åä¿æŒ worker ä¸é”€æ¯ï¼Œæé«˜å¤šè½®è¿­ä»£æ€§èƒ½ã€‚</li>
<li>pin_memory_device: å½“ pin_memory=True æ—¶ï¼ŒæŒ‡å®šå›ºå®šå†…å­˜çš„è®¾å¤‡æ ‡ç­¾ï¼ˆä¸€èˆ¬ç•™ç©ºå³å¯ï¼‰ã€‚</li>
</ul>
<p>DataLoaderè¿”å›æ˜¯ä¸€ä¸ªå¯è¿­ä»£çš„å¯¹è±¡ï¼Œæ¯æ¬¡è¿­ä»£äº§å‡ºä¸€ä¸ªæ‰¹æ¬¡çš„æ ·æœ¬ã€‚ä¸€ä¸ªæ‰¹æ¬¡çš„å†…å®¹å°±æ˜¯æŠŠå½“æ‰¹æ ·æœ¬åˆ—è¡¨äº¤ç»™ collate_fn çš„è¿”å›å€¼ï¼ˆè‹¥æœªè‡ªå®šä¹‰ï¼Œåˆ™ç”¨ PyTorch çš„é»˜è®¤ default_collateï¼‰ã€‚è€Œç±»å‹å–å†³äºä¸¤ç‚¹Dataset.<strong>getitem</strong> è¿”å›ä»€ä¹ˆï¼ˆtensor/æ•°å€¼/dict/tupleâ€¦ï¼‰å’Œcollate_fn å¦‚ä½•æŠŠä¸€æ‰¹â€œæ ·æœ¬åˆ—è¡¨â€æ‹¼æˆâ€œæ‰¹æ¬¡â€ã€‚</p>
<p>è¿™é‡Œé‡ç‚¹é˜è¿°ä¸€ä¸‹collate_fnæ˜¯ä¸€ä¸ªç”¨æˆ·éœ€è¦æ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼Œç›®çš„æ˜¯è¦æŠŠä¸€ä¸ªæ‰¹çš„æ ·æœ¬æ‹¼æ¥èµ·æ¥ã€‚åŒæ—¶å¯¹äºè¾“å…¥æ ·æœ¬å¦‚æœå¼ é‡çš„å½¢çŠ¶ä¸ä¸€è‡´å¦‚å˜é•¿åºåˆ—ï¼Œè¿›è¡Œpaddingã€å¯¹é½ã€maskç­‰åŠ¨ä½œã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Example</span><span class="p">]):</span>
    <span class="n">src_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">src</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span>
    <span class="n">tgt_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">tgt</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span>

    <span class="n">src_batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tgt_in_batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tgt_out_batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">src</span> <span class="o">+</span> <span class="p">[</span><span class="n">PAD_IDX</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">src_max</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">src</span><span class="p">))</span>
        <span class="c1"># teacher forcingï¼šè¾“å…¥å»æ‰æœ€åä¸€ä¸ªã€è¾“å‡ºå»æ‰ç¬¬ä¸€ä¸ª</span>
        <span class="n">tgt_in</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">tgt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">PAD_IDX</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">tgt_max</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">tgt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">tgt_out</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">tgt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">PAD_IDX</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">tgt_max</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">tgt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

        <span class="n">src_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">tgt_in_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tgt_in</span><span class="p">)</span>
        <span class="n">tgt_out_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tgt_out</span><span class="p">)</span>

    <span class="n">src</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">src_batch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>         <span class="c1"># (B,S)</span>
    <span class="n">tgt_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">tgt_in_batch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>   <span class="c1"># (B,T)</span>
    <span class="n">tgt_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">tgt_out_batch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span> <span class="c1"># (B,T)</span>
    <span class="n">src_pad_mask</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">PAD_IDX</span><span class="p">)</span>                          <span class="c1"># (B,S) True=PAD</span>
    <span class="n">tgt_pad_mask</span> <span class="o">=</span> <span class="n">tgt_in</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">PAD_IDX</span><span class="p">)</span>                       <span class="c1"># (B,T) True=PAD</span>
    <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt_in</span><span class="p">,</span> <span class="n">tgt_out</span><span class="p">,</span> <span class="n">src_pad_mask</span><span class="p">,</span> <span class="n">tgt_pad_mask</span>
</code></pre></div>
<ul>
<li>è¾“å…¥ï¼šbatch æ˜¯è‹¥å¹²ä¸ª Exampleï¼Œæ¯ä¸ªåŒ…å« src: List[int] ä¸ tgt: List[int]ï¼ˆç›®æ ‡åºåˆ—å·²å« bos/eosï¼‰ã€‚</li>
<li>æ ¸å¿ƒï¼šå¯¹é½å˜é•¿åºåˆ—ï¼ˆå³ä¾§ paddingï¼‰ï¼Œæ„é€  teacher forcing çš„ (tgt_in, tgt_out)ï¼Œå¹¶ç”Ÿæˆ padding æ©ç ã€‚</li>
<li>
<p>è¾“å‡ºï¼š</p>
<ul>
<li>src: (B, S)</li>
<li>tgt_in: (B, T)</li>
<li>tgt_out: (B, T)</li>
<li>src_pad_mask: (B, S)ï¼›True=PAD</li>
<li>tgt_pad_mask: (B, T)ï¼›True=PAD</li>
</ul>
</li>
</ul>
<p>é¦–å…ˆä½¿ç”¨src_max/tgt_maxè®¡ç®—æ‰¹å†…æœ€é•¿é•¿åº¦ï¼Œè¿™æ ·èƒ½å¤Ÿå°†æ‰€æœ‰æ ·æœ¬å³ä¾§è¡¥åˆ°åŒä¸€é•¿åº¦ï¼Œæ–¹ä¾¿å †å ä¸ºçŸ©é˜µã€‚</p>
<p>æ¥ç€å®šä¹‰æ‰¹å†…ç´¯ç§¯çš„å®¹å™¨src_batch,tgt_in_batch,tgt_out_batchã€‚</p>
<ul>
<li>src_batch: ç¼–ç å™¨è¾“å…¥æ ·æœ¬çš„æ‰¹æ¬¡ã€‚</li>
<li>tgt_in_batch:è§£ç å™¨è¾“å…¥æ ·æœ¬çš„æ‰¹æ¬¡ã€‚</li>
<li>tgt_out_batch:è§£ç å™¨è¾“å‡ºæ ·æœ¬çš„æ‰¹æ¬¡ã€‚</li>
</ul>
<p>å…¶æ¬¡ä½¿ç”¨forå¾ªç¯å¯¹æ¯ä¸ªæ ·æœ¬è¿›è¡Œè¡¥é½ï¼Œä½¿å…¶è·Ÿsrc_maxã€tgt_maxé•¿åº¦ä¸€è‡´ï¼Œ[PAD_IDX] * (src_max - len(ex.src))çš„æ„æ€æ˜¯å°†[PAD_IDX]çš„å•å…ƒç´ åˆ—è¡¨é‡å¤src_max - len(ex.src)ç”¨äºæ‹¼æ¥è¿½åŠ åˆ°ex.srcåï¼Œä½¿å…¶å¯¹é½ã€‚tgt_inå’Œtgt_outåŒç†ã€‚</p>
<p>åœ¨å¯¹tgt_inå’Œtgt_outåšæ ·æœ¬è¡¥é½æ—¶ï¼Œå› ä¸ºè¾“å…¥ex.tgtæ˜¯åŒ…å«äº†boså’Œeosç›®æ ‡åºåˆ—ï¼Œå¯¹äºtgt_inè¾“å…¥éœ€è¦å»æ‰æœ€åä¸€ä¸ªtoken bosï¼Œtgt_outè¾“å‡ºéœ€è¦å»æ‰ç¬¬ä¸€ä¸ªtoken eosã€‚</p>
<p>ç„¶åå°±æ˜¯å°†è¡¥é½çš„åºåˆ—ä¾æ¬¡æ·»åŠ åˆ°src_batchï¼Œtgt_in_batchï¼Œtgt_out_batchã€‚è¿™æ ·å°±å¯¹è¾“å…¥çš„æ•°æ®è¿›è¡Œäº†åˆ†ç±»ï¼ŒæŠŠç¼–ç å™¨çš„è¾“å…¥æ•´åˆäº†åœ¨ä¸€èµ·ï¼Œè§£ç å™¨çš„è¾“å…¥å’Œè¾“å‡ºæ•´åˆäº†ä¸€èµ·ã€‚</p>
<p>æœ€åå°±æ˜¯å°†æ‰¹å†…å¯¹é½åçš„æºåºåˆ—åˆ—è¡¨è½¬æ¢ä¸ºå¼ é‡ï¼ŒåŒæ—¶è®¡ç®—srcå’Œtag_inçš„maskï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹æ•°æ®å“ªäº›ä½ç½®æ·»åŠ äº†padã€‚</p>
<p>ä¸‹é¢æ˜¯collate_fnç›¸å…³çš„æ‰“å°æ•°æ®ï¼Œä¾¿äºç†è§£ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">batch</span> <span class="p">[</span><span class="n">Example</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span> <span class="n">tgt</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> <span class="n">Example</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">tgt</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">])]</span>
<span class="n">src</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span>
<span class="n">tgt_in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">tgt_out</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">src</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">tgt_in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">tgt_out</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">src_batch</span> <span class="p">[[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
<span class="n">tgt_in_batch</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
<span class="n">tgt_out_batch</span> <span class="p">[[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
<span class="n">src</span> <span class="n">tensor</span><span class="p">([[</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">6</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">0</span><span class="p">]])</span>
<span class="n">tgt_in</span> <span class="n">tensor</span><span class="p">([[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">0</span><span class="p">]])</span>
<span class="n">tgt_out</span> <span class="n">tensor</span><span class="p">([[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">2</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">]])</span>
<span class="n">src_pad_mask</span> <span class="n">tensor</span><span class="p">([[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>  <span class="kc">True</span><span class="p">]])</span>
<span class="n">tgt_pad_mask</span> <span class="n">tensor</span><span class="p">([[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>  <span class="kc">True</span><span class="p">]])</span>
<span class="n">src</span> <span class="n">tensor</span><span class="p">([[</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">6</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">0</span><span class="p">]])</span>
<span class="n">tgt_in</span> <span class="n">tensor</span><span class="p">([[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">0</span><span class="p">]])</span>
<span class="n">tgt_out</span> <span class="n">tensor</span><span class="p">([[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">2</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">]])</span>
<span class="n">src_mask</span> <span class="n">tensor</span><span class="p">([[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>  <span class="kc">True</span><span class="p">]])</span>
<span class="n">tgt_mask</span> <span class="n">tensor</span><span class="p">([[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>  <span class="kc">True</span><span class="p">]])</span>
</code></pre></div>
<p>æœ€åå®Œæ•´çš„ç¤ºä¾‹ä»£ç </p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">"""</span>
<span class="sd">æœ€å°å¯è¿è¡Œç¤ºä¾‹ï¼šç”¨ Dataset + DataLoaderï¼ˆå« collate_fnï¼‰æ¼”ç¤ºå˜é•¿åºåˆ—å¦‚ä½•æ‹¼æ‰¹å¹¶ç”Ÿæˆ padding æ©ç ã€‚</span>

<span class="sd">è¿è¡Œï¼š</span>
<span class="sd">  python3 dataloader_demo.py</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 1) å‡†å¤‡ä¸€ç‚¹è¯­æ–™ï¼ˆç©ºæ ¼åˆ†è¯ï¼‰</span>
<span class="c1"># --------------------------</span>
<span class="n">pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">"æˆ‘ æœ‰ ä¸€ä¸ª è‹¹æœ"</span><span class="p">,</span> <span class="s2">"i have an apple"</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">"æˆ‘ æœ‰ ä¸€æœ¬ ä¹¦"</span><span class="p">,</span> <span class="s2">"i have a book"</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">"ä½  å–œæ¬¢ ä¹¦"</span><span class="p">,</span> <span class="s2">"you like books"</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">"æˆ‘ åƒ è‹¹æœ"</span><span class="p">,</span> <span class="s2">"i eat apples"</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">build_vocab</span><span class="p">(</span><span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
    <span class="n">itos</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"&lt;pad&gt;"</span><span class="p">,</span> <span class="s2">"&lt;bos&gt;"</span><span class="p">,</span> <span class="s2">"&lt;eos&gt;"</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    <span class="n">stoi</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itos</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">stoi</span><span class="p">,</span> <span class="n">itos</span>

<span class="n">src_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>
<span class="n">tgt_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>
<span class="n">SRC_STOI</span><span class="p">,</span> <span class="n">SRC_ITOS</span> <span class="o">=</span> <span class="n">build_vocab</span><span class="p">(</span><span class="n">src_texts</span><span class="p">)</span>
<span class="n">TGT_STOI</span><span class="p">,</span> <span class="n">TGT_ITOS</span> <span class="o">=</span> <span class="n">build_vocab</span><span class="p">(</span><span class="n">tgt_texts</span><span class="p">)</span>

<span class="n">PAD_IDX</span><span class="p">,</span> <span class="n">BOS_IDX</span><span class="p">,</span> <span class="n">EOS_IDX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">encode_src</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">SRC_STOI</span><span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>

<span class="k">def</span> <span class="nf">encode_tgt</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">BOS_IDX</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">TGT_STOI</span><span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="o">+</span> <span class="p">[</span><span class="n">EOS_IDX</span><span class="p">]</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 2) Datasetï¼šå®šä¹‰â€œå•æ ·æœ¬æ€ä¹ˆå–â€</span>
<span class="c1"># --------------------------</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Example</span><span class="p">:</span>
    <span class="n">src</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">tgt</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToyDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]):</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"encode_src(s)"</span><span class="p">,</span><span class="n">encode_src</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"encode_tgt(t)"</span><span class="p">,</span><span class="n">encode_tgt</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">Example</span><span class="p">(</span><span class="n">encode_src</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">encode_tgt</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Example</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 3) collate_fnï¼šæŠŠâ€œæ ·æœ¬åˆ—è¡¨â€æ‹¼æˆä¸€æ‰¹ï¼ˆå¯¹é½ padding + ç”Ÿæˆ mask + teacher forcingï¼‰</span>
<span class="c1"># --------------------------</span>
<span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Example</span><span class="p">]):</span>
    <span class="n">src_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">src</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span>
    <span class="c1">#è®¡ç®—æ‰¹æ¬¡å†…æœ€é•¿é•¿åº¦ï¼Œè¿™æ ·èƒ½å°†æ ·æœ¬å³ä¾§è¡¥é½åˆ°åŒä¸€é•¿åº¦ï¼Œæ–¹ä¾¿å †å çŸ©é˜µ</span>
    <span class="n">tgt_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">tgt</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span>

    <span class="n">src_batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tgt_in_batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tgt_out_batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"batch"</span><span class="p">,</span><span class="n">batch</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">src</span> <span class="o">+</span> <span class="p">[</span><span class="n">PAD_IDX</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">src_max</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">src</span><span class="p">))</span>
        <span class="c1"># teacher forcingï¼šè¾“å…¥å»æ‰æœ€åä¸€ä¸ªã€è¾“å‡ºå»æ‰ç¬¬ä¸€ä¸ª</span>
        <span class="n">tgt_in</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">tgt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">PAD_IDX</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">tgt_max</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">tgt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">tgt_out</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">tgt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">PAD_IDX</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">tgt_max</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">tgt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"src"</span><span class="p">,</span><span class="n">src</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"tgt_in"</span><span class="p">,</span><span class="n">tgt_in</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"tgt_out"</span><span class="p">,</span><span class="n">tgt_out</span><span class="p">)</span>

        <span class="n">src_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">tgt_in_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tgt_in</span><span class="p">)</span>
        <span class="n">tgt_out_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tgt_out</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"src_batch"</span><span class="p">,</span><span class="n">src_batch</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"tgt_in_batch"</span><span class="p">,</span><span class="n">tgt_in_batch</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"tgt_out_batch"</span><span class="p">,</span><span class="n">tgt_out_batch</span><span class="p">)</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">src_batch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>         <span class="c1"># (B,S)</span>
    <span class="n">tgt_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">tgt_in_batch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>   <span class="c1"># (B,T)</span>
    <span class="n">tgt_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">tgt_out_batch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span> <span class="c1"># (B,T)</span>
    <span class="n">src_pad_mask</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">PAD_IDX</span><span class="p">)</span>                          <span class="c1"># (B,S) True=PAD</span>
    <span class="n">tgt_pad_mask</span> <span class="o">=</span> <span class="n">tgt_in</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">PAD_IDX</span><span class="p">)</span>                       <span class="c1"># (B,T) True=PAD</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"src"</span><span class="p">,</span><span class="n">src</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"tgt_in"</span><span class="p">,</span><span class="n">tgt_in</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"tgt_out"</span><span class="p">,</span><span class="n">tgt_out</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"src_pad_mask"</span><span class="p">,</span><span class="n">src_pad_mask</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"tgt_pad_mask"</span><span class="p">,</span><span class="n">tgt_pad_mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt_in</span><span class="p">,</span> <span class="n">tgt_out</span><span class="p">,</span> <span class="n">src_pad_mask</span><span class="p">,</span> <span class="n">tgt_pad_mask</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 4) DataLoaderï¼šå®šä¹‰â€œå¦‚ä½•æŒ‰æ‰¹å–æ ·æœ¬â€å¹¶æ¼”ç¤ºè¾“å‡º</span>
<span class="c1"># --------------------------</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">ToyDataset</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"dataset"</span><span class="p">,</span><span class="n">dataset</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">dataset</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>        <span class="c1"># è·¨å¹³å°æ¼”ç¤ºï¼Œç”¨ 0ï¼›Linux å¯è°ƒå¤§</span>
        <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
        <span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># EPOCH=40</span>
    <span class="c1"># for epoch in range(EPOCH):</span>
    <span class="c1">#   for src, tgt_in, tgt_out, src_mask, tgt_mask in loader:</span>
        <span class="c1"># å‰å‘ã€lossã€åä¼ ã€ä¼˜åŒ–</span>
    <span class="n">total_steps</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">data_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_steps</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">tgt_in</span><span class="p">,</span> <span class="n">tgt_out</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt_mask</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">data_iter</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="c1"># å½“å‰è¿­ä»£å™¨ç”¨å°½ï¼Œé‡å»ºä¸€ä¸ªæ–°çš„ï¼ˆç›¸å½“äºè¿›å…¥æ–°ä¸€è½®ï¼‰</span>
            <span class="n">data_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">tgt_in</span><span class="p">,</span> <span class="n">tgt_out</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt_mask</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">data_iter</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"src"</span><span class="p">,</span><span class="n">src</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"tgt_in"</span><span class="p">,</span><span class="n">tgt_in</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"tgt_out"</span><span class="p">,</span><span class="n">tgt_out</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"src_mask"</span><span class="p">,</span><span class="n">src_mask</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"tgt_mask"</span><span class="p">,</span><span class="n">tgt_mask</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<ul>
<li>iter(loader): æŠŠå¯è¿­ä»£çš„ DataLoader å˜æˆâ€œæ‰¹æ¬¡è¿­ä»£å™¨â€ã€‚</li>
<li>next(iterator): ä»è¯¥è¿­ä»£å™¨ä¸­å–â€œä¸‹ä¸€ä¸ªæ‰¹æ¬¡â€ã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨å°±æ˜¯â€œç¬¬ä¸€ä¸ª batchâ€ã€‚</li>
</ul>
<div class="codehilite"><pre><span></span><code>    <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
    <span class="n">batch1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
    <span class="n">batch2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
</code></pre></div>
<p>åœ¨ shuffle=True æ—¶ï¼Œæ¯æ¬¡ iter(loader) ç›¸å½“äºå¼€å§‹â€œæ–°çš„ä¸€è½®éå†â€ï¼Œé¡ºåºä¼šé‡æ–°æ´—ç‰Œï¼›drop_lastã€num_workersã€pin_memory ç­‰å‚æ•°ä¼šå½±å“æ‰¹æ¬¡æ•°é‡ã€å¹¶è¡ŒåŠ è½½ä¸ä¼ è¾“æ€§èƒ½ã€‚</p>
<p>å½“ç„¶é™¤äº†ç”¨nextè¿­ä»£ï¼Œè¿˜æ˜¯ç”¨forå¾ªç¯çš„æ–¹å¼ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code>  <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCH</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt_in</span><span class="p">,</span> <span class="n">tgt_out</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt_mask</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">"src"</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">"tgt_in"</span><span class="p">,</span> <span class="n">tgt_in</span><span class="p">)</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">"tgt_out"</span><span class="p">,</span> <span class="n">tgt_out</span><span class="p">)</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">"src_mask"</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">)</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">"tgt_mask"</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">)</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="æ•°æ®ç»´åº¦.html">â† æ•°æ®ç»´åº¦</a>
    <a class="next" href="æ•°æ®ç»´åº¦.html">æ•°æ®ç»´åº¦ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

