<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>é™æ€ftrace - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">åŸºæœ¬åŸç†</a><ul></ul></li><li><a href="#_2">ç¼–è¯‘å®Œæˆæ’æ¡©ç‚¹</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>é™æ€ftrace</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-08-28
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><p>ä¸Šé¢ç« èŠ‚ä¸»è¦æè¿°çš„æ˜¯åŠ¨æ€ftraceï¼Œåœ¨æ—©æœŸè¿˜æœ‰é™æ€ftraceã€‚åŒºåˆ«ä¸»è¦å¦‚ä¸‹ï¼š - åŠ¨æ€ftraceä¸é™æ€ftraceåœ¨ç¼–è¯‘å‚æ•°æ–¹é¢é™æ€ç¼–è¯‘ä½¿ç”¨çš„æ˜¯å‚æ•°â€œ-pgâ€ï¼Œè€ŒåŠ¨æ€ä½¿ç”¨çš„æ˜¯fpatchable-function-entryã€‚ - å·¥å…·é“¾ä½¿èƒ½â€œ-pgâ€å‚æ•°æ—¶ï¼Œä¼šåœ¨æ¯ä¸ªå‡½æ•°ä½“å‰é¢æ’å…¥_mcountå‡½æ•°ã€‚è€ŒåŠ¨æ€ftraceä¼šåœ¨å‡½æ•°å…¥å£ï¼ˆå‡½æ•°å‡†å¤‡é˜¶æ®µå‰ï¼‰æ’å…¥nopæŒ‡ä»¤ã€‚ - é™æ€ftraceæ’å…¥çš„_mcoutç›´åˆ°ä»£ç è¿è¡ŒæœŸé—´ä¸€ç›´å­˜åœ¨ï¼Œè€ŒåŠ¨æ€ftraceåœ¨ä¸ä½¿èƒ½traceræ˜¯nopæŒ‡ä»¤ï¼ŒåŠ¨æ€ftraceå¯ä»¥åŠ¨æ€çš„ä¿®æ”¹ä»£ç ã€‚ å†…æ ¸ç¼–è¯‘æ—¶ï¼Œä½¿èƒ½CONFIG_FUNCTION_TRACERæ—¶ä¼šå¯åŠ¨è¯¥å‚æ•°ç¼–è¯‘ï¼Œåœ¨kernelç›®å½•ä¸‹çš„Makefileå¯ä»¥çœ‹åˆ°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="cp"># The arch Makefiles can override CC_FLAGS_FTRACE. We may also append it later.</span>
<span class="n">ifdef</span><span class="w"> </span><span class="n">CONFIG_FUNCTION_TRACER</span>
<span class="w">  </span><span class="nl">CC_FLAGS_FTRACE</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">pg</span>
<span class="n">endif</span>
</code></pre></div>
<h2 id="_1">åŸºæœ¬åŸç†</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ftrace_stub</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">mcount</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* save any bare state needed in order to do initial checking */</span>

<span class="w">        </span><span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ftrace_trace_function</span><span class="p">)(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ftrace_trace_function</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ftrace_stub</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">do_trace</span><span class="p">;</span>
<span class="w">        </span><span class="n">â‘ </span><span class="w"> </span><span class="n">å¦‚æœç”¨æˆ·å®šä¹‰äº†traceå‡½æ•°</span><span class="err">ï¼Œ</span><span class="n">é‚£ä¹ˆå°±è·³è½¬åˆ°do_trace</span><span class="err">ï¼Œ</span><span class="n">æ‰§è¡Œftrace_trace_function</span><span class="err">ã€‚</span><span class="n">å¦åˆ™ä»€ä¹ˆéƒ½ä¸åš</span><span class="err">ï¼Œ</span><span class="n">ç›´æ¥è¿”å›</span><span class="err">ã€‚</span>
<span class="w">        </span><span class="cm">/* restore any bare state */</span>

<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="nl">do_trace</span><span class="p">:</span>

<span class="w">        </span><span class="cm">/* save all state needed by the ABI (see paragraph above) */</span>

<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">frompc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">selfpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="k">return</span><span class="w"> </span><span class="n">address</span><span class="o">&gt;</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">MCOUNT_INSN_SIZE</span><span class="p">;</span>
<span class="w">        </span><span class="n">ftrace_trace_function</span><span class="p">(</span><span class="n">frompc</span><span class="p">,</span><span class="w"> </span><span class="n">selfpc</span><span class="p">);</span>
<span class="w">        </span><span class="n">â‘¡</span><span class="w"> </span><span class="n">è·³è½¬æ‰§è¡Œftrace_trace_function</span>
<span class="w">        </span><span class="cm">/* restore all state needed by the ABI */</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<h2 id="_2">ç¼–è¯‘å®Œæˆæ’æ¡©ç‚¹</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_0490cf5c14d6626155560b593b74cd17.jpg"><img alt="é™æ€ftrace" src="assets/doc/01-linux/æ€§èƒ½å·¥å…·/é™æ€ftrace/images/wp_editor_md_0490cf5c14d6626155560b593b74cd17.jpg"/></a></p>
<p>é€šè¿‡åæ±‡ç¼–objdump -D vmlinux &gt; logåæŸ¥çœ‹_mcountè¢«æ’å…¥åˆ°äº†vfs_readä¸­ï¼Œæ’å…¥çš„ä½ç½®åœ¨å‡½æ•°å‡†å¤‡é˜¶æ®µä¹‹åï¼Œå‡½æ•°ä½“å†…å®¹ä¹‹å‰ã€‚ç³»ç»Ÿè¿è¡Œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨gdb æŸ¥çœ‹æ±‡ç¼–æŒ‡ä»¤ï¼Œä¸ä¸Šé¢åŸºæœ¬ä¸€è‡´ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_4341ac57b9fdc51f0a5b1d5ae3d435ff.jpg"><img alt="é™æ€ftrace" src="assets/doc/01-linux/æ€§èƒ½å·¥å…·/é™æ€ftrace/images/wp_editor_md_4341ac57b9fdc51f0a5b1d5ae3d435ff.jpg"/></a></p>
<p>æˆ‘ä»¬æ¥ç€å†æŸ¥çœ‹ä»¥ä¸‹_mcountçš„å®ç°ï¼Œå¦‚ä¸‹</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/08/wp_editor_md_a94e3ba70c9625257801cb18222e6387.jpg"><img alt="é™æ€ftrace" src="assets/doc/01-linux/æ€§èƒ½å·¥å…·/é™æ€ftrace/images/wp_editor_md_a94e3ba70c9625257801cb18222e6387.jpg"/></a></p></div>
  <div class="post-nav">
    <a class="prev" href="åŠ¨æ€function-traceråŸç†.html">â† åŠ¨æ€function traceråŸç†</a>
    <a class="next" href="ftrace-æ¦‚è¿°.html">ftrace-æ¦‚è¿° â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

