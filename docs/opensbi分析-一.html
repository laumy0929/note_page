<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>opensbiåˆ†æï¼ˆä¸€ï¼‰ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#hart">å¼•å¯¼Hartå¯åŠ¨</a><ul></ul></li><li><a href="#_1">é‡å®šä½å’Œåˆå§‹åŒ–</a><ul><li><a href="#_2">é¢„å¤‡ä¿¡æ¯</a></li></ul></li><li><a href="#_3">çŠ¶æ€åˆå§‹åŒ–</a><ul></ul></li><li><a href="#_4">åˆå§‹åŒ–å¹³å°</a><ul></ul></li><li><a href="#sbi_scratch">åˆå§‹åŒ–sbi_scratch</a><ul></ul></li><li><a href="#fdt">FDTé‡å®šä½</a><ul></ul></li><li><a href="#boot-hard">boot hardå¯åŠ¨å®Œæˆ</a><ul></ul></li><li><a href="#boot-hart">éboot hartç­‰å¾…è¿è¡Œ</a><ul></ul></li><li><a href="#hart_1">hart çƒ­å¯åŠ¨</a><ul></ul></li><li><a href="#_5">å°ç»“</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>opensbiåˆ†æï¼ˆä¸€ï¼‰</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-05-16
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      risc-v
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="hart">å¼•å¯¼Hartå¯åŠ¨</h2>
<div class="codehilite"><pre><span></span><code><span class="nl">_start</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/* Find preferred boot HART id */</span>
<span class="w">    </span><span class="n">MOV_3R</span><span class="w">  </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>
<span class="w">    </span><span class="cp"># å°†a0,a1,a2çš„å‚æ•°åˆ†åˆ«èµ‹å€¼ä¸ºs0,s1,s2,è¿™3ä¸ªå‚æ•°æ˜¯å‰ä¸€é˜¶æ®µä¼ å…¥çš„å‚æ•°ã€‚</span>
<span class="w">    </span><span class="cp"># a0: hart id</span>
<span class="w">    </span><span class="cp"># a1: device tree</span>
<span class="w">    </span><span class="cp"># a2: struct fw_dynamic_infoåœ°å€</span>

<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">fw_boot_hart</span>
<span class="w">    </span><span class="cp"># fw_boot_hartä¼šæ ¹æ®é…ç½®ä¸ºfw_dynamicã€fw_jumpã€fw_payloadä¸‰ç§æ–¹å¼è¿›è¡Œè·³è½¬ï¼Œ</span>
<span class="w">    </span><span class="cp"># åä¸¤ç§æ–¹å¼ç›´æ¥è¿”å›-1ï¼Œå³hart idä½¿ç”¨éšæœºçš„æ–¹å¼ï¼Œè€Œfw_dynamicæ ¹æ®ä¼ è¿›æ¥çš„å‚æ•°</span>
<span class="w">    </span><span class="cp"># è¿›è¡Œè§£æå‡ºboot hart idï¼Œa2æŒ‡å‘struct fw_dynamic_info</span>
<span class="w">    </span><span class="cp"># æˆ‘ä»¬è¿™é‡Œåˆ†æä½¿ç”¨çš„æ˜¯fw_jumpçš„æ–¹å¼ã€‚</span>

<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">a6</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="cp"># å°†ç»è¿‡fw_boot_harté€‰æ‹©çš„hart idèµ‹å€¼ä¸ºa6ï¼Œè¿™æ ·a6ä¿å­˜çš„å°±æ˜¯é¦–å…ˆè¦å¯åŠ¨çš„hart id</span>

<span class="w">    </span><span class="n">MOV_3R</span><span class="w">  </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span>
<span class="w">    </span><span class="cp"># æ¢å¤a0,a1,a2çš„å€¼ï¼Œä¹‹å‰æ˜¯æš‚å­˜åˆ°s0,s1,s2ä¸­ï¼Œå› ä¸ºå‰é¢è°ƒç”¨äº†fw_boot_hartä¼šä¿®æ”¹</span>

<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">a7</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span>
<span class="w">    </span><span class="n">beq</span><span class="w"> </span><span class="n">a6</span><span class="p">,</span><span class="w"> </span><span class="n">a7</span><span class="p">,</span><span class="w"> </span><span class="n">_try_lottery</span>
<span class="w">    </span><span class="cp"># å¦‚æœa6ä¸º-1,å³ä¸Šä¸€é˜¶æ®µæ²¡æœ‰é€‰å®šboot hard idï¼Œåˆ™ä½¿ç”¨å½©ç¥¨æœºåˆ¶éšæœºé€‰æ‹©ä¸€ä¸ª</span>
<span class="w">    </span><span class="cp"># hard idè¿›è¡Œå…ˆå¯åŠ¨ã€‚</span>

<span class="w">    </span><span class="cm">/* Jump to relocation wait loop if we are not boot hart */</span>
<span class="w">    </span><span class="n">bne</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a6</span><span class="p">,</span><span class="w"> </span><span class="n">_wait_relocate_copy_done</span>
<span class="w">    </span><span class="cp"># å¦‚æœé€‰æ‹©çš„boot hard idä¸å½“å‰è¿è¡Œçš„hart idä¸ç­‰ï¼Œåˆ™è¿›è¡Œç­‰å¾…boot hart idå…ˆè¿è¡Œã€‚</span>

<span class="nl">_try_lottery</span><span class="p">:</span><span class="err">ï¼ˆ</span><span class="n">å½©ç¥¨æœºåˆ¶é€‰æ‹©ä¸€ä¸ªhart</span><span class="w"> </span><span class="n">idä½œä¸ºå¯åŠ¨hart</span><span class="err">ï¼‰</span>
<span class="w">    </span><span class="cm">/* Jump to relocation wait loop if we don't get relocation lottery */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">a6</span><span class="p">,</span><span class="w"> </span><span class="n">_relocate_lottery</span>
<span class="w">    </span><span class="cp"># åŠ è½½_relocate_lotteryï¼ˆæ˜¯ä¸€æ®µbssç©ºé—´ï¼‰åˆ°a6å¯„å­˜</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">a7</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">amoadd</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="n">a6</span><span class="p">,</span><span class="w"> </span><span class="n">a7</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a6</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># a6æŒ‡å‘çš„åœ°å€ä¸Šçš„å€¼ï¼ˆ_relocate_lottery çš„åœ°å€ï¼‰åšåŸå­åŠ  1ï¼Œ</span>
<span class="w">    </span><span class="cp"># _relocate_lottery çš„è€å€¼å†™å…¥a6ï¼ˆæœ€åŸå§‹çš„å€¼ä¸º0ï¼‰ã€‚</span>
<span class="w">    </span><span class="n">bnez</span><span class="w">    </span><span class="n">a6</span><span class="p">,</span><span class="w"> </span><span class="n">_wait_relocate_copy_done</span>
<span class="w">    </span><span class="cp"># å¦‚æœa6ä¸ç­‰äº0ï¼Œè¡¨ç¤ºä¸æ˜¯æœ€å…ˆæ‰§è¡Œçš„hartï¼Œåˆ™è·³è½¬åˆ°_wait_relocate_copy_done</span>
<span class="w">    </span><span class="cp"># ç­‰å¾…ï¼Œå¦‚æœç­‰äº0ï¼Œè¡¨ç¤ºæœ€å¿«è¿è¡Œçš„hartï¼Œåˆ™ä¸ºboot hartå¾€ä¸‹èµ°</span>
<span class="w">    </span><span class="cp"># ä¸å…¶è¯´æ˜¯å½©ç¥¨æœºåˆ¶ï¼Œçœ‹èµ·æ¥æ˜¯èµ›è·‘æœºåˆ¶ï¼Œæœ€å…ˆè·‘åˆ°è¿™æ®µä»£ç çš„ä½œä¸ºboot hart</span>
</code></pre></div>
<p>ä¸Šé¢çš„ä»£ç ï¼Œä¸»è¦æ˜¯è·å–ä¸€ä¸ªhart ä½œä¸ºboot hartï¼Œé€‰å®šäº†boot hartåï¼Œå…¶ä»–çš„hartå°±éœ€è¦ç­‰å¾…boot hartå…ˆè¿è¡Œå®Œæˆç›¸å…³åˆå§‹åŒ–å·¥ä½œå†è¿è¡Œã€‚å¦‚æœopensbiä½¿ç”¨çš„æ˜¯fw_jumpã€fw_payloadï¼Œé€‰æ‹©boot hartçš„æ–¹å¼å°±æ˜¯å½©ç¥¨æœºåˆ¶ã€‚</p>
<h2 id="_1">é‡å®šä½å’Œåˆå§‹åŒ–</h2>
<h3 id="_2">é¢„å¤‡ä¿¡æ¯</h3>
<h4 id="_fw_start">_fw_start</h4>
<p>_fw_startçš„å€¼ï¼Œåœ¨é“¾æ¥è„šæœ¬ build/platform/generic/firmware/fw_jump.elf.ldä¸­æŒ‡å®š <a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_9c3807da2c0941724b7dbfc629354ac2.jpg"><img alt="" src="assets/doc/02-risc-v/opensbiåˆ†æï¼ˆä¸€ï¼‰/images/wp_editor_md_9c3807da2c0941724b7dbfc629354ac2.jpg"/></a></p>
<p>ä»é€šè¿‡å·¥å…·é“¾è¯»å–åˆ°_fw_startä¸º0x80000000,å¦‚ä¸‹ï¼š</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_2b32ae0fe9b5e437f62b9d2e48fff47d.jpg"><img alt="" src="assets/doc/02-risc-v/opensbiåˆ†æï¼ˆä¸€ï¼‰/images/wp_editor_md_2b32ae0fe9b5e437f62b9d2e48fff47d.jpg"/></a></p>
<h4 id="reladyn">.rela.dyn</h4>
<p>.rela.dynæ˜¯é‡å®šä½æ®µï¼Œé‡å®šä½æ˜¯è¿æ¥ç¬¦å·å¼•ç”¨ä¸ç¬¦å·å®šä¹‰çš„è¿‡ç¨‹ã€‚ä¾‹å¦‚ï¼Œç¨‹åºè°ƒç”¨å‡½æ•°æ—¶ï¼Œå…³è”çš„è°ƒç”¨æŒ‡ä»¤å¿…é¡»åœ¨æ‰§è¡Œæ—¶å°†æ§åˆ¶æƒè½¬ç§»åˆ°æ­£ç¡®çš„ç›®æ ‡åœ°å€ã€‚å¯é‡å®šä½æ–‡ä»¶å¿…é¡»åŒ…å«è¯´æ˜å¦‚ä½•ä¿®æ”¹å…¶èŠ‚å†…å®¹çš„ä¿¡æ¯ã€‚é€šè¿‡æ­¤ä¿¡æ¯ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶å¯åŒ…å«è¿›ç¨‹çš„ç¨‹åºæ˜ åƒçš„æ­£ç¡®ä¿¡æ¯ã€‚é‡å®šä½é¡¹å³æ˜¯è¿™äº›æ•°æ®ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">elf32_rela</span><span class="p">{</span>
<span class="w">  </span><span class="n">Elf32_Addr</span><span class="w">    </span><span class="n">r_offset</span><span class="p">;</span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w">    </span><span class="n">r_info</span><span class="p">;</span>
<span class="w">  </span><span class="n">Elf32_Sword</span><span class="w">   </span><span class="n">r_addend</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">Elf32_Rela</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">elf64_rela</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Elf64_Addr</span><span class="w"> </span><span class="n">r_offset</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Location at which to apply the action */</span>
<span class="w">  </span><span class="n">Elf64_Xword</span><span class="w"> </span><span class="n">r_info</span><span class="p">;</span><span class="w">   </span><span class="cm">/* index and type of relocation */</span>
<span class="w">  </span><span class="n">Elf64_Sxword</span><span class="w"> </span><span class="n">r_addend</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Constant addend used to compute value */</span>
<span class="p">}</span><span class="w"> </span><span class="n">Elf64_Rela</span><span class="p">;</span>
</code></pre></div>
<p>é‡å®šä½è¡¨çš„æ¯ä¸ªæ¡ç›®çš„å†…å®¹å¦‚ä¸Šæ•°æ®ç»“æ„æ‰€ç¤ºï¼Œæœ‰3ä¸ªå˜é‡ã€‚</p>
<ul>
<li>r_offset: éœ€è¦é‡å®šä½åœ°å€çš„åç§»ï¼Œå¤–éƒ¨ç¬¦å·åœ¨gotè¡¨çš„åç§»</li>
<li>r_r_info: é‡å®šä½çš„æ–¹æ³•</li>
<li>r_addendï¼šé‡å®šä½è®¡ç®—çš„å€¼</li>
</ul>
<p>ä½¿ç”¨ riscv64-unknown-linux-gnu-readelf -S build/platform/generic/firmware/fw_jump.elfå‘½ä»¤å¯ä»¥çœ‹åˆ°é‡å®šä½è¡¨çš„åœ°å€ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_053503180c2ea4d7d1a4daae09be0ec3.jpg"><img alt="" src="assets/doc/02-risc-v/opensbiåˆ†æï¼ˆä¸€ï¼‰/images/wp_editor_md_053503180c2ea4d7d1a4daae09be0ec3.jpg"/></a></p>
<p>å¦‚ä¸Šå›¾.rela.dynçš„åœ°å€ä¸º0x8001c3a8ï¼Œé•¿åº¦ä¸º0x2418ã€‚</p>
<p>æ‰§è¡Œriscv64-unknown-linux-gnu-readelf -rW build/platform/generic/firmware/fw_jump.elfå¯ä»¥æŸ¥çœ‹é‡å®šä½ä¿¡æ¯è¡¨ã€‚ <a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_a334cd8ead484a4434f97d55a5abea15.jpg"><img alt="" src="assets/doc/02-risc-v/opensbiåˆ†æï¼ˆä¸€ï¼‰/images/wp_editor_md_a334cd8ead484a4434f97d55a5abea15.jpg"/></a></p>
<p>ä¸Šå›¾æ‰€ç¤ºï¼Œfw_jump.elfçš„é‡å®šä½è¡¨ä¸­æœ‰385ä¸ªæ¡ç›®ï¼Œå³æœ‰385ä¸ªåœ°å€éœ€è¦é‡å®šä½ï¼Œä¸Šå›¾ä¸­r_infoæ˜¯0x3,å³ç±»å‹æ˜¯R_RISCV_RELATIVEï¼Œåˆ™é‡å®šä½æ–¹å¼æ˜¯æŒ‰ç…§B+Aï¼ŒBè¡¨ç¤ºæ‰§è¡Œè¿‡ç¨‹ä¸­å°†å…±äº«ç›®æ ‡æ–‡ä»¶è£…å…¥å†…å­˜çš„åŸºæœ¬åœ°å€ï¼Œé€šå¸¸ç”Ÿæˆçš„å…±äº«ç›®æ ‡æ–‡ä»¶çš„åŸºæœ¬è™šæ‹Ÿåœ°å€ä¸º0ï¼Œåœ¨æœ¬èŠ‚ä¸­Bä¸º_fw_start - FW_TEXT_STARTï¼›Aè¡¨ç¤ºå¸¸é‡åŠ æ•°ï¼Œç”¨äºè®¡ç®—å­˜å‚¨åœ¨å¯é‡å®šä½å­—æ®µä¸­çš„å€¼ï¼Œå³r_addendçš„å€¼ï¼Œæ‰€ä»¥0x80020018çš„åœ°å€é‡å®šä½åˆ°0x80000000ã€‚</p>
<p>æ€ä¹ˆç†è§£_fw_start å’Œ FW_TEXT_STARTåœ°å€ï¼Ÿ</p>
<ul>
<li>_fw_startè¡¨ç¤ºåŠ è½½åœ°å€</li>
<li>FW_TEXT_STARTè¡¨ç¤ºé“¾æ¥åœ°å€</li>
</ul>
<p>åœ¨opensbi 1.2ç‰ˆæœ¬ï¼Œ_fw_startå’ŒFW_TEXT_STARTæ˜¯ä¸€æ ·çš„ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_da1a1fd18d1fc19cf1244668f42433bf.jpg"><img alt="" src="assets/doc/02-risc-v/opensbiåˆ†æï¼ˆä¸€ï¼‰/images/wp_editor_md_da1a1fd18d1fc19cf1244668f42433bf.jpg"/></a></p>
<p>OpenSBIåœ¨ä»€ä¹ˆæ—¶å€™å¼•å…¥çš„PIEæ”¯æŒï¼Ÿ</p>
<p>åœ¨1.0ç‰ˆæœ¬å¼•å…¥çš„ï¼Œ<a href="https://github.com/riscv-software-src/opensbi/commit/0f20e8a?diff=split&amp;w=0">https://github.com/riscv-software-src/opensbi/commit/0f20e8a?diff=split&amp;w=0</a></p>
<ul>
<li>é“¾æ¥è„šæœ¬åŒ…å«.rela.dynèŠ‚ï¼Œè¯¥èŠ‚ä¸­çš„æ‰€æœ‰é‡å®šä½è¡¨é¡¹å‡æ˜¯R_RISCV_RELATIVEç±»å‹ã€‚</li>
<li>Self-relocataionå‘ç”Ÿåœ¨éå¸¸æ—©æœŸçš„æ±‡ç¼–ä»£ç é˜¶æ®µfirmware/fw_base.S</li>
<li>éå†.rela.dynèŠ‚é‡Œçš„æ‰€æœ‰é‡å®šä½è¡¨é¡¹ï¼Œè¿›è¡Œåœ°å€ä¿®æ­£</li>
<li>åœ¨é‡å®šä½å®Œæˆä¹‹å‰ï¼Œæ‰€æœ‰å¯¹å…¨å±€å˜é‡çš„åœ°å€å¼•ç”¨ï¼Œéœ€è¦æ˜¾å¼ä½¿ç”¨llaæ±‡ç¼–ä¼ªæŒ‡ä»¤ï¼ˆload local addressï¼‰è€Œä¸æ˜¯la</li>
<li>laåœ¨PIEæ¨¡å¼ä¸‹ä¼šç¼–è¯‘æˆå¯¹GOTè¡¨çš„å¼•ç”¨ã€‚</li>
</ul>
<p>rela.dynå’Œ.rel.dynæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<p>.rel.dyn å’Œ .rela.dyn éƒ½æ˜¯ ELF æ–‡ä»¶ä¸­ç”¨äºå­˜å‚¨é‡å®šä½æ¡ç›®çš„èŠ‚ï¼ˆsectionï¼‰ï¼Œå®ƒä»¬ä¸»è¦ç”¨äºåŠ¨æ€é“¾æ¥è¿‡ç¨‹ä¸­ä¿®æ­£å…¨å±€åç§»è¡¨ï¼ˆGOT, Global Offset Tableï¼‰å’Œç¨‹åºä¸­çš„æŸäº›åœ°å€ã€‚ä¸è¿‡ï¼Œå®ƒä»¬ä¹‹é—´å­˜åœ¨ä¸€äº›å…³é”®å·®å¼‚ï¼š</p>
<p>ï¼ˆ1ï¼‰æ•°æ®ç»“æ„ä¸åŒï¼š.rel.dyn ä½¿ç”¨çš„æ˜¯ REL ç±»å‹çš„é‡å®šä½æ¡ç›®ï¼Œæ¯ä¸ªæ¡ç›®åŒ…å«ä¸¤ä¸ªå­—æ®µï¼šä¸€ä¸ªè¡¨ç¤ºéœ€è¦è¢«é‡å®šä½çš„ä½ç½®çš„åç§»é‡ï¼Œå¦ä¸€ä¸ªè¡¨ç¤ºé‡å®šä½ç±»å‹ã€‚ .rela.dyn ä½¿ç”¨çš„æ˜¯ RELA ç±»å‹çš„é‡å®šä½æ¡ç›®ï¼Œåœ¨ REL ç±»å‹çš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€ä¸ª additive constant å­—æ®µï¼Œä½¿å¾—é‡å®šä½æ“ä½œå¯ä»¥ç›´æ¥åº”ç”¨ä¸€ä¸ªç«‹å³æ•°åˆ°ç›®æ ‡ä½ç½®ï¼Œè€Œä¸éœ€è¦åƒ REL é‚£æ ·è¿›è¡Œé—´æ¥è®¡ç®—ã€‚è¿™æ„å‘³ç€ RELA ç±»å‹æä¾›äº†æ›´ç›´æ¥çš„é‡å®šä½èƒ½åŠ›ã€‚ ï¼ˆ2ï¼‰å†…å­˜å ç”¨å’Œæ•ˆç‡ï¼šRELA ç±»å‹ç”±äºåŒ…å«é¢å¤–çš„ additive constant å­—æ®µï¼Œæ‰€ä»¥æ¯ä¸ªæ¡ç›®ç›¸æ¯” REL ç±»å‹ä¼šå ç”¨æ›´å¤šçš„ç©ºé—´ã€‚ç„¶è€Œï¼ŒRELA ç±»å‹åœ¨å¤„ç†æ—¶å¯èƒ½å› ä¸ºç›´æ¥æ€§è€Œç¨å¾®æé«˜æ•ˆç‡ï¼Œå› ä¸ºå®ƒå‡å°‘äº†å¤„ç†å™¨éœ€è¦æ‰§è¡Œçš„è®¡ç®—æ­¥éª¤ã€‚ ï¼ˆ3ï¼‰ä½¿ç”¨åœºæ™¯ï¼šåœ¨ä¸åŒçš„ç³»ç»Ÿæˆ–ç¼–è¯‘å™¨é…ç½®ä¸‹ï¼Œå¯èƒ½ä¼šä¼˜å…ˆé€‰æ‹©ä½¿ç”¨å…¶ä¸­ä¸€ç§ç±»å‹ã€‚é€šå¸¸ï¼Œç°ä»£ç³»ç»Ÿå’Œç¼–è¯‘å™¨æ›´å€¾å‘äºä½¿ç”¨ .rela.dynï¼Œå› ä¸ºå®ƒè™½ç„¶å ç”¨æ›´å¤šç©ºé—´ï¼Œä½†æä¾›çš„ç›´æ¥é‡å®šä½èƒ½åŠ›ç®€åŒ–äº†é“¾æ¥è¿‡ç¨‹ã€‚ æ€»çš„æ¥è¯´ï¼Œ.rel.dyn å’Œ .rela.dyn éƒ½æœåŠ¡äºåŠ¨æ€é“¾æ¥æ—¶çš„åœ°å€ä¿®æ­£ï¼Œä¸»è¦åŒºåˆ«åœ¨äºé‡å®šä½æ¡ç›®çš„æ ¼å¼åŠå…¶å¯¹ç©ºé—´å’Œå¤„ç†æ•ˆç‡çš„å½±å“ã€‚åœ¨å…·ä½“åº”ç”¨ä¸­ï¼Œæ ¹æ®ç¼–è¯‘å™¨é€‰é¡¹å’Œç›®æ ‡ç³»ç»Ÿçš„åå¥½ï¼Œä¼šé€‰æ‹©ä½¿ç”¨å…¶ä¸­ä¹‹ä¸€æ¥å®ŒæˆåŠ¨æ€é“¾æ¥æ‰€éœ€çš„é‡å®šä½å·¥ä½œã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="cm">/* Save load address */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">_load_start</span>
<span class="w">    </span><span class="cp"># åŠ è½½åœ°å€å­˜å‚¨åˆ°t0å¯„å­˜å™¨ï¼š0x0000000080020018</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">_fw_start</span>
<span class="w">    </span><span class="cp"># _fw_startå­˜å‚¨åˆ°t1å¯„å­˜å™¨ï¼št1ç‰‡=0x0000000080000000</span>
<span class="w">    </span><span class="cp"># _fw_startä¸ºé“¾æ¥è„šæœ¬ä¸­è®¾å®šçš„èµ·å§‹åœ°å€</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># REG_Sæ˜¯sdï¼Œå³t1çš„å€¼å­˜å‚¨åˆ°t0çš„åœ°å€</span>
<span class="w">    </span><span class="cp"># å¯ä»¥ç†è§£ä¸º_load_startæ˜¯ä¸€ä¸ªå…¨å±€æŒ‡é’ˆï¼ˆæŒ‡å‘äº‹å…ˆåˆ†é…çš„ç©ºé—´ï¼‰ï¼Œå°†fw_jump.elf</span>
<span class="w">    </span><span class="cp"># çš„èµ·å§‹åœ°å€å³ï¼Œåœ¨é“¾æ¥è„šæœ¬ä¸­è®¾ç½®çš„èµ‹å€¼_load_startä¸­å­˜å‚¨ã€‚</span>

<span class="cp">#ifdef FW_PIC</span>
<span class="w">    </span><span class="cm">/* relocate the global table content */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">_link_start</span>
<span class="w">    </span><span class="cp"># _link_startå­˜å‚¨åˆ°t0å¯„å­˜å™¨ï¼št0 = 0x0000000080020020</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># å°†t0åœ°å€çš„å€¼åŠ è½½åˆ°t0,t0=0x0000000080000000ï¼Œ</span>
<span class="w">    </span><span class="cp"># _link_startæŒ‡å‘ä¸€ä¸ªdwordå…¨å±€å˜é‡çš„æŒ‡é’ˆï¼ŒæŒ‡å‘çš„æ˜¯FW_TEXT_START</span>
<span class="w">    </span><span class="cp"># åœ¨firmware/fw_base.Sä¸­å¦‚ä¸‹å®šä¹‰</span>
<span class="w">    </span><span class="cp">#  _link_start:gg</span>
<span class="w">    </span><span class="cp">#  RISCV_PTR   FW_TEXT_START</span>
<span class="w">    </span><span class="cp"># æ‰€ä»¥ä¸Šé¢ä»£ç çš„æ„æ€å°±æ˜¯å°†FW_TEXT_STARTèµ‹å€¼ä¸ºt0,FW_TEXT_STARTåœ¨</span>
<span class="w">    </span><span class="cp"># platform/generic/objects.mkä¸­å®šä¹‰ï¼Œè¡¨ç¤ºFW TEXTæ®µçš„å¼€å§‹åœ°å€</span>
<span class="w">    </span><span class="cp"># æ­£å¥½ä¹Ÿæ˜¯FW_TEXT_START=0x80000000</span>
<span class="w">    </span><span class="cp"># FW_TEXT_STARTè®¾ç½®çš„æ˜¯å›ºä»¶è¦è¿è¡Œçš„èµ·å§‹åœ°å€ï¼Œè€Œ_fw_startæ˜¯é“¾æ¥åœ°å€</span>

<span class="w">    </span><span class="cm">/* t1 shall has the address of _fw_start */</span>
<span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>
<span class="w">    </span><span class="cp"># t2 = _fw_start - FW_TEXT_STARTï¼Œè®¡ç®—è¦è¿è¡Œåœ°å€å’Œé“¾æ¥åœ°å€çš„å·®å€¼</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">_runtime_offset</span>
<span class="w">    </span><span class="cp"># t3 = 0x0000000080020060,ç”³è¯·çš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼ˆbssç©ºé—´ï¼‰</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">t3</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># å°†è¿è¡Œçš„åœ°å€ä¸é“¾æ¥åœ°å€çš„åç§»å­˜å‚¨åˆ°_runtime_offsetæŒ‡å‘çš„åœ°å€ä¸­</span>

<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">__rel_dyn_start</span>
<span class="w">    </span><span class="cp"># é‡å®šä½è¡¨å¼€å§‹åœ°å€ï¼š0x000000008001c3a8</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">__rel_dyn_end</span>
<span class="w">    </span><span class="cp"># é‡å®šä½è¡¨çš„ç»“æŸåœ°å€ï¼š0x000000008001e7c0</span>
<span class="w">    </span><span class="cp"># ç»“æŸåœ°å€å‡å»èµ·å§‹åœ°å€æ­£å¥½sizeä¸º0x2418,è·Ÿå‰é¢ç« èŠ‚å¯¹åº”ã€‚</span>

<span class="w">    </span><span class="n">beq</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">_relocate_done</span>
<span class="w">    </span><span class="n">j</span><span class="w">   </span><span class="mf">5f</span>
<span class="w">    </span><span class="cp"># å¦‚æœé‡å®šä½è¡¨çš„å¼€å§‹åœ°å€ç­‰äºç»“æŸåœ°å€ï¼Œè¯´æ˜ä¸éœ€è¦é‡å®šä½ï¼Œç›´æ¥è·³è½¬åˆ°</span>
<span class="w">    </span><span class="cp"># _relocate_doneç»“æŸé‡å®šä½ï¼Œå¦åˆ™è·³è½¬åˆ°5æ ‡ç­¾è¿›è¡Œé‡å®šä½ã€‚</span>
<span class="mi">2</span><span class="o">:</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">REGBYTES</span><span class="o">*</span><span class="mi">2</span><span class="p">)(</span><span class="n">t0</span><span class="p">)</span><span class="w">   </span><span class="cm">/* t5 &lt;-- relocation info:type */</span>
<span class="w">    </span><span class="cp"># REG_Lä¸ºldï¼Œt0-16åœ°å€æŒ‡å‘æ¡ç›®çš„ç¬¬äºŒä¸ªæˆå‘˜å˜é‡å³info type</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">R_RISCV_RELATIVE</span><span class="w">    </span><span class="cm">/* reloc type R_RISCV_RELATIVE */</span>
<span class="w">    </span><span class="n">bne</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="mf">3f</span>
<span class="w">    </span><span class="cp"># å¦‚æœinfo typeä¸æ˜¯R_RISCV_RELATIVEç±»å‹ï¼Œåˆ™è·³è½¬åˆ°æ ‡ç­¾</span>
<span class="w">    </span><span class="cp"># æ¥ä¸‹æ¥å°±æ˜¯å¤„ç†info typeä¸ºR_RISCV_RELATIVEçš„é‡å®šä½</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">REGBYTES</span><span class="o">*</span><span class="mi">3</span><span class="p">)(</span><span class="n">t0</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># è·å–é‡å®šä½è¡¨ä¸€ä¸ªæ¡ç›®ä¸­offsetçš„å€¼å­˜å‚¨åˆ°t3</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">REGBYTES</span><span class="p">)(</span><span class="n">t0</span><span class="p">)</span><span class="w"> </span><span class="cm">/* t5 &lt;-- addend */</span>
<span class="w">    </span><span class="cp"># è·å–é‡å®šä½è¡¨ä¸€ä¸ªæ¡ç›®ä¸­addendå€¼</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span>
<span class="w">    </span><span class="cp"># å³é‡å®šä½åœ°å€ä¸ºB+Aï¼ŒAä¸ºaddendå€¼ï¼ŒB=_fw_start - FW_TEXT_START</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">t3</span><span class="p">)</span><span class="w">       </span><span class="cm">/* store runtime address to the GOT entry */</span>
<span class="w">    </span><span class="cp"># å°†é‡å®šä½çš„åœ°å€æ›´æ–°åˆ°GOTè¡¨ä¸­å»ã€‚</span>
<span class="w">    </span><span class="n">j</span><span class="w">   </span><span class="mf">5f</span>
<span class="w">    </span><span class="cp"># è·³è½¬åˆ°æ ‡ç­¾5ç»§ç»­å¾ªç¯ï¼Œå°†æ‰€æœ‰çš„é‡å®šä½æ¡ç›®æ›´æ–°åˆ°GOTè¡¨ä¸­å»ã€‚</span>

<span class="w">    </span><span class="cp"># æ ‡ç­¾3å’Œ4æ˜¯é’ˆå¯¹info typeä¸æ˜¯R_RISCV_RELATIVEçš„å¤„ç†ï¼Œè¿™é‡Œå°±ä¸å†åˆ†æäº†ã€‚</span>
<span class="mi">3</span><span class="o">:</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">t4</span><span class="p">,</span><span class="w"> </span><span class="n">__dyn_sym_start</span>
<span class="mi">4</span><span class="o">:</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">REGBYTES</span><span class="o">*</span><span class="mi">2</span><span class="p">)(</span><span class="n">t0</span><span class="p">)</span><span class="w">   </span><span class="cm">/* t5 &lt;-- relocation info:type */</span>
<span class="w">    </span><span class="n">srli</span><span class="w">    </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">SYM_INDEX</span><span class="w">   </span><span class="cm">/* t6 &lt;--- sym table index */</span>
<span class="w">    </span><span class="n">andi</span><span class="w">    </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFF</span><span class="w">        </span><span class="cm">/* t5 &lt;--- relocation type */</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">RELOC_TYPE</span>
<span class="w">    </span><span class="n">bne</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="mf">5f</span>
<span class="w">    </span><span class="cm">/* address R_RISCV_64 or R_RISCV_32 cases*/</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">REGBYTES</span><span class="o">*</span><span class="mi">3</span><span class="p">)(</span><span class="n">t0</span><span class="p">)</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">SYM_SIZE</span>
<span class="w">    </span><span class="n">mul</span><span class="w"> </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="n">t5</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">s5</span><span class="p">,</span><span class="w"> </span><span class="n">t4</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">REGBYTES</span><span class="p">)(</span><span class="n">t0</span><span class="p">)</span><span class="w"> </span><span class="cm">/* t0 &lt;-- addend */</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">REGBYTES</span><span class="p">(</span><span class="n">s5</span><span class="p">)</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="w">      </span><span class="cm">/* t5 &lt;-- location to fix up in RAM */</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="w">      </span><span class="cm">/* t3 &lt;-- location to fix up in RAM */</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">t3</span><span class="p">)</span><span class="w">       </span><span class="cm">/* store runtime address to the variable */</span>

<span class="mi">5</span><span class="o">:</span>
<span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">REGBYTES</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># REGBYTESåœ¨64ä½ç³»ç»Ÿä¸º8å­—èŠ‚å¤§å°ï¼Œ__rel_dyn_startåç§»3ä¸ªå˜é‡ï¼Œå³24å­—èŠ‚å¤§å°</span>
<span class="w">    </span><span class="cp"># æ­£å¥½å°±æ˜¯ä¸€ä¸ªæ¡ç›®çš„å¤§å°ï¼ˆElf64_Relaæ•°æ®ç»“æ„ï¼‰ã€‚</span>
<span class="w">    </span><span class="n">ble</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="n">b</span>
<span class="w">    </span><span class="cp"># å¦‚æœt0åŠ äº†ä¸€ä¸ªæ¡ç›®çš„å¤§å°è¿˜å°äº__rel_dyn_endåˆ™è·³è½¬åˆ°2æ ‡ç­¾ã€‚</span>

<span class="w">    </span><span class="n">j</span><span class="w">   </span><span class="n">_relocate_done</span>
<span class="nl">_wait_relocate_copy_done</span><span class="p">:</span>
<span class="w">    </span><span class="n">j</span><span class="w">   </span><span class="n">_wait_for_boot_hart</span>

<span class="nl">_relocate_done</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Mark relocate copy done</span>
<span class="cm">     * Use _boot_status copy relative to the load address</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">_boot_status</span>
<span class="w">    </span><span class="cp"># t0 = 0x0000000080020010</span>
<span class="cp">#ifndef FW_PIC</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">_link_start</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">_load_start</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
<span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">BOOT_STATUS_RELOCATE_DONE</span>
<span class="w">    </span><span class="cp"># t1 = 1</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># å°†1 å†™åˆ°_boot_statusæŒ‡å‘çš„åœ°å€</span>
<span class="w">    </span><span class="n">fence</span><span class="w">   </span><span class="n">rw</span><span class="p">,</span><span class="w"> </span><span class="n">rw</span>
<span class="w">    </span><span class="cp"># å»ºç«‹ä¸€ä¸ªå…¨å±€å†…å­˜å±éšœï¼Œç¡®ä¿è¯¥æŒ‡ä»¤æ‰§è¡Œå‰åï¼Œæ‰€æœ‰å†™æ“ä½œéƒ½å®Œæˆå®Œæˆã€‚</span>
<span class="w">    </span><span class="cp"># _relocate_doneçš„ä½œç”¨å°±æ˜¯å†™ä¸€ä¸ªæ ‡å¿—ä½åˆ°_boot_statusè¡¨ç¤ºé‡å®šä½</span>
<span class="w">    </span><span class="cp"># å·²ç»å®Œæˆã€‚</span>
</code></pre></div>
<h2 id="_3">çŠ¶æ€åˆå§‹åŒ–</h2>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="cm">/* At this point we are running from link address */</span>

<span class="w">    </span><span class="cm">/* Reset all registers for boot HART */</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">ra</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">_reset_regs</span>
<span class="w">    </span><span class="cp"># æ¸…é™¤æ‰€æœ‰çš„å¯„å­˜å™¨</span>

<span class="w">    </span><span class="cm">/* Zero-out BSS */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">s4</span><span class="p">,</span><span class="w"> </span><span class="n">_bss_start</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">s5</span><span class="p">,</span><span class="w"> </span><span class="n">_bss_end</span>
<span class="nl">_bss_zero</span><span class="p">:</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">s4</span><span class="p">)</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">s4</span><span class="p">,</span><span class="w"> </span><span class="n">s4</span><span class="p">,</span><span class="w"> </span><span class="n">__SIZEOF_POINTER__</span>
<span class="w">    </span><span class="n">blt</span><span class="w"> </span><span class="n">s4</span><span class="p">,</span><span class="w"> </span><span class="n">s5</span><span class="p">,</span><span class="w"> </span><span class="n">_bss_zero</span>
<span class="w">    </span><span class="cp"># æ¸…é™¤BSSæ®µï¼ŒBSSæ®µå†™0</span>

<span class="w">    </span><span class="cm">/* Setup temporary trap handler */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">s4</span><span class="p">,</span><span class="w"> </span><span class="n">_start_hang</span>
<span class="w">    </span><span class="n">csrw</span><span class="w">    </span><span class="n">CSR_MTVEC</span><span class="p">,</span><span class="w"> </span><span class="n">s4</span>
<span class="w">    </span><span class="cp"># è®¾ç½®ä¸´æ—¶çš„trap handleï¼Œé‡Œé¢ç›´æ¥è¿›å…¥WFI</span>

<span class="w">    </span><span class="cm">/* Setup temporary stack */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">s4</span><span class="p">,</span><span class="w"> </span><span class="n">_fw_end</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">s5</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">SBI_SCRATCH_SIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">s4</span><span class="p">,</span><span class="w"> </span><span class="n">s5</span>
<span class="w">    </span><span class="cp"># è®¾ç½®ä¸´æ—¶æ ˆ</span>

<span class="w">    </span><span class="cm">/* Allow main firmware to save info */</span>
<span class="w">    </span><span class="n">MOV_5R</span><span class="w">  </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">s3</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">s4</span><span class="p">,</span><span class="w"> </span><span class="n">a4</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">fw_save_info</span>
<span class="w">    </span><span class="n">MOV_5R</span><span class="w">  </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">s3</span><span class="p">,</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">s4</span>
</code></pre></div>
<h2 id="_4">åˆå§‹åŒ–å¹³å°</h2>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Initialize platform</span>
<span class="cm">     * Note: The a0 to a4 registers passed to the</span>
<span class="cm">     * firmware are parameters to this function.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">MOV_5R</span><span class="w">  </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">s3</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">s4</span><span class="p">,</span><span class="w"> </span><span class="n">a4</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">fw_platform_init</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="n">MOV_5R</span><span class="w">  </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">s3</span><span class="p">,</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">s4</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">sbi_platform</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * OpenSBI version this sbi_platform is based on.</span>
<span class="cm">     * It's a 32-bit value where upper 16-bits are major number</span>
<span class="cm">     * and lower 16-bits are minor number</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">opensbi_version</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * OpenSBI platform version released by vendor.</span>
<span class="cm">     * It's a 32-bit value where upper 16-bits are major number</span>
<span class="cm">     * and lower 16-bits are minor number</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">platform_version</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Name of the platform */</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="w">    </span><span class="cm">/** Supported features */</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">features</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Total number of HARTs */</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">hart_count</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Per-HART stack size for exception/interrupt handling */</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">hart_stack_size</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Pointer to sbi platform operations */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">platform_ops_addr</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Pointer to system firmware specific context */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">firmware_context</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * HART index to HART id table</span>
<span class="cm">     *</span>
<span class="cm">     * For used HART index &lt;abc&gt;:</span>
<span class="cm">     *     hart_index2id[&lt;abc&gt;] = some HART id</span>
<span class="cm">     * For unused HART index &lt;abc&gt;:</span>
<span class="cm">     *     hart_index2id[&lt;abc&gt;] = -1U</span>
<span class="cm">     *</span>
<span class="cm">     * If hart_index2id == NULL then we assume identity mapping</span>
<span class="cm">     *     hart_index2id[&lt;abc&gt;] = &lt;abc&gt;</span>
<span class="cm">     *</span>
<span class="cm">     * We have only two restrictions:</span>
<span class="cm">     * 1. HART index &lt; sbi_platform hart_count</span>
<span class="cm">     * 2. HART id &lt; SBI_HARTMASK_MAX_BITS</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">hart_index2id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">sbi_platform</span><span class="w"> </span><span class="n">platform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">opensbi_version</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">OPENSBI_VERSION</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">platform_version</span><span class="w">   </span><span class="o">=</span>
<span class="w">        </span><span class="n">SBI_PLATFORM_VERSION</span><span class="p">(</span><span class="n">CONFIG_PLATFORM_GENERIC_MAJOR_VER</span><span class="p">,</span>
<span class="w">                     </span><span class="n">CONFIG_PLATFORM_GENERIC_MINOR_VER</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">name</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">CONFIG_PLATFORM_GENERIC_NAME</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">features</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">SBI_PLATFORM_DEFAULT_FEATURES</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">hart_count</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">SBI_HARTMASK_MAX_BITS</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">hart_index2id</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">generic_hart_index2id</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">hart_stack_size</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">SBI_PLATFORM_DEFAULT_HART_STACK_SIZE</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">platform_ops_addr</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">platform_ops</span>
<span class="p">};</span>
</code></pre></div>
<h2 id="sbi_scratch">åˆå§‹åŒ–sbi_scratch</h2>
<div class="codehilite"><pre><span></span><code><span class="cm">/** Representation of per-HART scratch space */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sbi_scratch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/** Start (or base) address of firmware linked to OpenSBI library */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">fw_start</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Size (in bytes) of firmware linked to OpenSBI library */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">fw_size</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Offset (in bytes) of the R/W section */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">fw_rw_offset</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Arg1 (or 'a1' register) of next booting stage for this HART */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">next_arg1</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Address of next booting stage for this HART */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">next_addr</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Privilege mode of next booting stage for this HART */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">next_mode</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Warm boot entry point address for this HART */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">warmboot_addr</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Address of sbi_platform */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">platform_addr</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Address of HART ID to sbi_scratch conversion function */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">hartid_to_scratch</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Address of trap exit function */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">trap_exit</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Temporary storage */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">tmp0</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Options for OpenSBI library */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">options</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>æ¥ä¸‹æ¥çš„ä»£ç å°±æ˜¯åˆ›å»ºä¸€æ®µç©ºé—´ï¼Œç»™sbi_scratchï¼Œç„¶åå°†é‡Œé¢çš„å€¼å¡«å……ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="cm">/* Preload HART details</span>
<span class="cm">     * s7 -&gt; HART Count</span>
<span class="cm">     * s8 -&gt; HART Stack Size</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">platform</span>
<span class="w">    </span><span class="cp"># åŠ è½½platformçš„åœ°å€åˆ°a4å¯„å­˜å™¨</span>
<span class="cp">#if __riscv_xlen &gt; 32</span>
<span class="w">    </span><span class="n">lwu</span><span class="w"> </span><span class="n">s7</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_PLATFORM_HART_COUNT_OFFSET</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span>
<span class="w">    </span><span class="n">lwu</span><span class="w"> </span><span class="n">s8</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_PLATFORM_HART_STACK_SIZE_OFFSET</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">lw</span><span class="w">  </span><span class="n">s7</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_PLATFORM_HART_COUNT_OFFSET</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># åŸºäºa4åœ°å€åç§»80å­—èŠ‚ï¼Œå³æŒ‡å‘platform-&gt;hart_count:1ï¼Ÿä¸ºå•¥ä¸æ˜¯128ï¼Ÿ</span>
<span class="w">    </span><span class="n">lw</span><span class="w">  </span><span class="n">s8</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_PLATFORM_HART_STACK_SIZE_OFFSET</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># åŸºäºa4åœ°å€åç§»84å­—èŠ‚ï¼Œå³æŒ‡å‘platform-&gt;hart_stack_size:8192</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="cm">/* Setup scratch space for all the HARTs*/</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">_fw_end</span>
<span class="w">    </span><span class="cp"># åŠ è½½_fw_end: 0x80038000</span>
<span class="w">    </span><span class="n">mul</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">s7</span><span class="p">,</span><span class="w"> </span><span class="n">s8</span>
<span class="w">    </span><span class="cp"># a5 = s7 *s8 = 1 * 0x2000 = 0x2000</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">a5</span>
<span class="w">    </span><span class="cp"># tp = tp +a5 = 0x80038000 + 0x2000 = 0x8003a000</span>
<span class="w">    </span><span class="cm">/* Keep a copy of tp */</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="cp"># t3 = tp = 0x8003a000</span>
<span class="w">    </span><span class="cm">/* Counter */</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="cm">/* hartid 0 is mandated by ISA */</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="cp"># tp æ˜¯ RISC-V ä¸­çš„ä¸€ä¸ªç‰¹æ®Šå¯„å­˜å™¨ï¼Œç”¨äºæŒ‡å‘ä¸´æ—¶å·¥ä½œåŒºåŸŸï¼ˆscratch spaceï¼‰ã€‚</span>
<span class="w">    </span><span class="cp"># å°† _fw_end åœ°å€åŠ è½½è¿› tp, åœ¨ç”¨ s7,s8 è®¡ç®—å‡º scratch space, å†åŠ ä¸Š tp,</span>
<span class="w">    </span><span class="cp"># è¿™æ ·å°±ç›¸å½“äºåˆ†é…äº†ä¸€æ®µhartçš„æš‚å­˜ç©ºé—´ã€‚</span>
<span class="nl">_scratch_init</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * The following registers hold values that are computed before</span>
<span class="cm">     * entering this block, and should remain unchanged.</span>
<span class="cm">     *</span>
<span class="cm">     * t3 -&gt; the firmware end address</span>
<span class="cm">     * s7 -&gt; HART count</span>
<span class="cm">     * s8 -&gt; HART stack size</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="cp"># tp = t3 = 0x8003a000</span>
<span class="w">    </span><span class="n">mul</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">s8</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span>
<span class="w">    </span><span class="cp"># a5 = s8 *s1 = 0</span>
<span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">a5</span>
<span class="w">    </span><span class="cp"># tp = tp - a5 = 0x8003a000</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_SIZE</span>
<span class="w">    </span><span class="cp"># åŠ è½½SBI_SRATCH_SIZEç©ºé—´åˆ°a5ï¼Œè¿™é‡Œæ˜¯0x1000</span>
<span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">a5</span>
<span class="w">    </span><span class="cp"># tp = tp - a5 = 0x80039000</span>

<span class="w">    </span><span class="cm">/* Initialize scratch space */</span>
<span class="w">    </span><span class="cm">/* Store fw_start and fw_size in scratch space */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">_fw_start</span>
<span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">a4</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_FW_START_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_FW_SIZE_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># å°†fw_startå’Œfw_sizeå†™åˆ°scratchç©ºé—´</span>

<span class="w">    </span><span class="cm">/* Store R/W section's offset in scratch space */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">__fw_rw_offset</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_FW_RW_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># å°†__fw_rw_offset= _fw_rw_start - _fw_startï¼Œå†™åˆ°scratchç©ºé—´ã€‚</span>
<span class="w">    </span><span class="cp"># å³dataæ®µçš„åç§»ä½ç½®ã€‚</span>

<span class="w">    </span><span class="cm">/* Store next arg1 in scratch space */</span>
<span class="w">    </span><span class="n">MOV_3R</span><span class="w">  </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">fw_next_arg1</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_NEXT_ARG1_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
<span class="w">    </span><span class="n">MOV_3R</span><span class="w">  </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span>
<span class="w">    </span><span class="cp"># å­˜å‚¨ä¸‹ä¸€é˜¶æ®µå¯åŠ¨çš„ä¼ é€’çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¿™é‡Œæ˜¯FW_JUMP_FDT_ADDR</span>
<span class="w">    </span><span class="cp"># åœ¨platform/generic/objects.mkä¸­é…ç½®ï¼Œ= ($(FW_TEXT_START) + 0x2200000))</span>
<span class="w">    </span><span class="cp"># FW_JUMP_FDT_ADDR = 0x82200000</span>
<span class="w">    </span><span class="cm">/* Store next address in scratch space */</span>
<span class="w">    </span><span class="n">MOV_3R</span><span class="w">  </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">fw_next_addr</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_NEXT_ADDR_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
<span class="w">    </span><span class="n">MOV_3R</span><span class="w">  </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span>
<span class="w">    </span><span class="cp"># å­˜å‚¨ä¸‹ä¸€é˜¶æ®µå¯åŠ¨åœ°å€ï¼Œå³opensbiè¿è¡Œé˜¶æ®µè¦è·³è½¬çš„åœ°å€</span>
<span class="w">    </span><span class="cp"># è·³è½¬çš„åœ°å€ä¸ºFW_JUMP_ADDRï¼Œobject.mkä¸­è®¾ç½®</span>
<span class="w">    </span><span class="cp"># = ($(FW_TEXT_START) + 0x200000))</span>
<span class="w">    </span><span class="cp"># æ‰€ä»¥FW_JUMP_ADDR = 0x80200000</span>
<span class="w">    </span><span class="cm">/* Store next mode in scratch space */</span>
<span class="w">    </span><span class="n">MOV_3R</span><span class="w">  </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">fw_next_mode</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_NEXT_MODE_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
<span class="w">    </span><span class="n">MOV_3R</span><span class="w">  </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span>
<span class="w">    </span><span class="cp"># å°†ä¸‹ä¸€é˜¶æ®µå¯åŠ¨çš„æ¨¡å¼å­˜å‚¨next_modeï¼Œè¿™é‡Œæ˜¯Sæ¨¡å¼ï¼š1</span>

<span class="w">    </span><span class="cm">/* Store warm_boot address in scratch space */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">_start_warm</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_WARMBOOT_ADDR_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># å­˜å‚¨warm_bootå¯åŠ¨åœ°å€ï¼š0x80000354</span>
<span class="w">    </span><span class="cp"># å³ï¼šfirmware/fw_base.S::426è¡Œ</span>

<span class="w">    </span><span class="cm">/* Store platform address in scratch space */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">platform</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_PLATFORM_ADDR_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># å­˜å‚¨platformçš„åœ°å€</span>

<span class="w">    </span><span class="cm">/* Store hartid-to-scratch function address in scratch space */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">_hartid_to_scratch</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_HARTID_TO_SCRATCH_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># å­˜å‚¨_hartid_to_scratchåœ°å€ï¼Œè¿™æ®µæ˜¯å…¶ä»–hardè°ƒç”¨è¯¥å‡½æ•°ç”¨äºåˆ†é…scratchç©ºé—´</span>

<span class="w">    </span><span class="cm">/* Store trap-exit function address in scratch space */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">_trap_exit</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_TRAP_EXIT_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># å­˜å‚¨çš„æ˜¯trapé€€å‡ºå‡½æ•°</span>

<span class="w">    </span><span class="cm">/* Clear tmp0 in scratch space */</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_TMP0_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
<span class="w">    </span><span class="cm">/* Store firmware options in scratch space */</span>
<span class="w">    </span><span class="n">MOV_3R</span><span class="w">  </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>
<span class="cp">#ifdef FW_OPTIONS</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">FW_OPTIONS</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">fw_options</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_OPTIONS_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
<span class="w">    </span><span class="n">MOV_3R</span><span class="w">  </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span>
<span class="w">    </span><span class="cm">/* Move to next scratch space */</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span>
<span class="w">    </span><span class="n">blt</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">s7</span><span class="p">,</span><span class="w"> </span><span class="n">_scratch_init</span>
<span class="w">    </span><span class="cp"># å®Œæˆä¸€ä¸ªhartçš„scrachåˆå§‹åŒ–ï¼Œæ¥ç€ä¸ºä¸‹ä¸€ä¸ªhartåˆ†é…ä¸€ä¸ªscratchå¹¶åˆå§‹åŒ–ã€‚</span>
</code></pre></div>
<h2 id="fdt">FDTé‡å®šä½</h2>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Relocate Flatened Device Tree (FDT)</span>
<span class="cm">     * source FDT address = previous arg1</span>
<span class="cm">     * destination FDT address = next arg1</span>
<span class="cm">     *</span>
<span class="cm">     * Note: We will preserve a0 and a1 passed by</span>
<span class="cm">     * previous booting stage.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">beqz</span><span class="w">    </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">_fdt_reloc_done</span>
<span class="w">    </span><span class="cm">/* Mask values in a4 */</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span>
<span class="w">    </span><span class="cm">/* t1 = destination FDT start address */</span>
<span class="w">    </span><span class="n">MOV_3R</span><span class="w">  </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">fw_next_arg1</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="n">MOV_3R</span><span class="w">  </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span>
<span class="w">    </span><span class="n">beqz</span><span class="w">    </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">_fdt_reloc_done</span>
<span class="w">    </span><span class="n">beq</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">_fdt_reloc_done</span>
<span class="w">    </span><span class="cm">/* t0 = source FDT start address */</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="cm">/* t2 = source FDT size in big-endian */</span>
<span class="cp">#if __riscv_xlen == 64</span>
<span class="w">    </span><span class="n">lwu</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">lw</span><span class="w">  </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="cm">/* t3 = bit[15:8] of FDT size */</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="n">srli</span><span class="w">    </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span>
<span class="w">    </span><span class="n">and</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">a4</span>
<span class="w">    </span><span class="n">slli</span><span class="w">    </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="cm">/* t4 = bit[23:16] of FDT size */</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t4</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="n">srli</span><span class="w">    </span><span class="n">t4</span><span class="p">,</span><span class="w"> </span><span class="n">t4</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="n">and</span><span class="w"> </span><span class="n">t4</span><span class="p">,</span><span class="w"> </span><span class="n">t4</span><span class="p">,</span><span class="w"> </span><span class="n">a4</span>
<span class="w">    </span><span class="n">slli</span><span class="w">    </span><span class="n">t4</span><span class="p">,</span><span class="w"> </span><span class="n">t4</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span>
<span class="w">    </span><span class="cm">/* t5 = bit[31:24] of FDT size */</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="n">and</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">a4</span>
<span class="w">    </span><span class="n">slli</span><span class="w">    </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span>
<span class="w">    </span><span class="cm">/* t2 = bit[7:0] of FDT size */</span>
<span class="w">    </span><span class="n">srli</span><span class="w">    </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span>
<span class="w">    </span><span class="n">and</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">a4</span>
<span class="w">    </span><span class="cm">/* t2 = FDT size in little-endian */</span>
<span class="w">    </span><span class="n">or</span><span class="w">  </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">t3</span>
<span class="w">    </span><span class="n">or</span><span class="w">  </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">t4</span>
<span class="w">    </span><span class="n">or</span><span class="w">  </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">t5</span>
<span class="w">    </span><span class="cm">/* t2 = destination FDT end address */</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span>
<span class="w">    </span><span class="cm">/* FDT copy loop */</span>
<span class="w">    </span><span class="n">ble</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">_fdt_reloc_done</span>
<span class="nl">_fdt_reloc_again</span><span class="p">:</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">__SIZEOF_POINTER__</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">__SIZEOF_POINTER__</span>
<span class="w">    </span><span class="n">blt</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">_fdt_reloc_again</span>
</code></pre></div>
<h2 id="boot-hard">boot hardå¯åŠ¨å®Œæˆ</h2>
<div class="codehilite"><pre><span></span><code><span class="nl">_fdt_reloc_done</span><span class="p">:</span>

<span class="w">    </span><span class="cm">/* mark boot hart done */</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">BOOT_STATUS_BOOT_HART_DONE</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">_boot_status</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
<span class="w">    </span><span class="n">fence</span><span class="w">   </span><span class="n">rw</span><span class="p">,</span><span class="w"> </span><span class="n">rw</span>
<span class="w">    </span><span class="n">j</span><span class="w">   </span><span class="n">_start_warm</span>
<span class="w">    </span><span class="cp"># boot hartå¯åŠ¨å®Œæˆï¼Œå†™å…¥ä¸€ä¸ªæ ‡å¿—ä½ï¼Œä»¥ä¾¿é€šçŸ¥å…¶ä»–hartï¼Œè·³è½¬åˆ°çƒ­å¯åŠ¨</span>
</code></pre></div>
<h2 id="boot-hart">éboot hartç­‰å¾…è¿è¡Œ</h2>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="cm">/* waiting for boot hart to be done (_boot_status == 2) */</span>
<span class="nl">_wait_for_boot_hart</span><span class="p">:</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">BOOT_STATUS_BOOT_HART_DONE</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">_boot_status</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
<span class="w">    </span><span class="cm">/* Reduce the bus traffic so that boot hart may proceed faster */</span>
<span class="w">    </span><span class="n">nop</span>
<span class="w">    </span><span class="n">nop</span>
<span class="w">    </span><span class="n">nop</span>
<span class="w">    </span><span class="n">bne</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">_wait_for_boot_hart</span>
<span class="w">    </span><span class="cp"># è¯»å–_boot_statusçš„æ ‡å¿—ï¼Œåˆ¤æ–­boot hartæ˜¯å¦è¿è¡Œåˆå§‹åŒ–å®Œï¼Œå¦‚æœåˆå§‹åŒ–</span>
<span class="w">    </span><span class="cp"># å³å¯è¿›å…¥_start_warmï¼Œå¦åˆ™éœ€è¦ä¸€ç›´ç­‰å¾…ã€‚</span>
</code></pre></div>
<h2 id="hart_1">hart çƒ­å¯åŠ¨</h2>
<div class="codehilite"><pre><span></span><code><span class="nl">_start_warm</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/* Reset all registers for non-boot HARTs */</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">ra</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">_reset_regs</span>
<span class="w">    </span><span class="cp"># å¯¹äºnon-boot HARTSå¤ä½å¯„å­˜å™¨</span>

<span class="w">    </span><span class="cm">/* Disable all interrupts */</span>
<span class="w">    </span><span class="n">csrw</span><span class="w">    </span><span class="n">CSR_MIE</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="cp"># å…³é—­æ‰€æœ‰çš„ä¸­æ–­</span>

<span class="w">    </span><span class="cm">/* Find HART count and HART stack size */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">platform</span>
<span class="cp">#if __riscv_xlen == 64</span>
<span class="w">    </span><span class="n">lwu</span><span class="w"> </span><span class="n">s7</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_PLATFORM_HART_COUNT_OFFSET</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span>
<span class="w">    </span><span class="n">lwu</span><span class="w"> </span><span class="n">s8</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_PLATFORM_HART_STACK_SIZE_OFFSET</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">lw</span><span class="w">  </span><span class="n">s7</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_PLATFORM_HART_COUNT_OFFSET</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span>
<span class="w">    </span><span class="n">lw</span><span class="w">  </span><span class="n">s8</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_PLATFORM_HART_STACK_SIZE_OFFSET</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w">   </span><span class="n">s9</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_PLATFORM_HART_INDEX2ID_OFFSET</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span>
<span class="w">    </span><span class="cp"># åŠ è½½platformï¼Œè·å–åˆ°Hart countå’Œhart stack size</span>

<span class="w">    </span><span class="cm">/* Find HART id */</span>
<span class="w">    </span><span class="n">csrr</span><span class="w">    </span><span class="n">s6</span><span class="p">,</span><span class="w"> </span><span class="n">CSR_MHARTID</span>
<span class="w">    </span><span class="cp"># è·å–å½“å‰çš„hart id</span>

<span class="w">    </span><span class="cm">/* Find HART index */</span>
<span class="w">    </span><span class="n">beqz</span><span class="w">    </span><span class="n">s9</span><span class="p">,</span><span class="w"> </span><span class="mf">3f</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">1</span><span class="o">:</span>
<span class="cp">#if __riscv_xlen == 64</span>
<span class="w">    </span><span class="n">lwu</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">s9</span><span class="p">)</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">lw</span><span class="w">  </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">s9</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">beq</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">s6</span><span class="p">,</span><span class="w"> </span><span class="mf">2f</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">s9</span><span class="p">,</span><span class="w"> </span><span class="n">s9</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">blt</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">s7</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="n">b</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span>
<span class="mi">2</span><span class="o">:</span><span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">s6</span><span class="p">,</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="mi">3</span><span class="o">:</span><span class="w">  </span><span class="n">bge</span><span class="w"> </span><span class="n">s6</span><span class="p">,</span><span class="w"> </span><span class="n">s7</span><span class="p">,</span><span class="w"> </span><span class="n">_start_hang</span>
<span class="w">    </span><span class="cm">/* Find the scratch space based on HART index */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">_fw_end</span>
<span class="w">    </span><span class="n">mul</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">s7</span><span class="p">,</span><span class="w"> </span><span class="n">s8</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">a5</span>
<span class="w">    </span><span class="n">mul</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">s8</span><span class="p">,</span><span class="w"> </span><span class="n">s6</span>
<span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">a5</span>
<span class="w">    </span><span class="n">li</span><span class="w">  </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_SIZE</span>
<span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">a5</span>
<span class="w">    </span><span class="cp"># æ ¹æ®hart indexæ‰¾åˆ°å¯¹åº”çš„scratch space</span>

<span class="w">    </span><span class="cm">/* update the mscratch */</span>
<span class="w">    </span><span class="n">csrw</span><span class="w">    </span><span class="n">CSR_MSCRATCH</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span>
<span class="w">    </span><span class="cp"># å°†scratchåœ°å€æ›´æ–°åˆ°mscratchå¯„å­˜å™¨ä¸­</span>

<span class="w">    </span><span class="cm">/* Setup stack */</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="cp"># è®¾ç½®hartçš„æ ˆç©ºé—´</span>

<span class="w">    </span><span class="cm">/* Setup trap handler */</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">_trap_handler</span>
<span class="cp">#if __riscv_xlen == 32</span>
<span class="w">    </span><span class="n">csrr</span><span class="w">    </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">CSR_MISA</span>
<span class="w">    </span><span class="n">srli</span><span class="w">    </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="sc">'H'</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="sc">'A'</span><span class="p">)</span>
<span class="w">    </span><span class="n">andi</span><span class="w">    </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span>
<span class="w">    </span><span class="n">beq</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">_skip_trap_handler_rv32_hyp</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">_trap_handler_rv32_hyp</span>
<span class="nl">_skip_trap_handler_rv32_hyp</span><span class="p">:</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">csrw</span><span class="w">    </span><span class="n">CSR_MTVEC</span><span class="p">,</span><span class="w"> </span><span class="n">a4</span>
<span class="w">    </span><span class="cp"># è®¾ç½®trapå¤„ç†å…¥å£å‡½æ•°_trap_handler</span>
<span class="cp">#if __riscv_xlen == 32</span>
<span class="w">    </span><span class="cm">/* Override trap exit for H-extension */</span>
<span class="w">    </span><span class="n">csrr</span><span class="w">    </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">CSR_MISA</span>
<span class="w">    </span><span class="n">srli</span><span class="w">    </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="sc">'H'</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="sc">'A'</span><span class="p">)</span>
<span class="w">    </span><span class="n">andi</span><span class="w">    </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span>
<span class="w">    </span><span class="n">beq</span><span class="w"> </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">_skip_trap_exit_rv32_hyp</span>
<span class="w">    </span><span class="n">lla</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">_trap_exit_rv32_hyp</span>
<span class="w">    </span><span class="n">csrr</span><span class="w">    </span><span class="n">a5</span><span class="p">,</span><span class="w"> </span><span class="n">CSR_MSCRATCH</span>
<span class="w">    </span><span class="n">REG_S</span><span class="w">   </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">SBI_SCRATCH_TRAP_EXIT_OFFSET</span><span class="p">(</span><span class="n">a5</span><span class="p">)</span>
<span class="nl">_skip_trap_exit_rv32_hyp</span><span class="p">:</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="cm">/* Initialize SBI runtime */</span>
<span class="w">    </span><span class="n">csrr</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">CSR_MSCRATCH</span>
<span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">sbi_init</span>
<span class="w">    </span><span class="cp"># scratchçš„åœ°å€ä½œä¸ºå‚æ•°ï¼Œè·³è½¬åˆ°sbi_initæ‰§è¡Œã€‚</span>
</code></pre></div>
<h2 id="_5">å°ç»“</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_9e0252c9c3914a87a4e0af3c33349b68.jpg"><img alt="" src="assets/doc/02-risc-v/opensbiåˆ†æï¼ˆä¸€ï¼‰/images/wp_editor_md_9e0252c9c3914a87a4e0af3c33349b68.jpg"/></a></p>
<p>æœ¬æ–‡å‚è€ƒï¼š [æ³°æ™“ç§‘æŠ€OpenSBIåˆ†æ1](https://tinylab.org/sbi-firmware-analyze-41/ \"æ³°æ™“ç§‘æŠ€OpenSBIåˆ†æ1\") [æ³°æ™“ç§‘æŠ€OpenSBIåˆ†æ2](https://tinylab.org/sbi-firmware-analyze-2/ \"æ³°æ™“ç§‘æŠ€OpenSBIåˆ†æ2\") [æ³°æ™“ç§‘æŠ€OpenSBIåˆ†æ3](https://tinylab.org/sbi-firmware-analyze-3/ \"æ³°æ™“ç§‘æŠ€OpenSBIåˆ†æ3\") [æ³°æ™“ç§‘æŠ€OpenSBIåˆ†æ4](https://tinylab.org/sbi-firmware-analyze-4/ \"æ³°æ™“ç§‘æŠ€OpenSBIåˆ†æ4\") [passenger12234çš„åšå®¢ OpenSBIåˆ†æ](https://blog.csdn.net/passenger12234/category_11411139.html \"passenger12234çš„åšå®¢ OpenSBIåˆ†æ\") [OpenSBI ELF rela.dynå’Œ.dynsymåŠ¨æ€é“¾æ¥è¿‡ç¨‹](https://blog.csdn.net/dai_xiangjun/article/details/123629743 \"OpenSBI ELF rela.dynå’Œ.dynsymåŠ¨æ€é“¾æ¥è¿‡ç¨‹\")</p></div>
  <div class="post-nav">
    <a class="prev" href="opensbiåˆ†æ-äºŒ.html">â† opensbiåˆ†æï¼ˆäºŒï¼‰</a>
    <a class="next" href="qemu-opensbi-uboot-linux-busyboxå¯åŠ¨ç¯å¢ƒæ­å»º.html">qemu+opensbi+uboot+linux+busyboxå¯åŠ¨ç¯å¢ƒæ­å»º â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

