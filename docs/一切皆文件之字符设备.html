<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å­—ç¬¦è®¾å¤‡ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">æ³¨å†Œå­—ç¬¦è®¾å¤‡é©±åŠ¨</a><ul></ul></li><li><a href="#_2">åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</a><ul></ul></li><li><a href="#_3">é©±åŠ¨ç³»ç»Ÿè°ƒç”¨</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å­—ç¬¦è®¾å¤‡</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-05-28
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/module.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/fs.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/uaccess.h&gt;</span>

<span class="cp">#define DEVICE_NAME "mychardev"</span>
<span class="cp">#define BUFFER_SIZE 1024</span>

<span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">device_buffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">open_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">device_open</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">open_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

<span class="w">    </span><span class="n">open_count</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">device_release</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">open_count</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">device_read</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_to_read</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">bytes_to_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">BUFFER_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">*</span><span class="n">offset</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">device_buffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">bytes_to_read</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="w">    </span><span class="o">*</span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bytes_to_read</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bytes_to_read</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">device_write</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_to_write</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">bytes_to_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">BUFFER_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">*</span><span class="n">offset</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">device_buffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">bytes_to_write</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="w">    </span><span class="o">*</span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bytes_to_write</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bytes_to_write</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="n">fops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_open</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">release</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_release</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_read</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">chardev_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">register_chrdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE_NAME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fops</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span><span class="w"> </span><span class="s">"Failed to register char device</span><span class="se">\\</span><span class="s">n"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="w"> </span><span class="s">"Char device driver registered,major:%d</span><span class="se">\\</span><span class="s">n"</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__exit</span><span class="w"> </span><span class="nf">chardev_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">unregister_chrdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE_NAME</span><span class="p">);</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="w"> </span><span class="s">"Char device driver unregistered</span><span class="se">\\</span><span class="s">n"</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">chardev_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">chardev_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">"Your Name"</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">"A simple character device driver"</span><span class="p">);</span>
</code></pre></div>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªåŠ è½½å­—ç¬¦è®¾å¤‡é©±åŠ¨åçš„æµ‹è¯•ç¤ºä¾‹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">mknod</span><span class="w"> </span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mychardev</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">MAJOR_NUMBER</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="err">#</span><span class="n">MAJOR_NUMERä¸ºæ³¨å†Œå­—ç¬¦è®¾å¤‡æ—¶è·å¾—çš„ä¸»è®¾å¤‡å·</span>
<span class="n">echo</span><span class="w"> </span><span class="s">"Hello, world!"</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mychardev</span><span class="w">   </span><span class="err">#</span><span class="w"> </span><span class="n">å†™å…¥æ•°æ®åˆ°è®¾å¤‡</span>
<span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mychardev</span><span class="w">                  </span><span class="err">#</span><span class="w"> </span><span class="n">ä»è®¾å¤‡è¯»å–æ•°æ®</span>
</code></pre></div>
<h2 id="_1">æ³¨å†Œå­—ç¬¦è®¾å¤‡é©±åŠ¨</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_85ad14b1958abe5e4e1bdba751564b82.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å­—ç¬¦è®¾å¤‡/images/wp_editor_md_85ad14b1958abe5e4e1bdba751564b82.jpg"/></a></p>
<p>ï¼ˆ1ï¼‰å…ˆè°ƒç”¨__register_chrdev_regionåˆ†é…ä¸€ä¸ªstrcut char_device_strcutçš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦è®¾å¤‡é©±åŠ¨ï¼Œåœ¨å‡½æ•°ä¸­ä¼šå¡«å……cdæ•°æ®ç»“æ„ã€‚ç³»ç»Ÿä¸ºäº†ç®¡ç†è®¾å¤‡ï¼Œä¸ºæ¯ä¸ªè®¾å¤‡ç¼–äº†å·ï¼Œæ¯ä¸ªè®¾å¤‡åˆåˆ†ä¸ºä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ï¼Œä¸»è®¾å¤‡å·ç”¨æ¥åŒºåˆ†ä¸åŒç±»ä¼¼çš„è®¾å¤‡ï¼Œè€Œæ¬¡è®¾å¤‡å·ç”¨æ¥åŒºåˆ†åŒä¸€ç±»å‹çš„å¤šä¸ªè®¾å¤‡ï¼Œå¦‚IICé©±åŠ¨çš„ä¸»è®¾å¤‡å·æ˜¯100ï¼ŒIICæœ‰3ä¸ªè®¾å¤‡IIC-0ï¼ŒIIC-1ï¼ŒIIC-2ï¼Œè¿™3ä¸ªè®¾å¤‡å…±ç”¨ä¸€å¥—é©±åŠ¨ã€‚å¯ä»¥é€šè¿‡cat /proc/devices æŸ¥çœ‹å·²åŠ è½½çš„é©±åŠ¨è®¾å¤‡ä¸»è®¾å¤‡å·ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">char_device_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">char_device_struct</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span><span class="w">  </span><span class="c1">//æŒ‡å‘ä¸‹ä¸€ä¸ªå­—ç¬¦è®¾å¤‡</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">major</span><span class="p">;</span><span class="w">            </span><span class="c1">//ä¸»è®¾å¤‡å·</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">baseminor</span><span class="p">;</span><span class="w">        </span><span class="c1">//æ¬¡è®¾å¤‡èµ·å§‹å€¼</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">minorct</span><span class="p">;</span><span class="w">                  </span><span class="c1">//æ¬¡è®¾å¤‡æ•°é‡</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span><span class="w">               </span><span class="c1">//è®¾å¤‡æˆ–é©±åŠ¨çš„åç§°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="o">*</span><span class="n">cdev</span><span class="p">;</span><span class="w">      </span><span class="cm">/* will die */</span>
<span class="p">}</span><span class="w"> </span><span class="o">*</span><span class="n">chrdevs</span><span class="p">[</span><span class="n">CHRDEV_MAJOR_HASH_SIZE</span><span class="p">];</span>
</code></pre></div>
<p>ï¼ˆ2ï¼‰è°ƒç”¨cdev_allocåˆ†é…è®¾å¤‡ä¸€ä¸ªcdevå®ä¾‹ï¼Œcdevæè¿°äº†ä¸€ä¸ªå­—ç¬¦è®¾å¤‡ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="n">kobj</span><span class="p">;</span><span class="w"> </span><span class="c1">//å†…æ ¸å¯¹è±¡ï¼Œé€šè¿‡ä»–å°†è®¾å¤‡ç»Ÿä¸€åŠ åˆ°è®¾å¤‡é©±åŠ¨æ¨¡å‹ä¸­ç®¡ç†</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">;</span><span class="w"> </span><span class="c1">//æ–‡ä»¶ç³»ç»Ÿä¸è®¾å¤‡ç›´æ¥çš„æ“ä½œå‡½æ•°é›†åˆ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="c1">//æ‰€æœ‰çš„å­—ç¬¦è®¾å¤‡é©±åŠ¨å½¢æˆé“¾è¡¨</span>
<span class="w">    </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span><span class="w"> </span><span class="c1">//å­—ç¬¦è®¾å¤‡çš„è®¾å¤‡å·ï¼Œç”±ä¸»è®¾å¤‡å’Œæ¬¡è®¾å¤‡æ„æˆ</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></div>
<p>ï¼ˆ3ï¼‰å¡«å……ç”¨æˆ·æ³¨å†Œçš„é©±åŠ¨å‡½æ•°æ“ä½œé›†åˆï¼Œç”¨æˆ·æ³¨å†Œçš„open/read/writeç­‰å‡½æ•°ï¼Œè¿™æ˜¯æ–‡ä»¶ç³»ç»Ÿä¸è®¾å¤‡çš„æ²Ÿé€šæ¡¥æ¢ã€‚ ï¼ˆ4ï¼‰å°†cdevæ·»åŠ åˆ°strutct kobj_map *cdev_mapå…¨å±€åˆ—è¡¨ä¸­ï¼Œkobj_mapä¸­æœ‰255ä¸ªprobeï¼Œæ¯ä¸ªprobeå¯¹åº”ä¸€ä¸ªä¸»è®¾å¤‡ï¼Œç›¸å½“äºå­—ç¬¦è®¾å¤‡çš„æ•°é‡ä¸èƒ½è¶…è¿‡255ã€‚æ¯ä¸ªä¸»è®¾å¤‡ä¸‹å¯ä»¥ç”±å¤šä¸ªæ¬¡è®¾å¤‡ã€‚</p>
<h2 id="_2">åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_4737273667b8d77e4ff73ea9d77da032.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å­—ç¬¦è®¾å¤‡/images/wp_editor_md_4737273667b8d77e4ff73ea9d77da032.jpg"/></a></p>
<p>insmodåŠ è½½å®Œæˆé©±åŠ¨åï¼Œé€šå¸¸éœ€è¦ä½¿ç”¨mknodåˆ›å»ºä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥é€šè¿‡æ–‡ä»¶ç³»ç»ŸèŠ‚ç‚¹çš„æ–¹å¼è®¿é—®è®¾å¤‡ï¼Œä¸‹é¢æ˜¯mknodçš„ä½¿ç”¨ç¤ºä¾‹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">mknod</span><span class="w"> </span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">xxx</span><span class="w"> </span><span class="n">è®¾å¤‡ç±»å‹</span><span class="w"> </span><span class="n">ä¸»è®¾å¤‡å·</span><span class="w"> </span><span class="n">ä»è®¾å¤‡å·</span>
</code></pre></div>
<p>ä»ä¸Šå›¾çš„æµç¨‹å›¾å¯çŸ¥ï¼Œ/devæ˜¯æŒ‚è½½äº†tmpfsç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿã€‚åœ¨ç³»ç»Ÿå¯åŠ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨shmem_initæ³¨å†Œä¸€ä¸ªtmpfsç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿã€‚ åœ¨ä½¿ç”¨mknodeåœ¨/devä¸‹åˆ›å»ºè®¾å¤‡é©±åŠ¨èŠ‚ç‚¹ï¼Œä¸å‰é¢æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ç±»ä¼¼ï¼Œå…³é”®ç‚¹å°±æ˜¯ä¸ºæ–‡ä»¶åˆ›å»ºä¸€ä¸ªdentryå’Œinodeï¼Œç„¶åå¡«å……inodeå¯¹åº”çš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„æ˜¯inodeå¡«å……çš„i_fopçš„æ“ä½œå‡½æ•°é›†åˆæ˜¯def_chr_fopsï¼Œè¿™ä¸ªfile_operationså¯¹åº”çš„openæ˜¯chardev_openï¼Œå› æ­¤åç»­åœ¨ç”¨æˆ·æ‰“å¼€æ–‡ä»¶æ—¶å°†ä¼šè°ƒç”¨åˆ°è¯¥å‡½æ•°ã€‚</p>
<h2 id="_3">é©±åŠ¨ç³»ç»Ÿè°ƒç”¨</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_a3bf16fee47bf7a033418479e049b2af.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å­—ç¬¦è®¾å¤‡/images/wp_editor_md_a3bf16fee47bf7a033418479e049b2af.jpg"/></a></p>
<p>ä¸Šä¸€å°èŠ‚ä¸­ï¼Œä½¿ç”¨mknodåˆ›å»ºè®¾å¤‡èŠ‚ç‚¹æ—¶ï¼Œinode-&gt;i_fopå¡«å……çš„æ˜¯def_char_fopsï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿæ‰“å¼€æ—¶å°±ä¼šè°ƒç”¨åˆ°chrdev_openå‡½æ•°ï¼Œæ‰“å¼€çš„æµç¨‹ä¸å‰é¢åˆ†æçš„æµç¨‹ä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸å†åˆ†æäº†ï¼Œæˆ‘ä»¬è¿™é‡Œé‡ç‚¹å…³æ³¨è·Ÿè®¾å¤‡é©±åŠ¨ç›¸å…³çš„å·®å¼‚ã€‚chrdev_openå‡½æ•°å¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">chrdev_open</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="o">*</span><span class="n">fops</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="o">*</span><span class="n">new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_cdev</span><span class="p">;</span><span class="w"> </span><span class="c1">//è·å–æ–‡ä»¶å¯¹åº”çš„cdevï¼Œå¦‚æœä¸ºç©ºåˆ™éœ€è¦è¿›è¡ŒæŸ¥æ‰¾ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">kobj</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span>
<span class="w">        </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_lock</span><span class="p">);</span>
<span class="w">        </span><span class="n">kobj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kobj_lookup</span><span class="p">(</span><span class="n">cdev_map</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">idx</span><span class="p">);</span><span class="w"> </span><span class="c1">//ä»cdev_mapä¸­æŸ¥æ‰¾kobj</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">kobj</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="w">        </span><span class="n">new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="p">,</span><span class="w"> </span><span class="n">kobj</span><span class="p">);</span><span class="c1">//è·å–åˆ°cdev</span>
<span class="w">        </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_lock</span><span class="p">);</span>
<span class="w">        </span><span class="cm">/* Check i_cdev again in case somebody beat us to it while</span>
<span class="cm">           we dropped the lock. */</span>
<span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_cdev</span><span class="p">;</span><span class="w"> </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_cdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="p">;</span><span class="w"> </span><span class="c1">//å°†cdevèµ‹å€¼ç»™inode</span>
<span class="w">            </span><span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_devices</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span><span class="c1">//å°†inodeæ·»åŠ åˆ°è®¾å¤‡åˆ—è¡¨ä¸­</span>
<span class="w">            </span><span class="n">new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cdev_get</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cdev_get</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="w">    </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">cdev_put</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="w">    </span><span class="n">fops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fops_get</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span><span class="w"> </span><span class="c1">//è·å–é©±åŠ¨æ³¨å†Œçš„file_operations</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fops</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out_cdev_put</span><span class="p">;</span>

<span class="w">    </span><span class="n">replace_fops</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="n">fops</span><span class="p">);</span><span class="w"> </span><span class="c1">//å°†struct fileä¸­çš„f_opæ›´æ–°è·Ÿé©±åŠ¨çš„æ³¨å†Œçš„file_operations</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">filp</span><span class="p">);</span><span class="w"> </span><span class="c1">//è°ƒç”¨é©±åŠ¨æ³¨å†Œçš„openå‡½æ•°</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">out_cdev_put</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w"> </span><span class="nl">out_cdev_put</span><span class="p">:</span>
<span class="w">    </span><span class="n">cdev_put</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>chrdev_openå‡½æ•°å…³é”®çš„ä½œç”¨å…ˆä»cdev_mapä¸­æ‰¾åˆ°è®¾å¤‡çš„cdevï¼Œç„¶åå¡«å……åˆ°inodeä¸­ï¼Œè¿™æ ·ä¸‹æ¬¡æ“ä½œè®¾å¤‡æ–‡ä»¶èŠ‚ç‚¹æ—¶å°±ä¸ç”¨å†æŸ¥æ‰¾äº†ï¼Œæ¥ä¸‹æ¥éå¸¸å…³é”®çš„ä½œç”¨æ˜¯å°†strcut fileä¸­çš„f_opç”±åŸæ¥inode-&gt;i_fopæŒ‡å‘çš„file_operations(def_chr_fops)æ›¿æ¢ä¸ºé©±åŠ¨æ³¨å†Œçš„file_operationsï¼Œè¿™æ ·åç»­ç”¨æˆ·åœ¨è¿›ç¨‹ä¸­å†æ“ä½œè¯¥æ–‡ä»¶èŠ‚ç‚¹æ—¶ï¼Œå¯¹æ–‡ä»¶çš„open/read/writeç­‰æ“ä½œç»è¿‡VFSåå°±ç›´æ¥è°ƒç”¨åˆ°é©±åŠ¨æ³¨å†Œçš„file_opearationsæ“ä½œé›†åˆäº†ï¼Œä¸ä¼šå†ç»è¿‡def_chr_fopsã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_f3806964978c66e9e0d500a5c0fe0e36.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å­—ç¬¦è®¾å¤‡/images/wp_editor_md_f3806964978c66e9e0d500a5c0fe0e36.jpg"/></a></p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_6a645d1ff38afff207ce60e4602f88e6.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å­—ç¬¦è®¾å¤‡/images/wp_editor_md_6a645d1ff38afff207ce60e4602f88e6.jpg"/></a></p></div>
  <div class="post-nav">
    <a class="prev" href="ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨-ä¸€.html">â† ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆä¸€ï¼‰</a>
    <a class="next" href="æ–‡ä»¶ç³»ç»Ÿå¸¸è§ç³»ç»Ÿè°ƒç”¨.html">æ–‡ä»¶ç³»ç»Ÿå¸¸è§ç³»ç»Ÿè°ƒç”¨ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

