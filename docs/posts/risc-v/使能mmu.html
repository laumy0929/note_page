<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>使能MMU - Laumy的技术栈</title>
    <link rel="stylesheet" href="/note_page/assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="/note_page/">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="/note_page/">首页</a></div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>使能MMU</h1>
  <div class="meta">2024-07-07 · risc-v</div>
  <div class="post-content"><div class="codehilite"><pre><span></span><code><span class="n">①</span><span class="w"> </span><span class="n">多核情况使能MMU</span>
<span class="p">.</span><span class="n">Lsecondary_start</span><span class="o">:</span>
<span class="cp">#ifdef CONFIG_SMP</span>
<span class="w">    </span><span class="cm">/* Set trap vector to spin forever to help debug */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">Lsecondary_park</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">CSR_STVEC</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span>

<span class="w">    </span><span class="n">slli</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">LGREG</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">__cpu_up_stack_pointer</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">__cpu_up_task_pointer</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * This hart didn\'t win the lottery, so we wait for the winning hart to</span>
<span class="cm">     * get far enough along the boot process that it should continue.</span>
<span class="cm">     */</span>
<span class="p">.</span><span class="n">Lwait_for_cpu_up</span><span class="o">:</span>
<span class="w">    </span><span class="cm">/* FIXME: We should WFI to save some energy here. */</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
<span class="w">    </span><span class="n">beqz</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">Lwait_for_cpu_up</span>
<span class="w">    </span><span class="n">beqz</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">Lwait_for_cpu_up</span>
<span class="w">    </span><span class="n">fence</span>

<span class="w">    </span><span class="cm">/* Enable virtual memory and relocate to virtual address */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">swapper_pg_dir</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">relocate</span>

<span class="w">    </span><span class="n">tail</span><span class="w"> </span><span class="n">smp_callin</span>
<span class="cp">#endif</span>

<span class="n">②主hart</span><span class="w"> </span><span class="n">使能mmu</span>
<span class="n">_start_kernel</span>
<span class="w">   </span><span class="n">la</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">early_pg_dir</span>
<span class="w">   </span><span class="n">call</span><span class="w"> </span><span class="n">relocate</span>

<span class="nl">relocate</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/* Relocate return address */</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_OFFSET</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">_start</span>
<span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">ra</span><span class="p">,</span><span class="w"> </span><span class="n">ra</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span>
<span class="w">    </span><span class="n">③</span><span class="w"> </span><span class="n">PAGE_OFFSET</span><span class="p">(</span><span class="n">内核的虚拟地址</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_start</span><span class="p">(</span><span class="n">内核加载的物理内存</span><span class="p">)</span><span class="w"> </span><span class="n">得到虚拟地址相对物理地址的偏移</span><span class="err">，</span><span class="n">ra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ra</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">PAGE_OFFSET</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_start</span><span class="p">)</span><span class="err">，</span><span class="n">相当于计算了ra的虚拟地址</span><span class="err">。</span>
<span class="w">    </span><span class="cm">/* Point stvec to virtual address of intruction after satp write */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="mf">1f</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span>
<span class="n">csrw</span><span class="w"> </span><span class="n">CSR_STVEC</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>
<span class="n">④</span><span class="w"> </span><span class="n">将便签1转化为虚拟地址</span><span class="err">，</span><span class="n">a1存储的还是va_pa_offset</span><span class="err">，</span><span class="n">再将标签1处的虚拟地址填充到stvec寄存器</span><span class="err">，</span><span class="n">设置中断的入口函数</span><span class="err">。</span>
<span class="w">    </span><span class="cm">/* Compute satp for kernel page tables, but don\'t load it yet */</span>
<span class="w">    </span><span class="n">srl</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="w">  </span><span class="n">a0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">early_pg_dir</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">early_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">SATP_MODE</span><span class="w">      </span><span class="n">a1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="n">s</span><span class="w"> </span><span class="n">atp的模式</span><span class="err">，</span><span class="mi">3</span><span class="n">级页表</span>
<span class="w">    </span><span class="n">or</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="w">           </span><span class="n">a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">early_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="n">⑤</span><span class="w"> </span><span class="n">计算satp寄存器的值</span><span class="err">，</span><span class="n">mod为8代表3级页表</span><span class="err">，</span><span class="n">根目录页表的地址为early_pg_dir</span><span class="err">，</span><span class="n">这个页表在set_vm填充的页表</span><span class="err">，</span><span class="n">包括内核的镜像的粗粒度映射</span><span class="err">。</span><span class="n">这里只是先计算当前的值</span><span class="err">，</span><span class="n">但是先不写到satp寄存器</span><span class="err">。</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Load trampoline page directory, which will cause us to trap to</span>
<span class="cm">     * stvec if VA != PA, or simply fall through if VA == PA.  We need a</span>
<span class="cm">     * full fence here because setup_vm() just wrote these PTEs and we need</span>
<span class="cm">     * to ensure the new translations are in use.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">trampoline_pg_dir</span><span class="w"> </span>
<span class="w">    </span><span class="n">srl</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="w">    </span><span class="n">trampoline_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span>
<span class="w">    </span><span class="n">or</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="w">            </span><span class="n">trampoline_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="n">sfence</span><span class="p">.</span><span class="n">vma</span>
<span class="n">csrw</span><span class="w"> </span><span class="n">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="w">      </span><span class="n">satp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trampoline_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span>
<span class="n">⑥</span><span class="w"> </span><span class="n">satp设置的页表是trampoline_pg_dir</span><span class="err">，</span><span class="n">页表trampoline_pg_di</span><span class="o">/</span><span class="n">trampoline_pmd在setup_vm中对PAGE_OFFSET</span><span class="o">~</span><span class="n">PAGE_OFFSET</span><span class="o">+</span><span class="mi">2</span><span class="n">M的空间做了粗粒度映射</span><span class="err">。</span><span class="n">a0</span><span class="o">=</span><span class="n">trampoline_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span><span class="err">，</span><span class="n">将a0的值写如到satp的那一刻</span><span class="err">，</span><span class="n">MMU就使能了</span><span class="err">，</span><span class="n">寻址的地址就需要经过MMU来翻译</span><span class="err">，</span><span class="n">因此PC下一条指令的取值地址</span><span class="err">，</span><span class="n">需要经过MMU翻译</span><span class="err">，</span><span class="n">但是下一条指令依旧是物理地址</span><span class="err">，</span><span class="n">MMU没有对应的页表就会陷入异常</span><span class="err">，</span><span class="n">具体过程如下</span><span class="err">：</span>

<span class="mh">0x802000f4</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">244</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="n">a0</span><span class="p">,</span><span class="mi">-240</span>
<span class="mh">0x802000f8</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">248</span><span class="o">&gt;</span><span class="w"> </span><span class="n">srli</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="n">a0</span><span class="p">,</span><span class="mh">0xc</span>
<span class="mh">0x802000fa</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">250</span><span class="o">&gt;</span><span class="w"> </span><span class="n">or</span><span class="w">      </span><span class="n">a0</span><span class="p">,</span><span class="n">a0</span><span class="p">,</span><span class="n">a1</span><span class="w"> </span>
<span class="o">=&gt;</span><span class="w">  </span><span class="mh">0x80200100</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">256</span><span class="o">&gt;</span><span class="w"> </span><span class="n">csrw</span><span class="w">    </span><span class="n">satp</span><span class="p">,</span><span class="n">a0</span><span class="w">                                                                                                                                                                       </span>
<span class="mh">0x80200104</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">260</span><span class="o">&gt;</span><span class="w"> </span><span class="n">auipc</span><span class="w">   </span><span class="n">a0</span><span class="p">,</span><span class="mh">0x0</span><span class="w">                                                                                                                                                                        </span>
<span class="mh">0x80200108</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">264</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="n">a0</span><span class="p">,</span><span class="mi">104</span><span class="w">                                                                                                                                                                     </span>
<span class="mh">0x8020010c</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">268</span><span class="o">&gt;</span><span class="w"> </span><span class="n">csrw</span><span class="w">    </span><span class="n">stvec</span><span class="p">,</span><span class="n">a0</span><span class="w">                                                                                                                                                                      </span>
<span class="mh">0x80200110</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">272</span><span class="o">&gt;</span><span class="w"> </span><span class="n">auipc</span><span class="w">   </span><span class="n">gp</span><span class="p">,</span><span class="mh">0x880</span><span class="w">                                                                                                                                                                      </span>
<span class="mh">0x80200114</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">276</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addi</span><span class="w">    </span><span class="n">gp</span><span class="p">,</span><span class="n">gp</span><span class="p">,</span><span class="mi">1976</span><span class="w">                                                                                                                                                                    </span>
<span class="mh">0x80200118</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">280</span><span class="o">&gt;</span><span class="w"> </span><span class="n">csrw</span><span class="w">    </span><span class="n">satp</span><span class="p">,</span><span class="n">a2</span><span class="w">               </span>
<span class="n">如上的指令</span><span class="err">，</span><span class="n">PC运行到0x80200100</span><span class="err">，</span><span class="n">这句的指令就是向satp写入a0的值</span><span class="err">，</span><span class="n">执行完这条指令后就使能了MMU</span><span class="err">，</span><span class="n">后续的取指令地址都需要经过MMU翻译</span><span class="err">。</span><span class="n">当继续运行到下一条时PC</span><span class="o">=</span><span class="mh">0x80200104</span><span class="n">地址</span><span class="err">，</span><span class="mh">0x80200104</span><span class="n">需要经过MMU翻译</span><span class="err">，</span><span class="n">但是MMU查询不到页表就会进入异常</span><span class="err">，</span><span class="n">而跳转到异常的入口函数由上述④过程填充的1f</span><span class="err">（</span><span class="n">虚拟地址</span><span class="err">），</span><span class="n">因此下面的1f是异常处理的入口</span><span class="err">。</span>
<span class="n">这里使用trampoline_pg_dir页表看起来是多余了</span><span class="err">，</span><span class="n">其实可以直接使用early_pg_dir</span><span class="err">，</span><span class="n">也做过实验把csrw</span><span class="w"> </span><span class="n">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="n">直接改为csrw</span><span class="w"> </span><span class="n">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="err">，</span><span class="n">并把set_vm中关于trampoline_pg_dir的映射注释掉</span><span class="err">，</span><span class="n">系统也能正常起来</span><span class="err">，</span><span class="n">因此暂不清楚linux上游不把这个删除掉</span><span class="err">。</span>

<span class="p">.</span><span class="n">align</span><span class="w"> </span><span class="mi">2</span>
<span class="mi">1</span><span class="o">:</span>
<span class="w">   </span><span class="n">⑦这段代码是异常进入的入口</span><span class="err">，</span><span class="n">依旧使用虚拟地址取指运行</span><span class="err">。</span>
<span class="w">    </span><span class="cm">/* Set trap vector to spin forever to help debug */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">Lsecondary_park</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">CSR_STVEC</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span>
<span class="w">   </span><span class="n">⑧重新更新异常的入口为</span><span class="p">.</span><span class="n">Lsecondary_park</span>
<span class="w">    </span><span class="cm">/* Reload the global pointer */</span>
<span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">push</span>
<span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">norelax</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">gp</span><span class="p">,</span><span class="w"> </span><span class="n">__global_pointer$</span>
<span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">pop</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Switch to kernel page tables.  A full fence is necessary in order to</span>
<span class="cm">     * avoid using the trampoline translations, which are only correct for</span>
<span class="cm">     * the first superpage.  Fetching the fence is guarnteed to work</span>
<span class="cm">     * because that first superpage is translated the same way.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>
<span class="w">    </span><span class="n">sfence</span><span class="p">.</span><span class="n">vma</span>
<span class="w">    </span><span class="n">⑨</span><span class="w"> </span><span class="n">重新更新satp</span><span class="o">=</span><span class="n">early_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="n">ret</span>
</code></pre></div>
<p>当使能MMU时，下一条指令的取指就需要经过MMU进行翻译，但是下一条指令的地址依旧是物理地址，MMU查询不到对应的页表就会进入异常，而异常的入口实现使用了虚拟地址进行填充，虚拟地址的页表也在set_vm中进行了填充，因此虚拟地址是可以通过MMU查表找到物理地址，这样就从物理地址过渡到了虚拟地址的运行。</p>
<p>针对前面做个小结： 引导linux系统启动，需要解决的是物理地址切换到虚拟地址运行，而分界点就是写satp寄存器，使能MMU的那一刻。虚拟地址转化为物理地址，而关键点就是为MMU分配页表并填充好页表，而此时内存管理未初始化，又分配不了，所以总结下，就遇到了如下的问题。 6.内存管理没准备好。 7.需要分配页表。 8.开了MMU后，分配的页表能够用虚拟地址访问。 9.开了MMU后，要能够用虚拟地址访问内核。 10.开了MMU后，能够用虚拟地址访问设备树。 针对上面的问题对应的解决办法： 1.提前定义全局的静态数组用于做页表。 2.对内核vmlinux做粗粒度映射。 3.固定一段虚拟地址fixmap用于访问设备树、新分配的页表。 4.物理地址到虚拟地址的切换巧妙使用进异常进行转化。</p></div>
  <div class="post-nav">
    <a class="prev" href="/note_page/posts/risc-v/临时虚拟地址空间映射.html">← 临时虚拟地址空间映射</a>
    <a class="next" href="/note_page/posts/risc-v/虚拟地址与物理地址概念.html">虚拟地址与物理地址概念 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="/note_page/assets/site.js"></script>
  </body>
  </html>

