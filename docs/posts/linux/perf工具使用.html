<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>perf工具使用 - Laumy的技术栈</title>
    <link rel="stylesheet" href="/laumy.github.io/assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="/laumy.github.io/">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="/laumy.github.io/">首页</a></div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#perf">perf介绍</a><ul><li><a href="#perf-record">perf record</a></li><li><a href="#perf-report">perf report</a></li><li><a href="#perf-script">perf script</a></li></ul></li><li><a href="#_1">实践应用</a><ul><li><a href="#perf-sched">perf sched</a></li><li><a href="#perf-irq">perf irq</a></li><li><a href="#_2">火焰图</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>perf工具使用</h1>
  <div class="meta">2025-05-14 · linux</div>
  <div class="post-content"><h2 id="perf">perf介绍</h2>
<p>perf 是一个强大的 Linux 性能分析工具，广泛用于分析程序的性能瓶颈，帮助开发者进行调优。perf 工具能够收集并分析多种硬件和软件事件，包括 CPU 的指令执行、缓存命中与失误、上下文切换等。</p>
<ul>
<li>硬件事件驱：通过访问 CPU 的 PMU（性能监控单元）捕获硬件级事件，如 CPU 周期数、缓存命中/未命中、分支预测失败等。</li>
<li>
<p>采样与统计机制：采样模式，周期性记录程序执行状态，生成热点函数分布（默认基于 CPU 时钟周期）；统计模式，精确记录特定事件的发生次数（如指令数、缓存访问次数）；</p>
</li>
<li>
<p>内核集成优势：直接调用内核的 tracepoint 和 kprobe 机制，支持用户态与内核态的全栈追</p>
</li>
</ul>
<p>基本语法：</p>
<div class="codehilite"><pre><span></span><code><span class="n">perf</span><span class="w"> </span><span class="o">&lt;</span><span class="n">command</span><span class="o">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">options</span><span class="p">]</span>
</code></pre></div>
<ul>
<li>command：perf 工具的子命令，例如 record、stat、report 等。</li>
<li>options：提供给 command 的选项和参数。</li>
</ul>
<h3 id="perf-record">perf record</h3>
<p>perf record 命令用于收集性能数据，通常用来分析程序的性能瓶颈。</p>
<div class="codehilite"><pre><span></span><code><span class="n">perf</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">[</span><span class="n">options</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="n">command</span><span class="o">&gt;</span>
</code></pre></div>
<ul>
<li>-p \<pid>：指定要分析的进程的 PID。</pid></li>
<li>-F \<frequency>：指定采样的频率（每秒钟采样次数）。例如，-F 99 每秒采样 99 次。</frequency></li>
<li>-g：收集调用图信息（调用栈信息），可以用来分析函数调用的上下文。</li>
<li>-e \<event>：指定要计数的事件。例如：-e cycles 计数 CPU 周期，-e cache-misses 计数缓存未命中</event></li>
<li>-- sleep \<time>：执行指定命令，并在给定的时间内采样性能数据。例如，-- sleep 30 表示记录 30 秒的数据。</time></li>
</ul>
<p>示例：</p>
<div class="codehilite"><pre><span></span><code><span class="n">perf</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="o">-</span><span class="n">F</span><span class="w"> </span><span class="mi">99</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">12345</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">sleep</span><span class="w"> </span><span class="mi">30</span>
<span class="cp"># 这会对进程 PID 为 12345 的程序进行 30 秒的性能采样，采样频率为99Hz（默认是1000HZ），并收集调用图信息。</span>
<span class="cp"># record生成的是原始数据bin，无法直接查看，默认是生成perf.data，可以使用-o指定输出文件。</span>
<span class="cp"># 需要使用perf script转化才可解析。</span>
</code></pre></div>
<h3 id="perf-report">perf report</h3>
<p>perf report 命令用于分析和展示 perf record 记录的性能数据。</p>
<div class="codehilite"><pre><span></span><code><span class="n">perf</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="p">[</span><span class="n">options</span><span class="p">]</span>
</code></pre></div>
<ul>
<li>-g：显示调用图（调用堆栈）信息，帮助分析函数的调用关系，如果要绘制图像，需要加这个参数。</li>
<li>-i \<file>：指定输入文件，默认情况下会使用 perf.data 文件。</file></li>
</ul>
<p>示例：</p>
<div class="codehilite"><pre><span></span><code><span class="n">perf</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="o">-</span><span class="n">g</span>
</code></pre></div>
<p>这会显示 perf record 记录的性能数据的调用图。</p>
<h3 id="perf-script">perf script</h3>
<p>perf script 是一个 perf 工具的子命令，主要用于将 perf record 采集到的性能数据转换为可读的格式，并允许用户对其进行进一步处理。它的主要功能是解析性能数据文件并输出到标准输出或指定文件，方便进一步分析。</p>
<div class="codehilite"><pre><span></span><code><span class="n">perf</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="p">[</span><span class="n">options</span><span class="p">]</span>
</code></pre></div>
<p>将 perf record 生成的性能数据（默认文件名为 perf.data）转化为易于阅读的文本格式。可以与其他工具结合，进一步分析和处理数据。</p>
<div class="codehilite"><pre><span></span><code><span class="n">perf</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">perf</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">txt</span>

<span class="n">指定输入文件转化为输出文件</span><span class="err">。</span>
</code></pre></div>
<h2 id="_1">实践应用</h2>
<h3 id="perf-sched">perf sched</h3>
<p>perf sched 是 perf 工具中的一个子命令，用于分析与调度相关的性能数据，主要用于分析 Linux 系统中的调度器行为（即进程和线程的调度）。这个命令可以帮助开发人员深入了解进程或线程如何在 CPU 上执行，以及在多核系统上如何分配 CPU 时间。</p>
<p>perf sched 命令通过分析内核的调度事件（如进程切换、上下文切换、进程调度延迟等），帮助开发人员识别系统中可能的调度瓶颈或性能问题。</p>
<p><strong>抓取数据</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">perf</span><span class="w"> </span><span class="n">sched</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">sched_raw</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">&amp;</span>

<span class="n">解析数据</span><span class="err">：</span>

<span class="n">killall</span><span class="w"> </span><span class="n">perf</span>
<span class="cp">#结束进程，注意是不要使用-9强行退出，需要等待退出，保证写入的文件完整。</span>

<span class="n">perf</span><span class="w"> </span><span class="n">sched</span><span class="w"> </span><span class="n">timehist</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">sched_raw</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sched_timehist</span><span class="p">.</span><span class="n">log</span>

<span class="n">perf</span><span class="w"> </span><span class="n">sched</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">sched_raw</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sched_latency</span><span class="p">.</span><span class="n">log</span>
<span class="cp"># 显示进程或线程的调度延迟，帮助你理解调度延迟如何影响系统性能。</span>

<span class="n">perf</span><span class="w"> </span><span class="n">sched</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">sched_raw</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sched</span><span class="p">.</span><span class="n">log</span>
</code></pre></div>
<p><strong>解析数据</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">killall</span><span class="w"> </span><span class="n">perf</span>
<span class="cp">#结束进程，注意是不要使用-9强行退出，需要等待退出，保证写入的文件完整。</span>

<span class="n">perf</span><span class="w"> </span><span class="n">sched</span><span class="w"> </span><span class="n">timehist</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">sched_raw</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sched_timehist</span><span class="p">.</span><span class="n">log</span>

<span class="n">perf</span><span class="w"> </span><span class="n">sched</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">sched_raw</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sched_latency</span><span class="p">.</span><span class="n">log</span>
<span class="cp"># 显示进程或线程的调度延迟，帮助你理解调度延迟如何影响系统性能。</span>

<span class="n">perf</span><span class="w"> </span><span class="n">sched</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">sched_raw</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sched</span><span class="p">.</span><span class="n">log</span>
</code></pre></div>
<h3 id="perf-irq">perf irq</h3>
<p>perf irq是perf 工具中的一个子命令，用于分析与中断（IRQ, Interrupt Request）相关的性能数据。中断是操作系统用来响应硬件或软件事件的机制。perf irq 可以帮助开发者分析中断的发生频率、持续时间及其对系统性能的影响。</p>
<p><strong>抓取数据</strong></p>
<p>抓取中断的进入和退出</p>
<div class="codehilite"><pre><span></span><code><span class="n">perf</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">irq</span><span class="o">:</span><span class="n">irq_handler_entry</span><span class="p">,</span><span class="n">irq</span><span class="o">:</span><span class="n">irq_handler_exit</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">irq_raw</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">&amp;</span>
</code></pre></div>
<p><strong>解析数据</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">killall</span><span class="w"> </span><span class="n">perf</span>

<span class="n">perf</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">irq_raw</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">irq</span><span class="p">.</span><span class="n">log</span>
<span class="n">perf</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">irq_raw</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">irq_report</span><span class="p">.</span><span class="n">log</span>
</code></pre></div>
<h3 id="_2">火焰图</h3>
<p>通过perf script将原始数据转换的数据，可以使用工具转换为火焰图。需要注意的时，在使用perf script转换之前，perf record需要加-g参数，记录调用栈。</p>
<p>火焰图工具下载链接：<a href="https://github.com/brendangregg/FlameGraph">https://github.com/brendangregg/FlameGraph</a></p>
<p>下面是转换命令：</p>
<div class="codehilite"><pre><span></span><code><span class="p">..</span><span class="o">/</span><span class="n">FlameGraph</span><span class="o">-</span><span class="n">master</span><span class="o">/</span><span class="n">stackcollapse</span><span class="o">-</span><span class="n">perf</span><span class="p">.</span><span class="n">pl</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sched</span><span class="p">.</span><span class="n">log</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">FlameGraph</span><span class="o">-</span><span class="n">master</span><span class="o">/</span><span class="n">flamegraph</span><span class="p">.</span><span class="n">pl</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sched</span><span class="p">.</span><span class="n">svg</span>
</code></pre></div>
<p>其中sched.log是perf script转换的处理的数据，先使用stackcollapse-perf.pl处理数据，然后再使用flamegraph.pl绘制图像，即可使用网页打开。</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/05/wp_editor_md_51abac8beee2dee0ca6db0c96bedf93c.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/性能工具/perf工具使用/images/wp_editor_md_51abac8beee2dee0ca6db0c96bedf93c.jpg"/></a></p>
<p>y轴(竖)表示调用栈，每一层都是一个函数，调用栈越深，火焰就越高，顶部就是正在执行的函数，下方都是它的父函数。</p>
<p>x轴（横）表示抽样数，若一个函数在x轴占据的宽度越宽，就表示它被抽到的次数多，即执行的时间长。注意，x 轴不代表时间，而是所有的调用栈合并后，按字母顺序排列的。</p>
<p>火焰图就是看顶层的哪个函数占据的宽度最大。只要有"平顶"（plateaus），就表示该函数可能存在性能问题。</p>
<p>点击一层会水平放大，左上角会同时显示"Reset Zoom"，点击该链接，图片就会恢复原样。</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/05/wp_editor_md_afedbfc8905518f58d0e95529e1e61a2.jpg"><img alt="" src="/laumy.github.io/assets/doc/01-linux/性能工具/perf工具使用/images/wp_editor_md_afedbfc8905518f58d0e95529e1e61a2.jpg"/></a></p></div>
  <div class="post-nav">
    <a class="prev" href="/laumy.github.io/posts/ai/opencv基础操作.html">← opencv基础操作</a>
    <a class="next" href="/laumy.github.io/posts/ai/优化算法.html">优化算法 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="/laumy.github.io/assets/site.js"></script>
  </body>
  </html>

