<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">æ¦‚è¿°</a><ul></ul></li><li><a href="#_2">æ•°æ®ç»“æ„</a><ul></ul></li><li><a href="#cpu">CPUæ‹“æ‰‘ç»“æ„</a><ul></ul></li><li><a href="#sdsg">åˆ›å»ºsdå’Œsg</a><ul><li><a href="#diemccpusdsdcsgsgc">ä¸ºDIEå’ŒMCåˆ†é…æ¯CPUçš„sd/sdc/sg/sgcç©ºé—´</a></li><li><a href="#sd">åˆå§‹åŒ–è°ƒåº¦åŸŸsd</a></li><li><a href="#sg">åˆå§‹åŒ–è°ƒåº¦ç»„sg</a></li><li><a href="#sgc">æ„å»ºè°ƒåº¦ç»„èƒ½åŠ›sgc</a></li><li><a href="#cpumcsdrootdomaincpu-rq">å°†æ¯cpuçš„MCå±‚çº§sdã€rootdomainä¸cpu rqç»‘å®š</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-04-16
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">æ¦‚è¿°</h2>
<p>ä»ä¸Šä¸€ç« èŠ‚å¤§æ¦‚åº”è¯¥èƒ½å¤Ÿç†è§£è´Ÿè½½å’Œåˆ©ç”¨ç‡çš„åŒºåˆ«äº†ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨è¿è¡Œæˆ–è€…å³ä½¿æ²¡æœ‰åœ¨cpuä¸Šè¿è¡Œï¼Œè€Œåœ¨å°±ç»ªé˜Ÿåˆ—ä¸­ç­‰å¾…è¿è¡Œï¼Œé‚£ä¹ˆä»–ä¾æ—§æ¶ˆè€—cpuçš„è´Ÿè½½ã€‚è¿™æ˜¯åˆç†çš„ï¼Œå› ä¸ºcpuçš„å°±ç»ªé˜Ÿåˆ—æœ‰10ä¸ªä»»åŠ¡ç­‰å¾…ç€è¿è¡Œä¸5ä¸ªä»»åŠ¡ç­‰å¾…è¿è¡Œï¼Œæ˜æ˜¾æ˜¯10ä¸ªä»»åŠ¡çš„è´Ÿè½½é‡ã€‚è€Œåˆ©ç”¨ç‡åªæ˜¯å…³æ³¨æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡è€Œä¸åŒ…å«åœ¨å°±ç»ªé˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œåœ¨æŸä¸ªæ—¶é—´æ®µå†…å¯èƒ½æŸä¸ªä»»åŠ¡çš„cpuåˆ©ç”¨ç‡å¾ˆé«˜ï¼Œä½†æ˜¯å ç”¨å®Œä¹‹åä¸€ç›´ç¡çœ ï¼Œé‚£ä¹ˆå…¶é˜Ÿç³»ç»Ÿçš„è´Ÿè½½è´¡çŒ®è¿˜æ˜¯è¾ƒå°ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_7899f9010271eec5a7d023fca4dd488b.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/10-è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ/images/wp_editor_md_7899f9010271eec5a7d023fca4dd488b.jpg"/></a></p>
<p>ä»CPUçš„å±‚æ¬¡åˆ’åˆ†ï¼Œä»å¤§åˆ°å°åˆ†ä¸ºï¼š</p>
<ul>
<li>NUMA: å¤šä¸ªSOCç»„æˆï¼Œé€šè¿‡UPIå¯ä»¥å…±äº«å¤šå—ç‰©ç†å†…å­˜ï¼Œå¸¸ç”¨äºæœåŠ¡å™¨ã€‚</li>
<li>SOC: system-on-a-chipï¼Œé›†æˆäº†å¤šä¸ªç³»ç»Ÿç»„ä»¶æˆ–åŠŸèƒ½çš„èŠ¯ç‰‡ï¼Œå¯¹åº”DIEã€‚</li>
<li>MC:multi-coreï¼Œå¤šæ ¸å¤„ç†å™¨ï¼Œä¸€ä¸ªSOCé›†æˆå¤šä¸ªæ ¸å¿ƒï¼Œæ¯ä¸ªæ ¸å¿ƒç”¨äºè‡ªå·±çš„ç¼“å­˜æˆ–å¯„å­˜å™¨èµ„æºï¼Œå¯ä»¥å¹¶è¡Œå¤„ç†å¤šä¸ªç¨‹åºã€‚</li>
<li>SMT:Simultaneous Multi-Threadingï¼Œè¶…çº¿ç¨‹ï¼Œå•ä¸ªæ ¸å¿ƒå¤„ç†å™¨åŒæ—¶æ‰§è¡Œå¤šä¸ªçº¿ç¨‹ï¼Œåœ¨å•ä¸ªæ ¸å¿ƒå¤„ç†å™¨å¼•å…¥å¤šä¸ªé€»è¾‘æ‰§è¡Œå•å…ƒå’Œèµ„æºå…±äº«æè‡´ï¼Œå®ç°æ›´å¥½çš„æŒ‡ä»¤é›†å¹¶å‘æ€§ã€‚</li>
</ul>
<p>ç°åœ¨çš„åµŒå…¥å¼å¤„ç†å™¨é€šå¸¸åŒ…å«SOC+MCæŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ªSOCä¸Šé›†æˆäº†å¤šæ ¸å¤„ç†å™¨ï¼Œç›®å‰é‡åˆ°çš„SMTå’ŒNUMAçš„è¿˜æ¯”è¾ƒå°‘ï¼Œå› æ­¤æœ¬ç« èŠ‚å…ˆè®¨è®ºä¸€ä¸ªSOCä¸Šé›†æˆMCçš„æƒ…å†µã€‚ å› ä¸ºå¤šæ ¸çš„å‡ºç°ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥è´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³å°†SOCè¿è¡Œçš„ä»»åŠ¡å‡è¡¡çš„åˆ†é…åˆ°å„ä¸ªæ ¸ä¸Šå¤„ç†ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ç®€å•çš„å¹³å‡åˆ†é…ä»»åŠ¡åˆ°å„ä¸ªCPUä¸Šï¼Œä»ä¸Šå›¾çš„æ¶æ„æ¥çœ‹ï¼Œä¸€ä¸ªSOCä¸Šå­˜åœ¨å¤§å°æ ¸çš„æƒ…å†µ2ä¸ªå°æ ¸+2ä¸ªå¤§æ ¸ï¼Œé‚£è‡ªç„¶å¤§æ ¸çš„ç®—åŠ›è¦é«˜äºå°æ ¸çš„ç®—åŠ›ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘CPUçš„é¢‘ç‡ï¼ŒåŒæ ·çš„æ¶æ„æ ¸å¿ƒé«˜é¢‘çš„ç®—åŠ›è‡ªç„¶è¦é«˜äºä½é¢‘çš„ç®—åŠ›ã€‚é™¤äº†é…åˆå„CPUçš„ç®—åŠ›æ¥å‡è¡¡è´Ÿè½½å¤–ï¼Œè¿˜éœ€è¦è€ƒè™‘ä»»åŠ¡è¿ç§»çš„å¼€é”€ï¼Œä¸Šå›¾CPU0ä¸Šçš„ä»»åŠ¡è¿ç§»åˆ°CPU1ä¸Šçš„å¼€é”€ä¼šå°‘äºè¿ç§»åˆ°CPU2ä¸Šï¼Œå› ä¸ºCPU0å’ŒCPU1å…±äº«L2 cacheï¼Œå¦‚æœè¿ç§»åˆ°L2ä¸Šçš„è¯ï¼Œcacheå°±ä¼šå¤±æ•ˆï¼Œæ€§èƒ½æˆ–è®¸ä¼šå‡å¼±ã€‚åŸºäºä¸Šè¿°è¿™äº›å› ç´ ï¼Œlinuxæ„å»ºäº†ç›¸å…³çš„æ•°æ®ç»“æ„æ¥å¤„ç†è¿™äº›é—®é¢˜ï¼Œç§°ä¸ºè°ƒåº¦åŸŸå’Œè°ƒåº¦ç»„ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_2e21f150223e2f456e7dab528e5568de.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/10-è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ/images/wp_editor_md_2e21f150223e2f456e7dab528e5568de.jpg"/></a></p>
<p>ç³»ç»Ÿä¸ºäº†ä¾¿äºè´Ÿè½½å‡è¡¡ï¼Œæ„å»ºè°ƒåº¦åŸŸï¼ˆsched domainï¼Œç®€è®°sdï¼‰å’Œè°ƒåº¦ç»„(sched groupï¼Œç®€è®°sg)ã€‚æŒ‰ç…§æ¶æ„å±‚çº§å¯ä»¥ä¾æ¬¡åˆ’åˆ†ä¸ºä¸åŒçš„SOCã€ç›¸åŒSOCä¸åŒçš„æ ¸å¿ƒã€ç›¸åŒçš„æ ¸å¿ƒä¸åŒçš„è¶…çº¿ç¨‹ã€‚æˆ‘ä»¬æŠŠç›¸åŒå±‚çº§ç§°ä¸ºè°ƒåº¦åŸŸï¼Œè¶Šå¾€ä¸‹å±‚çš„è°ƒåº¦åŸŸå…±ç”¨çš„ç¼“å­˜è¶Šå¤šï¼Œå› æ­¤åœ¨ä»»åŠ¡åšè¿ç§»æ—¶ï¼Œä¼˜å…ˆé€‰æ‹©ä»åº•å±‚çš„è°ƒåº¦åŸŸä¸­è¿›è¡Œã€‚å…ˆä¸è€ƒè™‘SMTï¼Œä¸Šå›¾çš„è°ƒåº¦åŸŸå¯ä»¥åˆ†ä¸ºä¸¤çº§ä»ä¸‹å¾€ä¸ŠMC domainï¼ˆmulti core domainï¼‰ï¼ŒDIE domainã€‚</p>
<ul>
<li>DIE domainï¼šå¤„äºé¡¶å±‚ï¼Œè¦†ç›–ç³»ç»Ÿæ‰€æœ‰çš„CPUï¼ˆCPU0~CPU3ï¼‰ã€‚</li>
<li>MC domainï¼šå¤„äºåº•å±‚ï¼Œä¹Ÿç§°ä¸ºbase domainï¼Œåˆ†ä¸ºå°æ ¸MC domainï¼ˆcpu0~cpu1ï¼‰å’Œå¤§æ ¸MC domainï¼ˆCPU2~CPU3ï¼‰ï¼Œå°æ ¸MC domainæ˜¯ä¸€ä¸ªclusterï¼Œå¤§æ ¸MC domainæ˜¯ä¸€ä¸ªclusterã€‚</li>
</ul>
<p>è´Ÿè½½å‡è¡¡è°ƒåº¦çš„æœ€å°å•å…ƒæ˜¯è°ƒåº¦ç»„ï¼Œæ¯ä¸ªè°ƒåº¦åŸŸè¿›è¡Œåˆ†ç»„ã€‚å¯¹äºMCåŸŸï¼ŒåŸºæœ¬å¯ä»¥æŒ‰ç…§ä¸€ä¸ªcpuæ˜¯ä¸€ç»„ï¼Œæ‰€ä»¥å°æ ¸MC domainå¯ä»¥åˆ†ä¸ºä¸¤ç»„ï¼ˆä¸€ä¸ªCPUå¯¹åº”ä¸€ç»„ï¼‰ï¼Œå¤§æ ¸MC domainä¹Ÿæ˜¯åˆ†ä¸ºä¸¤ç»„ã€‚å¯¹äºDIEåŸŸï¼Œæ¯ä¸ªåˆ†ç»„è¦è¦†ç›–åˆ°å…¶child domainï¼ŒDIE åŸŸæœ‰ä¸¤ä¸ªå­domainï¼Œåˆ†åˆ«æ˜¯å°æ ¸MC domainï¼Œå¤§æ ¸MC domainï¼Œå› æ­¤DIE domainåˆ†ä¸ºä¸¤ä¸ªç»„å¯¹äºå°æ ¸groupå’Œå¤§æ ¸groupã€‚</p>
<h2 id="_2">æ•°æ®ç»“æ„</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_a488005fef52cf5dc4690aa63612a881.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/10-è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ/images/wp_editor_md_a488005fef52cf5dc4690aa63612a881.jpg"/></a></p>
<p>Linuxå†…æ ¸ä½¿ç”¨struct sched_domain_topology_levelï¼Œç®€ç§°SDTLæ¥æè¿°CPUçš„å±‚æ¬¡å…³ç³»ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_92716d6b3a12d29b803e07b741b7498c.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/10-è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ/images/wp_editor_md_92716d6b3a12d29b803e07b741b7498c.jpg"/></a></p>
<p>struct sched_domain_topology_level</p>
<ul>
<li>maskï¼šå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å®šcpumaskä½å›¾</li>
<li>sd_flagsï¼šå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å®šæ ‡å¿—ä½</li>
<li>flags:è¿›ä¸€æ­¥æè¿°å’Œè®¾ç½®è°ƒåº¦åŸŸ</li>
<li>numa_level:NUMAå±‚çº§ï¼Œç¡®å®šè¯¥å±‚çº§ä¸ºNUMAçš„é‚£ä¸€å±‚</li>
<li>data:è°ƒåº¦åŸŸæ•°æ®ç»“æ„ï¼Œå­˜å‚¨å…³äºè°ƒåº¦åŸŸçš„ç»Ÿè®¡ä¿¡æ¯</li>
<li>name:è°ƒåº¦åŸŸåç§°</li>
</ul>
<p>ä»¥ä¸‹æ˜¯å†…æ ¸é»˜è®¤å®šä¹‰äº†ä¸€ä¸ªå±‚æ¬¡ç»“æ„ï¼ŒDIEæ˜¯é»˜è®¤æ‰“å¼€ï¼ŒMCå’ŒSMTæ˜¯å¯é€‰çš„ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_topology_level</span><span class="w"> </span><span class="n">default_topology</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCHED_SMT</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">cpu_smt_mask</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_smt_flags</span><span class="p">,</span><span class="w"> </span><span class="n">SD_INIT_NAME</span><span class="p">(</span><span class="n">SMT</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SCHED_MC</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">cpu_coregroup_mask</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_core_flags</span><span class="p">,</span><span class="w"> </span><span class="n">SD_INIT_NAME</span><span class="p">(</span><span class="n">MC</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">cpu_cpu_mask</span><span class="p">,</span><span class="w"> </span><span class="n">SD_INIT_NAME</span><span class="p">(</span><span class="n">DIE</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_topology_level</span><span class="w"> </span><span class="o">*</span><span class="n">sched_domain_topology</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">default_topology</span><span class="p">;</span>
</code></pre></div>
<p>struct sd_data,è¯¥ç»“æ„ä½“ä¸­æˆå‘˜éƒ½ä½¿ç”¨percpuæ¥ä¿®é¥°ï¼Œç”¨äºæŒ‡ç¤ºè¯¥æŒ‡é’ˆæ˜¯ä¸€ä¸ªper-CPUå˜é‡ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨å°†å˜é‡çš„å†…å­˜åˆ†é…ä¸ºæ¯ä¸ªCPUåˆ†åˆ«ä¿ç•™çš„ç‹¬ç«‹å†…å­˜å—ï¼Œå¦‚struct sched *__percpu *sdæ˜¯æŒ‡å‘struct sched_domainç±»å‹çš„per-CPUå˜é‡ï¼Œä¹Ÿå°±æ˜¯å…¶æŒ‡å‘çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ˆæœ‰cpuä¸ªæ•°å…ƒç´ ï¼‰ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ æ˜¯æŒ‡å‘ä¸€ä¸ªstruct sched_domainç±»å‹çš„æŒ‡é’ˆï¼Œæ¯ä¸ªæŒ‡é’ˆä¸ä¸€ä¸ªç‰¹å®šçš„CPUç›¸å…³è”ï¼Œåˆ†é…æ•°ç»„æ˜¯ä½¿ç”¨alloc_percpuæ¥å®ç°ï¼Œè¯¥å‡½æ•°ä¼šåˆ†é…ä¸€ä¸ªå…·æœ‰ç›¸åŒå¤§å°çš„å—ï¼Œå¹¶ä¸ºæ¯ä¸ªcpuéƒ½åˆ†é…ä¸€ä¸ªæŒ‡é’ˆã€‚ sd = alloc_percpu(struct sched_domain *)ï¼Œåˆ™sdåˆ†é…äº†per-CPUå˜é‡çš„å†…å­˜ç©ºé—´ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªCPUéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„struct sched_domainæŒ‡é’ˆå˜é‡ï¼Œå½“ç»™å…¶æ¯ä¸ªCPUçš„æŒ‡é’ˆå˜é‡èµ‹å€¼åï¼Œåç»­å¯ä»¥é€šè¿‡sd[cpu]æ¥cpuä¸Šçš„struct sched_domainå˜é‡ã€‚</p>
<ul>
<li>sd[]: æè¿°CPUçš„è°ƒåº¦åŸŸï¼Œå®é™…æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„å…ƒç´ æŒ‡é’ˆæŒ‡å‘cpuæ‰€å±çš„è°ƒåº¦åŸŸï¼Œä¸‹åŒã€‚</li>
<li>sds[]:å­˜å‚¨è°ƒåº¦åŸŸå…±äº«æ•°æ®ï¼Œç”¨äºæè¿°å¤šä¸ªCPUå…±äº«çš„è°ƒåº¦åŸŸã€‚</li>
<li>sg[]:æ¯ä¸ªcpuéƒ½æœ‰ä¸€ä¸ªæŒ‡å‘è°ƒåº¦ç»„çš„æŒ‡é’ˆï¼Œç”¨äºæè¿°CPUæ‰€å±çš„è°ƒåº¦ç»„</li>
<li>sgc[]:è°ƒåº¦ç»„çš„å®¹é‡ä¿¡æ¯ï¼Œç”¨äºæè¿°è°ƒåº¦ç»„çš„èµ„æºå®¹é‡ã€‚</li>
</ul>
<p>åœ¨ç³»ç»Ÿä¸­ï¼Œä¸ºäº†é¿å…å¤šæ ¸ä¹‹é—´çš„äº’æ–¥è®¿é—®å½±å“æ€§èƒ½ï¼Œè°ƒåº¦åŸŸsched_domainæ•°æ®ç»“æ„é‡‡ç”¨Per-CPUçš„å˜é‡æ¥æ„å»ºï¼Œæ¯ä¸ªCPUéƒ½ç»´æŠ¤ä¸€ä¸ªè°ƒåº¦åŸŸæ•°æ®ç»“æ„ã€‚ struct sched_domain_sharedï¼Œä¸ºäº†é™ä½é”ç«äº‰ï¼Œsdæ˜¯per-cpuçš„ï¼Œä½†æ˜¯æœ‰ä¸€äº›ä¿¡æ¯éœ€è¦åœ¨per-cpuä¸Šçš„sdä¹‹é—´å…±äº«ï¼Œä¸èƒ½åœ¨æ¯ä¸ªsdä¸Šæ„å»ºï¼Œè¿™äº›å…±äº«çš„ä¿¡æ¯å°±å­˜å‚¨åœ¨sdsä¸Šã€‚</p>
<ul>
<li>nr_busy_cpus:è¯¥sdä¸­å¿™çš„cpuä¸ªæ•°ã€‚</li>
<li>has_idle_cores:è¯¥sdä¸­æ˜¯å¦æœ‰idle cpuã€‚</li>
</ul>
<p>struct sched_group_capacity</p>
<ul>
<li>capacity:</li>
<li>min/max_capacity:</li>
<li>next_update:</li>
<li>imbalance:</li>
<li>cpumask[]</li>
</ul>
<p>struct sched_domain</p>
<ul>
<li>parentå’Œchild:è°ƒåº¦åŸŸä¼šå½¢æˆå±‚æ¬¡ç»“æ„ï¼Œparentå’Œchildå»ºç«‹äº†ä¸åŒå±‚çº§çš„çˆ¶å­å…³ç³»ã€‚å¯¹äºbase domainè€Œè¨€ï¼Œå…¶child=NULLï¼Œå¯¹äºé¡¶å±‚domainè€Œè¨€ï¼Œparent=NULLã€‚</li>
<li>groups:ä¸€ä¸ªè°ƒåº¦åŸŸä¸­æœ‰è‹¥å¹²è°ƒåº¦ç»„ï¼Œè¿™äº›è°ƒåˆ°ç»„å½¢æˆä¸€ä¸ªç¯å½¢çš„é“¾è¡¨ï¼Œgroupsæˆå‘˜å°±æ˜¯é“¾è¡¨å¤´ã€‚</li>
<li>flags:è°ƒåº¦åŸŸçš„æ ‡å¿—ï¼ŒSD_BALANCE_NEWIDLEæ˜¯å¦æ”¯æŒnewidle balanceï¼ŒSD_SHARE_PKG_RESOURCESæ˜¯å¦å…±äº«cacheç­‰èµ„æºã€‚</li>
<li>span[]:è°ƒåº¦åŸŸä¸­cpu æ ¸å½¢æˆçš„cpu maskï¼Œå³è°ƒåº¦åŸŸè¦†ç›–çš„cpuæ ¸èŒƒå›´ï¼Œå½“å‰è°ƒåº¦åŸŸå¯ä½¿ç”¨é‚£å‡ ä¸ªcpuæ ¸ã€‚</li>
</ul>
<p>struct sched_group</p>
<ul>
<li>next: è°ƒåº¦åŸŸä¸­çš„æ‰€æœ‰groupéƒ½ä¼šå½¢æˆä¸€ä¸ªé“¾è¡¨ï¼ŒnextæŒ‡å‘ä¸‹ä¸€ä¸ªgroupã€‚</li>
<li>ref:è¯¥è°ƒåº¦ç»„è¢«åº”ç”¨çš„æ¬¡æ•°ã€‚</li>
<li>group_weight:è°ƒåº¦ç»„ä¸­æœ‰å¤šå°‘ä¸ªcpuã€‚</li>
<li>sgc:è°ƒåº¦ç»„çš„ç®—åŠ›ä¿¡æ¯ã€‚</li>
<li>cpumask:è°ƒåº¦ç»„åŒ…æ‹¬é‚£äº›cpuã€‚</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">cpumask</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">cpumask</span><span class="w"> </span><span class="p">{</span>
<span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span><span class="w"> </span><span class="n">NR_CPUS</span><span class="p">);</span>
<span class="c1">//unsigned long bits[1]ï¼›</span>
<span class="p">}</span>

<span class="c1">//NR_CPUSä¸ºæ ¸å¿ƒæ•°ï¼Œä»¥8æ ¸ï¼Œ64ä½ç³»ç»Ÿè®¡ç®—ä¸ºä¾‹ã€‚</span>

<span class="cp">#define DECLARE_BITMAP(name,bits) \\</span>
<span class="cp">unsigned long name[BITS_TO_LONGS(bits)]</span>

<span class="cp">#define BITS_TO_LONGS(nr)   __KERNEL_DIV_ROUND_UP(nr, BITS_PER_TYPE(long))</span>

<span class="cp">#define __KERNEL_DIV_ROUND_UP(n, d) (((n) + (d) - 1) / (d))</span>

<span class="cp">#define BITS_PER_TYPE(type) (sizeof(type) * BITS_PER_BYTE)</span>

<span class="cp">#define BITS_PER_BYTE       8</span>

<span class="p">(((</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">64</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">s_data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">sd</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">root_domain</span><span class="w">  </span><span class="o">*</span><span class="n">rd</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h2 id="cpu">CPUæ‹“æ‰‘ç»“æ„</h2>
<div class="codehilite"><pre><span></span><code><span class="n">Linuxå†…æ ¸ä¸­</span><span class="err">ï¼Œ</span><span class="n">é€šè¿‡è¯»å–dtsæ–‡ä»¶</span><span class="err">ï¼Œ</span><span class="n">å»ºç«‹Topology</span><span class="err">ã€‚</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">cpus</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#address-cells = &lt;0x02&gt;;</span>
<span class="w">        </span><span class="cp">#size-cells = &lt;0x00&gt;;</span>

<span class="w">        </span><span class="n">cpu</span><span class="err">@</span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"cpu"</span><span class="p">;</span>
<span class="w">            </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"arm,cortex-a55"</span><span class="p">;</span>
<span class="w">            </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00</span><span class="w"> </span><span class="mh">0x00</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">enable</span><span class="o">-</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"psci"</span><span class="p">;</span>
<span class="w">            </span><span class="n">cpu</span><span class="o">-</span><span class="n">idle</span><span class="o">-</span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x02</span><span class="w"> </span><span class="mh">0x03</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">capacity</span><span class="o">-</span><span class="n">dmips</span><span class="o">-</span><span class="n">mhz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x39a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x04</span><span class="w"> </span><span class="mh">0x01</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">operating</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x05</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="cp">#cooling-cells = &lt;0x02&gt;;</span>
<span class="w">            </span><span class="n">dynamic</span><span class="o">-</span><span class="n">power</span><span class="o">-</span><span class="n">coefficient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x11e</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">cpu</span><span class="o">-</span><span class="n">supply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x06</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">phandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x09</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="n">cpu</span><span class="err">@</span><span class="mi">100</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"cpu"</span><span class="p">;</span>
<span class="w">            </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"arm,cortex-a55"</span><span class="p">;</span>
<span class="w">            </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00</span><span class="w"> </span><span class="mh">0x100</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">enable</span><span class="o">-</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"psci"</span><span class="p">;</span>
<span class="w">            </span><span class="n">cpu</span><span class="o">-</span><span class="n">idle</span><span class="o">-</span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x02</span><span class="w"> </span><span class="mh">0x03</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">capacity</span><span class="o">-</span><span class="n">dmips</span><span class="o">-</span><span class="n">mhz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x39a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x04</span><span class="w"> </span><span class="mh">0x01</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">operating</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x05</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="cp">#cooling-cells = &lt;0x02&gt;;</span>
<span class="w">            </span><span class="n">phandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="n">cpu</span><span class="err">@</span><span class="mi">200</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"cpu"</span><span class="p">;</span>
<span class="w">            </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"arm,cortex-a55"</span><span class="p">;</span>
<span class="w">            </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00</span><span class="w"> </span><span class="mh">0x200</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">enable</span><span class="o">-</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"psci"</span><span class="p">;</span>
<span class="w">            </span><span class="n">cpu</span><span class="o">-</span><span class="n">idle</span><span class="o">-</span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x02</span><span class="w"> </span><span class="mh">0x03</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">capacity</span><span class="o">-</span><span class="n">dmips</span><span class="o">-</span><span class="n">mhz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x39a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x04</span><span class="w"> </span><span class="mh">0x01</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">operating</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x05</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="cp">#cooling-cells = &lt;0x02&gt;;</span>
<span class="w">            </span><span class="n">phandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0b</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="n">cpu</span><span class="err">@</span><span class="mi">300</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"cpu"</span><span class="p">;</span>
<span class="w">            </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"arm,cortex-a55"</span><span class="p">;</span>
<span class="w">            </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00</span><span class="w"> </span><span class="mh">0x300</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">enable</span><span class="o">-</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"psci"</span><span class="p">;</span>
<span class="w">            </span><span class="n">cpu</span><span class="o">-</span><span class="n">idle</span><span class="o">-</span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x02</span><span class="w"> </span><span class="mh">0x03</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">capacity</span><span class="o">-</span><span class="n">dmips</span><span class="o">-</span><span class="n">mhz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x39a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x04</span><span class="w"> </span><span class="mh">0x01</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">operating</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x05</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="cp">#cooling-cells = &lt;0x02&gt;;</span>
<span class="w">            </span><span class="n">phandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0c</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="n">cpu</span><span class="err">@</span><span class="mi">400</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"cpu"</span><span class="p">;</span>
<span class="w">            </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"arm,cortex-a55"</span><span class="p">;</span>
<span class="w">            </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00</span><span class="w"> </span><span class="mh">0x400</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">enable</span><span class="o">-</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"psci"</span><span class="p">;</span>
<span class="w">            </span><span class="n">cpu</span><span class="o">-</span><span class="n">idle</span><span class="o">-</span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x02</span><span class="w"> </span><span class="mh">0x03</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">capacity</span><span class="o">-</span><span class="n">dmips</span><span class="o">-</span><span class="n">mhz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x400</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x04</span><span class="w"> </span><span class="mh">0x03</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">operating</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x07</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="cp">#cooling-cells = &lt;0x02&gt;;</span>
<span class="w">            </span><span class="n">dynamic</span><span class="o">-</span><span class="n">power</span><span class="o">-</span><span class="n">coefficient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x162</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">cpu</span><span class="o">-</span><span class="n">supply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x08</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">phandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0d</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="n">cpu</span><span class="err">@</span><span class="mi">500</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"cpu"</span><span class="p">;</span>
<span class="w">            </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"arm,cortex-a55"</span><span class="p">;</span>
<span class="w">            </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00</span><span class="w"> </span><span class="mh">0x500</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">enable</span><span class="o">-</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"psci"</span><span class="p">;</span>
<span class="w">            </span><span class="n">cpu</span><span class="o">-</span><span class="n">idle</span><span class="o">-</span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x02</span><span class="w"> </span><span class="mh">0x03</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">capacity</span><span class="o">-</span><span class="n">dmips</span><span class="o">-</span><span class="n">mhz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x400</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x04</span><span class="w"> </span><span class="mh">0x03</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">operating</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x07</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="cp">#cooling-cells = &lt;0x02&gt;;</span>
<span class="w">            </span><span class="n">phandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0e</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="n">cpu</span><span class="err">@</span><span class="mi">600</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"cpu"</span><span class="p">;</span>
<span class="w">            </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"arm,cortex-a55"</span><span class="p">;</span>
<span class="w">            </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00</span><span class="w"> </span><span class="mh">0x600</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">enable</span><span class="o">-</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"psci"</span><span class="p">;</span>
<span class="w">            </span><span class="n">cpu</span><span class="o">-</span><span class="n">idle</span><span class="o">-</span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x02</span><span class="w"> </span><span class="mh">0x03</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">capacity</span><span class="o">-</span><span class="n">dmips</span><span class="o">-</span><span class="n">mhz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x400</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x04</span><span class="w"> </span><span class="mh">0x03</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">operating</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x07</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="cp">#cooling-cells = &lt;0x02&gt;;</span>
<span class="w">            </span><span class="n">phandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0f</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="n">cpu</span><span class="err">@</span><span class="mi">700</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"cpu"</span><span class="p">;</span>
<span class="w">            </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"arm,cortex-a55"</span><span class="p">;</span>
<span class="w">            </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00</span><span class="w"> </span><span class="mh">0x700</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">enable</span><span class="o">-</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"psci"</span><span class="p">;</span>
<span class="w">            </span><span class="n">cpu</span><span class="o">-</span><span class="n">idle</span><span class="o">-</span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x02</span><span class="w"> </span><span class="mh">0x03</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">capacity</span><span class="o">-</span><span class="n">dmips</span><span class="o">-</span><span class="n">mhz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x400</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x04</span><span class="w"> </span><span class="mh">0x03</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">operating</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x07</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="cp">#cooling-cells = &lt;0x02&gt;;</span>
<span class="w">            </span><span class="n">phandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x10</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="n">cpu</span><span class="o">-</span><span class="n">map</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="n">cluster0</span><span class="w"> </span><span class="p">{</span>

<span class="w">                </span><span class="n">core0</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x09</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="p">};</span>

<span class="w">                </span><span class="n">core1</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="p">};</span>

<span class="w">                </span><span class="n">core2</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0b</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="p">};</span>

<span class="w">                </span><span class="n">core3</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0c</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="p">};</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="n">cluster1</span><span class="w"> </span><span class="p">{</span>

<span class="w">                </span><span class="n">core0</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0d</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="p">};</span>

<span class="w">                </span><span class="n">core1</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0e</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="p">};</span>

<span class="w">                </span><span class="n">core2</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0f</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="p">};</span>

<span class="w">                </span><span class="n">core3</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x10</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="p">};</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p>ä¸Šé¢çš„dtsæè¿°ï¼Œsocä¸­æœ‰8ä¸ªæ ¸å¿ƒï¼Œåˆ†ä¸ºä¸¤ä¸ªclusterï¼Œcpu0~cpu3ï¼Œcpu4~cpu7ï¼Œå› æ­¤è°ƒåº¦åŸŸå¯ä»¥è¿™æ ·åˆ’åˆ†ã€‚</p>
<ul>
<li>DIE: cpu 0~7</li>
<li>MC: cpu 0~3ä¸€ç»„ï¼Œcpu4~7ä¸€ç»„ã€‚</li>
</ul>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_85351c787565585bdea6b8eb17e513f1.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/10-è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ/images/wp_editor_md_85351c787565585bdea6b8eb17e513f1.jpg"/></a></p>
<p>å¯ä»¥é€šè¿‡ /sys/devices/system/cpu/cpuX/topologyèŠ‚ç‚¹æ¥è·å–topologyç›¸å…³ä¿¡æ¯ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">root</span><span class="err">@</span><span class="n">TinaLinux</span><span class="o">:/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">cpu0</span><span class="o">/</span><span class="n">topology</span><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">*</span>
<span class="mo">01</span><span class="w"> </span><span class="c1">//core_cpus </span>
<span class="mi">0</span><span class="w"> </span><span class="c1">//core_cpus_list</span>
<span class="mi">0</span><span class="w"> </span><span class="c1">//core_id</span>
<span class="mf">0f</span><span class="w"> </span><span class="c1">//core_siblings</span>
<span class="mi">0-3</span><span class="w"> </span><span class="c1">//core_siblings_list</span>
<span class="mo">01</span><span class="w"> </span><span class="c1">//die_cpus</span>
<span class="mi">0</span><span class="w"> </span><span class="c1">//die_cpus_list</span>
<span class="mi">-1</span><span class="w"> </span><span class="c1">//die_id</span>
<span class="mf">0f</span><span class="w"> </span><span class="c1">//package_cpus</span>
<span class="mi">0-3</span><span class="w"> </span><span class="c1">//package_cpus_list</span>
<span class="mi">0</span><span class="w"> </span><span class="c1">//physical_package_id</span>
<span class="mo">01</span><span class="w"> </span><span class="c1">//thread_siblings</span>
<span class="mi">0</span><span class="w"> </span><span class="c1">//thread_siblings_list</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">root</span><span class="err">@</span><span class="n">TinaLinux</span><span class="o">:/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">cpu6</span><span class="o">/</span><span class="n">topology</span><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">*</span>
<span class="mi">40</span><span class="w"> </span><span class="c1">//core_cpus </span>
<span class="mi">6</span><span class="w"> </span><span class="c1">//core_cpus_list</span>
<span class="mi">2</span><span class="w"> </span><span class="c1">//core_id</span>
<span class="n">f0</span><span class="w"> </span><span class="c1">//core_siblings</span>
<span class="mi">4-7</span><span class="w"> </span><span class="c1">//core_siblings_list</span>
<span class="mi">40</span><span class="w"> </span><span class="c1">//die_cpus</span>
<span class="mi">6</span><span class="w"> </span><span class="c1">//die_cpus_list</span>
<span class="mi">-1</span><span class="w"> </span><span class="c1">//die_id</span>
<span class="n">f0</span><span class="w"> </span><span class="c1">//package_cpus</span>
<span class="mi">4-7</span><span class="w"> </span><span class="c1">//package_cpus_list</span>
<span class="mi">1</span><span class="w"> </span><span class="c1">//physical_package_id</span>
<span class="mi">40</span><span class="w"> </span><span class="c1">//thread_siblings</span>
<span class="mi">7</span><span class="w"> </span><span class="c1">//thread_siblings_list</span>
</code></pre></div>
<p>åœ¨åç»­ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬éƒ½ä»¥å½“å‰çš„æ‹“æ‰‘ç»“æ„ä¸¾ä¾‹æ¥è¯´æ˜ã€‚</p>
<h2 id="sdsg">åˆ›å»ºsdå’Œsg</h2>
<p>CPU MASK</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#define cpu_possible_mask ((const struct cpumask *)&amp;__cpu_possible_mask) </span>
<span class="c1">//ç³»ç»Ÿä¸­æœ‰å¤šå°‘ä¸ªCPUæ ¸å¯ä»¥è¿è¡Œ</span>

<span class="cp">#define cpu_online_mask   ((const struct cpumask *)&amp;__cpu_online_mask)</span>
<span class="c1">//ç³»ç»Ÿä¸­æœ‰å¤šå°‘ä¸ªCPUæ ¸æ­£åœ¨è¿è¡Œ</span>

<span class="cp">#define cpu_present_mask  ((const struct cpumask *)&amp;__cpu_present_mask)</span>
<span class="c1">//ç³»ç»Ÿä¸­æœ‰å¤šå°‘ä¸ªæ­£å¤„äºè¿è¡ŒçŠ¶æ€çš„CPUæ ¸ã€‚</span>

<span class="cp">#define cpu_active_mask   ((const struct cpumask *)&amp;__cpu_active_mask)</span>
<span class="c1">//ç³»ç»Ÿä¸­æœ‰å¤šå°‘ä¸ªæ´»è·ƒçš„CPUæ ¸</span>

<span class="cp">#define cpu_dying_mask    ((const struct cpumask *)&amp;__cpu_dying_mask)</span>
<span class="c1">//ç³»ç»Ÿä¸­æœ‰å¤šå°‘ä¸ªå°†æ­»çš„cpuæ ¸</span>

<span class="n">å¦‚æœæ²¡æœ‰CONFIG_HOTPULG_CPU</span><span class="err">ï¼Œ</span><span class="n">é‚£ä¹ˆpresent</span><span class="o">=</span><span class="n">possible</span><span class="err">ï¼Œ</span><span class="n">active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">online</span><span class="err">ã€‚</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">sched_init_domains</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_map</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">    </span><span class="n">zalloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sched_domains_tmpmask</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">    </span><span class="n">zalloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sched_domains_tmpmask2</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">    </span><span class="n">zalloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fallback_doms</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>

<span class="w">    </span><span class="n">arch_update_cpu_topology</span><span class="p">();</span>
<span class="w">    </span><span class="n">asym_cpu_capacity_scan</span><span class="p">();</span>
<span class="w">    </span><span class="n">ndoms_cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="n">doms_cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_sched_domains</span><span class="p">(</span><span class="n">ndoms_cur</span><span class="p">);</span>
<span class="c1">//åˆ›å»ºcpumask_var_tç±»å‹ï¼Œå­˜å‚¨ç”¨äºå½“å‰è°ƒåº¦åŸŸçš„å¯ç”¨çš„cpuã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">doms_cur</span><span class="p">)</span>
<span class="w">        </span><span class="n">doms_cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fallback_doms</span><span class="p">;</span>

<span class="n">cpumask_and</span><span class="p">(</span><span class="n">doms_cur</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">cpu_map</span><span class="p">,</span><span class="w"> </span><span class="n">housekeeping_cpumask</span><span class="p">(</span><span class="n">HK_FLAG_DOMAIN</span><span class="p">));</span>
<span class="c1">//cpu_mapä¸ºcpu_active_maskï¼Œåœ¨activeä¸­æ’é™¤æ‰ä¸èƒ½ç”¨äºè°ƒåº¦åŸŸçš„cpuï¼Œisolcpuså¯¹æŸäº›//cpuè¿›è¡Œçš„éš”ç¦»ï¼Œä¸å‚ä¸è°ƒåº¦åŸŸä¸­ï¼Œdoms_curæœ€ç»ˆä¿å­˜çš„æ’é™¤ä¹‹åå¯ç”¨è°ƒåº¦åŸŸçš„cpuã€‚</span>

<span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">build_sched_domains</span><span class="p">(</span><span class="n">doms_cur</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="c1">//è°ƒåº¦åŸŸå»ºç«‹ã€‚</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="diemccpusdsdcsgsgc">ä¸ºDIEå’ŒMCåˆ†é…æ¯CPUçš„sd/sdc/sg/sgcç©ºé—´</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">build_sched_domains</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_map</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_attr</span><span class="w"> </span><span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">s_alloc</span><span class="w"> </span><span class="n">alloc_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_none</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="w"> </span><span class="o">*</span><span class="n">sd</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">s_data</span><span class="w"> </span><span class="n">d</span><span class="p">;</span>
<span class="p">......</span>
<span class="w">   </span><span class="c1">//åˆ†é…DIE,MC SDTLæ‹“æ‰‘ç›¸å…³æ•°æ®ç»“æ„ï¼Œåˆå§‹åŒ–ä¸€ä¸ªstruct s_dataï¼›</span>
<span class="w">    </span><span class="n">alloc_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__visit_domain_allocation_hell</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_map</span><span class="p">);</span>
<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<p>build_shed_domainså‡½æ•°ä¸­é¦–å…ˆè°ƒç”¨__visit_domain_allocation_hellä¸ºæ¯ä¸ªcpuåˆ†é…å„ä¸ªè°ƒåº¦åŸŸå±‚çº§ï¼ˆDIE/MCï¼‰åˆ†é…sd/sdc/sg/sgcã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_topology_level</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sched_domain_mask_f</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span>
<span class="w">    </span><span class="n">sched_domain_flags_f</span><span class="w"> </span><span class="n">sd_flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w">         </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w">         </span><span class="n">numa_level</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sd_data</span><span class="w">      </span><span class="n">data</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SCHED_DEBUG</span>
<span class="w">    </span><span class="kt">char</span><span class="w">                </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="c1">//å®šä¹‰äº†ä¸€ä¸ªstatic struct sched_domain_topology_level default_topology[]å…¨å±€å˜é‡ã€‚</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_topology_level</span><span class="w"> </span><span class="n">default_topology</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCHED_SMT</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">cpu_smt_mask</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_smt_flags</span><span class="p">,</span><span class="w"> </span><span class="n">SD_INIT_NAME</span><span class="p">(</span><span class="n">SMT</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SCHED_MC</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">cpu_coregroup_mask</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_core_flags</span><span class="p">,</span><span class="w"> </span><span class="n">SD_INIT_NAME</span><span class="p">(</span><span class="n">MC</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">cpu_cpu_mask</span><span class="p">,</span><span class="w"> </span><span class="n">SD_INIT_NAME</span><span class="p">(</span><span class="n">DIE</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">},</span>
<span class="p">};</span>
</code></pre></div>
<p>å†…æ ¸å®šä¹‰äº†ä¸€ä¸ªå…¨å±€å˜é‡static struct sched_domain_topology_level default_topology[]ï¼Œè¯¥å˜é‡æ ¹æ®å®é…ç½®è°ƒåº¦åŸŸçš„å±‚æ¬¡ï¼ŒDIEè°ƒåº¦åŸŸæ˜¯é»˜è®¤å¼€å¯çš„ï¼Œå¾€ä¸‹æ˜¯MCè°ƒåº¦åŸŸï¼Œå†åˆ°SMTè°ƒåº¦åŸŸï¼Œç”±äºARMæ¶æ„SMTè°ƒåº¦ç›®å‰è§å¾—è¿˜æ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥å†ä¸è€ƒè™‘ï¼Œbuild_shed_domainså¾—æ ¸å¿ƒå°±æ˜¯å„å±‚çº§å¾—SDTLã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">s_alloc</span>
<span class="nf">__visit_domain_allocation_hell</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">s_data</span><span class="w"> </span><span class="o">*</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_map</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">));</span>
<span class="c1">//ä¸ºå…¨å±€struct sched_domain_topology_level default_topology[]çš„DIEå’ŒMCåˆ†é…å¯¹åº”çš„</span>
<span class="c1">//per-CPU sd/sds/sg/sgc</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__sdt_alloc</span><span class="p">(</span><span class="n">cpu_map</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sa_sd_storage</span><span class="p">;</span>
<span class="c1">//ä¸ºæ¯ä¸ªCPUåˆ†é…äº†ä¸€ä¸ªè°ƒåº¦åŸŸï¼Œä½œç”¨æ˜¯ç”¨æˆ·å­˜å‚¨æœ€åº•å±‚ï¼ˆMCï¼‰çš„sdï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªCPU çš„</span>
<span class="c1">//d-&gt;sdæŒ‡å‘MCçš„sdï¼Œè¿™åªæ˜¯ä¸´æ—¶åˆ†é…ï¼Œç”¨äºåœ¨å»ºç«‹sgçš„æ—¶å€™è¾…åŠ©ä½¿ç”¨ï¼Œåç»­ä¼šé”€æ¯ã€‚</span>
<span class="w">    </span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_percpu</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sa_sd_storage</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//åˆ†é…ä¸€ä¸ªrootdomainå¹¶è¿›è¡Œåˆå§‹åŒ–ï¼Œä¸»è¦ç”¨äºrtçš„ï¼Ÿ</span>
<span class="w">    </span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_rootdomain</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rd</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sa_sd</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sa_rootdomain</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>__visist_domain_allocation_hellè°ƒç”¨__sdt_allocï¼Œåˆ†é…SDTLä¸­çš„struct sd_data dataå¹¶è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">sd_data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="w"> </span><span class="o">*</span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">sd</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_shared</span><span class="w"> </span><span class="o">*</span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">sds</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_group</span><span class="w"> </span><span class="o">*</span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_group_capacity</span><span class="w"> </span><span class="o">*</span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">sgc</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>sd_dataçš„æˆå‘˜éƒ½æ˜¯__percpuç±»å‹ï¼Œéœ€è¦å…ˆè°ƒç”¨alloc_percpuåˆ†é…ç›¸åŒå¤§å°çš„cpuä¸ªæ•°åŒºåŸŸï¼Œè¿™äº›åŒºåŸŸå­˜å‚¨çš„æ˜¯æŒ‡é’ˆï¼ŒæŒ‡å‘æ¯ä¸ªcpuå¯¹åº”çš„sd/sds/sg/sgcï¼Œä»¥struct sched_domain *__percpu *sdä¸ºä¾‹ï¼Œsdd-&gt;sd = alloc_percpu(struct sched_domain *)åˆ†é…ä¸€å—æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„å…ƒç´ çš„ä¸ªæ•°ä¸ºcpuæ ¸ä¸ªæ•°ï¼ŒsdæŒ‡å‘è¿™ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æŒ‡é’ˆç”¨äºåç»­æ¯ä¸ªCPUæŒ‡å‘åˆ†é…çš„sdç©ºé—´ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">__sdt_alloc</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_map</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_topology_level</span><span class="w"> </span><span class="o">*</span><span class="n">tl</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//éå†SDTLï¼Œè¿™é‡Œæœ‰MCå’ŒDIEã€‚</span>
<span class="w">    </span><span class="n">for_each_sd_topology</span><span class="p">(</span><span class="n">tl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">sd_data</span><span class="w"> </span><span class="o">*</span><span class="n">sdd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//åˆ†é…å½“å‰å±‚çº§è°ƒåº¦åŸŸsd Per-CPUå˜é‡ï¼ˆæŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„å…ƒç´ ä¸ºcpuä¸ªæ•°æŒ‡é’ˆï¼Œä¸‹åŒï¼‰</span>
<span class="w">        </span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_percpu</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">       </span><span class="c1">//åˆ†é…å½“å‰å±‚çº§sdc Per-CPUå˜é‡</span>
<span class="w">        </span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_percpu</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_shared</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sds</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">       </span><span class="c1">//åˆ†é…å½“å‰å±‚çº§sg Per-CPUå˜é‡</span>
<span class="w">        </span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_percpu</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_group</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">       </span><span class="c1">//åˆ†é…å½“å‰å±‚çº§sgc Per-CPUå˜é‡</span>
<span class="w">        </span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sgc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_percpu</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_group_capacity</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sgc</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//ä¸Šé¢å·²ç»å®Œæˆå½“å‰å±‚çº§Per-CPUå˜é‡ï¼Œä¸‹é¢å°±éå†æ¯ä¸ªcpuåˆ†é…sd/sds/sg/sgcï¼ŒPer-CPU</span>
<span class="c1">//éå†å°†ä¸€ä¸€å¯¹åº”æŒ‡å‘ã€‚</span>
<span class="w">        </span><span class="n">for_each_cpu</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="w"> </span><span class="o">*</span><span class="n">sd</span><span class="p">;</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_shared</span><span class="w"> </span><span class="o">*</span><span class="n">sds</span><span class="p">;</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_group</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">;</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_group_capacity</span><span class="w"> </span><span class="o">*</span><span class="n">sgc</span><span class="p">;</span>
<span class="w">            </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kzalloc_node</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cpumask_size</span><span class="p">(),</span>
<span class="w">                    </span><span class="n">GFP_KERNEL</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_to_node</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">            </span><span class="o">*</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//å¦‚å¯¹åº”cpu0æ¥è¯´ï¼Œsdd-sd[0] = sd,sdd-sd[0]æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å½“å‰åˆ†é…çš„sdç©ºé—´ã€‚</span>
<span class="w">            </span><span class="n">sds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kzalloc_node</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_shared</span><span class="p">),</span>
<span class="w">                    </span><span class="n">GFP_KERNEL</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_to_node</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sds</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">            </span><span class="o">*</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sds</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sds</span><span class="p">;</span>
<span class="w">            </span><span class="n">sg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kzalloc_node</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_group</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cpumask_size</span><span class="p">(),</span>
<span class="w">                    </span><span class="n">GFP_KERNEL</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_to_node</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sg</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">            </span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sg</span><span class="p">;</span>
<span class="w">            </span><span class="o">*</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sg</span><span class="p">;</span>
<span class="w">            </span><span class="n">sgc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kzalloc_node</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_group_capacity</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cpumask_size</span><span class="p">(),</span>
<span class="w">                    </span><span class="n">GFP_KERNEL</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_to_node</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sgc</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">            </span><span class="o">*</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sgc</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sgc</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>æ‰§è¡Œå®Œ__sdt_allocï¼Œå±‚æ¬¡ç»“æ„å°±å¦‚ä¸‹æ‰€ç¤ºï¼Œå¦‚å¯¹åº”DIEå±‚æ¬¡ï¼Œsdd-sd[0~7]åˆ†åˆ«æŒ‡å‘å„è‡ªcpuåˆ†é…çš„sdåŒºåŸŸã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_93ac6fcf2c164a26ffc7776cbd62875a.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/10-è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ/images/wp_editor_md_93ac6fcf2c164a26ffc7776cbd62875a.jpg"/></a></p>
<h3 id="sd">åˆå§‹åŒ–è°ƒåº¦åŸŸsd</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">build_sched_domains</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_map</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_attr</span><span class="w"> </span><span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">s_alloc</span><span class="w"> </span><span class="n">alloc_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_none</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="w"> </span><span class="o">*</span><span class="n">sd</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">s_data</span><span class="w"> </span><span class="n">d</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rq</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">has_asym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="p">........</span>
<span class="c1">//éå†æ¯ä¸ªCPUï¼Œä»ä¸‹å¾€ä¸Šåˆå§‹åŒ–SDTLçš„sdï¼Œå…ˆåˆå§‹åŒ–MCå†åˆå§‹åŒ–DIEã€‚</span>
<span class="c1">// DIEçš„sd å…¶childæŒ‡å‘MCçš„sdï¼ŒMCçš„sd å…¶parentæŒ‡å‘DIEçš„sdã€‚</span>
<span class="w">    </span><span class="n">for_each_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_topology_level</span><span class="w"> </span><span class="o">*</span><span class="n">tl</span><span class="p">;</span>
<span class="w">        </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="n">for_each_sd_topology</span><span class="p">(</span><span class="n">tl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">topology_span_sane</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_map</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)))</span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//åˆå§‹åŒ–è°ƒåº¦åŸŸ</span>
<span class="w">            </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">build_sched_domain</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_map</span><span class="p">,</span><span class="w"> </span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>

<span class="w">            </span><span class="n">has_asym</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SD_ASYM_CPUCAPACITY</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tl</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sched_domain_topology</span><span class="p">)</span>
<span class="w">                </span><span class="o">*</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//å°†æœ€ä½å±‚çº§çš„sdä¿å­˜åˆ°s_data.sdçš„per_cpuå˜é‡ä¸­ï¼Œæœ€åº•å±‚ä¸ºMC levelçš„sd</span>
<span class="w">            </span><span class="c1">//ä¸ºä¸‹ä¸€æ­¥å»ºç«‹sgåšå‡†å¤‡ã€‚</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SDTL_OVERLAP</span><span class="p">)</span>
<span class="w">                </span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">SD_OVERLAP</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpumask_equal</span><span class="p">(</span><span class="n">cpu_map</span><span class="p">,</span><span class="w"> </span><span class="n">sched_domain_span</span><span class="p">(</span><span class="n">sd</span><span class="p">)))</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//sched_domain_span(sd)ç”¨äºè·å–ç»™å®šè°ƒåº¦åŸŸsdçš„èŒƒå›´cpuï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰è°ƒåº¦åŸŸ   </span>
<span class="c1">//ä¸­è¦†ç›–çš„cpuæ˜¯é‚£å‡ ä¸ªã€‚</span>
<span class="c1">//è°ƒåº¦åŸŸéƒ½æœ‰ä¸€ä¸ªèŒƒå›´ï¼Œè¡¨ç¤ºè¯¥è°ƒåº¦åŸŸå¯ä»¥ç®¡ç†çš„CPUèŒƒå›´ï¼Œè¿™ä¸ªèŒƒå›´é€šå¸¸æœ‰ä¸€</span>
<span class="c1">//ä¸ªcpumaskè¡¨ç¤ºï¼Œå…¶ä¸­æ¯ä¸ªä½éƒ½å¯¹åº”ä¸€ä¸ªcpuï¼Œè°ƒåº¦åŸŸçš„èŒƒå›´å®šä¹‰äº†è¯¥è°ƒåº¦åŸŸå½±//å“çš„cpué›†åˆã€‚</span>
<span class="w">        </span><span class="p">}</span>
<span class="p">}</span>
<span class="p">........</span>
<span class="p">}</span>
</code></pre></div>
<p>for_each_cpuéå†æ¯ä¸€ä¸ªcpuï¼Œæ¥ç€for_each_sd_topology(tl)å¯¹æ¯ä¸ªcpuä»æœ€åº•å±‚ä¾æ¬¡å¾€ä¸Šæ„å»ºè°ƒåº¦åŸŸï¼Œå…ˆæ„å»ºMCå†DIEã€‚build_sched_domainä¸­ä¼šè°ƒç”¨sd_initå¯¹è°ƒåº¦åŸŸè¿›è¡Œåˆå§‹åŒ–ï¼Œä¸»è¦æ˜¯struct sched_domainç»“æ„ä½“æˆå‘˜èµ‹å€¼ï¼ŒåŒæ—¶å»ºç«‹èµ·MCä¸DIEå±‚çº§sdçš„çˆ¶å­è”ç³»ï¼Œå¦‚ä¸‹å¯¹äºDIEå±‚çº§ï¼Œæ¯cpuçš„sd.childæŒ‡å‘MCå±‚çº§çš„sdï¼Œè€ŒMCå±‚çº§sd.parentæŒ‡å‘DIEå±‚çº§çš„sdã€‚åœ¨åˆå§‹åŒ–è°ƒåº¦åŸŸæ˜¯ä¼šè®¾ç½®å…¶spanï¼Œspanä¸ºè°ƒåº¦åŸŸä½œç”¨çš„cpuèŒƒå›´ï¼Œå®é™…æ˜¯æ ¹æ®spançš„ä½œç”¨èŒƒå›´æ¥å¯¹å½“å‰è°ƒåº¦åŸŸå±‚çº§è¿›è¡Œåˆ†ç»„ã€‚å¦‚MCå±‚çº§ï¼ŒæŒ‰ç…§4.2.1.2çš„æ‹“æ‰‘ç»“æ„ï¼Œæœ‰ä¸¤ä¸ªMCè°ƒåº¦åŸŸåï¼ŒCPU0~CPU3æ˜¯ä¸€ç»„ï¼Œæ‰€ä»¥CPU0~CPU3çš„sd-&gt;spanæ˜¯ç›¸åŒçš„ï¼ŒCPU4~CPU7æ˜¯ä¸€ç»„ï¼Œæ‰€ä»¥CPU4~CPU7çš„sd-&gt;spanç›¸åŒçš„ã€‚sd-&gt;spanéå¸¸é‡è¦ï¼Œåœ¨åç»­ç« èŠ‚ä¸­ä¹Ÿä¼šä½¿ç”¨è¯¥ä¿¡æ¯æ¥å»ºç«‹sgä¹‹é—´çš„è”ç³»ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_977a5d176cdc2259262d23e5536bbb5f.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/10-è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ/images/wp_editor_md_977a5d176cdc2259262d23e5536bbb5f.jpg"/></a></p>
<h3 id="sg">åˆå§‹åŒ–è°ƒåº¦ç»„sg</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">build_sched_domains</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_map</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_attr</span><span class="w"> </span><span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">s_alloc</span><span class="w"> </span><span class="n">alloc_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_none</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="w"> </span><span class="o">*</span><span class="n">sd</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">s_data</span><span class="w"> </span><span class="n">d</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rq</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">has_asym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="p">........</span>
<span class="w">    </span><span class="cm">/* Build the groups for the domains */</span>
<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//d.sdæ˜¯æœ€åº•å±‚å¾—è°ƒåº¦åŸŸï¼Œè¿™é‡Œæ˜¯MCï¼Œå³æ¯cpuçš„sd</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"> </span><span class="n">sd</span><span class="p">;</span><span class="w"> </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">span_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpumask_weight</span><span class="p">(</span><span class="n">sched_domain_span</span><span class="p">(</span><span class="n">sd</span><span class="p">));</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SD_OVERLAP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">build_overlap_sched_groups</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">))</span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">build_sched_groups</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">))</span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">........</span>
<span class="p">}</span>
</code></pre></div>
<p>for_each_cpuéå†æ¯ä¸ªcpuï¼Œfor (sd = *per_cpu_ptr(d.sd, i); sd; sd = sd-&gt;parent)éå†å½“å‰cpuçš„è°ƒåº¦åŸŸï¼Œä»MCè°ƒåº¦åŸŸå¾€ä¸Šå¼€å§‹ï¼Œè°ƒç”¨build_sched_groupsæ„å»ºå½“å‰è°ƒåº¦åŸŸçš„è°ƒåº¦ç»„ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">build_sched_groups</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="w"> </span><span class="o">*</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_group</span><span class="w"> </span><span class="o">*</span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sd_data</span><span class="w"> </span><span class="o">*</span><span class="n">sdd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_domain_span</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
<span class="c1">//è·å–å½“å‰è°ƒåº¦åŸŸçš„cpuä½œç”¨èŒƒå›´ï¼Œå¯¹äºDIEå±‚çº§ï¼Œspanæ˜¯cpu0~cpu7è€Œå¯¹äºMCå±‚çº§</span>
<span class="c1">//spanæ˜¯core_siblingsï¼Œå³cpu0~cpu3æˆ–cpu4~cpu7ã€‚</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">covered</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sched_domains_mutex</span><span class="p">);</span>
<span class="w">    </span><span class="n">covered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_domains_tmpmask</span><span class="p">;</span>

<span class="n">cpumask_clear</span><span class="p">(</span><span class="n">covered</span><span class="p">);</span>
<span class="c1">//ä»å½“å‰cpuå¼€å§‹éå†æ•´ä¸ªsd spanã€‚</span>
<span class="w">    </span><span class="n">for_each_cpu_wrap</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">span</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_group</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">covered</span><span class="p">))</span><span class="w"> </span>
<span class="c1">//å·²ç»åœ¨coverd mskä¸­çš„cpuï¼Œç»§ç»­æ‰§è¡Œï¼Œä¸ä¸‹é¢çš„cpumask_oré…åˆï¼Œé¿å…é‡å¤æŒ‡å‘ã€‚</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="c1">//è·å–cpu içš„è°ƒåº¦ç»„sg</span>
<span class="w">        </span><span class="n">sg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_group</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">sdd</span><span class="p">);</span>

<span class="w">        </span><span class="n">cpumask_or</span><span class="p">(</span><span class="n">covered</span><span class="p">,</span><span class="w"> </span><span class="n">covered</span><span class="p">,</span><span class="w"> </span><span class="n">sched_group_span</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
<span class="w">        </span><span class="c1">//coverd = coverd | sched_group_span(sg)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
<span class="w">            </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sg</span><span class="p">;</span><span class="c1">//æ¯ä¸ªcpuè¿›æ¥çš„ç¬¬ä¸€ä¸ªsg</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
<span class="w">            </span><span class="n">last</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sg</span><span class="p">;</span><span class="c1">//æ¯ä¸ªsgçš„ä¸‹ä¸€ä¸ªsg</span>
<span class="w">        </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sg</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">last</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w"> </span><span class="c1">//æœ€åä¸€ä¸ªsgå†æŒ‡å‘ç¬¬ä¸€ä¸ªsgï¼Œå°±å½¢æˆç¯å½¢é“¾è¡¨äº†ã€‚</span>
<span class="w">    </span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w"> </span><span class="c1">//sd-&gt;groupsæŒ‡å‘ç¬¬ä¸€ä¸ªsgï¼Œå¯¹äºMCæ˜¯è‡ªå·±çš„sg</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>åœ¨MCè°ƒåº¦åŸŸå±‚çº§ï¼Œæ ¹æ®è°ƒåº¦åŸŸsd-&gt;spanå®šä¹‰çš„cpuèŒƒå›´å†…çš„sgå½¢æˆç¯å½¢é“¾è¡¨ï¼Œä¸‹é¢å°±æ˜¯ä¸¤ä¸ªç¯å½¢é“¾è¡¨ï¼Œå¯¹åº”çš„å°±æ˜¯MCè°ƒåº¦åŸŸå±‚çº§çš„ä¸¤ä¸ªè°ƒåº¦åŸŸå®ä½“ã€‚ åœ¨DIEåŒºåŸŸï¼Œsgå–çš„æ˜¯å­è°ƒåº¦åŸŸæ‰€åœ¨çš„ç¬¬ä¸€ä¸ªcpuï¼Œå³cpu0æ‰€åœ¨çš„sgå’Œcpu4æ‰€åœ¨çš„sgã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_f9ca1c7f1149e85701f9b533ebdd5eab.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/10-è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ/images/wp_editor_md_f9ca1c7f1149e85701f9b533ebdd5eab.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_group</span><span class="w"> </span><span class="o">*</span><span class="n">get_group</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sd_data</span><span class="w"> </span><span class="o">*</span><span class="n">sdd</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="w"> </span><span class="o">*</span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="w"> </span><span class="o">*</span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_group</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">already_visited</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
<span class="w">        </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpumask_first</span><span class="p">(</span><span class="n">sched_domain_span</span><span class="p">(</span><span class="n">child</span><span class="p">));</span>
<span class="c1">//å¦‚æœè°ƒåº¦åŸŸå­˜åœ¨å­è°ƒåº¦åŸŸï¼Œåˆ™cpuè·å–å­è°ƒåº¦åŸŸçš„ç¬¬ä¸€ä¸ªcpuï¼Œåªæœ‰DIEå±‚çº§æ‰æœ‰å­è°ƒåº¦//åŸŸï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯cpu0æˆ–cpu4</span>

<span class="w">    </span><span class="n">sg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">);</span><span class="w"> </span><span class="c1">//è·å–å½“å‰å±‚çº§cpuä¸Šçš„sg</span>
<span class="w">    </span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">sgc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">sdd</span><span class="o">-&gt;</span><span class="n">sgc</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">);</span><span class="c1">//è·å–å½“å‰å±‚çº§cpuä¸Šçš„sgcï¼Œå°†sg-&gt;sgcæŒ‡å‘sgc</span>

<span class="w">    </span><span class="cm">/* Increase refcounts for claim_allocations: */</span>
<span class="w">    </span><span class="n">already_visited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* sgc visits should follow a similar trend as sg */</span>
<span class="w">    </span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">already_visited</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">sgc</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>

<span class="w">    </span><span class="cm">/* If we have already visited that group, it\'s already initialized. */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">already_visited</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sg</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//å¦‚æœæ˜¯DIEå±‚çº§</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cpumask_copy</span><span class="p">(</span><span class="n">sched_group_span</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span><span class="w"> </span><span class="n">sched_domain_span</span><span class="p">(</span><span class="n">child</span><span class="p">));</span>
<span class="w">        </span><span class="c1">//å°†å­è°ƒåº¦åŸŸçš„cpuèŒƒå›´èµ‹å€¼åˆ°è°ƒåº¦ç»„sgçš„cpuèŒƒå›´ï¼Œå­sd-&gt;span = çˆ¶sg-&gt;cpumask</span>
<span class="w">        </span><span class="n">cpumask_copy</span><span class="p">(</span><span class="n">group_balance_mask</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span><span class="w"> </span><span class="n">sched_group_span</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
<span class="w">        </span><span class="c1">//å°†è°ƒåº¦ç»„sgçš„cpuèŒƒå›´èµ‹å€¼åˆ°sgçš„å¹³è¡¡æ©ç balance mask</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cpumask_set_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">sched_group_span</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
<span class="w">        </span><span class="c1">//å°†cpuæ·»åŠ åˆ°è°ƒåº¦ç»„sgçš„cpuèŒƒå›´ä¸­</span>
<span class="w">        </span><span class="n">cpumask_set_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">group_balance_mask</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
<span class="w">        </span><span class="c1">//å°†cpuæ·»åŠ åˆ°è°ƒåº¦ç»„sgå¹³è¡¡æ©ç ä¸­</span>
<span class="w">    </span><span class="p">}</span>

<span class="n">sg</span><span class="o">-&gt;</span><span class="n">sgc</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCHED_CAPACITY_SCALE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cpumask_weight</span><span class="p">(</span><span class="n">sched_group_span</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
<span class="c1">//è®¡ç®—è°ƒåº¦ç»„èƒ½åŠ›ã€‚</span>
<span class="w">    </span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">sgc</span><span class="o">-&gt;</span><span class="n">min_capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCHED_CAPACITY_SCALE</span><span class="p">;</span>
<span class="w">    </span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">sgc</span><span class="o">-&gt;</span><span class="n">max_capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCHED_CAPACITY_SCALE</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sg</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>MCå±‚çº§åŸºæœ¬æ˜¯ä¸€ä¸ªcpuå¯¹åº”ä¸€ä¸ªè°ƒåº¦ç»„sgï¼Œè€Œå¯¹äºDIEå±‚çº§ä¸€ä¸ªclusterå¯¹åº”ä¸€ä¸ªè°ƒåº¦ç»„ï¼Œè°ƒåº¦ç»„è¡¨ç¤ºä¸€èˆ¬é€‰æ‹©æ¯ä¸ªclusterçš„ç¬¬ä¸€ä¸ªcpuï¼Œè¯¥sgä»£è¡¨çš„ä¸æ˜¯ä¸€ä¸ªcpuï¼Œè€Œæ˜¯æ•´ä¸ªclusterä¸Šçš„cpuï¼Œæ‰€ä»¥cpuä¸Šçš„sg-&gt;cpumaskä¸ºå­è°ƒåº¦åŸŸçš„sd-&gt;spanã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_de708bbcaf7fa6f9463cb50c1df39411.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/10-è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ/images/wp_editor_md_de708bbcaf7fa6f9463cb50c1df39411.jpg"/></a></p>
<h3 id="sgc">æ„å»ºè°ƒåº¦ç»„èƒ½åŠ›sgc</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">build_sched_domains</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_map</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_attr</span><span class="w"> </span><span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">......</span>
<span class="cm">/* Calculate CPU capacity for physical packages and nodes */</span>
<span class="c1">//éå†æ¯ä¸ªCPUï¼Œä»å¤§åˆ°å°å¼€å§‹éå†ï¼Œç„¶åä¾æ¬¡éå†MCåˆ°DIEï¼Œåˆå§‹åŒ–sgçš„cpu_capacity</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nr_cpumask_bits</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_map</span><span class="p">))</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//è¿˜æ˜¯ä»åº•å±‚MCå¼€å§‹å¾€ä¸Šéå†ï¼Œåˆå§‹åŒ–sgc</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"> </span><span class="n">sd</span><span class="p">;</span><span class="w"> </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">claim_allocations</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="p">);</span>
<span class="w">            </span><span class="n">init_sched_groups_capacity</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="p">}</span>
<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<p>éå†æ¯ä¸ªcpuï¼Œç„¶åä»MCå±‚çº§å¾€ä¸Šåˆ°DIEå±‚çº§ï¼Œåˆå§‹åŒ–æ¯cpuå„å±‚çº§çš„sgcã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init_sched_groups_capacity</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="w"> </span><span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_group</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">groups</span><span class="p">;</span>

<span class="w">    </span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sg</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//å¾ªç¯ï¼Œå¯¹sgç¯å½¢é“¾è¡¨ä¸­æ‰€æœ‰çš„sg-&gt;group_weightè¿›è¡Œåˆå§‹åŒ–ã€‚</span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">max_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">        </span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">group_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpumask_weight</span><span class="p">(</span><span class="n">sched_group_span</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SD_ASYM_PACKING</span><span class="p">))</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>

<span class="w">        </span><span class="n">for_each_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">sched_group_span</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max_cpu</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                </span><span class="n">max_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu</span><span class="p">;</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sched_asym_prefer</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">max_cpu</span><span class="p">))</span>
<span class="w">                </span><span class="n">max_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">asym_prefer_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_cpu</span><span class="p">;</span>

<span class="nl">next</span><span class="p">:</span>
<span class="w">        </span><span class="n">sg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">sg</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">groups</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpu</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">group_balance_cpu</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="n">update_group_capacity</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">);</span><span class="w"> </span><span class="c1">//æ›´æ–°group çš„capacityã€‚</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="cpumcsdrootdomaincpu-rq">å°†æ¯cpuçš„MCå±‚çº§sdã€rootdomainä¸cpu rqç»‘å®š</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">build_sched_domains</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_map</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain_attr</span><span class="w"> </span><span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">......</span>
<span class="c1">//éå†æ¯ä¸ªcpuï¼Œè·å–æœ€åº•å±‚çš„è°ƒåº¦åŸŸMCï¼Œå°†å…¶ä¸d.rdä»¥åŠcpu rqç»‘å®šèµ·æ¥</span>
<span class="w">    </span><span class="n">for_each_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu_rq</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">        </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* Use READ_ONCE()/WRITE_ONCE() to avoid load/store tearing: */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cpu_capacity_orig</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">max_cpu_capacity</span><span class="p">))</span>
<span class="w">            </span><span class="n">WRITE_ONCE</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">max_cpu_capacity</span><span class="p">,</span><span class="w"> </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cpu_capacity_orig</span><span class="p">);</span>

<span class="w">        </span><span class="n">cpu_attach_domain</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">rd</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
<span class="w">    </span><span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<p>for_each_cpuéå†æ‰€æœ‰cpuï¼Œsd = *per_cpu_ptr(d.sd, i)è·å–çš„æ˜¯MCå±‚çº§çš„è°ƒåº¦åŸŸï¼Œæœ€åè°ƒç”¨cpu_attach_domainè¿›è¡Œç»‘å®šã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">cpu_attach_domain</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_domain</span><span class="w"> </span><span class="o">*</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">root_domain</span><span class="w"> </span><span class="o">*</span><span class="n">rd</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">......</span>
<span class="w">    </span><span class="n">sched_domain_debug</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">);</span>

<span class="n">rq_attach_root</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">rd</span><span class="p">);</span><span class="w"> </span><span class="c1">// å°†æ–°çš„root domainä¸cpu rqç»‘å®šï¼Œrd-&gt;rd = rdã€‚</span>

<span class="w">    </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
<span class="w">    </span><span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="p">);</span><span class="w"> </span><span class="c1">//å°†æ–°çš„sdä¸rd-&gt;sd ç»‘å®š</span>
<span class="w">    </span><span class="n">dirty_sched_domain_sysctl</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
<span class="w">    </span><span class="n">destroy_sched_domains</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

<span class="w">    </span><span class="n">update_top_cache_domain</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>å°†æ¯ä¸ªcpuçš„MCå±‚çº§çš„è°ƒåº¦åŸŸsdèµ‹å€¼ç»™å½“å‰cpuè°ƒåº¦é˜Ÿåˆ—çš„rq-&gt;sdï¼Œå°†root domain èµ‹å€¼ä¸ºå½“å‰cpuè°ƒåº¦é˜Ÿåˆ—çš„rq-&gt;rdã€‚ æ€»ç»“ï¼š</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_4eddbc7922c08a5aa49fb18e019c2ad6.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/10-è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ/images/wp_editor_md_4eddbc7922c08a5aa49fb18e019c2ad6.jpg"/></a></p>
<ul>
<li>æ ¹æ®CPUæ¶æ„çš„å±‚æ¬¡ï¼Œä»ä¸‹åˆ°ä¸Šï¼Œåˆ†ä¸ºMCå±‚çº§-&gt;DIEå±‚çº§ï¼Œæ¯ä¸ªå±‚çº§ä½¿ç”¨struct sched_domain_topology_levelsï¼ˆSDTLï¼‰æ•°æ®ç»“æ„æè¿°ã€‚</li>
<li>è€ƒè™‘å¤šæ ¸çš„é”ç«äº‰è®¿é—®ï¼Œæ¯å±‚çº§SDTLä¸ºæ¯ä¸ªcpuå®šä¹‰äº†sd/sds/sg/sgcæ•°æ®ç»“æ„ã€‚</li>
<li>åœ¨åŒä¸€å±‚çº§ï¼ˆå¦‚MCå±‚çº§ï¼‰ç”±SOCæ¶æ„ï¼ˆDTSæè¿°ï¼‰æ¥ç¡®å®šé‚£äº›æ˜¯å…„å¼Ÿå…³ç³»(core_siblings)ï¼Œå…„å¼Ÿå…³ç³»åœ¨è°ƒåº¦åŸŸsdä¸­ä½¿ç”¨sd-&gt;spanæ¥æè¿°ï¼Œåœ¨è°ƒåº¦ç»„ä¸­sgä¸­ä½¿ç”¨sg-&gt;cpumaskæ¥æè¿°ï¼Œå±äºå…„å¼Ÿå…³ç³»çš„cpuæ ¸å±äºä¸€ä¸ªè°ƒåº¦åŸŸã€‚DIEå±‚çº§çš„sg-&gt;cpumask = MCå±‚çº§sd-&gt;spanã€‚</li>
<li>å¯¹äºMCå±‚çº§æ¥è¯´æ¯ä¸ªcpuå°±æ˜¯ä¸€ä¸ªè°ƒåº¦ç»„sgï¼Œå…„å¼Ÿå…³ç³»çš„sgå½’å±ä¸ºä¸€ä¸ªè°ƒåº¦åŸŸï¼Œè¯¥è°ƒåº¦åŸŸçš„sgå½¢æˆä¸€ä¸ªç¯å½¢é“¾è¡¨ï¼Œä½†ä¸åŒcpuæŒ‡å‘çš„ç¯å½¢é“¾è¡¨é¦–å…ƒç´ æ˜¯ä¸åŒçš„ï¼Œé¦–å…ƒç´ æŒ‡å‘çš„éƒ½æ˜¯è‡ªå·±cpuæ‰€åœ¨çš„sgï¼Œå¦‚cpu0çš„é“¾è¡¨é¡ºåºæ˜¯(0,1,2,3)ï¼Œcpu1çš„é“¾è¡¨é¡ºåºæ˜¯(1,2,3,0)ã€‚</li>
<li>å¯¹äºDIEå±‚çº§æ¥è¯´æ¯ä¸ªclusteræ˜¯ä¸€ä¸ªè°ƒåº¦ç»„ï¼Œæ¯ä¸ªè°ƒåº¦ç»„æœ‰å¤šä¸ªcpuï¼Œè°ƒåº¦ç»„è¦†ç›–çš„cpuèŒƒå›´å­è°ƒåº¦åŸŸçš„cpuè¦†ç›–èŒƒå›´ï¼Œä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯æ¯ä¸ªclusterçš„cpuèŒƒå›´ã€‚åŒæ—¶è°ƒåº¦ç»„é€‰å–çš„æ˜¯å­è°ƒåº¦åŸŸcpuèŒƒå›´çš„ç¬¬ä¸€é¡ºåºcpuä½œä¸ºè°ƒåº¦ç»„ï¼Œä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯æ¯ä¸ªclusterçš„ç¬¬ä¸€ä¸ªcpuã€‚</li>
<li>å¯¹äºDIEå±‚å…¶æ¯cpuçš„è°ƒåº¦åŸŸsd.childæŒ‡å‘ä¸‹ä¸€çº§MCå±‚æ¯cpuè°ƒåº¦åŸŸsdï¼Œè€ŒMCå±‚å…¶æ¯cpuè°ƒåº¦åŸŸsd.parentæŒ‡å‘ä¸Šä¸€çº§DIEå±‚æ¯cpuè°ƒåº¦åŸŸsdã€‚</li>
<li>è´Ÿè½½å‡è¡¡æ—¶ä¼šä¼˜å…ˆä»æœ€åº•å±‚çº§è¿›è¡Œå‡è¡¡ï¼Œä»ä¸‹å¾€ä¸Šæ„å‘³ç€å¯é€‰æ‹©çš„cpuä¼šè¶Šæ¥è¶Šå¤šï¼Œä½†æ˜¯å‡è¡¡çš„ä»£ä»·ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ã€‚</li>
</ul>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_72cca7be11d43af0b4877e54f6989813.jpg"><img alt="" src="assets/doc/01-linux/è¿›ç¨‹è°ƒåº¦/10-è´Ÿè½½å‡è¡¡ä¹‹è°ƒåº¦ç»„å’Œè°ƒåº¦åŸŸ/images/wp_editor_md_72cca7be11d43af0b4877e54f6989813.jpg"/></a></p></div>
  <div class="post-nav">
    <a class="prev" href="è´Ÿè½½å‡è¡¡ä¹‹å‡è¡¡.html">â† è´Ÿè½½å‡è¡¡ä¹‹å‡è¡¡</a>
    <a class="next" href="è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ª.html">è´Ÿè½½å‡è¡¡ä¹‹è´Ÿè½½è·Ÿè¸ª â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

