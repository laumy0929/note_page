<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>è¿ç»­å†…å­˜åˆ†é…å™¨CMA - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#cma">CMAåŒºåŸŸåˆ›å»º</a><ul><li><a href="#_1">è®¾å¤‡æ•°çš„æ–¹å¼åˆ›å»º</a></li></ul></li><li><a href="#_2">å‘½ä»¤è¡Œæˆ–å®æ–¹å¼åˆ›å»º</a><ul></ul></li><li><a href="#cma_1">CMAåˆå§‹åŒ–</a><ul></ul></li><li><a href="#cma_2">CMAåº”ç”¨</a><ul></ul></li><li><a href="#ion">ION</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>è¿ç»­å†…å­˜åˆ†é…å™¨CMA</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-08-19
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><p>CMA,contiguous memory allocatoræ˜¯å†…å­˜ç®¡ç†å­ç³»ç»Ÿçš„ä¸€ä¸ªæ¨¡å—ï¼Œå…¶ä¸»è¦ä¸ºäº†è§£å†³åˆ†é…è¿ç»­çš„ç‰©ç†å†…å­˜ã€‚å°½ç®¡æœ‰äº†ä¼™ä¼´ç³»ç»Ÿã€slabåˆ†é…å™¨ä»¥åŠç›¸å…³çš„å†…å­˜å›æ”¶æœºåˆ¶ï¼Œä½†æ˜¯å¯¹äºä¸€äº›é©±åŠ¨å¦‚cameraã€displayç­‰æ¨¡å—ä¸€ä¸‹éœ€è¦åˆ†é…æ¯”è¾ƒå¤§çš„ä¸€å—è¿ç»­ç‰©ç†å†…å­˜ï¼Œéšç€ç³»ç»Ÿè¿è¡Œä¹…ä¹‹åï¼Œç¢ç‰‡åŒ–ä¸¥é‡ï¼Œåˆ†é…è¾ƒå¤§çš„è¿ç»­å†…å­˜ä¼šå˜å¾—å›°éš¾ï¼Œè€ŒåŒæ—¶åˆä¸èƒ½ç›´æ¥é¢„ç•™ä¸€å—å¤§çš„è¿ç»­å†…å­˜åªç”¨äºè¿ç»­ç‰©ç†å†…å­˜åˆ†é…ï¼Œå› ä¸ºå½“æ¨¡å—ä¸ä½¿ç”¨è¿™äº›å†…å­˜æ—¶ï¼Œå†…å­˜å°±æµªè´¹æ‰äº†ã€‚å› æ­¤ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæå‡ºäº†CMAæœºåˆ¶ï¼Œå…ˆé¢„ç•™ä¸€éƒ¨åˆ†å†…å­˜å‡ºæ¥ä¸“é—¨ç”¨äºCMAå†…å­˜ï¼Œå½“é©±åŠ¨æ²¡æœ‰åˆ†é…ä½¿ç”¨çš„æ—¶å€™ï¼Œè¿™äº›memoryå¯ä»¥ç»™ä¼™ä¼´ç³»ç»Ÿä¾›å…¶ä»–æ¨¡å—æ­£å¸¸ä½¿ç”¨ï¼Œå½“éœ€è¦åˆ†é…è¿ç»­çš„å¤§å†…å­˜æ—¶ï¼Œå°±å›æ”¶å›æ¥å½¢æˆç‰©ç†åœ°å€è¿ç»­çš„å¤§å—å†…å­˜ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_534a275819ad65dd5978c0d341381b29.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/è¿ç»­å†…å­˜åˆ†é…å™¨cma/images/wp_editor_md_534a275819ad65dd5978c0d341381b29.jpg"/></a></p>
<p>ä¸Šå›¾å¯ä»¥çœ‹å‡ºCMAæ‰€å¤„çš„ä½ç½®ï¼ŒCMAå‘ä¸‹æ˜¯åŸºäºä¼™ä¼´ç³»ç»Ÿï¼Œå‘ä¸Šæ˜¯æä¾›ç»™DMAçš„å°è£…æ¥å£ï¼Œæœ€ç»ˆç”¨æˆ·é€šè¿‡æ“ä½œDMA bufferæ¥åˆ†é…å’Œé‡Šæ”¾å†…å­˜ã€‚CMAçš„åŒºåŸŸæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è¿›è¡Œé…ç½®ï¼Œåˆ†åˆ«æ˜¯å†…æ ¸å‘½ä»¤è¡Œå‚æ•°é…ç½®å’ŒDTSè®¾å¤‡æ ‘çš„æ–¹å¼é…ç½®ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">cma</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">   </span><span class="n">base_pfn</span><span class="p">;</span><span class="w">  </span><span class="n">ç‰©ç†åœ°å€èµ·å§‹é¡µå¸§å·</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">   </span><span class="n">count</span><span class="p">;</span><span class="w">     </span><span class="n">åŒºåŸŸçš„æ€»é¡µæ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">   </span><span class="o">*</span><span class="n">bitmap</span><span class="p">;</span><span class="w">   </span><span class="n">é¡µçš„åˆ†é…æƒ…å†µ0è¡¨ç¤ºfree</span><span class="err">ï¼Œ</span><span class="mi">1</span><span class="n">è¡¨ç¤ºå·²åˆ†é…</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">order_per_bit</span><span class="p">;</span><span class="w">  </span><span class="n">æ¯æ¬¡åˆ†é…</span><span class="o">/</span><span class="n">é‡Šæ”¾å¯¹åº”çš„2</span><span class="o">^</span><span class="n">order</span><span class="w"> </span><span class="n">é¡µ</span><span class="err">ï¼Œ</span><span class="n">ä¸bitmapçš„bitå¯¹åº”</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w">    </span><span class="n">lock</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_CMA_DEBUGFS</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_head</span><span class="w"> </span><span class="n">mem_head</span><span class="p">;</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">mem_head_lock</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cma</span><span class="w"> </span><span class="n">cma_areas</span><span class="p">[</span><span class="n">MAX_CMA_AREAS</span><span class="p">];</span>
<span class="k">extern</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">cma_area_count</span><span class="p">;</span>
</code></pre></div>
<p>å†…æ ¸ä½¿ç”¨struct cmaç»“æ„ä½“æ¥æè¿°cmaåŒºåŸŸï¼Œç³»ç»Ÿä¸­å¯èƒ½æœ‰å¤šä¸ªcmaåŒºåŸŸï¼Œä½¿ç”¨ä¸€ä¸ªå…¨å±€çš„æ•°ç»„æ¥æè¿°æ‰€æœ‰çš„cmaåŒºåŸŸstruct cma cma_areas[MAX_CMA_AREAS];</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_9cfaf952d9167d7c2305b9492f635706.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/è¿ç»­å†…å­˜åˆ†é…å™¨cma/images/wp_editor_md_9cfaf952d9167d7c2305b9492f635706.jpg"/></a></p>
<p>å¦‚ä¸Šå›¾ï¼Œcma_areas 0å·åŒºåŸŸï¼Œç‰©ç†é¡µå·ä»0å¼€å§‹ï¼Œæ¯å—å†…å­˜ç”±4é¡µç‰©ç†å¸§ç»„æˆï¼Œç›®å‰åªåˆ†é…äº†ç¬¬0å—ã€‚</p>
<h2 id="cma">CMAåŒºåŸŸåˆ›å»º</h2>
<p>åˆ›å»ºCMAåŒºåŸŸæœ‰ä¸¤ç§æ–¹å¼ï¼šç¬¬ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡è®¾å¤‡æ ‘DTSçš„é…ç½®æ–¹å¼ï¼Œå¦ä¸€ç§æ˜¯æ ¹æ®å‘½ä»¤è¡Œæˆ–å®é…ç½®æ–¹å¼ã€‚</p>
<h3 id="_1">è®¾å¤‡æ•°çš„æ–¹å¼åˆ›å»º</h3>
<div class="codehilite"><pre><span></span><code><span class="cm">/* global autoconfigured region for contiguous allocations */</span>
<span class="n">linux</span><span class="p">,</span><span class="n">cma</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"shared-dma-pool"</span><span class="p">;</span>
<span class="w">    </span><span class="n">reusable</span><span class="p">;</span>
<span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x4000000</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="n">alignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x2000</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="n">linux</span><span class="p">,</span><span class="n">cma</span><span class="o">-</span><span class="k">default</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>CMAçš„å†…å­˜åŒºåŸŸé€šè¿‡ä»¥ä¸Šè®¾å¤‡æ ‘ä¿¡æ¯æ¥è¿›è¡Œæè¿°ï¼Œå¯¹èŠ‚ç‚¹çš„è§£æåœ¨rmem_cma_setupå‡½æ•°ä¸­è¿›è¡Œã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">rmem_cma_setup</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">reserved_mem</span><span class="w"> </span><span class="o">*</span><span class="n">rmem</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">MAX_ORDER</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">pageblock_order</span><span class="p">);</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rmem</span><span class="o">-&gt;</span><span class="n">fdt_node</span><span class="p">;</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">default_cma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">of_get_flat_dt_prop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="s">"linux,cma-default"</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="err">ï¼ˆ</span><span class="mi">1</span><span class="err">ï¼‰</span><span class="n">è§£ælinux</span><span class="p">,</span><span class="n">cma</span><span class="o">-</span><span class="n">defaultèŠ‚ç‚¹</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cma</span><span class="w"> </span><span class="o">*</span><span class="n">cma</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_cmdline</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">default_cma</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_info</span><span class="p">(</span><span class="s">"Reserved memory: bypass %s node, using cmdline CMA params instead</span><span class="se">\\</span><span class="s">n"</span><span class="p">,</span>
<span class="w">            </span><span class="n">rmem</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="err">ï¼ˆ</span><span class="mi">2</span><span class="err">ï¼‰</span><span class="n">CMAå¯¹åº”çš„reserved</span><span class="w"> </span><span class="n">memoryèŠ‚ç‚¹å¿…é¡»æœ‰reusableå±æ€§</span><span class="err">ï¼Œ</span><span class="n">ä¸èƒ½æœ‰no</span><span class="o">-</span><span class="n">mapå±æ€§</span><span class="err">ã€‚</span>
<span class="w">   </span><span class="n">reusableå±æ€§æ‰èƒ½è¢«ä¼™ä¼´ç³»ç»Ÿå›æ”¶ä½¿ç”¨</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">of_get_flat_dt_prop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="s">"reusable"</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="n">of_get_flat_dt_prop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="s">"no-map"</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">rmem</span><span class="o">-&gt;</span><span class="n">base</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">rmem</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mask</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_err</span><span class="p">(</span><span class="s">"Reserved memory: incorrect alignment of CMA region</span><span class="se">\\</span><span class="s">n"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="err">ï¼ˆ</span><span class="mi">3</span><span class="err">ï¼‰</span><span class="n">è§£æå‡ºæ¥çš„å‚æ•°è¿›è¡Œåˆå§‹åŒ–CMAåŒºåŸŸ</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cma_init_reserved_mem</span><span class="p">(</span><span class="n">rmem</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">rmem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">rmem</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cma</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_err</span><span class="p">(</span><span class="s">"Reserved memory: unable to setup CMA region</span><span class="se">\\</span><span class="s">n"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="cm">/* Architecture specific contiguous memory fixup. */</span>
<span class="w">    </span><span class="n">dma_contiguous_early_fixup</span><span class="p">(</span><span class="n">rmem</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">rmem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">default_cma</span><span class="p">)</span>
<span class="w">        </span><span class="n">dma_contiguous_default_area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cma</span><span class="p">;</span>

<span class="w">    </span><span class="n">rmem</span><span class="o">-&gt;</span><span class="n">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rmem_cma_ops</span><span class="p">;</span>
<span class="w">    </span><span class="n">rmem</span><span class="o">-&gt;</span><span class="n">priv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cma</span><span class="p">;</span>

<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="s">"Reserved memory: created CMA memory pool at %pa, size %ld MiB</span><span class="se">\\</span><span class="s">n"</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">rmem</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">rmem</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">SZ_1M</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">RESERVEDMEM_OF_DECLARE</span><span class="p">(</span><span class="n">cma</span><span class="p">,</span><span class="w"> </span><span class="s">"shared-dma-pool"</span><span class="p">,</span><span class="w"> </span><span class="n">rmem_cma_setup</span><span class="p">);</span>
</code></pre></div>
<p>rmem_cma_setupå‡½æ•°ä¸»è¦è§£æè®¾å¤‡æ ‘ï¼Œè·å–cmaåŒºåŸŸçš„åœ°å€åŠå¤§å°ï¼Œç„¶åè°ƒç”¨cma_init_reserved_memå‡½æ•°ä»å…¨å±€æ•°ç»„struct cma cma_areas[MAX_CMA_AREAS]è·å–ä¸€ä¸ªcmaè¿›è¡Œåˆå§‹åŒ–è®¾ç½®ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">cma_init_reserved_mem</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
<span class="w">                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">order_per_bit</span><span class="p">,</span>
<span class="w">                 </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span>
<span class="w">                 </span><span class="k">struct</span><span class="w"> </span><span class="nc">cma</span><span class="w"> </span><span class="o">**</span><span class="n">res_cma</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cma</span><span class="w"> </span><span class="o">*</span><span class="n">cma</span><span class="p">;</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">alignment</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Sanity checks */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cma_area_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cma_areas</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_err</span><span class="p">(</span><span class="s">"Not enough slots for CMA reserved regions!</span><span class="se">\\</span><span class="s">n"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">memblock_is_region_reserved</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* ensure minimal alignment required by mm core */</span>
<span class="w">    </span><span class="n">alignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="w"> </span><span class="o">&lt;&lt;</span>
<span class="w">            </span><span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_ORDER</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">pageblock_order</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* alignment should be aligned with order_per_bit */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">alignment</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">order_per_bit</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ALIGN</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">alignment</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">alignment</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Each reserved area must be initialised later, when more kernel</span>
<span class="cm">     * subsystems (like slab allocator) are available.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">cma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cma_areas</span><span class="p">[</span><span class="n">cma_area_count</span><span class="p">];</span>
<span class="w">   </span><span class="err">ï¼ˆ</span><span class="mi">1</span><span class="err">ï¼‰</span><span class="n">ä»å…¨å±€æ•°ç»„ä¸­è·å–ä¸€ä¸ªcma</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="w">        </span><span class="n">snprintf</span><span class="p">(</span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">CMA_MAX_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">snprintf</span><span class="p">(</span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">CMA_MAX_NAME</span><span class="p">,</span><span class="w">  </span><span class="s">"cma%d</span><span class="se">\\</span><span class="s">n"</span><span class="p">,</span><span class="w"> </span><span class="n">cma_area_count</span><span class="p">);</span>
<span class="w">   </span><span class="err">ï¼ˆ</span><span class="mi">2</span><span class="err">ï¼‰</span><span class="n">è®¾ç½®cmaç›¸å…³çš„å‚æ•°</span>
<span class="w">    </span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">base_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="w">    </span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">;</span>
<span class="w">    </span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">order_per_bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">order_per_bit</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">res_cma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cma</span><span class="p">;</span>
<span class="w">    </span><span class="n">cma_area_count</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="n">totalcma_pages</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_2">å‘½ä»¤è¡Œæˆ–å®æ–¹å¼åˆ›å»º</h2>
<p>å†…æ ¸è¿˜æä¾›é€šè¿‡å†…æ ¸å¯åŠ¨å‚æ•°æˆ–å®çš„æ–¹å¼æ¥è¿›è¡Œé…ç½®ï¼Œæœ¬ç« èŠ‚é‡ç‚¹æè¿°å†…æ ¸å¯åŠ¨å‚æ•°çš„æ–¹å¼ï¼Œè¿™é‡Œçš„å¯åŠ¨å‚æ•°ä¸€èˆ¬æ˜¯ubootä¼ é€’è¿‡æ¥çš„å‚æ•°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">env</span><span class="p">.</span><span class="n">cfg</span>

<span class="n">earlycon</span><span class="o">=</span><span class="n">uart8250</span><span class="p">,</span><span class="n">mmio32</span><span class="p">,</span><span class="mh">0x02500000</span>
<span class="n">initcall_debug</span><span class="o">=</span><span class="mi">0</span>
<span class="n">console</span><span class="o">=</span><span class="n">ttyAS0</span><span class="p">,</span><span class="mi">115200</span>
<span class="n">nand_root</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">nand0p4</span>
<span class="n">mmc_root</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p4</span>
<span class="n">nor_root</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">mtdblock4</span>
<span class="n">init</span><span class="o">=/</span><span class="n">init</span>
<span class="n">loglevel</span><span class="o">=</span><span class="mi">8</span>
<span class="n">selinux</span><span class="o">=</span><span class="mi">0</span>
<span class="n">cma</span><span class="o">=</span><span class="mi">64</span><span class="n">M</span>
<span class="n">mac</span><span class="o">=</span>
<span class="n">wifi_mac</span><span class="o">=</span>
<span class="n">bt_mac</span><span class="o">=</span>
<span class="n">specialstr</span><span class="o">=</span>
<span class="n">keybox_list</span><span class="o">=</span><span class="n">hdcpkey</span><span class="p">,</span><span class="n">widevine</span>
</code></pre></div>
<p>ç¬”è€…ç³»ç»Ÿä¸­å†…æ ¸çš„å¯åŠ¨å‚æ•°é…ç½®åœ¨env.cfgä¸­ï¼Œå¦‚ä¸‹cmaçš„å¤§å°é…ç½®ä¸º64Mã€‚å†…æ ¸ä»£ç ä¸­é€šè¿‡å‡½æ•°dma_contiguous_reserveè¿›è¡Œè·å–cmdlineæˆ–å®é…ç½®çš„cmaå¤§å°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">dma_contiguous_reserve</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">selected_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">selected_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">selected_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">limit</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="n">pr_debug</span><span class="p">(</span><span class="s">"%s(limit %08lx)</span><span class="se">\\</span><span class="s">n"</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">limit</span><span class="p">);</span>
<span class="w">   </span><span class="err">ï¼ˆ</span><span class="mi">1</span><span class="err">ï¼‰</span><span class="n">è·å–cmdlineä¸­ä¼ å…¥çš„cma</span><span class="w"> </span><span class="n">sizeå¤§å°å’Œåœ°å€</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_cmdline</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">selected_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size_cmdline</span><span class="p">;</span>
<span class="w">        </span><span class="n">selected_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_cmdline</span><span class="p">;</span>
<span class="w">        </span><span class="n">selected_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min_not_zero</span><span class="p">(</span><span class="n">limit_cmdline</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">base_cmdline</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size_cmdline</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">limit_cmdline</span><span class="p">)</span>
<span class="w">            </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">è¿™é‡Œæ˜¯å®å®šä¹‰çš„æ–¹å¼</span>
<span class="cp">#ifdef CONFIG_CMA_SIZE_SEL_MBYTES</span>
<span class="w">        </span><span class="n">selected_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size_bytes</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_CMA_SIZE_SEL_PERCENTAGE)</span>
<span class="w">        </span><span class="n">selected_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cma_early_percent_memory</span><span class="p">();</span>
<span class="cp">#elif defined(CONFIG_CMA_SIZE_SEL_MIN)</span>
<span class="w">        </span><span class="n">selected_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">size_bytes</span><span class="p">,</span><span class="w"> </span><span class="n">cma_early_percent_memory</span><span class="p">());</span>
<span class="cp">#elif defined(CONFIG_CMA_SIZE_SEL_MAX)</span>
<span class="w">        </span><span class="n">selected_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">size_bytes</span><span class="p">,</span><span class="w"> </span><span class="n">cma_early_percent_memory</span><span class="p">());</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">selected_size</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">dma_contiguous_default_area</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_debug</span><span class="p">(</span><span class="s">"%s: reserving %ld MiB for global area</span><span class="se">\\</span><span class="s">n"</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span>
<span class="w">             </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">selected_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">SZ_1M</span><span class="p">);</span>
<span class="w">    </span><span class="err">ï¼ˆ</span><span class="mi">2</span><span class="err">ï¼‰</span><span class="n">è·å–åˆ°cmaåŒºåŸŸå</span><span class="err">ï¼Œ</span><span class="n">è¿›è¡Œåˆå§‹åŒ–</span>
<span class="w">        </span><span class="n">dma_contiguous_reserve_area</span><span class="p">(</span><span class="n">selected_size</span><span class="p">,</span><span class="w"> </span><span class="n">selected_base</span><span class="p">,</span>
<span class="w">                        </span><span class="n">selected_limit</span><span class="p">,</span>
<span class="w">                        </span><span class="o">&amp;</span><span class="n">dma_contiguous_default_area</span><span class="p">,</span>
<span class="w">                        </span><span class="n">fixed</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>dma_contiguous_reserve_areaå‡½æ•°æœ€ç»ˆè¿˜æ˜¯ä¼šè°ƒç”¨åˆ°cma_init_reserved_memï¼Œè¿›è€Œè·å–ä¸€ä¸ªcmaå®ä¾‹ï¼Œç„¶åè¿›è¡Œåˆå§‹åŒ–cmaç»“æ„ä½“ã€‚</p>
<h2 id="cma_1">CMAåˆå§‹åŒ–</h2>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">cma_init_reserved_areas</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="n">éå†CMAæ•°ç»„</span><span class="err">ï¼Œ</span><span class="n">è¿›è¡Œåˆå§‹åŒ–</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cma_area_count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">cma_activate_area</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cma_areas</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">core_initcall</span><span class="p">(</span><span class="n">cma_init_reserved_areas</span><span class="p">);</span>
</code></pre></div>
<p>ä¸»è¦æ˜¯éå†cma_areasæ•°ç»„ï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">cma_activate_area</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cma</span><span class="w"> </span><span class="o">*</span><span class="n">cma</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">base_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">base_pfn</span><span class="p">,</span><span class="w"> </span><span class="n">pfn</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="o">*</span><span class="n">zone</span><span class="p">;</span>
<span class="w">   </span><span class="err">ï¼ˆ</span><span class="mi">1</span><span class="err">ï¼‰</span><span class="n">è®¡ç®—éœ€è¦çš„bitmapå¤§å°</span><span class="err">ï¼Œ</span><span class="n">ç„¶åè¿›è¡Œåˆ†é…</span><span class="err">ã€‚</span><span class="n">ä¸»è¦å—countå’Œbitçš„å½±å“</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitmap_zalloc</span><span class="p">(</span><span class="n">cma_bitmap_maxno</span><span class="p">(</span><span class="n">cma</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out_error</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * alloc_contig_range() requires the pfn range specified to be in the</span>
<span class="cm">     * same zone. Simplify by forcing the entire CMA resv range to be in the</span>
<span class="cm">     * same zone.</span>
<span class="cm">     */</span>
<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">pfn_valid</span><span class="p">(</span><span class="n">base_pfn</span><span class="p">));</span>
<span class="err">ï¼ˆ</span><span class="mi">2</span><span class="err">ï¼‰</span><span class="n">åˆ¤æ–­ç‰©ç†é¡µæ˜¯å¦éƒ½åœ¨ä¸€ä¸ªzoneåŒº</span><span class="err">ï¼Œ</span><span class="n">éœ€è¦åœ¨åŒä¸€ä¸ªzoneåŒº</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">zone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">page_zone</span><span class="p">(</span><span class="n">pfn_to_page</span><span class="p">(</span><span class="n">base_pfn</span><span class="p">));</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_pfn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">pfn</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">base_pfn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">pfn</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">pfn_valid</span><span class="p">(</span><span class="n">pfn</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">page_zone</span><span class="p">(</span><span class="n">pfn_to_page</span><span class="p">(</span><span class="n">pfn</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">zone</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">not_in_zone</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">   </span><span class="err">ï¼ˆ</span><span class="mi">3</span><span class="err">ï¼‰</span><span class="n">å°†ç‰©ç†é¡µé‡Šæ”¾åˆ°ä¼™ä¼´ç³»ç»Ÿä¸­å»</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_pfn</span><span class="p">;</span><span class="w"> </span><span class="n">pfn</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">base_pfn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
<span class="w">         </span><span class="n">pfn</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">pageblock_nr_pages</span><span class="p">)</span>
<span class="w">        </span><span class="n">init_cma_reserved_pageblock</span><span class="p">(</span><span class="n">pfn_to_page</span><span class="p">(</span><span class="n">pfn</span><span class="p">));</span>

<span class="w">    </span><span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_CMA_DEBUGFS</span>
<span class="w">    </span><span class="n">INIT_HLIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">);</span>
<span class="w">    </span><span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">mem_head_lock</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span>

<span class="nl">not_in_zone</span><span class="p">:</span>
<span class="w">    </span><span class="n">bitmap_free</span><span class="p">(</span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>
<span class="nl">out_error</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/* Expose all pages to the buddy, they are useless for CMA. */</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_pfn</span><span class="p">;</span><span class="w"> </span><span class="n">pfn</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">base_pfn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">pfn</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">free_reserved_page</span><span class="p">(</span><span class="n">pfn_to_page</span><span class="p">(</span><span class="n">pfn</span><span class="p">));</span>
<span class="w">    </span><span class="n">totalcma_pages</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">pr_err</span><span class="p">(</span><span class="s">"CMA area %s could not be activated</span><span class="se">\\</span><span class="s">n"</span><span class="p">,</span><span class="w"> </span><span class="n">cma</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="cma_2">CMAåº”ç”¨</h2>
<div class="codehilite"><pre><span></span><code><span class="n">DMAçš„ç”³è¯·</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">dma_alloc_from_contiguous</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span>
<span class="w">                       </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">no_warn</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">align</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">CONFIG_CMA_ALIGNMENT</span><span class="p">)</span>
<span class="w">        </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CONFIG_CMA_ALIGNMENT</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cma_alloc</span><span class="p">(</span><span class="n">dev_get_cma_area</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"> </span><span class="n">no_warn</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">DMAçš„é‡Šæ”¾</span>

<span class="kt">bool</span><span class="w"> </span><span class="n">dma_release_from_contiguous</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">pages</span><span class="p">,</span>
<span class="w">                 </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cma_release</span><span class="p">(</span><span class="n">dev_get_cma_area</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span><span class="w"> </span><span class="n">pages</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>å¯¹å†…æ ¸çš„ç”³è¯·å’Œé‡Šæ”¾æä¾›ç»™ç”¨æˆ·ä½¿ç”¨çš„åˆ†é…æ˜¯dma_alloc_from_contiguouså’Œdma_release_from_contiguousï¼Œå…¶è°ƒç”¨çš„æ˜¯cma_allocå’Œcma_releaseæ¥å®ç°çš„ã€‚ cma_allocæŒ‡å®šCMA areasä¸Šåˆ†é…countä¸ªè¿ç»­çš„page frameï¼Œå…·ä½“å°±æ˜¯éå†bitmapçœ‹æ˜¯å¦æœ‰å¯ç”¨å†…å­˜ï¼Œå¦‚æœæœ‰å°±å‘ä¼™ä¼´ç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œå¦‚æœä¼™ä¼´ç³»ç»Ÿå°†å¯¹åº”çš„å†…å­˜æŒªç»™å…¶ä»–åº”ç”¨äº†ï¼Œé‚£ä¹ˆéœ€è¦è¿›è¡Œé¡µé¢è¿ç§»ã€é¡µé¢å›æ”¶ç­‰æ“ä½œå›æ”¶å›æ¥ã€‚</p>
<h2 id="ion">ION</h2>
<p>å¾…è¡¥å……</p></div>
  <div class="post-nav">
    <a class="prev" href="dmaä¸cacheä¸€è‡´æ€§.html">â† DMAä¸cacheä¸€è‡´æ€§</a>
    <a class="next" href="slubåˆ†é…å™¨.html">slubåˆ†é…å™¨ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

