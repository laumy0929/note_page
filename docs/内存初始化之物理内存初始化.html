<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ– - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#__create_page_tables">æ’ç­‰æ˜ å°„ä¸å†…æ ¸é•œåƒæ˜ å°„__create_page_tables</a><ul><li><a href="#_1">æ’ç­‰æ˜ å°„</a></li><li><a href="#_2">ç²—ç²’åº¦çš„å†…æ ¸æ˜ åƒæ˜ å°„</a></li></ul></li><li><a href="#fixmap">fixmapæ˜ å°„</a><ul><li><a href="#fixmap_1">fixmapç©ºé—´åˆ†ç±»</a></li><li><a href="#fixmap_2">fixmapåˆå§‹åŒ–</a></li><li><a href="#fixmap_3">fixmapç›¸å…³å‡½æ•°</a></li><li><a href="#fixmap-io">fixmap ioæ˜ å°„</a></li><li><a href="#fixmap-dtb">fixmap DTBæ˜ å°„</a></li></ul></li><li><a href="#memblock">Memblock</a><ul><li><a href="#_3">è·å–ç‰©ç†å†…å­˜å¤§å°</a></li><li><a href="#_4">ç®¡ç†ç»“æ„ä½“</a></li><li><a href="#memblock_1">memblockä¸»è¦æ¥å£å‡½æ•°</a></li><li><a href="#arm64-memblock-init">Arm64 memblock init</a></li></ul></li><li><a href="#paging_init">paging_init</a><ul><li><a href="#pgd">æ„å»ºPGDæ˜ å°„è¡¨</a></li><li><a href="#early_pgtable_alloc">early_pgtable_alloc</a></li><li><a href="#-map_kernel">å†…æ ¸é•œåƒç»†ç²’åº¦æ˜ å°„-map_kernel</a></li><li><a href="#-map_mem">çº¿æ€§æ˜ å°„-map_mem</a></li><li><a href="#__create_pgd_mapping">__create_pgd_mapping</a></li></ul></li><li><a href="#bootmem_init">bootmem_init</a><ul><li><a href="#sparse_init">sparse_init</a></li><li><a href="#zone_sizes_init">zone_sizes_init</a></li></ul></li><li><a href="#build_all_zonelists">build_all_zonelists</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-07-01
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="__create_page_tables">æ’ç­‰æ˜ å°„ä¸å†…æ ¸é•œåƒæ˜ å°„__create_page_tables</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_0799025c3a2daf03a2a31ced36b88d37.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_0799025c3a2daf03a2a31ced36b88d37.jpg"/></a></p>
<ul>
<li>preserve_boot_argsï¼šä¿æŒå¯åŠ¨å‚æ•°åˆ°boot_args[]æ•°ç»„</li>
<li>set_cpu_boot_maode_flagï¼šè®¾ç½®å…³äºcpu bootç›¸å…³çš„å…¨å±€å˜é‡</li>
<li>__create_page_tablesï¼šåˆ›å»ºæ’ç­‰æ˜ å°„é¡µè¡¨ï¼Œå†…æ ¸æ˜ åƒæ˜ å°„é¡µè¡¨</li>
<li>__cpu_setupï¼šä¸ºæ‰“å¼€mmuåšä¸€äº›cpuç›¸å…³çš„åˆå§‹åŒ–</li>
<li>__primary_switchï¼šå¯åŠ¨mmuï¼Œå¹¶è·³è½¬start_kernel()å‡½æ•°</li>
</ul>
<h3 id="_1">æ’ç­‰æ˜ å°„</h3>
<p>ï¼ˆtextï¼š__idmap_text_start~__idmap_text_end/dataï¼šidmap_pg_dir~idmap_pg_endï¼‰</p>
<p>ä¸€æ—¦å¯åŠ¨MMUå°±éœ€è¦ä½¿ç”¨è™šæ‹Ÿåœ°å€ï¼Œç°ä»£å¤„ç†å™¨å¤§å¤šæ•°æ˜¯å¤šçº§æµæ°´çº¿ï¼Œå¤„ç†å™¨ä¼šæå‰é¢„å–å¤šæ¡æŒ‡ä»¤åˆ°æµæ°´çº¿ä¸­ï¼Œæ‰“å¼€MMUæ—¶ï¼Œè¿™äº›æŒ‡ä»¤éƒ½æ˜¯ç‰©ç†åœ°å€é¢„å–çš„ï¼›åœ¨MMUå¼€å¯åï¼Œå°†ä»¥è™šæ‹Ÿåœ°å€è®¿é—®ï¼Œè¿™æ ·å°±ä¼šå‡ºé”™ï¼Œæ‰€ä»¥å¼•å…¥äº†â€œæ’ç­‰æ˜ å°„â€ï¼Œå³åœ¨è¿‡æ¸¡é˜¶æ®µçš„ä»£ç ï¼Œè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ç›¸ç­‰ã€‚æ’ç­‰æ˜ å°„å®Œæˆåï¼Œå°±å¯åŠ¨MMUï¼Œè¿›å…¥è™šæ‹Ÿåœ°å€è®¿é—®é˜¶æ®µã€‚æ’ç­‰æ˜ å°„çš„ä»£ç åœ¨ __idmap_text_start~__idmap_text_endï¼Œå¯ä»¥ä»System.mapæ–‡ä»¶ä¸­æŸ¥è¯¢åˆ°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">kernel</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">System</span><span class="p">.</span><span class="n">map</span>

<span class="n">ffffffc00899b000</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">__idmap_text_start</span>
<span class="n">ffffffc00899b000</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">init_kernel_el</span>
<span class="n">ffffffc00899b00c</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">init_el1</span>
<span class="n">ffffffc00899b034</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">init_el2</span>
<span class="n">ffffffc00899b1e8</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">__cpu_stick_to_vhe</span>
<span class="n">ffffffc00899b1f8</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">set_cpu_boot_mode_flag</span>
<span class="n">ffffffc00899b21c</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">secondary_holding_pen</span>
<span class="n">ffffffc00899b240</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">pen</span>
<span class="n">ffffffc00899b254</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">secondary_entry</span>
<span class="n">ffffffc00899b260</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">secondary_startup</span>
<span class="n">ffffffc00899b27c</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">__secondary_switched</span>
<span class="n">ffffffc00899b310</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">__secondary_too_slow</span>
<span class="n">ffffffc00899b31c</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">__enable_mmu</span>
<span class="n">ffffffc00899b37c</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">__cpu_secondary_check52bitva</span>
<span class="n">ffffffc00899b380</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">__no_granule_support</span>
<span class="n">ffffffc00899b3a4</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">__relocate_kernel</span>
<span class="n">ffffffc00899b3ec</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">__primary_switch</span>
<span class="n">ffffffc00899b428</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">enter_vhe</span>
<span class="n">ffffffc00899b460</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">cpu_resume</span>
<span class="n">ffffffc00899b488</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">cpu_do_resume</span>
<span class="n">ffffffc00899b52c</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">idmap_cpu_replace_ttbr1</span>
<span class="n">ffffffc00899b560</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">__idmap_kpti_flag</span>
<span class="n">ffffffc00899b564</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">idmap_kpti_install_ng_mappings</span>
<span class="n">ffffffc00899b5a0</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">do_pgd</span>
<span class="n">ffffffc00899b5b8</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">next_pgd</span>
<span class="n">ffffffc00899b5c8</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">skip_pgd</span>
<span class="n">ffffffc00899b608</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">walk_puds</span>
<span class="n">ffffffc00899b610</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">next_pud</span>
<span class="n">ffffffc00899b614</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">walk_pmds</span>
<span class="n">ffffffc00899b61c</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">do_pmd</span>
<span class="n">ffffffc00899b634</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">next_pmd</span>
<span class="n">ffffffc00899b644</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">skip_pmd</span>
<span class="n">ffffffc00899b654</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">walk_ptes</span>
<span class="n">ffffffc00899b65c</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">do_pte</span>
<span class="n">ffffffc00899b680</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">skip_pte</span>
<span class="n">ffffffc00899b690</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">__idmap_kpti_secondary</span>
<span class="n">ffffffc00899b6d8</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">__cpu_setup</span>
<span class="n">ffffffc00899b7dc</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">__idmap_text_end</span>
</code></pre></div>
<p>æ’ç­‰æ˜ å°„ç›®çš„å°±æ˜¯ä¸º__idmap_text_start~__idmap_text_endè¿™æ®µä»£ç åˆ›å»ºä¸€ä¸ªæ˜ å°„é¡µè¡¨ï¼Œä½¿å…¶è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜¯ç›¸ç­‰çš„ã€‚åœ¨vmlinux.lds.Sä¸­ï¼Œäº‹å…ˆå·²ç»åˆ†é…äº†IDMAP_DIR_SIZEçš„ç©ºé—´ç”¨äºå­˜å‚¨é¡µè¡¨ï¼Œé€šå¸¸å™¨é¡µè¡¨ä¸º3ä¸ªè¿ç»­çš„4KBé¡µé¢ï¼Œåˆ†åˆ«å¯¹äºPGD,PUD,PMDé¡µè¡¨ï¼Œè¿™é‡Œæ²¡æœ‰ä½¿ç”¨PTEï¼Œæ‰€ä»¥ç²’åº¦æ˜¯2MBçš„å¤§å°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">vmlinux</span><span class="p">.</span><span class="n">lds</span><span class="p">.</span><span class="n">S</span>

<span class="w">    </span><span class="n">idmap_pg_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span>
<span class="w">    </span><span class="p">.</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">IDMAP_DIR_SIZE</span><span class="p">;</span>
<span class="w">    </span><span class="n">idmap_pg_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span>
</code></pre></div>
<h3 id="_2">ç²—ç²’åº¦çš„å†…æ ¸æ˜ åƒæ˜ å°„</h3>
<p>ï¼ˆtext: kernel_text / dataï¼šinit_pg_dir~init_pg_endï¼‰</p>
<p>ä¹‹æ‰€ä»¥è¦åˆ›å»ºç¬¬äºŒä¸ªé¡µè¡¨ï¼Œæ˜¯å› ä¸ºcpuåˆšå¯åŠ¨æ—¶ï¼Œç‰©ç†å†…å­˜ä¸€èˆ¬éƒ½åœ¨ä½åœ°å€ï¼ˆä¸è¿‡è¶…è¿‡256TBï¼‰ï¼Œæ’ç­‰æ˜ å°„çš„åœ°å€å®é™…ä¹Ÿåœ¨ç”¨æˆ·ç©ºé—´ï¼Œå³MMUå¯ç”¨åidmap_pg_dirä¼šå¡«å…¥TTBR0ï¼Œè€Œå†…æ ¸ç©ºé—´é“¾æ¥åœ°å€ï¼ˆè™šæ‹Ÿåœ°å€ï¼‰éƒ½æ˜¯åœ¨é«˜åœ°å€ï¼Œéœ€è¦å¡«å…¥TTBR1ï¼Œå› æ­¤éœ€è¦å†åˆ›å»ºä¸€å¼ è¡¨ï¼Œæ˜ å°„æ•´ä¸ªå†…æ ¸é•œåƒï¼Œä¸”è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯å†é«˜åœ°å€0xffff xxxx xxxx xxxx</p>
<div class="codehilite"><pre><span></span><code><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">head</span><span class="p">.</span><span class="n">S</span>
<span class="cm">/*</span>
<span class="cm">     * Map the kernel image (starting with PHYS_OFFSET).</span>
<span class="cm">     */</span>

<span class="w">    </span><span class="c1">///è°ƒç”¨map_memoryå®å»ºç«‹æ•´ä¸ªå†…æ ¸é•œåƒä»£ç æ®µ  çš„æ˜ å°„é¡µè¡¨ï¼›</span>
<span class="w">    </span><span class="cm">/**************************************************************************</span>
<span class="cm">     * ä¸ºä»€ä¹ˆè¦å»ºç¬¬äºŒå¼ è¡¨ï¼Ÿ</span>
<span class="cm">     * CPUåˆšå¯åŠ¨æ—¶ï¼Œç‰©ç†å†…å­˜ä¸€èˆ¬éƒ½åœ¨ä½åœ°å€(ä¸ä¼šè¶…è¿‡256Tå¤§å°)ï¼Œæ’ç­‰æ˜ å°„çš„åœ°å€å®é™…åœ¨ç”¨æˆ·ç©ºé—´äº†ï¼Œ</span>
<span class="cm">     * å³MMUå¯ç”¨åidmap_pg_dirä¼šå¡«å…¥TTBR0;</span>
<span class="cm">     * è€Œå†…æ ¸ç©ºé—´çš„é“¾æ¥åœ°å€éƒ½æ˜¯åœ¨é«˜åœ°å€(å†…æ ¸ç©ºé—´åœ¨é«˜åœ°å€)ï¼Œéœ€è¦å¡«å…¥TTBR1ï¼›</span>
<span class="cm">     * å› æ­¤ï¼Œè¿™é‡Œå†å»ºä¸€å¼ è¡¨ï¼Œæ˜ å°„æ•´ä¸ªå†…æ ¸é•œåƒï¼Œä¸”è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯åœ¨é«˜åœ°å€åŒº0xffffxxxx xxxx xxxx</span>

<span class="cm">     * æ³¨ï¼šinit_pg_dirå’Œidmap_pg_dirä¸¤ä¸ªé¡µè¡¨æ˜ å°„åŒºåˆ«ï¼š</span>
<span class="cm">     * (1)init_pg_diræ˜ å°„çš„è™šæ‹Ÿåœ°å€åœ¨é«˜ä½0xffff xxxx xxxx xxxx;</span>
<span class="cm">     *   idmap_pg_diræ˜ å°„çš„è™šæ‹Ÿåœ°å€åœ¨ä½ä½0x0000 xxxx xxxx xxxx;</span>
<span class="cm">     *   MMUå¯ç”¨åï¼Œinit_pg_dirå¡«å…¥TTBR1,idmap_pg_dirå¡«å…¥TTBR0ï¼›</span>
<span class="cm">     * (2)init_pg_diræ˜ å°„å¤§å°æ˜¯æ•´ä¸ªå†…æ ¸é•œåƒï¼Œidmap_pg_diræ˜ å°„2M, åªæ˜¯å†…å­˜è®¿é—®è¿‡æ¸¡ï¼ŒæˆåŠŸå¼€å¯MMUå³å¯ï¼›</span>
<span class="cm">     ***************************************************************************/</span>
<span class="w">    </span><span class="n">adrp</span><span class="w">    </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">init_pg_dir</span>
<span class="w">    </span><span class="n">mov_q</span><span class="w">   </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="n">KIMAGE_VADDR</span><span class="w">        </span><span class="c1">// compile time __va(_text)</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="n">x23</span><span class="w">         </span><span class="c1">// add KASLR displacement</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="n">PTRS_PER_PGD</span>
<span class="w">    </span><span class="n">adrp</span><span class="w">    </span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">_end</span><span class="w">            </span><span class="c1">// runtime __pa(_end)</span>
<span class="w">    </span><span class="n">adrp</span><span class="w">    </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">_text</span><span class="w">           </span><span class="c1">// runtime __pa(_text)</span>
<span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">x3</span><span class="w">          </span><span class="c1">// _end - _text</span>
<span class="n">add</span><span class="w"> </span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">x5</span><span class="w">          </span><span class="c1">// runtime __va(_end)</span>

<span class="w">    </span><span class="n">map_memory</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="n">x10</span><span class="p">,</span><span class="w"> </span><span class="n">x11</span><span class="p">,</span><span class="w"> </span><span class="n">x12</span><span class="p">,</span><span class="w"> </span><span class="n">x13</span><span class="p">,</span><span class="w"> </span><span class="n">x14</span>
</code></pre></div>
<h2 id="fixmap">fixmapæ˜ å°„</h2>
<p>å…ˆåˆ›å»ºå¥½é¡µè¡¨ï¼Œå»ºç«‹å¥½è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»ã€‚</p>
<p>Linuxå†…æ ¸è¦è®¿é—®ç‰©ç†å†…å­˜ï¼Œä¸€æ—¦å¼€å¯MMUåï¼Œå°±åªèƒ½é€šè¿‡è™šæ‹Ÿåœ°å€æŸ¥è¯¢é¡µè¡¨æ‰¾åˆ°ç‰©ç†åœ°å€è¿›è¡Œè®¿é—®ï¼Œä¸Šä¸€ç« èŠ‚ä¸­å»ºç«‹æ’ç­‰æ˜ å°„å’Œç²—ç²’åº¦å†…æ ¸æ˜ åƒæ˜ å°„çš„é¡µè¡¨ï¼Œå› æ­¤åªèƒ½ä¿è¯å†…æ ¸é•œåƒæ­£å¸¸è®¿é—®ã€‚å¦‚æœè¦è§£æDTBï¼Œè®¿é—®è®¾å¤‡IOç­‰ä¾ç„¶æ˜¯æ— æ³•è®¿é—®çš„ï¼Œå› ä¸ºæŸ¥è¯¢ä¸åˆ°å¯¹åº”çš„é¡µè¡¨ã€‚å› æ­¤å†…æ ¸å¼•å…¥äº†fixmapæœºåˆ¶ï¼Œå°±æ˜¯äº‹å…ˆåˆ†é…ä¸€æ®µè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç„¶åç»™å®šå…¶è™šæ‹Ÿåœ°å€åˆ›å»ºå¥½é¡µè¡¨ï¼Œé¡µè¡¨ä¸­çš„è¡¨é¡¹æœ€åä¸€çº§æŒ‡å‘çš„ç‰©ç†é¡µå¸§å·å…ˆä¸å¡«å……ï¼Œç­‰åˆ°å®é™…è¦è®¿é—®é‚£æ®µç‰©ç†å†…å­˜åå†å°†å…¶å¡«å……ï¼Œå†…åé€šè¿‡fixmapè¿™æ®µè™šæ‹Ÿåœ°å€èŒƒå›´å°±å¯ä»¥é€šè¿‡æŸ¥è¯¢é¡µè¡¨è®¿é—®åˆ°ç‰©ç†å†…å­˜ã€‚ Fixmapæœ€å…³é”®è¦å®ç°çš„ç›®çš„å°±æ˜¯å°†ä¸€æ®µç©ºé—´çš„è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€å¯¹åº”ä¸Šï¼Œlinuxå†…æ ¸é€šè¿‡è™šæ‹Ÿåœ°å€è®¿é—®åˆ°ç‰©ç†ç©ºé—´ï¼Œé‚£æ—¢ç„¶æ˜¯é€šè¿‡è™šæ‹Ÿåœ°å€è®¿é—®åˆ°ç‰©ç†åœ°å€ï¼Œé‚£å¿…é¡»æ„å»ºå¡«å……è¿™æ®µè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„é¡µè¡¨ï¼Œè¿™æ ·Linuxå†…æ ¸ç»è¿‡MMUåˆ©ç”¨æŸ¥æ‰¾é¡µè¡¨æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€è¿›è¡Œè®¿é—®ã€‚</p>
<h3 id="fixmap_1">fixmapç©ºé—´åˆ†ç±»</h3>
<p>Fixmapæ˜¯ä¸€æ®µå›ºå®šèŒƒå›´çš„è™šæ‹Ÿåœ°å€ï¼Œåœ¨å…¶åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ç¡®å®šå¥½äº†ã€‚ä¸‹é¢æ˜¯æ·»åŠ ä¸€æ®µæ‰“å°å¯ä»¥æŸ¥çœ‹FIXMAPåŒºåŸŸçš„å„å°æ®µçš„åœ°å€èŒƒå›´ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">early_fixmap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdp</span><span class="p">;</span>
<span class="w">    </span><span class="n">p4d_t</span><span class="w"> </span><span class="o">*</span><span class="n">p4dp</span><span class="p">,</span><span class="w"> </span><span class="n">p4d</span><span class="p">;</span>
<span class="w">    </span><span class="n">pud_t</span><span class="w"> </span><span class="o">*</span><span class="n">pudp</span><span class="p">;</span>
<span class="w">    </span><span class="n">pmd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pmdp</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FIXADDR_START</span><span class="p">;</span>

<span class="w">    </span><span class="n">pgdp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgd_offset_k</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="n">p4dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p4d_offset</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="err">\</span><span class="s">"FIX_HOLE             :0x%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__fix_to_virt(FIX_HOLE));</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="err">\</span><span class="s">"FIX_FDT_END          :0x%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__fix_to_virt(FIX_FDT_END));</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="err">\</span><span class="s">"FIX_FDT              :0x%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__fix_to_virt(FIX_FDT));</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="err">\</span><span class="s">"FIX_EARLYCON_MEM_BASE:0x%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__fix_to_virt(FIX_EARLYCON_MEM_BASE));</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="err">\</span><span class="s">"FIX_BTMAP_END        :0x%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__fix_to_virt(FIX_BTMAP_END));</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="err">\</span><span class="s">"FIX_BTMAP_BEGIN      :0x%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__fix_to_virt(FIX_BTMAP_BEGIN));</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="err">\</span><span class="s">"FIX_PTE              :0x%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__fix_to_virt(FIX_PTE));</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="err">\</span><span class="s">"FIX_PMD              :0x%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__fix_to_virt(FIX_PMD));</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="err">\</span><span class="s">"FIX_PUD              :0x%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__fix_to_virt(FIX_PUD));</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="err">\</span><span class="s">"FIX_PGD              :0x%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,__fix_to_virt(FIX_PGD));</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="err">\</span><span class="s">"FIXADDR_START~TOP    :0x%lx - 0x%lx   (%6ld KB)</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,</span>
<span class="w">            </span><span class="n">FIXADDR_START</span><span class="p">,</span><span class="n">FIXADDR_TOP</span><span class="p">,(</span><span class="n">FIXADDR_TOP</span><span class="o">-</span><span class="n">FIXADDR_START</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="p">.......</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">FIX_HOLE</span><span class="w">             </span><span class="o">:</span><span class="mh">0xfffffffdfe000000</span><span class="w"> </span><span class="c1">//0x000007FFFFFFEFF0</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">FIX_FDT_END</span><span class="w">          </span><span class="o">:</span><span class="mh">0xfffffffdfdfff000</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">FIX_FDT</span><span class="w">               </span><span class="o">:</span><span class="mh">0xfffffffdfdc00000</span><span class="w"> </span><span class="c1">//0x000007FFFFFFEFEE</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">FIX_EARLYCON_MEM_BASE</span><span class="o">:</span><span class="mh">0xfffffffdfdbff000</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">FIX_BTMAP_END</span><span class="w">        </span><span class="o">:</span><span class="mh">0xfffffffdfdbf9000</span><span class="w"> </span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">FIX_BTMAP_BEGIN</span><span class="w">      </span><span class="o">:</span><span class="mh">0xfffffffdfda3a000</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">FIX_PTE</span><span class="w">              </span><span class="o">:</span><span class="mh">0xfffffffdfda39000</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">FIX_PMD</span><span class="w">              </span><span class="o">:</span><span class="mh">0xfffffffdfda38000</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">FIX_PUD</span><span class="w">              </span><span class="o">:</span><span class="mh">0xfffffffdfda37000</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">FIX_PGD</span><span class="w">              </span><span class="o">:</span><span class="mh">0xfffffffdfda36000</span><span class="w"> </span><span class="c1">//0x000007FFFFFFEFED</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">FIXADDR_START</span><span class="o">~</span><span class="n">TOP</span><span class="w">    </span><span class="o">:</span><span class="mh">0xfffffffdfdbf9000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xfffffffdfe000000</span><span class="w">   </span><span class="p">(</span><span class="w">  </span><span class="mi">4124</span><span class="w"> </span><span class="n">KB</span><span class="p">)</span>
</code></pre></div>
<p>ä¸Šé¢0xfffffffdfdbf9000 - 0xfffffffdfe000000è¿™æ®µè™šæ‹Ÿåœ°å€èŒƒå›´å°±æ˜¯fixed mapåŒºåŸŸï¼Œè¿™æ®µåŒºåŸŸå¯ä»¥é€šè¿‡FIXADDR_STARTå’ŒFIXADDR_TOPæ¥ç¡®å®šã€‚Fixmapè™šæ‹Ÿåœ°å€å¹³å‡åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸¤ä¸ªéƒ¨åˆ†permanent fixed addresseså’Œtemporary fixed addressesã€‚permanent fixed addressesæ˜¯æ°¸ä¹…æ˜ å°„ï¼Œtemporary fixed addressesæ˜¯ä¸´æ—¶æ˜ å°„ã€‚æ°¸ä¹…æ˜ å°„æ˜¯æŒ‡åœ¨å»ºç«‹çš„æ˜ å°„å…³ç³»åœ¨kernelé˜¶æ®µä¸ä¼šæ”¹å˜ï¼Œä»…ä¾›ç‰¹å®šæ¨¡å—ä¸€ç›´ä½¿ç”¨ã€‚ä¸´æ—¶æ˜ å°„å°±æ˜¯æ¨¡å—ä½¿ç”¨å‰åˆ›å»ºæ˜ å°„ï¼Œä½¿ç”¨åè§£é™¤æ˜ å°„ã€‚fixmapåŒºåŸŸåˆè¢«ç»§ç»­ç»†åˆ†ï¼Œåˆ†é…ç»™ä¸åŒæ¨¡å—ä½¿ç”¨ã€‚kernelä¸­å®šä¹‰æšä¸¾ç±»å‹ä½œä¸ºindexï¼Œæ ¹æ®indexå¯ä»¥è®¡ç®—åœ¨fixmapåŒºåŸŸçš„è™šæ‹Ÿåœ°å€ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_23663a9fb10854c6c0043aad12af115c.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_23663a9fb10854c6c0043aad12af115c.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="k">asm</span><span class="o">/</span><span class="n">fixmap</span><span class="p">.</span><span class="n">h</span>
<span class="k">enum</span><span class="w"> </span><span class="n">fixed_addresses</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">FIX_HOLE</span><span class="p">,</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Reserve a virtual window for the FDT that is 2 MB larger than the</span>
<span class="cm">     * maximum supported size, and put it at the top of the fixmap region.</span>
<span class="cm">     * The additional space ensures that any FDT that does not exceed</span>
<span class="cm">     * MAX_FDT_SIZE can be mapped regardless of whether it crosses any</span>
<span class="cm">     * 2 MB alignment boundaries.</span>
<span class="cm">     *</span>
<span class="cm">     * Keep this at the top so it remains 2 MB aligned.</span>
<span class="cm">     */</span>
<span class="cp">#define FIX_FDT_SIZE        (MAX_FDT_SIZE + SZ_2M)</span>
<span class="w">    </span><span class="n">FIX_FDT_END</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_FDT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FIX_FDT_END</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">FIX_FDT_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_EARLYCON_MEM_BASE</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_TEXT_POKE0</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_ACPI_APEI_GHES</span>
<span class="w">    </span><span class="cm">/* Used for GHES mapping from assorted contexts */</span>
<span class="w">    </span><span class="n">FIX_APEI_GHES_IRQ</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_APEI_GHES_SEA</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_ARM_SDE_INTERFACE</span>
<span class="w">    </span><span class="n">FIX_APEI_GHES_SDEI_NORMAL</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_APEI_GHES_SDEI_CRITICAL</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ACPI_APEI_GHES */</span>

<span class="cp">#ifdef CONFIG_UNMAP_KERNEL_AT_EL0</span>
<span class="w">    </span><span class="n">FIX_ENTRY_TRAMP_TEXT3</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_ENTRY_TRAMP_TEXT2</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_ENTRY_TRAMP_TEXT1</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_ENTRY_TRAMP_DATA</span><span class="p">,</span>
<span class="cp">#define TRAMP_VALIAS        (__fix_to_virt(FIX_ENTRY_TRAMP_TEXT1))</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_UNMAP_KERNEL_AT_EL0 */</span>
<span class="w">    </span><span class="n">__end_of_permanent_fixed_addresses</span><span class="p">,</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Temporary boot-time mappings, used by early_ioremap(),</span>
<span class="cm">     * before ioremap() is functional.</span>
<span class="cm">     */</span>
<span class="cp">#define NR_FIX_BTMAPS       (SZ_256K / PAGE_SIZE)</span>
<span class="cp">#define FIX_BTMAPS_SLOTS    7</span>
<span class="cp">#define TOTAL_FIX_BTMAPS    (NR_FIX_BTMAPS * FIX_BTMAPS_SLOTS)</span>

<span class="w">    </span><span class="n">FIX_BTMAP_END</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__end_of_permanent_fixed_addresses</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_BTMAP_BEGIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FIX_BTMAP_END</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOTAL_FIX_BTMAPS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Used for kernel page table creation, so unmapped memory may be used</span>
<span class="cm">     * for tables.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">FIX_PTE</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_PMD</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_PUD</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_PGD</span><span class="p">,</span>

<span class="w">    </span><span class="n">__end_of_fixed_addresses</span>
<span class="p">};</span>

<span class="cp">#define FIXADDR_SIZE    (__end_of_permanent_fixed_addresses &lt;&lt; PAGE_SHIFT)</span>
<span class="cp">#define FIXADDR_START   (FIXADDR_TOP - FIXADDR_SIZE)</span>
</code></pre></div>
<h3 id="fixmap_2">fixmapåˆå§‹åŒ–</h3>
<p>å‰é¢æè¿°äº†ï¼Œfixmapå°±æ˜¯è®©ä¸€æ®µå›ºå®šçš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸ä¸€æ®µç‰©ç†ç©ºé—´å»ºç«‹æ˜ å°„ï¼Œä»¥ä¾¿linuxå†…æ ¸é€šè¿‡è™šæ‹Ÿåœ°å€æ‰èƒ½è®¿é—®åˆ°å¯¹åº”ç‰©ç†åœ°å€çš„ç©ºé—´æ•°æ®ï¼Œè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢æ˜¯é€šè¿‡mmuæŸ¥è¯¢é¡µè¡¨å¾—æ¥çš„ï¼Œå› æ­¤éœ€è¦æ„å»ºå¡«å……è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€è½¬æ¢çš„é¡µè¡¨ã€‚åœ¨linuxå†…æ ¸ä¸­ï¼Œé¡µè¡¨å­˜å‚¨é€šè¿‡å®šä¹‰äº†3ä¸ªå…¨å±€æ•°ç»„bm_pud,bm_pmd,bt_pteæ¥å­˜å‚¨ã€‚å› æ­¤early_fixmap_initçš„ç›®çš„æ¥å¡«å……è¿™å‡ ä¸ªæ•°ç»„ï¼ˆé¡µè¡¨ï¼‰ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">pte_t</span><span class="w"> </span><span class="n">bm_pte</span><span class="p">[</span><span class="n">PTRS_PER_PTE</span><span class="p">]</span><span class="w"> </span><span class="n">__page_aligned_bss</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="n">pmd_t</span><span class="w"> </span><span class="n">bm_pmd</span><span class="p">[</span><span class="n">PTRS_PER_PMD</span><span class="p">]</span><span class="w"> </span><span class="n">__page_aligned_bss</span><span class="w"> </span><span class="n">__maybe_unused</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="n">pud_t</span><span class="w"> </span><span class="n">bm_pud</span><span class="p">[</span><span class="n">PTRS_PER_PUD</span><span class="p">]</span><span class="w"> </span><span class="n">__page_aligned_bss</span><span class="w"> </span><span class="n">__maybe_unused</span><span class="p">;</span>

<span class="n">æ²¡æœ‰å»ºç«‹PGD</span><span class="err">ï¼Œ</span><span class="n">PGDåœ¨swapper_pg_dirä¸­</span><span class="err">ï¼Œ</span><span class="n">åœ¨å†…æ ¸é•œåƒçš„æ•°æ®æ®µ</span>

<span class="n">PTRS_PER_PTE</span><span class="o">/</span><span class="n">PMD</span><span class="o">/</span><span class="n">PUDä¸ºé¡µè¡¨entryçš„æ•°ç›®</span>
<span class="cp">#define PTRS_PER_PTE        (1 &lt;&lt; (PAGE_SHIFT - 3))</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">mm</span><span class="o">/</span><span class="n">mmu</span><span class="p">.</span><span class="n">c</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="n">early_fixmap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgd</span><span class="p">;</span>
<span class="n">p4d_t</span><span class="w"> </span><span class="o">*</span><span class="n">p4dp</span><span class="p">,</span><span class="w"> </span><span class="n">p4d</span><span class="p">;</span>
<span class="w">    </span><span class="n">pud_t</span><span class="w"> </span><span class="o">*</span><span class="n">pud</span><span class="p">;</span>
<span class="w">    </span><span class="n">pmd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pmd</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FIXADDR_START</span><span class="p">;</span><span class="w"> </span><span class="err">ï¼ˆ</span><span class="mi">1</span><span class="err">ï¼‰</span><span class="n">FIXADDR_STARTå®šä¹‰äº†fixedmapåŒºåŸŸçš„èµ·å§‹åœ°å€</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">pgdp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgd_offset_k</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span><span class="w"> </span>
<span class="n">p4dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p4d_offset</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span><span class="c1">//3çº§é¡µè¡¨ä¸­p4dp=pgd</span>
<span class="n">p4d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">p4dp</span><span class="p">);</span><span class="c1">//è¯»è¡¨é¡¹ä¸­çš„å†…å®¹</span>
<span class="err">ï¼ˆ</span><span class="mi">2</span><span class="err">ï¼‰</span><span class="n">è·å–addrå¯¹åº”çš„pgdå…¨å±€é¡µè¡¨è¡¨é¡¹åœ°å€</span><span class="err">ï¼Œ</span><span class="n">é¡µè¡¨æ˜¯swapper_pg_dirçš„ç©ºé—´</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CONFIG_PGTABLE_LEVELS</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="o">!</span><span class="p">(</span><span class="n">pgd_none</span><span class="p">(</span><span class="o">*</span><span class="n">pgd</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">pgd_page_paddr</span><span class="p">(</span><span class="o">*</span><span class="n">pgd</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">__pa_symbol</span><span class="p">(</span><span class="n">bm_pud</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pud_offset_kimg</span><span class="p">(</span><span class="n">pgd</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="n">å› ä¸ºæ˜¯3çº§é¡µè¡¨p4d_node</span><span class="o">=</span><span class="mi">0</span><span class="err">ï¼Œ</span><span class="n">å› æ­¤ä¸ä¼šè¿›å…¥è¿™é‡Œ</span><span class="err">ï¼Œ</span><span class="n">ä¹Ÿå°±æ˜¯ä¸ä¼šä½¿ç”¨bm_pud</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p4d_none</span><span class="p">(</span><span class="n">p4d</span><span class="p">))</span>
<span class="w">            </span><span class="n">__p4d_populate</span><span class="p">(</span><span class="n">p4dp</span><span class="p">,</span><span class="w"> </span><span class="n">__pa_symbol</span><span class="p">(</span><span class="n">bm_pud</span><span class="p">),</span><span class="w"> </span><span class="n">P4D_TYPE_TABLE</span><span class="p">);</span><span class="w"> </span>
<span class="w">        </span><span class="n">pud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixmap_pud</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="n">è·å–addråœ¨PUDé¡µè¡¨é¡¹ä¸­çš„åç§»åœ°å€</span><span class="err">ï¼Œ</span><span class="n">è¿™é‡Œæ˜¯3çº§é¡µè¡¨</span><span class="err">ï¼Œ</span><span class="n">æ‰€ä»¥pud</span><span class="o">=</span><span class="n">pgdp</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pud_none</span><span class="p">(</span><span class="o">*</span><span class="n">pud</span><span class="p">))</span>
<span class="w">        </span><span class="n">__pud_populate</span><span class="p">(</span><span class="n">pud</span><span class="p">,</span><span class="w"> </span><span class="n">__pa_symbol</span><span class="p">(</span><span class="n">bm_pmd</span><span class="p">),</span><span class="w"> </span><span class="n">PMD_TYPE_TABLE</span><span class="p">);</span><span class="w"> </span>
<span class="w">       </span><span class="err">ï¼ˆ</span><span class="mi">5</span><span class="err">ï¼‰</span><span class="n">å°†bm_pmdçš„ç‰©ç†åœ°å€å†™åˆ°pgdé¡µè¡¨å¯¹åº”è¡¨é¡¹ä¸­</span>
<span class="w">    </span><span class="n">pmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixmap_pmd</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="err">ï¼ˆ</span><span class="mi">6</span><span class="err">ï¼‰</span><span class="n">è·å–addråœ¨å¯¹åº”é¡µè¡¨ä¸­è¡¨é¡¹çš„åœ°å€</span><span class="err">ï¼ˆ</span><span class="n">è™šæ‹Ÿåœ°å€</span><span class="err">ï¼‰ã€‚</span>
<span class="w">    </span><span class="n">__pmd_populate</span><span class="p">(</span><span class="n">pmd</span><span class="p">,</span><span class="w"> </span><span class="n">__pa_symbol</span><span class="p">(</span><span class="n">bm_pte</span><span class="p">),</span><span class="w"> </span><span class="n">PMD_TYPE_TABLE</span><span class="p">);</span><span class="w"> </span>
<span class="err">ï¼ˆ</span><span class="mi">7</span><span class="err">ï¼‰</span><span class="n">å°†bm_pteçš„ç‰©ç†åœ°å€å†™åˆ°pmdé¡µè¡¨ä¸­</span><span class="err">ã€‚</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_a43f5a5f0c5c2ac250675dd7c3dbf93e.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_a43f5a5f0c5c2ac250675dd7c3dbf93e.jpg"/></a></p>
<p>TIPS:å½“ä½¿ç”¨3çº§é¡µè¡¨æ—¶ï¼Œå†…æ ¸å¦‚ä½•åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ›å»ºPUDé¡µè¡¨ï¼Ÿ</p>
<div class="codehilite"><pre><span></span><code><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="k">asm</span><span class="o">/</span><span class="n">pgtable</span><span class="o">-</span><span class="n">types</span><span class="p">.</span><span class="n">h</span>

<span class="cp">#if CONFIG_PGTABLE_LEVELS == 2</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;asm-generic/pgtable-nopmd.h&gt;</span>
<span class="cp">#elif CONFIG_PGTABLE_LEVELS == 3</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;asm-generic/pgtable-nopud.h&gt;</span>
<span class="cp">#elif CONFIG_PGTABLE_LEVELS == 4</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;asm-generic/pgtable-nop4d.h&gt;</span>
<span class="cp">#endif</span>
</code></pre></div>
<p>ä»ä¸Šå¯çŸ¥ï¼Œé¡µè¡¨æ˜¯3çº§é¡µè¡¨æ—¶ï¼ŒåŒ…å«çš„pudç›¸å…³çš„å¤´æ–‡ä»¶æ—¶#include <asm-generic pgtable-nopud.h=""></asm-generic></p>
<div class="codehilite"><pre><span></span><code><span class="n">include</span><span class="o">/</span><span class="k">asm</span><span class="o">-</span><span class="n">generic</span><span class="o">/</span><span class="n">pgtable</span><span class="o">-</span><span class="n">nopud</span><span class="p">.</span><span class="n">h</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">p4d_none</span><span class="p">(</span><span class="n">p4d_t</span><span class="w"> </span><span class="n">p4d</span><span class="p">)</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">//ç›´æ¥è¿”å›0</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">p4d_bad</span><span class="p">(</span><span class="n">p4d_t</span><span class="w"> </span><span class="n">p4d</span><span class="p">)</span><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">p4d_present</span><span class="p">(</span><span class="n">p4d_t</span><span class="w"> </span><span class="n">p4d</span><span class="p">)</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">p4d_clear</span><span class="p">(</span><span class="n">p4d_t</span><span class="w"> </span><span class="o">*</span><span class="n">p4d</span><span class="p">)</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<span class="cp">#define p4d_populate(mm, p4d, pud)      do { } while (0)</span>
<span class="cp">#define p4d_populate_safe(mm, p4d, pud)     do { } while (0)</span>
<span class="cp">#define set_p4d(p4dptr, p4dval) set_pud((pud_t *)(p4dptr), (pud_t) { p4dval })</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">pud_t</span><span class="w"> </span><span class="o">*</span><span class="n">pud_offset</span><span class="p">(</span><span class="n">p4d_t</span><span class="w"> </span><span class="o">*</span><span class="n">p4d</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pud_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">p4d</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#define pud_offset pud_offset</span>
<span class="cp">#define pud_val(x)              (p4d_val((x).p4d))</span>
<span class="cp">#define __pud(x)                ((pud_t) { __p4d(x) })</span>
<span class="cp">#define p4d_page(p4d)               (pud_page((pud_t){ p4d }))</span>
<span class="cp">#define p4d_pgtable(p4d)            ((pud_t *)(pud_pgtable((pud_t){ p4d })))</span>
<span class="cp">#define pud_alloc_one(mm, address)      NULL</span>
<span class="cp">#define pud_free(mm, x)             do { } while (0)</span>
<span class="cp">#define pud_free_tlb(tlb, x, a)             do { } while (0)</span>
<span class="cp">#undef  pud_addr_end</span>
<span class="cp">#define pud_addr_end(addr, end)         (end)</span>
</code></pre></div>
<p>å®é™…ä¸Šï¼Œearly_fixmap_initåªæ˜¯å»ºç«‹äº†ä¸€ä¸ªæ˜ å°„çš„æ¡†æ¶ï¼Œå®é™…çš„ç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€çš„æ˜ å°„å…³ç³»æ˜¯æ²¡æœ‰å¡«å……çš„ï¼Œè¿™ä¸ªéœ€è¦å®é™…ä½¿ç”¨çš„æ—¶å€™å†å»å¡«å……å¯¹åº”çš„pte entryã€‚ bm_pud/bm_pmd/bm_pteæ˜¯å…¨å±€æ•°ç»„ï¼ˆå…¨å±€æ•°æ®æ®µï¼‰ï¼Œè¯¥é˜¶æ®µè®¿é—®è¿™å‡ ä¸ªå…¨å±€æ•°ç»„çš„è™šæ‹Ÿåœ°å€èƒ½å¤Ÿå¯ä»¥é€šè¿‡mmuè½¬åŒ–ä¸ºç‰©ç†åœ°å€ï¼Œå› ä¸ºè¿™å‡ ä¸ªå˜é‡æ˜¯å±äºå†…æ ¸æ˜ åƒä¸­ï¼Œåœ¨ä¸Šä¸€ç« èŠ‚ä¸­å†…æ ¸é•œåƒä¸­çš„æ‰€æœ‰åŒ…æ‹¬æ•°æ®æ®µã€ä»£ç æ®µç­‰éƒ½å¯ä»¥è¿›è¡Œè®¿é—®äº†ï¼Œå› æ­¤è¿™å‡ ä¸ªå…¨å±€æ•°ç»„çš„è™šæ‹Ÿåœ°å€æ˜¯ä¸éœ€è¦æ˜ å°„çš„ã€‚</p>
<h3 id="fixmap_3">fixmapç›¸å…³å‡½æ•°</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_15bdb7e35e942367df40075724cada93.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_15bdb7e35e942367df40075724cada93.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="cp">#define pte_offset_phys(dir,addr)   (pmd_page_paddr(READ_ONCE(*(dir))) + pte_index(addr) * sizeof(pte_t))</span>
<span class="c1">//æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”PTEçš„ç‰©ç†åœ°å€ï¼ˆåŸºåœ°å€ï¼‰ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”PMDæ¡ç›®ä¸­çš„å€¼ã€‚</span>

<span class="cp">#define pte_set_fixmap(addr)        ((pte_t *)set_fixmap_offset(FIX_PTE, addr))</span>
<span class="c1">//è·å–addrï¼ˆç‰©ç†åœ°å€ï¼‰å¯¹åº”çš„è™šæ‹Ÿåœ°å€ï¼Œå…¶è™šæ‹Ÿåœ°å€åœ¨FIX_PTEè¿™ä¸ªèŒƒå›´ï¼ˆå»ºç«‹æ˜ å°„ï¼‰ã€‚</span>

<span class="cp">#define pte_set_fixmap_offset(pmd, addr)    pte_set_fixmap(pte_offset_phys(pmd, addr))</span>
<span class="c1">//è·å–addråœ¨PTEé¡µè¡¨é¡¹çš„è™šæ‹Ÿåœ°å€ï¼Œå…¶è™šæ‹Ÿåœ°å€èŒƒå›´åœ¨FIX_PTEè¿™ä¸ªèŒƒå›´ï¼ˆå»ºç«‹æ˜ å°„ï¼‰ã€‚</span>

<span class="cp">#define pte_clear_fixmap()      clear_fixmap(FIX_PTE)</span>
<span class="c1">//æ¸…é™¤FIX_PTEè™šæ‹Ÿåœ°å€çš„æ˜ å°„</span>

<span class="cp">#define pmd_set_fixmap(addr)        ((pmd_t *)set_fixmap_offset(FIX_PMD, addr))</span>
<span class="cp">#define pmd_set_fixmap_offset(pud, addr)    pmd_set_fixmap(pmd_offset_phys(pud, addr))</span>
<span class="cp">#define pmd_clear_fixmap()      clear_fixmap(FIX_PMD)</span>

<span class="cp">#define pud_set_fixmap(addr)        ((pud_t *)set_fixmap_offset(FIX_PUD, addr))</span>
<span class="cp">#define pud_set_fixmap_offset(p4d, addr)    pud_set_fixmap(pud_offset_phys(p4d, addr))</span>
<span class="cp">#define pud_clear_fixmap()      clear_fixmap(FIX_PUD)</span>

<span class="cp">#define pgd_set_fixmap(addr)    ((pgd_t *)set_fixmap_offset(FIX_PGD, addr))</span>
<span class="cp">#define pgd_clear_fixmap()  clear_fixmap(FIX_PGD)</span>
</code></pre></div>
<h3 id="fixmap-io">fixmap ioæ˜ å°„</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__iomem</span><span class="w"> </span><span class="o">*</span><span class="n">prev_map</span><span class="p">[</span><span class="n">FIX_BTMAPS_SLOTS</span><span class="p">]</span><span class="w"> </span><span class="n">__initdata</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">prev_size</span><span class="p">[</span><span class="n">FIX_BTMAPS_SLOTS</span><span class="p">]</span><span class="w"> </span><span class="n">__initdata</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">slot_virt</span><span class="p">[</span><span class="n">FIX_BTMAPS_SLOTS</span><span class="p">]</span><span class="w"> </span><span class="n">__initdata</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">early_ioremap_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">FIX_BTMAPS_SLOTS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">prev_map</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">FIX_BTMAPS_SLOTS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">slot_virt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__fix_to_virt</span><span class="p">(</span><span class="n">FIX_BTMAP_BEGIN</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">NR_FIX_BTMAPS</span><span class="o">*</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Ioremapçš„ç©ºé—´å­˜æ”¾å†slot_viræ•°ç»„ä¸­ï¼Œå…¶è™šæ‹Ÿåœ°å€ç©ºé—´æ¯ä¸€ä¸ªè·¨åº¦ä¸ºNR_FIX_BITMAPSã€‚</p>
<p>å®é™…è¿›è¡ŒIOæ˜ å°„çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ°__early_ioremapå‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­å›å»å¡«å……pte entryï¼Œè¿™æ ·è™šæ‹Ÿåœ°å€å’Œioè®¾å¤‡çš„ç‰©ç†åœ°å€å°±åŒ¹é…ä¸Šäº†ã€‚</p>
<h3 id="fixmap-dtb">fixmap DTBæ˜ å°„</h3>
<div class="codehilite"><pre><span></span><code><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">setup</span><span class="p">.</span><span class="n">c</span>

<span class="n">setup_machine_fdt</span><span class="o">-&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">__init</span><span class="w"> </span><span class="n">fixmap_remap_fdt</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">dt_phys</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">pgprot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">dt_virt_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__fix_to_virt</span><span class="p">(</span><span class="n">FIX_FDT</span><span class="p">);</span><span class="w"> </span><span class="c1">//ä»FIXMAPä¸­è·å–è®¾å¤‡æ ‘çš„è™šæ‹Ÿåœ°å€</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dt_virt</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Check whether the physical FDT address is set and meets the minimum</span>
<span class="cm">     * alignment requirement. Since we are relying on MIN_FDT_ALIGN to be</span>
<span class="cm">     * at least 8 bytes so that we can always access the magic and size</span>
<span class="cm">     * fields of the FDT header after mapping the first chunk, double check</span>
<span class="cm">     * here if that is indeed the case.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">MIN_FDT_ALIGN</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dt_phys</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dt_phys</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">MIN_FDT_ALIGN</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Make sure that the FDT region can be mapped without the need to</span>
<span class="cm">     * allocate additional translation table pages, so that it is safe</span>
<span class="cm">     * to call create_mapping_noalloc() this early.</span>
<span class="cm">     *</span>
<span class="cm">     * On 64k pages, the FDT will be mapped using PTEs, so we need to</span>
<span class="cm">     * be in the same PMD as the rest of the fixmap.</span>
<span class="cm">     * On 4k pages, we\'ll use section mappings for the FDT so we only</span>
<span class="cm">     * have to be in the same PUD.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">dt_virt_base</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">SZ_2M</span><span class="p">);</span>

<span class="w">    </span><span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">__fix_to_virt</span><span class="p">(</span><span class="n">FIX_FDT_END</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">SWAPPER_TABLE_SHIFT</span><span class="w"> </span><span class="o">!=</span>
<span class="w">             </span><span class="n">__fix_to_virt</span><span class="p">(</span><span class="n">FIX_BTMAP_BEGIN</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">SWAPPER_TABLE_SHIFT</span><span class="p">);</span>

<span class="w">    </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dt_phys</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">SWAPPER_BLOCK_SIZE</span><span class="p">;</span>
<span class="w">    </span><span class="n">dt_virt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">dt_virt_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* map the first chunk so we can read the size from the header */</span>
<span class="w">    </span><span class="n">create_mapping_noalloc</span><span class="p">(</span><span class="n">round_down</span><span class="p">(</span><span class="n">dt_phys</span><span class="p">,</span><span class="w"> </span><span class="n">SWAPPER_BLOCK_SIZE</span><span class="p">),</span>
<span class="w">            </span><span class="n">dt_virt_base</span><span class="p">,</span><span class="w"> </span><span class="n">SWAPPER_BLOCK_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//æ ¹æ®æä¾›çš„ç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€è®¾ç½®é¡µè¡¨entryï¼Œå»ºç«‹dbtç‰©ç†åœ°å€åˆ°fixmapä¸­è™šæ‹Ÿåœ°å€çš„æ˜ å°„</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fdt_magic</span><span class="p">(</span><span class="n">dt_virt</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">FDT_MAGIC</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//è·å–dtbæ–‡ä»¶å¤§å°</span>
<span class="o">*</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdt_totalsize</span><span class="p">(</span><span class="n">dt_virt</span><span class="p">);</span>
<span class="c1">//DTBçš„å¤§å°ä¸èƒ½è¶…è¿‡2M</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MAX_FDT_SIZE</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//å¦‚æœDTBæ–‡ä»¶ç»“å°¾çš„åœ°å€ç©ºé—´è¶…è¿‡äº†ä¸Šé¢å»ºç«‹çš„2Måœ°å€èŒƒå›´ï¼Œéœ€è¦ç´§æ¥è¿™å†æ˜ å°„2Måœ°å€ç©ºé—´ã€‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">SWAPPER_BLOCK_SIZE</span><span class="p">)</span>
<span class="w">        </span><span class="n">create_mapping_noalloc</span><span class="p">(</span><span class="n">round_down</span><span class="p">(</span><span class="n">dt_phys</span><span class="p">,</span><span class="w"> </span><span class="n">SWAPPER_BLOCK_SIZE</span><span class="p">),</span><span class="w"> </span><span class="n">dt_virt_base</span><span class="p">,</span>
<span class="w">                   </span><span class="n">round_up</span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">SWAPPER_BLOCK_SIZE</span><span class="p">),</span><span class="w"> </span><span class="n">prot</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dt_virt</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>TIPSï¼šå¦‚ä½•æ‰“å¼€linuxå†…æ ¸pr_debugç›¸å…³çš„æ‰“å°</p>
<div class="codehilite"><pre><span></span><code><span class="n">æ‰“å¼€pr_debugçš„æ‰“å°</span>

<span class="err">ï¼ˆ</span><span class="mi">1</span><span class="err">ï¼‰</span><span class="n">å°†Default</span><span class="w"> </span><span class="n">console</span><span class="w"> </span><span class="n">loglevel</span><span class="w"> </span><span class="n">è®¾ç½®åˆ°8</span>
<span class="w"> </span><span class="n">Kernel</span><span class="w"> </span><span class="n">hacking</span><span class="w"> </span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">printk</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">dmesg</span><span class="w"> </span><span class="n">options</span>
<span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="n">Default</span><span class="w"> </span><span class="n">console</span><span class="w"> </span><span class="n">loglevel</span><span class="w"> </span><span class="p">(</span><span class="mi">1-15</span><span class="p">)</span>

<span class="err">ï¼ˆ</span><span class="mi">2</span><span class="err">ï¼‰</span><span class="n">åœ¨å¯¹åº”çš„æ¨¡å—ä¸Šç¼–è¯‘æ·»åŠ </span><span class="o">-</span><span class="n">DDEBUGå®</span>
<span class="n">diff</span><span class="w"> </span><span class="o">--</span><span class="n">git</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">of</span><span class="o">/</span><span class="n">Makefile</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">of</span><span class="o">/</span><span class="n">Makefile</span>
<span class="n">index</span><span class="w"> </span><span class="n">e0360a44306e</span><span class="p">.</span><span class="mf">.25</span><span class="n">bc584536b3</span><span class="w"> </span><span class="mi">100644</span>
<span class="o">---</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">of</span><span class="o">/</span><span class="n">Makefile</span>
<span class="o">+++</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">of</span><span class="o">/</span><span class="n">Makefile</span>
<span class="o">+</span><span class="n">ccflags</span><span class="o">-</span><span class="n">y</span><span class="w"> </span><span class="o">:=-</span><span class="n">DDEBUG</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_ed6d752d1d9e8e158c2bd68dd3305e77.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_ed6d752d1d9e8e158c2bd68dd3305e77.jpg"/></a></p>
<h2 id="memblock">Memblock</h2>
<p>Linuxå†…æ ¸ä½¿ç”¨ä¼™ä¼´ç³»ç»Ÿç®¡ç†å†…å­˜ï¼Œåœ¨ä¼™ä¼´ç³»ç»Ÿä¹‹å‰ï¼Œå†…æ ¸é€šè¿‡memblockæ¥ç®¡ç†ã€‚åœ¨ç³»ç»Ÿå¯åŠ¨é˜¶æ®µï¼Œä½¿ç”¨memblockè®°å½•ç†å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥åˆ†æˆå¥½å‡ å—ã€‚ - æ°¸ä¹…åˆ†é…ç»™ç³»ç»Ÿå†…æ ¸ï¼šå†…æ ¸é•œåƒå ç”¨çš„éƒ¨åˆ†ï¼Œå¦‚ä»£ç ã€æ•°æ®æ®µç­‰ï¼›è®¾å¤‡æ ‘DTBç­‰ - é¢„ç•™ç»™å¤–è®¾çš„è¿ç»­å†…å­˜ï¼šå¦‚GPU/Camera/å¤šæ ¸å…±äº«ç­‰éœ€è¦é¢„ç•™å¤§é‡è¿ç»­å†…å­˜ã€‚ - å…¶ä»–éƒ¨åˆ†ï¼šä»¥ä¸Šçš„å‰©ä½™éƒ¨åˆ†å†…å­˜ï¼Œéœ€è¦è¿›è¡Œå†…å­˜ç®¡ç†ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_f5ab56223e97582a9c49b7282b87bb9d.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_f5ab56223e97582a9c49b7282b87bb9d.jpg"/></a></p>
<p>Memblockå°†ä»¥ä¸Šå†…å­˜æŒ‰åŠŸèƒ½åˆ’åˆ†ä¸ºè‹¥å¹²å†…å­˜åŒºï¼Œä½¿ç”¨ä¸åŒçš„ç±»å‹å­˜æ”¾åœ¨memoryå’Œreservedä¸¤ä¸ªé›†åˆä¸­ï¼Œmemoryå³åŠ¨æ€å†…å­˜ï¼Œreservedå³é™æ€åˆ†é…çš„å†…å­˜ã€‚</p>
<h3 id="_3">è·å–ç‰©ç†å†…å­˜å¤§å°</h3>
<p>åœ¨è®¾å¤‡æ ‘ä¸­ï¼Œä½¿ç”¨èŠ‚ç‚¹åç§°ä¸ºmemoryæ¥æè¿°å†…å­˜ä¿¡æ¯ï¼Œå¦‚æœç³»ç»Ÿä¸­æœ‰å¤šä¸ªå†…å­˜èŒƒå›´ï¼Œé‚£ä¹ˆdevice treeä¸­å¯èƒ½ä¼šåˆ›å»ºå¤šä¸ªå†…å­˜èŠ‚ç‚¹ï¼Œæˆ–è€…ä¸€ä¸ªå•ç‹¬çš„å†…å­˜èŠ‚ç‚¹é€šè¿‡regå±æ€§æŒ‡å®šå†…å­˜çš„è®¿é—®ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_bc46cb00223ef61f78821936b736e7f2.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_bc46cb00223ef61f78821936b736e7f2.jpg"/></a></p>
<p>å‡è®¾ä¸€ä¸ª64ä½ç³»ç»Ÿå…·æœ‰ä»¥ä¸‹çš„ç‰©ç†å†…å­˜å—ï¼š - RAM:èµ·å§‹åœ°å€0x0,é•¿åº¦0x80000000(2GB) - RAMï¼šèµ·å§‹åœ°å€0x100000000,é•¿åº¦0x100000000(4GB) æ–¹æ³•ä¸€</p>
<div class="codehilite"><pre><span></span><code><span class="n">memory</span><span class="err">@</span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">ã€€   </span><span class="n">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="s">"memory</span><span class="se">\"</span><span class="s">; </span>
<span class="w">ã€€   </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x000000000</span><span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mh">0x80000000</span><span class="w"> </span>
<span class="w">ã€€           </span><span class="mh">0x000000001</span><span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mh">0x00000001</span><span class="w"> </span><span class="mh">0x00000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span>
<span class="p">};</span>
<span class="n">ç¬¬ä¸€ä¸ªæ•´æ•°</span><span class="err">ï¼ˆ</span><span class="mh">0x00000000</span><span class="err">ï¼‰ï¼š</span><span class="n">è¡¨ç¤ºç‰©ç†åœ°å€çš„é«˜32ä½</span><span class="err">ã€‚</span>
<span class="n">ç¬¬äºŒä¸ªæ•´æ•°</span><span class="err">ï¼ˆ</span><span class="mh">0x00000000</span><span class="err">ï¼‰ï¼š</span><span class="n">è¡¨ç¤ºç‰©ç†åœ°å€çš„ä½32ä½</span><span class="err">ã€‚</span><span class="n">åœ¨è¿™ä¸ªä¾‹å­ä¸­</span><span class="err">ï¼Œ</span><span class="n">ç‰©ç†åœ°å€ä¸º0x00000000</span><span class="err">ã€‚</span>
<span class="n">ç¬¬ä¸‰ä¸ªæ•´æ•°</span><span class="err">ï¼ˆ</span><span class="mh">0x00000000</span><span class="err">ï¼‰ï¼š</span><span class="n">è¡¨ç¤ºå¤§å°çš„é«˜32ä½</span><span class="err">ã€‚</span>
<span class="n">ç¬¬å››ä¸ªæ•´æ•°</span><span class="err">ï¼ˆ</span><span class="mh">0x80000000</span><span class="err">ï¼‰ï¼š</span><span class="n">è¡¨ç¤ºå¤§å°çš„ä½32ä½</span><span class="err">ã€‚</span><span class="n">åœ¨è¿™ä¸ªä¾‹å­ä¸­</span><span class="err">ï¼Œ</span><span class="n">å¤§å°ä¸º0x80000000</span><span class="err">ï¼Œ</span><span class="n">å³2GB</span><span class="err">ã€‚</span>
<span class="n">ç¬¬äº”ä¸ªæ•´æ•°</span><span class="err">ï¼ˆ</span><span class="mh">0x00000001</span><span class="err">ï¼‰ï¼š</span><span class="n">è¡¨ç¤ºç‰©ç†åœ°å€çš„é«˜32ä½</span><span class="err">ã€‚</span>
<span class="n">ç¬¬å…­ä¸ªæ•´æ•°</span><span class="err">ï¼ˆ</span><span class="mh">0x00000000</span><span class="err">ï¼‰ï¼š</span><span class="n">è¡¨ç¤ºç‰©ç†åœ°å€çš„ä½32ä½</span><span class="err">ã€‚</span><span class="n">åœ¨è¿™ä¸ªä¾‹å­ä¸­</span><span class="err">ï¼Œ</span><span class="n">ç‰©ç†åœ°å€ä¸º0x100000000</span><span class="err">ã€‚</span>
<span class="n">ç¬¬ä¸ƒä¸ªæ•´æ•°</span><span class="err">ï¼ˆ</span><span class="mh">0x00000001</span><span class="err">ï¼‰ï¼š</span><span class="n">è¡¨ç¤ºå¤§å°çš„é«˜32ä½</span><span class="err">ã€‚</span>
<span class="n">ç¬¬å…«ä¸ªæ•´æ•°</span><span class="err">ï¼ˆ</span><span class="mh">0x00000000</span><span class="err">ï¼‰ï¼š</span><span class="n">è¡¨ç¤ºå¤§å°çš„ä½32ä½</span><span class="err">ã€‚</span><span class="n">åœ¨è¿™ä¸ªä¾‹å­ä¸­</span><span class="err">ï¼Œ</span><span class="n">å¤§å°ä¸º0x100000000</span><span class="err">ï¼Œ</span><span class="n">å³4GB</span><span class="err">ã€‚</span>
</code></pre></div>
<p>æ–¹æ³•äºŒ</p>
<div class="codehilite"><pre><span></span><code><span class="n">memory</span><span class="err">@</span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">ã€€   </span><span class="n">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="s">"memory</span><span class="se">\"</span><span class="s">; </span>
<span class="w">ã€€   </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x000000000</span><span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mh">0x80000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span>
<span class="p">};</span><span class="w"> </span>
<span class="n">memory</span><span class="err">@</span><span class="mi">100000000</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">ã€€   </span><span class="n">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="s">"memory</span><span class="se">\"</span><span class="s">; </span>
<span class="w">ã€€   </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x000000001</span><span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mh">0x00000001</span><span class="w"> </span><span class="mh">0x00000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span>
<span class="p">};</span>
</code></pre></div>
<p>æœ‰äº›å¹³å°ä¸­åœ¨è®¾å¤‡æ ‘ä¸­æœ‰æ—¶å¹¶æ²¡æœ‰å»æè¿°è¯¥èŠ‚ç‚¹ï¼Œé‚£æ˜¯å› ä¸ºåœ¨ubootå¯åŠ¨çš„æ—¶å€™ä¼šåˆ›å»ºæˆ–æ”¹å†™è¯¥èŠ‚ç‚¹ï¼Œå®é™…çš„ç‰©ç†å†…å­˜å¤§å°å¯èƒ½åœ¨boot0é˜¶æ®µå°±æ¢æµ‹åˆ°äº†ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">fdt_fixup_memory_banks</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">blob</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">start</span><span class="p">[],</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">size</span><span class="p">[],</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">banks</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="n">nodeoffset</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">tmp</span><span class="p">[</span><span class="n">MEMORY_BANKS_MAX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">];</span><span class="w"> </span><span class="cm">/* Up to 64-bit address + 64-bit size */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">banks</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MEMORY_BANKS_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s: num banks %d exceeds hardcoded limit %d.</span><span class="se">\"</span>
<span class="w">               </span><span class="err">\</span><span class="s">" Recompile with higher MEMORY_BANKS_MAX?</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,</span>
<span class="w">               </span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="w"> </span><span class="n">banks</span><span class="p">,</span><span class="w"> </span><span class="n">MEMORY_BANKS_MAX</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdt_check_header</span><span class="p">(</span><span class="n">blob</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="err">\</span><span class="s">"%s: %s</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">, __FUNCTION__, fdt_strerror(err));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="cm">/* find or create \"/memory\" node. */</span>
<span class="w">    </span><span class="n">nodeoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdt_find_or_add_subnode</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="s">"memory</span><span class="se">\"</span><span class="s">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nodeoffset</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">nodeoffset</span><span class="p">;</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdt_setprop</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span><span class="w"> </span><span class="n">nodeoffset</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="s">"device_type</span><span class="se">\"</span><span class="s">, </span><span class="se">\"</span><span class="s">memory</span><span class="se">\"</span><span class="s">,</span>
<span class="w">            </span><span class="k">sizeof</span><span class="p">(</span><span class="err">\</span><span class="s">"memory</span><span class="se">\"</span><span class="s">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="err">\</span><span class="s">"WARNING: could not set %s %s.</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">, </span><span class="se">\"</span><span class="s">device_type</span><span class="se">\"</span><span class="s">,</span>
<span class="w">                </span><span class="n">fdt_strerror</span><span class="p">(</span><span class="n">err</span><span class="p">));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">banks</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">banks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">banks</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">banks</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="n">banks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdt_pack_reg</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">banks</span><span class="p">);</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdt_setprop</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span><span class="w"> </span><span class="n">nodeoffset</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="s">"reg</span><span class="se">\"</span><span class="s">, tmp, len);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="err">\</span><span class="s">"WARNING: could not set %s %s.</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,</span>
<span class="w">                </span><span class="err">\</span><span class="s">"reg</span><span class="se">\"</span><span class="s">, fdt_strerror(err));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>
<p>æ‰€ä»¥ï¼Œåœ¨è®¾å¤‡æ ‘ä¸­æ‰¾ä¸åˆ°æè¿°ï¼Œå¯ä»¥åœ¨ç³»ç»Ÿå¯åŠ¨é˜¶æ®µåœ¨ubooté˜¶æ®µæŸ¥çœ‹å†…å­˜èŠ‚ç‚¹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="o">=&gt;</span><span class="w"> </span><span class="n">fdt</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">/</span><span class="n">memory</span>
<span class="n">memory</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00000000</span><span class="w"> </span><span class="mh">0x40000000</span><span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mh">0x80000000</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="n">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="s">"memory</span><span class="se">\"</span><span class="s">;</span>
<span class="p">};</span>
<span class="n">ç‰©ç†åœ°å€èµ·å§‹</span><span class="err">ï¼š</span><span class="mh">0x40000000</span><span class="w"> </span>
<span class="n">ç‰©ç†å†…å­˜å¤§å°</span><span class="err">ï¼š</span><span class="mh">0x80000000</span><span class="err">ï¼ˆ</span><span class="mi">2</span><span class="n">GB</span><span class="err">ï¼‰</span>
</code></pre></div>
<p>å†…æ ¸è°ƒç”¨early_init_dt_scan_nodesæ‰«æDTBï¼Œç„¶åå°†ç‰©ç†å†…å­˜åŒæ•…å®«memblock_addæ·»åŠ åˆ°memblockä¸­è¿›è¡Œç®¡ç†ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">drivers</span><span class="o">/</span><span class="n">os</span><span class="o">/</span><span class="n">fdt</span><span class="p">.</span><span class="n">c</span>

<span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="n">early_init_dt_scan_nodes</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Initialize {size,address}-cells info */</span>
<span class="w">    </span><span class="n">of_scan_flat_dt</span><span class="p">(</span><span class="n">early_init_dt_scan_root</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Retrieve various information from the /chosen node */</span>
<span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">of_scan_flat_dt</span><span class="p">(</span><span class="n">early_init_dt_scan_chosen</span><span class="p">,</span><span class="w"> </span><span class="n">boot_command_line</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
<span class="w">        </span><span class="n">pr_warn</span><span class="p">(</span><span class="err">\</span><span class="s">"No chosen node found, continuing without</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">);</span>

<span class="w">    </span><span class="cm">/* Setup memory, calling early_init_dt_add_memory_arch */</span>
<span class="w">    </span><span class="n">of_scan_flat_dt</span><span class="p">(</span><span class="n">early_init_dt_scan_memory</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">      </span><span class="n">early_init_dt_add_memory_arch</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="n">memblock_add</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="c1">//ä»è®¾å¤‡æ ‘ä¸­è¯»å–åˆ°ç‰©ç†å†…å­˜çš„åœ°å€å’Œå¤§å°ï¼Œæ·»åŠ åˆ°memblockä¸­</span>

<span class="w">    </span><span class="cm">/* Handle linux,usable-memory-range property */</span>
<span class="w">    </span><span class="n">early_init_dt_check_for_usable_mem_range</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_4">ç®¡ç†ç»“æ„ä½“</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_a869009d572cf7995e9b217791b39879.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_a869009d572cf7995e9b217791b39879.jpg"/></a></p>
<ul>
<li>ç¬¬ä¸€å±‚ï¼šstruct memblockï¼Œå®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç”¨æ¥ç»´æŠ¤æ‰€æœ‰çš„ç‰©ç†å†…å­˜ï¼›</li>
<li>ç¬¬äºŒå±‚ï¼šstruct memblock_typeï¼Œç³»ç»Ÿä¸­å†…å­˜ç±»å‹ï¼ŒåŒ…æ‹¬å¯åˆ†é…ä½¿ç”¨çš„å†…å­˜å’Œä¿ç•™çš„å†…å­˜ï¼›</li>
<li>ç¬¬ä¸‰å±‚ï¼šstruct memblock_regionï¼Œæè¿°å…·ä½“å†…å­˜åŒºåŸŸï¼ŒåŒ…å«åœ¨struct memblock_typeä¸­çš„regionsæ•°ç»„ä¸­ï¼Œæœ€å¤šå­˜æ”¾128ä¸ªã€‚</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">mm</span><span class="o">/</span><span class="n">memblock</span><span class="p">.</span><span class="n">c</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">memblock_region</span><span class="w"> </span><span class="n">memblock_memory_init_regions</span><span class="p">[</span><span class="n">INIT_MEMBLOCK_REGIONS</span><span class="p">]</span><span class="w"> </span><span class="n">__initdata_memblock</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">memblock_region</span><span class="w"> </span><span class="n">memblock_reserved_init_regions</span><span class="p">[</span><span class="n">INIT_MEMBLOCK_RESERVED_REGIONS</span><span class="p">]</span><span class="w"> </span><span class="n">__initdata_memblock</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">memblock</span><span class="w"> </span><span class="n">memblock</span><span class="w"> </span><span class="n">__initdata_memblock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">regions</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">memblock_memory_init_regions</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">cnt</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">    </span><span class="cm">/* empty dummy entry */</span>
<span class="w">    </span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">max</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">INIT_MEMBLOCK_REGIONS</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="s">"memory</span><span class="se">\"</span><span class="s">,</span>

<span class="w">    </span><span class="p">.</span><span class="n">reserved</span><span class="p">.</span><span class="n">regions</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">memblock_reserved_init_regions</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">reserved</span><span class="p">.</span><span class="n">cnt</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">    </span><span class="cm">/* empty dummy entry */</span>
<span class="w">    </span><span class="p">.</span><span class="n">reserved</span><span class="p">.</span><span class="n">max</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">INIT_MEMBLOCK_RESERVED_REGIONS</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">reserved</span><span class="p">.</span><span class="n">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="s">"reserved</span><span class="se">\"</span><span class="s">,</span>

<span class="w">    </span><span class="p">.</span><span class="n">bottom_up</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">current_limit</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">MEMBLOCK_ALLOC_ANYWHERE</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p>å®šä¹‰äº†memblockå…¨å±€å˜é‡ï¼Œå› æ­¤æ˜¯ä¸éœ€è¦åˆå§‹åŒ–çš„ï¼Œåœ¨å®šä¹‰çš„æ—¶å€™å°±è¿›è¡Œäº†åˆå§‹åŒ–ã€‚regionsæŒ‡å‘çš„ä¹Ÿæ˜¯é™æ€å…¨å±€çš„æ•°ç»„ï¼Œæ•°ç»„çš„å¤§å°ä¸ºINIT_MEMBLOCK_REGIONSï¼ˆ128ï¼‰ï¼Œåœ¨å®é™…ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå½“è¶…è¿‡è¿™ä¸ªæ•°ç»„æ—¶ï¼Œè¿™ä¸ªæ•°ç»„å°†ä¼šè¿›è¡ŒåŠ¨æ€æ‰©å¤§ã€‚</p>
<h3 id="memblock_1">memblockä¸»è¦æ¥å£å‡½æ•°</h3>
<p>Memblockç³»ç»Ÿæä¾›ä¸€äº›åˆ—æ¥å£ä¾›å†…æ ¸æ¨¡å—ä½¿ç”¨ï¼ŒåŒ…æ‹¬å†…å­˜åŒºå—çš„æ·»åŠ ã€é¢„ç•™ã€å†…å­˜ç”³è¯·ç­‰åŠŸèƒ½ã€‚ - memblock_add:å°†å†…å­˜å—æ·»åŠ åˆ°å¯ç”¨å†…å­˜é›†åˆï¼Œæ·»åŠ æ–°çš„å†…å­˜å—åŒºåŸŸåˆ°memblock.memoryä¸­ã€‚ - memblock_reserve:å°†å†…å­˜å—æ·»åŠ åˆ°é¢„ç•™å†…å­˜é›†åˆ - memblock_phys_alloc:ç”¨äºç”³è¯·memblockä¸­çš„ç‰©ç†å†…å­˜ - memblock_remove:åˆ é™¤å†…å­˜å—åŒºåŸŸ - memblock_alloc:åˆ†é…å†…å­˜ - memblock_free:é‡Šæ”¾å†…å­˜</p>
<h4 id="memblock_add">memblock_add</h4>
<p>memblock_addå‡½æ•°å°†ç‰©ç†å†…å­˜åŒºå—æ·»åŠ åˆ°å¯ç”¨å†…å­˜é›†åˆä¸­ï¼Œç»“æ„ç®¡ç†å›¾å¦‚ä¸‹</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_47d2c5ceb64eb74d8a7a5f45335b5149.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_47d2c5ceb64eb74d8a7a5f45335b5149.jpg"/></a></p>
<h4 id="memblock_reserve">memblock_reserve</h4>
<p>ä¸memblock_addç±»ä¼¼</p>
<h4 id="memblock_alloc">memblock_alloc</h4>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">memblock_alloc</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">align</span><span class="p">)</span>
<span class="w"> </span><span class="n">memblock_alloc_try_nid</span>
<span class="w">  </span><span class="n">memblock_alloc_internal</span>
<span class="w">   </span><span class="n">memblock_alloc_range_nid</span>
<span class="n">memblock_find_in_range_node</span>
<span class="n">phys_to_virt</span><span class="p">(</span><span class="n">alloc</span><span class="p">)</span><span class="w"> </span>
</code></pre></div>
<p>æœ€ç»ˆè°ƒç”¨memblock_find_in_range_nodeå®ç°ç‰©ç†å†…å­˜çš„åˆ†é…ã€‚memblock_phys_allocå‡½æ•°ä¸è¯¥å‡½æ•°ç±»ä¼¼ï¼ŒåŒºåˆ«æ˜¯memblock_allocåœ¨åˆ†é…åä¼šä¼šè°ƒç”¨phys_to_virtå°†ç‰©ç†åœ°å€è½¬åŒ–ä¸ºè™šæ‹Ÿåœ°å€ï¼Œè€Œmemblock_phys_allocä¸ä¼šã€‚</p>
<h3 id="arm64-memblock-init">Arm64 memblock init</h3>
<p>ç‰©ç†å†…å­˜éƒ½æ·»åŠ åˆ°ç³»ç»Ÿä¹‹åï¼Œä¼šè°ƒç”¨arm64_memblock_initå¯¹æ•´ä¸ªç‰©ç†å†…å­˜è¿›è¡Œæ•´ç†ï¼Œä¸»è¦çš„å·¥ä½œå°±æ˜¯removeæ‰ä¸€äº›no-mapåŒºåŸŸï¼ˆä¸å½’å†…æ ¸ç®¡ç†ï¼‰ï¼ŒåŒæ—¶ä¿ç•™ä¸€äº›å…³é”®åŒºåŸŸï¼Œå¦‚å†…æ ¸é•œåƒåŒºï¼Œdtbä¸­reservedçš„å†…å­˜èŠ‚ç‚¹ã€‚ <a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_1ada4f67a7860c6a54b457c46a606fc6.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_1ada4f67a7860c6a54b457c46a606fc6.jpg"/></a></p>
<p>ä¸Šå›¾ä¸­ï¼Œæµ…ç»¿è‰²çš„å°±æ˜¯reservedéƒ¨åˆ†ï¼Œä¸èƒ½è¢«åˆ†é…ä½¿ç”¨ï¼Œè€Œå‰©ä¸‹çš„éƒ¨åˆ†å°±å¯ä»¥é€šè¿‡è°ƒç”¨ä¸Šå°ç« èŠ‚ä¸­çš„å‡½æ•°å»ä½¿ç”¨å†…å­˜äº†ã€‚</p>
<p>å°ç»“ï¼š ï¼ˆ1ï¼‰ç³»ç»Ÿé€šè¿‡memblockä»¥æ•°ç»„memory typeçš„æ–¹å¼è®°å½•ç‰©ç†å†…å­˜ç©ºé—´ï¼Œæ•°ç»„ä¸­æ¯ä¸€ä¸ªå†…å­˜åŒºåŸŸæè¿°äº†ä¸€æ®µå†…å­˜ä¿¡æ¯ï¼ŒåŒ…æ‹¬baseï¼Œsizeï¼Œnode idç­‰ã€‚ ï¼ˆ2ï¼‰åœ¨memblockä¿¡æ¯ä¸­ï¼Œå·²ç»è¢«ä½¿ç”¨æˆ–è€…è¢«å†…æ ¸å®šä¹‰éœ€è¦ä¿ç•™çš„åŒºåŸŸï¼Œä¼šå­˜å‚¨åœ¨reserved æ•°ç»„ä¸­ã€‚ ï¼ˆ3ï¼‰memory typeæ•°ç»„ä¸­å¹¶ä¸æ˜¯ä»£è¡¨æ•´ä¸ªå†…æ ¸ç³»ç»Ÿçš„å†…å­˜ç©ºé—´ï¼Œå› ä¸ºè‚¡ä»½é©±åŠ¨ä¼šä¿ç•™ä¸€æ®µå†…å­˜åŒºåŸŸä¾›è‡ªå·±å•ç‹¬ä½¿ç”¨ï¼Œå…¶åœ¨dtsä¸­å…·æœ‰no-mapç†Ÿæ‚‰çš„reserved-memoryèŠ‚ç‚¹ï¼Œä¸ä¼šç”±å†…æ ¸åˆ›å»ºåœ°å€æ˜ å°„ã€‚ ï¼ˆ4ï¼‰å¯ä»¥é€šè¿‡å†…æ ¸è°ƒè¯•èŠ‚ç‚¹/sys/kernel/debug/memblockkè¿›è¡ŒæŸ¥è¯¢ç›¸å…³ä¿¡æ¯</p>
<h2 id="paging_init">paging_init</h2>
<p>ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œç‰©ç†å†…å­˜é€šè¿‡è¯¥memblockæ¨¡å—æ·»åŠ è¿›äº†ç³»ç»Ÿï¼Œä½†æ˜¯æ­¤æ—¶ä»ç„¶åªæœ‰DTBå’Œimageæ‰€åœ¨çš„ä¸¤ç«¯ç‰©ç†å†…å­˜å¯ä»¥è®¿é—®ï¼Œå…¶ä»–ç‰©ç†å†…å­˜è¿˜è®¿é—®ä¸äº†ï¼Œå› ä¸ºå…¶è¿˜æ²¡æœ‰å»ºç«‹å…¶é¡µè¡¨ã€‚å³ä½¿å¯ä»¥é€šè¿‡memblock_allocåˆ†é…ç‰©ç†å†…å­˜ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½è®¿é—®ï¼Œå› ä¸ºå…¶è™šæ‹Ÿåœ°å€å¯¹åº”çš„é¡µè¡¨æ²¡æœ‰ç”Ÿæˆï¼Œåªæœ‰æ˜¯åˆ›å»ºäº†é¡µè¡¨æ‰èƒ½é€šè¿‡è™šæ‹Ÿåœ°å€è½¬åŒ–è®¿é—®ç‰©ç†åœ°å€ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">paging_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgd_set_fixmap</span><span class="p">(</span><span class="n">__pa_symbol</span><span class="p">(</span><span class="n">swapper_pg_dir</span><span class="p">));</span>
<span class="c1">//ï¼ˆ1ï¼‰è·å–ä¸€é¡µå†…å­˜ç”¨äºæ„å»ºPGDæ˜ å°„è¡¨ï¼Œè¿”å›çš„æ˜¯è™šæ‹Ÿåœ°å€ã€‚</span>
<span class="n">map_kernel</span><span class="p">(</span><span class="n">pgdp</span><span class="p">);</span>
<span class="c1">//ï¼ˆ2ï¼‰å®Œæˆå†…æ ¸çš„æ˜ å°„ï¼ŒåŒ…æ‹¬text,data,bssæ®µç­‰ã€‚</span>
<span class="n">map_mem</span><span class="p">(</span><span class="n">pgdp</span><span class="p">);</span>
<span class="c1">//ï¼ˆ3ï¼‰å°†memblockå­ç³»ç»Ÿæ·»åŠ åˆ°ç‰©ç†å†…å­˜è¿›è¡Œæ˜ å°„</span>
<span class="w">    </span><span class="n">pgd_clear_fixmap</span><span class="p">();</span>
<span class="n">cpu_replace_ttbr1</span><span class="p">(</span><span class="n">lm_alias</span><span class="p">(</span><span class="n">swapper_pg_dir</span><span class="p">));</span>
<span class="c1">//ï¼ˆ4ï¼‰åˆ‡æ¢é¡µè¡¨ï¼Œæ–°å»ºç«‹é¡µè¡¨å†…å®¹æ›¿æ¢swapper_pg_dir</span>
<span class="w">    </span><span class="n">init_mm</span><span class="p">.</span><span class="n">pgd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">swapper_pg_dir</span><span class="p">;</span>
<span class="w">    </span><span class="n">memblock_free</span><span class="p">(</span><span class="n">__pa_symbol</span><span class="p">(</span><span class="n">init_pg_dir</span><span class="p">),</span>
<span class="w">              </span><span class="n">__pa_symbol</span><span class="p">(</span><span class="n">init_pg_end</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__pa_symbol</span><span class="p">(</span><span class="n">init_pg_dir</span><span class="p">));</span>
<span class="w">    </span><span class="c1">//ï¼ˆ5ï¼‰æ–°çš„æ˜ å°„æ›´æ–°å®Œæˆï¼Œé‡Šæ”¾æ‰ä¸´æ—¶ç©ºé—´</span>
<span class="w">    </span><span class="n">memblock_allow_resize</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="pgd">æ„å»ºPGDæ˜ å°„è¡¨</h3>
<p>é¡µç›®å½•ç›´æ¥ä½¿ç”¨çš„æ˜¯swapper_pg_dirï¼Œä¸€ä¸ªæ¡ç›®æ˜ å°„çš„ç©ºé—´æœ¬èº«å°±å¾ˆå¤§ï¼Œä¸€ä¸ªentryå¯¹åº”èŒƒå›´æœ‰512GBã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="k">asm</span><span class="o">/</span><span class="n">fixmap</span><span class="p">.</span><span class="n">h</span>
<span class="k">enum</span><span class="w"> </span><span class="n">fixed_addresses</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">......</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Used for kernel page table creation, so unmapped memory may be used</span>
<span class="cm">     * for tables.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">FIX_PTE</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_PMD</span><span class="p">,</span>
<span class="w">    </span><span class="n">FIX_PUD</span><span class="p">,</span>
<span class="n">FIX_PGD</span><span class="p">,</span>
<span class="p">......</span>
<span class="p">};</span>

<span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgd_set_fixmap</span><span class="p">(</span><span class="n">__pa_symbol</span><span class="p">(</span><span class="n">swapper_pg_dir</span><span class="p">));</span>
<span class="w"> </span><span class="cp">#define pgd_set_fixmap(addr)    ((pgd_t *)set_fixmap_offset(FIX_PGD, addr))</span>

<span class="w">  </span><span class="cp">#define set_fixmap_offset(idx, phys) \\</span>
<span class="cp">__set_fixmap_offset(idx, phys, FIXMAP_PAGE_NORMAL)</span>

<span class="w">   </span><span class="cp">#define __set_fixmap_offset(idx, phys, flags)               \\</span>
<span class="cp">({                                  \\</span>
<span class="cp">     unsigned long ________addr;                 \\</span>
<span class="cp">    __set_fixmap(idx, phys, flags);                 \\</span>
<span class="cp">     ________addr = fix_to_virt(idx) + ((phys) &amp; (PAGE_SIZE - 1));   \\</span>
<span class="cp">     ________addr;                           \\</span>
<span class="cp">})</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">vmlinux</span><span class="p">.</span><span class="n">lds</span><span class="p">.</span><span class="n">S</span>
<span class="w">    </span><span class="n">swapper_pg_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span>
<span class="p">.</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">;</span>

<span class="n">swapper_pg_diræ˜¯å®ç°åˆ†é…çš„ä¸€æ®µç©ºé—´</span><span class="err">ï¼Œ</span><span class="n">å¤„äºå†…æ ¸é•œåƒçš„dataæ®µ</span><span class="err">ã€‚</span>
</code></pre></div>
<p>é€šè¿‡__pa_symbolå…ˆå°†swapper_pg_dirè½¬åŒ–ä¸ºç‰©ç†åœ°å€ï¼Œç„¶åä¸FIX_PGDåœ°å€èŒƒå›´è¿›è¡Œæ˜ å°„ï¼Œåç»­å°±å¯ä»¥é€šè¿‡è™šæ‹Ÿåœ°å€FIX_PGDè¿™æ®µè®¿é—®è®¿é—®åˆ°swapper_pg_dirè¿™å—ç‰©ç†ç©ºé—´ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_298d61f904629b7e9dc7780f3cb7d71c.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_298d61f904629b7e9dc7780f3cb7d71c.jpg"/></a></p>
<h3 id="early_pgtable_alloc">early_pgtable_alloc</h3>
<p>å¯¹å†…æ ¸å„ä¸ªæ®µã€ä»¥åŠmemblockç®¡ç†çš„ç‰©ç†å†…å­˜å»ºç«‹æ˜ å°„ï¼Œåœ¨ä¸Šä¸€ç« èŠ‚ä¸­å·²ç»è·å–åˆ°äº†PGDå…¨å±€ç›®å½•é¡µè¡¨ï¼Œä½†æ˜¯æ¥ä¸‹æ¥çš„PUD,PMD,PTEå¯¹åº”çš„é¡µè¡¨æ˜¯éœ€è¦è¿›è¡ŒåŠ¨æ€åˆ†é…çš„ï¼Œç©ºé—´çš„åˆ†é…å¯ä»¥ä½¿ç”¨memblockæä¾›çš„å‡½æ•°è¿›è¡Œåˆ†é…ï¼Œä½†æ˜¯å¦‚ä½•è¿›è¡Œè®¿é—®å¡«å……é¡µè¡¨äº†ï¼Ÿmemblockåˆ†é…ç©ºé—´å†…æ ¸æ˜¯æ²¡æ³•ç›´æ¥è®¿é—®çš„ï¼Œå› ä¸ºæ²¡æœ‰åˆ›å»ºé¡µè¡¨ï¼Œæ²¡æ³•é€šè¿‡æŸ¥è¡¨çš„æ–¹å¼è¿›è¡ŒæŸ¥æ‰¾åˆ°ç‰©ç†åœ°å€ã€‚è¿™ä¸ªæ—¶å€™å‰é¢fixmapå°±å‘æŒ¥ä½œç”¨äº†ï¼Œåœ¨fixmapç« èŠ‚ä¸­ï¼Œå·²ç»åˆ›å»ºäº†è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„é¡µè¡¨ï¼Œæœ‰ä¸€æ®µå®é™…çš„è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€æ˜¯å¾…å¡«å……çš„ï¼Œé‚£å°±æ˜¯FIX_PTE~FIX_PGDï¼Œæ‰€ä»¥å°±å¯ä»¥åˆ©ç”¨è¿™æ®µç©ºé—´å°†memblockåˆ†é…åˆ°çš„ç‰©ç†åœ°å€ä¸FIX_PTE~FIX_PGDå¯¹åº”ä¸Šï¼Œè¿™æ ·å†…æ ¸å°±å¯ä»¥é€šè¿‡è™šæ‹Ÿåœ°å€è¿›è¡Œè®¿é—®äº†ï¼Œå°±å¯ä»¥å¡«å……é¡µè¡¨å†…å®¹ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_0d80fb38225d4efc6a0cf49ece64f8b4.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_0d80fb38225d4efc6a0cf49ece64f8b4.jpg"/></a></p>
<p>å†…æ ¸è®¿é—®ç‰©ç†å†…å­˜ä½¿ç”¨çš„éƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè€Œç¡¬ä»¶æ¨¡å—æ¯”å¦‚MMUç­‰è®¿é—®å†…å­˜ä½¿ç”¨çš„æ˜¯ç‰©ç†åœ°å€ï¼Œä¸éœ€è¦ä»è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€è½¬æ¢ï¼ˆå¦åˆ™å°±é™·å…¥å¾ªç¯äº†ï¼‰ã€‚è™šæ‹Ÿåœ°å€è½¬ä¸ºç‰©ç†åœ°å€éœ€è¦æŸ¥æ‰¾é¡µè¡¨æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œè€Œè¿™ä¸ªé¡µè¡¨éœ€è¦è¿›è¡Œå¡«å……ï¼ˆå»ºç«‹æ˜ å°„å…³ç³»ï¼‰ï¼Œå› æ­¤å†…æ ¸åœ¨å¡«å……é¡µè¡¨çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä½¿ç”¨çš„è™šæ‹Ÿåœ°å€è®¿é—®ã€‚åªè¦æŠŠå„çº§é¡µè¡¨å¡«å……å¥½ä¹‹åå°±å¯ä»¥äº†ï¼Œæœ€ç»ˆMMUåœ¨ç¿»è¯‘çš„æ—¶å€™å°±è®¿é—®çš„æ˜¯ç‰©ç†åœ°å€ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="n">early_pgtable_alloc</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">shift</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">phys</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
<span class="w">    </span><span class="n">phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblock_phys_alloc_range</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                     </span><span class="n">MEMBLOCK_ALLOC_NOLEAKTRACE</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//ï¼ˆ1ï¼‰å…ˆåˆ†é…ä¸€å—ç‰©ç†å†…å­˜</span>
<span class="w">  </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pte_set_fixmap</span><span class="p">(</span><span class="n">phys</span><span class="p">);</span>
<span class="c1">//ï¼ˆ2ï¼‰å°†å½“å‰çš„ç‰©ç†å†…å­˜ä¸fixmapçš„è™šæ‹Ÿåœ°å€è¿›è¡Œæ˜ å°„ï¼Œæ˜ å°„å®Œæˆåï¼Œå†…æ ¸å³å¯è®¿é—®è¿™æ®µå†…å­˜ï¼Œç”¨çš„æ˜¯PTEè¿™æ®µï¼ŒPGD,PUD,PMDç”¨åœ¨å“ªé‡Œï¼Ÿ</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="n">pte_clear_fixmap</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">phys</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>ä»ä¸Šå¯ä»¥çœ‹å‡ºåˆ†é…ä¸€ä¸ªé¡µè¡¨éœ€è¦PAGE_SIZEçš„å¤§å°ï¼Œä¹Ÿå°±ç­‰äºä¸€ä¸ªç‰©ç†é¡µå¸§å¤§å°4KBã€‚é¡µè¡¨æœ‰512ä¸ªæ¡ç›®ï¼Œæ¯ä¸ªæ¡ç›®å ç”¨8å­—èŠ‚ã€‚</p>
<h3 id="-map_kernel">å†…æ ¸é•œåƒç»†ç²’åº¦æ˜ å°„-map_kernel</h3>
<p>Map_kernelä¸»è¦å®Œæˆå†…æ ¸ä¸­å„ä¸ªæ®µçš„æ˜ å°„ï¼ŒåŒ…æ‹¬textã€rodataã€initã€dataã€bssç­‰å„ä¸ªæ®µã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">map_kernel</span><span class="p">(</span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdp</span><span class="p">)</span>
<span class="w">    </span><span class="n">map_kernel_segment</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">_stext</span><span class="p">,</span><span class="w"> </span><span class="n">_etext</span><span class="p">,</span><span class="w"> </span><span class="n">text_prot</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vmlinux_text</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">               </span><span class="n">VM_NO_GUARD</span><span class="p">);</span>
<span class="w">    </span><span class="n">map_kernel_segment</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">__start_rodata</span><span class="p">,</span><span class="w"> </span><span class="n">__inittext_begin</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_KERNEL</span><span class="p">,</span>
<span class="w">               </span><span class="o">&amp;</span><span class="n">vmlinux_rodata</span><span class="p">,</span><span class="w"> </span><span class="n">NO_CONT_MAPPINGS</span><span class="p">,</span><span class="w"> </span><span class="n">VM_NO_GUARD</span><span class="p">);</span>
<span class="w">    </span><span class="n">map_kernel_segment</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">__inittext_begin</span><span class="p">,</span><span class="w"> </span><span class="n">__inittext_end</span><span class="p">,</span><span class="w"> </span><span class="n">text_prot</span><span class="p">,</span>
<span class="w">               </span><span class="o">&amp;</span><span class="n">vmlinux_inittext</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">VM_NO_GUARD</span><span class="p">);</span><span class="w"> </span><span class="c1">//.init</span>
<span class="w">    </span><span class="n">map_kernel_segment</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">__initdata_begin</span><span class="p">,</span><span class="w"> </span><span class="n">__initdata_end</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_KERNEL</span><span class="p">,</span>
<span class="w">               </span><span class="o">&amp;</span><span class="n">vmlinux_initdata</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">VM_NO_GUARD</span><span class="p">);</span><span class="c1">//.data</span>
<span class="w">    </span><span class="n">map_kernel_segment</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">_data</span><span class="p">,</span><span class="w"> </span><span class="n">_end</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_KERNEL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vmlinux_data</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">//.bss</span>
</code></pre></div>
<p>å¯åŠ¨æ—¥å¿—</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">Virtual</span><span class="w"> </span><span class="n">kernel</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">layout</span><span class="o">:</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">     </span><span class="n">modules</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffffc000000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xffffffc008000000</span><span class="w">   </span><span class="p">(</span><span class="w">   </span><span class="mi">128</span><span class="w"> </span><span class="n">MB</span><span class="p">)</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">     </span><span class="n">vmalloc</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffffc008000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xfffffffdf0000000</span><span class="w">   </span><span class="p">(</span><span class="w">   </span><span class="mi">247</span><span class="w"> </span><span class="n">GB</span><span class="p">)</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">       </span><span class="p">.</span><span class="n">text</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffffc008080000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xffffffc008a30000</span><span class="w">   </span><span class="p">(</span><span class="w">  </span><span class="mi">9920</span><span class="w"> </span><span class="n">KB</span><span class="p">)</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">     </span><span class="p">.</span><span class="n">rodata</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffffc008a30000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xffffffc008d70000</span><span class="w">   </span><span class="p">(</span><span class="w">  </span><span class="mi">3328</span><span class="w"> </span><span class="n">KB</span><span class="p">)</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">       </span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffffc008d70000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xffffffc008ef0000</span><span class="w">   </span><span class="p">(</span><span class="w">  </span><span class="mi">1536</span><span class="w"> </span><span class="n">KB</span><span class="p">)</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">       </span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffffc008ef0000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xffffffc00900f008</span><span class="w">   </span><span class="p">(</span><span class="w">  </span><span class="mi">1149</span><span class="w"> </span><span class="n">KB</span><span class="p">)</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">        </span><span class="p">.</span><span class="n">bss</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffffc00900f008</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xffffffc009069920</span><span class="w">   </span><span class="p">(</span><span class="w">   </span><span class="mi">363</span><span class="w"> </span><span class="n">KB</span><span class="p">)</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">     </span><span class="n">fixed</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="mh">0xfffffffdfdbf9000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xfffffffdfe000000</span><span class="w">   </span><span class="p">(</span><span class="w">  </span><span class="mi">4124</span><span class="w"> </span><span class="n">KB</span><span class="p">)</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">     </span><span class="n">PCI</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xfffffffdfe800000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xfffffffdff800000</span><span class="w">   </span><span class="p">(</span><span class="w">    </span><span class="mi">16</span><span class="w"> </span><span class="n">MB</span><span class="p">)</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">     </span><span class="n">vmemmap</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xfffffffe00000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xffffffff00000000</span><span class="w">   </span><span class="p">(</span><span class="w">     </span><span class="mi">4</span><span class="w"> </span><span class="n">GB</span><span class="w"> </span><span class="n">maximum</span><span class="p">)</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">               </span><span class="mh">0xfffffffe00000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xfffffffe02000000</span><span class="w">   </span><span class="p">(</span><span class="w">    </span><span class="mi">32</span><span class="w"> </span><span class="n">MB</span><span class="w"> </span><span class="n">actual</span><span class="p">)</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">     </span><span class="n">memory</span><span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffff8000000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xffffff8080000000</span><span class="w">   </span><span class="p">(</span><span class="w">  </span><span class="mi">2048</span><span class="w"> </span><span class="n">MB</span><span class="p">)</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">     </span><span class="n">PAGE_OFFSET</span><span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffff8000000000</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">     </span><span class="n">PHYS_OFFSET</span><span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="n">x</span><span class="w">        </span><span class="mi">40000000</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">     </span><span class="n">KIMAGE_VADDR</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffffc008000000</span><span class="w">  </span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">map_kernel_segment</span><span class="p">(</span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">va_start</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">va_end</span><span class="p">,</span>
<span class="w">                      </span><span class="n">pgprot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">,</span>
<span class="w">                      </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">pa_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__pa_symbol</span><span class="p">(</span><span class="n">va_start</span><span class="p">);</span><span class="w"> </span><span class="c1">//å°†è™šæ‹Ÿåœ°å€è½¬ä¸ºç‰©ç†åœ°å€</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">va_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">va_start</span><span class="p">;</span>

<span class="w">    </span><span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">PAGE_ALIGNED</span><span class="p">(</span><span class="n">pa_start</span><span class="p">));</span>
<span class="w">    </span><span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">PAGE_ALIGNED</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>

<span class="w">    </span><span class="n">__create_pgd_mapping</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">pa_start</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">va_start</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span>
<span class="w">                 </span><span class="n">early_pgtable_alloc</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VM_NO_GUARD</span><span class="p">))</span>
<span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">;</span>

<span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">addr</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">va_start</span><span class="p">;</span>
<span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">pa_start</span><span class="p">;</span>
<span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">size</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">VM_MAP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">;</span>
<span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">caller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="n">vm_area_add_early</span><span class="p">(</span><span class="n">vma</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_b18c2463b591ae314ded0293f324b1aa.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_b18c2463b591ae314ded0293f324b1aa.jpg"/></a></p>
<h3 id="-map_mem">çº¿æ€§æ˜ å°„-map_mem</h3>
<p>å®Œæˆå¯¹ç‰©ç†å†…å­˜çš„æ˜ å°„ï¼Œè¿™éƒ¨åˆ†çš„ç‰©ç†å†…å­˜æ˜¯åŒæ•…å®«memblock_addæ·»åŠ ç³»ç»Ÿä¸­çš„ï¼Œå‡½æ•°ä¸­å°†ä¼šéå†memblockä¸­çš„å„ä¸ªå—ï¼Œç„¶åè°ƒç”¨__map_memblockæ¥å®Œæˆå®é™…çš„æ˜ å°„æ“ä½œã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">map_mem</span><span class="p">(</span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="p">......</span>
<span class="n">memblock_mark_nomap</span><span class="p">(</span><span class="n">kernel_start</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kernel_start</span><span class="p">);</span>
<span class="c1">//ï¼ˆ1ï¼‰ä¸å¯¹è®¾ç½®äº†MEMBLOCK_NOMAPçš„æ ‡å¿—æ˜ å°„</span>

<span class="w">  </span><span class="cm">/* map all the memory banks */</span>
<span class="w">    </span><span class="n">for_each_mem_range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">end</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * The linear map must allow allocation tags reading/writing</span>
<span class="cm">         * if MTE is present. Otherwise, it has the same attributes as</span>
<span class="cm">         * PAGE_KERNEL.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">__map_memblock</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">pgprot_tagged</span><span class="p">(</span><span class="n">PAGE_KERNEL</span><span class="p">),</span>
<span class="w">                   </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="c1">//ï¼ˆ2ï¼‰éå†memblockä¸­çš„å„ä¸ªå—å¹¶å®Œæˆå†…å­˜çš„æ˜ å°„</span>
<span class="p">}</span>
</code></pre></div>
<p>éå†memblock.memoryè¿›è¡Œé€ä¸€æ˜ å°„ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">map_mem</span><span class="p">(</span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="p">......</span>
<span class="n">memblock_mark_nomap</span><span class="p">(</span><span class="n">kernel_start</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kernel_start</span><span class="p">);</span>
<span class="c1">//ï¼ˆ1ï¼‰ä¸å¯¹è®¾ç½®äº†MEMBLOCK_NOMAPçš„æ ‡å¿—æ˜ å°„</span>

<span class="w">  </span><span class="cm">/* map all the memory banks */</span>
<span class="w">    </span><span class="n">for_each_mem_range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">end</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * The linear map must allow allocation tags reading/writing</span>
<span class="cm">         * if MTE is present. Otherwise, it has the same attributes as</span>
<span class="cm">         * PAGE_KERNEL.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">__map_memblock</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">pgprot_tagged</span><span class="p">(</span><span class="n">PAGE_KERNEL</span><span class="p">),</span>
<span class="w">                   </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="c1">//ï¼ˆ2ï¼‰éå†memblockä¸­çš„å„ä¸ªå—å¹¶å®Œæˆå†…å­˜çš„æ˜ å°„</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">__map_memblock</span><span class="p">(</span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span>
<span class="w">                  </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">pgprot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">__create_pgd_mapping</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">__phys_to_virt</span><span class="p">(</span><span class="n">start</span><span class="p">),</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">,</span>
<span class="w">                 </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">early_pgtable_alloc</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">Startæ˜¯è¦æ˜ å°„çš„ç‰©ç†åœ°å€</span><span class="err">ï¼Œ</span><span class="n">__phys_to_virt</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="n">æ˜¯è¦æ˜ å°„çš„è™šæ‹Ÿåœ°å€</span><span class="err">ï¼Œ</span><span class="n">ç”±æ­¤å¯è§</span><span class="err">ï¼Œ</span><span class="n">è¿™æ®µç©ºé—´æ˜¯è¿›è¡Œçš„çº¿æ€§æ˜ å°„</span><span class="err">ã€‚</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_d72d6060b232c98f975ac6a73a875895.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_d72d6060b232c98f975ac6a73a875895.jpg"/></a></p>
<h3 id="__create_pgd_mapping">__create_pgd_mapping</h3>
<p>map_kernelä¸map_memæœ€ç»ˆéƒ½ä¼šè°ƒç”¨__create_pgd_mappingè¿›è¡Œæ˜ å°„ã€‚</p>
<p><a href="http://8.134.108.235/wp-content/uploads/2023/11/wp_editor_md_3322c2565dfff87c8655ca5612a64302.jpg"><img alt="" src="images/wp_editor_md_3322c2565dfff87c8655ca5612a64302.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">__create_pgd_mapping</span><span class="p">(</span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span>
<span class="w">                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">virt</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
<span class="w">                 </span><span class="n">pgprot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span>
<span class="w">                 </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pgtable_alloc</span><span class="p">)(</span><span class="kt">int</span><span class="p">),</span>
<span class="w">                 </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgd_offset_pgd</span><span class="p">(</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">virt</span><span class="p">);</span><span class="w"> </span>
<span class="c1">//è·å–è¦æ˜ å°„åœ°å€virtåœ¨PGDé¡µè¡¨ç›®å½•çš„è¡¨é¡¹å¯¹åº”çš„åœ°å€ï¼ˆè™šæ‹Ÿåœ°å€ï¼‰ï¼Œæ¥ä¸‹æ¥å°†ä¼šè¿›è¡Œå¡«å……å†…å®¹ï¼ˆä¸‹ä¸€çº§é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼‰ã€‚</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * If the virtual and physical address don\'t have the same offset</span>
<span class="cm">     * within a page, we cannot map the region as the caller expects.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WARN_ON</span><span class="p">((</span><span class="n">phys</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">virt</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//è®©ç‰©ç†å†…å­˜ç”±åŸç†çš„æŒ‰å­—èŠ‚è®¡ç®—ä½ç½®æ”¹ä¸ºæŒ‰é¡µè®¡ç®—ä½ç½®</span>
<span class="w">    </span><span class="n">phys</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="n">PAGE_MASK</span><span class="p">;</span>
<span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">virt</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PAGE_MASK</span><span class="p">;</span>
<span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">virt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="c1">//æŒ‰PAGEå¯¹é½çš„æ–¹å¼ç®—ï¼Œç»“æŸåœ°å€å¤šå°‘ã€‚</span>

<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgd_addr_end</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>
<span class="c1">//æ‰¾åˆ°å½“å‰PGDçš„ç»“æŸåœ°å€ï¼Œä¸€èˆ¬æ¥è¯´PGD entryåªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥è¿™é‡Œçš„å¾ªç¯åªä¼šæœ‰ä¾æ¬¡ã€‚åŸå› æ˜¯ä¸€ä¸ªPGDæœ‰512ä¸ªæ¡ç›®ï¼Œæ¯ä¸ªæ¡ç›®è¡¨ç¤º512GBï¼ˆ2^39ï¼‰çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</span>

<span class="w">        </span><span class="n">alloc_init_pud</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">pgtable_alloc</span><span class="p">,</span>
<span class="w">                   </span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">//åˆå§‹åŒ–è¯¥PGDæ¡ç›®å¯¹åº”çš„PUD</span>
<span class="w">        </span><span class="n">phys</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">pgdp</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="alloc_init_pud">alloc_init_pud</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">alloc_init_pud</span><span class="p">(</span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">end</span><span class="p">,</span>
<span class="w">               </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">pgprot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span>
<span class="w">               </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pgtable_alloc</span><span class="p">)(</span><span class="kt">int</span><span class="p">),</span>
<span class="w">               </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="n">pud_t</span><span class="w"> </span><span class="o">*</span><span class="n">pudp</span><span class="p">;</span>
<span class="n">p4d_t</span><span class="w"> </span><span class="o">*</span><span class="n">p4dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p4d_offset</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span><span class="w"> </span>
<span class="c1">//è·å–ç¬¬å››çº§é¡µè¡¨ä¸­é¡µè¡¨é¡¹çš„åœ°å€ï¼ŒMR527æ˜¯ä¸‰çº§é¡µè¡¨ï¼Œæ‰€ä»¥p4dp=pgdpã€‚</span>
<span class="w">    </span><span class="n">p4d_t</span><span class="w"> </span><span class="n">p4d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">p4dp</span><span class="p">);</span><span class="w"> </span><span class="c1">//è¯»å–è¡¨é¡¹ä¸­çš„å†…å®¹ï¼Œå®é™…è¯»çš„å°±æ˜¯PGDç›®å½•ï¼ˆ3çº§ï¼‰</span>
<span class="w">    </span><span class="c1">//åˆ¤æ–­è¡¨é¡¹å†…å®¹æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºéœ€è¦è¿›è¡ŒPUDï¼Œè¿™é‡Œè¡¨é¡¹ä¸ä¸ºç©ºï¼Œå› ä¸ºæ˜¯3çº§é¡µè¡¨ï¼Œæ‰€ä»¥ä¸éœ€è¦åˆ›å»ºPUD</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p4d_none</span><span class="p">(</span><span class="n">p4d</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">p4dval_t</span><span class="w"> </span><span class="n">p4dval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">P4D_TYPE_TABLE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">P4D_TABLE_UXN</span><span class="p">;</span>
<span class="w">        </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">pud_phys</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">NO_EXEC_MAPPINGS</span><span class="p">)</span>
<span class="w">            </span><span class="n">p4dval</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">P4D_TABLE_PXN</span><span class="p">;</span>
<span class="w">        </span><span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pgtable_alloc</span><span class="p">);</span>
<span class="w">        </span><span class="n">pud_phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgtable_alloc</span><span class="p">(</span><span class="n">PUD_SHIFT</span><span class="p">);</span>
<span class="w">        </span><span class="n">__p4d_populate</span><span class="p">(</span><span class="n">p4dp</span><span class="p">,</span><span class="w"> </span><span class="n">pud_phys</span><span class="p">,</span><span class="w"> </span><span class="n">p4dval</span><span class="p">);</span>
<span class="w">        </span><span class="n">p4d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">p4dp</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">BUG_ON</span><span class="p">(</span><span class="n">p4d_bad</span><span class="p">(</span><span class="n">p4d</span><span class="p">));</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * No need for locking during early boot. And it doesn\'t work as</span>
<span class="cm">     * expected with KASLR enabled.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">system_state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SYSTEM_BOOTING</span><span class="p">)</span>
<span class="w">        </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixmap_lock</span><span class="p">);</span>
<span class="n">pudp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pud_set_fixmap_offset</span><span class="p">(</span><span class="n">p4dp</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
<span class="c1">//è®¡ç®—æ‰€åœ¨PUDï¼ˆPGDï¼‰åç§»è¡¨é¡¹çš„åœ°å€ï¼ˆè™šæ‹Ÿåœ°å€ï¼‰ï¼Œå…¶åœ°å€ï¼ˆè™šæ‹Ÿï¼‰ç©ºé—´åœ¨fixmapèŒƒå›´å†…FIX_PUDï¼ˆFIX_PGDï¼‰èŒƒå›´å†…ï¼Œå› ä¸ºè¦è®¿é—®å…¶ç‰©ç†ç©ºé—´ï¼Œéœ€è¦æŸ¥è¯¢é¡µè¡¨ï¼Œæ‰€ä»¥ä½¿ç”¨ä¹‹å‰åˆ›å»ºå¥½çš„é¡µè¡¨ï¼Œå¡«å……æ˜ å°„å¥½åï¼Œå¯ä»¥ç›´æ¥è®¿é—®ã€‚</span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pud_t</span><span class="w"> </span><span class="n">old_pud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">pudp</span><span class="p">);</span>

<span class="w">        </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pud_addr_end</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>
<span class="c1">//PUDèµ·å§‹å’Œç»“æŸä½ç½®ï¼Œå¤§å°æ˜¯1GBã€‚ç©ºé—´æ¯”è¾ƒå¤§ï¼Œåªå¾ªç¯ä¸€æ¬¡ã€‚</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * For 4K granule only, attempt to put down a 1GB block</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_1G_block</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">NO_BLOCK_MAPPINGS</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pud_set_huge</span><span class="p">(</span><span class="n">pudp</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">);</span>

<span class="w">            </span><span class="cm">/*</span>
<span class="cm">             * After the PUD entry has been populated once, we</span>
<span class="cm">             * only allow updates to the permission attributes.</span>
<span class="cm">             */</span>
<span class="w">            </span><span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pgattr_change_is_safe</span><span class="p">(</span><span class="n">pud_val</span><span class="p">(</span><span class="n">old_pud</span><span class="p">),</span>
<span class="w">                              </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">pud_val</span><span class="p">(</span><span class="o">*</span><span class="n">pudp</span><span class="p">))));</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">alloc_init_cont_pmd</span><span class="p">(</span><span class="n">pudp</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span>
<span class="w">                        </span><span class="n">pgtable_alloc</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span><span class="c1">//å¾ªç¯åœ¨å„ä¸ªPUDæ˜ å°„è¡¨ç°å»ºç«‹å¯¹åº”PMDé¡µè¡¨</span>

<span class="w">            </span><span class="n">BUG_ON</span><span class="p">(</span><span class="n">pud_val</span><span class="p">(</span><span class="n">old_pud</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                   </span><span class="n">pud_val</span><span class="p">(</span><span class="n">old_pud</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">pud_val</span><span class="p">(</span><span class="o">*</span><span class="n">pudp</span><span class="p">)));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">phys</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">pudp</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>

<span class="w">    </span><span class="n">pud_clear_fixmap</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">system_state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SYSTEM_BOOTING</span><span class="p">)</span>
<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixmap_lock</span><span class="p">);</span>
<span class="p">}</span><span class="w">   </span>
</code></pre></div>
<h4 id="alloc_init_cont_pmd">alloc_init_cont_pmd</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">alloc_init_cont_pmd</span><span class="p">(</span><span class="n">pud_t</span><span class="w"> </span><span class="o">*</span><span class="n">pudp</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span>
<span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span>
<span class="w">                </span><span class="n">pgprot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span>
<span class="w">                </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pgtable_alloc</span><span class="p">)(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="n">pud_t</span><span class="w"> </span><span class="n">pud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">pudp</span><span class="p">);</span><span class="c1">//è·å–PUDé¡µè¡¨ä¸­addrå¯¹åº”çš„è¡¨é¡¹å†…å®¹ï¼Œä¹Ÿå°±æ˜¯PMDé¡µè¡¨åœ°å€</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Check for initial section mappings in the pgd/pud.</span>
<span class="cm">     */</span>
<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pud_sect</span><span class="p">(</span><span class="n">pud</span><span class="p">));</span>
<span class="c1">//å¦‚æœPUDé¡µè¡¨ä¸ºç©ºï¼Œåˆ™åˆ†é…ä¸€ä¸ªé¡µè¡¨ï¼Œé¡µè¡¨ä¸­çš„è¡¨é¡¹ä¸ºåˆ›å»º512ä¸ªã€‚é¡µè¡¨å¤§å°ä¸€ä¸ªä¸º4Kï¼Œæ¯ä¸ªè¡¨é¡¹å 8å­—èŠ‚ã€‚</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pud_none</span><span class="p">(</span><span class="n">pud</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pudval_t</span><span class="w"> </span><span class="n">pudval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PUD_TYPE_TABLE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PUD_TABLE_UXN</span><span class="p">;</span>
<span class="w">        </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">pmd_phys</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">NO_EXEC_MAPPINGS</span><span class="p">)</span>
<span class="w">            </span><span class="n">pudval</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PUD_TABLE_PXN</span><span class="p">;</span>
<span class="w">        </span><span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pgtable_alloc</span><span class="p">);</span>
<span class="w">        </span><span class="n">pmd_phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgtable_alloc</span><span class="p">(</span><span class="n">PMD_SHIFT</span><span class="p">);</span>
<span class="w">        </span><span class="n">__pud_populate</span><span class="p">(</span><span class="n">pudp</span><span class="p">,</span><span class="w"> </span><span class="n">pmd_phys</span><span class="p">,</span><span class="w"> </span><span class="n">pudval</span><span class="p">);</span><span class="c1">//å°†PMDé¡µè¡¨çš„ç‰©ç†åœ°å€å¡«å……åˆ°æ˜ å°„åœ°å€å¯¹åº”çš„PUDï¼ˆå®é™…ä¸Šæ˜¯PGDï¼Œ3çº§é¡µè¡¨ï¼‰è¡¨é¡¹ä¸­</span>
<span class="w">        </span><span class="n">pud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">pudp</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">BUG_ON</span><span class="p">(</span><span class="n">pud_bad</span><span class="p">(</span><span class="n">pud</span><span class="p">));</span>

<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pgprot_t</span><span class="w"> </span><span class="n">__prot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prot</span><span class="p">;</span>

<span class="w">        </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pmd_cont_addr_end</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>
<span class="c1">//ä¸€ä¸ªPMD entryæ˜ å°„èŒƒå›´æ˜¯2Mï¼Œæ‰€ä»¥è®¡ç®—éœ€è¦å¤šå°‘ä¸ªentryã€‚ä½†æ˜¯å¦‚æœæ˜¯è¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œinit_pmdä¸æ˜¯åªåˆå§‹åŒ–ä¸€ä¸ªentryï¼Œè€Œæ˜¯ä¸€ä¸‹åˆå§‹åŒ–å¤šä¸ªentryï¼Œå¤šå°‘ä¸ªentryç”±CONT_PMDSã€‚æ‰€ä»¥è¿™é‡Œçš„åœ°å€èŒƒå›´nextçš„è·ç¦»å°†æ˜¯CONT_PMDS*PMD_SIZEã€‚</span>

<span class="w">        </span><span class="cm">/* use a contiguous mapping if the range is suitably aligned */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((((</span><span class="n">addr</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">phys</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">CONT_PMD_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">NO_CONT_MAPPINGS</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">__prot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__pgprot</span><span class="p">(</span><span class="n">pgprot_val</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_CONT</span><span class="p">);</span>

<span class="w">        </span><span class="n">init_pmd</span><span class="p">(</span><span class="n">pudp</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">__prot</span><span class="p">,</span><span class="w"> </span><span class="n">pgtable_alloc</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//åˆå§‹åŒ–PMDé¡µè¡¨ï¼Œåˆ›å»ºä¸‹ä¸€çº§é¡µè¡¨ï¼ŒåŒæ—¶å°†å…¶ç‰©ç†åœ°å€å¡«å……åˆ°è¡¨é¡¹ä¸­ã€‚</span>
<span class="w">        </span><span class="n">phys</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="init_pmd">init_pmd</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init_pmd</span><span class="p">(</span><span class="n">pud_t</span><span class="w"> </span><span class="o">*</span><span class="n">pudp</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">end</span><span class="p">,</span>
<span class="w">             </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">pgprot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span>
<span class="w">             </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pgtable_alloc</span><span class="p">)(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="n">pmd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pmdp</span><span class="p">;</span>

<span class="n">pmdp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pmd_set_fixmap_offset</span><span class="p">(</span><span class="n">pudp</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
<span class="c1">//è·å–æ˜ å°„åœ°å€addrå¯¹åº”PMDé¡µè¡¨é¡¹çš„åœ°å€ï¼ˆè™šæ‹Ÿåœ°å€ï¼‰ï¼Œå…¶åœ°å€èŒƒå›´åœ¨FIX_PMDä¸­ï¼Œå› ä¸ºè®¿é—®ç‰©ç†å†…å­˜ä¹Ÿéœ€è¦æŸ¥è¯¢é¡µè¡¨ï¼Œé‚£å°±å°†å…¶ç‰©ç†åœ°å€æ˜ å°„åˆ°FIXMAPèŒƒå›´ï¼Œå°±å¯ä»¥è¿›è¡Œç›´æ¥è®¿é—®è™šæ‹Ÿåœ°å€äº†ã€‚</span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pmd_t</span><span class="w"> </span><span class="n">old_pmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">pmdp</span><span class="p">);</span><span class="c1">//éå†PMDè¡¨é¡¹ï¼Œ</span>

<span class="w">        </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pmd_addr_end</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>
<span class="w">       </span><span class="c1">//æ¯ä¸ªPMDçš„æ˜ å°„èŒƒå›´æ˜¯2Mï¼Œéå†éœ€è¦å¤šå°‘ä¸ªPTEã€‚</span>
<span class="w">        </span><span class="cm">/* try section mapping first */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="n">addr</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">phys</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">PMD_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">NO_BLOCK_MAPPINGS</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pmd_set_huge</span><span class="p">(</span><span class="n">pmdp</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">);</span>

<span class="w">            </span><span class="cm">/*</span>
<span class="cm">             * After the PMD entry has been populated once, we</span>
<span class="cm">             * only allow updates to the permission attributes.</span>
<span class="cm">             */</span>
<span class="w">            </span><span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pgattr_change_is_safe</span><span class="p">(</span><span class="n">pmd_val</span><span class="p">(</span><span class="n">old_pmd</span><span class="p">),</span>
<span class="w">                              </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">pmd_val</span><span class="p">(</span><span class="o">*</span><span class="n">pmdp</span><span class="p">))));</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">alloc_init_cont_pte</span><span class="p">(</span><span class="n">pmdp</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span>
<span class="w">                        </span><span class="n">pgtable_alloc</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>

<span class="w">            </span><span class="n">BUG_ON</span><span class="p">(</span><span class="n">pmd_val</span><span class="p">(</span><span class="n">old_pmd</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                   </span><span class="n">pmd_val</span><span class="p">(</span><span class="n">old_pmd</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">pmd_val</span><span class="p">(</span><span class="o">*</span><span class="n">pmdp</span><span class="p">)));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">phys</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">pmdp</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>

<span class="w">    </span><span class="n">pmd_clear_fixmap</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">alloc_init_cont_pte</span><span class="p">(</span><span class="n">pmd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pmdp</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span>
<span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span>
<span class="w">                </span><span class="n">pgprot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span>
<span class="w">                </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pgtable_alloc</span><span class="p">)(</span><span class="kt">int</span><span class="p">),</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="n">pmd_t</span><span class="w"> </span><span class="n">pmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">pmdp</span><span class="p">);</span><span class="c1">//è·å¾—PTEæ˜ å°„è¡¨çš„å¤´åœ°å€</span>

<span class="w">    </span><span class="n">BUG_ON</span><span class="p">(</span><span class="n">pmd_sect</span><span class="p">(</span><span class="n">pmd</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pmd_none</span><span class="p">(</span><span class="n">pmd</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="c1">//å¦‚æœæ²¡æœ‰è¯¥è¡¨åˆ™åˆ›å»ºä¸€ä¸ª</span>
<span class="w">        </span><span class="n">pmdval_t</span><span class="w"> </span><span class="n">pmdval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PMD_TYPE_TABLE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PMD_TABLE_UXN</span><span class="p">;</span>
<span class="w">        </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">pte_phys</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">NO_EXEC_MAPPINGS</span><span class="p">)</span>
<span class="w">            </span><span class="n">pmdval</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PMD_TABLE_PXN</span><span class="p">;</span>
<span class="w">        </span><span class="n">pte_phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgtable_alloc</span><span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="p">);</span>
<span class="w">        </span><span class="n">__pmd_populate</span><span class="p">(</span><span class="n">pmdp</span><span class="p">,</span><span class="w"> </span><span class="n">pte_phys</span><span class="p">,</span><span class="w"> </span><span class="n">pmdval</span><span class="p">);</span>
<span class="w">        </span><span class="n">pmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">pmdp</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pgprot_t</span><span class="w"> </span><span class="n">__prot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prot</span><span class="p">;</span>

<span class="w">        </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pte_cont_addr_end</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>
<span class="c1">//ä¸€ä¸ªPTE entryæ˜ å°„èŒƒå›´æ˜¯4Kï¼Œæ‰€ä»¥è®¡ç®—éœ€è¦å¤šå°‘ä¸ªentryã€‚ä½†æ˜¯å¦‚æœæ˜¯è¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œinit_pmdä¸æ˜¯åªåˆå§‹åŒ–ä¸€ä¸ªentryï¼Œè€Œæ˜¯ä¸€ä¸‹åˆå§‹åŒ–å¤šä¸ªentryï¼Œå¤šå°‘ä¸ªentryç”±CONT_PTESã€‚æ‰€ä»¥è¿™é‡Œçš„åœ°å€èŒƒå›´nextçš„è·ç¦»å°†æ˜¯CONT_PTES*PTE_SIZEã€‚</span>

<span class="w">        </span><span class="cm">/* use a contiguous mapping if the range is suitably aligned */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((((</span><span class="n">addr</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">phys</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">CONT_PTE_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">NO_CONT_MAPPINGS</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">__prot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__pgprot</span><span class="p">(</span><span class="n">pgprot_val</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_CONT</span><span class="p">);</span>

<span class="w">        </span><span class="n">init_pte</span><span class="p">(</span><span class="n">pmdp</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">__prot</span><span class="p">);</span><span class="c1">//åˆå§‹åŒ–æ¯ä¸€ä¸ªPTEçš„è¡¨é¡¹è®°å½•ï¼Œå¯¹åº”ç‰©ç†é¡µå¸§</span>

<span class="w">        </span><span class="n">phys</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="init_pte">init_pte</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init_pte</span><span class="p">(</span><span class="n">pmd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pmdp</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">end</span><span class="p">,</span>
<span class="w">             </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">pgprot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">ptep</span><span class="p">;</span>

<span class="w">    </span><span class="n">ptep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pte_set_fixmap_offset</span><span class="p">(</span><span class="n">pmdp</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span><span class="c1">//æ ¹æ®addræ‰¾åˆ°å¯¹åº”çš„PTE Entryä½ç½®</span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pte_t</span><span class="w"> </span><span class="n">old_pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">ptep</span><span class="p">);</span>
<span class="c1">//è¯»è¿™ä¸ªentryçš„å€¼ï¼Œä¸€èˆ¬æ¥è¯´æ–°å»ºçš„entryæ˜¯æ²¡æœ‰validçš„å€¼çš„</span>

<span class="w">        </span><span class="n">set_pte</span><span class="p">(</span><span class="n">ptep</span><span class="p">,</span><span class="w"> </span><span class="n">pfn_pte</span><span class="p">(</span><span class="n">__phys_to_pfn</span><span class="p">(</span><span class="n">phys</span><span class="p">),</span><span class="w"> </span><span class="n">prot</span><span class="p">));</span>
<span class="w">        </span><span class="c1">//å°†ç‰©ç†åœ°å€è½¬æ¢ä¸ºé¡µå¸§ï¼Œç„¶åå†™å…¥PTE</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * After the PTE entry has been populated once, we</span>
<span class="cm">         * only allow updates to the permission attributes.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pgattr_change_is_safe</span><span class="p">(</span><span class="n">pte_val</span><span class="p">(</span><span class="n">old_pte</span><span class="p">),</span>
<span class="w">                          </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">pte_val</span><span class="p">(</span><span class="o">*</span><span class="n">ptep</span><span class="p">))));</span>

<span class="w">        </span><span class="n">phys</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ptep</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>

<span class="w">    </span><span class="n">pte_clear_fixmap</span><span class="p">();</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
<h4 id="debug">å†…æ ¸debugæ—¥å¿—</h4>
<div class="codehilite"><pre><span></span><code><span class="n">å†…æ ¸debugæ—¥å¿—</span>

<span class="nl">map_kernel_segment</span><span class="p">:</span><span class="n">pgdp</span><span class="o">:</span><span class="n">fffffffdfda36000</span><span class="p">,[</span><span class="n">va_start</span><span class="o">:</span><span class="n">ffffffc008a30000</span><span class="p">,</span><span class="n">va_end</span><span class="o">:</span><span class="n">ffffffc008d70000</span><span class="p">]</span><span class="w"> </span><span class="n">paging_init</span><span class="o">+</span><span class="mh">0x14c</span><span class="o">/</span><span class="mh">0x524</span>
<span class="nl">__create_pgd_mapping</span><span class="p">:</span><span class="n">pgdp</span><span class="o">:</span><span class="mh">0xfffffffdfda36800</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">pgd_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">alloc_init_pud</span><span class="p">,</span><span class="mi">333</span><span class="o">:</span><span class="w"> </span><span class="n">pgdp</span><span class="o">:</span><span class="mh">0xfffffffdfda36800</span><span class="p">,</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">alloc_init_cont_pmd</span><span class="p">,</span><span class="mi">274</span><span class="o">:</span><span class="w"> </span><span class="n">pudp</span><span class="o">:</span><span class="mh">0xfffffffdfda36800</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">pud_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pmd</span><span class="p">,</span><span class="mi">235</span><span class="o">:</span><span class="w"> </span><span class="n">pmdp</span><span class="o">:</span><span class="mh">0xfffffffdfda38228</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">pmd_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="o">:</span><span class="mh">0xffffffc008a30000</span><span class="p">,</span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008d70000</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">alloc_init_cont_pte</span><span class="p">,</span><span class="mi">193</span><span class="o">:</span><span class="w"> </span><span class="n">pmdp</span><span class="o">:</span><span class="mh">0xfffffffdfda38228</span><span class="p">,</span><span class="n">addr</span><span class="o">:</span><span class="mh">0xffffffc008a30000</span><span class="p">,</span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008c00000</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39200</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008a40000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39280</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008a50000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39300</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008a60000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39380</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008a70000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39400</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008a80000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39480</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008a90000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39500</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008aa0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39580</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008ab0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39600</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008ac0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39680</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008ad0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39700</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008ae0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39780</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008af0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39800</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008b00000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39880</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008b10000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39900</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008b20000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39980</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008b30000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39a00</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008b40000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39a80</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008b50000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39b00</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008b60000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39b80</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008b70000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39c00</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008b80000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39c80</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008b90000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39d00</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008ba0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39d80</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008bb0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39e00</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008bc0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39e80</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008bd0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39f00</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008be0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39f80</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008bf0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda3a000</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008c00000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">alloc_init_cont_pte</span><span class="p">,</span><span class="mi">193</span><span class="o">:</span><span class="w"> </span><span class="n">pmdp</span><span class="o">:</span><span class="mh">0xfffffffdfda38230</span><span class="p">,</span><span class="n">addr</span><span class="o">:</span><span class="mh">0xffffffc008c00000</span><span class="p">,</span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008d70000</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="nl">memblock_reserve</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mh">0x00000000bfffc000-0x00000000bfffcfff</span><span class="p">]</span><span class="w"> </span><span class="n">memblock_alloc_range_nid</span><span class="o">+</span><span class="mh">0xec</span><span class="o">/</span><span class="mh">0x154</span>
<span class="nl">memblock_add_range</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mh">0x00000000bfffc000</span><span class="p">]</span><span class="w"> </span><span class="n">memblock_reserve</span><span class="o">+</span><span class="mh">0xac</span><span class="o">/</span><span class="mh">0x160</span>
<span class="nl">memblock_insert_region</span><span class="p">:</span><span class="n">name</span><span class="o">:</span><span class="n">reserved</span><span class="w"> </span><span class="p">[</span><span class="mh">0x00000000bfffc000</span><span class="p">]</span><span class="w"> </span><span class="n">size</span><span class="o">:</span><span class="mi">1000</span><span class="p">,</span><span class="n">memblock_add_range</span><span class="p">.</span><span class="n">constprop</span><span class="mf">.0</span><span class="p">.</span><span class="n">isra</span><span class="mf">.0</span><span class="o">+</span><span class="mh">0x19c</span><span class="o">/</span><span class="mh">0x214</span>
<span class="n">alloc_init_cont_pte</span><span class="p">,</span><span class="mi">204</span><span class="o">:</span><span class="w"> </span><span class="n">pte_phys</span><span class="o">:</span><span class="mh">0xbfffc000</span><span class="p">,</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39080</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008c10000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39100</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008c20000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39180</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008c30000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39200</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008c40000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39280</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008c50000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39300</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008c60000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39380</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008c70000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39400</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008c80000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39480</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008c90000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39500</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008ca0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39580</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008cb0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39600</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008cc0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39680</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008cd0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39700</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008ce0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39780</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008cf0000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39800</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008d00000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39880</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008d10000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39900</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008d20000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39980</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008d30000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39a00</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008d40000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39a80</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008d50000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39b00</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008d60000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
<span class="n">init_pte</span><span class="p">,</span><span class="mi">179</span><span class="o">:</span><span class="w"> </span><span class="n">ptep</span><span class="o">:</span><span class="mh">0xfffffffdfda39b80</span><span class="p">,</span><span class="n">size</span><span class="w"> </span><span class="n">pte_t</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">:</span><span class="mh">0xffffffc008d70000</span><span class="p">,</span><span class="n">number</span><span class="o">:</span><span class="mi">16</span><span class="w"> </span><span class="n">map_kernel_segment</span><span class="o">+</span><span class="mh">0xf4</span><span class="o">/</span><span class="mh">0x160</span>
</code></pre></div>
<p>numberè¡¨ç¤ºåœ¨å‡½æ•°ä¸­è°ƒç”¨ä¸€æ¬¡init_pteè°ƒç”¨set_pteçš„æ­¤æ¬¡ï¼Œä¸º16æ¬¡ã€‚</p>
<h2 id="bootmem_init">bootmem_init</h2>
<p>å®Œæˆäº†linuxç‰©ç†å†…å­˜æ¡†æ¶çš„åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬Node, Zone, Page Frameä»¥åŠå¯¹åº”çš„æ•°æ®ç»“æ„ç­‰ã€‚</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_3dc9de3996ef2284d9b13d36376b4fe1.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_3dc9de3996ef2284d9b13d36376b4fe1.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">bootmem_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">;</span>

<span class="w">    </span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PFN_UP</span><span class="p">(</span><span class="n">memblock_start_of_DRAM</span><span class="p">());</span>
<span class="w">    </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">memblock_end_of_DRAM</span><span class="p">());</span>

<span class="w">    </span><span class="n">early_memtest</span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">);</span>

<span class="w">    </span><span class="n">max_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_low_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">;</span>
<span class="w">    </span><span class="n">min_low_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">;</span>

<span class="w">    </span><span class="n">arch_numa_init</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * must be done after arch_numa_init() which calls numa_init() to</span>
<span class="cm">     * initialize node_online_map that gets used in hugetlb_cma_reserve()</span>
<span class="cm">     * while allocating required CMA size across online nodes.</span>
<span class="cm">     */</span>
<span class="cp">#if defined(CONFIG_HUGETLB_PAGE) &amp;&amp; defined(CONFIG_CMA)</span>
<span class="w">    </span><span class="n">arm64_hugetlb_cma_reserve</span><span class="p">();</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">dma_pernuma_cma_reserve</span><span class="p">();</span>

<span class="w">    </span><span class="n">kvm_hyp_reserve</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * sparse_init() tries to allocate memory from memblock, so must be</span>
<span class="cm">     * done after the fixed reservations</span>
<span class="cm">     */</span>
<span class="n">sparse_init</span><span class="p">();</span>

<span class="w">    </span><span class="n">zone_sizes_init</span><span class="p">(</span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Reserve the CMA area after arm64_dma_phys_limit was initialised.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">dma_contiguous_reserve</span><span class="p">(</span><span class="n">arm64_dma_phys_limit</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * request_standard_resources() depends on crashkernel\'s memory being</span>
<span class="cm">     * reserved, so do it here.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_ZONE_DMA</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_ZONE_DMA32</span><span class="p">))</span>
<span class="w">        </span><span class="n">reserve_crashkernel</span><span class="p">();</span>

<span class="w">    </span><span class="n">memblock_dump_all</span><span class="p">();</span>
</code></pre></div>
<h3 id="sparse_init">sparse_init</h3>
<p>Linuxå†…æ ¸ä½¿ç”¨é€šå¸¸æœ‰ä¸‰ç§å†…å­˜æ¨¡å‹ï¼Œå‰é¢ä¸¤ç§åŸºæœ¬ä¸å†ä½¿ç”¨ï¼Œç›®å‰å¸¸ç”¨çš„å°±æ˜¯Sparse memory modelï¼Œsparse initå°±æ˜¯å¯¹è¯¥æ¨¡å‹çš„åˆå§‹åŒ–ï¼Œä¸»è¦çš„ç›®çš„å°±æ˜¯å°†memblock.memoryæ·»åŠ åˆ°struct mem_sectionè¿›è¡Œç®¡ç†ã€‚</p>
<h4 id="memory_present">memory_present</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">memblocks_present</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">nid</span><span class="p">;</span>

<span class="w">    </span><span class="n">for_each_mem_pfn_range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_NUMNODES</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nid</span><span class="p">)</span>
<span class="w">        </span><span class="n">memory_present</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//ä»memblock.memoryè¿›è¡Œéå†å¯ç”¨å†…å­˜ï¼Œæ¯å—memoryè¿”å›çš„æ˜¯PFNçš„èŒƒå›´start~endï¼Œæ¯ä¸ªPFNå¤§å°4KBã€‚</span>
<span class="p">}</span>

<span class="cm">/* Record a memory area against a node. */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">memory_present</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">nid</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pfn</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SPARSEMEM_EXTREME</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mem_section</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">;</span>

<span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mem_section</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">NR_SECTION_ROOTS</span><span class="p">;</span>
<span class="w">        </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">INTERNODE_CACHE_SHIFT</span><span class="p">);</span>
<span class="w">        </span><span class="n">mem_section</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblock_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//åˆ†é…NR_SECTION_ROOTSä¸ªæ•°ç»„æŒ‡é’ˆï¼Œç”¨äºæŒ‡å‘struct mem_sectionçš„å®ä¾‹ã€‚</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mem_section</span><span class="p">)</span>
<span class="w">            </span><span class="n">panic</span><span class="p">(</span><span class="err">\</span><span class="s">"%s: Failed to allocate %lu bytes align=0x%lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,</span>
<span class="w">                  </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">start</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="n">PAGE_SECTION_MASK</span><span class="p">;</span>
<span class="w">    </span><span class="n">mminit_validate_memmodel_limits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">end</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"> </span><span class="n">pfn</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"> </span><span class="n">pfn</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PAGES_PER_SECTION</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pfn_to_section_nr</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">mem_section</span><span class="w"> </span><span class="o">*</span><span class="n">ms</span><span class="p">;</span>

<span class="w">        </span><span class="n">sparse_index_init</span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="w"> </span><span class="n">nid</span><span class="p">);</span>
<span class="w">           </span><span class="o">-&gt;</span><span class="n">section</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sparse_index_alloc</span><span class="p">(</span><span class="n">nid</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//ä¸ºå­˜åœ¨çš„mem_sectionåˆ†é…ä¸€ä¸ªå®ä¾‹,å¹¶æ·»åŠ åˆ°mem_sctionä¸­ã€‚</span>
<span class="w">        </span><span class="n">set_section_nid</span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="w"> </span><span class="n">nid</span><span class="p">);</span>

<span class="w">        </span><span class="n">ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__nr_to_section</span><span class="p">(</span><span class="n">section</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//è·å–è¯¥sectionçš„æŒ‡é’ˆ</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">section_mem_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">section_mem_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sparse_encode_early_nid</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="w">                            </span><span class="n">SECTION_IS_ONLINE</span><span class="p">;</span>
<span class="w">            </span><span class="n">__section_mark_present</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="n">section</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//è®¾ç½®è¯¥sectionçš„onlineæ ‡å¿—å’Œnode idå€¼</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_de4b23f4cb7caf0de027860f16b8ab25.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_de4b23f4cb7caf0de027860f16b8ab25.jpg"/></a></p>
<p>ç‰©ç†å†…å­˜ç©ºé—´æŒ‰ç…§secitonæ¥ç»„ç»‡çš„ï¼Œæ¯ä¸ªsectionå†…éƒ¨å…¶memoryæ˜¯è¿ç»­çš„ã€‚ä¸€ä¸ªsectionåŒ…å«å¤šä¸ªpageï¼Œåœ¨å†…æ ¸ä¸­ç”±PAGES_PER_SECTIONæ¥å†³å®šï¼Œlinux 5.15å†…æ ¸3çº§é¡µè¡¨ä¸­ä¸º32768ï¼Œå› æ­¤å†…å­˜çš„èŒƒå›´æ˜¯32768*4KB=128MBï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªsectionæœ€å¤§çš„å†…å­˜èŒƒå›´æ˜¯128MBã€‚</p>
<p>PFNæ‰¾åˆ°å¯¹åº”çš„pageï¼Œå¯ä»¥é€šè¿‡PFN-&gt;section-&gt;pageã€‚ pageæ‰¾åˆ°PFNï¼Œpage-&gt;section index-&gt;memory_section-&gt;section_mem_map-&gt;PFN</p>
<h4 id="sparse_init_nid">sparse_init_nid</h4>
<p>å†…å­˜æ·»åŠ åˆ°mem_sectionåï¼Œå°±è¿›è¡Œéå†presentçš„sectionï¼Œç„¶åä¸ºå…¶åˆ†é…å¯¹åº”çš„sectionç»“æ„ä»¥åŠå¯¹åº”çš„struct pageç»“æ„ä½“ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">for_each_present_section_nr</span><span class="p">(</span><span class="n">pnum_begin</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">pnum_end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sparse_early_nid</span><span class="p">(</span><span class="n">__nr_to_section</span><span class="p">(</span><span class="n">pnum_end</span><span class="p">));</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nid_begin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">map_count</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="cm">/* Init node with sections in range [pnum_begin, pnum_end) */</span>
<span class="w">        </span><span class="n">sparse_init_nid</span><span class="p">(</span><span class="n">nid_begin</span><span class="p">,</span><span class="w"> </span><span class="n">pnum_begin</span><span class="p">,</span><span class="w"> </span><span class="n">pnum_end</span><span class="p">,</span><span class="w"> </span><span class="n">map_count</span><span class="p">);</span>
<span class="w">        </span><span class="n">nid_begin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nid</span><span class="p">;</span>
<span class="w">        </span><span class="n">pnum_begin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pnum_end</span><span class="p">;</span>
<span class="w">        </span><span class="n">map_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w">              </span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">sparse_init_nid</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">nid</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pnum_begin</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pnum_end</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">map_count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mem_section_usage</span><span class="w"> </span><span class="o">*</span><span class="n">usage</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pnum</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//ï¼ˆ1ï¼‰ä¸ºmem_sectionä¸­çš„mem_section_usageåˆ†é…å†…å­˜ï¼Œç”¨äºå­˜å‚¨å†…å­˜æ®µçš„ä½¿ç”¨æƒ…å†µ</span>
<span class="w">    </span><span class="n">usage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sparse_early_usemaps_alloc_pgdat_section</span><span class="p">(</span><span class="n">NODE_DATA</span><span class="p">(</span><span class="n">nid</span><span class="p">),</span>
<span class="w">            </span><span class="n">mem_section_usage_size</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">map_count</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">usage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_err</span><span class="p">(</span><span class="err">\</span><span class="s">"%s: node[%d] usemap allocation failed</span><span class="se">\"</span><span class="s">, __func__, nid);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//ï¼ˆ2ï¼‰ä¸ºstruct pageç»“æ„ä½“åˆ†é…å†…å­˜ï¼Œä¸€ä¸ªsectionæœ€å¤§æŒ‡å‘128MBçš„ç©ºé—´ï¼Œå°†åˆ†é…128*1024/4ä¸ªæ•°é‡ã€‚</span>
<span class="w">    </span><span class="n">sparse_buffer_init</span><span class="p">(</span><span class="n">map_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">section_map_size</span><span class="p">(),</span><span class="w"> </span><span class="n">nid</span><span class="p">);</span>
<span class="w">    </span><span class="n">for_each_present_section_nr</span><span class="p">(</span><span class="n">pnum_begin</span><span class="p">,</span><span class="w"> </span><span class="n">pnum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">section_nr_to_pfn</span><span class="p">(</span><span class="n">pnum</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pnum</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">pnum_end</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__populate_section_memmap</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span><span class="w"> </span><span class="n">PAGES_PER_SECTION</span><span class="p">,</span>
<span class="w">                </span><span class="n">nid</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//è·å–è¯¥sectionå¯¹åº”çš„page ç»“æ„ä½“åœ°å€ï¼Œå¦‚æœä½¿èƒ½äº†vmemmapæ¨¡å‹ï¼Œåˆ™åœ°å€èŒƒå›´åœ¨vmememapåŒºåŸŸä¸­ï¼Œéœ€è¦å»ºç«‹vmmemapåˆ°page frameçš„é¡µè¡¨ã€‚</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pr_err</span><span class="p">(</span><span class="err">\</span><span class="s">"%s: node[%d] memory map backing failed. Some memory will not be available.</span><span class="se">\"</span><span class="s">,</span>
<span class="w">                   </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">nid</span><span class="p">);</span>
<span class="w">            </span><span class="n">pnum_begin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pnum</span><span class="p">;</span>
<span class="w">            </span><span class="n">sparse_buffer_fini</span><span class="p">();</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">check_usemap_section_nr</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span><span class="w"> </span><span class="n">usage</span><span class="p">);</span>
<span class="w">        </span><span class="n">sparse_init_one_section</span><span class="p">(</span><span class="n">__nr_to_section</span><span class="p">(</span><span class="n">pnum</span><span class="p">),</span><span class="w"> </span><span class="n">pnum</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">usage</span><span class="p">,</span>
<span class="w">                </span><span class="n">SECTION_IS_EARLY</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//è®¾ç½®sectionå¯¹åº”çš„pageç»“æ„ä½“æŒ‡é’ˆåŠå…¶æ ‡å¿—</span>
<span class="w">        </span><span class="n">usage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">usage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mem_section_usage_size</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">sparse_buffer_fini</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="nl">failed</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/* We failed to allocate, mark all the following pnums as not present */</span>
<span class="w">    </span><span class="n">for_each_present_section_nr</span><span class="p">(</span><span class="n">pnum_begin</span><span class="p">,</span><span class="w"> </span><span class="n">pnum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">mem_section</span><span class="w"> </span><span class="o">*</span><span class="n">ms</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pnum</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">pnum_end</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="n">ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__nr_to_section</span><span class="p">(</span><span class="n">pnum</span><span class="p">);</span>
<span class="w">        </span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">section_mem_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
<p>è™šæ‹Ÿåœ°å€ç©ºé—´vmmepmapåŒºåŸŸï¼Œæ˜¯å†…æ ¸ä¸­pageæ•°æ®çš„è™šæ‹Ÿåœ°å€ï¼Œé’ˆå¯¹sparseå†…å­˜æ¨¡å‹ï¼Œå†…æ ¸ç”³è¯·çš„pageè¿”å›çš„åœ°å€åœ¨è¯¥åŒºåŸŸã€‚</p>
<h3 id="zone_sizes_init">zone_sizes_init</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">zone_sizes_init</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">max_zone_pfns</span><span class="p">[</span><span class="n">MAX_NR_ZONES</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__maybe_unused</span><span class="w"> </span><span class="n">acpi_zone_dma_bits</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__maybe_unused</span><span class="w"> </span><span class="n">dt_zone_dma_bits</span><span class="p">;</span>
<span class="n">phys_addr_t</span><span class="w"> </span><span class="n">__maybe_unused</span><span class="w"> </span><span class="n">dma32_phys_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_zone_phys</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ZONE_DMA</span>
<span class="w">    </span><span class="n">acpi_zone_dma_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fls64</span><span class="p">(</span><span class="n">acpi_iort_dma_get_max_cpu_address</span><span class="p">());</span>
<span class="w">    </span><span class="n">dt_zone_dma_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fls64</span><span class="p">(</span><span class="n">of_dma_get_max_cpu_address</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">    </span><span class="n">zone_dma_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min3</span><span class="p">(</span><span class="mi">32U</span><span class="p">,</span><span class="w"> </span><span class="n">dt_zone_dma_bits</span><span class="p">,</span><span class="w"> </span><span class="n">acpi_zone_dma_bits</span><span class="p">);</span>
<span class="w">    </span><span class="n">arm64_dma_phys_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_zone_phys</span><span class="p">(</span><span class="n">zone_dma_bits</span><span class="p">);</span>
<span class="n">max_zone_pfns</span><span class="p">[</span><span class="n">ZONE_DMA</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">arm64_dma_phys_limit</span><span class="p">);</span>
<span class="c1">//è·Ÿè¿›å®é™…ç‰©ç†å†…å­˜è®¡ç®—ZONE_DMAåŒºçš„æœ€å¤§PFNæ•°é‡</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_ZONE_DMA32</span>
<span class="n">max_zone_pfns</span><span class="p">[</span><span class="n">ZONE_DMA32</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disable_dma32</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">dma32_phys_limit</span><span class="p">);</span>
<span class="c1">//è®¡ç®—ZONE_DMA_32åŒºçš„æœ€å¤§PFNæ•°é‡</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">arm64_dma_phys_limit</span><span class="p">)</span>
<span class="w">        </span><span class="n">arm64_dma_phys_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma32_phys_limit</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">max_zone_pfns</span><span class="p">[</span><span class="n">ZONE_NORMAL</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">;</span>
<span class="c1">//è®¡ç®—ZONE_NORMALåŒºçš„æœ€å¤§PFNæ•°é‡</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="err">\</span><span class="s">"%s,%d:dma:%lu, dma32:%lu, Normal:%lu %pS</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">, __func__,__LINE__,</span>
<span class="w">        </span><span class="n">max_zone_pfns</span><span class="p">[</span><span class="n">ZONE_DMA</span><span class="p">],</span><span class="w"> </span><span class="n">max_zone_pfns</span><span class="p">[</span><span class="n">ZONE_DMA32</span><span class="p">],</span><span class="w"> </span><span class="n">max_zone_pfns</span><span class="p">[</span><span class="n">ZONE_NORMAL</span><span class="p">],(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">_RET_IP_</span><span class="p">);</span>
<span class="n">free_area_init</span><span class="p">(</span><span class="n">max_zone_pfns</span><span class="p">);</span>
<span class="c1">//åˆå§‹åŒ–nodeå’Œzoneä¿¡æ¯ï¼Œä»¥åŠpageç»“æ„ä½“ã€‚</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="free_area_init">free_area_init</h5>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">free_area_init</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">max_zone_pfn</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start_pfn</span><span class="p">,</span><span class="w"> </span><span class="n">end_pfn</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">nid</span><span class="p">,</span><span class="w"> </span><span class="n">zone</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">descending</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Record where the zone boundaries are */</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">arch_zone_lowest_possible_pfn</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                </span><span class="k">sizeof</span><span class="p">(</span><span class="n">arch_zone_lowest_possible_pfn</span><span class="p">));</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">arch_zone_highest_possible_pfn</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                </span><span class="k">sizeof</span><span class="p">(</span><span class="n">arch_zone_highest_possible_pfn</span><span class="p">));</span>

<span class="w">    </span><span class="n">start_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_min_pfn_with_active_regions</span><span class="p">();</span>
<span class="w">    </span><span class="n">descending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arch_has_descending_max_zone_pfns</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_NR_ZONES</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">descending</span><span class="p">)</span>
<span class="w">            </span><span class="n">zone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_NR_ZONES</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">zone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zone</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ZONE_MOVABLE</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">         </span><span class="c1">//ZONE_MOVABLEæ˜¯ä¸€ä¸ªè™šæ‹ŸZONEï¼Œå®é™…å†…å­˜ç©ºé—´ä¸æ˜¯ç‹¬ç«‹çš„ï¼Œå› æ­¤ä¸éœ€è¦åˆå§‹åŒ–</span>
<span class="w">        </span><span class="n">end_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">max_zone_pfn</span><span class="p">[</span><span class="n">zone</span><span class="p">],</span><span class="w"> </span><span class="n">start_pfn</span><span class="p">);</span>
<span class="w">        </span><span class="n">arch_zone_lowest_possible_pfn</span><span class="p">[</span><span class="n">zone</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start_pfn</span><span class="p">;</span>
<span class="w">        </span><span class="n">arch_zone_highest_possible_pfn</span><span class="p">[</span><span class="n">zone</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end_pfn</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//å¡«å……æ¯ä¸ªzoneçš„åœ°å€èŒƒå›´</span>
<span class="w">        </span><span class="n">start_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end_pfn</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* Find the PFNs that ZONE_MOVABLE begins at in each node */</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">zone_movable_pfn</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">zone_movable_pfn</span><span class="p">));</span>
<span class="n">find_zone_movable_pfns_for_nodes</span><span class="p">();</span>
<span class="c1">//è·å–æ¯ä¸ªèŠ‚ç‚¹ä¸­ZONE_MOVABLE PFNs</span>

<span class="w">    </span><span class="cm">/* Print out the zone ranges */</span>
<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="err">\</span><span class="s">"Zone ranges:</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_NR_ZONES</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ZONE_MOVABLE</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="n">pr_info</span><span class="p">(</span><span class="err">\</span><span class="s">"  %-8s </span><span class="se">\"</span><span class="s">, zone_names[i]);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arch_zone_lowest_possible_pfn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span>
<span class="w">                </span><span class="n">arch_zone_highest_possible_pfn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="w">            </span><span class="n">pr_cont</span><span class="p">(</span><span class="err">\</span><span class="s">"empty</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">);</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">pr_cont</span><span class="p">(</span><span class="err">\</span><span class="s">"[mem %#018Lx-%#018Lx]</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,</span>
<span class="w">                </span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">arch_zone_lowest_possible_pfn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">                    </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">,</span>
<span class="w">                </span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">arch_zone_highest_possible_pfn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">                    </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="c1">//æ‰“å°æ¯ä¸ªZoneåŒºåŸŸçš„åœ°å€èŒƒå›´ã€‚</span>

<span class="w">    </span><span class="cm">/* Print out the PFNs ZONE_MOVABLE begins at in each node */</span>
<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="err">\</span><span class="s">"Movable zone start for each node</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_NUMNODES</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zone_movable_pfn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="w">            </span><span class="n">pr_info</span><span class="p">(</span><span class="err">\</span><span class="s">"  Node %d: %#018Lx</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">, i,</span>
<span class="w">                   </span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">zone_movable_pfn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//æ‰“å°æ¯ä¸ªèŠ‚ç‚¹ä¸­ZONE_MOVABLEåœ°å€èŒƒå›´</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Print out the early node map, and initialize the</span>
<span class="cm">     * subsection-map relative to active online memory ranges to</span>
<span class="cm">     * enable future \"sub-section\" extensions of the memory map.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="err">\</span><span class="s">"Early memory node ranges</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">);</span>
<span class="w">    </span><span class="n">for_each_mem_pfn_range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_NUMNODES</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">start_pfn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">end_pfn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_info</span><span class="p">(</span><span class="err">\</span><span class="s">"  node %3d: [mem %#018Lx-%#018Lx]</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">, nid,</span>
<span class="w">            </span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">start_pfn</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">,</span>
<span class="w">            </span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">end_pfn</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">subsection_map_init</span><span class="p">(</span><span class="n">start_pfn</span><span class="p">,</span><span class="w"> </span><span class="n">end_pfn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_pfn</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">//åˆå§‹åŒ–æ¯ä¸ªnodeï¼Œå®é™…ä¸ŠARM64ä¸Šé€šå¸¸åªæœ‰ä¸€ä¸ª</span>
<span class="w">    </span><span class="cm">/* Initialise every node */</span>
<span class="w">    </span><span class="n">mminit_verify_pageflags_layout</span><span class="p">();</span>
<span class="w">    </span><span class="n">setup_nr_node_ids</span><span class="p">();</span>
<span class="w">    </span><span class="n">for_each_online_node</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pg_data_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NODE_DATA</span><span class="p">(</span><span class="n">nid</span><span class="p">);</span>
<span class="w">        </span><span class="n">free_area_init_node</span><span class="p">(</span><span class="n">nid</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//åˆå§‹åŒ–nodeç›¸å…³ç»“æ„ä½“ä¸­pgdatå†…å®¹ï¼ŒåŒ…æ‹¬å„ä¸ªZONEåŒºåŸŸçš„spanned_pages,present_pages,memap_pagesï¼Œnr_kernel_pages,nr_all_pagesç­‰ç­‰</span>
<span class="w">        </span><span class="cm">/* Any memory on that node */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">node_present_pages</span><span class="p">)</span>
<span class="w">            </span><span class="n">node_set_state</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span><span class="w"> </span><span class="n">N_MEMORY</span><span class="p">);</span>
<span class="w">            </span><span class="c1">//å°†nodeçŠ¶æ€ä»N_ONLINEåˆ‡æ¢åˆ°N_MEMORYçŠ¶æ€</span>
<span class="w">        </span><span class="n">check_for_memory</span><span class="p">(</span><span class="n">pgdat</span><span class="p">,</span><span class="w"> </span><span class="n">nid</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="n">memmap_init</span><span class="p">();</span>
<span class="c1">//éå†memblockçš„regionï¼Œè·Ÿè¿›PFNæ‰¾åˆ°å¯¹åº”çš„struct pageï¼Œå¯¹è¯¥ç»“æ„ä½“è¿›è¡Œåˆå§‹åŒ–ï¼Œè®¾ç½®MIFRATE_MOVABLEæ ‡å¿—ç­‰ç­‰ã€‚</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="free_area_init_node">free_area_init_node</h5>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">free_area_init_node</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">pg_data_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NODE_DATA</span><span class="p">(</span><span class="n">nid</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">end_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* pg_data_t should be reset to zero when it\'s allocated */</span>
<span class="w">    </span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">nr_zones</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">kswapd_highest_zoneidx</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//è·å–è¯¥èŠ‚ç‚¹ä¸­PFNçš„èµ·å§‹å·å’Œç»“æŸå·</span>
<span class="w">    </span><span class="n">get_pfn_range_for_nid</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">start_pfn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">end_pfn</span><span class="p">);</span>

<span class="w">    </span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nid</span><span class="p">;</span>
<span class="w">    </span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">node_start_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start_pfn</span><span class="p">;</span><span class="w"> </span><span class="c1">//è®¾ç½®è¯¥èŠ‚ç‚¹çš„èµ·å§‹PFN</span>
<span class="w">    </span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">per_cpu_nodestats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="err">\</span><span class="s">"Initmem setup node %d [mem %#018Lx-%#018Lx]</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">, nid,</span>
<span class="w">        </span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">start_pfn</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">,</span>
<span class="w">        </span><span class="n">end_pfn</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">end_pfn</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">calculate_node_totalpages</span><span class="p">(</span><span class="n">pgdat</span><span class="p">,</span><span class="w"> </span><span class="n">start_pfn</span><span class="p">,</span><span class="w"> </span><span class="n">end_pfn</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//è®¡ç®—pgdatä¸­struct zoneæˆå‘˜ä¸­çš„spanned_pages,present_pagesç­‰å˜é‡å†…å®¹</span>
<span class="w">    </span><span class="n">alloc_node_mem_map</span><span class="p">(</span><span class="n">pgdat</span><span class="p">);</span>
<span class="w">    </span><span class="n">pgdat_set_deferred_range</span><span class="p">(</span><span class="n">pgdat</span><span class="p">);</span>

<span class="n">free_area_init_core</span><span class="p">(</span><span class="n">pgdat</span><span class="p">);</span>
<span class="c1">// è®¾ç½® zone dataç»“æ„ä½“ï¼ŒåŒ…æ‹¬è®¾ç½®å…¶æ‰€æœ‰çš„pages reservedï¼Œæ‰€æœ‰memory queuesæ˜¯ç©ºï¼Œæ¸…ç©ºmemory bitmapsç­‰ç­‰</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="free_area_init_core">free_area_init_core</h5>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">free_area_init_core</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pglist_data</span><span class="w"> </span><span class="o">*</span><span class="n">pgdat</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">zone_type</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">node_id</span><span class="p">;</span>

<span class="w">    </span><span class="n">pgdat_init_internals</span><span class="p">(</span><span class="n">pgdat</span><span class="p">);</span>
<span class="w">    </span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">per_cpu_nodestats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">boot_nodestats</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_NR_ZONES</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="o">*</span><span class="n">zone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">node_zones</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">freesize</span><span class="p">,</span><span class="w"> </span><span class="n">memmap_pages</span><span class="p">;</span>

<span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">spanned_pages</span><span class="p">;</span>
<span class="w">        </span><span class="n">freesize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">present_pages</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Adjust freesize so that it accounts for how much memory</span>
<span class="cm">         * is used by this zone for memmap. This affects the watermark</span>
<span class="cm">         * and per-cpu initialisations</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">memmap_pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calc_memmap_size</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">freesize</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">is_highmem_idx</span><span class="p">(</span><span class="n">j</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">freesize</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">memmap_pages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">freesize</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">memmap_pages</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memmap_pages</span><span class="p">)</span>
<span class="w">                    </span><span class="n">pr_debug</span><span class="p">(</span><span class="err">\</span><span class="s">"  %s zone: %lu pages used for memmap</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,</span>
<span class="w">                         </span><span class="n">zone_names</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">memmap_pages</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span>
<span class="w">                </span><span class="n">pr_warn</span><span class="p">(</span><span class="err">\</span><span class="s">"  %s zone: %lu memmap pages exceeds freesize %lu</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">,</span>
<span class="w">                    </span><span class="n">zone_names</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">memmap_pages</span><span class="p">,</span><span class="w"> </span><span class="n">freesize</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/* Account for reserved pages */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">freesize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">dma_reserve</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">freesize</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">dma_reserve</span><span class="p">;</span>
<span class="w">            </span><span class="n">pr_debug</span><span class="p">(</span><span class="err">\</span><span class="s">"  %s zone: %lu pages reserved</span><span class="se">\\</span><span class="s">n</span><span class="se">\"</span><span class="s">, zone_names[0], dma_reserve);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">is_highmem_idx</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
<span class="w">            </span><span class="n">nr_kernel_pages</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">freesize</span><span class="p">;</span>
<span class="w">        </span><span class="cm">/* Charge for highmem memmap if there are enough kernel pages */</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nr_kernel_pages</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">memmap_pages</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">            </span><span class="n">nr_kernel_pages</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">memmap_pages</span><span class="p">;</span>
<span class="w">        </span><span class="n">nr_all_pages</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">freesize</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Set an approximate value for lowmem here, it will be adjusted</span>
<span class="cm">         * when the bootmem allocator frees pages into the buddy system.</span>
<span class="cm">         * And all highmem pages will be managed by the buddy system.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">zone_init_internals</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">nid</span><span class="p">,</span><span class="w"> </span><span class="n">freesize</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="n">set_pageblock_order</span><span class="p">();</span>
<span class="w">        </span><span class="n">setup_usemap</span><span class="p">(</span><span class="n">zone</span><span class="p">);</span>
<span class="w">        </span><span class="n">init_currently_empty_zone</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span><span class="w"> </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">zone_start_pfn</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//åˆå§‹åŒ–ä¼™ä¼´ç³»ç»Ÿä¸­ä½¿ç”¨çš„free_area[]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="zone_init_free_lists">zone_init_free_lists</h5>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__meminit</span><span class="w"> </span><span class="nf">zone_init_free_lists</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="o">*</span><span class="n">zone</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="n">for_each_migratetype_order</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_area</span><span class="p">[</span><span class="n">order</span><span class="p">].</span><span class="n">free_list</span><span class="p">[</span><span class="n">t</span><span class="p">]);</span>
<span class="w">        </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_area</span><span class="p">[</span><span class="n">order</span><span class="p">].</span><span class="n">nr_free</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//åˆå§‹åŒ–free_area[]å¯¹åº”çš„é“¾è¡¨ã€‚</span>
<span class="c1">//for_each_migratetype_orderå¯ç”¨äºè¿­ä»£æŒ‡å®šè¿ç§»ç±»å‹çš„æ‰€æœ‰åˆ†é…é˜¶ï¼Œå…ˆéå†free_area[]ï¼Œå†éå†free_list[]</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="_5">å¯åŠ¨æ‰“å°ä¿¡æ¯</h5>
<div class="codehilite"><pre><span></span><code><span class="n">å¯åŠ¨æ‰“å°ä¿¡æ¯</span><span class="err">ã€‚</span>

<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">Zone</span><span class="w"> </span><span class="n">ranges</span><span class="o">:</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">   </span><span class="n">DMA</span><span class="w">      </span><span class="p">[</span><span class="n">mem</span><span class="w"> </span><span class="mh">0x0000000040000000-0x00000000bfffffff</span><span class="p">]</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">   </span><span class="n">DMA32</span><span class="w">    </span><span class="n">empty</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">   </span><span class="n">Normal</span><span class="w">   </span><span class="n">empty</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">Movable</span><span class="w"> </span><span class="n">zone</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">node</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">Early</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">ranges</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">   </span><span class="n">node</span><span class="w">   </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">mem</span><span class="w"> </span><span class="mh">0x0000000040000000-0x0000000041ffffff</span><span class="p">]</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">   </span><span class="n">node</span><span class="w">   </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">mem</span><span class="w"> </span><span class="mh">0x0000000042000000-0x000000004210ffff</span><span class="p">]</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">   </span><span class="n">node</span><span class="w">   </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">mem</span><span class="w"> </span><span class="mh">0x0000000042110000-0x00000000421fffff</span><span class="p">]</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">   </span><span class="n">node</span><span class="w">   </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">mem</span><span class="w"> </span><span class="mh">0x0000000042200000-0x0000000042243fff</span><span class="p">]</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">   </span><span class="n">node</span><span class="w">   </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">mem</span><span class="w"> </span><span class="mh">0x0000000042244000-0x00000000423fffff</span><span class="p">]</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">   </span><span class="n">node</span><span class="w">   </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">mem</span><span class="w"> </span><span class="mh">0x0000000042400000-0x0000000042443fff</span><span class="p">]</span>
<span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w">   </span><span class="n">node</span><span class="w">   </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">mem</span><span class="w"> </span><span class="mh">0x0000000042444000-0x00000000bfffffff</span><span class="p">]</span>
</code></pre></div>
<p>å†…æ ¸å¦‚ä½•ç›´åˆ°ç»™å®šçš„åˆ†é…å†…å­˜å±äºä½•ç§è¿ç§»ç±»å‹ï¼Ÿ å†…æ ¸æä¾›ä¸¤ä¸ªæ ‡å¿—ï¼Œåˆ†åˆ«ç”¨äºåˆ†é…å†…å­˜æ˜¯å¯ç§»åŠ¨çš„(__GFP_MOVABLE)æˆ–å¯å›æ”¶çš„(__GFP_RECATMABLE)ï¼Œå¦‚æœè¿™äº›æ ‡å¿—éƒ½æ²¡æœ‰è®¾ç½®ï¼Œåˆ™åˆ†é…çš„å†…å­˜å‡å®šä¸ºä¸å¯ç§»åŠ¨ã€‚</p>
<p>å¦‚ä½•åˆå§‹åŒ–å¯ç§»åŠ¨æ€§çš„åˆ†ç»„ï¼Ÿ</p>
<p><a href="https://www.laumy.tech//wp-content/uploads/2023/11/wp_editor_md_53db4a12d9ea1a1b1474f54fab1b6e53.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_53db4a12d9ea1a1b1474f54fab1b6e53.jpg"/></a></p>
<h2 id="build_all_zonelists">build_all_zonelists</h2>
<p><a href="https://www.laumy.tech//wp-content/uploads/2023/11/wp_editor_md_f3030335698a5e978b014bfb37c37d12.jpg"><img alt="" src="assets/doc/01-linux/å†…å­˜ç®¡ç†/å†…å­˜åˆå§‹åŒ–ä¹‹ç‰©ç†å†…å­˜åˆå§‹åŒ–ï¼ˆä¸€ï¼‰/images/wp_editor_md_f3030335698a5e978b014bfb37c37d12.jpg"/></a></p>
<p>ä¸»è¦æ˜¯ä¸ºnodeåˆ›å»ºä¸€ä¸ªå†…å­˜åˆ†é…æ—¶ä¼˜å…ˆçº§çš„é¡ºåºã€‚å°†ç³»ç»Ÿä¸­å„ä¸ªèŠ‚ç‚¹çš„å„ä¸ªzoneï¼ŒæŒ‰ç…§å¤‡é€‰èŠ‚ç‚¹çš„ä¼˜å…ˆçº§é¡ºåºä¾æ¬¡å¡«å†™åˆ°å¯¹åº”ç»“æ„ä½“æè¿°ç¬¦çš„struct zonelist node_zonelist[]æ•°ç»„ä¸­ã€‚æŸnodeçš„zonelistå¯ä»¥æŒ‰ä¸‹é¢çš„ä¼˜å…ˆçº§è¿›è¡Œèµ‹å€¼ï¼š</p>
<p>ï¼ˆ1ï¼‰å¯¹äºä¸åŒèŠ‚ç‚¹ï¼Œæœ¬åœ°nodeå†…å­˜æ”¾åœ¨zonelistçš„æœ€å‰é¢ï¼Œå…¶ä»–nodeçš„å†…å­˜æ ¹æ®å…¶ä¸æœ¬èŠ‚ç‚¹çš„distanceå€¼ä»å°åˆ°å¤§ä¾æ¬¡æ’åˆ—ã€‚</p>
<p>ï¼ˆ2ï¼‰å¯¹äºnodeå†…éƒ¨ä¸åŒçš„zoneä¹Ÿå­˜åœ¨ä¼˜å…ˆçº§å…³ç³»ï¼Œnormal zoneæ’åœ¨dma zoneçš„å‰é¢ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="ä¼™ä¼´ç³»ç»Ÿ.html">â† ä¼™ä¼´ç³»ç»Ÿ</a>
    <a class="next" href="å†…å­˜åˆå§‹åŒ–ä¹‹é¡µè¡¨åŸºæœ¬æ“ä½œ.html">å†…å­˜åˆå§‹åŒ–ä¹‹é¡µè¡¨åŸºæœ¬æ“ä½œ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

