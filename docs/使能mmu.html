<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ä½¿èƒ½MMU - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>ä½¿èƒ½MMU</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-07-07
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      risc-v
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><div class="codehilite"><pre><span></span><code><span class="n">â‘ </span><span class="w"> </span><span class="n">å¤šæ ¸æƒ…å†µä½¿èƒ½MMU</span>
<span class="p">.</span><span class="n">Lsecondary_start</span><span class="o">:</span>
<span class="cp">#ifdef CONFIG_SMP</span>
<span class="w">    </span><span class="cm">/* Set trap vector to spin forever to help debug */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">Lsecondary_park</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">CSR_STVEC</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span>

<span class="w">    </span><span class="n">slli</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">LGREG</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">__cpu_up_stack_pointer</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">__cpu_up_task_pointer</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * This hart didn\'t win the lottery, so we wait for the winning hart to</span>
<span class="cm">     * get far enough along the boot process that it should continue.</span>
<span class="cm">     */</span>
<span class="p">.</span><span class="n">Lwait_for_cpu_up</span><span class="o">:</span>
<span class="w">    </span><span class="cm">/* FIXME: We should WFI to save some energy here. */</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="w">    </span><span class="n">REG_L</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
<span class="w">    </span><span class="n">beqz</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">Lwait_for_cpu_up</span>
<span class="w">    </span><span class="n">beqz</span><span class="w"> </span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">Lwait_for_cpu_up</span>
<span class="w">    </span><span class="n">fence</span>

<span class="w">    </span><span class="cm">/* Enable virtual memory and relocate to virtual address */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">swapper_pg_dir</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">relocate</span>

<span class="w">    </span><span class="n">tail</span><span class="w"> </span><span class="n">smp_callin</span>
<span class="cp">#endif</span>

<span class="n">â‘¡ä¸»hart</span><span class="w"> </span><span class="n">ä½¿èƒ½mmu</span>
<span class="n">_start_kernel</span>
<span class="w">   </span><span class="n">la</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">early_pg_dir</span>
<span class="w">   </span><span class="n">call</span><span class="w"> </span><span class="n">relocate</span>

<span class="nl">relocate</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/* Relocate return address */</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_OFFSET</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">_start</span>
<span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">ra</span><span class="p">,</span><span class="w"> </span><span class="n">ra</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span>
<span class="w">    </span><span class="n">â‘¢</span><span class="w"> </span><span class="n">PAGE_OFFSET</span><span class="p">(</span><span class="n">å†…æ ¸çš„è™šæ‹Ÿåœ°å€</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_start</span><span class="p">(</span><span class="n">å†…æ ¸åŠ è½½çš„ç‰©ç†å†…å­˜</span><span class="p">)</span><span class="w"> </span><span class="n">å¾—åˆ°è™šæ‹Ÿåœ°å€ç›¸å¯¹ç‰©ç†åœ°å€çš„åç§»</span><span class="err">ï¼Œ</span><span class="n">ra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ra</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">PAGE_OFFSET</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_start</span><span class="p">)</span><span class="err">ï¼Œ</span><span class="n">ç›¸å½“äºè®¡ç®—äº†raçš„è™šæ‹Ÿåœ°å€</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="cm">/* Point stvec to virtual address of intruction after satp write */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="mf">1f</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span>
<span class="n">csrw</span><span class="w"> </span><span class="n">CSR_STVEC</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>
<span class="n">â‘£</span><span class="w"> </span><span class="n">å°†ä¾¿ç­¾1è½¬åŒ–ä¸ºè™šæ‹Ÿåœ°å€</span><span class="err">ï¼Œ</span><span class="n">a1å­˜å‚¨çš„è¿˜æ˜¯va_pa_offset</span><span class="err">ï¼Œ</span><span class="n">å†å°†æ ‡ç­¾1å¤„çš„è™šæ‹Ÿåœ°å€å¡«å……åˆ°stvecå¯„å­˜å™¨</span><span class="err">ï¼Œ</span><span class="n">è®¾ç½®ä¸­æ–­çš„å…¥å£å‡½æ•°</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="cm">/* Compute satp for kernel page tables, but don\'t load it yet */</span>
<span class="w">    </span><span class="n">srl</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="w">  </span><span class="n">a0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">early_pg_dir</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">early_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span>
<span class="w">    </span><span class="n">li</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">SATP_MODE</span><span class="w">      </span><span class="n">a1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="n">s</span><span class="w"> </span><span class="n">atpçš„æ¨¡å¼</span><span class="err">ï¼Œ</span><span class="mi">3</span><span class="n">çº§é¡µè¡¨</span>
<span class="w">    </span><span class="n">or</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="w">           </span><span class="n">a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">early_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="n">â‘¤</span><span class="w"> </span><span class="n">è®¡ç®—satpå¯„å­˜å™¨çš„å€¼</span><span class="err">ï¼Œ</span><span class="n">modä¸º8ä»£è¡¨3çº§é¡µè¡¨</span><span class="err">ï¼Œ</span><span class="n">æ ¹ç›®å½•é¡µè¡¨çš„åœ°å€ä¸ºearly_pg_dir</span><span class="err">ï¼Œ</span><span class="n">è¿™ä¸ªé¡µè¡¨åœ¨set_vmå¡«å……çš„é¡µè¡¨</span><span class="err">ï¼Œ</span><span class="n">åŒ…æ‹¬å†…æ ¸çš„é•œåƒçš„ç²—ç²’åº¦æ˜ å°„</span><span class="err">ã€‚</span><span class="n">è¿™é‡Œåªæ˜¯å…ˆè®¡ç®—å½“å‰çš„å€¼</span><span class="err">ï¼Œ</span><span class="n">ä½†æ˜¯å…ˆä¸å†™åˆ°satpå¯„å­˜å™¨</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Load trampoline page directory, which will cause us to trap to</span>
<span class="cm">     * stvec if VA != PA, or simply fall through if VA == PA.  We need a</span>
<span class="cm">     * full fence here because setup_vm() just wrote these PTEs and we need</span>
<span class="cm">     * to ensure the new translations are in use.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">trampoline_pg_dir</span><span class="w"> </span>
<span class="w">    </span><span class="n">srl</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="w">    </span><span class="n">trampoline_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span>
<span class="w">    </span><span class="n">or</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="w">            </span><span class="n">trampoline_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="n">sfence</span><span class="p">.</span><span class="n">vma</span>
<span class="n">csrw</span><span class="w"> </span><span class="n">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="w">      </span><span class="n">satp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trampoline_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span>
<span class="n">â‘¥</span><span class="w"> </span><span class="n">satpè®¾ç½®çš„é¡µè¡¨æ˜¯trampoline_pg_dir</span><span class="err">ï¼Œ</span><span class="n">é¡µè¡¨trampoline_pg_di</span><span class="o">/</span><span class="n">trampoline_pmdåœ¨setup_vmä¸­å¯¹PAGE_OFFSET</span><span class="o">~</span><span class="n">PAGE_OFFSET</span><span class="o">+</span><span class="mi">2</span><span class="n">Mçš„ç©ºé—´åšäº†ç²—ç²’åº¦æ˜ å°„</span><span class="err">ã€‚</span><span class="n">a0</span><span class="o">=</span><span class="n">trampoline_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span><span class="err">ï¼Œ</span><span class="n">å°†a0çš„å€¼å†™å¦‚åˆ°satpçš„é‚£ä¸€åˆ»</span><span class="err">ï¼Œ</span><span class="n">MMUå°±ä½¿èƒ½äº†</span><span class="err">ï¼Œ</span><span class="n">å¯»å€çš„åœ°å€å°±éœ€è¦ç»è¿‡MMUæ¥ç¿»è¯‘</span><span class="err">ï¼Œ</span><span class="n">å› æ­¤PCä¸‹ä¸€æ¡æŒ‡ä»¤çš„å–å€¼åœ°å€</span><span class="err">ï¼Œ</span><span class="n">éœ€è¦ç»è¿‡MMUç¿»è¯‘</span><span class="err">ï¼Œ</span><span class="n">ä½†æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤ä¾æ—§æ˜¯ç‰©ç†åœ°å€</span><span class="err">ï¼Œ</span><span class="n">MMUæ²¡æœ‰å¯¹åº”çš„é¡µè¡¨å°±ä¼šé™·å…¥å¼‚å¸¸</span><span class="err">ï¼Œ</span><span class="n">å…·ä½“è¿‡ç¨‹å¦‚ä¸‹</span><span class="err">ï¼š</span>

<span class="mh">0x802000f4</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">244</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="n">a0</span><span class="p">,</span><span class="mi">-240</span>
<span class="mh">0x802000f8</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">248</span><span class="o">&gt;</span><span class="w"> </span><span class="n">srli</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="n">a0</span><span class="p">,</span><span class="mh">0xc</span>
<span class="mh">0x802000fa</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">250</span><span class="o">&gt;</span><span class="w"> </span><span class="n">or</span><span class="w">      </span><span class="n">a0</span><span class="p">,</span><span class="n">a0</span><span class="p">,</span><span class="n">a1</span><span class="w"> </span>
<span class="o">=&gt;</span><span class="w">  </span><span class="mh">0x80200100</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">256</span><span class="o">&gt;</span><span class="w"> </span><span class="n">csrw</span><span class="w">    </span><span class="n">satp</span><span class="p">,</span><span class="n">a0</span><span class="w">                                                                                                                                                                       </span>
<span class="mh">0x80200104</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">260</span><span class="o">&gt;</span><span class="w"> </span><span class="n">auipc</span><span class="w">   </span><span class="n">a0</span><span class="p">,</span><span class="mh">0x0</span><span class="w">                                                                                                                                                                        </span>
<span class="mh">0x80200108</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">264</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addi</span><span class="w">    </span><span class="n">a0</span><span class="p">,</span><span class="n">a0</span><span class="p">,</span><span class="mi">104</span><span class="w">                                                                                                                                                                     </span>
<span class="mh">0x8020010c</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">268</span><span class="o">&gt;</span><span class="w"> </span><span class="n">csrw</span><span class="w">    </span><span class="n">stvec</span><span class="p">,</span><span class="n">a0</span><span class="w">                                                                                                                                                                      </span>
<span class="mh">0x80200110</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">272</span><span class="o">&gt;</span><span class="w"> </span><span class="n">auipc</span><span class="w">   </span><span class="n">gp</span><span class="p">,</span><span class="mh">0x880</span><span class="w">                                                                                                                                                                      </span>
<span class="mh">0x80200114</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">276</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addi</span><span class="w">    </span><span class="n">gp</span><span class="p">,</span><span class="n">gp</span><span class="p">,</span><span class="mi">1976</span><span class="w">                                                                                                                                                                    </span>
<span class="mh">0x80200118</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">280</span><span class="o">&gt;</span><span class="w"> </span><span class="n">csrw</span><span class="w">    </span><span class="n">satp</span><span class="p">,</span><span class="n">a2</span><span class="w">               </span>
<span class="n">å¦‚ä¸Šçš„æŒ‡ä»¤</span><span class="err">ï¼Œ</span><span class="n">PCè¿è¡Œåˆ°0x80200100</span><span class="err">ï¼Œ</span><span class="n">è¿™å¥çš„æŒ‡ä»¤å°±æ˜¯å‘satpå†™å…¥a0çš„å€¼</span><span class="err">ï¼Œ</span><span class="n">æ‰§è¡Œå®Œè¿™æ¡æŒ‡ä»¤åå°±ä½¿èƒ½äº†MMU</span><span class="err">ï¼Œ</span><span class="n">åç»­çš„å–æŒ‡ä»¤åœ°å€éƒ½éœ€è¦ç»è¿‡MMUç¿»è¯‘</span><span class="err">ã€‚</span><span class="n">å½“ç»§ç»­è¿è¡Œåˆ°ä¸‹ä¸€æ¡æ—¶PC</span><span class="o">=</span><span class="mh">0x80200104</span><span class="n">åœ°å€</span><span class="err">ï¼Œ</span><span class="mh">0x80200104</span><span class="n">éœ€è¦ç»è¿‡MMUç¿»è¯‘</span><span class="err">ï¼Œ</span><span class="n">ä½†æ˜¯MMUæŸ¥è¯¢ä¸åˆ°é¡µè¡¨å°±ä¼šè¿›å…¥å¼‚å¸¸</span><span class="err">ï¼Œ</span><span class="n">è€Œè·³è½¬åˆ°å¼‚å¸¸çš„å…¥å£å‡½æ•°ç”±ä¸Šè¿°â‘£è¿‡ç¨‹å¡«å……çš„1f</span><span class="err">ï¼ˆ</span><span class="n">è™šæ‹Ÿåœ°å€</span><span class="err">ï¼‰ï¼Œ</span><span class="n">å› æ­¤ä¸‹é¢çš„1fæ˜¯å¼‚å¸¸å¤„ç†çš„å…¥å£</span><span class="err">ã€‚</span>
<span class="n">è¿™é‡Œä½¿ç”¨trampoline_pg_diré¡µè¡¨çœ‹èµ·æ¥æ˜¯å¤šä½™äº†</span><span class="err">ï¼Œ</span><span class="n">å…¶å®å¯ä»¥ç›´æ¥ä½¿ç”¨early_pg_dir</span><span class="err">ï¼Œ</span><span class="n">ä¹Ÿåšè¿‡å®éªŒæŠŠcsrw</span><span class="w"> </span><span class="n">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="n">ç›´æ¥æ”¹ä¸ºcsrw</span><span class="w"> </span><span class="n">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="err">ï¼Œ</span><span class="n">å¹¶æŠŠset_vmä¸­å…³äºtrampoline_pg_dirçš„æ˜ å°„æ³¨é‡Šæ‰</span><span class="err">ï¼Œ</span><span class="n">ç³»ç»Ÿä¹Ÿèƒ½æ­£å¸¸èµ·æ¥</span><span class="err">ï¼Œ</span><span class="n">å› æ­¤æš‚ä¸æ¸…æ¥šlinuxä¸Šæ¸¸ä¸æŠŠè¿™ä¸ªåˆ é™¤æ‰</span><span class="err">ã€‚</span>

<span class="p">.</span><span class="n">align</span><span class="w"> </span><span class="mi">2</span>
<span class="mi">1</span><span class="o">:</span>
<span class="w">   </span><span class="n">â‘¦è¿™æ®µä»£ç æ˜¯å¼‚å¸¸è¿›å…¥çš„å…¥å£</span><span class="err">ï¼Œ</span><span class="n">ä¾æ—§ä½¿ç”¨è™šæ‹Ÿåœ°å€å–æŒ‡è¿è¡Œ</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="cm">/* Set trap vector to spin forever to help debug */</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">Lsecondary_park</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">CSR_STVEC</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span>
<span class="w">   </span><span class="n">â‘§é‡æ–°æ›´æ–°å¼‚å¸¸çš„å…¥å£ä¸º</span><span class="p">.</span><span class="n">Lsecondary_park</span>
<span class="w">    </span><span class="cm">/* Reload the global pointer */</span>
<span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">push</span>
<span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">norelax</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">gp</span><span class="p">,</span><span class="w"> </span><span class="n">__global_pointer$</span>
<span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="n">pop</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Switch to kernel page tables.  A full fence is necessary in order to</span>
<span class="cm">     * avoid using the trampoline translations, which are only correct for</span>
<span class="cm">     * the first superpage.  Fetching the fence is guarnteed to work</span>
<span class="cm">     * because that first superpage is translated the same way.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span>
<span class="w">    </span><span class="n">sfence</span><span class="p">.</span><span class="n">vma</span>
<span class="w">    </span><span class="n">â‘¨</span><span class="w"> </span><span class="n">é‡æ–°æ›´æ–°satp</span><span class="o">=</span><span class="n">early_pg_dir</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="n">ret</span>
</code></pre></div>
<p>å½“ä½¿èƒ½MMUæ—¶ï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤çš„å–æŒ‡å°±éœ€è¦ç»è¿‡MMUè¿›è¡Œç¿»è¯‘ï¼Œä½†æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ä¾æ—§æ˜¯ç‰©ç†åœ°å€ï¼ŒMMUæŸ¥è¯¢ä¸åˆ°å¯¹åº”çš„é¡µè¡¨å°±ä¼šè¿›å…¥å¼‚å¸¸ï¼Œè€Œå¼‚å¸¸çš„å…¥å£å®ç°ä½¿ç”¨äº†è™šæ‹Ÿåœ°å€è¿›è¡Œå¡«å……ï¼Œè™šæ‹Ÿåœ°å€çš„é¡µè¡¨ä¹Ÿåœ¨set_vmä¸­è¿›è¡Œäº†å¡«å……ï¼Œå› æ­¤è™šæ‹Ÿåœ°å€æ˜¯å¯ä»¥é€šè¿‡MMUæŸ¥è¡¨æ‰¾åˆ°ç‰©ç†åœ°å€ï¼Œè¿™æ ·å°±ä»ç‰©ç†åœ°å€è¿‡æ¸¡åˆ°äº†è™šæ‹Ÿåœ°å€çš„è¿è¡Œã€‚</p>
<p>é’ˆå¯¹å‰é¢åšä¸ªå°ç»“ï¼š å¼•å¯¼linuxç³»ç»Ÿå¯åŠ¨ï¼Œéœ€è¦è§£å†³çš„æ˜¯ç‰©ç†åœ°å€åˆ‡æ¢åˆ°è™šæ‹Ÿåœ°å€è¿è¡Œï¼Œè€Œåˆ†ç•Œç‚¹å°±æ˜¯å†™satpå¯„å­˜å™¨ï¼Œä½¿èƒ½MMUçš„é‚£ä¸€åˆ»ã€‚è™šæ‹Ÿåœ°å€è½¬åŒ–ä¸ºç‰©ç†åœ°å€ï¼Œè€Œå…³é”®ç‚¹å°±æ˜¯ä¸ºMMUåˆ†é…é¡µè¡¨å¹¶å¡«å……å¥½é¡µè¡¨ï¼Œè€Œæ­¤æ—¶å†…å­˜ç®¡ç†æœªåˆå§‹åŒ–ï¼Œåˆåˆ†é…ä¸äº†ï¼Œæ‰€ä»¥æ€»ç»“ä¸‹ï¼Œå°±é‡åˆ°äº†å¦‚ä¸‹çš„é—®é¢˜ã€‚ 6.å†…å­˜ç®¡ç†æ²¡å‡†å¤‡å¥½ã€‚ 7.éœ€è¦åˆ†é…é¡µè¡¨ã€‚ 8.å¼€äº†MMUåï¼Œåˆ†é…çš„é¡µè¡¨èƒ½å¤Ÿç”¨è™šæ‹Ÿåœ°å€è®¿é—®ã€‚ 9.å¼€äº†MMUåï¼Œè¦èƒ½å¤Ÿç”¨è™šæ‹Ÿåœ°å€è®¿é—®å†…æ ¸ã€‚ 10.å¼€äº†MMUåï¼Œèƒ½å¤Ÿç”¨è™šæ‹Ÿåœ°å€è®¿é—®è®¾å¤‡æ ‘ã€‚ é’ˆå¯¹ä¸Šé¢çš„é—®é¢˜å¯¹åº”çš„è§£å†³åŠæ³•ï¼š 1.æå‰å®šä¹‰å…¨å±€çš„é™æ€æ•°ç»„ç”¨äºåšé¡µè¡¨ã€‚ 2.å¯¹å†…æ ¸vmlinuxåšç²—ç²’åº¦æ˜ å°„ã€‚ 3.å›ºå®šä¸€æ®µè™šæ‹Ÿåœ°å€fixmapç”¨äºè®¿é—®è®¾å¤‡æ ‘ã€æ–°åˆ†é…çš„é¡µè¡¨ã€‚ 4.ç‰©ç†åœ°å€åˆ°è™šæ‹Ÿåœ°å€çš„åˆ‡æ¢å·§å¦™ä½¿ç”¨è¿›å¼‚å¸¸è¿›è¡Œè½¬åŒ–ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="ä¸´æ—¶è™šæ‹Ÿåœ°å€ç©ºé—´æ˜ å°„.html">â† ä¸´æ—¶è™šæ‹Ÿåœ°å€ç©ºé—´æ˜ å°„</a>
    <a class="next" href="è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€æ¦‚å¿µ.html">è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€æ¦‚å¿µ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

