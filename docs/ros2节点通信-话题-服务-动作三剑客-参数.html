<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ROS2节点通信：话题、服务、动作三剑客+参数 - Laumy的技术栈</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">首页</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="访问主站">主站点:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#_1">简介</a><ul></ul></li><li><a href="#_2">话题</a><ul><li><a href="#python">python示例</a></li><li><a href="#c">C++示例</a></li></ul></li><li><a href="#_3">服务</a><ul><li><a href="#python_1">python示例</a></li><li><a href="#c_1">C++示例</a></li></ul></li><li><a href="#_4">动作</a><ul><li><a href="#python_2">python示例</a></li><li><a href="#c_2">C++示例</a></li></ul></li><li><a href="#_5">通信接口</a><ul></ul></li><li><a href="#_6">参数</a><ul><li><a href="#_7">定义参数</a></li><li><a href="#_8">查询与设置</a></li></ul></li><li><a href="#dds">DDS</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>ROS2节点通信：话题、服务、动作三剑客+参数</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">🕒</i>
      2025-09-16
    </span>
    <span class="meta-item">
      <i class="icon">📂</i>
      ros系统
    </span>
    <span class="meta-item">
      <i class="icon">👤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">简介</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_3c3bec242569835edd283fe7661154bd_1757990015.png"><img alt="" src="assets/doc/05-ros系统/ros2节点通信：话题、服务、动作三剑客参数/images/wp_editor_md_3c3bec242569835edd283fe7661154bd_1757990015.png"/></a></p>
<p>在ROS系统每个节点可以理解为一个进程，更准确的说法它是一个包含了特定功能的独立执行单元。节点在ROS2中通常是一个可执行文件，负责执行特定的任务，如控制机器人、传感器数据处理等。每个节点可以通过ROS2的通信机制与其他节点进行数据交换。</p>
<p>在具体的工程应用中，需要多个节点进行配合完成一个具体的产品。那么多个节点直接如何进行通信了，ROS系统提供了话题、服务、动作这几种方式，当然除了上面3中之外还有一种<strong>参数</strong>的方式，这种方式是一种共享的<strong>全局变量</strong>，让各个节点可以进行<strong>查询/设置</strong>参数以达到信息传输的目的。</p>
<h2 id="_2">话题</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_6d53a0f8565494f55fa91277732d19b2_1757990813.gif"><img alt="" src="assets/doc/05-ros系统/ros2节点通信：话题、服务、动作三剑客参数/images/wp_editor_md_6d53a0f8565494f55fa91277732d19b2_1757990813.gif"/></a></p>
<p>搞过网络MQTT的对ROS2中的话题通信理解就简单了，可以说ROS2中的话题通信与MQTT是一模一样的。话题通信分为发布者和订阅者。发布者通过话题（topic）发布消息，订阅者通过订阅该话题后可接受到该消息。话题的通信是异步通信的方式，结构上是多对多的关系。</p>
<h3 id="python">python示例</h3>
<p>先创建一个包</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/dev_ws/src/
ros2<span class="w"> </span>pkg<span class="w"> </span>create<span class="w"> </span>--build-type<span class="w"> </span>ament_python<span class="w"> </span>learning_topic_python
</code></pre></div>
<p>创建一个发布者节点程序topic_hello_pub.py</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span>

<span class="k">class</span> <span class="nc">PublisherNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s2">"hello"</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">publish_message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">publish_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s2">"Hello, ROS2!"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Published: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">PublisherNode</span><span class="p">(</span><span class="s2">"publisher_node"</span><span class="p">)</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</code></pre></div>
<p>创建订阅者节点程序topic_hello_sub.py</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span>

<span class="k">class</span> <span class="nc">SubscriberNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s2">"hello"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Received: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">SubscriberNode</span><span class="p">(</span><span class="s2">"subscriber_node"</span><span class="p">)</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</code></pre></div>
<p>程序运行发布者</p>
<div class="codehilite"><pre><span></span><code><span class="n">ros2</span> <span class="n">run</span> <span class="n">learning_topic_python</span> <span class="n">topic_hello_pub</span>
</code></pre></div>
<p>程序运行订阅者</p>
<div class="codehilite"><pre><span></span><code><span class="n">ros2</span> <span class="n">run</span> <span class="n">learning_topic_python</span> <span class="n">topic_hello_sub</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_8fc372622d11e30cfbc899f1893ebbd8_1758004323.png"><img alt="" src="assets/doc/05-ros系统/ros2节点通信：话题、服务、动作三剑客参数/images/wp_editor_md_8fc372622d11e30cfbc899f1893ebbd8_1758004323.png"/></a></p>
<p>核心点就是发布调用self.create_publisher，订阅调用self.create_subscription。</p>
<h3 id="c">C++示例</h3>
<p>创建一个包</p>
<div class="codehilite"><pre><span></span><code><span class="n">ros2</span> <span class="n">pkg</span> <span class="n">create</span> <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="nb">type</span> <span class="n">ament_cmake</span> <span class="n">learn_topic_cpp</span>
</code></pre></div>
<p>编写发布者节点</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#include &lt;chrono&gt;</span>
<span class="c1">#include &lt;functional&gt;</span>
<span class="c1">#include &lt;memory&gt;</span>
<span class="c1">#include &lt;string&gt;</span>

<span class="c1">#include "rclcpp/rclcpp.hpp"</span>
<span class="c1">#include "std_msgs/msg/string.hpp"</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">std</span><span class="p">::</span><span class="n">chrono_literals</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">PublisherNode</span> <span class="p">:</span> <span class="n">public</span> <span class="n">rclcpp</span><span class="p">::</span><span class="n">Node</span>
<span class="p">{</span>
    <span class="n">public</span><span class="p">:</span>
        <span class="n">PublisherNode</span><span class="p">()</span>
        <span class="p">:</span> <span class="n">Node</span><span class="p">(</span><span class="s2">"topic_hello"</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">publisher_</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="p">::</span><span class="n">msg</span><span class="p">::</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
            <span class="n">timer_</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span><span class="mi">1</span><span class="n">s</span><span class="p">,</span> <span class="n">std</span><span class="p">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PublisherNode</span><span class="p">::</span><span class="n">timer_callback</span><span class="p">,</span> <span class="n">this</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="n">private</span><span class="p">:</span>
        <span class="n">void</span> <span class="n">timer_callback</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">auto</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">std_msgs</span><span class="p">::</span><span class="n">msg</span><span class="p">::</span><span class="n">String</span><span class="p">();</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s2">"Hello, ROS2!"</span><span class="p">;</span>
            <span class="n">publisher_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
            <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s2">"Published: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="n">rclcpp</span><span class="p">::</span><span class="n">TimerBase</span><span class="p">::</span><span class="n">SharedPtr</span> <span class="n">timer_</span><span class="p">;</span>
        <span class="n">rclcpp</span><span class="p">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="p">::</span><span class="n">msg</span><span class="p">::</span><span class="n">String</span><span class="o">&gt;</span><span class="p">::</span><span class="n">SharedPtr</span> <span class="n">publisher_</span><span class="p">;</span>
<span class="p">};</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">rclcpp</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
    <span class="n">rclcpp</span><span class="p">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="p">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">PublisherNode</span><span class="o">&gt;</span><span class="p">());</span>
    <span class="n">rclcpp</span><span class="p">::</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>编写订阅者节点</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#include &lt;memory&gt;</span>

<span class="c1">#include "rclcpp/rclcpp.hpp"</span>
<span class="c1">#include "std_msgs/msg/string.hpp"</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">std</span><span class="p">::</span><span class="n">chrono_literals</span><span class="p">;</span>
<span class="n">using</span> <span class="n">std</span><span class="p">::</span><span class="n">placeholders</span><span class="p">::</span><span class="n">_1</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">SubscriberNode</span> <span class="p">:</span> <span class="n">public</span> <span class="n">rclcpp</span><span class="p">::</span><span class="n">Node</span>
<span class="p">{</span>
    <span class="n">public</span><span class="p">:</span>
        <span class="n">SubscriberNode</span><span class="p">()</span>
        <span class="p">:</span> <span class="n">Node</span><span class="p">(</span><span class="s2">"topic_hello"</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">subscription_</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="p">::</span><span class="n">msg</span><span class="p">::</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">std</span><span class="p">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SubscriberNode</span><span class="p">::</span><span class="n">topic_callback</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
            <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s2">"SubscriberNode initialized"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="n">private</span><span class="p">:</span>
        <span class="n">void</span> <span class="n">topic_callback</span><span class="p">(</span><span class="n">const</span> <span class="n">std_msgs</span><span class="p">::</span><span class="n">msg</span><span class="p">::</span><span class="n">String</span><span class="p">::</span><span class="n">SharedPtr</span> <span class="n">msg</span><span class="p">)</span> <span class="n">const</span>
        <span class="p">{</span>
            <span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span> <span class="s2">"I heard: '</span><span class="si">%s</span><span class="s2">'"</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="n">rclcpp</span><span class="p">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="p">::</span><span class="n">msg</span><span class="p">::</span><span class="n">String</span><span class="o">&gt;</span><span class="p">::</span><span class="n">SharedPtr</span> <span class="n">subscription_</span><span class="p">;</span>
<span class="p">};</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">rclcpp</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
    <span class="n">rclcpp</span><span class="p">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="p">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">SubscriberNode</span><span class="o">&gt;</span><span class="p">());</span>
    <span class="n">rclcpp</span><span class="p">::</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>运行测试</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_451579abcfdfa6b4234bfceebdcda921_1758005475.png"><img alt="" src="assets/doc/05-ros系统/ros2节点通信：话题、服务、动作三剑客参数/images/wp_editor_md_451579abcfdfa6b4234bfceebdcda921_1758005475.png"/></a></p>
<p>到这里话题的python和cpp示例都实践了，话题主要使用的是异步的方式。</p>
<h2 id="_3">服务</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_71dead860a7dfe16a03add3641be8625_1758006085.gif"><img alt="" src="assets/doc/05-ros系统/ros2节点通信：话题、服务、动作三剑客参数/images/wp_editor_md_71dead860a7dfe16a03add3641be8625_1758006085.gif"/></a></p>
<p>在 ROS 2 中，服务（Service）通信是一种 请求-响应模式，允许客户端发送请求到服务端，服务端处理请求并返回响应。这种方式通常用于需要同步交互的情况，如远程调用、控制请求或计算任务等。这种通信方式与HTTP的通信方式类似，只有一个服务器，由客户端发起get，然后服务端响应数据。</p>
<h3 id="python_1">python示例</h3>
<p>创建一个包</p>
<div class="codehilite"><pre><span></span><code><span class="n">ros2</span> <span class="n">pkg</span> <span class="n">create</span> <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="nb">type</span> <span class="n">ament_python</span> <span class="n">learn_srv_python</span>
</code></pre></div>
<p>创建一个add_server.py节点</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">rclpy</span>

<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">learning_interface.srv</span> <span class="kn">import</span> <span class="n">AddTwoInts</span>

<span class="k">class</span> <span class="nc">adderServer</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_service</span><span class="p">(</span><span class="n">AddTwoInts</span><span class="p">,</span> <span class="s1">'add_two_int'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adder_callback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">adder_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">response</span><span class="o">.</span><span class="n">sum</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">b</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Incoming request</span><span class="se">\n</span><span class="s1">a: </span><span class="si">%d</span><span class="s1"> b: </span><span class="si">%d</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">adderServer</span><span class="p">(</span><span class="s2">"Service_adder_server"</span><span class="p">)</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</code></pre></div>
<p>再创建一个add_client.py节点</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">timeout</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">learning_interface.srv</span> <span class="kn">import</span> <span class="n">AddTwoInts</span>

<span class="k">class</span> <span class="nc">adderClient</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_client</span><span class="p">(</span><span class="n">AddTwoInts</span><span class="p">,</span> <span class="s1">'add_two_int'</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="n">timeout_sec</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'server not available, waiting again...'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">AddTwoInts</span><span class="o">.</span><span class="n">Request</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">send_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">call_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">adderClient</span><span class="p">(</span><span class="s2">"Service_adder_client"</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">send_request</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">ok</span><span class="p">():</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">spin_once</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">'Service call failed </span><span class="si">%r</span><span class="s1">'</span> <span class="o">%</span><span class="p">(</span><span class="n">e</span><span class="p">,))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">'Result of add_two_ints: for </span><span class="si">%d</span><span class="s1"> + </span><span class="si">%d</span><span class="s1"> = </span><span class="si">%d</span><span class="s1">'</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">sum</span><span class="p">))</span>
            <span class="k">break</span>
    <span class="n">node</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</code></pre></div>
<p>运行结果如下</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_fb8ea62974b7f14a592caf26cf820829_1758010165.png"><img alt="" src="assets/doc/05-ros系统/ros2节点通信：话题、服务、动作三剑客参数/images/wp_editor_md_fb8ea62974b7f14a592caf26cf820829_1758010165.png"/></a></p>
<p>示例演示了客户端请求两个数给服务器计算求和，服务器收到客户端的数据后，计算后返回结果。</p>
<p>在创建client和server的时候，要能够匹配上需要有共同的地址如create_service参数为"add_two_int"和create_client的参数地址一样。在服务端需要注册一个回调函数adder_callback，当收到客户端的数据时调用回调函数返回结果。</p>
<h3 id="c_1">C++示例</h3>
<p>创建一个C++的包</p>
<div class="codehilite"><pre><span></span><code><span class="n">ros2</span> <span class="n">pkg</span> <span class="n">create</span> <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="nb">type</span> <span class="n">ament_cmake</span> <span class="n">learn_srv_cpp</span>
</code></pre></div>
<p>创建add_server.cpp节点代码</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"rclcpp/rclcpp.hpp"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"learning_interface/srv/add_two_ints.hpp"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">adderServer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">learning_interface</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">AddTwoInts</span><span class="o">::</span><span class="n">Request</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">learning_interface</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">AddTwoInts</span><span class="o">::</span><span class="n">Response</span><span class="o">&gt;</span><span class="w">      </span><span class="n">response</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">response</span><span class="o">-&gt;</span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="o">-&gt;</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">request</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="w"> </span><span class="s">"Incoming request</span><span class="se">\n</span><span class="s">a: %ld b: %ld"</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">);</span>
<span class="w">    </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="w"> </span><span class="s">"sending back response: [%ld]"</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="o">-&gt;</span><span class="n">sum</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="o">::</span><span class="n">make_shared</span><span class="p">(</span><span class="s">"service_adder_server"</span><span class="p">);</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Service</span><span class="o">&lt;</span><span class="n">learning_interface</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">AddTwoInts</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">create_service</span><span class="o">&lt;</span><span class="n">learning_interface</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">AddTwoInts</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"add_two_int"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">adderServer</span><span class="p">);</span>
<span class="w">    </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="w"> </span><span class="s">"Ready to add two ints."</span><span class="p">);</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>创建一个add_client.cpp节点代码</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"rclcpp/rclcpp.hpp"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"learning_interface/srv/add_two_ints.hpp"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="o">::</span><span class="nn">chrono_literals</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="w"> </span><span class="s">"usage: service_adder_client X Y"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="o">::</span><span class="n">make_shared</span><span class="p">(</span><span class="s">"service_adder_client"</span><span class="p">);</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Client</span><span class="o">&lt;</span><span class="n">learning_interface</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">AddTwoInts</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">create_client</span><span class="o">&lt;</span><span class="n">learning_interface</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">AddTwoInts</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"add_two_int"</span><span class="p">);</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">learning_interface</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">AddTwoInts</span><span class="o">::</span><span class="n">Request</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">request</span><span class="o">-&gt;</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoll</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">    </span><span class="n">request</span><span class="o">-&gt;</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoll</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">wait_for_service</span><span class="p">(</span><span class="mi">1</span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="w"> </span><span class="s">"Interrupted while waiting for the service. Exiting."</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="w"> </span><span class="s">"service not available, waiting again..."</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="o">-&gt;</span><span class="n">async_send_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Wait for the result</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">spin_until_future_complete</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">FutureReturnCode</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="w"> </span><span class="s">"Result of add_two_ints: for %ld + %ld = %ld"</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sum</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">"rclcpp"</span><span class="p">),</span><span class="w"> </span><span class="s">"Failed to call service add_two_ints"</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>结果运行如下：</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_c1473d5b6b628901619492dfca7e4b51_1758011284.png"><img alt="" src="assets/doc/05-ros系统/ros2节点通信：话题、服务、动作三剑客参数/images/wp_editor_md_c1473d5b6b628901619492dfca7e4b51_1758011284.png"/></a></p>
<p>总结一下服务的通信方式可以理解为跟http的类似，基于请求和响应的方式进行，只有一个服务器，但是可以有多个客户端是一个一对多的通信结构。数据的通信跟话题相比其是同步传输，而话题是异步传输。</p>
<h2 id="_4">动作</h2>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_98cf621036421c1be7dee81bc44ea0f5_1758011487.gif"><img alt="" src="assets/doc/05-ros系统/ros2节点通信：话题、服务、动作三剑客参数/images/wp_editor_md_98cf621036421c1be7dee81bc44ea0f5_1758011487.gif"/></a></p>
<p>ROS 2 的 Action 是一种用于实现异步、长时间运行的任务的通信机制，常用于那些需要反馈或结果的任务。相比 ROS 2 的 Service（同步请求-响应模式），Action 允许客户端请求任务并在任务执行过程中接收反馈，最终获取任务的结果。它通常适用于需要较长时间处理的任务，如机器人运动控制、路径规划、抓取任务等。</p>
<p>具体的通信流程如下：</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_0ead2b22d39c11bc697f7c671fcde02d_1758013706.png"><img alt="" src="assets/doc/05-ros系统/ros2节点通信：话题、服务、动作三剑客参数/images/wp_editor_md_0ead2b22d39c11bc697f7c671fcde02d_1758013706.png"/></a></p>
<p>可以分为3个阶段</p>
<ul>
<li>阶段1：客户端异步的方式发送目标。</li>
<li>阶段2：服务端定期反馈实时结果。</li>
<li>阶段3：服务端反馈最终的结果。</li>
</ul>
<h3 id="python_2">python示例</h3>
<p>创建一个包</p>
<div class="codehilite"><pre><span></span><code>ros2<span class="w"> </span>pkg<span class="w"> </span>create<span class="w"> </span>--build-type<span class="w"> </span>ament_python<span class="w"> </span>learn_action_python
</code></pre></div>
<p>创建一个服务端节点程序action_server.py</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">rclpy</span>                                      <span class="c1"># ROS2 Python接口库</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span>   <span class="kn">import</span> <span class="n">Node</span>                     <span class="c1"># ROS2 节点类</span>
<span class="kn">from</span> <span class="nn">rclpy.action</span> <span class="kn">import</span> <span class="n">ActionServer</span>             <span class="c1"># ROS2 动作服务器类</span>
<span class="kn">from</span> <span class="nn">learning_interface.action</span> <span class="kn">import</span> <span class="n">MoveCircle</span>  <span class="c1"># 自定义的圆周运动接口</span>

<span class="k">class</span> <span class="nc">MoveCircleActionServer</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>                   <span class="c1"># ROS2节点父类初始化</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action_server</span> <span class="o">=</span> <span class="n">ActionServer</span><span class="p">(</span>      <span class="c1"># 创建动作服务器（接口类型、动作名、回调函数）</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">MoveCircle</span><span class="p">,</span>
            <span class="s1">'move_circle'</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_callback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_handle</span><span class="p">):</span>            <span class="c1"># 执行收到动作目标之后的处理函数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Moving circle...'</span><span class="p">)</span>
        <span class="n">feedback_msg</span> <span class="o">=</span> <span class="n">MoveCircle</span><span class="o">.</span><span class="n">Feedback</span><span class="p">()</span>            <span class="c1"># 创建一个动作反馈信息的消息</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="mi">30</span><span class="p">):</span>                     <span class="c1"># 从0到360度，执行圆周运动，并周期反馈信息</span>
            <span class="n">feedback_msg</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">i</span>                      <span class="c1"># 创建反馈信息，表示当前执行到的角度</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Publishing feedback: </span><span class="si">%d</span><span class="s1">'</span> <span class="o">%</span> <span class="n">feedback_msg</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="n">goal_handle</span><span class="o">.</span><span class="n">publish_feedback</span><span class="p">(</span><span class="n">feedback_msg</span><span class="p">)</span>  <span class="c1"># 发布反馈信息</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Goal succeeded'</span><span class="p">)</span>
        <span class="n">goal_handle</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>                           <span class="c1"># 动作执行成功</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">MoveCircle</span><span class="o">.</span><span class="n">Result</span><span class="p">()</span>                    <span class="c1"># 创建结果消息</span>
        <span class="n">result</span><span class="o">.</span><span class="n">finish</span> <span class="o">=</span> <span class="kc">True</span>                            
        <span class="k">return</span> <span class="n">result</span>                                   <span class="c1"># 反馈最终动作执行的结果</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                                       <span class="c1"># ROS2节点主入口main函数</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>                                  <span class="c1"># ROS2 Python接口初始化</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">MoveCircleActionServer</span><span class="p">(</span><span class="s2">"action_move_server"</span><span class="p">)</span>    <span class="c1"># 创建ROS2节点对象并进行初始化</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>                                       <span class="c1"># 循环等待ROS2退出</span>
    <span class="n">node</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>                                    <span class="c1"># 销毁节点对象</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>                                       <span class="c1"># 关闭ROS2 Python接口</span>
</code></pre></div>
<p>创建一个客户端阶段程序action_client.py</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">rclpy</span>                                      <span class="c1"># ROS2 Python接口库</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span>   <span class="kn">import</span> <span class="n">Node</span>                     <span class="c1"># ROS2 节点类</span>
<span class="kn">from</span> <span class="nn">rclpy.action</span> <span class="kn">import</span> <span class="n">ActionClient</span>             <span class="c1"># ROS2 动作客户端类</span>

<span class="kn">from</span> <span class="nn">learning_interface.action</span> <span class="kn">import</span> <span class="n">MoveCircle</span>  <span class="c1"># 自定义的圆周运动接口</span>

<span class="k">class</span> <span class="nc">MoveCircleActionClient</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>                   <span class="c1"># ROS2节点父类初始化</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action_client</span> <span class="o">=</span> <span class="n">ActionClient</span><span class="p">(</span>      <span class="c1"># 创建动作客户端（接口类型、动作名）</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">MoveCircle</span><span class="p">,</span> <span class="s1">'move_circle'</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">send_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable</span><span class="p">):</span>                 <span class="c1"># 创建一个发送动作目标的函数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Waiting for action server...'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>    <span class="c1"># 等待动作的服务器端启动</span>

        <span class="n">goal_msg</span> <span class="o">=</span> <span class="n">MoveCircle</span><span class="o">.</span><span class="n">Goal</span><span class="p">()</span>             <span class="c1"># 创建一个动作目标的消息</span>
        <span class="n">goal_msg</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span>                 <span class="c1"># 设置动作目标为使能，希望机器人开始运动</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Sending goal request...'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_goal_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_client</span><span class="o">.</span><span class="n">send_goal_async</span><span class="p">(</span>   <span class="c1"># 异步方式发送动作的目标</span>
            <span class="n">goal_msg</span><span class="p">,</span>                                                   <span class="c1"># 动作目标</span>
            <span class="n">feedback_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feedback_callback</span><span class="p">)</span>                   <span class="c1"># 处理周期反馈消息的回调函数</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_send_goal_future</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal_response_callback</span><span class="p">)</span> <span class="c1"># 设置一个服务器收到目标之后反馈时的回调函数</span>

    <span class="k">def</span> <span class="nf">goal_response_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>           <span class="c1"># 创建一个服务器收到目标之后反馈时的回调函数</span>
        <span class="n">goal_handle</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>                   <span class="c1"># 接收动作的结果</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">goal_handle</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>                    <span class="c1"># 如果动作被拒绝执行</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Goal rejected :('</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Goal accepted :)'</span><span class="p">)</span>                            <span class="c1"># 动作被顺利执行</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_result_future</span> <span class="o">=</span> <span class="n">goal_handle</span><span class="o">.</span><span class="n">get_result_async</span><span class="p">()</span>              <span class="c1"># 异步获取动作最终执行的结果反馈</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_result_future</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_result_callback</span><span class="p">)</span>   <span class="c1"># 设置一个收到最终结果的回调函数 </span>

    <span class="k">def</span> <span class="nf">get_result_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>                                    <span class="c1"># 创建一个收到最终结果的回调函数</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">result</span>                                       <span class="c1"># 读取动作执行的结果</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Result: {</span><span class="si">%d</span><span class="s1">}'</span> <span class="o">%</span> <span class="n">result</span><span class="o">.</span><span class="n">finish</span><span class="p">)</span>                <span class="c1"># 日志输出执行结果</span>

    <span class="k">def</span> <span class="nf">feedback_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedback_msg</span><span class="p">):</span>                                <span class="c1"># 创建处理周期反馈消息的回调函数</span>
        <span class="n">feedback</span> <span class="o">=</span> <span class="n">feedback_msg</span><span class="o">.</span><span class="n">feedback</span>                                      <span class="c1"># 读取反馈的数据</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Received feedback: {</span><span class="si">%d</span><span class="s1">}'</span> <span class="o">%</span> <span class="n">feedback</span><span class="o">.</span><span class="n">state</span><span class="p">)</span> 

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                                       <span class="c1"># ROS2节点主入口main函数</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>                                  <span class="c1"># ROS2 Python接口初始化</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">MoveCircleActionClient</span><span class="p">(</span><span class="s2">"action_move_client"</span><span class="p">)</span>    <span class="c1"># 创建ROS2节点对象并进行初始化</span>
    <span class="n">node</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>                                   <span class="c1"># 发送动作目标</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>                                       <span class="c1"># 循环等待ROS2退出</span>
    <span class="n">node</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>                                    <span class="c1"># 销毁节点对象</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>                                       <span class="c1"># 关闭ROS2 Python接口</span>
</code></pre></div>
<p>运行 <a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_241083bf25e5e6c8ac862eaf333210c4_1758014688.png"><img alt="" src="assets/doc/05-ros系统/ros2节点通信：话题、服务、动作三剑客参数/images/wp_editor_md_241083bf25e5e6c8ac862eaf333210c4_1758014688.png"/></a></p>
<p>总结一下流程：</p>
<div class="codehilite"><pre><span></span><code>客户端<span class="w">                    </span>服务端
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>--<span class="w"> </span>发送目标<span class="w"> </span>-----------&gt;<span class="p">|</span>
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>--<span class="w"> </span>execute_callback<span class="o">()</span><span class="w"> </span>被调用
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span><span class="w">   </span><span class="o">(</span>开始执行动作<span class="o">)</span>
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>&lt;--<span class="w"> </span>目标接受/拒绝<span class="w"> </span>------<span class="p">|</span>--<span class="w"> </span>立即响应目标请求
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>--<span class="w"> </span>goal_response_callback<span class="w"> </span>被调用
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>--<span class="w"> </span>开始循环执行
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span><span class="w">   </span><span class="o">(</span><span class="m">0</span>°,<span class="w"> </span><span class="m">30</span>°,<span class="w"> </span><span class="m">60</span>°...<span class="o">)</span>
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>&lt;--<span class="w"> </span>反馈消息<span class="w"> </span>----------<span class="p">|</span>--<span class="w"> </span>publish_feedback<span class="o">(</span><span class="m">0</span>°<span class="o">)</span>
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>--<span class="w"> </span>feedback_callback<span class="w"> </span>被调用
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>&lt;--<span class="w"> </span>反馈消息<span class="w"> </span>----------<span class="p">|</span>--<span class="w"> </span>publish_feedback<span class="o">(</span><span class="m">30</span>°<span class="o">)</span>
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>--<span class="w"> </span>feedback_callback<span class="w"> </span>被调用
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>&lt;--<span class="w"> </span>反馈消息<span class="w"> </span>----------<span class="p">|</span>--<span class="w"> </span>publish_feedback<span class="o">(</span><span class="m">60</span>°<span class="o">)</span>
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>--<span class="w"> </span>feedback_callback<span class="w"> </span>被调用
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span><span class="w">     </span>...<span class="w"> </span><span class="o">(</span>继续循环<span class="o">)</span><span class="w"> </span>...<span class="w"> </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>&lt;--<span class="w"> </span>反馈消息<span class="w"> </span>----------<span class="p">|</span>--<span class="w"> </span>publish_feedback<span class="o">(</span><span class="m">330</span>°<span class="o">)</span>
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>--<span class="w"> </span>feedback_callback<span class="w"> </span>被调用
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>--<span class="w"> </span>动作执行完成
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>--<span class="w"> </span>goal_handle.succeed<span class="o">()</span>
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>--<span class="w"> </span>返回结果
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>&lt;--<span class="w"> </span>最终结果<span class="w"> </span>----------<span class="p">|</span>--<span class="w"> </span>发送结果消息
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>--<span class="w"> </span>get_result_callback<span class="w"> </span>被调用
<span class="w">  </span><span class="p">|</span><span class="w">                        </span><span class="p">|</span>
<span class="w">  </span><span class="p">|</span>--<span class="w"> </span>动作完成<span class="w"> </span>-----------<span class="p">|</span>
</code></pre></div>
<p>客户端一共注册了3个回调：</p>
<ul>
<li>goal_response_callback：服务器第一次接收到目标请求后的回调函数，调用self._send_goal_future.add_done_callback设置。</li>
<li>feedback_callback：调用send_goal_async时注册，这个回调是服务器实时反馈的回调函数。</li>
<li>get_result_callback：服务器最后返回的结果回调。调用self._get_result_future.add_done_callback注册。</li>
</ul>
<p>服务端就仅仅只有execute_callback一个回调，即对应客户端的feedback回调，另外两个都是隐式的。</p>
<h3 id="c_2">C++示例</h3>
<p>创建一个包</p>
<div class="codehilite"><pre><span></span><code>ros2<span class="w"> </span>pkg<span class="w"> </span>create<span class="w"> </span>--build-type<span class="w"> </span>ament_cmake<span class="w"> </span>learn_action_cpp
</code></pre></div>
<p>创建客户端节点程序action_client.cpp</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#include &lt;iostream&gt;</span>

<span class="c1">#include "rclcpp/rclcpp.hpp"                          // ROS2 C++接口库</span>
<span class="c1">#include "rclcpp_action/rclcpp_action.hpp"            // ROS2 动作类</span>
<span class="c1">#include "learning_interface/action/move_circle.hpp"  // 自定义的圆周运动接口</span>

using<span class="w"> </span>namespace<span class="w"> </span>std<span class="p">;</span>

class<span class="w"> </span>MoveCircleActionClient<span class="w"> </span>:<span class="w"> </span>public<span class="w"> </span>rclcpp::Node
<span class="o">{</span>
<span class="w">    </span>public:
<span class="w">        </span>//<span class="w"> </span>定义一个自定义的动作接口类，便于后续使用
<span class="w">        </span>using<span class="w"> </span><span class="nv">CustomAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>learning_interface::action::MoveCircle<span class="p">;</span>
<span class="w">        </span>//<span class="w"> </span>定义一个处理动作请求、取消、执行的客户端类
<span class="w">        </span>using<span class="w"> </span><span class="nv">GoalHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>rclcpp_action::ClientGoalHandle&lt;CustomAction&gt;<span class="p">;</span>

<span class="w">        </span>explicit<span class="w"> </span>MoveCircleActionClient<span class="o">(</span>const<span class="w"> </span>rclcpp::NodeOptions<span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="nv">node_options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>rclcpp::NodeOptions<span class="o">())</span>
<span class="w">        </span>:<span class="w"> </span>Node<span class="o">(</span><span class="s2">"action_move_client"</span>,<span class="w"> </span>node_options<span class="o">)</span><span class="w">                            </span>//<span class="w"> </span>ROS2节点父类初始化
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span>this-&gt;client_ptr_<span class="w"> </span><span class="o">=</span><span class="w"> </span>rclcpp_action::create_client&lt;CustomAction&gt;<span class="o">(</span><span class="w">   </span>//<span class="w"> </span>创建动作客户端（接口类型、动作名）
<span class="w">                </span>this-&gt;get_node_base_interface<span class="o">()</span>,
<span class="w">                </span>this-&gt;get_node_graph_interface<span class="o">()</span>,
<span class="w">                </span>this-&gt;get_node_logging_interface<span class="o">()</span>,
<span class="w">                </span>this-&gt;get_node_waitables_interface<span class="o">()</span>,
<span class="w">                </span><span class="s2">"move_circle"</span><span class="o">)</span><span class="p">;</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span>//<span class="w"> </span>创建一个发送动作目标的函数
<span class="w">        </span>void<span class="w"> </span>send_goal<span class="o">(</span>bool<span class="w"> </span><span class="nb">enable</span><span class="o">)</span>
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span>//<span class="w"> </span>检查动作服务器是否可以使用
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>!this-&gt;client_ptr_-&gt;wait_for_action_server<span class="o">(</span>std::chrono::seconds<span class="o">(</span><span class="m">10</span><span class="o">)))</span><span class="w"> </span>
<span class="w">            </span><span class="o">{</span>
<span class="w">                </span>RCLCPP_ERROR<span class="o">(</span>this-&gt;get_logger<span class="o">()</span>,<span class="w"> </span><span class="s2">"Client: Action server not available after waiting"</span><span class="o">)</span><span class="p">;</span>
<span class="w">                </span>rclcpp::shutdown<span class="o">()</span><span class="p">;</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="o">}</span>

<span class="w">            </span>//<span class="w"> </span>绑定动作请求、取消、执行的回调函数
<span class="w">            </span>auto<span class="w"> </span><span class="nv">send_goal_options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>rclcpp_action::Client&lt;CustomAction&gt;::SendGoalOptions<span class="o">()</span><span class="p">;</span>
<span class="w">            </span>using<span class="w"> </span>namespace<span class="w"> </span>std::placeholders<span class="p">;</span>
<span class="w">            </span>send_goal_options.goal_response_callback<span class="w"> </span><span class="o">=</span>
<span class="w">                </span>std::bind<span class="o">(</span><span class="p">&amp;</span>MoveCircleActionClient::goal_response_callback,<span class="w"> </span>this,<span class="w"> </span>_1<span class="o">)</span><span class="p">;</span>
<span class="w">            </span>send_goal_options.feedback_callback<span class="w"> </span><span class="o">=</span>
<span class="w">                </span>std::bind<span class="o">(</span><span class="p">&amp;</span>MoveCircleActionClient::feedback_callback,<span class="w"> </span>this,<span class="w"> </span>_1,<span class="w"> </span>_2<span class="o">)</span><span class="p">;</span>
<span class="w">            </span>send_goal_options.result_callback<span class="w"> </span><span class="o">=</span>
<span class="w">                </span>std::bind<span class="o">(</span><span class="p">&amp;</span>MoveCircleActionClient::result_callback,<span class="w"> </span>this,<span class="w"> </span>_1<span class="o">)</span><span class="p">;</span>

<span class="w">            </span>//<span class="w"> </span>创建一个动作目标的消息
<span class="w">            </span>auto<span class="w"> </span><span class="nv">goal_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>CustomAction::Goal<span class="o">()</span><span class="p">;</span>
<span class="w">            </span>goal_msg.enable<span class="w"> </span><span class="o">=</span><span class="w"> </span>enable<span class="p">;</span>
<span class="w">            </span>//<span class="w"> </span>异步方式发送动作的目标
<span class="w">            </span>RCLCPP_INFO<span class="o">(</span>this-&gt;get_logger<span class="o">()</span>,<span class="w"> </span><span class="s2">"Client: Sending goal"</span><span class="o">)</span><span class="p">;</span>
<span class="w">            </span>this-&gt;client_ptr_-&gt;async_send_goal<span class="o">(</span>goal_msg,<span class="w"> </span>send_goal_options<span class="o">)</span><span class="p">;</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">    </span>private:
<span class="w">        </span>rclcpp_action::Client&lt;CustomAction&gt;::SharedPtr<span class="w"> </span>client_ptr_<span class="p">;</span>

<span class="w">        </span>//<span class="w"> </span>创建一个服务器收到目标之后反馈时的回调函数
<span class="w">        </span>void<span class="w"> </span>goal_response_callback<span class="o">(</span>GoalHandle::SharedPtr<span class="w"> </span>goal_message<span class="o">)</span>
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>!goal_message<span class="o">)</span>
<span class="w">            </span><span class="o">{</span>
<span class="w">                </span>RCLCPP_ERROR<span class="o">(</span>this-&gt;get_logger<span class="o">()</span>,<span class="w"> </span><span class="s2">"Client: Goal was rejected by server"</span><span class="o">)</span><span class="p">;</span>
<span class="w">                </span>rclcpp::shutdown<span class="o">()</span><span class="p">;</span><span class="w"> </span>//<span class="w"> </span>Shut<span class="w"> </span>down<span class="w"> </span>client<span class="w"> </span>node
<span class="w">            </span><span class="o">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">            </span><span class="o">{</span>
<span class="w">                </span>RCLCPP_INFO<span class="o">(</span>this-&gt;get_logger<span class="o">()</span>,<span class="w"> </span><span class="s2">"Client: Goal accepted by server, waiting for result"</span><span class="o">)</span><span class="p">;</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span>//<span class="w"> </span>创建处理周期反馈消息的回调函数
<span class="w">        </span>void<span class="w"> </span>feedback_callback<span class="o">(</span>
<span class="w">            </span>GoalHandle::SharedPtr,
<span class="w">            </span>const<span class="w"> </span>std::shared_ptr&lt;const<span class="w"> </span>CustomAction::Feedback&gt;<span class="w"> </span>feedback_message<span class="o">)</span>
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span>std::stringstream<span class="w"> </span>ss<span class="p">;</span>
<span class="w">            </span>ss<span class="w"> </span>&lt;&lt;<span class="w"> </span><span class="s2">"Client: Received feedback: "</span><span class="s">&lt;&lt; feedback_message-&gt;state;</span>
<span class="s">            RCLCPP_INFO(this-&gt;get_logger(), "%s", ss.str().c_str());</span>
<span class="s">        }</span>

<span class="s">        // 创建一个收到最终结果的回调函数</span>
<span class="s">        void result_callback(const GoalHandle::WrappedResult &amp; result_message)</span>
<span class="s">        {</span>
<span class="s">            switch (result_message.code)</span>
<span class="s">            {</span>
<span class="s">                case rclcpp_action::ResultCode::SUCCEEDED:</span>
<span class="s">                    break;</span>
<span class="s">                case rclcpp_action::ResultCode::ABORTED:</span>
<span class="s">                    RCLCPP_ERROR(this-&gt;get_logger(), "Client: Goal was aborted");</span>
<span class="s">                    rclcpp::shutdown(); // 关闭客户端节点</span>
<span class="s">                    return;</span>
<span class="s">                case rclcpp_action::ResultCode::CANCELED:</span>
<span class="s">                    RCLCPP_ERROR(this-&gt;get_logger(), "Client: Goal was canceled");</span>
<span class="s">                    rclcpp::shutdown(); // 关闭客户端节点</span>
<span class="s">                    return;</span>
<span class="s">                def</span>ault:
<span class="w">                    </span>RCLCPP_ERROR<span class="o">(</span>this-&gt;get_logger<span class="o">()</span>,<span class="w"> </span><span class="s2">"Client: Unknown result code"</span><span class="o">)</span><span class="p">;</span>
<span class="w">                    </span>rclcpp::shutdown<span class="o">()</span><span class="p">;</span><span class="w"> </span>//<span class="w"> </span>关闭客户端节点
<span class="w">                    </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">            </span>RCLCPP_INFO<span class="o">(</span>this-&gt;get_logger<span class="o">()</span>,<span class="w"> </span><span class="s2">"Client: Result received: %s"</span>,<span class="w"> </span><span class="o">(</span>result_message.result-&gt;finish<span class="w"> </span>?<span class="w"> </span><span class="s2">"true"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"false"</span><span class="o">))</span><span class="p">;</span>
<span class="w">            </span>rclcpp::shutdown<span class="o">()</span><span class="p">;</span><span class="w">         </span>//<span class="w"> </span>关闭客户端节点
<span class="w">        </span><span class="o">}</span>
<span class="o">}</span><span class="p">;</span>

//<span class="w"> </span>ROS2节点主入口main函数
int<span class="w"> </span>main<span class="o">(</span>int<span class="w"> </span>argc,<span class="w"> </span>char<span class="w"> </span>*<span class="w"> </span>argv<span class="o">[])</span>
<span class="o">{</span>
<span class="w">    </span>//<span class="w"> </span>ROS2<span class="w"> </span>C++接口初始化
<span class="w">    </span>rclcpp::init<span class="o">(</span>argc,<span class="w"> </span>argv<span class="o">)</span><span class="p">;</span>

<span class="w">    </span>//<span class="w"> </span>创建一个客户端指针
<span class="w">    </span>auto<span class="w"> </span><span class="nv">action_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>std::make_shared&lt;MoveCircleActionClient&gt;<span class="o">()</span><span class="p">;</span><span class="w"> </span>

<span class="w">    </span>//<span class="w"> </span>发送动作目标
<span class="w">    </span>action_client-&gt;send_goal<span class="o">(</span><span class="nb">true</span><span class="o">)</span><span class="p">;</span>

<span class="w">    </span>//<span class="w"> </span>创建ROS2节点对象并进行初始化
<span class="w">    </span>rclcpp::spin<span class="o">(</span>action_client<span class="o">)</span><span class="p">;</span><span class="w">  </span>

<span class="w">    </span>//<span class="w"> </span>关闭ROS2<span class="w"> </span>C++接口
<span class="w">    </span>rclcpp::shutdown<span class="o">()</span><span class="p">;</span><span class="w"> </span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">0</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></div>
<p>创建服务端节点程序action_server.cpp</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"rclcpp/rclcpp.hpp"</span><span class="c1">                          // ROS2 C++接口库</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"rclcpp_action/rclcpp_action.hpp"</span><span class="c1">            // ROS2 动作类</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"learning_interface/action/move_circle.hpp"</span><span class="c1">  // 自定义的圆周运动接口</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="p">;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MoveCircleActionServer</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span>
<span class="w">        </span><span class="c1">// 定义一个自定义的动作接口类，便于后续使用</span>
<span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="n">CustomAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">learning_interface</span><span class="o">::</span><span class="n">action</span><span class="o">::</span><span class="n">MoveCircle</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// 定义一个处理动作请求、取消、执行的服务器端</span>
<span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="n">GoalHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">ServerGoalHandle</span><span class="o">&lt;</span><span class="n">CustomAction</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">        </span><span class="k">explicit</span><span class="w"> </span><span class="n">MoveCircleActionServer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">NodeOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">action_server_options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">NodeOptions</span><span class="p">())</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">"action_move_server"</span><span class="p">,</span><span class="w"> </span><span class="n">action_server_options</span><span class="p">)</span><span class="w">                                     </span><span class="c1">// ROS2节点父类初始化</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="o">::</span><span class="nn">placeholders</span><span class="p">;</span>

<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">action_server_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">create_server</span><span class="o">&lt;</span><span class="n">CustomAction</span><span class="o">&gt;</span><span class="p">(</span><span class="w">                  </span><span class="c1">// 创建动作服务器（接口类型、动作名、回调函数）</span>
<span class="w">                </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_node_base_interface</span><span class="p">(),</span>
<span class="w">                </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_node_clock_interface</span><span class="p">(),</span>
<span class="w">                </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_node_logging_interface</span><span class="p">(),</span>
<span class="w">                </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_node_waitables_interface</span><span class="p">(),</span>
<span class="w">                </span><span class="s">"move_circle"</span><span class="p">,</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MoveCircleActionServer</span><span class="o">::</span><span class="n">handle_goal</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">,</span><span class="w"> </span><span class="n">_2</span><span class="p">),</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MoveCircleActionServer</span><span class="o">::</span><span class="n">handle_cancel</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">),</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MoveCircleActionServer</span><span class="o">::</span><span class="n">handle_accepted</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="o">:</span>
<span class="w">        </span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">Server</span><span class="o">&lt;</span><span class="n">CustomAction</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">action_server_</span><span class="p">;</span><span class="w">  </span><span class="c1">// 动作服务器</span>

<span class="w">        </span><span class="c1">// 响应动作目标的请求</span>
<span class="w">        </span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">GoalResponse</span><span class="w"> </span><span class="nf">handle_goal</span><span class="p">(</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">GoalUUID</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">uuid</span><span class="p">,</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">CustomAction</span><span class="o">::</span><span class="n">Goal</span><span class="o">&gt;</span><span class="w"> </span><span class="n">goal_request</span><span class="p">)</span><span class="w">                             </span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">"Server: Received goal request: %d"</span><span class="p">,</span><span class="w"> </span><span class="n">goal_request</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">);</span>
<span class="w">            </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">uuid</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 如请求为enable则接受运动请求，否则就拒绝</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">goal_request</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span><span class="w">                                                           </span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">GoalResponse</span><span class="o">::</span><span class="n">ACCEPT_AND_EXECUTE</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">GoalResponse</span><span class="o">::</span><span class="n">REJECT</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 响应动作取消的请求</span>
<span class="w">        </span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">CancelResponse</span><span class="w"> </span><span class="nf">handle_cancel</span><span class="p">(</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">GoalHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">goal_handle_canceled_</span><span class="p">)</span><span class="w">                            </span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">"Server: Received request to cancel action"</span><span class="p">);</span>
<span class="w">            </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">goal_handle_canceled_</span><span class="p">;</span><span class="w"> </span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">rclcpp_action</span><span class="o">::</span><span class="n">CancelResponse</span><span class="o">::</span><span class="n">ACCEPT</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 处理动作接受后具体执行的过程</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">handle_accepted</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">GoalHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">goal_handle_accepted_</span><span class="p">)</span><span class="w">          </span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="o">::</span><span class="nn">placeholders</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// 在线程中执行动作过程</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MoveCircleActionServer</span><span class="o">::</span><span class="n">execute</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">),</span><span class="w"> </span><span class="n">goal_handle_accepted_</span><span class="p">}.</span><span class="n">detach</span><span class="p">();</span><span class="w"> </span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="n">execute</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">GoalHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">goal_handle_</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">requested_goal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">goal_handle_</span><span class="o">-&gt;</span><span class="n">get_goal</span><span class="p">();</span><span class="w">       </span><span class="c1">// 动作目标</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">feedback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">CustomAction</span><span class="o">::</span><span class="n">Feedback</span><span class="o">&gt;</span><span class="p">();</span><span class="w"> </span><span class="c1">// 动作反馈</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">CustomAction</span><span class="o">::</span><span class="n">Result</span><span class="o">&gt;</span><span class="p">();</span><span class="w">     </span><span class="c1">// 动作结果</span>

<span class="w">            </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">"Server: Executing goal"</span><span class="p">);</span>
<span class="w">            </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Rate</span><span class="w"> </span><span class="nf">loop_rate</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 动作执行的过程</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">361</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ok</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">30</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 检查是否取消动作</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">goal_handle_</span><span class="o">-&gt;</span><span class="n">is_canceling</span><span class="p">())</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">finish</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">                    </span><span class="n">goal_handle_</span><span class="o">-&gt;</span><span class="n">canceled</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="w">                    </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">"Server: Goal canceled"</span><span class="p">);</span>
<span class="w">                    </span><span class="k">return</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// 更新反馈状态</span>
<span class="w">                </span><span class="n">feedback</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">                </span><span class="c1">// 发布反馈状态</span>
<span class="w">                </span><span class="n">goal_handle_</span><span class="o">-&gt;</span><span class="n">publish_feedback</span><span class="p">(</span><span class="n">feedback</span><span class="p">);</span>
<span class="w">                </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">"Server: Publish feedback"</span><span class="p">);</span>

<span class="w">                </span><span class="n">loop_rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 动作执行完成</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">finish</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">                </span><span class="n">goal_handle_</span><span class="o">-&gt;</span><span class="n">succeed</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="w">                </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">"Server: Goal succeeded"</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// ROS2节点主入口main函数</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// ROS2 C++接口初始化</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span><span class="w"> </span>

<span class="w">    </span><span class="c1">// 创建ROS2节点对象并进行初始化</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MoveCircleActionServer</span><span class="o">&gt;</span><span class="p">());</span>

<span class="w">    </span><span class="c1">// 关闭ROS2 C++接口</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>客户端同样也是注册了3个回调：</p>
<ul>
<li>目标的回调：goal_response_callback</li>
<li>反馈的回调：feedback_callback</li>
<li>结果的回调：result_callback</li>
</ul>
<p>运行代码</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_bb090a868cc78da6c443dc872146fdcb_1758015574.png"><img alt="" src="assets/doc/05-ros系统/ros2节点通信：话题、服务、动作三剑客参数/images/wp_editor_md_bb090a868cc78da6c443dc872146fdcb_1758015574.png"/></a></p>
<h2 id="_5">通信接口</h2>
<p>在 ROS 2 中，通信接口（Communication Interface）是指节点之间用于交换信息的机制和定义。这些接口可以通过不同的通信方式（如发布/订阅、服务、动作等）实现，且每种方式都有其特定的通信协议和数据结构。</p>
<p>在ROS 2系统中提供了多种通信接口，每种接口都有不同的用途和行为。常见的通信接口类型包括：</p>
<ul>
<li>话题（Topic）：使用.msg文件格式定义消息类型。</li>
<li>服务（Service）：使用.srv文件格式定义消息类型</li>
<li>动作（Action）：使用.action文件格式定义消息类型。</li>
</ul>
<p>对于通信接口有一些查明命令</p>
<ul>
<li>查询通信接口：ros2 interface list</li>
<li>查询某个通信接口定义：ros2 interface show &lt;接口名&gt;</li>
<li>查询某个功能包中的通信接口定义：ros2 interface package &lt;包名&gt;</li>
</ul>
<p>如下示例</p>
<div class="codehilite"><pre><span></span><code><span class="n">laumy</span><span class="nd">@ThinkBook</span><span class="o">-</span><span class="mi">14</span><span class="o">-</span><span class="n">G7</span><span class="o">-</span><span class="n">IAH</span><span class="p">:</span><span class="o">~/</span><span class="n">dev_ws</span><span class="err">$</span> <span class="n">ros2</span> <span class="n">interface</span> <span class="n">package</span> <span class="n">learn_action_cpp</span>
<span class="n">laumy</span><span class="nd">@ThinkBook</span><span class="o">-</span><span class="mi">14</span><span class="o">-</span><span class="n">G7</span><span class="o">-</span><span class="n">IAH</span><span class="p">:</span><span class="o">~/</span><span class="n">dev_ws</span><span class="err">$</span> <span class="n">ros2</span> <span class="n">interface</span> <span class="n">show</span> <span class="n">learning_interface</span><span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">AddTwoInts</span> 
<span class="n">int64</span> <span class="n">a</span>        <span class="c1"># 第一个加数</span>
<span class="n">int64</span> <span class="n">b</span>        <span class="c1"># 第二个加数</span>
<span class="o">---</span>
<span class="n">int64</span> <span class="nb">sum</span>      <span class="c1"># 求和结果</span>
</code></pre></div>
<p>下面举例创建通信接口的示例，为了方便我们直接在一个包里面创建3个不同类型的通信接口，分别对应.msg，.action，.srv。步骤如下：</p>
<p><strong>（1）创建一个包</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">ros2</span> <span class="n">pkg</span> <span class="n">create</span> <span class="n">my_interfaces</span> <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="nb">type</span> <span class="n">ament_cmake</span>
</code></pre></div>
<p><strong>（2）创建文件下存放.msg、.srv、.action文件</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">mkdir</span> <span class="n">msg</span> <span class="n">srv</span> <span class="n">action</span>
</code></pre></div>
<p><strong>（3）定义.msg文件</strong> 在 msg 文件夹中创建一个 .msg 文件。比如创建一个 MyMessage.msg 文件，定义消息格式：</p>
<div class="codehilite"><pre><span></span><code><span class="n">int32</span> <span class="nb">id</span>
<span class="n">string</span> <span class="n">name</span>
<span class="n">float64</span> <span class="n">value</span>
</code></pre></div>
<p><strong>（4）定义.srv文件</strong> 在 srv 文件夹中创建一个 .srv 文件。比如创建一个 AddTwoInts.srv 文件，定义服务请求和响应格式：</p>
<div class="codehilite"><pre><span></span><code><span class="n">int64</span> <span class="n">a</span>
<span class="n">int64</span> <span class="n">b</span>
<span class="o">---</span>
<span class="n">int64</span> <span class="nb">sum</span>
</code></pre></div>
<p><strong>（5）定义.action文件</strong></p>
<p>在 action 文件夹中创建一个 .action 文件。比如创建一个 MoveTo.action 文件，定义动作的目标、结果和反馈格式：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Goal</span>
<span class="n">float64</span> <span class="n">x</span>
<span class="n">float64</span> <span class="n">y</span>
<span class="o">---</span>
<span class="c1"># Result</span>
<span class="nb">bool</span> <span class="n">success</span>
<span class="n">string</span> <span class="n">message</span>
<span class="o">---</span>
<span class="c1"># Feedback</span>
<span class="n">float64</span> <span class="n">distance_remaining</span>
</code></pre></div>
<p><strong>（6）修改CMakeList.txt</strong></p>
<p>添加依赖：在 find_package 部分，添加对 ROS 2 生成接口工具的依赖</p>
<div class="codehilite"><pre><span></span><code><span class="n">find_package</span><span class="p">(</span><span class="n">rosidl_default_generators</span> <span class="n">REQUIRED</span><span class="p">)</span>
</code></pre></div>
<p>添加接口文件的生成：使用 rosidl_generate_interfaces 命令生成消息、服务和动作的代码。</p>
<div class="codehilite"><pre><span></span><code><span class="n">rosidl_generate_interfaces</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">PROJECT_NAME</span><span class="p">}</span>
  <span class="s2">"msg/MyMessage.msg"</span>
  <span class="s2">"srv/AddTwoInts.srv"</span>
  <span class="s2">"action/MoveTo.action"</span>
<span class="p">)</span>
</code></pre></div>
<p>安装生成的接口文件：</p>
<div class="codehilite"><pre><span></span><code><span class="n">install</span><span class="p">(</span><span class="n">DIRECTORY</span>
  <span class="n">msg</span>
  <span class="n">srv</span>
  <span class="n">action</span>
  <span class="n">DESTINATION</span> <span class="n">share</span><span class="o">/</span><span class="err">$</span><span class="p">{</span><span class="n">PROJECT_NAME</span><span class="p">}</span>
<span class="p">)</span>
</code></pre></div>
<p><strong>（7）修改packge.xml文件</strong></p>
<p>在 package.xml 中，添加对 rosidl_default_runtime 和 rclpy 等依赖的声明，确保能够生成并使用这些接口。</p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="n">depend</span><span class="o">&gt;</span><span class="n">rosidl_default_runtime</span><span class="o">&lt;/</span><span class="n">depend</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">depend</span><span class="o">&gt;</span><span class="n">rclpy</span><span class="o">&lt;/</span><span class="n">depend</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">depend</span><span class="o">&gt;</span><span class="n">example_interfaces</span><span class="o">&lt;/</span><span class="n">depend</span><span class="o">&gt;</span>
</code></pre></div>
<p><strong>（8）编译</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">colcon</span> <span class="n">build</span>
</code></pre></div>
<p><strong>（9）使用定义的接口</strong></p>
<p>话题通信</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">my_interfaces.msg</span> <span class="kn">import</span> <span class="n">MyMessage</span>
</code></pre></div>
<p>服务通信</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">my_interfaces.srv</span> <span class="kn">import</span> <span class="n">AddTwoInts</span>
</code></pre></div>
<p>动作通信</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">my_interfaces.action</span> <span class="kn">import</span> <span class="n">MoveTo</span>
</code></pre></div>
<h2 id="_6">参数</h2>
<p>在ROS2系统中，想要获取一些硬件设备如摄像头的分辨率等怎么表示了，这就用到了ROS系统中的参数。在 ROS 2 中，系统参数（System Parameters）用于存储和配置节点的运行时设置。通过参数，用户可以灵活地调整节点的行为，而无需修改源代码。ROS 2 的参数机制非常强大，支持动态更改参数值，并且能够在节点启动时通过命令行或 YAML 配置文件进行预设。</p>
<p>参数可以认为是多个节点可以互相访问的全局变量。</p>
<h3 id="_7">定义参数</h3>
<p><strong>（1）创建一个ROS2 包</strong></p>
<p>参数的定义可以包含在其他功能的包中，也可以单独的定义一个包。</p>
<div class="codehilite"><pre><span></span><code><span class="n">ros2</span> <span class="n">pkg</span> <span class="n">create</span> <span class="n">my_param_pkg</span> <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="nb">type</span> <span class="n">ament_python</span>
<span class="n">cd</span> <span class="n">my_param_pkg</span>
</code></pre></div>
<p><strong>（2）声明参数</strong></p>
<p>在 ROS 2 中，节点需要在初始化时声明参数。你可以为每个参数指定一个默认值和类型。</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="k">class</span> <span class="nc">ParamExampleNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">'param_example_node'</span><span class="p">)</span>

        <span class="c1"># 声明参数，并为其设定默认值</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">'param_name'</span><span class="p">,</span> <span class="s1">'default_value'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">'param_int'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">'param_bool'</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">ParamExampleNode</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>使用 declare_parameter() 方法声明一个参数。</p>
<h3 id="_8">查询与设置</h3>
<p>代码的方式查询与设置，调用get_parameter和set_parameters进行获取和设置参数</p>
<div class="codehilite"><pre><span></span><code><span class="n">获取参数</span>
<span class="n">param_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">'param_name'</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">()</span><span class="o">.</span><span class="n">string_value</span>
<span class="n">param_int_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">'param_int'</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">()</span><span class="o">.</span><span class="n">integer_value</span>
<span class="n">param_bool_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">'param_bool'</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">()</span><span class="o">.</span><span class="n">bool_value</span>

<span class="n">设置参数</span>
<span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">([</span><span class="n">Parameter</span><span class="p">(</span><span class="s1">'param_name'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">'new_value'</span><span class="p">)])</span>
</code></pre></div>
<p>也可以通过YAML文件的方式设置</p>
<div class="codehilite"><pre><span></span><code><span class="n">param_example_node</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">param_name</span><span class="p">:</span> <span class="s2">"new_value"</span>
    <span class="n">param_int</span><span class="p">:</span> <span class="mi">20</span>
    <span class="n">param_bool</span><span class="p">:</span> <span class="n">false</span>
</code></pre></div>
<p>通过 YAML 文件来为节点提供参数配置，这对于启动时设置多个参数非常有用。使用 --params-file 参数启动节点并加载该配置文件：</p>
<div class="codehilite"><pre><span></span><code><span class="n">ros2</span> <span class="n">run</span> <span class="n">my_param_pkg</span> <span class="n">my_node</span> <span class="o">--</span><span class="n">params</span><span class="o">-</span><span class="n">file</span> <span class="n">params</span><span class="o">.</span><span class="n">yaml</span>
</code></pre></div>
<p>还可以通过命令行的方式设置和查询。</p>
<div class="codehilite"><pre><span></span><code><span class="n">列出节点参数</span>
<span class="n">ros2</span> <span class="n">param</span> <span class="nb">list</span> <span class="o">/</span><span class="n">param_example_node</span>

<span class="n">获取参数的值</span>
<span class="n">ros2</span> <span class="n">param</span> <span class="n">get</span> <span class="o">/</span><span class="n">param_example_node</span> <span class="n">param_name</span>

<span class="n">设置参数的值</span>
<span class="n">ros2</span> <span class="n">param</span> <span class="nb">set</span> <span class="o">/</span><span class="n">param_example_node</span> <span class="n">param_name</span> <span class="s2">"new_value"</span>
</code></pre></div>
<p>还可以通过注册参数回调来处理参数的动态更新。当参数值发生变化时，回调函数会被调用。可以通过 add_on_set_parameters_callback() 注册这个回调。</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">parameter_callback</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Parameter '</span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">' has been updated to </span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">SetParametersResult</span><span class="p">(</span><span class="n">successful</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">add_on_set_parameters_callback</span><span class="p">(</span><span class="n">parameter_callback</span><span class="p">)</span>
</code></pre></div>
<h2 id="dds">DDS</h2>
<p>DDS（Data Distribution Service）是 ROS 2 的核心通信协议，话题、服务和动作都是基于底层的DDS实现。DDS 是一个中间件标准，它定义了数据交换、通信模式和可靠性保证的方式。ROS 2 采用 DDS 来实现节点之间的通信，提供了高效、灵活的实时数据传输机制。</p>
<p>DDS 提供了一些强大的特性，包括高可用性、灵活的 QoS（Quality of Service）配置、低延迟和高吞吐量。它是面向数据的，适合用于需要数据流的场景，如机器人、物联网、自动驾驶等领域。</p>
<p>ROS2系统中对DDS实现做了解耦，可以有不同的 DDS 实现（例如，Fast DDS、Cyclone DDS、RTI Connext DDS）提供了不同的功能和特性，但它们遵循相同的 DDS 标准。</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/09/wp_editor_md_670554578afb0f7215030bd54df7e718_1758018506.png"><img alt="" src="assets/doc/05-ros系统/ros2节点通信：话题、服务、动作三剑客参数/images/wp_editor_md_670554578afb0f7215030bd54df7e718_1758018506.png"/></a></p>
<p>DDS通信结构中，只有在一个domain域中才能通信，可以理解在一个网段中，所以了要能够使应用互相通信，需要将各个应用绑定到一个domain中。</p>
<p>DDS中还有另外一个特性就是服务特性QoS，可以设置通信的传输质量，优先级等。</p>
<p>在 ROS 2 中，可以通过 rclcpp 或 rclpy 中的接口来设置 QoS，下面简单举例。例如，设置话题的 QoS：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">rclpy.qos</span> <span class="kn">import</span> <span class="n">QoSProfile</span><span class="p">,</span> <span class="n">QoSReliabilityPolicy</span><span class="p">,</span> <span class="n">QoSHistoryPolicy</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span>

<span class="n">qos_profile</span> <span class="o">=</span> <span class="n">QoSProfile</span><span class="p">(</span>
    <span class="n">reliability</span><span class="o">=</span><span class="n">QoSReliabilityPolicy</span><span class="o">.</span><span class="n">RELIABLE</span><span class="p">,</span>
    <span class="n">history</span><span class="o">=</span><span class="n">QoSHistoryPolicy</span><span class="o">.</span><span class="n">KEEP_LAST</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>

<span class="n">publisher</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s1">'topic_name'</span><span class="p">,</span> <span class="n">qos_profile</span><span class="p">)</span>
</code></pre></div>
<p>本文关于ROS2的通信记录到此，具体在根据实践中查询吧。</p>
<p>附录：本文来自《ROS2智能机器人开发实践》笔记</p></div>
  <div class="post-nav">
    <a class="prev" href="ros2机器人仿真-urdf模型-gaezbo仿真.html">← ROS2机器人仿真：urdf模型、gaezbo仿真</a>
    <a class="next" href="ubuntu系统异常-无法进入登录桌面.html">ubuntu系统异常：无法进入登录桌面 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

