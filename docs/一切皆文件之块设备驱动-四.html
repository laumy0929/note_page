<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆå››ï¼‰ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">å®éªŒç¯å¢ƒ</a><ul></ul></li><li><a href="#_2">å—è®¾å¤‡æ— æ–‡ä»¶ç³»ç»Ÿæ–¹å¼è¯»å†™</a><ul><li><a href="#_3">å†™æ•°æ®</a></li><li><a href="#_4">è¯»æ•°æ®</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆå››ï¼‰</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2023-06-04
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">å®éªŒç¯å¢ƒ</h2>
<div class="codehilite"><pre><span></span><code><span class="n">kernel</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">linux</span><span class="w"> </span><span class="mf">5.15</span>
<span class="n">kernel</span><span class="w"> </span><span class="n">module</span><span class="o">:</span><span class="w"> </span><span class="n">simpleblk</span><span class="p">.</span><span class="n">ko</span><span class="w">  </span><span class="n">å‚è€ƒä¸Šä¸€ç« èŠ‚</span>
<span class="n">application</span><span class="err">ï¼š</span><span class="n">app_test</span><span class="w">        </span><span class="n">å‚è€ƒä¸Šä¸€ç« èŠ‚</span>
</code></pre></div>
<h2 id="_2">å—è®¾å¤‡æ— æ–‡ä»¶ç³»ç»Ÿæ–¹å¼è¯»å†™</h2>
<h3 id="_3">å†™æ•°æ®</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/11/wp_editor_md_c69fe5fb31aa6d753d775db469da9896.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆå››ï¼‰/images/wp_editor_md_c69fe5fb31aa6d753d775db469da9896.jpg"/></a></p>
<p>å­˜å‚¨è®¾å¤‡æ²¡æœ‰æ ¼å¼åŒ–æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œé‚£ä¹ˆå¯¹ç£ç›˜è®¾å¤‡çš„æ“ä½œä¼šç»è¿‡/dev/xxx tmpfsæ–‡ä»¶ç³»ç»Ÿå’Œbdevä¼ªæ–‡ä»¶ç³»ç»Ÿç»„åˆçš„æ–¹å¼è¯»å†™ç£ç›˜ã€‚</p>
<ul>
<li>Writeç³»ç»Ÿè°ƒç”¨ç»è¿‡VFSè°ƒç”¨åˆ°def_blk_fopsä¸­çš„blkdev_write_iterï¼Œè¯¥å‡½æ•°ä¸­ç»§ç»­è°ƒç”¨åˆ°__generic_file_write_iterã€‚</li>
<li>å¦‚æœæ˜¯ç¼“å†²I/Oçš„æ–¹å¼ï¼Œå°†ç»è¿‡4ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«ä¸ºè·å–page cacheã€ä»ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®åˆ°pageã€ä¿®æ”¹çš„ç¼“å­˜æ ‡è®°ä¸ºè„é¡µã€æ ¹æ®é˜ˆå€¼æ˜¯å¦è¦å†™å›è„é¡µã€‚</li>
<li>åœ¨write_beginä¸­ä¼šæŸ¥è¯¢æ˜¯å¦æœ‰ç£ç›˜å¯¹åº”çš„page cacheï¼Œå¦‚æœæ²¡æœ‰å°±ç”³è¯·ä¸€ä¸ªpageç”¨äºç£ç›˜çš„ç¼“å†²ï¼›å¯¹äºæ–°ç”³è¯·çš„page cacheï¼Œä¼šè°ƒç”¨ll_rw_blockè¿›è¡Œé¢„è¯»ï¼Œå°†ç£ç›˜æ•°æ®è¯»å–åˆ°pageä¸­ï¼Œåé¢çš„æ“ä½œå°±ç›´æ¥å¯¹page æ“ä½œå³å¯ã€‚</li>
</ul>
<h4 id="page">æ•°æ®å†™åˆ°ç¼“å­˜é¡µpageä¸­ï¼ˆæ–‡ä»¶ç³»ç»Ÿå±‚ï¼‰</h4>
<div class="codehilite"><pre><span></span><code><span class="n">ksys_write</span>
<span class="w">    </span><span class="o">--&gt;</span><span class="n">vfs_write</span>
<span class="w">        </span><span class="o">--&gt;</span><span class="n">new_sync_write</span>
<span class="w">            </span><span class="o">--&gt;</span><span class="n">blkdev_write_iter</span>
<span class="w">                </span><span class="o">--&gt;</span><span class="n">blk_start_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">)</span>
<span class="w">                </span><span class="o">--&gt;</span><span class="n">__generic_file_write_iter</span>
<span class="w">                </span><span class="o">--&gt;</span><span class="n">blk_finish_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">)</span>

<span class="n">generic_perform_write</span>
<span class="w">    </span><span class="o">--&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">write_begin</span><span class="w"> </span><span class="o">--&gt;</span><span class="n">blkdev_write_begin</span>
<span class="w">        </span><span class="o">--&gt;</span><span class="n">block_write_begin</span>
<span class="w">            </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">grab_cache_page_write_begin</span><span class="w"> </span><span class="n">è·å–pageç¼“å­˜</span>
<span class="w">            </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">__block_write_begin_int</span><span class="w">  </span><span class="n">å†™æ•°æ®å¼€å§‹åˆå§‹åŒ–</span>
<span class="w">                </span><span class="o">--&gt;</span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_page_buffers</span><span class="w">  </span><span class="n">åˆ†é…ä¸€ä¸ªbuffer_head</span>
<span class="w">                </span><span class="o">--&gt;</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">buffer_mapped</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_block</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">bh</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">                    </span><span class="o">--&gt;</span><span class="n">blkdev_get_block</span><span class="w"> </span><span class="n">å°†å—ä¸buffer_headæ˜ å°„</span><span class="err">ï¼ˆ</span><span class="n">æŠŠbh</span><span class="o">-&gt;</span><span class="n">b_bdevè®¾ç½®ä¸ºinodeå¯¹åº”çš„i_bdevå¹¶è®¾ç½®blockå·</span><span class="err">ï¼‰</span>
<span class="w">    </span><span class="o">--&gt;</span><span class="n">copy_page_from_iter_atomic</span><span class="w">     </span><span class="n">ç”¨æˆ·æ‹·è´æ•°æ®åˆ°pageä¸­</span>
<span class="w">     </span><span class="o">--&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">write_end</span><span class="w">  </span><span class="o">--&gt;</span><span class="n">blkdev_write_end</span><span class="w">  </span><span class="n">å†™æ•°æ®ç»“æŸ</span><span class="err">ï¼Œ</span><span class="n">è®¾ç½®pageä¸ºè„é¡µ</span>
<span class="w">     </span><span class="o">--&gt;</span><span class="n">balance_dirty_pages_ratelimited</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span><span class="w"> </span><span class="n">è„é¡µå¤ªå¤šè§¦å‘å›å†™åˆ°ç£ç›˜</span>
</code></pre></div>
<h4 id="bio">æ‰“åŒ…æ•°æ®æˆbioé€’äº¤åˆ°å—è®¾å¤‡å±‚</h4>
<p>ç›´æ¥å†™ç£ç›˜ä¸€èˆ¬æœ‰å‡ ç§æ–¹å¼ï¼Œåœ¨å»ºç«‹bhå’Œç£ç›˜æ˜ å°„æ—¶ï¼Œå¦‚æœæ•°æ®ä¸æ˜¯æœ€æ–°çš„åˆ™è°ƒç”¨ll_rw_blockè¿›è¡Œå†™ï¼›å¦å¤–æƒ…å†µå°±æ˜¯å½“è„é¡µè¶…è¿‡ä¸€å®šé˜ˆå€¼ã€ç”¨æˆ·å…³é—­æ–‡ä»¶ç­‰æ“ä½œè§¦å‘workerå›å†™ï¼Œæœ¬å°èŠ‚ä»¥è§¦å‘workeræ–¹å¼å›å†™ä¸ºä¾‹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">wb_workfn</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">wb_writeback</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">__writeback_inodes_wb</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">writeback_sb_inodes</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">__writeback_single_inode</span>

<span class="o">-&gt;</span><span class="n">do_writepages</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="k">if</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">writepages</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">writepages</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span><span class="w"> </span><span class="n">wbc</span><span class="p">)</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">blkdev_writepages</span><span class="w"> </span><span class="n">è°ƒç”¨bdevæ–‡ä»¶ç³»ç»Ÿæ³¨å†Œçš„å†™pageå‡½æ•°</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="k">else</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generic_writepages</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span><span class="w"> </span><span class="n">wbc</span><span class="p">);</span>

<span class="n">blkdev_writepages</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">generic_writepages</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">blk_start_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">)</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">write_cache_pages</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">__writepage</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">blk_finish_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>

<span class="n">__writepage</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">writepage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">wbc</span><span class="p">);</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">blkdev_writepage</span><span class="w">  </span><span class="n">æ³¨æ„ä¸blkdev_writepagesçš„åŒºåˆ«</span><span class="err">ï¼ˆ</span><span class="n">å¤šäº†ä¸ªs</span><span class="err">ï¼‰</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">block_write_full_page</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">__block_write_full_page</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="n">submit_bh_wbc</span>

<span class="n">submit_bh_wbc</span><span class="p">(</span><span class="n">REQ_OP_WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">write_flags</span><span class="p">,</span><span class="w"> </span><span class="n">bh</span><span class="p">,</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_write_hint</span><span class="p">,</span><span class="w"> </span><span class="n">wbc</span><span class="p">);</span>
<span class="w">     </span><span class="n">å°†bhè½¬åŒ–ä¸ºbio</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">bio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio_alloc</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">åˆ†é…ä¸€ä¸ªbio</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_iter</span><span class="p">.</span><span class="n">bi_sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">bio_set_dev</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_bdev</span><span class="p">);</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_write_hint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">write_hint</span><span class="p">;</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">bio_add_page</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_page</span><span class="p">,</span><span class="w"> </span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">,</span><span class="w"> </span><span class="n">bh_offset</span><span class="p">(</span><span class="n">bh</span><span class="p">));</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end_bio_bh_io_sync</span><span class="p">;</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bh</span><span class="p">;</span>
<span class="w">     </span><span class="n">é€’äº¤bio</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">submit_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>

<span class="n">submit_bio</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">submit_bio_noacct</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">__submit_bio_noacct</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">__submit_bio</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">submit_bio</span><span class="p">)</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">submit_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span><span class="w"> </span><span class="n">å¦‚æœå—è®¾å¤‡æ³¨å†Œäº†submit_bioç›´æ¥è°ƒç”¨</span><span class="err">ï¼ˆ</span><span class="n">ä¸€èˆ¬æ˜¯ramdiskä½¿ç”¨è¿™ç§æ–¹å¼</span><span class="err">ï¼‰</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="k">else</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="n">blk_mq_submit_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span><span class="w"> </span><span class="n">å¦‚æœæ²¡æœ‰æ³¨å†Œåˆ™è¿›å…¥mq</span>
</code></pre></div>
<h4 id="request">åˆ›å»ºå’Œå‘é€request</h4>
<div class="codehilite"><pre><span></span><code><span class="n">blk_qc_t</span><span class="w"> </span><span class="nf">blk_mq_submit_bio</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">è·å–å­˜å‚¨è®¾å¤‡çš„request</span><span class="w"> </span><span class="n">queue</span><span class="err">ï¼ˆ</span><span class="n">åŒ…å«blk_mq_ctxå’Œblk_mq_hw_ctx</span><span class="err">ï¼‰</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>

<span class="w">    </span><span class="n">å¦‚æœå†…å­˜åŒºå¤„äºé«˜ä½åŒº</span><span class="err">ï¼Œ</span><span class="n">åˆ™é‡æ–°æ˜ å°„åˆ°ä½ä½åŒº</span>
<span class="w">    </span><span class="n">blk_queue_bounce</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bio</span><span class="p">);</span>

<span class="w">    </span><span class="n">å¦‚æœbioå—å¤ªå¤§</span><span class="err">ï¼Œ</span><span class="n">åˆ™å¯¹bioè¿›è¡Œåˆ†å‰²</span>
<span class="w">    </span><span class="n">__blk_queue_split</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nr_segs</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">queue_exit</span><span class="p">;</span>

<span class="w">    </span><span class="n">å¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰ç¦ç”¨åˆå¹¶åˆ™å°è¯•åœ¨taskçš„current</span><span class="o">-&gt;</span><span class="n">plugä¸Šåˆå¹¶</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">is_flush_fua</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">blk_queue_nomerges</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">blk_attempt_plug_merge</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">nr_segs</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">same_queue_rq</span><span class="p">))</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">queue_exit</span><span class="p">;</span><span class="w"> </span><span class="c1">//åˆå¹¶æˆåŠŸåç›´æ¥é€€å‡º</span>

<span class="w">    </span><span class="n">ä¸ºäº†ç®¡ç†request</span><span class="err">ï¼Œ</span><span class="n">æ—©æœŸå†…æ ¸ä¸ºæ¯ä¸ªtaskéƒ½å®šä¹‰äº†ä¸€ä¸ªstruct</span><span class="w"> </span><span class="n">blk_plug</span><span class="err">ï¼Œ</span><span class="n">åŒtaskçš„requestæš‚æ—¶éƒ½</span>
<span class="w">    </span><span class="n">ä¼šæŒ‚è½½åˆ°blk_plug</span><span class="p">.</span><span class="n">mg_listä¸­</span><span class="err">ï¼Œ</span><span class="n">æ–°å¢çš„bioåˆ°æ¥æ—¶</span><span class="err">ï¼Œ</span><span class="n">ä¼šéå†blk_plug</span><span class="p">.</span><span class="n">mq_list</span><span class="err">ï¼Œ</span><span class="n">å¦‚æœå­˜åœ¨åˆé€‚çš„</span>
<span class="w">    </span><span class="n">requestç›´æ¥æ·»åŠ </span><span class="err">ï¼Œ</span><span class="n">å¦‚æœä¸å­˜åœ¨å°±ç”³è¯·ä¸€ä¸ªæ–°çš„requestæ·»åŠ </span><span class="err">ã€‚</span>

<span class="w">    </span><span class="n">å°è¯•åœ¨IOè°ƒåº¦å™¨æˆ–è½¯é˜Ÿåˆ—ctxä¸­åˆå¹¶</span><span class="err">ï¼Œ</span><span class="n">åˆå¹¶æˆåŠŸåˆ™è¿”å›</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blk_mq_sched_bio_merge</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">nr_segs</span><span class="p">))</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">queue_exit</span><span class="p">;</span>

<span class="w">    </span><span class="n">rq_qos_throttle</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">);</span>

<span class="w">    </span><span class="n">hipri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_opf</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">REQ_HIPRI</span><span class="p">;</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">cmd_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_opf</span><span class="p">;</span>

<span class="w">    </span><span class="n">å¦‚æœbioæ²¡æ³•åˆå¹¶åˆ°åŸæœ‰çš„requestä¸­å»</span><span class="err">ï¼Œ</span><span class="n">åˆ™é‡æ–°ç”³è¯·ä¸€ä¸ªæ–°çš„request</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="n">rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__blk_mq_alloc_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>

<span class="w">    </span><span class="n">rq_qos_track</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">);</span>

<span class="w">    </span><span class="n">cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request_to_qc_t</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">hctx</span><span class="p">,</span><span class="w"> </span><span class="n">rq</span><span class="p">);</span>

<span class="w">    </span><span class="n">å°†bioä¸­çš„æ•°æ®æ·»åŠ åˆ°æ–°ç”³è¯·çš„requestä¸­</span>
<span class="w">    </span><span class="n">blk_mq_bio_to_request</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">nr_segs</span><span class="p">);</span>

<span class="w">    </span><span class="n">è·å–plug</span>
<span class="w">    </span><span class="n">plug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blk_mq_plug</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">);</span>

<span class="w">    </span><span class="mf">1.</span><span class="w"> </span><span class="n">å¦‚æœæ˜¯åˆ·æ–°flush</span><span class="o">/</span><span class="n">fuaè¯·æ±‚</span><span class="err">ï¼Œ</span><span class="n">åˆ™ç»•è¿‡è°ƒåº¦å™¨ç›´æ¥æ’å…¥è¯·æ±‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">is_flush_fua</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Bypass scheduler for flush requests */</span>
<span class="w">        </span><span class="n">blk_insert_flush</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
<span class="w">        </span><span class="n">blk_mq_run_hw_queue</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">hctx</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="n">å¯åŠ¨è¯·æ±‚æ´¾å‘</span>
<span class="w">    </span><span class="mf">2.</span><span class="w"> </span><span class="n">å½“å‰ä»»åŠ¡æ­£åœ¨åšIO</span><span class="w"> </span><span class="n">Plug</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">è®¾å¤‡ç¡¬ä»¶é˜Ÿåˆ—åªæœ‰ä¸€ä¸ª</span><span class="p">(</span><span class="n">hw_ctx</span><span class="o">?</span><span class="p">)</span><span class="err">ï¼Œ</span><span class="n">å°†requestæ’å…¥åˆ°å½“å‰ä»»åŠ¡çš„plug</span><span class="w"> </span><span class="n">list</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">plug</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_hw_queues</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">||</span>
<span class="w">           </span><span class="n">blk_mq_is_sbitmap_shared</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">mq_hctx</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">           </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">mq_ops</span><span class="o">-&gt;</span><span class="n">commit_rqs</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">blk_queue_nonrot</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">request_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plug</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="w"> </span><span class="o">*</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">request_count</span><span class="p">)</span>
<span class="w">            </span><span class="n">trace_block_plug</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list_entry_rq</span><span class="p">(</span><span class="n">plug</span><span class="o">-&gt;</span><span class="n">mq_list</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request_count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">blk_plug_max_rq_count</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">last</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">last</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BLK_PLUG_FLUSH_SIZE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">blk_flush_plug_list</span><span class="p">(</span><span class="n">plug</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">            </span><span class="n">trace_block_plug</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">blk_add_rq_to_plug</span><span class="p">(</span><span class="n">plug</span><span class="p">,</span><span class="w"> </span><span class="n">rq</span><span class="p">);</span><span class="w"> </span>

<span class="w">    </span><span class="mf">3.</span><span class="w"> </span><span class="n">å¦‚æœrequest</span><span class="w"> </span><span class="n">queueé…ç½®äº†è°ƒåº¦å™¨</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">elevator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Insert the request at the IO scheduler queue */</span>
<span class="w">        </span><span class="n">blk_mq_sched_insert_request</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"> </span><span class="n">å°†è¯·æ±‚æ’å…¥åˆ°è°ƒåº¦å™¨é˜Ÿåˆ—</span>

<span class="w">    </span><span class="mf">4.</span><span class="w"> </span><span class="n">æœ‰plug</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">queueæ²¡æœ‰ç¦æ­¢åˆå¹¶</span>
<span class="w">       </span><span class="n">èµ°è¿™ä¸ªåˆ†æ”¯è¯´æ˜ä¸æ˜¯åˆ·æ–°è¯·æ±‚</span><span class="err">ã€</span><span class="n">æ²¡æœ‰IOè°ƒåº¦å™¨</span><span class="err">ã€‚</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">plug</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">blk_queue_nomerges</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="o">-&gt;</span><span class="n">mq_list</span><span class="p">))</span>
<span class="w">            </span><span class="n">same_queue_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same_queue_rq</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">same_queue_rq</span><span class="o">-&gt;</span><span class="n">queuelist</span><span class="p">);</span>
<span class="w">            </span><span class="n">plug</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">blk_add_rq_to_plug</span><span class="p">(</span><span class="n">plug</span><span class="p">,</span><span class="w"> </span><span class="n">rq</span><span class="p">);</span>
<span class="w">        </span><span class="n">trace_block_plug</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">same_queue_rq</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="n">hctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">same_queue_rq</span><span class="o">-&gt;</span><span class="n">mq_hctx</span><span class="p">;</span>
<span class="w">            </span><span class="n">trace_block_unplug</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">            </span><span class="n">blk_mq_try_issue_directly</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">hctx</span><span class="p">,</span><span class="w"> </span><span class="n">same_queue_rq</span><span class="p">,</span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">cookie</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="mf">5.</span><span class="w"> </span><span class="n">è®¾å¤‡ç¡¬ä»¶é˜Ÿåˆ—æœ‰å¤šä¸ª</span><span class="err">ï¼ˆ</span><span class="n">hw_ctx</span><span class="o">?</span><span class="err">ï¼‰</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_hw_queues</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">is_sync</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">hctx</span><span class="o">-&gt;</span><span class="n">dispatch_busy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * There is no scheduler and we can try to send directly</span>
<span class="cm">         * to the hardware.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">blk_mq_try_issue_directly</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">hctx</span><span class="p">,</span><span class="w"> </span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cookie</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Default case. */</span>
<span class="w">        </span><span class="n">blk_mq_sched_insert_request</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hipri</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">BLK_QC_T_NONE</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cookie</span><span class="p">;</span>
<span class="nl">queue_exit</span><span class="p">:</span>
<span class="w">    </span><span class="n">blk_queue_exit</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">BLK_QC_T_NONE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="ioblk_mq_run_hw_queue">IOæ´¾å‘blk_mq_run_hw_queue</h4>
<p>åœ¨mutilate queueä¸­å¾ˆå¤šç‚¹éƒ½ä¼šè§¦å‘IOè¯·æ±‚åˆ°å—è®¾å¤‡é©±åŠ¨ä¸­</p>
<div class="codehilite"><pre><span></span><code><span class="n">blk_mq_run_hw_queue</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">__blk_mq_delay_run_hw_queue</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">blk_mq_sched_dispatch_requests</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">__blk_mq_sched_dispatch_requests</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">blk_mq_do_dispatch_sched</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="n">blk_mq_dispatch_rq_list</span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">mq_ops</span><span class="o">-&gt;</span><span class="n">queue_rq</span><span class="p">(</span><span class="n">hctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bd</span><span class="p">);</span>
<span class="w">                            </span><span class="o">-&gt;</span><span class="n">ç”¨æˆ·æ³¨å†Œçš„å›è°ƒå‡½æ•°</span><span class="p">.</span><span class="n">queue_rq</span>
</code></pre></div>
<p>ç¤ºä¾‹dump_stack</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="w">  </span><span class="mf">917.615686</span><span class="p">]</span><span class="w">  </span><span class="n">_queue_rq</span><span class="o">+</span><span class="mh">0x74</span><span class="o">/</span><span class="mh">0x210</span><span class="w"> </span><span class="p">[</span><span class="n">simplefs</span><span class="p">]</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.620462</span><span class="p">]</span><span class="w">  </span><span class="n">blk_mq_dispatch_rq_list</span><span class="o">+</span><span class="mh">0x130</span><span class="o">/</span><span class="mh">0x8cc</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.625633</span><span class="p">]</span><span class="w">  </span><span class="n">blk_mq_do_dispatch_sched</span><span class="o">+</span><span class="mh">0x2a8</span><span class="o">/</span><span class="mh">0x32c</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.630902</span><span class="p">]</span><span class="w">  </span><span class="n">__blk_mq_sched_dispatch_requests</span><span class="o">+</span><span class="mh">0x14c</span><span class="o">/</span><span class="mh">0x1b0</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.636948</span><span class="p">]</span><span class="w">  </span><span class="n">blk_mq_sched_dispatch_requests</span><span class="o">+</span><span class="mh">0x40</span><span class="o">/</span><span class="mh">0x80</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.642609</span><span class="p">]</span><span class="w">  </span><span class="n">__blk_mq_run_hw_queue</span><span class="o">+</span><span class="mh">0x58</span><span class="o">/</span><span class="mh">0x90</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.647389</span><span class="p">]</span><span class="w">  </span><span class="n">__blk_mq_delay_run_hw_queue</span><span class="o">+</span><span class="mh">0x1d4</span><span class="o">/</span><span class="mh">0x200</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.652951</span><span class="p">]</span><span class="w">  </span><span class="n">blk_mq_run_hw_queue</span><span class="o">+</span><span class="mh">0x98</span><span class="o">/</span><span class="mh">0x100</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.657634</span><span class="p">]</span><span class="w">  </span><span class="n">blk_mq_sched_insert_requests</span><span class="o">+</span><span class="mh">0x90</span><span class="o">/</span><span class="mh">0x170</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.663193</span><span class="p">]</span><span class="w">  </span><span class="n">blk_mq_flush_plug_list</span><span class="o">+</span><span class="mh">0x130</span><span class="o">/</span><span class="mh">0x1ec</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.668267</span><span class="p">]</span><span class="w">  </span><span class="n">blk_flush_plug_list</span><span class="o">+</span><span class="mh">0xec</span><span class="o">/</span><span class="mh">0x120</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.672950</span><span class="p">]</span><span class="w">  </span><span class="n">blk_finish_plug</span><span class="o">+</span><span class="mh">0x40</span><span class="o">/</span><span class="mh">0xe0</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.677149</span><span class="p">]</span><span class="w">  </span><span class="n">wb_writeback</span><span class="o">+</span><span class="mh">0x1e8</span><span class="o">/</span><span class="mh">0x3b0</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.681246</span><span class="p">]</span><span class="w">  </span><span class="n">wb_workfn</span><span class="o">+</span><span class="mh">0x39c</span><span class="o">/</span><span class="mh">0x584</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.685043</span><span class="p">]</span><span class="w">  </span><span class="n">process_one_work</span><span class="o">+</span><span class="mh">0x204</span><span class="o">/</span><span class="mh">0x420</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.689535</span><span class="p">]</span><span class="w">  </span><span class="n">worker_thread</span><span class="o">+</span><span class="mh">0x74</span><span class="o">/</span><span class="mh">0x4dc</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.693634</span><span class="p">]</span><span class="w">  </span><span class="n">kthread</span><span class="o">+</span><span class="mh">0x128</span><span class="o">/</span><span class="mh">0x134</span>
<span class="p">[</span><span class="w">  </span><span class="mf">917.697247</span><span class="p">]</span><span class="w">  </span><span class="n">ret_from_fork</span><span class="o">+</span><span class="mh">0x10</span><span class="o">/</span><span class="mh">0x20</span>
</code></pre></div>
<h3 id="_4">è¯»æ•°æ®</h3>
<p><a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_6586bfe1e6c6b770f755723b513c66dd.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆå››ï¼‰/images/wp_editor_md_6586bfe1e6c6b770f755723b513c66dd.jpg"/></a> <a href="https://www.laumy.tech/wp-content/uploads/2023/12/wp_editor_md_db5cdf13a3a45712944c6a79faefd1b4.jpg"><img alt="" src="assets/doc/01-linux/æ–‡ä»¶ç³»ç»Ÿ/ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆå››ï¼‰/images/wp_editor_md_db5cdf13a3a45712944c6a79faefd1b4.jpg"/></a></p>
<h4 id="_5">é¢„è¯»</h4>
<div class="codehilite"><pre><span></span><code><span class="n">ksys_read</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">vfs_read</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">new_sync_read</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read_iter</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">blkdev_read_iter</span>

<span class="n">blkdev_read_iter</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">generic_file_read_iter</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">filemap_read</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">filemap_get_pages</span><span class="w"> </span><span class="n">è·å–pageç¼“å­˜</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">filemap_get_read_batch</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">last_index</span><span class="p">,</span><span class="w"> </span><span class="n">pvec</span><span class="p">);</span><span class="w"> </span><span class="n">è·å–ç¼“å­˜é¡µé¢</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="k">for</span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xas_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xas</span><span class="p">);</span><span class="w"> </span><span class="n">head</span><span class="p">;</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xas_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xas</span><span class="p">))</span><span class="w"> </span><span class="n">éå†xarrayæ ‘</span><span class="err">ï¼Œ</span><span class="n">æŸ¥è¯¢æ˜¯å¦æœ‰ç¼“å­˜é¡µ</span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="n">pagevec_add</span><span class="p">(</span><span class="n">pvec</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">)</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pagevec_count</span><span class="p">(</span><span class="n">pvec</span><span class="p">))</span><span class="w"> </span><span class="n">å¦‚æœæ²¡æœ‰è·å–åˆ°ç¼“å­˜é¡µé¢</span><span class="err">ï¼Œ</span><span class="n">åˆ™è¿›è¡Œé¡µé¢é¢„è¯»</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="n">page_cache_sync_readahead</span><span class="w"> </span><span class="n">æ–‡ä»¶é¢„è¯»</span><span class="err">ï¼ˆ</span><span class="n">æ–‡ä»¶é¢„è¯»ä¼šåœ¨é‡æ–°è‡ªå·±åˆ†é…page</span><span class="err">ï¼‰</span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="n">page_cache_sync_ra</span>
<span class="w">                            </span><span class="o">-&gt;</span><span class="n">ondemand_readahead</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pagevec_count</span><span class="p">(</span><span class="n">pvec</span><span class="p">))</span>
<span class="w">                    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filemap_create_page</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="p">...</span><span class="w"> </span><span class="n">å¦‚æœè¿˜æ˜¯æ²¡æœ‰è·å–åˆ°ç¼“å­˜é¡µé¢</span><span class="err">ï¼Œ</span><span class="n">åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„é¡µé¢</span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="n">add_to_page_cache_lru</span><span class="w"> </span><span class="n">æ·»åŠ é¡µé¢åˆ°LRUä¸­</span><span class="err">ï¼Œ</span><span class="n">ä¾¿äºå›æ”¶</span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filemap_read_page</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p">);</span><span class="w"> </span><span class="n">è¯»å–æ•°æ®åˆ°é¡µé¢</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pvec</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">pagevec_count</span><span class="p">(</span><span class="n">pvec</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="n">è·å–æ‰¹é‡ç¼“å­˜çš„æœ€åä¸€é¡µ</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PageReadahead</span><span class="p">(</span><span class="n">page</span><span class="p">))</span><span class="w"> </span><span class="n">åˆ¤æ–­æœ€åä¸€ä¸ªé¡µé¢æ˜¯å¦éœ€è¦é¢„è¯»</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="n">filemap_readahead</span><span class="w"> </span><span class="n">æ–‡ä»¶é¢„è¯»</span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="n">page_cache_async_readahead</span>

<span class="w">            </span><span class="o">-&gt;</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pagevec_count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvec</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w">  </span><span class="n">æ‹·è´æ•°æ®ç»™åº”ç”¨</span>
<span class="w">                </span><span class="n">copied</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_page_to_iter</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="n">iter</span><span class="p">);</span>

<span class="n">æ–‡ä»¶ç¼“å­˜é¡µé¢„è¯»å–</span>
<span class="n">page_cache_sync_ra</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">ondemand_readahead</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">do_page_cache_ra</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">page_cache_ra_unbounded</span>
<span class="w">                </span><span class="n">æ ¹æ®è¯·æ±‚é¢„è¯»çš„æ•°é‡éå†xarrayæ ‘</span><span class="err">ï¼Œ</span><span class="n">å¦‚æœpageä¸å­˜åœ¨å°±é‡æ–°ç”³è¯·æ·»åŠ pageå¹¶è¯»å–æ•°æ®æ·»åŠ åˆ°LRUä¸Š</span><span class="err">ã€‚</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr_to_read</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xa_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">i_pages</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">xa_is_value</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="n">read_pages</span><span class="p">(</span><span class="n">ractl</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">page_pool</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__page_cache_alloc</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">);</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="n">read_pages</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">read_pages</span>

<span class="n">read_pages</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">blk_start_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">)</span><span class="w">  </span><span class="n">åœ¨task_structä¸Šå®‰è£…ä¸€ä¸ªlist</span><span class="p">,</span><span class="n">ç”¨äºåˆå¹¶å¤šä¸ªrequestè¯·æ±‚</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aops</span><span class="o">-&gt;</span><span class="n">readahead</span><span class="p">)</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">aops</span><span class="o">-&gt;</span><span class="n">readahead</span><span class="p">(</span><span class="n">rac</span><span class="p">)</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">blkdev_readahead</span><span class="w">  </span><span class="mf">1.</span><span class="w"> </span><span class="n">blockå±‚é¢„è¯»</span><span class="w"> </span><span class="o">------&gt;</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">aops</span><span class="o">-&gt;</span><span class="n">readpages</span><span class="p">)</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">aops</span><span class="o">-&gt;</span><span class="n">readpages</span><span class="p">(</span><span class="n">rac</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">rac</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span><span class="w"> </span><span class="n">pages</span><span class="p">,</span><span class="n">readahead_count</span><span class="p">(</span><span class="n">rac</span><span class="p">));</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="k">else</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readahead_page</span><span class="p">(</span><span class="n">rac</span><span class="p">)))</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">blk_finish_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span><span class="w">  </span><span class="mf">2.</span><span class="n">å°†task_structä¸Šåˆå¹¶requestè¯·æ±‚flushåˆ°å­˜å‚¨è®¾å¤‡é˜Ÿåˆ—</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">blk_flush_plug_list</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">blk_mq_flush_plug_list</span>

<span class="mf">1.</span><span class="n">blockå±‚é¢„è¯»</span><span class="w"> </span><span class="o">------&gt;</span><span class="n">blkdev_readahead</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">mpage_readahead</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">mpage_bio_submit</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">submit_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span>

<span class="n">submit_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">submit_bio_noacct</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">__submit_bio</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">blk_mq_submit_bio</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">plug</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">hwqueue</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>

<span class="mf">2.</span><span class="n">blk_mq_flush_plug_list</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">blk_mq_sched_insert_requests</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">blk_mq_run_hw_queue</span>

<span class="n">blk_mq_run_hw_queue</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">__blk_mq_delay_run_hw_queue</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">__blk_mq_run_hw_queue</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">blk_mq_sched_dispatch_requests</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">blk_mq_do_dispatch_sched</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="n">blk_mq_dispatch_rq_list</span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="n">ç”¨æˆ·æ³¨å†Œçš„å›è°ƒå‡½æ•°</span><span class="p">.</span><span class="n">queue_rq</span><span class="w"> </span><span class="o">--&gt;</span><span class="n">read</span>
</code></pre></div>
<h4 id="_6">ä»ç¼“å­˜ä¸­è¯»å–</h4>
<div class="codehilite"><pre><span></span><code><span class="n">ksys_read</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">vfs_read</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">new_sync_read</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read_iter</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">blkdev_read_iter</span>

<span class="n">blkdev_read_iter</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">generic_file_read_iter</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">filemap_read</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">filemap_get_pages</span><span class="w"> </span><span class="n">è·å–pageç¼“å­˜</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">filemap_get_read_batch</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">last_index</span><span class="p">,</span><span class="w"> </span><span class="n">pvec</span><span class="p">);</span><span class="w"> </span><span class="n">è·å–ç¼“å­˜é¡µé¢</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="k">for</span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xas_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xas</span><span class="p">);</span><span class="w"> </span><span class="n">head</span><span class="p">;</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xas_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xas</span><span class="p">))</span><span class="w"> </span><span class="n">éå†xarrayæ ‘</span><span class="err">ï¼Œ</span><span class="n">æŸ¥è¯¢æœ‰ç¼“å­˜é¡µ</span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="n">pagevec_add</span><span class="p">(</span><span class="n">pvec</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">)</span>

<span class="w">            </span><span class="o">-&gt;</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pagevec_count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvec</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w">  </span><span class="n">æ‹·è´æ•°æ®ç»™åº”ç”¨</span>
<span class="w">                </span><span class="n">copied</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_page_to_iter</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="n">iter</span><span class="p">);</span>
</code></pre></div>
<p>ä¸é¢„è¯»ç›¸æ¯”ï¼Œå¦‚æœåœ¨ç¼“å­˜ä¸­å‘½ä¸­åï¼Œå°†ç›´æ¥ä»ç¼“å­˜ä¸­è·å–è¿”å›ï¼Œåœ¨filemap_get_pageså‡½æ•°ä¸­è·å–ç¼“å­˜é¡µï¼Œå¦‚æœå·²ç»å­˜åœ¨ç¼“å­˜é¡µåˆ™ä¸éœ€è¦è¿›è¡Œé¢„è¯»æ“ä½œï¼Œæ¥ä¸‹æ¥ä»ç¼“å­˜ä¸­æ‹·è´æ•°æ®ç»™åº”ç”¨ç©ºé—´å³å¯ã€‚</p></div>
  <div class="post-nav">
    <a class="prev" href="æ–‡ä»¶ç³»ç»Ÿç¼“å­˜.html">â† æ–‡ä»¶ç³»ç»Ÿç¼“å­˜</a>
    <a class="next" href="ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨-äº”.html">ä¸€åˆ‡çš†æ–‡ä»¶ä¹‹å—è®¾å¤‡é©±åŠ¨ï¼ˆäº”ï¼‰ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

