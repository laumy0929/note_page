<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RTSPè§†é¢‘ä¼ è¾“ç¤ºä¾‹ä»£ç åˆ†æ - Laumyçš„æŠ€æœ¯æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJaxæ”¯æŒLaTeXæ•°å­¦å…¬å¼ -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumyçš„æŠ€æœ¯æ ˆ</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="è¾“å…¥å…³é”®è¯å›è½¦æœç´¢">
        </div>
        <div class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜" id="theme-toggle">â˜¾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">é¦–é¡µ</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="è®¿é—®ä¸»ç«™">ä¸»ç«™ç‚¹:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">æ–‡ç« ç›®å½•</div>
          <nav id="toc"><ul><li><a href="#_1">æ•°æ®ç»“æ„</a><ul><li><a href="#samplertspcontext">SampleRtspContext</a></li><li><a href="#samplertspconfig">SampleRtspConfig</a></li><li><a href="#_2">ç¼–ç æµ</a></li></ul></li><li><a href="#_3">åˆå§‹åŒ–å¯åŠ¨</a><ul><li><a href="#_4">åˆå§‹åŒ–ä¸Šä¸‹æ–‡å‚æ•°</a></li><li><a href="#mpp">MPPåˆå§‹åŒ–</a></li><li><a href="#vipp">åˆ›å»ºVIPPé€šé“å’Œè™šæ‹Ÿé€šé“</a></li><li><a href="#venc">åˆ›å»ºVENCç¼–ç é€šé“</a></li><li><a href="#mux">åˆ›å»ºMUXé€šé“</a></li><li><a href="#_5">é€šé“ç»‘å®š</a></li><li><a href="#_6">ä½¿èƒ½è™šæ‹Ÿä¸ç¼–ç é€šé“</a></li><li><a href="#_7">åˆ›å»ºè·å–ç¼–ç æµçº¿ç¨‹</a></li></ul></li><li><a href="#_8">ç¼–ç æµè·å–ä¸å¤„ç†</a><ul><li><a href="#spspps">è·å–SPSå’ŒPPS</a></li><li><a href="#rtsp">å¼€å¯RTSP</a></li><li><a href="#rtsp_1">å¾ªç¯è·å–ç¼–ç æµå¹¶å‘é€åˆ°RTSP</a></li></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>RTSPè§†é¢‘ä¼ è¾“ç¤ºä¾‹ä»£ç åˆ†æ</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">ğŸ•’</i>
      2024-11-17
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ“‚</i>
      linux
    </span>
    <span class="meta-item">
      <i class="icon">ğŸ‘¤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><p>æ•°æ®æµé€šè·¯ï¼š CSI -&gt; ISP -&gt; VIPP -&gt; VirChn -&gt; VENC</p>
<ul>
<li>CSIï¼šè¡¨ç¤ºç‰©ç† Camera Signal Input Pasrse Device çš„æ¥å£ã€‚CSI å¯ä»¥é€‰æ‹©è¿æ¥ä»»æ„ä¸€ä¸ª ISPã€‚æœ€å¤šæ”¯æŒ 3 ä¸ª CSIã€‚</li>
<li>ISPï¼šè¡¨ç¤ºç‰©ç† ISPã€‚ISP å¯ä»¥é€‰æ‹©è¿æ¥ä»»æ„å¤šä¸ª VIPPã€‚æœ€å¤šæ”¯æŒ 5 ä¸ª ISPã€‚</li>
<li>VIPPï¼šè¡¨ç¤ºç‰©ç† Scale + OSD + Mask é€šé“ã€‚æ¯ä¸ª VIPP é…åˆä¸€ä¸ª DMA è¾“å‡ºä¸€è·¯ Video ç»™åˆ° DDRã€‚æœ€å¤šæ”¯æŒ 16 ä¸ª VIPPã€‚</li>
<li>VirChnï¼šè¡¨ç¤º VI è™šé€šé“ã€‚æ¯ä¸ªç‰©ç†é€šé“æœ€å¤šè™šæ‹Ÿ 4 ä¸ªè™šé€šé“è¾“å‡ºã€‚é»˜è®¤æƒ…å†µä¸‹æ¨èä½¿ç”¨ä¸€ä¸ªç‰©ç†é€šé“å’Œä¸€ä¸ªè™šé€šé“æ¥é‡‡é›†è§†é¢‘æ•°æ®ã€‚è™šæ‹Ÿé€šé“çš„å›¾åƒå±æ€§æ˜¯ç‰©ç†é€šé“çš„å¤åˆ¶å“ã€‚</li>
<li>VENC:ç¼–ç é€šé“ï¼Œæ”¯æŒå¤šè·¯å®æ—¶ç¼–ç ï¼Œä¸”æ¯è·¯ç¼–ç ç‹¬ç«‹ï¼Œç¼–ç åè®®å’Œç¼–ç  proâ€‘file å¯ä»¥ä¸åŒã€‚VENC æ¨¡å—çš„è¾“å…¥æºåŒ…æ‹¬ä¸¤ç±»ï¼šç”¨æˆ·æ€è¯»å–å›¾åƒæ–‡ä»¶å‘ç¼–ç æ¨¡å—å‘é€æ•°æ®ï¼›è§†é¢‘è¾“å…¥ï¼ˆVIï¼‰æ¨¡å—é‡‡é›†çš„å›¾åƒç›´æ¥å‘é€åˆ°ç¼–ç æ¨¡å—ã€‚</li>
</ul>
<h2 id="_1">æ•°æ®ç»“æ„</h2>
<h3 id="samplertspcontext">SampleRtspContext</h3>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">SampleRtspContext</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">SampleRtspCmdLineParam</span><span class="w"> </span><span class="n">mCmdLinePara</span><span class="p">;</span><span class="w"> </span><span class="c1">//rtspå‘½ä»¤è¡Œçš„å‚æ•°è·¯å¾„ -pathæŒ‡å®šçš„ã€‚</span>
<span class="w">    </span><span class="n">SampleRtspConfig</span><span class="w"> </span><span class="n">mConfigPara</span><span class="p">;</span><span class="w"> </span><span class="c1">//rtspçš„é…ç½®</span>

<span class="w">    </span><span class="n">cdx_sem_t</span><span class="w"> </span><span class="n">mSemExit</span><span class="p">;</span><span class="w"> </span><span class="c1">//ä¿¡å·é‡ï¼Ÿ</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mbExitFlag</span><span class="p">;</span>

<span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">mMainIspRunFlag</span><span class="p">;</span>
<span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">mSubIspRunFlag</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//å…ˆå°†mConfigParaä»æ–‡ä»¶ä¸­è¯»å–å‡ºæ¥ï¼Œç„¶ååˆ†åˆ«å†™åˆ°ä¸‹é¢ã€‚</span>
<span class="w">    </span><span class="n">VencStreamContext</span><span class="w"> </span><span class="n">mMainStream</span><span class="p">;</span><span class="w"> </span><span class="c1">//ä¸»ç æµçš„å‚æ•°</span>
<span class="w">    </span><span class="n">VencStreamContext</span><span class="w"> </span><span class="n">mSubStream</span><span class="p">;</span><span class="w"> </span><span class="c1">//å­ç æµçš„å‚æ•°</span>
<span class="w">    </span><span class="n">VencStreamContext</span><span class="w"> </span><span class="n">mSubLapseStream</span><span class="p">;</span><span class="w"> </span><span class="c1">//ç¼©æ—¶å½•å½±ç æµå‚æ•°</span>

<span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="n">mWbYuvThreadId</span><span class="p">;</span>
<span class="p">}</span><span class="n">SampleRtspContext</span><span class="p">;</span>
</code></pre></div>
<p>SampleRtspContextç»“æ„ä½“ä¸»è¦ç”¨äºrtsp sampleå‡½æ•°ä¹‹é—´çš„å‚æ•°ä¼ é€’ã€‚</p>
<h3 id="samplertspconfig">SampleRtspConfig</h3>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">SampleRtspConfig</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// main stream</span>
<span class="w">    </span><span class="n">ISP_DEV</span><span class="w"> </span><span class="n">mMainIsp</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">    </span><span class="n">VI_DEV</span><span class="w"> </span><span class="n">mMainVipp</span><span class="p">;</span><span class="w"> </span><span class="c1">//æŒ‡å®švippè®¾å¤‡å·ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºvipp0</span>
<span class="w">    </span><span class="n">VI_CHN</span><span class="w"> </span><span class="n">mMainViChn</span><span class="p">;</span><span class="w"> </span><span class="c1">//æŒ‡å®šviè™šæ‹Ÿé€šé“å·ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºvich0</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mMainSrcWidth</span><span class="p">;</span><span class="w"> </span><span class="c1">//æŒ‡å®šåŸå§‹è§†é¢‘çš„å®½åº¦</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mMainSrcHeight</span><span class="p">;</span><span class="w"> </span><span class="c1">//æŒ‡å®šåŸå§‹è§†é¢‘çš„é«˜åº¦</span>
<span class="w">    </span><span class="n">PIXEL_FORMAT_E</span><span class="w"> </span><span class="n">mMainPixelFormat</span><span class="p">;</span><span class="w"> </span><span class="c1">//æŒ‡å®šåƒç´ æ ¼å¼ï¼ŒYUVç±»å‹ï¼šNV21ï¼ŒYU12ï¼ŒNV12ã€‚LBCå‹ç¼©ç±»ä¼¼ï¼šaw_lbc_2_0x,aw_lbc_2_5x, aw_lbc_1_5x, aw_lbc_1_0x)ã€‚</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mMainWdrEnable</span><span class="p">;</span><span class="w"> </span><span class="c1">//æŒ‡å®šæ˜¯å¦å¼€å¯WDRï¼Œé»˜è®¤ä¸º0ä¸å¼€ã€‚</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mMainViBufNum</span><span class="p">;</span><span class="c1">//æŒ‡å®šVIçš„bufferä¸ªæ•°ï¼Œä»…å †ç¦»çº¿ç¼–ç æœ‰æ•ˆã€‚</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mMainSrcFrameRate</span><span class="p">;</span><span class="c1">//æŒ‡å®švippé‡‡é›†çš„å¸§ç‡ï¼Œå•ä½ï¼šfpsã€‚</span>
<span class="w">    </span><span class="n">VENC_CHN</span><span class="w"> </span><span class="n">mMainVEncChn</span><span class="p">;</span><span class="c1">//æŒ‡å®šVEé€šé“å·</span>
<span class="w">    </span><span class="n">PAYLOAD_TYPE_E</span><span class="w"> </span><span class="n">mMainEncodeType</span><span class="p">;</span><span class="c1">//æŒ‡å®šç¼–ç æ ¼å¼ï¼Œå¦‚H.264ï¼ŒH.265</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mMainEncodeWidth</span><span class="p">;</span><span class="c1">//ç¼–ç ç æµçš„è§†é¢‘å®½åº¦</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mMainEncodeHeight</span><span class="p">;</span><span class="c1">//ç¼–ç ç æµçš„è§†é¢‘é«˜åº¦</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mMainEncodeFrameRate</span><span class="p">;</span><span class="c1">//ç¼–ç è§†é¢‘çš„å¸§ç‡ï¼Œfps</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mMainEncodeBitrate</span><span class="p">;</span><span class="c1">//ç¼–ç çš„ç ç‡ï¼Œbps</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">mMainFilePath</span><span class="p">[</span><span class="n">MAX_FILE_PATH_SIZE</span><span class="p">];</span><span class="c1">//ç¼–ç ç æµå­˜æ”¾çš„è·¯å¾„ï¼Œè‹¥ä¸æŒ‡å®šåˆ™ä¸ä¼šä¿å­˜æ–‡ä»¶ã€‚</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mMainOnlineEnable</span><span class="p">;</span><span class="c1">//æ˜¯å¦å¼€å¯åœ¨çº¿ç¼–ç ï¼Œ0è¡¨ç¤ºä¸å¼€å¯è¡¨ç¤ºç¦»çº¿ç¼–ç ã€‚</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mMainOnlineShareBufNum</span><span class="p">;</span><span class="c1">//åœ¨çº¿ç¼–ç å…±äº«çš„bufferä¸ªæ•°ã€‚</span>
<span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">mMainEncppEnable</span><span class="p">;</span><span class="w"> </span><span class="c1">//æ˜¯å¦ç¦ç”¨encppæ–°é€šè·¯ï¼Ÿï¼Ÿï¼Ÿ</span>

<span class="w">    </span><span class="c1">// sub stream å­ç æµ</span>
<span class="w">    </span><span class="n">ISP_DEV</span><span class="w"> </span><span class="n">mSubIsp</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="n">VI_DEV</span><span class="w"> </span><span class="n">mSubVipp</span><span class="p">;</span>
<span class="w">    </span><span class="n">VI_CHN</span><span class="w"> </span><span class="n">mSubViChn</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubSrcWidth</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubSrcHeight</span><span class="p">;</span>
<span class="w">    </span><span class="n">PIXEL_FORMAT_E</span><span class="w"> </span><span class="n">mSubPixelFormat</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubWdrEnable</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubViBufNum</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubSrcFrameRate</span><span class="p">;</span>
<span class="w">    </span><span class="n">VENC_CHN</span><span class="w"> </span><span class="n">mSubVEncChn</span><span class="p">;</span>
<span class="w">    </span><span class="n">PAYLOAD_TYPE_E</span><span class="w"> </span><span class="n">mSubEncodeType</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubEncodeWidth</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubEncodeHeight</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubEncodeFrameRate</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubEncodeBitrate</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">mSubFilePath</span><span class="p">[</span><span class="n">MAX_FILE_PATH_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubEncppSharpAttenCoefPer</span><span class="p">;</span>
<span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">mSubVippCropEnable</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubVippCropRectX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubVippCropRectY</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubVippCropRectWidth</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubVippCropRectHeight</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubOnlineEnable</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubOnlineShareBufNum</span><span class="p">;</span>
<span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">mSubEncppEnable</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// sub lapse stream //ç¼©æ—¶å½•å½±ï¼Œå°†è¾ƒé•¿çš„å½•å½±å‹ç¼©å˜çŸ­çš„æ‹æ‘„æŠ€æœ¯</span>
<span class="w">    </span><span class="n">VI_DEV</span><span class="w"> </span><span class="n">mSubLapseVipp</span><span class="p">;</span><span class="w"> </span><span class="c1">//æŒ‡å®šVIPPé€šé“</span>
<span class="w">    </span><span class="n">VI_CHN</span><span class="w"> </span><span class="n">mSubLapseViChn</span><span class="p">;</span><span class="w"> </span><span class="c1">//æŒ‡å®šviè™šæ‹Ÿé€šé“</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubLapseSrcWidth</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubLapseSrcHeight</span><span class="p">;</span>
<span class="w">    </span><span class="n">PIXEL_FORMAT_E</span><span class="w"> </span><span class="n">mSubLapsePixelFormat</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubLapseWdrEnable</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubLapseViBufNum</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubLapseSrcFrameRate</span><span class="p">;</span>
<span class="w">    </span><span class="n">VENC_CHN</span><span class="w"> </span><span class="n">mSubLapseVEncChn</span><span class="p">;</span>
<span class="w">    </span><span class="n">PAYLOAD_TYPE_E</span><span class="w"> </span><span class="n">mSubLapseEncodeType</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubLapseEncodeWidth</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubLapseEncodeHeight</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubLapseEncodeFrameRate</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubLapseEncodeBitrate</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">mSubLapseFilePath</span><span class="p">[</span><span class="n">MAX_FILE_PATH_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubLapseEncppSharpAttenCoefPer</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mSubLapseTime</span><span class="p">;</span>
<span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">mSubLapseEncppEnable</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// isp and ve linkage</span>
<span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">mIspAndVeLinkageEnable</span><span class="p">;</span>
<span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">mCameraAdaptiveMovingAndStaticEnable</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mVencLensMovingMaxQp</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// wb yuv</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mWbYuvEnable</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mWbYuvBufNum</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mWbYuvScalerRatio</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mWbYuvStartIndex</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mWbYuvTotalCnt</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mWbYuvStreamChn</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">mWbYuvFilePath</span><span class="p">[</span><span class="n">MAX_FILE_PATH_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="c1">// rtsp</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mRtspNetType</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mStreamBufSize</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// others</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mTestDuration</span><span class="p">;</span><span class="w">  </span><span class="c1">//unit:s, 0 means infinite.</span>
<span class="p">}</span><span class="n">SampleRtspConfig</span><span class="p">;</span>
</code></pre></div>
<h3 id="_2">ç¼–ç æµ</h3>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VENC_STREAM_S</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">VENC_PACK_S</span><span class="w">       </span><span class="o">*</span><span class="n">mpPack</span><span class="p">;</span><span class="w">      </span><span class="cm">/*stream pack attribute*/</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">      </span><span class="n">mPackCount</span><span class="p">;</span><span class="w">  </span><span class="cm">/*the pack number of one frame stream*/</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">      </span><span class="n">mSeq</span><span class="p">;</span><span class="w">       </span><span class="cm">/*the list number of stream*/</span>

<span class="w">    </span><span class="k">union</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">VENC_STREAM_INFO_H264_S</span><span class="w">  </span><span class="n">mH264Info</span><span class="p">;</span><span class="w">   </span><span class="cm">/*the stream info of h264*/</span>
<span class="w">        </span><span class="n">VENC_STREAM_INFO_JPEG_S</span><span class="w">  </span><span class="n">mJpegInfo</span><span class="p">;</span><span class="w">    </span><span class="cm">/*the stream info of jpeg*/</span>
<span class="w">        </span><span class="n">VENC_STREAM_INFO_MPEG4_S</span><span class="w"> </span><span class="n">mMpeg4Info</span><span class="p">;</span><span class="w">    </span><span class="cm">/*the stream info of mpeg4*/</span>
<span class="w">        </span><span class="n">VENC_STREAM_INFO_H265_S</span><span class="w">  </span><span class="n">mH265Info</span><span class="p">;</span><span class="w">     </span><span class="cm">/*the stream info of h265*/</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span><span class="n">VENC_STREAM_S</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VENC_PACK_S</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//unsigned int   mPhyAddr;  /*the physics address of stream*/</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">   </span><span class="o">*</span><span class="n">mpAddr0</span><span class="p">;</span><span class="w">   </span><span class="cm">/*the virtual address of stream*/</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">   </span><span class="o">*</span><span class="n">mpAddr1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">   </span><span class="o">*</span><span class="n">mpAddr2</span><span class="p">;</span><span class="w">  </span><span class="c1">//for jpeg encoder, jpeg encoder may use three buffer to store mainPicture and thumbPicture.</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">   </span><span class="n">mLen0</span><span class="p">;</span><span class="w">      </span><span class="cm">/*the length of stream*/</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">   </span><span class="n">mLen1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">   </span><span class="n">mLen2</span><span class="p">;</span>

<span class="w">    </span><span class="kt">uint64_t</span><span class="w">   </span><span class="n">mPTS</span><span class="p">;</span><span class="w">           </span><span class="cm">/*PTS*/</span>
<span class="w">    </span><span class="n">BOOL</span><span class="w">  </span><span class="n">mbFrameEnd</span><span class="p">;</span><span class="w">         </span><span class="cm">/*frame endï¼Ÿ*/</span>

<span class="w">    </span><span class="n">VENC_DATA_TYPE_U</span><span class="w">  </span><span class="n">mDataType</span><span class="p">;</span><span class="w">                     </span><span class="cm">/*the type of stream*/</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">   </span><span class="n">mOffset</span><span class="p">;</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mDataNum</span><span class="p">;</span>
<span class="w">    </span><span class="n">VENC_PACK_INFO_S</span><span class="w"> </span><span class="n">mPackInfo</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">}</span><span class="n">VENC_PACK_S</span><span class="p">;</span>
</code></pre></div>
<h2 id="_3">åˆå§‹åŒ–å¯åŠ¨</h2>
<h3 id="_4">åˆå§‹åŒ–ä¸Šä¸‹æ–‡å‚æ•°</h3>
<div class="codehilite"><pre><span></span><code><span class="n">åˆ†é…ä¸€ä¸ªSampleRtspContextç»“æ„ä½“</span>
<span class="n">SampleRtspContext</span><span class="w"> </span><span class="o">*</span><span class="n">pContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SampleRtspContext</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SampleRtspContext</span><span class="p">));</span>
<span class="n">gpSampleRtspContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pContext</span><span class="p">;</span>
<span class="n">memset</span><span class="p">(</span><span class="n">pContext</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">SampleRtspContext</span><span class="p">));</span>
<span class="n">cdx_sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mSemExit</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="n">å¤„ç†å‘½ä»¤è¡Œçš„å‚æ•°</span><span class="err">ï¼Œ</span><span class="n">ä¸»è¦æ˜¯å°†</span><span class="o">-</span><span class="n">pathçš„è·¯å¾„å‚æ•°å­˜å‚¨åˆ°pCmdLinePara</span><span class="o">-&gt;</span><span class="n">mConfigFilePathä¸­</span><span class="err">ã€‚</span>
<span class="n">ParseCmdLine</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mCmdLinePara</span><span class="p">)</span>

<span class="n">è§£æ</span><span class="o">-</span><span class="n">pathä¸­é…ç½®æ–‡ä»¶çš„å‚æ•°</span><span class="err">ï¼Œ</span><span class="n">å°†å…¶åŠ è½½åˆ°pContext</span><span class="o">-&gt;</span><span class="n">mConfigParaç»“æ„ä½“ä¸­</span><span class="err">ã€‚</span>
<span class="n">loadSampleConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mConfigPara</span><span class="p">,</span><span class="w"> </span><span class="n">pConfigFilePath</span><span class="p">)</span>
</code></pre></div>
<h3 id="mpp">MPPåˆå§‹åŒ–</h3>
<div class="codehilite"><pre><span></span><code><span class="n">é…ç½®ç³»ç»Ÿæ§åˆ¶å‚æ•°</span><span class="err">ï¼Œ</span><span class="n">æœ‰ä»€ä¹ˆç”¨äº†</span><span class="err">ï¼Ÿï¼Ÿï¼Ÿ</span>
<span class="n">MPP_SYS_CONF_S</span><span class="w"> </span><span class="n">stSysConf</span><span class="p">;</span>
<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stSysConf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">MPP_SYS_CONF_S</span><span class="p">));</span>
<span class="n">stSysConf</span><span class="p">.</span><span class="n">nAlignWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="n">AW_MPI_SYS_SetConf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stSysConf</span><span class="p">);</span>

<span class="n">MPPæ¥å£åˆå§‹åŒ–</span>
<span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AW_MPI_SYS_Init</span><span class="p">();</span>

<span class="n">é…ç½®ä¸»ç æµçš„å‚æ•°</span><span class="err">ï¼Œ</span>
<span class="n">configMainStream</span><span class="p">(</span><span class="n">pContext</span><span class="p">);</span>
<span class="n">AW_MPI_VI_CreateVipp</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">.</span><span class="n">mVipp</span><span class="p">);</span>
<span class="n">AW_MPI_VI_SetVippAttr</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">.</span><span class="n">mVipp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">.</span><span class="n">mViAttr</span><span class="p">);</span>
</code></pre></div>
<h3 id="vipp">åˆ›å»ºVIPPé€šé“å’Œè™šæ‹Ÿé€šé“</h3>
<div class="codehilite"><pre><span></span><code><span class="n">é…ç½®ä¸»ç æµçš„å‚æ•°</span><span class="err">ï¼Œ</span>
<span class="n">configMainStream</span><span class="p">(</span><span class="n">pContext</span><span class="p">);</span>
<span class="n">AW_MPI_VI_CreateVipp</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">.</span><span class="n">mVipp</span><span class="p">);</span>
<span class="n">AW_MPI_VI_SetVippAttr</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">.</span><span class="n">mVipp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">.</span><span class="n">mViAttr</span><span class="p">);</span>

<span class="n">åˆ›å»ºVIPPé€šé“</span><span class="err">ã€</span><span class="n">VIPPè™šæ‹Ÿé€šé“</span><span class="err">ï¼Œ</span><span class="n">åŒæ—¶åˆå§‹åŒ–ISP</span><span class="err">ï¼Œ</span><span class="n">ä½¿èƒ½VIPP</span><span class="err">ã€‚</span>
<span class="n">configMainStream</span><span class="p">(</span><span class="n">pContext</span><span class="p">);</span><span class="w"> </span><span class="c1">//å°†è·¯å¾„ä¸­é…ç½®æ–‡ä»¶å‚æ•°å†™åˆ°&amp;pContext-&gt;mMainStreamä¸­</span>
<span class="n">AW_MPI_VI_CreateVipp</span><span class="p">(</span><span class="n">pContext</span><span class="err">â€‘</span><span class="o">&gt;</span><span class="n">mViDev</span><span class="p">);</span><span class="c1">//åˆ›å»ºVIPP</span>
<span class="n">AW_MPI_VI_SetVippAttr</span><span class="p">(</span><span class="n">pContext</span><span class="err">â€‘</span><span class="o">&gt;</span><span class="n">mViDev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="err">â€‘</span><span class="o">&gt;</span><span class="n">mViAttr</span><span class="p">);</span><span class="c1">//è®¾ç½®VIPPçš„å‚æ•°</span>
<span class="n">AW_MPI_ISP_Run</span><span class="p">(</span><span class="n">pContext</span><span class="err">â€‘</span><span class="o">&gt;</span><span class="n">mIspDev</span><span class="p">);</span><span class="c1">//åˆå§‹åŒ–ISPè¿è¡Œ</span>
<span class="n">AW_MPI_VI_CreateVirChn</span><span class="p">(</span><span class="n">pContext</span><span class="err">â€‘</span><span class="o">&gt;</span><span class="n">mViDev</span><span class="p">,</span><span class="w"> </span><span class="n">pContext</span><span class="err">â€‘</span><span class="o">&gt;</span><span class="n">mViChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stVirChnAttr</span><span class="p">);</span>
<span class="n">AW_MPI_VI_RegisterCallback</span><span class="p">(</span><span class="n">pContext</span><span class="err">â€‘</span><span class="o">&gt;</span><span class="n">mViDev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cbInfo</span><span class="p">);</span><span class="c1">//åˆ›å»ºVIPPè™šæ‹Ÿé€šé“</span>
<span class="n">AW_MPI_VI_EnableVipp</span><span class="p">(</span><span class="n">pContext</span><span class="err">â€‘</span><span class="o">&gt;</span><span class="n">mViDev</span><span class="p">);</span><span class="c1">//ä½¿èƒ½VIPP</span>
</code></pre></div>
<h3 id="venc">åˆ›å»ºVENCç¼–ç é€šé“</h3>
<p>åˆ›å»ºç¼–ç é€šé“ï¼Œé€‚ç”¨ä»€ä¹ˆç¼–ç æ ¼å¼ï¼Œåœ¨pContext-&gt;mMainStream.mVEncChnAtträ¸­è¿›è¡Œè®¾å®šï¼Œå¦‚é€‚ç”¨h264ç¼–ç ï¼Œåˆ™VeAttr.Type=PT_H264</p>
<div class="codehilite"><pre><span></span><code><span class="n">è®¾ç½®ç¼–ç å‚æ•°</span><span class="p">,</span><span class="n">åˆ›å»ºVENCç¼–ç é€šé“</span>
<span class="n">AW_MPI_VENC_CreateChn</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">.</span><span class="n">mVEncChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">.</span><span class="n">mVEncChnAttr</span><span class="p">);</span>
<span class="n">AW_MPI_VENC_SetRcParam</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">.</span><span class="n">mVEncChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">.</span><span class="n">mVEncRcParam</span><span class="p">);</span>
<span class="n">AW_MPI_VENC_RegisterCallback</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">.</span><span class="n">mVEncChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cbInfo</span><span class="p">);</span><span class="c1">//æ³¨å†Œä¸€ä¸ªå›è°ƒ</span>
<span class="n">é…ç½®ISPVEè”åŠ¨</span><span class="err">ã€‚</span>
<span class="n">AW_MPI_VENC_EnableIspVeLink</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">.</span><span class="n">mVEncChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stIspVeLinkAttr</span><span class="p">);</span>
</code></pre></div>
<h3 id="mux">åˆ›å»ºMUXé€šé“</h3>
<p>ç•¥</p>
<h3 id="_5">é€šé“ç»‘å®š</h3>
<div class="codehilite"><pre><span></span><code><span class="n">å°†VIè™šæ‹Ÿé€šé“å’ŒVENCé€šé“ç»‘å®š</span><span class="err">ã€‚</span>
<span class="n">AW_MPI_SYS_Bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ViChn</span><span class="p">,</span><span class="o">&amp;</span><span class="n">VeChn</span><span class="p">);</span>
</code></pre></div>
<h3 id="_6">ä½¿èƒ½è™šæ‹Ÿä¸ç¼–ç é€šé“</h3>
<div class="codehilite"><pre><span></span><code><span class="n">å¯åŠ¨VIè™šæ‹Ÿé€šé“</span><span class="err">ã€</span><span class="n">vencé€šé“</span><span class="err">ã€‚</span>
<span class="n">AW_MPI_VI_EnableVirChn</span><span class="p">(</span><span class="n">pContext</span><span class="err">â€‘</span><span class="o">&gt;</span><span class="n">mViDev</span><span class="p">,</span><span class="w"> </span><span class="n">pContext</span><span class="err">â€‘</span><span class="o">&gt;</span><span class="n">mViChn</span><span class="p">);</span>
<span class="n">AW_MPI_VENC_StartRecvPic</span><span class="p">(</span><span class="n">pContext</span><span class="err">â€‘</span><span class="o">&gt;</span><span class="n">mVeChn</span><span class="p">);</span>
</code></pre></div>
<h3 id="_7">åˆ›å»ºè·å–ç¼–ç æµçº¿ç¨‹</h3>
<div class="codehilite"><pre><span></span><code><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">.</span><span class="n">mStreamThreadId</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">getVencStreamThread</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mMainStream</span><span class="p">);</span>
<span class="n">åˆ›å»ºä¸€ä¸ªæ¥æ”¶çº¿ç¨‹</span><span class="err">ï¼Œ</span><span class="n">ç”¨äºæ¥æ”¶è§†é¢‘æµ</span>
</code></pre></div>
<h2 id="_8">ç¼–ç æµè·å–ä¸å¤„ç†</h2>
<h3 id="spspps">è·å–SPSå’ŒPPS</h3>
<div class="codehilite"><pre><span></span><code><span class="n">VencHeaderData</span><span class="w"> </span><span class="n">stSpsPpsInfo</span><span class="p">;</span>
<span class="n">AW_MPI_VENC_GetH264SpsPpsInfo</span><span class="p">(</span><span class="n">pStreamContext</span><span class="o">-&gt;</span><span class="n">mVEncChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stSpsPpsInfo</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pStreamContext</span><span class="o">-&gt;</span><span class="n">mFile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">stSpsPpsInfo</span><span class="p">.</span><span class="n">pBuffer</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>
<span class="w">           </span><span class="n">stSpsPpsInfo</span><span class="p">.</span><span class="n">nLength</span><span class="p">,</span><span class="w"> </span><span class="n">pStreamContext</span><span class="o">-&gt;</span><span class="n">mFile</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>SPSä¿å­˜ç€è§†é¢‘å†…å®¹çš„è§„æ ¼å‚æ•°ï¼ŒåŒ…æ‹¬è§†é¢‘é«˜åº¦ã€è§†é¢‘å®½åº¦ã€å¸§ç‡ç­‰ç­‰ã€‚PPSä¿å­˜ç€è§†é¢‘å¸§çš„ç¼–ç å‚æ•°ï¼ŒåŒ…æ‹¬ç†µç¼–ç æ¨¡å¼ã€åˆ‡ç‰‡åˆ†å‰²ç±»å‹ã€åˆå§‹é‡åŒ–å‚æ•°ã€è‰²åº¦é‡åŒ–å‚æ•°ç­‰ç­‰ã€‚éœ€è¦è·å–åˆ°è¿™äº›å‚æ•°è§£ç å™¨æ‰èƒ½è§£ç ã€‚å¦‚æœé…ç½®æ–‡ä»¶ä¸­è¦å°†ç¼–ç æ•°æ®å†™å…¥æ–‡ä»¶ï¼Œåˆ™å…ˆå°†SPSå’ŒPPSå†™å…¥ã€‚</p>
<h3 id="rtsp">å¼€å¯RTSP</h3>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">rtsp_start</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">RTSP_SERVER_CHANNEL_NUM</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="err">\\\</span><span class="s">"%s,%d: invalid id %d &gt;= %d</span><span class="se">\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span><span class="s">n</span><span class="se">\\\"</span><span class="s">, __func__,__LINE__, id, RTSP_SERVER_CHANNEL_NUM);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">TinyServer</span><span class="w"> </span><span class="o">*</span><span class="n">rtsp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpRtspContext</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
<span class="w">    </span><span class="n">MediaStream</span><span class="w"> </span><span class="o">*</span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpRtspStream</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">url_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">streamURL</span><span class="p">();</span>
<span class="w">    </span><span class="n">rtsp</span><span class="o">-&gt;</span><span class="n">runWithNewThread</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="rtsp_1">å¾ªç¯è·å–ç¼–ç æµå¹¶å‘é€åˆ°RTSP</h3>
<div class="codehilite"><pre><span></span><code><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mbExitFlag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//è·å–ç¼–ç æµç¨‹</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_GetStream</span><span class="p">(</span><span class="n">pStreamContext</span><span class="o">-&gt;</span><span class="n">mVEncChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stVencStream</span><span class="p">,</span><span class="w"> </span><span class="n">nMilliSec</span><span class="p">)</span>
<span class="w">    </span><span class="c1">//å¦‚æœé…ç½®æ–‡ä»¶ä½¿èƒ½äº†è¦å†™å…¥æ–‡ä»¶ï¼Œåˆ™å†™å…¥ã€‚0/1/2åŒºåˆ«ï¼Ÿ</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">stVencStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mpAddr0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">           </span><span class="n">stVencStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mLen0</span><span class="p">,</span><span class="w"> </span><span class="n">pStreamContext</span><span class="o">-&gt;</span><span class="n">mFile</span><span class="p">)</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">stVencStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mpAddr1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">           </span><span class="n">stVencStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mLen1</span><span class="p">,</span><span class="w"> </span><span class="n">pStreamContext</span><span class="o">-&gt;</span><span class="n">mFile</span><span class="p">)</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">stVencStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">mpAddr2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">           </span><span class="n">stVencStream</span><span class="p">.</span><span class="n">mpPack</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">mLen2</span><span class="p">,</span><span class="w"> </span><span class="n">pStreamContext</span><span class="o">-&gt;</span><span class="n">mFile</span><span class="p">)</span>

<span class="w">    </span><span class="n">å†™å…¥sps</span><span class="o">/</span><span class="n">ppsåˆ°stream_bufä¸­</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">stream_buf</span><span class="p">,</span><span class="w"> </span><span class="n">stSpsPpsInfo</span><span class="p">.</span><span class="n">pBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">stSpsPpsInfo</span><span class="p">.</span><span class="n">nLength</span><span class="p">);</span>
<span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">stSpsPpsInfo</span><span class="p">.</span><span class="n">nLength</span>
<span class="w">    </span><span class="n">frame_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RTSP_FRAME_DATA_TYPE_I</span><span class="err">ï¼›</span>

<span class="w">    </span><span class="n">å†™å…¥ç¼–ç æµåˆ°stream_bufä¸­</span><span class="err">ï¼Œ</span><span class="n">åŒæ ·ä¼šåˆ¤æ–­å¯¹ç”¨çš„mpPackp</span><span class="o">-&gt;</span><span class="n">mLenxè‹¥å¤§äº0</span><span class="err">ï¼Œ</span><span class="n">ä¾æ¬¡æ‹·è´</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">stream_buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">stVencStream</span><span class="p">.</span><span class="n">mpPack</span><span class="o">-&gt;</span><span class="n">mpAddr0</span><span class="p">,</span>
<span class="w">           </span><span class="n">stVencStream</span><span class="p">.</span><span class="n">mpPack</span><span class="o">-&gt;</span><span class="n">mLen0</span><span class="p">);</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">stream_buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">stVencStream</span><span class="p">.</span><span class="n">mpPack</span><span class="o">-&gt;</span><span class="n">mpAddr1</span><span class="p">,</span>
<span class="w">           </span><span class="n">stVencStream</span><span class="p">.</span><span class="n">mpPack</span><span class="o">-&gt;</span><span class="n">mLen1</span><span class="p">);</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">stream_buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">stVencStream</span><span class="p">.</span><span class="n">mpPack</span><span class="o">-&gt;</span><span class="n">mpAddr2</span><span class="p">,</span>
<span class="w">           </span><span class="n">stVencStream</span><span class="p">.</span><span class="n">mpPack</span><span class="o">-&gt;</span><span class="n">mLen2</span><span class="p">);</span>

<span class="w">    </span><span class="n">è·å–å½“å‰çš„fps</span><span class="err">ï¼Œ</span><span class="n">rtspä¼šæ£€æŸ¥durationæ—¶é—´</span>
<span class="w">    </span><span class="n">AW_MPI_ISP_GetSensorFps</span><span class="p">(</span><span class="n">pStreamContext</span><span class="o">-&gt;</span><span class="n">mIsp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sensor_fps</span><span class="p">);</span>

<span class="w">    </span><span class="n">è°ƒç”¨rtsp_sendDataå‘é€</span>
<span class="w">    </span><span class="n">RtspSendDataParam</span><span class="w"> </span><span class="n">stRtspParam</span><span class="p">;</span>
<span class="w">    </span><span class="n">stRtspParam</span><span class="p">.</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stream_buf</span><span class="p">;</span><span class="w"> </span><span class="c1">//ç¼–ç æµbufferåœ°å€</span>
<span class="w">    </span><span class="n">stRtspParam</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="w">    </span><span class="n">stRtspParam</span><span class="p">.</span><span class="n">frame_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame_type</span><span class="p">;</span><span class="c1">//ç¼–ç æµç±»å‹</span>
<span class="w">    </span><span class="n">stRtspParam</span><span class="p">.</span><span class="n">pts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pts</span><span class="p">;</span>
<span class="w">    </span><span class="n">stRtspParam</span><span class="p">.</span><span class="n">frame_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sensor_fps</span><span class="p">;</span><span class="c1">//ç¼–ç æµçš„å¸§ç‡</span>
<span class="w">    </span><span class="n">rtsp_sendData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stRtspParam</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="æ‹ç…§ç¤ºä¾‹ä»£ç åˆ†æ.html">â† æ‹ç…§ç¤ºä¾‹ä»£ç åˆ†æ</a>
    <a class="next" href="ç§»åŠ¨æ£€æµ‹ä»£ç ç¤ºä¾‹åˆ†æ.html">ç§»åŠ¨æ£€æµ‹ä»£ç ç¤ºä¾‹åˆ†æ â†’</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright Â©2022-2025 laumy ç‰ˆæƒæ‰€æœ‰</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

